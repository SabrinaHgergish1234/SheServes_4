"use strict";var fx=Object.defineProperty;var px=(s,t,e)=>t in s?fx(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var r=(s,t,e)=>(px(s,typeof t!="symbol"?t+"":t,e),e),df=(s,t,e)=>{if(!t.has(s))throw TypeError("Cannot "+e)};var le=(s,t,e)=>(df(s,t,"read from private field"),e?e.call(s):t.get(s)),Ei=(s,t,e)=>{if(t.has(s))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(s):t.set(s,e)},Ki=(s,t,e,i)=>(df(s,t,"write to private field"),i?i.call(s,e):t.set(s,e),e);var ml=(s,t,e)=>(df(s,t,"access private method"),e);const h=require("./three.light.umd.cjs"),re=require("./gltf-progressive.light.umd.cjs"),Y=require("./three-examples.light.umd.cjs"),oe=require("./vendor.light.umd.cjs"),ie=require("./three-mesh-ui.light.umd.cjs");var _a=typeof document<"u"?document.currentScript:null;let Rb,O_=null;function dn(){return Rb}function Pm(s){if(s==null){console.warn("Oh no: someone tried registering a non-existend gltf-loader. When you see this log it might mean that needle-engine is being imported multiple times. Please check your project setup.");return}O_!==s&&(O_=s,Rb=new s)}const uf=new Map;function Ht(s=(t=>(t=globalThis.location)==null?void 0:t.hostname)()){if(uf.has(s))return uf.get(s);const e=/(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})|localhost/.test(s);return uf.set(s,e),e===!0}function kb(){return window.location.hostname.includes("glitch.me")}const M_=typeof window!==void 0?window.location.search.includes("debugcontext"):!1;var he=(s=>(s.ContextRegistered="ContextRegistered",s.ContextCreationStart="ContextCreationStart",s.ContextCreated="ContextCreated",s.ContextFirstFrameRendered="ContextFirstFrameRendered",s.ContextDestroying="ContextDestroying",s.ContextDestroyed="ContextDestroyed",s.MissingCamera="MissingCamera",s.ContextClearing="ContextClearing",s.ContextCleared="ContextCleared",s))(he||{});class ce{static get Current(){return globalThis["NeedleEngine.Context.Current"]}static set Current(t){globalThis["NeedleEngine.Context.Current"]=t}static get All(){return this.Registered}static register(t){this.Registered.indexOf(t)===-1&&(M_&&console.warn("Registering context"),this.Registered.push(t),this.dispatchCallback("ContextRegistered",t))}static unregister(t){const e=this.Registered.indexOf(t);e!==-1&&(M_&&console.warn("Unregistering context"),this.Registered.splice(e,1))}static registerCallback(t,e){this._callbacks[t]||(this._callbacks[t]=[]),this._callbacks[t].push(e)}static unregisterCallback(t,e){if(!this._callbacks[t])return;const i=this._callbacks[t].indexOf(e);i!==-1&&this._callbacks[t].splice(i,1)}static dispatchCallback(t,e,i){if(!this._callbacks[t])return!0;const n={event:t,context:e};if(i)for(const a in i)n[a]=i[a];const o=new Array;return this._callbacks[t].forEach(a=>{const l=a(n);l instanceof Promise&&o.push(l)}),Promise.all(o)}static addContextCreatedCallback(t){this.registerCallback("ContextCreated",t)}static addContextDestroyedCallback(t){this.registerCallback("ContextDestroyed",t)}}r(ce,"Registered",[]),r(ce,"_callbacks",{});const Eb=()=>s=>s;function mx(s){return Eb()(s)}function gx(){return!!x("debug")}class xi{constructor(t,e){r(this,"_factory");r(this,"_cache",[]);r(this,"_maxSize");r(this,"_index",0);this._factory=t,this._maxSize=e}get(){const t=this._index%this._maxSize;return this._index++,this._cache.length<=t&&(this._cache[t]=this._factory()),this._cache[t]}}let Bo=!1;const Ap=new Array;typeof window<"u"&&setTimeout(()=>{if(Bo){const s={},t=new URL(window.location.href),e=new URL(t);e.searchParams.append("console","");const i=e.toString().replace(/=$|=(?=&)/g,"");for(const o of Ap){const a=new URL(t);a.searchParams.append(o,""),s[o]=a.toString().replace(/=$|=(?=&)/g,"")}console.log(`🌵 ?help: Debug Options for Needle Engine.
Append any of these parameters to the URL to enable specific debug options.
Example: ${i} will show an onscreen console window.`);const n=Bo===!0?"":` (containing "${Bo}")`;console.group("Available URL parameters:"+n);for(const o of Object.keys(s).sort())typeof Bo=="string"&&!o.toLowerCase().includes(Bo.toLowerCase())||(console.groupCollapsed(o),console.log("Reload with this flag enabled:"),console.log(s[o]),console.groupEnd());console.groupEnd()}},100);function Bc(){var s;return new URLSearchParams((s=globalThis.location)==null?void 0:s.search)}function x(s){Bo&&!Ap.includes(s)&&Ap.push(s);const t=Bc();if(t.has(s)){const e=t.get(s);if(e){const i=Number(e);return isNaN(i)?e:i}else return!0}return!1}Bo=x("help");function _x(s,t){const e=Bc();e.has(s)?e.set(s,t):e.append(s,t),document.location.search=e.toString()}function wc(s,t,e=!0){const i=Bc();i.has(s)?t===null?i.delete(s):i.set(s,t):t!==null&&i.append(s,t),e?Tb(s,i):Om(s,i)}function Dp(s,t,e){s.has(t)?s.set(t,e.toString()):s.append(t,e.toString())}function Tb(s,t,e){window.history.pushState(e,s,"?"+t.toString())}function Om(s,t,e){window.history.replaceState(e,s,"?"+t.toString())}function yx(s){for(var t="",e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=e.length,n=0;n<s;n++)t+=e.charAt(Math.floor(Math.random()*i));return t}function bx(s,t){return Math.floor(Math.random()*(t-s+1))+s}const R_=["smol","tiny","giant","interesting","smart","bright","dull","extreme","beautiful","pretty","dark","epic","salty","silly","funny","lame","lazy","loud","lucky","mad","mean","mighty","mysterious","nasty","odd","old","powerful","quiet","rapid","scary","shiny","shy","silly","smooth","sour","spicy","stupid","sweet","tasty","terrible","ugly","unusual","vast","wet","wild","witty","wrong","zany","zealous","zippy","zombie","zorro"],k_=["cat","dog","mouse","pig","cow","horse","sheep","chicken","duck","goat","panda","tiger","lion","elephant","monkey","bird","fish","snake","frog","turtle","hamster","penguin","kangaroo","whale","dolphin","crocodile","snail","ant","bee","beetle","butterfly","dragon","eagle","fish","giraffe","lizard","panda","penguin","rabbit","snake","spider","tiger","zebra"];function Ab(){const s=R_[Math.floor(Math.random()*R_.length)],t=k_[Math.floor(Math.random()*k_.length)];return s+"_"+t}function Db(s){return s=s.replace(/[^a-z0-9áéíóúñü \.,_-]/gim,""),s.trim()}function ka(s,t,e=!0,i=!1){var n;if(t==null)return null;if(t.userData&&t.userData.guid===s)return t;if(t.guid==s)return t;if(i&&(n=t.userData)!=null&&n.components){for(const o of t.userData.components)if(o.guid===s)return o}if(e){if(t.scenes)for(const o in t.scenes){const a=t.scenes[o],l=ka(s,a,e,i);if(l)return l}if(t.children)for(const o in t.children){const a=t.children[o],l=ka(s,a,e,i);if(l)return l}}}function Fc(s,t){if(s!=null&&typeof s=="object"){let e;Array.isArray(s)?e=[]:(e=Object.create(s),Object.assign(e,s));for(const i of Object.keys(s)){const n=s[i];t&&!t(s,i,n)?e[i]=n:(n==null?void 0:n.clone)!==void 0&&typeof n.clone=="function"?e[i]=n.clone():e[i]=Fc(n,t)}return e}return s}function un(s){return new Promise((t,e)=>{setTimeout(t,s)})}function Uc(s,t){if(s<=0)return Promise.resolve();if(t||(t=ce.Current),!t)return Promise.reject("No context");const e=t.time.frameCount+s;return new Promise((i,n)=>{if(!t)return n("No context");const o=()=>{t.time.frameCount>=e&&(t.pre_update_callbacks.splice(t.pre_update_callbacks.indexOf(o),1),i())};t.pre_update_callbacks.push(o)})}const kh=x("debugresolveurl"),Lb="rel:";function vx(s,t){return mo(s,t)}function mo(s,t){if(t===void 0)return kh&&console.warn("getPath: uri is undefined, returning uri",t),t;if(t.startsWith("./"))return t;if(t.startsWith("http"))return kh&&console.warn("getPath: uri is absolute, returning uri",t),t;if(s===void 0)return kh&&console.warn("getPath: source is undefined, returning uri",t),t;t.startsWith(Lb)&&(t=t.substring(4));const e=s.lastIndexOf("/");if(e>=0){const i=s.substring(0,e+1);for(;i.endsWith("/")&&t.startsWith("/");)t=t.substring(1);const n=i+t;return kh&&console.log("source:",s,`changed uri 
from`,t,`
to `,n,`
basePath: `+i),n}return t}class wx{constructor(t,e){r(this,"writeCallbacks",[]);r(this,"_applied",!1);r(this,"_object");r(this,"_prop");r(this,"_wrapperProp");this._object=t,this._prop=e,this._wrapperProp=Symbol("$"+e),this.apply()}subscribeWrite(t){this.writeCallbacks.push(t)}unsubscribeWrite(t){const e=this.writeCallbacks.indexOf(t);e!==-1&&this.writeCallbacks.splice(e,1)}apply(){if(this._applied||!this._object)return;const t=this._object,e=this._prop;if(t[e]===void 0)return;this._applied=!0,t[this._wrapperProp]!==void 0&&console.warn("Watcher is being applied to an object that already has a wrapper property. This is not (yet) supported");const i=t[e];t[this._wrapperProp]=i,Object.defineProperty(t,e,{get:()=>t[this._wrapperProp],set:a=>{t[this._wrapperProp]=a;for(const l of this.writeCallbacks)l(a,this._prop)}})}revoke(){if(!this._applied||!this._object)return;this._applied=!1;const t=this._object,e=this._prop;Reflect.deleteProperty(t,e);const i=t[this._wrapperProp];t[e]=i,Reflect.deleteProperty(t,this._wrapperProp)}dispose(){this.revoke(),this.writeCallbacks.length=0,this._object=null}}class fs{constructor(t,e){r(this,"_watches",[]);if(Array.isArray(e))for(const i of e)this._watches.push(new fs(t,i));else this._watches.push(new wx(t,e))}subscribeWrite(t){for(const e of this._watches)e.subscribeWrite(t)}unsubscribeWrite(t){for(const e of this._watches)e.unsubscribeWrite(t)}apply(){for(const t of this._watches)t.apply()}revoke(){for(const t of this._watches)t.revoke()}dispose(){for(const t of this._watches)t.dispose();this._watches.length=0}}const ea=Symbol("needle:watches");function vu(s,t){if(!s[ea])if(s instanceof h.Vector2)s[ea]=new fs(s,["x","y"]);else if(s instanceof h.Vector3)s[ea]=new fs(s,["x","y","z"]);else if(s instanceof h.Vector4||s instanceof h.Quaternion)s[ea]=new fs(s,["x","y","z","w"]);else return!1;return s[ea].subscribeWrite(t),!0}function Mm(s,t){if(!s)return;const e=s[ea];e&&e.unsubscribeWrite(t)}exports.DeviceUtilities=void 0;(s=>{let t;function e(){if(t!==void 0)return t;const L=window.navigator.userAgent,V=/Windows|MacOS|Mac OS/.test(L),G=/Windows NT/.test(L)&&/Edg/.test(L)&&!/Win64/.test(L);return t=V&&!G&&!w()}s.isDesktop=e;let i;function n(){return i!==void 0?i:typeof window.orientation<"u"||navigator.userAgent.indexOf("IEMobile")!==-1?i=!0:i=/iPhone|iPad|iPod|Android|IEMobile/i.test(navigator.userAgent)}s.isMobileDevice=n;function o(){return l()}s.isIPad=o;let a;function l(){return a!==void 0?a:a=/iPad/.test(navigator.userAgent)}s.isiPad=l;let c;function d(){return c!==void 0?c:c=/Android/.test(navigator.userAgent)}s.isAndroidDevice=d;let u;function f(){return u!==void 0?u:u=/WebXRViewer\//i.test(navigator.userAgent)}s.isMozillaXR=f;let m;function g(){if(m!==void 0)return m;if(navigator.userAgentData)return m=navigator.userAgentData.platform==="macOS";{const L=navigator.userAgent.toLowerCase();return m=L.includes("mac os x")||L.includes("macintosh")}}s.isMacOS=g;let _;function y(){return _!==void 0?_:_=g()&&"xr"in navigator}s.isVisionOS=y;let b;const v=["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"];function w(){return b!==void 0?b:b=v.includes(navigator.platform)||navigator.userAgent.includes("Mac")&&"ontouchend"in document}s.isiOS=w;let P;function k(){return P!==void 0||(P=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)),P}s.isSafari=k;let O;function M(){return O!==void 0?O:O=navigator.userAgent.includes("OculusBrowser")}s.isQuest=M;let A;function I(){return A!==void 0||(A=document.createElement("a").relList.supports("ar")),A}s.supportsQuickLookAR=I;async function T(){try{return(await navigator.permissions.query({name:"microphone"})).state!=="denied"}catch(L){return console.error("Error querying `microphone` permissions.",L),!1}}s.microphonePermissionsGranted=T;let j;function F(){if(j!==void 0)return j;const L=navigator.userAgent.match(/iPhone OS (\d+_\d+)/);if(L&&(j=L[1].replace("_",".")),!j){const V=navigator.userAgent.match(/(?:\(Macintosh;|iPhone;|iPad;).*Version\/(\d+\.\d+)/);V&&(j=V[1])}return j||(j=null),j}s.getiOSVersion=F;let X;function E(){if(X!==void 0)return X;const L=navigator.userAgent.match(/(?:CriOS|Chrome)\/(\d+\.\d+\.\d+\.\d+)/);return L?X=L[1].replace("_","."):X=null,X}s.getChromeVersion=E})(exports.DeviceUtilities||(exports.DeviceUtilities={}));function xx(){return exports.DeviceUtilities.isDesktop()}function Sx(){return exports.DeviceUtilities.isMobileDevice()}function Cx(){return exports.DeviceUtilities.isiPad()}function Px(){return exports.DeviceUtilities.isiPad()}function Ox(){return exports.DeviceUtilities.isAndroidDevice()}function Mx(){return exports.DeviceUtilities.isMozillaXR()}function Rx(){return exports.DeviceUtilities.isMacOS()}function kx(){return exports.DeviceUtilities.isiOS()}function Ex(){return exports.DeviceUtilities.isSafari()}function Tx(){return exports.DeviceUtilities.isQuest()}async function Ax(){return exports.DeviceUtilities.microphonePermissionsGranted()}const Dx=/ip=(?<ip>.+?)\n/s;async function Lx(){const t=await(await fetch("https://www.cloudflare.com/cdn-cgi/trace")).text(),e=Dx.exec(t);return e?e[1]:null}async function Ix(){const s=await fetch("https://api.db-ip.com/v2/free/self").catch(()=>null);return s?(await s.json()).ipAddress:void 0}async function jx(){const s=await fetch("https://api.db-ip.com/v2/free/self").catch(()=>null);return s?await s.json():void 0}const Xs=new WeakMap;function Ib(s,t,e){if(!Xs.get(s)){const n=new MutationObserver(o=>{Bx(s,o)});Xs.set(s,{observer:n,attributeChangedListeners:new Map}),n.observe(s,{attributes:!0})}const i=Xs.get(s).attributeChangedListeners;i.has(t)||i.set(t,[]),i.get(t).push(e)}function jb(s,t,e){if(!Xs.get(s))return;const i=Xs.get(s).attributeChangedListeners;if(!i.has(t))return;const n=i.get(t),o=n.indexOf(e);if(o!==-1&&(n.splice(o,1),n.length<=0)){i.delete(t);const a=Xs.get(s);a==null||a.observer.disconnect(),Xs.delete(s)}}function Bx(s,t){const e=Xs.get(s).attributeChangedListeners;for(const i of t)if(i.type==="attributes"){const n=i.attributeName,o=s.getAttribute(n);if(e.has(n))for(const a of e.get(n))a(o)}}class Lp{constructor(t){r(this,"reason");this.reason=t}}async function Rm(s){const t=await Promise.allSettled(s).catch(n=>[new Lp(n.message)]);let e=!1;const i=t.map(n=>"value"in n?n.value:(e=!0,new Lp(n.reason)));return{anyFailed:e,results:i}}async function Bb(s){if(!globalThis.QRCode){const i="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js";let n=document.head.querySelector(`script[src="${i}"]`);n||(n=document.createElement("script"),n.src=i,document.head.appendChild(n)),await new Promise((o,a)=>{n.addEventListener("load",()=>{o(!0)})})}const t=globalThis.QRCode,e=s.domElement??document.createElement("div");return new t(e,{width:s.width??256,height:s.height??256,colorDark:"#000000",colorLight:"#ffffff",correctLevel:t.CorrectLevel.M,...s}),e}const Fb=x("debugdebug");let xc=!1;(x("noerrors")||x("nooverlaymessages"))&&(xc=!0);const ff="needle_engine_global_error_container";var bi=(s=>(s[s.Log=0]="Log",s[s.Warn=1]="Warn",s[s.Error=2]="Error",s))(bi||{});function km(){return Vb}const Ip=new Array;function Fx(s){Ip.push(s)}let pf=!1;function Ux(...s){if(!pf){pf=!0;try{for(let t=0;t<Ip.length;t++)Ip[t](...s)}catch(t){console.error(t)}pf=!1}}const Ub=console.error,zb=function(...s){Ub.apply(console,s),Vx(s),Tn(2,s),jp(...s)};function Nb(s){xc=!s,s?console.error=zb:console.error=Ub}function zx(s){return Nb(s)}function Nx(){xc||(Fb&&console.warn("Patch console",window.location.hostname),console.error=zb,window.addEventListener("error",s=>{if(!s)return;const t=s.error;if(t===void 0){Ht()&&console.warn("Received unknown error",s,s.target);return}Tn(2,t,s.filename,s.lineno),jp(s)},!0),window.addEventListener("unhandledrejection",s=>{xc||s&&(s.reason?Tn(2,s.reason.message,s.reason.stack):Tn(2,"unhandled rejection"),jp(s))}))}let Vb=0;function jp(...s){Vb+=1,Ux(...s)}function Vx(s){if(Array.isArray(s))for(let t=0;t<s.length;t++){const e=s[t];typeof e=="string"&&e.startsWith("THREE.PropertyBinding: Trying to update node for track:")&&(s[t]="Some animated objects couldn't be found: see console for details")}}function Tn(s,t,e,i){if(xc)return;const n=ce.Current,o=(n==null?void 0:n.domElement)??document.querySelector("needle-engine");if(o){if(Array.isArray(t)){let a="";for(let l=0;l<t.length;l++){let c=t[l];c instanceof Error&&(c=c.message),typeof c!="object"&&(l>0&&(a+=" "),a+=c)}t=a}!t||t.length<=0||$x(s,o,t)}}const Kl=new Map;function $x(s,t,e){if(e==null)return;const i=Hx(t);if(i.childElementCount>=20){const l=i.lastElementChild;E_(l)}e.length>400&&(e=e.substring(0,400)+"...");const n=e;if(Kl.has(n))return;const o=qx(s,e);i.prepend(o);const a=()=>{Kl.delete(n),E_(o)};Kl.set(n,a),setTimeout(a,1e4)}function Wx(){Fb&&console.log("Clearing messages");for(const s of Kl.values())s==null||s.call(s);Kl.clear()}const Gx=`

@import url('https://fonts.googleapis.com/css2?family=Roboto+Flex:opsz,wght@8..144,100..1000&display=swap');

div[data-needle_engine_debug_overlay] {
    font-family: 'Roboto Flex', sans-serif;
    font-weight: 400;
    font-size: 16px;
}

div[data-needle_engine_debug_overlay] strong {
    font-weight: 700;
}

div[data-needle_engine_debug_overlay] a {
    color: white;
    text-decoration: none;
    border-bottom: 1px solid rgba(255, 255, 255, 0.3);
}

div[data-needle_engine_debug_overlay] a:hover {
    text-decoration: none;
    border: none;
}

div[data-needle_engine_debug_overlay] .log strong {
    color: rgba(200,200,200,.9);
}

div[data-needle_engine_debug_overlay] .warn strong {
    color: rgba(255,255,230, 1);
}

div[data-needle_engine_debug_overlay] .error strong {
    color: rgba(255,100,120, 1);
}
`;function Hx(s){globalThis[ff]||(globalThis[ff]=new Map);const t=globalThis[ff];if(t.has(s))return t.get(s);{const e=document.createElement("div");t.set(s,e),e.setAttribute("data-needle_engine_debug_overlay",""),e.classList.add("debug-container"),e.style.cssText=`
            position: absolute;
            top: 0;
            right: 5px;
            padding-top: 0px;
            max-width: 70%;
            max-height: calc(100% - 5px);
            z-index: 9999999999;
            pointer-events: scroll;
            display: flex;
            align-items: end;
            flex-direction: column;
            color: white;
            overflow: auto;
            word-break: break-word;
        `,s.shadowRoot?s.shadowRoot.appendChild(e):s.appendChild(e);const i=document.createElement("style");return i.innerHTML=Gx,e.appendChild(i),e}}const $b=Symbol("logtype"),Td=new Map;function E_(s){s.remove();const t=s[$b],e=Td.get(t)??[];e.push(s),Td.set(t,e)}function qx(s,t){if(Td.has(s)){const i=Td.get(s);if(i.length>0){const n=i.pop();return n.innerHTML=t,n}}const e=document.createElement("div");switch(e.setAttribute("data-id","__needle_engine_debug_overlay"),e.style.marginRight="5px",e.style.padding=".5em",e.style.backgroundColor="rgba(0,0,0,.9)",e.style.marginTop="5px",e.style.marginBottom="3px",e.style.borderRadius="8px",e.style.pointerEvents="all",e.style.userSelect="text",e.style.maxWidth="250px",e.style.whiteSpace="pre-wrap",e.style["backdrop-filter"]="blur(10px)",e.style["-webkit-backdrop-filter"]="blur(10px)",e.style.backgroundColor="rgba(20,20,20,.8)",e.style.boxShadow="inset 0 0 80px rgba(0,0,0,.2), 0 0 5px rgba(0,0,0,.2)",e.style.border="1px solid rgba(160,160,160,.2)",e[$b]=s,s){case 0:e.classList.add("log"),e.style.color="rgba(200,200,200,.7)",e.style.backgroundColor="rgba(40,40,40,.7)";break;case 1:e.classList.add("warn"),e.style.color="rgb(255, 255, 150)",e.style.backgroundColor="rgba(50,50,20,.8)";break;case 2:e.classList.add("error"),e.style.color="rgb(255, 50, 50",e.style.backgroundColor="rgba(50,20,20,.8)";break}return e.title="Open the browser console (F12) for more information",e.innerHTML=t,e}class Xx{constructor(){r(this,"Rad2Deg",180/Math.PI);r(this,"Deg2Rad",Math.PI/180);r(this,"Epsilon",1e-5)}random(t,e){return Array.isArray(t)?t.length<=0?null:t[Math.floor(Math.random()*t.length)]:t!==void 0&&e!==void 0?Math.random()*(e-t)+t:Math.random()}randomVector3(t,e=0,i=1){t.x=this.random(e,i),t.y=this.random(e,i),t.z=this.random(e,i)}clamp(t,e,i){return t<e?e:t>i?i:t}clamp01(t){return this.clamp(t,0,1)}lerp(t,e,i){return i=i<0?0:i,i=i>1?1:i,t+(e-t)*i}inverseLerp(t,e,i){return(i-t)/(e-t)}remap(t,e,i,n,o){return n+(o-n)*(t-e)/(i-e)}moveTowards(t,e,i){return t+=i,(i<0&&t<e||i>0&&t>e)&&(t=e),t}toDegrees(t){return t*180/Math.PI}toRadians(t){return t*Math.PI/180}tan(t){return Math.tan(t)}gammaToLinear(t){return Math.pow(t,2.2)}linearToGamma(t){return Math.pow(t,1/2.2)}approximately(t,e,i=Number.EPSILON){for(const n of Qx){const o=t[n],a=e[n];if(o===void 0||a===void 0)break;if(Math.abs(o-a)>i)return!1}return!0}easeInOutCubic(t){return t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2}}const Qx=["x","y","z","w"],z=new Xx;class T_{constructor(t){r(this,"y");r(this,"s");r(this,"alpha",0);this.setAlpha(t),this.y=null,this.s=null}setAlpha(t){if(t<=0||t>1)throw new Error;this.alpha=t}filter(t,e){e&&this.setAlpha(e);let i;return this.y?i=this.alpha*t+(1-this.alpha)*this.s:i=t,this.y=t,this.s=i,i}lastValue(){return this.y}reset(t){this.y=t,this.s=t}}class hd{constructor(t,e=1,i=0,n=1){r(this,"freq");r(this,"minCutOff");r(this,"beta");r(this,"dCutOff");r(this,"x");r(this,"dx");r(this,"lasttime");if(t<=0||e<=0||n<=0)throw new Error;this.freq=t,this.minCutOff=e,this.beta=i,this.dCutOff=n,this.x=new T_(this.alpha(this.minCutOff)),this.dx=new T_(this.alpha(this.dCutOff)),this.lasttime=null}alpha(t){const e=1/this.freq;return 1/(1+1/(2*Math.PI*t)/e)}filter(t,e=null){this.lasttime&&e&&(this.freq=1/(e-this.lasttime)),this.lasttime=e;const i=this.x.lastValue(),n=i?(t-i)*this.freq:0,o=this.dx.filter(n,this.alpha(this.dCutOff)),a=this.minCutOff+this.beta*Math.abs(o);return this.x.filter(t,this.alpha(a))}reset(t){t!=null&&this.x.reset(t),this.x.alpha=this.alpha(this.minCutOff),this.dx.alpha=this.alpha(this.dCutOff),this.lasttime=null}}class Em{constructor(t,e=1,i=0,n=1){r(this,"x");r(this,"y");r(this,"z");this.x=new hd(t,e,i,n),this.y=new hd(t,e,i,n),this.z=new hd(t,e,i,n)}filter(t,e,i=null){e.x=this.x.filter(t.x,i),e.y=this.y.filter(t.y,i),e.z=this.z.filter(t.z,i)}reset(t){this.x.reset(t==null?void 0:t.x),this.y.reset(t==null?void 0:t.y),this.z.reset(t==null?void 0:t.z)}}const dd="needle:cameraController";function Wb(s){return s[dd]}function Bp(s,t,e){e?s[dd]=t:s[dd]===t&&(s[dd]=null)}const Fp="needle:autofit";function Gb(s){return s[Fp]===void 0?!0:s[Fp]!==!1}function Ad(s,t){s[Fp]=t}function Yx(s,t,e){const i=s.length(),n=t.length(),o=z.lerp(i,n,e);return s.lerp(t,e).normalize().multiplyScalar(o)}const mf=new h.Quaternion,Hb=new h.Quaternion().setFromAxisAngle(new h.Vector3(0,1,0),Math.PI);function Kx(s,t){s.lookAt(t),s.quaternion.multiply(Hb)}function zc(s,t,e=!0,i=!1){if(s===t)return;mf.copy(s.quaternion);const n=Z(t),o=Z(s);if(i){if(Wi(s,_e(t)),e){const a=o.y,l=o.sub(Xb(s));l.y=a,s.lookAt(l),s.quaternion.multiply(Hb)}Number.isNaN(s.quaternion.x)&&s.quaternion.copy(mf);return}e&&(n.y=o.y),s.lookAt(n),Number.isNaN(s.quaternion.x)&&s.quaternion.copy(mf)}function Zx(s,t,e,i=1){if(e){const n=$(0,0,0),o=t.x/window.innerWidth*2-1,a=-(t.y/window.innerHeight)*2+1;n.set(o,a,0),n.unproject(e);const l=e.worldPosition,c=s.worldPosition.distanceTo(l),d=n.sub(l);d.multiplyScalar(i*3.6*c);const u=e.worldPosition.add(d);return s.lookAt(u),u}return null}const Jx=new xi(()=>new h.Vector3,100);function $(s,t,e){const i=Jx.get();return i.set(0,0,0),s instanceof h.Vector3?i.copy(s):Array.isArray(s)?i.set(s[0],s[1],s[2]):s instanceof DOMPointReadOnly?i.set(s.x,s.y,s.z):typeof s=="number"?(i.x=s,i.y=t!==void 0?t:i.x,i.z=e!==void 0?e:i.x):typeof s=="object"&&(i.x=s.x,i.y=s.y,i.z=s.z),i}const eS=new xi(()=>new h.Color,30);function qb(s){const t=eS.get();return s?t.copy(s):t.set(0,0,0),t}const tS=new xi(()=>new h.Quaternion,100);function on(s){const t=tS.get();return t.identity(),s instanceof h.Quaternion?t.copy(s):s instanceof DOMPointReadOnly&&t.set(s.x,s.y,s.z,s.w),t}const Tm=new xi(()=>new h.Vector3,100),A_=Symbol("lastMatrixWorldUpdateKey");function Z(s,t=null,e=!0){const i=t??Tm.get();return s?s.parent?(e&&s.updateWorldMatrix(!0,!1),s.matrixWorldNeedsUpdate&&s[A_]!==Date.now()&&(s[A_]=Date.now(),s.updateMatrixWorld()),i.setFromMatrixPosition(s.matrixWorld),i):i.copy(s.position):i.set(0,0,0)}function it(s,t){if(!s)return s;const e=Tm.get();return t!==e&&e.copy(t),((s==null?void 0:s.parent)??s).worldToLocal(e),s.position.set(e.x,e.y,e.z),s}function ar(s,t,e,i){const n=Tm.get();return n.set(t,e,i),it(s,n),s}const Dd=new xi(()=>new h.Quaternion,100),Yo=new h.Quaternion,gf=new h.Quaternion;function _e(s,t=null){if(!s)return Dd.get().identity();const e=t??Dd.get();return s.parent?(s.getWorldQuaternion(e),e):e.copy(s.quaternion)}function Wi(s,t){if(!s)return;t!==Yo&&Yo.copy(t);const e=Yo,i=s==null?void 0:s.parent;i==null||i.getWorldQuaternion(gf),gf.invert();const n=gf.multiply(e);s.quaternion.set(n.x,n.y,n.z,n.w)}function Am(s,t,e,i,n){Yo.set(t,e,i,n),Wi(s,Yo)}const iS=new xi(()=>new h.Vector3,100),nS=new h.Vector3;function Ue(s,t=null){return t||(t=iS.get()),s?s.parent?(s.getWorldScale(t),t):t.copy(s.scale):t.set(0,0,0)}function Ea(s,t){if(!s)return;if(!s.parent){s.scale.copy(t);return}const e=nS;s.parent.getWorldScale(e),s.scale.copy(t),s.scale.divide(e)}const sS=new h.Vector3,D_=new h.Quaternion;function oS(s){return _e(s,D_),sS.set(0,0,1).applyQuaternion(D_)}const rS=new xi(()=>new h.Vector3,100),L_=new h.Quaternion;function Xb(s,t){return t||(t=rS.get().set(0,0,1)),_e(s,L_),t.applyQuaternion(L_)}const I_=new h.Euler,j_=new h.Euler,aS=new h.Vector3;function Dm(s){const t=Dd.get();return s.getWorldQuaternion(t),j_.setFromQuaternion(t),j_}function Lm(s,t){const e=Dd.get();Wi(s,e.setFromEuler(t))}function Nc(s){const t=Dm(s),e=aS;return e.set(t.x,t.y,t.z),e.x=z.toDegrees(e.x),e.y=z.toDegrees(e.y),e.z=z.toDegrees(e.z),e}function Im(s,t){Vc(s,t.x,t.y,t.z,!0)}function Vc(s,t,e,i,n=!0){n&&(t=z.toRadians(t),e=z.toRadians(e),i=z.toRadians(i)),I_.set(t,e,i),Yo.setFromEuler(I_),Wi(s,Yo)}function Ld(s,t=!0){s&&(t?function e(i){console.groupCollapsed((i.name?i.name:"(no name : "+i.type+")")+" %o",i),i.children.forEach(e),console.groupEnd()}(s):s.traverse(function(e){for(var i="|___",n=e;n.parent!==null;)i="	"+i,n=n.parent;console.log(i+e.name+" <"+e.type+">")}))}function lS(s){let t=(s==null?void 0:s.name)||"";if(!s)return t;let e=s.parent;for(;e;)t=e.name+"/"+t,e=e.parent;return t}function Qb(s){if(s){const t=s;return t.blendMode!==void 0&&t.clampWhenFinished!==void 0&&t.enabled!==void 0&&t.fadeIn!==void 0&&t.getClip!==void 0}return!1}class ji{static createBlitMaterial(t){return new h.ShaderMaterial({uniforms:{map:new h.Uniform$1(null)},vertexShader:this.vertex,fragmentShader:t})}static copyTexture(t,e){this.blitMaterial||(this.blitMaterial=new h.ShaderMaterial({uniforms:{map:new h.Uniform$1(null)},vertexShader:this.vertex,fragmentShader:this.fragment}));const i=e||this.blitMaterial;i.uniforms.map.value=t,i.needsUpdate=!0,i.uniformsNeedUpdate=!0;const n=i.vertexShader;i.vertexShader=this.vertex,this.mesh||(this.mesh=new h.Mesh(this.planeGeometry,this.blitMaterial));const o=this.mesh;o.material=i,o.frustumCulled=!1,this.scene.children.length=0,this.scene.add(o),this.renderer||(this.renderer=new h.WebGLRenderer({antialias:!1})),this.renderer.setSize(t.image.width,t.image.height),this.renderer.clear(),this.renderer.render(this.scene,this.perspectiveCam);const a=new h.Texture(this.renderer.domElement);return a.name="Copy",a.needsUpdate=!0,i.vertexShader=n,a}static textureToCanvas(t,e=!1){if(!t)return null;(e===!0||t.isCompressedTexture===!0)&&(t=Yb(t));const i=t.image;if(hS(i)){const n=document.createElement("canvas");n.width=i.width,n.height=i.height;const o=n.getContext("2d");return o?(o.drawImage(i,0,0,i.width,i.height,0,0,n.width,n.height),n):(console.error("Failed getting canvas 2d context"),null)}return null}}r(ji,"planeGeometry",new h.PlaneGeometry(2,2,1,1)),r(ji,"renderer"),r(ji,"perspectiveCam",new h.PerspectiveCamera),r(ji,"scene",new h.Scene),r(ji,"vertex",`
    varying vec2 vUv;
    void main(){
        vUv = uv;
        gl_Position = vec4(position.xy * 1.0,0.,.999999);
    }`),r(ji,"fragment",`
    uniform sampler2D map; 
    varying vec2 vUv;
    void main(){ 
        vec2 uv = vUv;
        uv.y = 1.0 - uv.y;
        gl_FragColor = texture2D( map, uv);
        // gl_FragColor = vec4(uv.xy, 0, 1);
    }`),r(ji,"blitMaterial"),r(ji,"mesh");function Yb(s){return ji.copyTexture(s)}function cS(s,t=!1){return ji.textureToCanvas(s,t)}function hS(s){return typeof HTMLImageElement<"u"&&s instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&s instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&s instanceof OffscreenCanvas||typeof ImageBitmap<"u"&&s instanceof ImageBitmap}function dS(s){const t=s.type;return t==="Mesh"||t==="SkinnedMesh"}function jm(s,t){t?s["needle:rendercustomshadow"]=!0:s["needle:rendercustomshadow"]=!1}function Kb(s){if(s){if(s["needle:rendercustomshadow"]===!0)return!0;if(s["needle:rendercustomshadow"]==null)return!0}return!1}function si(s,t=void 0,e=void 0,i=void 0){const n=i||new h.Box3;n.makeEmpty();const o=[];function a(c){let d=!0;if(c.visible&&Gb(c)!==!1&&!(c.type==="TransformControlsGizmo"||c.type==="TransformControlsPlane")){if(c instanceof h.Box3Helper&&(d=!1),c instanceof h.GridHelper&&(d=!1),c instanceof Y.GroundedSkybox&&(d=!1),c.isGizmo===!0&&(d=!1),c.material instanceof h.ShadowMaterial&&(d=!1),dS(c)||(d=!1),e&&c.layers.test(e)===!1&&(d=!1),d){if(t&&Array.isArray(t)&&(t!=null&&t.includes(c)))return;if(typeof t=="function"&&t(c)===!0)return}if(c.isUI!==!0){if(d){const u=c.children;c.children=o;const f=c.position,m=c.scale;if(Number.isNaN(f.x)||Number.isNaN(f.y)||Number.isNaN(f.z)){console.warn(`Object "${c.name}" has NaN values in position or scale.... will ignore it`,f,m);return}n.expandByObject(c,!0),c.children=u}for(const u of c.children)a(u)}}}let l=!1;Array.isArray(s)||(s=[s]);for(const c of s)c&&(l=!0,c.updateMatrixWorld(),a(c));return l||console.warn("No objects to fit camera to..."),n}function Zb(s,t,e){const i=si([s],e==null?void 0:e.ignore),n=new h.Vector3;i.getSize(n);const o=new h.Vector3;i.getCenter(o);const a=new h.Vector3;t.getSize(a);const l=new h.Vector3;t.getCenter(l);const c=new h.Vector3;c.set(a.x/n.x,a.y/n.y,a.z/n.z);const d=Math.min(c.x,c.y,c.z),u=(e==null?void 0:e.scale)!==!1;if(u&&Ea(s,Ue(s).multiplyScalar(d)),(e==null?void 0:e.position)!==!1){const f=new h.Vector3;i.getCenter(f),f.y=i.min.y;const m=new h.Vector3;t.getCenter(m),m.y=t.min.y;const g=m.clone().sub(f);u&&g.multiplyScalar(d),it(s,Z(s).add(g))}return{boundsBefore:i,scale:c}}function Jb(s,t){const e=si([s]),i=new h.Vector3;e.getCenter(i),i.y=e.min.y;const n=t.clone().sub(i),o=Z(s);return it(s,o.add(n)),{offset:n,bounds:e}}function Bm(s,t,e,i){if(Array.isArray(t)){let a=!0;for(let l=0;l<t.length;l++)Bm(s,t[l],l,t)||(a=!1);return a}if(t.type==="MeshStandardMaterial"||t.type==="MeshBasicMaterial")return!1;if(t["material:fbx"]!=null)return!0;const n=new h.MeshStandardMaterial;n["material:fbx"]=t;const o=t;return o&&(o.map?n.color.set(1,1,1):n.color.copyLinearToSRGB(o.color),n.emissive.copyLinearToSRGB(o.emissive),n.emissiveIntensity=o.emissiveIntensity,n.opacity=o.opacity,n.displacementScale=o.displacementScale,n.transparent=o.transparent,n.bumpMap=o.bumpMap,n.aoMap=o.aoMap,n.map=o.map,n.displacementMap=o.displacementMap,n.emissiveMap=o.emissiveMap,n.normalMap=o.normalMap,n.envMap=o.envMap,n.alphaMap=o.alphaMap,n.metalness=o.reflectivity,n.vertexColors=o.vertexColors,o.shininess&&(n.roughness=1-Math.sqrt(o.shininess)/10),n.needsUpdate=!0),e===void 0?s.material=n:i[e]=n,!0}let Eh=!1;Fx((...s)=>{var t;B()&&((t=ce.Current)!=null&&t.isInXR)&&(Ko(!0),e0("error",...s))});function Ko(s){if(s){if(Eh)return;Eh=!0,fS()}else{if(!Eh)return;Eh=!1,pS()}}const Zl={log:void 0,warn:void 0,error:void 0};class uS{constructor(){r(this,"familyName","needle-xr");r(this,"root",null);r(this,"context",null);r(this,"defaultFontSize",.06);r(this,"targetObject",new h.Object3D);r(this,"userForwardViewPoint",new h.Vector3);r(this,"oneEuroFilter",new Em(90,.8));r(this,"_lastElementRemoveTime",0);r(this,"onBeforeRender",()=>{var e,i;const t=(e=this.context)==null?void 0:e.mainCamera;if(this.context&&t instanceof h.PerspectiveCamera){const n=this.getRoot();Number.isNaN(n.position.x)&&n.position.set(0,0,0),Number.isNaN(n.quaternion.x)&&n.quaternion.set(0,0,0,1),this.context.scene.add(this.targetObject);const o=((i=this.context.xr)==null?void 0:i.rigScale)??1,a=3.5*o,l=t.worldForward;l.y=0,l.normalize().multiplyScalar(a),this.userForwardViewPoint.copy(t.worldPosition).sub(l),this.targetObject.position.distanceTo(this.userForwardViewPoint)>2*o&&(this.targetObject.position.copy(this.userForwardViewPoint),zc(this.targetObject,t,!0,!0),this.targetObject.rotateY(Math.PI)),this.oneEuroFilter.filter(this.targetObject.position,n.position,this.context.time.time);const d=this.context.time.deltaTime;if(n.quaternion.slerp(this.targetObject.quaternion,d*5),n.scale.setScalar(o),this.targetObject.removeFromParent(),this.context.scene.add(n),this.context.time.time-this._lastElementRemoveTime>.1){this._lastElementRemoveTime=this.context.time.time;const u=Date.now();for(let f=0;f<this._activeTexts.length;f++){const m=this._activeTexts[f];if(m instanceof ie.__webpack_exports__default.Text&&u-m._activatedTime>2e4){m.removeFromParent(),this._textBuffer.push(m),this._activeTexts.splice(f,1);break}}}}});r(this,"textOptions",{fontSize:this.defaultFontSize,fontFamily:this.familyName,padding:.03,margin:.005,color:0,backgroundColor:16777215,backgroundOpacity:.4,borderRadius:.03,offset:.025});r(this,"_textBuffer",[]);r(this,"_activeTexts",[]);this.ensureFont()}onEnable(){this.context=ce.Current||ce.All[0],this.context.pre_render_callbacks.push(this.onBeforeRender)}onDisable(){var t,e,i;(e=this.context)==null||e.pre_render_callbacks.splice((t=this.context)==null?void 0:t.pre_render_callbacks.indexOf(this.onBeforeRender),1),(i=this.root)==null||i.removeFromParent()}addLog(t,e){const i=this.getRoot(),n=this.getText();let o=16777215,a=0;switch(t){case"log":o=16777215,a=0;break;case"warn":o=16772761,a=4465152;break;case"error":o=16755370,a=7798784;break}e.length>1e3&&(e=e.substring(0,1e3)+"...");const l=new Date().toISOString().split("T")[1].split(".")[0];n.textContent="["+l+"] "+e,n.visible=!0,n._activatedTime=Date.now(),i.add(n),this._activeTexts.push(n),this.context&&this.context.scene.add(i),n.set({backgroundColor:o,color:a}),ie.__webpack_exports__default.update()}ensureFont(){let t=ie.__webpack_exports__default.FontLibrary.getFontFamily(this.familyName);if(!t){t=ie.__webpack_exports__default.FontLibrary.addFontFamily(this.familyName);const e=t.addVariant("normal","normal","./include/needle/arial-msdf.json","./include/needle/arial.png");e==null||e.addEventListener("ready",()=>{ie.__webpack_exports__default.update()})}}getText(){const t=this.getRoot();if(this._textBuffer.length>0){const i=this._textBuffer.pop();return i.visible=!0,setTimeout(()=>this.disableDepthTestRecursive(i),100),i}if(t.children.length>20&&this._activeTexts.length>0)return this._activeTexts.shift();const e=new ie.__webpack_exports__default.Text(this.textOptions);return setTimeout(()=>this.disableDepthTestRecursive(e),500),setTimeout(()=>this.disableDepthTestRecursive(e),1500),e}disableDepthTestRecursive(t,e=0){for(let n=0;n<t.children.length;n++){const o=t.children[n];o instanceof h.Object3D&&this.disableDepthTestRecursive(o,e+1)}t.renderOrder=10*e,t.layers.set(2);const i=t.material;i&&(i.depthWrite=!1,i.depthTest=!1,i.transparent=!0),e===0&&ie.__webpack_exports__default.update()}getRoot(){if(this.root)return this.root;const t=this.defaultFontSize,e={boxSizing:"border-box",fontFamily:this.familyName,width:"2.6",fontSize:t,color:0,lineHeight:1,backgroundColor:16777215,backgroundOpacity:0,whiteSpace:"pre-wrap",flexDirection:"column-reverse"};return this.root=new ie.__webpack_exports__default.Block(e),this.root}}let $t=null;function fS(){$t||($t=new uS),$t.onEnable();for(const s in Zl){Zl[s]=console[s];let t=!1;console[s]=function(){var e;if((e=Zl[s])==null||e.apply(console,arguments),!t)try{t=!0,e0(s,...arguments)}finally{t=!1}}}}function pS(){$t==null||$t.onDisable();for(const s in Zl)console[s]=Zl[s]}const gl=new Map;function e0(s,...t){try{switch(gl.clear(),s){case"log":$t==null||$t.addLog("log",e());break;case"warn":$t==null||$t.addLog("warn",e());break;case"error":$t==null||$t.addLog("error",e());break}}catch(o){console.error("Error in spatial console",o)}finally{gl.clear()}function e(){let o="";for(let a=0;a<t.length;a++){const l=t[a];o+=i(l),a<t.length-1&&(o+=", ")}return o}function i(o,a=0){if(typeof o=="string")return'"'+o+'"';if(typeof o=="number"){if(o%1!==0){const c=o.toFixed(5),d=c.indexOf(".");let u=c.length-1;for(;u>d&&c[u]==="0";)u--;return c.substring(0,u+1)}return o.toString()}else if(Array.isArray(o)){let l="[";for(let c=0;c<o.length;c++){const d=o[c];l+=i(d,a+1),c<o.length-1&&(l+=", ")}return l+="]",l}else{if(o===null)return"null";if(o===void 0)return"undefined";if(typeof o=="function")return o.name+"()"}if(o instanceof h.Vector2)return`(${i(o.x)}, ${i(o.y)})`;if(o instanceof h.Vector3)return`(${i(o.x)}, ${i(o.y)}, ${i(o.z)})`;if(o instanceof h.Vector4)return`(${i(o.x)}, ${i(o.y)}, ${i(o.z)}, ${i(o.w)})`;if(o instanceof h.Quaternion)return`(${i(o.x)}, ${i(o.y)}, ${i(o.z)}, ${i(o.w)})`;if(o instanceof h.Material||o instanceof h.Texture)return o.name;if(o instanceof h.Matrix3)return`[${o.elements.join(", ")}]`;if(o instanceof h.Matrix4)return`[${o.elements.join(", ")}]`;if(o instanceof h.Layers)return o.mask.toString();if(typeof o=="object"){if(gl.has(o))return"*";let l=`{
`;l+=n(a);const c=Object.keys(o);let d="";for(let u=0;u<c.length;u++){const f=c[u],m=o[f];if(gl.has(m)){d+="";continue}gl.set(m,!0),d+=f+":"+i(m,a+1),u<c.length-1&&(d+=", "),d.length>=60&&(d+=`
`,d+=n(a),l+=d,d="")}return l+=d,l+=`
}`,l}return o}function n(o){let a="";for(let l=0;l<o;l++)a+=" ";return a}}const mS=x("nodevlogs");function Te(s,t=bi.Log){Tn(t,s)}function pe(s){Te(s,bi.Warn)}function $c(s){Te(s,bi.Error)}let Up,_f;function B(){if(mS)return!1;if(Up!==void 0)return Up;if(_f!==void 0)return _f;let s=Ht();return s||(s=window.location.hostname.endsWith(".local-credentialless.webcontainer.io")),_f=s,s}function gS(s){Up=s}let Wt,mi=null,An=null,_l=!1,B_=null;const t0="terminal",Ll=x("console"),_S=x("noerrors")||x("noconsole")||window.crossOriginIsolated;Ll&&Fm();if(!_S&&(Ll||Ht())){if(Ht()&&!Ll){const t=new URL(window.location.href);t.searchParams.set("console","1"),console.log('🌵 Tip: You can add the "?console" query parameter to the url to show the debug console (on mobile it will automatically open in the bottom right corner when your get errors during development. In VR a spatial console will appear.)',`
Open this page to get the console: `+t.toString())}const s=exports.DeviceUtilities.isMobileDevice()||exports.DeviceUtilities.isQuest()&&B();if((s||Ll)&&(Nx(),n0(),s0(!0),s)){const t=document.querySelector("needle-engine");t==null||t.addEventListener("enter-ar",()=>{(Ll||Wt||km()>0)&&x("noerrors")}),t==null||t.addEventListener("exit-ar",()=>{wS()})}}const zp=Symbol("consoleParent");function Fm(){if(Wt){Wt.showSwitch();return}s0()}function i0(){Wt&&(Wt.hide(),Wt.hideSwitch())}function n0(){B_||(B_=setInterval(yS,500))}let F_=0;function yS(){const s=km(),t=s!==F_;F_=s,t&&bS()}function bS(){Fm(),An&&(An.setAttribute("error","true"),An.innerText="🤬")}function vS(){An&&(An.removeAttribute("error"),An.innerText=t0)}function wS(){mi&&mi[zp]&&mi[zp].appendChild(mi)}function s0(s=!1){if(Wt!==void 0||_l)return;_l=!0;const t=document.createElement("script");t.onload=()=>{if(!globalThis.VConsole){console.warn("🌵 Debug console failed to load."),_l=!1,Wt=null;return}_l=!1,n0(),Wt=new VConsole({pluginOrder:["default","needle-console"]});const e=globalThis["needle:codegen_files"];if(e&&e.length>0&&Wt.addPlugin(xS()),mi=CS(),mi&&(mi[zp]=mi.parentElement,mi.style.position="absolute",mi.style.zIndex=Number.MAX_SAFE_INTEGER.toString()),Wt.setSwitchPosition(20,30),An=SS(),An){An.innerText=t0,An.addEventListener("click",vS);const i=document.createElement("style"),n=40;i.innerHTML=`
                #__vconsole .vc-switch {
                    border: 1px solid rgba(255, 255, 255, .1);
                    border-radius: 50%;
                    width: ${n}px;
                    height: ${n}px;
                    padding: 0;
                    line-height: ${n}px;
                    font-size: ${n*.4}px;
                    text-align: center;
                    background: #ffffff5c;
                    backdrop-filter: blur(16px);
                    -webkit-backdrop-filter: blur(16px);
                    user-select: none;
                    pointer-events: auto;
                    transition: transform .2s ease-in-out;
                    box-shadow: 0px 7px 0.5rem 0px rgb(0 0 0 / 6%), inset 0px 0px 1.3rem rgba(0,0,0,.05);

                    font-family: 'Material Symbols Outlined';
                    color: black;
                    font-size: 2.3em;
                    font-weight: 100;
                }
                #__vconsole .vc-switch:hover {
                    cursor: pointer;
                    transform: scale(1.1);
                    transition: transform .1s ease-in-out, background .1s linear;
                    background: rgba(245, 245, 245, .8);
                    outline: rgba(0, 0, 0, .05) 1px solid;
                }
                #__vconsole .vc-switch[error] {
                    background: rgba(255,0,0,.2);
                    animation: vconsole-notify 1s ease-in-out;
                    line-height: 35px;
                }
                @keyframes vconsole-notify {
                    from {
                        transform: scale(1, 1);
                    }
                    10% {
                        transform: scale(1.3, 1.3);
                    }
                    70% {
                        transform: scale(1.4, 1.4);
                    }
                    to {
                        transform: scale(1, 1);
                    }
                }
                #__vconsole .vc-panel {
                    font-family: monospace;
                    font-size: 11px;
                }
                #__vconsole .vc-plugin-box.vc-actived {
                    height: 100%;
                }
                #__vconsole .vc-mask {
                    overflow: hidden;
                }
            `,mi==null||mi.prepend(i),s===!0&&km()<=0&&i0(),console.log("🌵 Debug console has loaded")}},t.onerror=()=>{console.warn("🌵 Debug console failed to load."+(window.crossOriginIsolated?"This page is using cross-origin isolation, so external scripts can't be loaded.":"")),_l=!1,Wt=null},t.src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js",document.body.appendChild(t)}function xS(){if(!globalThis.VConsole)return;const s=new VConsole.VConsolePlugin("needle-console","🌵 Inspect glTF"),t=()=>document.querySelector("#__vc_plug_"+s._id+" iframe");return s.on("renderTab",function(e){const i=globalThis["needle:codegen_files"];if(!i||i.length===0)return;let n=globalThis["needle:codegen_files"][0];const o=n.indexOf("?");o>-1&&(n=n.substring(0,o));const l=location.protocol+"//"+location.host+location.pathname+"/"+n,c=encodeURIComponent(l);s.fullUrl="https://viewer.needle.tools?inspect&file="+c;var d='<iframe src="" style="width: 100%; height: 99%; border: none;"></iframe>';e(d)}),s.on("show",function(){const e=t();e&&e.src!==s.fullUrl&&(e.src=s.fullUrl)}),s.on("hide",function(){const e=t();e&&(e.src="")}),s.on("addTopBar",function(e){var i=new Array;i.push({name:"Open in new window ↗",onClick:function(n){window.open(s.fullUrl,"_blank"),Wt==null||Wt.hide()}}),i.push({name:"Reload",onClick:function(n){const o=t();o&&(o.src=s.fullUrl)}}),i.push({name:"Fullscreen",onClick:function(n){const o=t();o.requestFullscreen?o.requestFullscreen():o.webkitRequestFullscreen instanceof Function&&o.webkitRequestFullscreen()}}),e(i)}),s}function SS(){const s=document.querySelector("#__vconsole .vc-switch");return s||null}function CS(){const s=document.querySelector("#__vconsole");return s||null}const o0=x("debugdefines");go('if(!globalThis[""4.4.0-alpha.5""]) globalThis[""4.4.0-alpha.5""] = "0.0.0";');go('if(!globalThis[""undefined""]) globalThis[""undefined""] = "unknown";');go('if(!globalThis[""Thu Mar 27 2025 13:24:31 GMT+0100 (Central European Standard Time)""]) globalThis[""Thu Mar 27 2025 13:24:31 GMT+0100 (Central European Standard Time)""] = "unknown";');go('if(!globalThis[""npk_74222a9fbd1b42572cdd3bf7f639eeb17a07d07f40a6185fac5f722e8fd34df9""]) globalThis[""npk_74222a9fbd1b42572cdd3bf7f639eeb17a07d07f40a6185fac5f722e8fd34df9""] = "unknown";');go('globalThis["__NEEDLE_ENGINE_VERSION__"] = "4.4.0-alpha.5";');go('globalThis["__NEEDLE_ENGINE_GENERATOR__"] = "undefined";');go('globalThis["__NEEDLE_PROJECT_BUILD_TIME__"] = "Thu Mar 27 2025 13:24:31 GMT+0100 (Central European Standard Time)";');go('globalThis["__NEEDLE_PUBLIC_KEY__"] = "npk_74222a9fbd1b42572cdd3bf7f639eeb17a07d07f40a6185fac5f722e8fd34df9";');const ln="4.4.0-alpha.5",wu="undefined",Um="Thu Mar 27 2025 13:24:31 GMT+0100 (Central European Standard Time)";o0&&console.log(`Engine version: ${ln} (generator: ${wu})
Project built at ${Um}`);const Jl="npk_74222a9fbd1b42572cdd3bf7f639eeb17a07d07f40a6185fac5f722e8fd34df9",ps="needle_isActiveInHierarchy",Fo="builtin_components",ec="needle_editor_guid";function go(s){try{(0,eval)(s)}catch(t){o0&&console.error(t)}}const PS='<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 160 187.74"><defs><linearGradient id="a" x1="89.64" y1="184.81" x2="90.48" y2="21.85" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#62d399"/><stop offset=".51" stop-color="#acd842"/><stop offset=".9" stop-color="#d7db0a"/></linearGradient><linearGradient id="b" x1="69.68" y1="178.9" x2="68.08" y2="16.77" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#0ba398"/><stop offset=".5" stop-color="#4ca352"/><stop offset="1" stop-color="#76a30a"/></linearGradient><linearGradient id="c" x1="36.6" y1="152.17" x2="34.7" y2="84.19" gradientUnits="userSpaceOnUse"><stop offset=".19" stop-color="#36a382"/><stop offset=".54" stop-color="#49a459"/><stop offset="1" stop-color="#76a30b"/></linearGradient><linearGradient id="d" x1="15.82" y1="153.24" x2="18" y2="90.86" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#267880"/><stop offset=".51" stop-color="#457a5c"/><stop offset="1" stop-color="#717516"/></linearGradient><linearGradient id="e" x1="135.08" y1="135.43" x2="148.93" y2="63.47" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#b0d939"/><stop offset="1" stop-color="#eadb04"/></linearGradient><linearGradient id="f" x1="-4163.25" y1="2285.12" x2="-4160.81" y2="2215.34" gradientTransform="rotate(20 4088.49 13316.712)" gradientUnits="userSpaceOnUse"><stop offset=".17" stop-color="#74af52"/><stop offset=".48" stop-color="#99be32"/><stop offset="1" stop-color="#c0c40a"/></linearGradient><symbol id="g" viewBox="0 0 160 187.74"><path style="fill:url(#a)" d="M79.32 36.98v150.76L95 174.54l6.59-156.31-22.27 18.75z"/><path style="fill:url(#b)" d="M79.32 36.98 57.05 18.23l6.59 156.31 15.68 13.2V36.98z"/><path style="fill:url(#c)" d="m25.19 104.83 8.63 49.04 12.5-14.95-2.46-56.42-18.67 22.33z"/><path style="fill:url(#d)" d="M25.19 104.83 0 90.24l16.97 53.86 16.85 9.77-8.63-49.04z"/><path style="fill:#9c3" d="M43.86 82.5 18.69 67.98 0 90.24l25.18 14.59L43.86 82.5z"/><path style="fill:url(#e)" d="m134.82 78.69-9.97 56.5 15.58-9.04L160 64.1l-25.18 14.59z"/><path style="fill:url(#f)" d="m134.82 78.69-18.68-22.33-2.86 65 11.57 13.83 9.97-56.5z"/><path style="fill:#ffe113" d="m160 64.1-18.69-22.26-25.17 14.52 18.67 22.33L160 64.1z"/><path style="fill:#f3e600" d="M101.59 18.23 79.32 0 57.05 18.23l22.27 18.75 22.27-18.75z"/></symbol></defs><use width="160" height="187.74" xlink:href="#g"/></svg>',OS=btoa(PS),MS="data:image/svg+xml;base64,"+OS,RS=MS,kS=`<?xml version="1.0" encoding="UTF-8"?> <!DOCTYPE svg PUBLIC '-//W3C//DTD SVG 1.1//EN' 'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'> <svg clip-rule="evenodd" fill-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="2" version="1.1" viewBox="0 0 1014 282" xml:space="preserve" xmlns="http://www.w3.org/2000/svg"> <g transform="matrix(1.008 0 0 1.008 -2.239 .61874)"> <path d="m665.95 132.73v44.88l-10.56-8.4c-0.8-0.64-1.2-1.44-1.2-2.4v-32.4c0-6.48-4.12-9.72-12.36-9.72-2.16 0-4.18 0.4-6.06 1.2s-3.54 1.8-4.98 3-2.56 2.5-3.36 3.9-1.2 2.7-1.2 3.9v40.92l-10.68-8.4c-0.72-0.64-1.08-1.44-1.08-2.4v-53.76l10.92 8.52c0.32 0.24 0.56 0.44 0.72 0.6s0.36 0.32 0.6 0.48c0.96-1.2 2.14-2.28 3.54-3.24s2.92-1.76 4.56-2.4 3.34-1.14 5.1-1.5 3.44-0.54 5.04-0.54c1.44 0 2.92 0.04 4.44 0.12s2.84 0.28 3.96 0.6c4.56 1.12 7.8 3.12 9.72 6s2.88 6.56 2.88 11.04z" fill-rule="nonzero"/> </g> <g transform="matrix(1.008 0 0 1.008 -2.239 .61874)"> <path d="m732.38 146.05c0 0.88 0.02 1.5 0.06 1.86s-0.02 0.98-0.18 1.86h-7.08c-2.08 0-4.44-0.02-7.08-0.06s-5.36-0.06-8.16-0.06h-22.08c0 2.88 0.56 5.36 1.68 7.44s2.6 3.8 4.44 5.16 3.94 2.36 6.3 3 4.74 0.96 7.14 0.96c3.04 0 5.9-0.76 8.58-2.28s4.94-3.52 6.78-6c0.64 0.56 1.54 1.48 2.7 2.76s2.94 3.2 5.34 5.76c-2.8 3.36-6.22 6.02-10.26 7.98s-8.42 2.94-13.14 2.94-8.92-0.64-12.84-1.92-7.32-3.24-10.2-5.88-5.12-5.98-6.72-10.02-2.4-8.82-2.4-14.34c0-4.96 0.66-9.42 1.98-13.38s3.22-7.32 5.7-10.08 5.44-4.9 8.88-6.42 7.32-2.28 11.64-2.28c5.76 0 10.52 0.88 14.28 2.64s6.72 4.16 8.88 7.2 3.66 6.54 4.5 10.5 1.26 8.18 1.26 12.66zm-29.4-22.8c-2.16 0.16-4.16 0.72-6 1.68s-3.42 2.2-4.74 3.72-2.36 3.28-3.12 5.28-1.14 4.12-1.14 6.36h33.12c0-2-0.22-4.06-0.66-6.18s-1.3-4.02-2.58-5.7-3.1-3.02-5.46-4.02-5.5-1.38-9.42-1.14z" fill-rule="nonzero"/> </g> <g transform="matrix(1.008 0 0 1.008 -2.239 .61874)"> <path d="m795.93 146.05c0 0.88 0.02 1.5 0.06 1.86s-0.02 0.98-0.18 1.86h-7.08c-2.08 0-4.44-0.02-7.08-0.06s-5.36-0.06-8.16-0.06h-22.08c0 2.88 0.56 5.36 1.68 7.44s2.6 3.8 4.44 5.16 3.94 2.36 6.3 3 4.74 0.96 7.14 0.96c3.04 0 5.9-0.76 8.58-2.28s4.94-3.52 6.78-6c0.64 0.56 1.54 1.48 2.7 2.76s2.94 3.2 5.34 5.76c-2.8 3.36-6.22 6.02-10.26 7.98s-8.42 2.94-13.14 2.94-8.92-0.64-12.84-1.92-7.32-3.24-10.2-5.88-5.12-5.98-6.72-10.02-2.4-8.82-2.4-14.34c0-4.96 0.66-9.42 1.98-13.38s3.22-7.32 5.7-10.08 5.44-4.9 8.88-6.42 7.32-2.28 11.64-2.28c5.76 0 10.52 0.88 14.28 2.64s6.72 4.16 8.88 7.2 3.66 6.54 4.5 10.5 1.26 8.18 1.26 12.66zm-29.4-22.8c-2.16 0.16-4.16 0.72-6 1.68s-3.42 2.2-4.74 3.72-2.36 3.28-3.12 5.28-1.14 4.12-1.14 6.36h33.12c0-2-0.22-4.06-0.66-6.18s-1.3-4.02-2.58-5.7-3.1-3.02-5.46-4.02-5.5-1.38-9.42-1.14z" fill-rule="nonzero"/> </g> <g transform="matrix(1.008 0 0 1.008 -2.239 .61874)"> <path d="m858.57 97.21c0.64 0.48 0.96 1.16 0.96 2.04v74.88c-0.08 1.04-0.12 2.12-0.12 3.24-1.84-1.52-3.56-2.92-5.16-4.2-1.36-1.12-2.66-2.18-3.9-3.18s-2.06-1.66-2.46-1.98c-1.76 2.48-4.26 4.44-7.5 5.88s-7.02 2.16-11.34 2.16c-3.84 0-7.4-0.7-10.68-2.1s-6.14-3.44-8.58-6.12-4.34-5.94-5.7-9.78-2.04-8.16-2.04-12.96c0-4.32 0.78-8.34 2.34-12.06s3.6-6.92 6.12-9.6 5.38-4.78 8.58-6.3 6.48-2.28 9.84-2.28c2.56 0 4.82 0.22 6.78 0.66s3.68 1.06 5.16 1.86 2.78 1.74 3.9 2.82 2.16 2.22 3.12 3.42v-35.04l10.68 8.64zm-27.96 67.92c3.6 0 6.52-0.68 8.76-2.04s3.98-3.06 5.22-5.1 2.1-4.22 2.58-6.54 0.72-4.44 0.72-6.36v-1.2c0-1.12-0.22-2.7-0.66-4.74s-1.28-4.06-2.52-6.06-3-3.7-5.28-5.1-5.22-2.02-8.82-1.86c-3.44 0-6.26 0.74-8.46 2.22s-3.96 3.26-5.28 5.34-2.24 4.2-2.76 6.36-0.78 3.92-0.78 5.28c0 1.84 0.24 3.92 0.72 6.24s1.36 4.48 2.64 6.48 3.04 3.68 5.28 5.04 5.12 2.04 8.64 2.04z" fill-rule="nonzero"/> </g> <g transform="matrix(1.008 0 0 1.008 -2.239 .61874)"> <path d="m882.81 97.09c0.64 0.48 0.96 1.12 0.96 1.92l-0.12 41.04v37.08l-10.56-8.4c-0.72-0.64-1.08-1.44-1.08-2.4v-77.88l10.8 8.64z" fill-rule="nonzero"/> </g> <g transform="matrix(1.008 0 0 1.008 -2.239 .61874)"> <path d="m950.36 146.05c0 0.88 0.02 1.5 0.06 1.86s-0.02 0.98-0.18 1.86h-7.08c-2.08 0-4.44-0.02-7.08-0.06s-5.36-0.06-8.16-0.06h-22.08c0 2.88 0.56 5.36 1.68 7.44s2.6 3.8 4.44 5.16 3.94 2.36 6.3 3 4.74 0.96 7.14 0.96c3.04 0 5.9-0.76 8.58-2.28s4.94-3.52 6.78-6c0.64 0.56 1.54 1.48 2.7 2.76s2.94 3.2 5.34 5.76c-2.8 3.36-6.22 6.02-10.26 7.98s-8.42 2.94-13.14 2.94-8.92-0.64-12.84-1.92-7.32-3.24-10.2-5.88-5.12-5.98-6.72-10.02-2.4-8.82-2.4-14.34c0-4.96 0.66-9.42 1.98-13.38s3.22-7.32 5.7-10.08 5.44-4.9 8.88-6.42 7.32-2.28 11.64-2.28c5.76 0 10.52 0.88 14.28 2.64s6.72 4.16 8.88 7.2 3.66 6.54 4.5 10.5 1.26 8.18 1.26 12.66zm-29.4-22.8c-2.16 0.16-4.16 0.72-6 1.68s-3.42 2.2-4.74 3.72-2.36 3.28-3.12 5.28-1.14 4.12-1.14 6.36h33.12c0-2-0.22-4.06-0.66-6.18s-1.3-4.02-2.58-5.7-3.1-3.02-5.46-4.02-5.5-1.38-9.42-1.14z" fill-rule="nonzero"/> </g> <g transform="matrix(1.8559 0 0 .7642 45.348 36.475)"> <g transform="translate(2.7114)"> <path d="m3.935 173.02c-0.331 0-0.497-0.402-0.497-1.207v-51.002c0-0.738 0.138-1.107 0.414-1.107h1.781c0.277 0 0.415 0.335 0.415 1.006v5.935c0 0.336 0.027 0.553 0.083 0.654 0.055 0.101 0.151-0.017 0.289-0.352 0.912-1.744 1.754-3.236 2.527-4.477 0.773-1.24 1.554-2.179 2.341-2.816s1.65-0.956 2.588-0.956c1.685 0 3.011 0.922 3.977 2.766 0.967 1.845 1.602 3.84 1.905 5.986 0.056 0.268 0.139 0.369 0.249 0.302s0.221-0.235 0.331-0.503c0.939-1.811 1.802-3.353 2.589-4.628 0.787-1.274 1.581-2.246 2.382-2.917s1.671-1.006 2.61-1.006c2.016 0 3.569 1.392 4.66 4.175 1.09 2.783 1.636 6.421 1.636 10.915v37.925c0 0.871-0.18 1.307-0.539 1.307h-1.739c-0.138 0-0.249-0.1-0.332-0.301-0.083-0.202-0.124-0.503-0.124-0.906v-36.315c0-3.555-0.338-6.321-1.015-8.3-0.676-1.978-1.76-2.967-3.251-2.967-0.884 0-1.726 0.386-2.527 1.157s-1.519 1.727-2.154 2.867-1.201 2.213-1.699 3.219c-0.248 0.469-0.421 0.905-0.517 1.308-0.097 0.402-0.145 0.972-0.145 1.71v37.221c0 0.871-0.166 1.307-0.497 1.307h-1.74c-0.166 0-0.29-0.1-0.373-0.301-0.083-0.202-0.124-0.503-0.124-0.906v-36.315c0-3.555-0.332-6.321-0.994-8.3-0.663-1.978-1.754-2.967-3.273-2.967-1.242 0-2.375 0.704-3.396 2.112-1.022 1.409-2.223 3.555-3.604 6.439v39.031c0 0.805-0.18 1.207-0.539 1.207h-1.698z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> <g transform="translate(2.7114)"> <path d="m53.642 166.28c-1.077 2.549-2.237 4.477-3.479 5.785-1.243 1.307-2.61 1.961-4.101 1.961-2.154 0-3.853-1.324-5.095-3.973-1.243-2.649-1.864-6.187-1.864-10.613 0-3.488 0.4-6.489 1.201-9.004s1.988-4.51 3.562-5.985c1.574-1.476 3.521-2.414 5.841-2.817l3.686-0.704c0.221-0.067 0.394-0.218 0.518-0.453 0.124-0.234 0.187-0.587 0.187-1.056v-2.917c0-3.89-0.504-6.975-1.512-9.255s-2.354-3.42-4.039-3.42c-1.298 0-2.472 0.72-3.521 2.162s-2.002 3.572-2.858 6.388c-0.083 0.268-0.159 0.453-0.228 0.554-0.069 0.1-0.172 0.083-0.311-0.051l-1.698-1.71c-0.083-0.134-0.138-0.285-0.166-0.453-0.027-0.167 0.014-0.452 0.125-0.855 0.856-3.353 2.009-6.052 3.459-8.098 1.449-2.045 3.224-3.068 5.322-3.068 1.74 0 3.211 0.687 4.412 2.062s2.112 3.37 2.734 5.986c0.621 2.615 0.932 5.7 0.932 9.255v35.712c0 0.536-0.035 0.888-0.104 1.056s-0.2 0.251-0.393 0.251h-1.533c-0.166 0-0.29-0.117-0.373-0.352-0.083-0.234-0.124-0.553-0.124-0.955l-0.083-5.231c-0.055-0.939-0.221-1.006-0.497-0.202zm0.456-19.314c0-1.14-0.194-1.643-0.58-1.509l-3.107 0.603c-1.436 0.202-2.686 0.638-3.749 1.308-1.063 0.671-1.953 1.543-2.671 2.616s-1.257 2.33-1.616 3.772-0.538 3.102-0.538 4.98c0 3.152 0.455 5.616 1.367 7.393 0.911 1.778 2.14 2.666 3.686 2.666 0.939 0 1.85-0.419 2.734-1.257s1.671-1.895 2.361-3.169c0.663-1.408 1.181-2.85 1.553-4.326 0.373-1.475 0.56-2.883 0.56-4.225v-8.852z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> <g transform="translate(2.7114)"> <path d="m79.034 173.02c-0.166 0-0.297-0.117-0.394-0.352-0.096-0.234-0.145-0.553-0.145-0.955v-4.628c0-0.536-0.041-0.838-0.124-0.905s-0.207 0.1-0.373 0.503c-0.276 0.67-0.69 1.593-1.242 2.766-0.553 1.174-1.271 2.23-2.154 3.169-0.884 0.939-1.961 1.408-3.231 1.408-1.74 0-3.314-0.989-4.722-2.967-1.409-1.979-2.534-4.963-3.376-8.953-0.843-3.991-1.264-8.937-1.264-14.838 0-5.701 0.415-10.68 1.243-14.939s1.988-7.595 3.479-10.009c1.492-2.415 3.204-3.622 5.137-3.622 1.436 0 2.616 0.57 3.541 1.71 0.926 1.14 1.719 2.381 2.382 3.722 0.249 0.47 0.414 0.637 0.497 0.503s0.125-0.536 0.125-1.207v-23.841c0-0.805 0.151-1.208 0.455-1.208h1.864c0.276 0 0.414 0.369 0.414 1.107v72.128c0 0.537-0.041 0.905-0.124 1.107-0.083 0.201-0.235 0.301-0.455 0.301h-1.533zm-0.621-42.049c-0.939-2.213-1.885-3.94-2.838-5.181s-2.009-1.861-3.169-1.861c-1.463 0-2.768 0.889-3.914 2.666s-2.044 4.376-2.693 7.796-0.973 7.578-0.973 12.474c0 5.097 0.338 9.272 1.015 12.524 0.676 3.253 1.567 5.651 2.672 7.193 1.104 1.543 2.305 2.314 3.603 2.314 1.188 0 2.258-0.704 3.211-2.113 0.952-1.408 1.705-3.118 2.257-5.13s0.829-3.957 0.829-5.835v-24.847z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> <g transform="translate(2.7114)"> <path d="m89.514 149.38c0 3.42 0.345 6.606 1.035 9.557 0.691 2.951 1.609 5.315 2.755 7.092s2.437 2.666 3.873 2.666c1.519 0 2.837-0.738 3.956-2.213 1.118-1.476 2.064-3.655 2.837-6.539 0.083-0.336 0.166-0.52 0.249-0.554 0.083-0.033 0.179 0.017 0.29 0.151l1.408 1.912c0.221 0.268 0.235 0.67 0.041 1.207-0.69 2.548-1.47 4.661-2.34 6.337-0.87 1.677-1.857 2.935-2.962 3.773-1.104 0.838-2.319 1.257-3.645 1.257-2.043 0-3.838-1.14-5.385-3.42-1.546-2.28-2.761-5.482-3.645-9.607-0.884-4.124-1.325-8.836-1.325-14.134 0-5.901 0.455-10.931 1.367-15.089 0.911-4.158 2.14-7.377 3.686-9.658 1.547-2.28 3.3-3.42 5.261-3.42 1.988 0 3.714 1.073 5.178 3.219 1.463 2.146 2.595 5.231 3.396 9.255s1.201 8.886 1.201 14.587c0 0.469-0.02 0.939-0.062 1.408-0.041 0.469-0.214 0.704-0.517 0.704h-16.362c-0.083 0-0.152 0.151-0.207 0.453-0.056 0.302-0.083 0.654-0.083 1.056zm13.752-6.237c0.304 0 0.497-0.1 0.58-0.302 0.083-0.201 0.124-0.57 0.124-1.106 0-3.219-0.283-6.187-0.849-8.903s-1.367-4.896-2.402-6.539c-1.036-1.643-2.272-2.464-3.708-2.464-1.629 0-2.996 0.955-4.101 2.867-1.104 1.911-1.94 4.342-2.506 7.293s-0.849 6.002-0.849 9.154h13.711z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> <g transform="translate(2.7114)"> <path d="m148.54 119.7c0.165 0 0.283 0.117 0.352 0.352s0.076 0.52 0.02 0.855l-6.254 50.902c-0.028 0.47-0.104 0.788-0.228 0.956s-0.297 0.251-0.518 0.251h-1.615c-0.442 0-0.718-0.402-0.829-1.207l-5.26-40.138c-0.111-0.604-0.201-0.905-0.27-0.905s-0.131 0.301-0.186 0.905l-5.012 40.138c-0.028 0.47-0.097 0.788-0.207 0.956-0.111 0.168-0.277 0.251-0.497 0.251h-1.74c-0.442 0-0.718-0.402-0.829-1.207l-6.503-50.801c-0.055-0.403-0.048-0.721 0.021-0.956s0.2-0.352 0.393-0.352h1.823c0.166 0 0.297 0.067 0.393 0.201 0.097 0.134 0.159 0.403 0.187 0.805l5.302 41.848c0.083 0.671 0.179 0.989 0.29 0.956 0.11-0.034 0.207-0.386 0.29-1.056l5.219-41.949c0.055-0.268 0.124-0.47 0.207-0.604s0.193-0.201 0.331-0.201h1.533c0.138 0 0.262 0.067 0.373 0.201 0.11 0.134 0.179 0.403 0.207 0.805l5.468 41.848c0.083 0.671 0.179 0.989 0.29 0.956 0.11-0.034 0.207-0.386 0.29-1.056l5.053-41.849c0.055-0.335 0.138-0.57 0.249-0.704 0.11-0.134 0.234-0.201 0.373-0.201h1.284z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> <g transform="translate(2.7114)"> <path d="m156.49 171.51c0 0.604-0.042 1.006-0.125 1.208-0.082 0.201-0.262 0.301-0.538 0.301h-1.533c-0.221 0-0.366-0.083-0.435-0.251s-0.103-0.486-0.103-0.956v-50.902c0-0.805 0.152-1.207 0.456-1.207h1.822c0.304 0 0.456 0.402 0.456 1.207v50.6zm0.165-63.979c0 1.207-0.207 1.811-0.621 1.811h-1.905c-0.221 0-0.366-0.135-0.435-0.403s-0.104-0.67-0.104-1.207v-7.847c0-1.006 0.18-1.509 0.539-1.509h1.988c0.359 0 0.538 0.47 0.538 1.409v7.746z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> <g transform="translate(2.7114)"> <path d="m168.3 124.83c-0.221 0-0.331 0.269-0.331 0.805v33.801c0 3.42 0.221 5.667 0.663 6.74 0.441 1.073 1.09 1.609 1.946 1.609h3.024c0.138 0 0.242 0.084 0.311 0.252 0.069 0.167 0.103 0.419 0.103 0.754v2.716c0 0.537-0.138 0.906-0.414 1.107-0.248 0.067-0.614 0.134-1.098 0.201-0.483 0.067-0.959 0.118-1.429 0.151-0.469 0.034-0.828 0.05-1.077 0.05-1.712 0-2.934-0.955-3.665-2.867-0.732-1.911-1.098-5.013-1.098-9.305v-35.108c0-0.604-0.124-0.906-0.373-0.906h-3.521c-0.248 0-0.373-0.268-0.373-0.804v-3.521c0-0.537 0.111-0.805 0.332-0.805h3.686c0.166 0 0.263-0.268 0.29-0.805l0.415-16.095c0-0.805 0.124-1.207 0.372-1.207h1.492c0.303 0 0.455 0.436 0.455 1.307v15.995c0 0.537 0.097 0.805 0.29 0.805h5.468c0.221 0 0.331 0.268 0.331 0.805v3.521c0 0.536-0.124 0.804-0.373 0.804h-5.426z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> <g transform="translate(2.7114)"> <path d="m179.4 173.02c-0.331 0-0.497-0.402-0.497-1.207v-72.329c0-0.738 0.138-1.107 0.414-1.107h1.782c0.276 0 0.414 0.336 0.414 1.006v27.162c0 0.335 0.034 0.536 0.103 0.603s0.159-0.033 0.27-0.302c0.994-1.81 1.898-3.319 2.713-4.526 0.814-1.208 1.629-2.113 2.444-2.717 0.814-0.603 1.691-0.905 2.63-0.905 2.182 0 3.839 1.375 4.971 4.125 1.132 2.749 1.698 6.404 1.698 10.965v37.925c0 0.871-0.166 1.307-0.497 1.307h-1.74c-0.165 0-0.29-0.1-0.373-0.301-0.082-0.202-0.124-0.503-0.124-0.906v-36.315c0-3.555-0.366-6.321-1.097-8.3-0.732-1.978-1.899-2.967-3.501-2.967-0.883 0-1.705 0.318-2.464 0.956-0.76 0.637-1.526 1.576-2.299 2.816-0.773 1.241-1.643 2.834-2.61 4.779v39.031c0 0.805-0.179 1.207-0.538 1.207h-1.699z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> </g> <g transform="matrix(.80638 0 0 .80638 452.53 65.421)" fill-rule="nonzero"> <path d="m79.32 36.98v150.76l15.68-13.2 6.59-156.31-22.27 18.75z" fill="url(#f)"/> <path d="m79.32 36.98-22.27-18.75 6.59 156.31 15.68 13.2v-150.76z" fill="url(#e)"/> <path d="m25.19 104.83 8.63 49.04 12.5-14.95-2.46-56.42-18.67 22.33z" fill="url(#d)"/> <path d="m25.19 104.83-25.19-14.59 16.97 53.86 16.85 9.77-8.63-49.04z" fill="url(#c)"/> <path d="M43.86,82.5L18.69,67.98L0,90.24L25.18,104.83L43.86,82.5Z" fill="#9c3"/> <path d="m134.82 78.69-9.97 56.5 15.58-9.04 19.57-62.05-25.18 14.59z" fill="url(#b)"/> <path d="m134.82 78.69-18.68-22.33-2.86 65 11.57 13.83 9.97-56.5z" fill="url(#a)"/> <path d="m160 64.1-18.69-22.26-25.17 14.52 18.67 22.33 25.19-14.59z" fill="#ffe113"/> <path d="M101.59,18.23L79.32,0L57.05,18.23L79.32,36.98L101.59,18.23Z" fill="#f3e600"/> </g> <defs> <linearGradient id="f" x2="1" gradientTransform="matrix(.84 -162.96 162.96 .84 89.64 184.81)" gradientUnits="userSpaceOnUse"><stop stop-color="#62d399" offset="0"/><stop stop-color="#acd842" offset=".51"/><stop stop-color="#d7db0a" offset=".9"/><stop stop-color="#d7db0a" offset="1"/></linearGradient> <linearGradient id="e" x2="1" gradientTransform="matrix(-1.6,-162.13,162.13,-1.6,69.68,178.9)" gradientUnits="userSpaceOnUse"><stop stop-color="#0ba398" offset="0"/><stop stop-color="#4ca352" offset=".5"/><stop stop-color="#76a30a" offset="1"/></linearGradient> <linearGradient id="d" x2="1" gradientTransform="matrix(-1.9,-67.98,67.98,-1.9,36.6,152.17)" gradientUnits="userSpaceOnUse"><stop stop-color="#36a382" offset="0"/><stop stop-color="#36a382" offset=".19"/><stop stop-color="#49a459" offset=".54"/><stop stop-color="#76a30b" offset="1"/></linearGradient> <linearGradient id="c" x2="1" gradientTransform="matrix(2.18,-62.38,62.38,2.18,15.82,153.24)" gradientUnits="userSpaceOnUse"><stop stop-color="#267880" offset="0"/><stop stop-color="#457a5c" offset=".51"/><stop stop-color="#717516" offset="1"/></linearGradient> <linearGradient id="b" x2="1" gradientTransform="matrix(13.85,-71.96,71.96,13.85,135.08,135.43)" gradientUnits="userSpaceOnUse"><stop stop-color="#b0d939" offset="0"/><stop stop-color="#eadb04" offset="1"/></linearGradient> <linearGradient id="a" x2="1" gradientTransform="matrix(26.159 -64.737 64.737 26.159 107.42 128.14)" gradientUnits="userSpaceOnUse"><stop stop-color="#74af52" offset="0"/><stop stop-color="#74af52" offset=".17"/><stop stop-color="#99be32" offset=".48"/><stop stop-color="#c0c40a" offset="1"/></linearGradient> </defs> </svg>`;btoa(kS);const ES='<svg viewBox="0 0 509 154" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2"><path d="M665.95 132.73v44.88l-10.56-8.4c-.8-.64-1.2-1.44-1.2-2.4v-32.4c0-6.48-4.12-9.72-12.36-9.72-2.16 0-4.18.4-6.06 1.2-1.88.8-3.54 1.8-4.98 3-1.44 1.2-2.56 2.5-3.36 3.9-.8 1.4-1.2 2.7-1.2 3.9v40.92l-10.68-8.4c-.72-.64-1.08-1.44-1.08-2.4v-53.76l10.92 8.52c.32.24.56.44.72.6.16.16.36.32.6.48.96-1.2 2.14-2.28 3.54-3.24 1.4-.96 2.92-1.76 4.56-2.4 1.64-.64 3.34-1.14 5.1-1.5 1.76-.36 3.44-.54 5.04-.54 1.44 0 2.92.04 4.44.12 1.52.08 2.84.28 3.96.6 4.56 1.12 7.8 3.12 9.72 6 1.92 2.88 2.88 6.56 2.88 11.04ZM732.38 146.05c0 .88.02 1.5.06 1.86.04.36-.02.98-.18 1.86h-7.08c-2.08 0-4.44-.02-7.08-.06-2.64-.04-5.36-.06-8.16-.06h-22.08c0 2.88.56 5.36 1.68 7.44 1.12 2.08 2.6 3.8 4.44 5.16 1.84 1.36 3.94 2.36 6.3 3 2.36.64 4.74.96 7.14.96 3.04 0 5.9-.76 8.58-2.28 2.68-1.52 4.94-3.52 6.78-6 .64.56 1.54 1.48 2.7 2.76 1.16 1.28 2.94 3.2 5.34 5.76-2.8 3.36-6.22 6.02-10.26 7.98-4.04 1.96-8.42 2.94-13.14 2.94-4.72 0-8.92-.64-12.84-1.92-3.92-1.28-7.32-3.24-10.2-5.88-2.88-2.64-5.12-5.98-6.72-10.02-1.6-4.04-2.4-8.82-2.4-14.34 0-4.96.66-9.42 1.98-13.38 1.32-3.96 3.22-7.32 5.7-10.08s5.44-4.9 8.88-6.42c3.44-1.52 7.32-2.28 11.64-2.28 5.76 0 10.52.88 14.28 2.64 3.76 1.76 6.72 4.16 8.88 7.2 2.16 3.04 3.66 6.54 4.5 10.5.84 3.96 1.26 8.18 1.26 12.66Zm-29.4-22.8c-2.16.16-4.16.72-6 1.68-1.84.96-3.42 2.2-4.74 3.72-1.32 1.52-2.36 3.28-3.12 5.28-.76 2-1.14 4.12-1.14 6.36h33.12c0-2-.22-4.06-.66-6.18-.44-2.12-1.3-4.02-2.58-5.7-1.28-1.68-3.1-3.02-5.46-4.02-2.36-1-5.5-1.38-9.42-1.14ZM795.93 146.05c0 .88.02 1.5.06 1.86.04.36-.02.98-.18 1.86h-7.08c-2.08 0-4.44-.02-7.08-.06-2.64-.04-5.36-.06-8.16-.06h-22.08c0 2.88.56 5.36 1.68 7.44 1.12 2.08 2.6 3.8 4.44 5.16 1.84 1.36 3.94 2.36 6.3 3 2.36.64 4.74.96 7.14.96 3.04 0 5.9-.76 8.58-2.28 2.68-1.52 4.94-3.52 6.78-6 .64.56 1.54 1.48 2.7 2.76 1.16 1.28 2.94 3.2 5.34 5.76-2.8 3.36-6.22 6.02-10.26 7.98-4.04 1.96-8.42 2.94-13.14 2.94-4.72 0-8.92-.64-12.84-1.92-3.92-1.28-7.32-3.24-10.2-5.88-2.88-2.64-5.12-5.98-6.72-10.02-1.6-4.04-2.4-8.82-2.4-14.34 0-4.96.66-9.42 1.98-13.38 1.32-3.96 3.22-7.32 5.7-10.08s5.44-4.9 8.88-6.42c3.44-1.52 7.32-2.28 11.64-2.28 5.76 0 10.52.88 14.28 2.64 3.76 1.76 6.72 4.16 8.88 7.2 2.16 3.04 3.66 6.54 4.5 10.5.84 3.96 1.26 8.18 1.26 12.66Zm-29.4-22.8c-2.16.16-4.16.72-6 1.68-1.84.96-3.42 2.2-4.74 3.72-1.32 1.52-2.36 3.28-3.12 5.28-.76 2-1.14 4.12-1.14 6.36h33.12c0-2-.22-4.06-.66-6.18-.44-2.12-1.3-4.02-2.58-5.7-1.28-1.68-3.1-3.02-5.46-4.02-2.36-1-5.5-1.38-9.42-1.14ZM858.57 97.21c.64.48.96 1.16.96 2.04v74.88c-.08 1.04-.12 2.12-.12 3.24-1.84-1.52-3.56-2.92-5.16-4.2-1.36-1.12-2.66-2.18-3.9-3.18-1.24-1-2.06-1.66-2.46-1.98-1.76 2.48-4.26 4.44-7.5 5.88-3.24 1.44-7.02 2.16-11.34 2.16-3.84 0-7.4-.7-10.68-2.1-3.28-1.4-6.14-3.44-8.58-6.12-2.44-2.68-4.34-5.94-5.7-9.78-1.36-3.84-2.04-8.16-2.04-12.96 0-4.32.78-8.34 2.34-12.06 1.56-3.72 3.6-6.92 6.12-9.6 2.52-2.68 5.38-4.78 8.58-6.3 3.2-1.52 6.48-2.28 9.84-2.28 2.56 0 4.82.22 6.78.66 1.96.44 3.68 1.06 5.16 1.86s2.78 1.74 3.9 2.82a35.92 35.92 0 0 1 3.12 3.42V88.57l10.68 8.64Zm-27.96 67.92c3.6 0 6.52-.68 8.76-2.04 2.24-1.36 3.98-3.06 5.22-5.1a20.5 20.5 0 0 0 2.58-6.54c.48-2.32.72-4.44.72-6.36v-1.2c0-1.12-.22-2.7-.66-4.74-.44-2.04-1.28-4.06-2.52-6.06s-3-3.7-5.28-5.1c-2.28-1.4-5.22-2.02-8.82-1.86-3.44 0-6.26.74-8.46 2.22-2.2 1.48-3.96 3.26-5.28 5.34-1.32 2.08-2.24 4.2-2.76 6.36-.52 2.16-.78 3.92-.78 5.28 0 1.84.24 3.92.72 6.24.48 2.32 1.36 4.48 2.64 6.48s3.04 3.68 5.28 5.04c2.24 1.36 5.12 2.04 8.64 2.04ZM882.81 97.09c.64.48.96 1.12.96 1.92l-.12 41.04v37.08l-10.56-8.4c-.72-.64-1.08-1.44-1.08-2.4V88.45l10.8 8.64ZM950.36 146.05c0 .88.02 1.5.06 1.86.04.36-.02.98-.18 1.86h-7.08c-2.08 0-4.44-.02-7.08-.06-2.64-.04-5.36-.06-8.16-.06h-22.08c0 2.88.56 5.36 1.68 7.44 1.12 2.08 2.6 3.8 4.44 5.16 1.84 1.36 3.94 2.36 6.3 3 2.36.64 4.74.96 7.14.96 3.04 0 5.9-.76 8.58-2.28 2.68-1.52 4.94-3.52 6.78-6 .64.56 1.54 1.48 2.7 2.76 1.16 1.28 2.94 3.2 5.34 5.76-2.8 3.36-6.22 6.02-10.26 7.98-4.04 1.96-8.42 2.94-13.14 2.94-4.72 0-8.92-.64-12.84-1.92-3.92-1.28-7.32-3.24-10.2-5.88-2.88-2.64-5.12-5.98-6.72-10.02-1.6-4.04-2.4-8.82-2.4-14.34 0-4.96.66-9.42 1.98-13.38 1.32-3.96 3.22-7.32 5.7-10.08s5.44-4.9 8.88-6.42c3.44-1.52 7.32-2.28 11.64-2.28 5.76 0 10.52.88 14.28 2.64 3.76 1.76 6.72 4.16 8.88 7.2 2.16 3.04 3.66 6.54 4.5 10.5.84 3.96 1.26 8.18 1.26 12.66Zm-29.4-22.8c-2.16.16-4.16.72-6 1.68-1.84.96-3.42 2.2-4.74 3.72-1.32 1.52-2.36 3.28-3.12 5.28-.76 2-1.14 4.12-1.14 6.36h33.12c0-2-.22-4.06-.66-6.18-.44-2.12-1.3-4.02-2.58-5.7-1.28-1.68-3.1-3.02-5.46-4.02-2.36-1-5.5-1.38-9.42-1.14Z" style="fill-rule:nonzero" transform="translate(-452.406 -63.709) scale(1.00797)"/><path d="M79.32 36.98v150.76L95 174.54l6.59-156.31-22.27 18.75Z" style="fill:url(#a);fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="M79.32 36.98 57.05 18.23l6.59 156.31 15.68 13.2V36.98Z" style="fill:url(#b);fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="m25.19 104.83 8.63 49.04 12.5-14.95-2.46-56.42-18.67 22.33Z" style="fill:url(#c);fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="M25.19 104.83 0 90.24l16.97 53.86 16.85 9.77-8.63-49.04Z" style="fill:url(#d);fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="M43.86 82.5 18.69 67.98 0 90.24l25.18 14.59L43.86 82.5Z" style="fill:#9c3;fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="m134.82 78.69-9.97 56.5 15.58-9.04L160 64.1l-25.18 14.59Z" style="fill:url(#e);fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="m134.82 78.69-18.68-22.33-2.86 65 11.57 13.83 9.97-56.5Z" style="fill:url(#f);fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="m160 64.1-18.69-22.26-25.17 14.52 18.67 22.33L160 64.1Z" style="fill:#ffe113;fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="M101.59 18.23 79.32 0 57.05 18.23l22.27 18.75 22.27-18.75Z" style="fill:#f3e600;fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><defs><linearGradient id="a" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="matrix(.84 -162.96 162.96 .84 89.64 184.81)"><stop offset="0" style="stop-color:#62d399;stop-opacity:1"/><stop offset=".51" style="stop-color:#acd842;stop-opacity:1"/><stop offset=".9" style="stop-color:#d7db0a;stop-opacity:1"/><stop offset="1" style="stop-color:#d7db0a;stop-opacity:1"/></linearGradient><linearGradient id="b" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="rotate(-90.565 123.412 54.953) scale(162.14)"><stop offset="0" style="stop-color:#0ba398;stop-opacity:1"/><stop offset=".5" style="stop-color:#4ca352;stop-opacity:1"/><stop offset="1" style="stop-color:#76a30a;stop-opacity:1"/></linearGradient><linearGradient id="c" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="scale(-68) rotate(88.4 .881 -1.396)"><stop offset="0" style="stop-color:#36a382;stop-opacity:1"/><stop offset=".19" style="stop-color:#36a382;stop-opacity:1"/><stop offset=".54" style="stop-color:#49a459;stop-opacity:1"/><stop offset="1" style="stop-color:#76a30b;stop-opacity:1"/></linearGradient><linearGradient id="d" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="rotate(-88 87.255 68.431) scale(62.42)"><stop offset="0" style="stop-color:#267880;stop-opacity:1"/><stop offset=".51" style="stop-color:#457a5c;stop-opacity:1"/><stop offset="1" style="stop-color:#717516;stop-opacity:1"/></linearGradient><linearGradient id="e" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="rotate(-79.1 149.53 -14.065) scale(73.28)"><stop offset="0" style="stop-color:#b0d939;stop-opacity:1"/><stop offset="1" style="stop-color:#eadb04;stop-opacity:1"/></linearGradient><linearGradient id="f" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="rotate(-67.997 148.705 -15.558) scale(69.8226)"><stop offset="0" style="stop-color:#74af52;stop-opacity:1"/><stop offset=".17" style="stop-color:#74af52;stop-opacity:1"/><stop offset=".48" style="stop-color:#99be32;stop-opacity:1"/><stop offset="1" style="stop-color:#c0c40a;stop-opacity:1"/></linearGradient></defs></svg>',TS=btoa(ES),AS="data:image/svg+xml;charset=utf-8;base64,"+TS,DS=AS,LS=x("debugpatch");function xu(s,t,e,i){const n=LS===t;if(!e&&!i)return;const o=t+"___needle";jS(s,t,e,i);const a=Object.getOwnPropertyDescriptor(s,t),l=s[t];n&&console.log("Patch",s.constructor.name,t,a,l),a?(n&&console.log("Apply patch with existing descriptor",s.constructor.name,t,a),typeof a.value=="function"&&(s[t]=z_(a.value,s,t))):(n&&console.log("Create patch with new property",s.constructor.name,t,a),Object.defineProperty(s,t,{set:function(c){if(typeof c=="function")this[o]=z_(c,s,t);else{const d=this[o];r0(s,t,this,d,c),this[o]=c,a0(s,t,this,d,c)}},get:function(){const c=this[o];return typeof c=="function"&&c[o]?c[o]:c}}))}function IS(s,t,e){const i=zm(s,t);if(i)for(let n=i.length-1;n>=0;n--){const o=i[n];o.prefix===e&&(o.prefix=null),o.postfix===e&&(o.postfix=null),!o.prefix&&!o.postfix&&i.splice(n,1)}}const U_=Symbol("Needle:Patches:WrappedFunction");function z_(s,t,e){if(s[U_])return s;const i=function(...n){r0(t,e,this,...n);const o=s.apply(this,n);return a0(t,e,this,o,...n),o};return i[U_]=!0,i}const ud="Needle:Patches";function Np(){return globalThis[ud]||(globalThis[ud]=new WeakMap),globalThis[ud]}function zm(s,t){const e=Np().get(s);return e?e.get(t):null}function jS(s,t,e,i){let n=Np().get(s);n||(n=new Map,Np().set(s,n));let o=n.get(t);o||(o=[],n.set(t,o)),o.push({prefix:e,postfix:i})}function r0(s,t,e,...i){var o;if(!e)return;const n=zm(s,t);if(n)for(const a of n)(o=a.prefix)==null||o.call(e,...i)}function a0(s,t,e,i,...n){var a;if(!e)return;const o=zm(s,t);if(o)for(const l of o)(a=l.postfix)==null||a.call(e,i,...n)}const Ta=[];function Su(s){Ta.indexOf(s)===-1&&Ta.push(s)}function BS(s){const t=Ta.indexOf(s);t!==-1&&Ta.splice(t,1)}const Aa=[];function Nm(s){Aa.indexOf(s)===-1&&Aa.push(s)}function FS(s){const t=Aa.indexOf(s);t!==-1&&Aa.splice(t,1)}function l0(s){globalThis.dispatchEvent(new CustomEvent("needle-xrsession-start",{detail:s}));for(let t=0;t<Ta.length;t++)Ta[t](s)}function c0(s){globalThis.dispatchEvent(new CustomEvent("needle-xrsession-end",{detail:s}));for(let t=0;t<Aa.length;t++)Aa[t](s)}const Ze=x("debuginput");var Cu=(s=>(s.Mouse="mouse",s.Touch="touch",s.Controller="controller",s.Hand="hand",s))(Cu||{}),ke=(s=>(s.PointerDown="pointerdown",s.PointerUp="pointerup",s.PointerMove="pointermove",s.KeyDown="keydown",s.KeyUp="keyup",s.KeyPressed="keypress",s))(ke||{});class ns extends PointerEvent{constructor(e,i,n){super(e,n);r(this,"clientZ");r(this,"deviceIndex");r(this,"origin");r(this,"source");r(this,"mode");r(this,"_ray");r(this,"space");r(this,"isClick",!1);r(this,"isDoubleClick",!1);r(this,"_used",!1);r(this,"_pointerid");r(this,"_pointerType");r(this,"_type");r(this,"metadata",{});r(this,"intersections",new Array);r(this,"_immediatePropagationStopped",!1);r(this,"_propagationStopped",!1);this.clientZ=n.clientZ,this._pointerid=n.pointerId,this._pointerType=n.pointerType,this._type=e,this.deviceIndex=n.deviceIndex,this.origin=n.origin,this.source=i,this.mode=n.mode,this._ray=n.ray,this.space=n.device}get isSpatial(){return this.mode!="screen"}get ray(){return this._ray||(this._ray=new h.Ray(this.space.worldPosition.clone(),this.space.worldForward.clone())),this._ray}set ray(e){this._ray=e}get hasRay(){return this._ray!==void 0}get used(){return this._used}use(){this._used=!0}get pointerId(){return this._pointerid}get pointerType(){return this._pointerType}get type(){return this._type}get immediatePropagationStopped(){return this._immediatePropagationStopped}get propagationStopped(){return this._immediatePropagationStopped||this._propagationStopped}stopImmediatePropagation(){var e;this._immediatePropagationStopped=!0,super.stopImmediatePropagation(),(e=this.source)==null||e.stopImmediatePropagation()}stopPropagation(){var e;this._propagationStopped=!0,super.stopPropagation(),(e=this.source)==null||e.stopPropagation(),Ze&&console.warn("Stop propagation...",this.pointerId,this.pointerType)}}class Il extends KeyboardEvent{constructor(e,i,n){super(e,n);r(this,"source");this.source=i}stopImmediatePropagation(){var e;super.stopImmediatePropagation(),(e=this.source)==null||e.stopImmediatePropagation()}}class US{constructor(t){r(this,"key");r(this,"keyType");r(this,"source");this.key=t.key,this.keyType=t.type,this.source=t}}var ei=(s=>(s[s.Early=-100]="Early",s[s.Default=0]="Default",s[s.Late=100]="Late",s))(ei||{});class h0{constructor(t){r(this,"_eventListeners",{});r(this,"_doubleClickTimeThreshold",.2);r(this,"_longPressTimeThreshold",1);r(this,"_setCursorTypes",[]);r(this,"context");r(this,"_pointerDown",[!1]);r(this,"_pointerUp",[!1]);r(this,"_pointerClick",[!1]);r(this,"_pointerDoubleClick",[!1]);r(this,"_pointerPressed",[!1]);r(this,"_pointerPositions",[new h.Vector2]);r(this,"_pointerPositionsLastFrame",[new h.Vector2]);r(this,"_pointerPositionsDelta",[new h.Vector2]);r(this,"_pointerPositionsRC",[new h.Vector2]);r(this,"_pointerPositionDown",[new h.Vector3]);r(this,"_pointerDownTime",[]);r(this,"_pointerUpTime",[]);r(this,"_pointerUpTimestamp",[]);r(this,"_pointerIds",[]);r(this,"_pointerTypes",[""]);r(this,"_mouseWheelChanged",[!1]);r(this,"_mouseWheelDeltaY",[0]);r(this,"_pointerEvent",[]);r(this,"_pointerEventsPressed",[]);r(this,"_pointerSpace",[]);r(this,"_pressedStack",new Map);r(this,"_htmlEventSource");r(this,"onLostFocus",()=>{for(const t in this.keysPressed)this.keysPressed[t].pressed=!1});r(this,"_receivedPointerMoveEventsThisFrame",new Array);r(this,"onEndOfFrame",()=>{this._receivedPointerMoveEventsThisFrame.length=0;for(let t=0;t<this._pointerUp.length;t++)this._pointerUp[t]=!1;for(let t=0;t<this._pointerDown.length;t++)this._pointerDown[t]=!1;for(let t=0;t<this._pointerClick.length;t++)this._pointerClick[t]=!1;for(let t=0;t<this._pointerDoubleClick.length;t++)this._pointerDoubleClick[t]=!1;for(const t of this._pointerPositionsDelta)t.set(0,0);for(let t=0;t<this._mouseWheelChanged.length;t++)this._mouseWheelChanged[t]=!1;for(let t=0;t<this._mouseWheelDeltaY.length;t++)this._mouseWheelDeltaY[t]=0});r(this,"onContextMenu",t=>{this.canReceiveInput(t)!==!1&&t instanceof PointerEvent&&t.pointerType});r(this,"keysPressed",{});r(this,"onKeyDown",t=>{if(Ze&&console.log(`key down ${t.code}, ${this.context.application.hasFocus}`,t),!this.context.application.hasFocus)return;const e=this.keysPressed[t.code];if(e&&e.pressed)return;this.keysPressed[t.code]={pressed:!0,frame:this.context.time.frameCount+1,startFrame:this.context.time.frameCount+1,key:t.key,code:t.code};const i=new Il("keydown",t,t);this.onDispatchEvent(i)});r(this,"onKeyPressed",t=>{if(!this.context.application.hasFocus)return;const e=this.keysPressed[t.code];if(!e)return;e.pressed=!0,e.frame=this.context.time.frameCount+1;const i=new Il("keypress",t,t);this.onDispatchEvent(i)});r(this,"onKeyUp",t=>{if(!this.context.application.hasFocus)return;const e=this.keysPressed[t.code];if(!e)return;e.pressed=!1,e.frame=this.context.time.frameCount+1;const i=new Il("keyup",t,t);this.onDispatchEvent(i)});r(this,"onWheelWindow",t=>{document.pointerLockElement&&this.onMouseWheel(t)});r(this,"onMouseWheel",t=>{if(this.canReceiveInput(t)===!1)return;this._mouseWheelDeltaY.length<=0&&this._mouseWheelDeltaY.push(0),this._mouseWheelChanged.length<=0&&this._mouseWheelChanged.push(!1),this._mouseWheelChanged[0]=!0;const e=this._mouseWheelDeltaY[0];this._mouseWheelDeltaY[0]=e+t.deltaY});r(this,"onPointerDown",t=>{if(this.context.isInAR||this.canReceiveInput(t)===!1)return;t.target instanceof HTMLElement&&t.target.setPointerCapture(t.pointerId);const e=this.getPointerId(t);Ze&&Te(`pointer down #${e}, identifier:${t.pointerId}`);const i=this.getAndUpdateSpatialObjectForScreenPosition(e,t.clientX,t.clientY),n=new ns("pointerdown",t,{origin:this,mode:"screen",deviceIndex:0,pointerId:e,button:t.button,clientX:t.clientX,clientY:t.clientY,pointerType:t.pointerType,buttonName:this.getButtonName(t),device:i,pressure:t.pressure});this.onDown(n)});r(this,"onPointerMove",t=>{if(this.context.isInAR||this._receivedPointerMoveEventsThisFrame.includes(t.pointerId))return;this._receivedPointerMoveEventsThisFrame.push(t.pointerId);let e=t.button;t.pointerType==="mouse"&&(e=this.getFirstPressedButtonForPointer(0)??0);const i=this.getPointerId(t,e);e===-1&&(e=i);const n=this.getAndUpdateSpatialObjectForScreenPosition(i,t.clientX,t.clientY),o=new ns("pointermove",t,{origin:this,mode:"screen",deviceIndex:0,pointerId:i,button:e,clientX:t.clientX,clientY:t.clientY,pointerType:t.pointerType,buttonName:this.getButtonName(t),device:n,pressure:t.pressure});this.onMove(o)});r(this,"onPointerCancel",t=>{this.context.isInAR||(Ze&&console.log("Pointer cancel",t),this.onPointerUp(t))});r(this,"onPointerUp",t=>{if(this.context.isInAR)return;t.target instanceof HTMLElement&&t.target.releasePointerCapture(t.pointerId);const e=this.getPointerId(t),i=new ns("pointerup",t,{origin:this,mode:"screen",deviceIndex:0,pointerId:e,button:t.button,clientX:t.clientX,clientY:t.clientY,pointerType:t.pointerType,buttonName:this.getButtonName(t),device:this.getAndUpdateSpatialObjectForScreenPosition(e,t.clientX,t.clientY),pressure:t.pressure});this.onUp(i),this._pointerIds[e]=-1,Ze&&console.log("ID="+e,"PointerId="+t.pointerId,"ALL:",[...this._pointerIds])});r(this,"onTouchStart",t=>{if(this.context.isInAR)for(let e=0;e<t.changedTouches.length;e++){const i=t.changedTouches[e],n=this.getPointerIndex(i.identifier),o=this.getAndUpdateSpatialObjectForScreenPosition(n,i.clientX,i.clientY),a=new ns("pointerdown",t,{origin:this,mode:"screen",deviceIndex:0,pointerId:n,button:0,clientX:i.clientX,clientY:i.clientY,pointerType:"touch",buttonName:"unknown",device:o,pressure:i.force});this.onDown(a)}});r(this,"onTouchMove",t=>{if(this.context.isInAR)for(let e=0;e<t.changedTouches.length;e++){const i=t.changedTouches[e],n=this.getPointerIndex(i.identifier),o=this.getAndUpdateSpatialObjectForScreenPosition(n,i.clientX,i.clientY),a=new ns("pointermove",t,{origin:this,mode:"screen",deviceIndex:0,pointerId:n,button:0,clientX:i.clientX,clientY:i.clientY,pointerType:"touch",buttonName:"unknown",device:o,pressure:i.force});this.onMove(a)}});r(this,"onTouchEnd",t=>{if(this.context.isInAR)for(let e=0;e<t.changedTouches.length;e++){const i=t.changedTouches[e],n=this.getPointerIndex(i.identifier),o=new ns("pointerup",t,{origin:this,mode:"screen",deviceIndex:0,pointerId:n,button:0,clientX:i.clientX,clientY:i.clientY,pointerType:"touch",buttonName:"unknown",device:this.getAndUpdateSpatialObjectForScreenPosition(n,i.clientX,i.clientY),pressure:i.force});this.onUp(o),this._pointerIds[n]=-1}});r(this,"tempNearPlaneVector",new h.Vector3);r(this,"tempFarPlaneVector",new h.Vector3);r(this,"tempLookMatrix",new h.Matrix4);this.context=t,this.context.post_render_callbacks.push(this.onEndOfFrame)}addEventListener(t,e,i){if(this._eventListeners[t]||(this._eventListeners[t]=[]),!e||typeof e!="function"){console.error("Invalid call to addEventListener: callback is required and must be a function!");return}i?i={...i}:i={};let n=0;(i==null?void 0:i.queue)!=null&&(n=i.queue);const o=this._eventListeners[t],a=o.find(l=>l.priority===n);a?a.listeners.push({callback:e,options:i}):(o.push({priority:n,listeners:[{callback:e,options:i}]}),o.sort((l,c)=>l.priority-c.priority))}removeEventListener(t,e,i){if(!this._eventListeners[t]||!e)return;const n=this._eventListeners[t];if((i==null?void 0:i.queue)!=null){const o=n.find(l=>l.priority===i.queue);if(!o)return;const a=o.listeners.findIndex(l=>l.callback===e);a>=0&&o.listeners.splice(a,1)}else for(const o of n){const a=o.listeners.findIndex(l=>l.callback===e);a>=0&&o.listeners.splice(a,1)}}dispatchEvent(t){var i,n,o,a;let e=!1;if(t instanceof Il){const l=this._eventListeners[t.type];if(l)for(const c of l)for(let d=0;d<c.listeners.length;d++){const u=c.listeners[d];if((n=(i=u.options)==null?void 0:i.signal)!=null&&n.aborted){c.listeners.splice(d,1),d--;continue}u.options.once&&(c.listeners.splice(d,1),d--),u.callback(t)}}if(t instanceof ns){const l=this._eventListeners[t.type];if(l)for(const c of l){if(e)break;for(let d=0;d<c.listeners.length;d++){const u=c.listeners[d];if((a=(o=u.options)==null?void 0:o.signal)!=null&&a.aborted){c.listeners.splice(d,1),d--;continue}if(t.immediatePropagationStopped){e=!0,Ze&&console.log("immediatePropagationStopped",t.type);break}else t.propagationStopped&&(e=!0,Ze&&console.log("propagationStopped",t.type));u.options.once&&(c.listeners.splice(d,1),d--),u.callback(t)}}}}get mousePosition(){return this._pointerPositions[0]}get mousePositionRC(){return this._pointerPositionsRC[0]}get mouseDown(){return this._pointerDown[0]}get mouseUp(){return this._pointerUp[0]}get mouseClick(){return this._pointerClick[0]}get mouseDoubleClick(){return this._pointerDoubleClick[0]}get mousePressed(){return this._pointerPressed[0]}get mouseWheelChanged(){return this.getMouseWheelChanged(0)}get click(){return this._pointerClick[0]}get doubleClick(){return this._pointerDoubleClick[0]}getGamepad(t=0){return typeof navigator<"u"&&"getGamepads"in navigator&&navigator.getGamepads()[t]||null}setCursorPointer(){this.setCursor("pointer")}setCursorNormal(){this.unsetCursor("pointer")}setCursor(t){this._setCursorTypes.push(t),this._setCursorTypes.length>10&&this._setCursorTypes.shift(),this.updateCursor()}unsetCursor(t){for(let e=this._setCursorTypes.length-1;e>=0;e--)if(this._setCursorTypes[e]===t){this._setCursorTypes.splice(e,1),this.updateCursor();break}}updateCursor(){var t;((t=this._setCursorTypes)==null?void 0:t.length)==0?this.context.domElement.style.cursor="default":this.context.domElement.style.cursor=this._setCursorTypes[this._setCursorTypes.length-1]}getIsPointerIdInUse(t){for(const e of this._pointerEventsPressed)if(e.pointerId===t&&e.used)return!0;return!1}getPointerPressedCount(){let t=0;for(let e=0;e<this._pointerPressed.length;e++)this._pointerPressed[e]&&t++;return t}getPointerPosition(t){return t>=this._pointerPositions.length?null:this._pointerPositions[t]}getPointerPositionLastFrame(t){return t>=this._pointerPositionsLastFrame.length?null:this._pointerPositionsLastFrame[t]}getPointerPositionDelta(t){return t>=this._pointerPositionsDelta.length?null:this._pointerPositionsDelta[t]}getPointerPositionRC(t){return t>=this._pointerPositionsRC.length?null:this._pointerPositionsRC[t]}getPointerDown(t){return t>=this._pointerDown.length?!1:this._pointerDown[t]}getPointerUp(t){return t>=this._pointerUp.length?!1:this._pointerUp[t]}getPointerPressed(t){return t>=this._pointerPressed.length?!1:this._pointerPressed[t]}getPointerClicked(t){return t>=this._pointerClick.length?!1:this._pointerClick[t]}getPointerDoubleClicked(t){return t>=this._pointerDoubleClick.length?!1:this._pointerDoubleClick[t]}getPointerDownTime(t){return t>=this._pointerDownTime.length?-1:this._pointerDownTime[t]}getPointerUpTime(t){return t>=this._pointerUpTime.length?-1:this._pointerUpTime[t]}getPointerLongPress(t){return t>=this._pointerDownTime.length?!1:this.getPointerPressed(t)&&this.context.time.time-this._pointerDownTime[t]>this._longPressTimeThreshold}getIsMouse(t){return t<0||t>=this._pointerTypes.length?!1:this._pointerTypes[t]==="mouse"}getIsTouch(t){return t<0||t>=this._pointerTypes.length?!1:this._pointerTypes[t]==="touch"}getTouchesPressedCount(){let t=0;for(let e=0;e<this._pointerPressed.length;e++)this._pointerPressed[e]&&this.getIsTouch(e)&&t++;return t}getMouseWheelChanged(t=0){return t>=this._mouseWheelChanged.length?!1:this._mouseWheelChanged[t]}getMouseWheelDeltaY(t=0){return t>=this._mouseWheelDeltaY.length?0:this._mouseWheelDeltaY[t]}getPointerEvent(t){if(!(t>=this._pointerEvent.length))return this._pointerEvent[t]??void 0}*foreachPointerId(t){for(let e=0;e<this._pointerTypes.length;e++)if(this._pointerIsActive(e)){if(t!==void 0){const i=this._pointerTypes[e];if(Array.isArray(t)){let n=!1;for(const o of t)if(i===o){n=!0;break}if(!n)continue}else if(t!==i)continue}yield e}}*foreachTouchId(){for(let t=0;t<this._pointerTypes.length;t++)this._pointerTypes[t]==="touch"&&this._pointerIsActive[t]&&(yield t)}_pointerIsActive(t){return t<0?!1:this._pointerPressed[t]||this._pointerDown[t]||this._pointerUp[t]}onDownButton(t,e){let i=this._pressedStack.get(t);i||(i=[],this._pressedStack.set(t,i)),i.push(e)}onReleaseButton(t,e){const i=this._pressedStack.get(t);if(!i)return;const n=i.indexOf(e);n>=0&&i.splice(n,1)}getFirstPressedButtonForPointer(t){const e=this._pressedStack.get(t);if(e)return e[0]}getLatestPressedButtonForPointer(t){const e=this._pressedStack.get(t);if(e)return e[e.length-1]}getKeyDown(){for(const t in this.keysPressed){const e=this.keysPressed[t];if(e.startFrame===this.context.time.frameCount)return e.key}return null}getKeyPressed(){for(const t in this.keysPressed){const e=this.keysPressed[t];if(e.pressed)return e.key}return null}isKeyDown(t){var i;if(!this.context.application.isVisible||!this.context.application.hasFocus)return!1;const e=this.getCodeForCommonKeyName(t);if(e!==null){for(const n of e)if(this.isKeyDown(n))return!0;return!1}return((i=this.keysPressed[t])==null?void 0:i.startFrame)===this.context.time.frameCount&&this.keysPressed[t].pressed}isKeyUp(t){var i;if(!this.context.application.isVisible||!this.context.application.hasFocus)return!1;const e=this.getCodeForCommonKeyName(t);if(e!==null){for(const n of e)if(this.isKeyUp(n))return!0;return!1}return((i=this.keysPressed[t])==null?void 0:i.frame)===this.context.time.frameCount&&!this.keysPressed[t].pressed}isKeyPressed(t){var i;if(!this.context.application.isVisible||!this.context.application.hasFocus)return!1;const e=this.getCodeForCommonKeyName(t);if(e!==null){for(const n of e)if(this.isKeyPressed(n))return!0;return!1}return(i=this.keysPressed[t])==null?void 0:i.pressed}getCodeForCommonKeyName(t){if(t.length===1){if(t>="0"&&t<="9")return["Digit"+t];if(t>="a"&&t<="z")return["Key"+t.toUpperCase()];if(t==" ")return["Space"]}switch(t){case"shift":case"Shift":return["ShiftLeft","ShiftRight"];case"control":case"Control":return["ControlLeft","ControlRight"];case"alt":case"Alt":return["AltLeft","AltRight"]}return null}createInputEvent(t){switch(t.type){case"pointerdown":Ze&&Te("Create Pointer down"),this.onDownButton(t.deviceIndex,t.button),this.onDown(t);break;case"pointermove":Ze&&Te("Create Pointer move"),this.onMove(t);break;case"pointerup":Ze&&Te("Create Pointer up"),this.onUp(t),this.onReleaseButton(t.deviceIndex,t.button);break}}convertScreenspaceToRaycastSpace(t){return t.x=(t.x-this.context.domX)/this.context.domWidth*2-1,t.y=-((t.y-this.context.domY)/this.context.domHeight)*2+1,t}bindEvents(){this.unbindEvents(),this._htmlEventSource=this.context.renderer.domElement,window.addEventListener("contextmenu",this.onContextMenu),this._htmlEventSource.addEventListener("pointerdown",this.onPointerDown,{passive:!0}),window.addEventListener("pointermove",this.onPointerMove,{passive:!0,capture:!0}),window.addEventListener("pointerup",this.onPointerUp,{passive:!0}),window.addEventListener("pointercancel",this.onPointerCancel,{passive:!0}),window.addEventListener("touchstart",this.onTouchStart,{passive:!0}),window.addEventListener("touchmove",this.onTouchMove,{passive:!0}),window.addEventListener("touchend",this.onTouchEnd,{passive:!0}),this._htmlEventSource.addEventListener("wheel",this.onMouseWheel,{passive:!0}),window.addEventListener("wheel",this.onWheelWindow,{passive:!0}),window.addEventListener("keydown",this.onKeyDown,!1),window.addEventListener("keypress",this.onKeyPressed,!1),window.addEventListener("keyup",this.onKeyUp,!1),window.addEventListener("blur",this.onLostFocus)}unbindEvents(){var t,e;window.removeEventListener("contextmenu",this.onContextMenu),(t=this._htmlEventSource)==null||t.removeEventListener("pointerdown",this.onPointerDown),window.removeEventListener("pointermove",this.onPointerMove),window.removeEventListener("pointerup",this.onPointerUp),window.removeEventListener("pointercancel",this.onPointerCancel),window.removeEventListener("touchstart",this.onTouchStart),window.removeEventListener("touchmove",this.onTouchMove),window.removeEventListener("touchend",this.onTouchEnd),(e=this._htmlEventSource)==null||e.removeEventListener("wheel",this.onMouseWheel,!1),window.removeEventListener("wheel",this.onWheelWindow,!1),window.removeEventListener("keydown",this.onKeyDown,!1),window.removeEventListener("keypress",this.onKeyPressed,!1),window.removeEventListener("keyup",this.onKeyUp,!1),window.removeEventListener("blur",this.onLostFocus)}dispose(){const t=this.context.post_render_callbacks.indexOf(this.onEndOfFrame);t>=0&&this.context.post_render_callbacks.splice(t,1),this.unbindEvents()}canReceiveInput(t){var e;return t.target===((e=this.context.renderer)==null?void 0:e.domElement)||t.target===this.context.domElement||this.context.isInAR||this.context.isInAR&&t.target===document.body&&exports.DeviceUtilities.isMozillaXR()?!0:(Ze&&console.warn("CanReceiveInput:False for",t.target),!1)}getPointerId(t,e){return t.pointerType==="mouse"?0+(e??t.button):this.getPointerIndex(t.pointerId)}getButtonName(t){const e=t.button;if(t.pointerType==="mouse")switch(e){case 0:return"left";case 1:return"middle";case 2:return"right"}return"unknown"}getAndUpdateSpatialObjectForScreenPosition(t,e,i){let n=this._pointerSpace[t];n||(n=new h.Object3D,this._pointerSpace[t]=n),this._pointerSpace[t]=n;const o=this.context.mainCamera;if(o){const a=this.tempNearPlaneVector.set(e,i,-1);this.convertScreenspaceToRaycastSpace(a);const l=this.tempFarPlaneVector.set(a.x,a.y,1);a.unproject(o),l.unproject(o);const c=o.worldUp||$(0,1,0).applyQuaternion(_e(o));this.tempLookMatrix.lookAt(l,a,c),n.position.set(a.x,a.y,a.z),n.quaternion.setFromRotationMatrix(this.tempLookMatrix)}return n}isInRect(t){if(this.context.isInXR)return!0;const e=this.context.domElement.getBoundingClientRect(),i=t.clientX,n=t.clientY,o=i>=e.x&&i<=e.right&&n>=e.y&&n<=e.bottom;return Ze&&!o&&console.log("Not in rect",e,i,n),o}onDown(t){const e=t.pointerId;if(this.getPointerPressed(e)&&console.warn(`Received pointerDown for pointerId that is already pressed: ${e}`,Ze?t:""),Ze&&console.log(t.pointerType,"DOWN",e),!!this.isInRect(t)){for(this.setPointerState(e,this._pointerPressed,!0),this.setPointerState(e,this._pointerDown,!0),this.setPointerStateT(e,this._pointerEvent,t.source);e>=this._pointerTypes.length;)this._pointerTypes.push(t.pointerType);for(this._pointerTypes[e]=t.pointerType;e>=this._pointerPositionDown.length;)this._pointerPositionDown.push(new h.Vector3);for(this._pointerPositionDown[e].set(t.clientX,t.clientY,t.clientZ??0);e>=this._pointerPositions.length;)this._pointerPositions.push(new h.Vector2);this._pointerPositions[e].set(t.clientX,t.clientY),e>=this._pointerDownTime.length&&this._pointerDownTime.push(0),this._pointerDownTime[e]=this.context.time.realtimeSinceStartup,this.updatePointerPosition(t),this._pointerEventsPressed.push(t),this.onDispatchEvent(t)}}onMove(t){const e=t.pointerId,i=this.getPointerPressed(e);i===!1&&!this.isInRect(t)||t.pointerType==="touch"&&!i||(this.updatePointerPosition(t),this.setPointerStateT(e,this._pointerEvent,t.source),this.onDispatchEvent(t))}onUp(t){const e=t.pointerId;if(!this.getPointerPressed(e)){Ze&&console.log(t.pointerType,"UP",e,"was not down");return}Ze&&console.log(t.pointerType,"UP",e),this.setPointerState(e,this._pointerPressed,!1),this.setPointerStateT(e,this._pointerEvent,t.source),this.setPointerState(e,this._pointerUp,!0),this.updatePointerPosition(t);for(let c=this._pointerEventsPressed.length-1;c>=0;c--)if(this._pointerEventsPressed[c].pointerId===e){this._pointerEventsPressed.splice(c,1);break}if(!this._pointerPositionDown[e]){Ze&&pe("Received pointer up event without matching down event for button: "+e),console.warn("Received pointer up event without matching down event for button: "+e);return}const n=this._pointerUpTime[e],o=this._pointerDownTime[e],a=this.context.time.realtimeSinceStartup,l=a-o;if(e>=this._pointerUpTime.length&&this._pointerUpTime.push(-99),this._pointerUpTime[e]=a,l<1){let c=t.clientX-this._pointerPositionDown[e].x,d=t.clientY-this._pointerPositionDown[e].y,u=0;if(t.isSpatial&&t.clientZ!=null&&(u=t.clientZ-this._pointerPositionDown[e].z,c*=200,d*=200,u*=200),Math.abs(c)<5&&Math.abs(d)<5&&Math.abs(u)<5){this.setPointerState(e,this._pointerClick,!0),t.isClick=!0;const f=a-n;Ze&&console.log("CLICK",e,c,d,u,f),f<this._doubleClickTimeThreshold&&f>0&&(this.setPointerState(e,this._pointerDoubleClick,!0),t.isDoubleClick=!0)}}this.onDispatchEvent(t)}updatePointerPosition(t){const e=t.pointerId;for(;e>=this._pointerPositions.length;)this._pointerPositions.push(new h.Vector2);for(;e>=this._pointerPositionsLastFrame.length;)this._pointerPositionsLastFrame.push(new h.Vector2);for(;e>=this._pointerPositionsDelta.length;)this._pointerPositionsDelta.push(new h.Vector2);const i=this._pointerPositionsLastFrame[e];i.copy(this._pointerPositions[e]);const n=this._pointerPositionsDelta[e];let o=t.clientX-i.x,a=t.clientY-i.y;if(t.source instanceof MouseEvent||t.source instanceof TouchEvent){const u=t.source;o===0&&u.movementX!==0&&(o=u.movementX||0),a===0&&u.movementY!==0&&(a=u.movementY||0)}n.x+=o,n.y+=a,this._pointerPositions[e].x=t.clientX,this._pointerPositions[e].y=t.clientY;const l=t.clientX,c=t.clientY;for(;e>=this._pointerPositionsRC.length;)this._pointerPositionsRC.push(new h.Vector2);const d=this._pointerPositionsRC[e];d.set(l,c),this.convertScreenspaceToRaycastSpace(d)}getPointerIndex(t){let e=-1;for(let i=0;i<this._pointerIds.length;i++){if(this._pointerIds[i]===t)return i;e===-1&&this._pointerIds[i]===-1&&(e=i)}return e!==-1?(this._pointerIds[e]=t,e):(Ze&&console.log("PUSH pointerId:",t),this._pointerIds.push(t),this._pointerIds.length-1)}setPointerState(t,e,i){e[t]=i}setPointerStateT(t,e,i){return e[t]=i,i}onDispatchEvent(t){const e=Q.Current;try{Q.Current=this.context,this.dispatchEvent(t)}finally{Q.Current=e}}}const ya=new h.Matrix4().makeRotationY(Math.PI),Ii=new h.Quaternion().setFromAxisAngle(new h.Vector3(0,1,0),Math.PI),zS=x("debugwebxr");class NS{constructor(){r(this,"priority",-1e5);r(this,"gameObject");if(this.gameObject=new h.Object3D,this.gameObject.name="Implicit XR Rig",zS){const t=Xm(16733661);t.position.y+=.5,this.gameObject.add(t)}}isXRRig(){return!0}get isActive(){return this.gameObject.visible}}const qn=x("debugwebxr"),Th=x("debugcustomgesture"),VS="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles",$S="generic-trigger",WS=new h.Quaternion().setFromEuler(new h.Euler(h.MathUtils.degToRad(0),h.MathUtils.degToRad(-90),h.MathUtils.degToRad(-90))),GS=new h.Vector3(.04,-.04,0);class Vm{constructor(t,e,i){r(this,"xr");r(this,"inputSource");r(this,"index",0);r(this,"emitEvents",!0);r(this,"_connected",!0);r(this,"_isTracking",!1);r(this,"__gamepad");r(this,"__hand");r(this,"__side");r(this,"_hitTestSource");r(this,"_hasSelectEvent",!1);r(this,"_isMxInk",!1);r(this,"_isMetaQuestTouchController",!1);r(this,"_handJointPoses",new Map);r(this,"_gripMatrix",new h.Matrix4);r(this,"_gripPosition",new h.Vector3);r(this,"_gripQuaternion",new h.Quaternion);r(this,"_linearVelocity",new h.Vector3);r(this,"_rayPositionRaw",new h.Vector3);r(this,"_rayRotationRaw",new h.Quaternion);r(this,"_rayMatrix",new h.Matrix4);r(this,"_rayPosition",new h.Vector3);r(this,"_rayQuaternion",new h.Quaternion);r(this,"_gripWorldPosition",new h.Vector3);r(this,"_gripWorldQuaternion",new h.Quaternion);r(this,"_rayWorldPosition",new h.Vector3);r(this,"_rayWorldQuaternion",new h.Quaternion);r(this,"_pinchPosition",new h.Vector3);r(this,"_ray");r(this,"_hand_wristDotUp");r(this,"_object");r(this,"_gripSpaceObject");r(this,"_raySpaceObject");r(this,"model",null);r(this,"_debugAxesHelper",new h.AxesHelper(.15));r(this,"_debugGripAxesHelper",new h.AxesHelper(.07));r(this,"_debugRayAxesHelper",new h.AxesHelper(.07));r(this,"_hitTestSourcePromise",null);r(this,"onPointerHits",t=>{});r(this,"_needleGamepadButtons",{});r(this,"_buttonMap",new Map);r(this,"_motioncontroller");r(this,"_layout");r(this,"getMotionController");r(this,"emitPointerDownEvent",!0);r(this,"emitPointerUpEvent",!0);r(this,"emitPointerMoveEvent",!0);r(this,"pointerMoveDistanceThreshold",.03);r(this,"pointerMoveAngleThreshold",.05);r(this,"_selectButtonIndex");r(this,"_squeezeButtonIndex");r(this,"onSelectStart",t=>{var n,o,a,l;if(!this.emitPointerDownEvent||this.inputSource!==t.inputSource)return;this.onUpdateFrame(t.frame),this._hasSelectEvent=!0;const e=(n=this._layout)==null?void 0:n.selectComponentId,i=(l=(a=(o=this._layout)==null?void 0:o.components[e])==null?void 0:a.gamepadIndices)==null?void 0:l.button;i!==void 0&&(this._selectButtonIndex=i),!Th&&(qn&&N.DrawDirection(this.rayWorldPosition,$(0,.01,1).applyQuaternion(this.rayWorldQuaternion),16711680,10),this.emitPointerEvent(ke.PointerDown,this._selectButtonIndex||0,"xr-standard-trigger",!0,t))});r(this,"onSelectEnd",t=>{this.emitPointerUpEvent&&(Th||this.inputSource===t.inputSource&&this.emitPointerEvent(ke.PointerUp,this._selectButtonIndex||0,"xr-standard-trigger",!0,t))});r(this,"onSequeezeStart",t=>{var e,i,n;this.emitPointerDownEvent&&this.inputSource===t.inputSource&&(this._squeezeButtonIndex=(n=(i=(e=this._layout)==null?void 0:e.components["xr-standard-squeeze"])==null?void 0:i.gamepadIndices)==null?void 0:n.button,this._squeezeButtonIndex!==void 0&&(qn&&N.DrawDirection(this.rayWorldPosition,$(0,.01,1).applyQuaternion(this.rayWorldQuaternion),255,10),this.emitPointerEvent(ke.PointerDown,this._squeezeButtonIndex||0,"xr-standard-squeeze",!0,t)))});r(this,"onSequeezeEnd",t=>{this.emitPointerUpEvent&&this.inputSource===t.inputSource&&this._squeezeButtonIndex!==void 0&&this.emitPointerEvent(ke.PointerUp,this._squeezeButtonIndex||0,"xr-standard-squeeze",!0,t)});r(this,"states",{});r(this,"_didMoveLastFrame",!1);r(this,"_lastPointerMovePosition",new h.Vector3);r(this,"_lastPointerMoveQuaternion",new h.Quaternion);r(this,"pointerInit");this.xr=t,this.inputSource=e,this.index=i,this._object=new h.Object3D,this._object.name=`NeedleXRController_${i}`,qn&&(this._object.add(this._debugAxesHelper),this._gripSpaceObject=new h.Object3D,this._raySpaceObject=new h.Object3D,this._gripSpaceObject.name=`NeedleXRController_${i}_gripSpace`,this._raySpaceObject.name=`NeedleXRController_${i}_raySpace`,this._gripSpaceObject.add(this._debugGripAxesHelper),this._raySpaceObject.add(this._debugRayAxesHelper),this.xr.context.scene.add(this._gripSpaceObject),this.xr.context.scene.add(this._raySpaceObject)),this.xr.context.scene.add(this._object),this._ray=new h.Ray,this.pointerInit={origin:this,pointerType:this.hand?"hand":"controller",deviceIndex:this.index,pointerId:-1,mode:this.inputSource.targetRayMode,ray:this._ray,device:this._object,buttonName:"none"},this.initialize(),this.subscribeEvents()}get context(){return this.xr.context}get connected(){return this._connected}get isTracking(){return this._isTracking}get gamepad(){return this.__gamepad??(this.__gamepad=this.inputSource.gamepad)}get isHand(){return this.hand!=null}get hand(){return this.__hand??(this.__hand=this.inputSource.hand)}get handObject(){return this.context.renderer.xr.getHand(this.index)}get profiles(){return this.inputSource.profiles}get layout(){return this._layout}get targetRayMode(){return this.inputSource.targetRayMode}get targetRaySpace(){return this.inputSource.targetRaySpace}get gripSpace(){return this.inputSource.gripSpace}get side(){return this.__side??(this.__side=this.inputSource.handedness)}get isRight(){return this.side==="right"}get isLeft(){return this.side==="left"}get isStylus(){return this._isMxInk}getHitTestSource(){return this._hitTestSource||this._requestHitTestSource(),this._hitTestSource}get hasHitTestSource(){return this._hitTestSource}cancelHitTestSource(){this._hitTestSource&&(this._hitTestSource.cancel(),this._hitTestSource=void 0)}get hasSelectEvent(){return this._hasSelectEvent}getHitTest(){return this.xr.getHitTest(this)}getHandJointPose(t,e){var n;if(e=e||this.xr.frame,!this.hand||!(e!=null&&e.getJointPose)||!this.xr.referenceSpace)return null;let i=(n=this._handJointPoses)==null?void 0:n.get(t);return i||(i=e.getJointPose(t,this.xr.referenceSpace),i&&this._handJointPoses.set(t,i),i)}get gripPosition(){return $(this._gripPosition)}get gripQuaternion(){return on(this._gripQuaternion)}get gripMatrix(){return this._gripMatrix}get gripLinearVelocity(){return $(this._linearVelocity).applyQuaternion(Ii)}get rayPosition(){return $(this._rayPosition)}get rayQuaternion(){return on(this._rayQuaternion)}get gripWorldPosition(){return $(this._gripWorldPosition)}get gripWorldQuaternion(){return on(this._gripWorldQuaternion)}get rayWorldPosition(){return $(this._rayWorldPosition)}updateRayWorldPosition(){var e;const t=(e=this.xr.context.mainCamera)==null?void 0:e.parent;this._rayWorldPosition.copy(this._rayPositionRaw),t&&this._rayWorldPosition.applyMatrix4(t.matrixWorld)}get rayWorldQuaternion(){return on(this._rayWorldQuaternion)}get pinchPosition(){return $(this._pinchPosition)}updateRayWorldQuaternion(){var i;const t=(i=this.xr.context.mainCamera)==null?void 0:i.parent,e=t?_e(t):void 0;this._rayWorldQuaternion.copy(this._rayRotationRaw).multiply(Ii),e&&this._rayWorldQuaternion.premultiply(e)}get ray(){return this._ray.origin.copy(this.rayWorldPosition),this._ray.direction.copy($(0,0,1).applyQuaternion(this.rayWorldQuaternion)),this._ray}get handWristDotUp(){var e;if(this._hand_wristDotUp!==void 0)return this._hand_wristDotUp;const t=(e=this.handObject)==null?void 0:e.joints.wrist;if(t){const i=$(0,1,0).applyQuaternion(t.quaternion),n=$(0,1,0).dot(i);return this._hand_wristDotUp=n}}get isHandUpsideDown(){return this.handWristDotUp!==void 0?this.handWristDotUp<-.7:!1}get isTeleportGesture(){var t;return this.isHandUpsideDown&&((t=this.getGesture("pinch"))==null?void 0:t.isDown)}get object(){return this._object}async getModelUrl(){var t;return(t=this.getMotionController)==null?void 0:t.then(e=>(e==null?void 0:e.assetUrl)||null)}_requestHitTestSource(){var t;return this._hitTestSourcePromise?this._hitTestSourcePromise:this.xr.mode==="immersive-ar"&&this.inputSource.targetRayMode==="tracked-pointer"&&this.xr.session.requestHitTestSourceForTransientInput?this._hitTestSourcePromise=((t=this.xr.session.requestHitTestSourceForTransientInput({profile:this.inputSource.profiles[0],offsetRay:new XRRay}))==null?void 0:t.then(e=>(this._hitTestSourcePromise=null,this.connected?this._hitTestSource=e:(e.cancel(),null))))??null:null}onUpdate(t){performance.mark("NeedleXRController onUpdate start"),this.onUpdateFrame(t),this.updateInputEvents(),this.onUpdateMove(),performance.mark("NeedleXRController onUpdate end"),performance.measure("NeedleXRController onUpdate","NeedleXRController onUpdate start","NeedleXRController onUpdate end")}onRenderDebug(){var o;N.DrawSphere(this.rayWorldPosition,.003),N.DrawDirection(this.rayWorldPosition,$(0,0,10).applyQuaternion(this.rayWorldQuaternion));const e=(this.inputSource.gripSpace?this.gripWorldPosition:this.object.worldPosition).sub(this.object.worldForward.multiplyScalar(.1)),i=this.inputSource.profiles.join(`
`);let n=`Controller[${this.index}] (${this.inputSource.targetRayMode}, ${this.side})
C:${this.connected?"x":"-"} T:${this.isTracking?"x":"-"} Hand:${this.inputSource.hand?"x":"-"} Pen: ${this._isMxInk?"x":"-"}`;if(this.inputSource.hand&&(n+=`
Pinch: ${(o=this.getGesture("pinch"))==null?void 0:o.value.toFixed(3)}`),n+=`
`+i,n+=`
`+(this.inputSource.targetRaySpace?"Ray: x":"Ray: -")+(this.inputSource.gripSpace?" Grip: x":" Grip: -")+(this.inputSource.gamepad?` Gamepad: ${this.inputSource.gamepad.mapping}`:" Gamepad: -"),this.inputSource.gamepad){const a=this.inputSource.gamepad;let l="[btns "+a.buttons.length+"]: "+a.buttons.map(c=>c.value.toPrecision(1)).join(",");l+=`
[axes `+a.axes.length+"]: "+a.axes.map(c=>c.toPrecision(1)).join(","),n+=`
`+l}N.DrawLabel(e,n,.006)}onUpdateFrame(t){var u,f,m,g,_,y,b,v,w,P,k;if(this._handJointPoses.clear(),this._hand_wristDotUp=void 0,!this.xr.referenceSpace){this._isTracking=!1;return}const e=t.getPose(this.inputSource.targetRaySpace,this.xr.referenceSpace);this._isTracking=e!=null;let i=null,n=null,o=null,a=null;if(e){const O=e.transform;this._rayMatrix.fromArray(O.matrix).premultiply(ya),this._rayMatrix.decompose(this._rayPosition,this._rayQuaternion,$(1,1,1)),o=$(O.position),a=on(O.orientation),this._rayPositionRaw.copy(o),this._rayRotationRaw.copy(a)}if(this.inputSource.gripSpace){const O=t.getPose(this.inputSource.gripSpace,this.xr.referenceSpace);if(O){const M=O.transform;if(i=$(M.position),n=on(M.orientation),this._gripMatrix.fromArray(M.matrix).premultiply(ya),this._gripMatrix.decompose(this._gripPosition,this._gripQuaternion,$(1,1,1)),"linearVelocity"in O&&O.linearVelocity){const A=O.linearVelocity;this._linearVelocity.set(A.x,A.y,A.z)}}}(u=this.xr.context.mainCamera)!=null&&u.parent&&(this._object.parent!==((f=this.xr.context.mainCamera)==null?void 0:f.parent)&&this.xr.context.mainCamera.parent.add(this._object),this._gripSpaceObject!==void 0&&((m=this._gripSpaceObject)==null?void 0:m.parent)!==((g=this.xr.context.mainCamera)==null?void 0:g.parent)&&this.xr.context.mainCamera.parent.add(this._gripSpaceObject),this._raySpaceObject!==void 0&&((_=this._raySpaceObject)==null?void 0:_.parent)!==((y=this.xr.context.mainCamera)==null?void 0:y.parent)&&this.xr.context.mainCamera.parent.add(this._raySpaceObject));const l=this.hand;if(l){let O=!1;const M=l.get("wrist"),A=M&&this.getHandJointPose(M,t);if(A){O=!0;const j=A.transform.position,F=A.transform.orientation;this._object.position.set(j.x,j.y,j.z),this._object.quaternion.set(F.x,F.y,F.z,F.w).multiply(Ii)}O||(this._object.position.copy(this._rayPosition),this._object.quaternion.copy(this._rayQuaternion).multiply(Ii));const I=l.get("middle-finger-metacarpal"),T=I&&this.getHandJointPose(I,t);T&&(this._gripMatrix.fromArray(T.transform.matrix).premultiply(ya),this._gripMatrix.decompose(this._gripPosition,this._gripQuaternion,$(1,1,1)),i=$().copy(T.transform.position),n=on().copy(T.transform.orientation),n.multiply(WS),i.add($(GS).applyQuaternion(n)))}else this.inputSource.gripSpace&&this.targetRayMode==="transient-pointer"&&i&&n?(this._object.position.copy(i),this._object.quaternion.copy(n).multiply(Ii)):o&&a&&(this._object.position.copy(o),this._object.quaternion.copy(a).multiply(Ii));qn&&(o&&a&&((b=this._raySpaceObject)==null||b.position.copy(o),(v=this._raySpaceObject)==null||v.quaternion.copy(a).multiply(Ii)),i&&n&&((w=this._gripSpaceObject)==null||w.position.copy(i),(P=this._gripSpaceObject)==null||P.quaternion.copy(n).multiply(Ii)));const c=(k=this.xr.context.mainCamera)==null?void 0:k.parent,d=c?_e(c):void 0;i&&n&&(this._gripWorldPosition.copy(i),c&&this._gripWorldPosition.applyMatrix4(c.matrixWorld),this._gripWorldQuaternion.copy(n),this._gripWorldQuaternion.multiply(Ii),d&&this._gripWorldQuaternion.premultiply(d)),this.updateRayWorldPosition(),this.updateRayWorldQuaternion()}onDisconnected(){var t,e,i,n,o,a;this._connected=!1,qn&&console.warn("Controller disconnected",this.index);for(const l of this._object.children)this.xr.context.scene.attach(l);(t=this._object)==null||t.removeFromParent(),(e=this._debugAxesHelper)==null||e.removeFromParent(),(i=this._debugGripAxesHelper)==null||i.removeFromParent(),(n=this._debugRayAxesHelper)==null||n.removeFromParent(),(o=this._gripSpaceObject)==null||o.removeFromParent(),(a=this._raySpaceObject)==null||a.removeFromParent(),this.unsubscribeEvents(),this._hitTestSource&&(this._hitTestSource.cancel(),this._hitTestSource=void 0)}getButton(t){var i;if(!this._layout)return;switch(t){case"primary-button":if(this.isLeft)t="x-button";else if(this.isRight)t="a-button";else return;break;case"primary":return this.hand?this.getGesture("pinch"):this.toNeedleGamepadButton(0,t)}if(this._buttonMap.has(t))return this.toNeedleGamepadButton(this._buttonMap.get(t),t);const e=(i=this._layout)==null?void 0:i.components[t];if(e!=null&&e.gamepadIndices)switch(e.type){case"button":case"squeeze":if(this.inputSource.gamepad){const n=e.gamepadIndices.button;return this._buttonMap.set(t,n),this.toNeedleGamepadButton(n,t)}break;default:console.warn("Unsupported component type",e.type);break}this._buttonMap.set(t,void 0)}getGesture(t){const e=this.states[t];if(!e)return null;this.states[t]=e;const i=this._needleGamepadButtons[t]||new V_(void 0,t);return i.pressed=e.pressed,i.value=e.value,i.isDown=e.isDown,i.isUp=e.isUp,this._needleGamepadButtons[t]=i,i}getPointerId(t){if((t==="primary"||t==="pinch")&&(t=0),typeof t!="number"){const e=this._buttonMap.get(t);if(e===void 0)return;t=e}return this.index*10+t}toNeedleGamepadButton(t,e){var a,l;if(!((a=this.inputSource.gamepad)!=null&&a.buttons))return;const i=(l=this.inputSource.gamepad)==null?void 0:l.buttons[t],n=this.states[t],o=this._needleGamepadButtons[t]||new V_(t,e);return i&&(o.pressed=i.pressed,o.value=i.value,o.touched=i.touched),n&&(o.isDown=n.isDown,o.isUp=n.isUp),this._needleGamepadButtons[t]=o,o}getStick(t){var i,n,o,a,l,c,d,u,f;if(!this._layout)return{x:0,y:0,z:0};if(t==="primary"){const m=((i=this.inputSource.gamepad)==null?void 0:i.axes[0])||0,g=((n=this.inputSource.gamepad)==null?void 0:n.axes[1])||0,_=((a=(o=this.inputSource.gamepad)==null?void 0:o.buttons[3])==null?void 0:a.value)||0;return{x:m,y:g,z:_}}const e=(l=this._layout)==null?void 0:l.components[t];if(e!=null&&e.gamepadIndices)switch(e.type){case"thumbstick":if(this.inputSource.gamepad){const m=e.gamepadIndices.xAxis,g=e.gamepadIndices.yAxis;let _=(c=this.inputSource.gamepad)==null?void 0:c.axes[m],y=(d=this.inputSource.gamepad)==null?void 0:d.axes[g];_*=-1,y*=-1;const b=e.gamepadIndices.button,v=(f=(u=this.inputSource.gamepad)==null?void 0:u.buttons[b])==null?void 0:f.value;return{x:_,y,z:v}}}return{x:0,y:0,z:0}}initialize(){if(this._hasSelectEvent=this.profiles.includes("generic-hand-select")||this.profiles.some(t=>t.startsWith("generic-trigger")),this._isMetaQuestTouchController=this.profiles.includes("meta-quest-touch-plus")||this.profiles.includes("oculus-touch-v3"),this._isMxInk=this.profiles.includes("logitech-mx-ink"),!this._layout){if(this.inputSource.targetRayMode==="transient-pointer")return;const t=oe.fetchProfile(this.inputSource,VS,$S);this.getMotionController=t.then(e=>{var o;if(!this.connected)return null;this._motioncontroller=new oe.MotionController(this.inputSource,e.profile,e.assetPath||"");const n=e.profile.layouts[this.inputSource.handedness];if(this._layout=n,this._layout&&!((o=this._layout.gamepad)!=null&&o.length)){this._layout.gamepad=[];for(const a in this._layout.components){const l=this._layout.components[a];this._layout.gamepad[l.gamepadIndices.button]=a}}return this._motioncontroller}).catch(e=>(this.inputSource&&console.warn("Couldn't initialize motion controller profile for ",this.inputSource,e),null))}}subscribeEvents(){this.xr.session.addEventListener("selectstart",this.onSelectStart),this.xr.session.addEventListener("selectend",this.onSelectEnd),this.xr.session.addEventListener("squeezestart",this.onSequeezeStart),this.xr.session.addEventListener("squeezeend",this.onSequeezeEnd)}unsubscribeEvents(){this.xr.session.removeEventListener("selectstart",this.onSelectStart),this.xr.session.removeEventListener("selectend",this.onSelectEnd),this.xr.session.removeEventListener("squeezestart",this.onSequeezeStart),this.xr.session.removeEventListener("squeezeend",this.onSequeezeEnd)}updateInputEvents(){var t,e,i;if((t=this.gamepad)!=null&&t.buttons){for(let n=0;n<this.gamepad.buttons.length;n++){const o=this.gamepad.buttons[n],a=this.states[n]||new N_;let l=null;this._isMxInk&&(n===4||n===5)?(o.value>0&&!a.pressed?(l="pointerdown",a.isDown=!0,a.isUp=!1):o.value===0&&a.pressed?(l="pointerup",a.isDown=!1,a.isUp=!0):a.pressed&&(l="pointermove",a.isDown=!1,a.isUp=!1),a.pressed=o.value>0,a.value=o.value):(o.pressed&&!a.pressed?(l="pointerdown",a.isDown=!0,a.isUp=!1):!o.pressed&&a.pressed?(l="pointerup",a.isDown=!1,a.isUp=!0):(a.isDown=!1,a.isUp=!1),a.pressed=o.pressed,a.value=o.value),this.states[n]=a;const c=n!==this._selectButtonIndex&&n!==this._squeezeButtonIndex;if(l!=null&&c){let d=(e=this._layout)==null?void 0:e.gamepad[n];this._isMxInk&&n===4&&(d="stylus-touch"),this._isMxInk&&n===5&&(d="stylus-tip"),(qn||Th)&&console.log("Emitting pointer event",l,n,d,o.value,this.gamepad,this._layout),this.emitPointerEvent(l,n,d??"none",!1,null,o.value)}}if(this._isMetaQuestTouchController){const n=this.gamepad.buttons.length-1,o=this.states[n];if(o&&o.isDown){const a=this.context.menu;a.spatialMenuIsVisible?a.setSpatialMenuVisible(!1):this.context.menu.setSpatialMenuVisible(!0)}}}if(this.hand){const n=this.handObject;if(n){const o=n.joints["index-finger-tip"],a=n.joints["thumb-tip"];if(o&&a){const l=o.position.distanceTo(a.position);this._pinchPosition.lerpVectors(o.position,a.position,.5);const c=(i=this.xr.context.mainCamera)==null?void 0:i.parent;if(c&&this._pinchPosition.applyMatrix4(c.matrixWorld),l!==0){const f=this.states.pinch||new N_,m=(.02+.01)*1.5;f.value=1-(l-.02)/m;const g=l<.02-.01,_=l>.02+.01;g&&!f.pressed?(Th&&console.log("pinch start",l),f.isDown=!0,f.isUp=!1,f.pressed=!0):_&&f.pressed?(f.isDown=!1,f.isUp=!0,f.pressed=!1):(f.isDown=!1,f.isUp=!1),this.states.pinch=f}}}}}onUpdateMove(){var i,n;if(!this.emitPointerMoveEvent)return;let t=!1;if(this._lastPointerMovePosition.distanceTo(this.gripWorldPosition)>this.pointerMoveDistanceThreshold*this.xr.rigScale&&(t=!0),t||this._lastPointerMoveQuaternion.angleTo(this.gripWorldQuaternion)>this.pointerMoveAngleThreshold&&(t=!0),t){this._didMoveLastFrame=!0,this._lastPointerMovePosition.copy(this.gripWorldPosition),this._lastPointerMoveQuaternion.copy(this.gripWorldQuaternion),qn&&N.DrawLabel(this.rayWorldPosition.add(this.object.worldForward.multiplyScalar(.1)),"move",.01);let o=this.xr.context.input.getFirstPressedButtonForPointer(this.index);o===void 0&&(o=0);const a=(n=(i=this.gamepad)==null?void 0:i.buttons[o])==null?void 0:n.value;this.emitPointerEvent("pointermove",o,"none",!1,null,a)}else this._didMoveLastFrame=!1}emitPointerEvent(t,e,i,n,o=null,a){if(!this.emitEvents){qn&&t!==ke.PointerMove&&console.warn("Pointer events are disabled for this controller",this.index,t,e);return}if(this.xr.mode==="immersive-vr"||this.xr.isPassThrough){this.pointerInit.origin=this,this.pointerInit.pointerId=this.getPointerId(e),this.pointerInit.pointerType=this.hand?"hand":"controller",this.pointerInit.button=e,this.pointerInit.buttonName=i,this.pointerInit.isPrimary=n,this.pointerInit.mode=this.inputSource.targetRayMode,this.pointerInit.ray=this.ray,this.pointerInit.device=this.object,this.pointerInit.pressure=a,this.pointerInit.clientX=this._rayPosition.x/this.xr.rigScale,this.pointerInit.clientY=this._rayPosition.y/this.xr.rigScale,this.pointerInit.clientZ=this._rayPosition.z/this.xr.rigScale;const l=Q.Current;Q.Current=this.xr.context,qn&&t!=="pointermove"&&console.warn("Pointer event",t,e,i,{...this.pointerInit}),this.xr.context.input.createInputEvent(new ns(t,o,this.pointerInit)),Q.Current=l}}}class N_{constructor(){r(this,"isDown",!1);r(this,"isUp",!1);r(this,"pressed",!1);r(this,"value",0)}}class V_{constructor(t,e){r(this,"index");r(this,"name");r(this,"touched",!1);r(this,"pressed",!1);r(this,"value",0);r(this,"isDown",!1);r(this,"isUp",!1);this.index=t,this.name=e}}const ba=new Map,ca=new Map;let $_=0;function bs(s,t,e){if(ba.has(t)||ba.set(t,new Array),ba.get(t).push({method:s,options:{once:!1,...e}}),$_<30){const i=ca.get(t);i&&(i==null?void 0:i.length)>100&&($_+=1,console.warn(`You have ${i.length} methods registered for Event ${t}.

This might be a performance issue!
Consider unregistering the methods when they are not needed anymore!

To unregister you can call the function returned by your event hook (e.g.const unregister = onStart(...)) 

or by using the once option like onStart(()=>{}, { once:true }).

See https://engine.needle.tools/docs/scripting.html#special-lifecycle-hooks for more information.`))}}function _o(s,t){const e=ca.get(t);if(e){for(let n=0;n<e.length;n++)if(e[n].method===s){e.splice(n,1);return}}const i=ba.get(t);if(i){for(let n=0;n<i.length;n++)if(i[n].method===s){i.splice(n,1);return}}}function wn(s,t){t===he.ContextCreated&&Vp.delete(s),d0(s,t)}function d0(s,t){t===ve.Start&&ba.get(he.ContextCreated)&&d0(s,he.ContextCreated);const e=t===ve.Start||t===he.ContextCreated,i=ca.get(t);i&&i.length>0&&G_(s,i,e);const n=ba.get(t);if(n&&n.length>0){const o=[...n];n.length=0,G_(s,o,e),o.length>0&&(ca.has(t)||ca.set(t,new Array),ca.get(t).push(...o))}}const Ah=new Array,W_={context:null};function G_(s,t,e){var n,o;Ah.length=0;for(let a=0;a<t.length;a++)Ah.push(t[a]);let i=Vp.get(s);for(let a=0;a<Ah.length;a++){const l=Ah[a];let c=!0;if(i&&i.has(l)&&(c=!1),c)try{W_.context=s,(n=l.method)==null||n.call(W_,s)}catch(d){console.error("Error in lifecycle method",d)}if((o=l.options)!=null&&o.once){for(let d=0;d<t.length;d++)if(t[d]===l){t.splice(d,1);break}}else e&&(i||(i=new Set,Vp.set(s,i)),i.add(l))}}const Vp=new WeakMap,$m={};function Wm(s,t){$m[s]=t}function u0(s){const t=s.getBufferIdentifier(),e=$m[t];return e(s)}function f0(s){return typeof s.guid=="function"?s.guid():null}let Gm;function HS(){return Gm}function qS(s){Gm=s}function p0(s,t){return t||(t={}),t={...Gm,...t},s?new oe.$70d766613f57b014$export$2e2bcd8739ae039(s,t):new oe.$70d766613f57b014$export$2e2bcd8739ae039(t)}async function H_(){const s=await Promise.resolve().then(()=>require("./vendor.light.umd.cjs")).then(t=>t.bundler);return console.log(s),s.default===void 0?s:s.default}class m0{constructor(){r(this,"_host");r(this,"_client");r(this,"_clientData");this.onEnable()}get isHost(){return this._host!==void 0}onEnable(){const t="HOST-5980e65c-8438-453e-8b35-f13c736dcd81";this.trySetupHost(t)}async trySetupHost(t){const e=await H_(),i=new e(t);i.on("error",n=>{console.error(n),this._host=void 0,this.trySetupClient(t)}),i.on("open",n=>{this._host=new QS(i)})}async trySetupClient(t){const e=await H_();this._client=new e,this._client.on("error",i=>{console.error("Client error",i)}),this._client.on("open",i=>{console.log("client connected",i),this._clientData=this._client.connect(t,{metadata:{id:i}}),this._clientData.on("open",()=>{console.log("Connected to host")}),this._clientData.on("data",n=>{console.log("<<",n)})})}}class XS{constructor(t){r(this,"_peer");this._peer=t}}class QS extends XS{constructor(e){var i;super(e);r(this,"_connections",[]);console.log("I AM THE HOST"),(i=this._peer)==null||i.on("connection",this.onConnection.bind(this)),this._peer.on("close",()=>{this.broadcast("BYE")}),setInterval(()=>{this.broadcast("HELLO")},2e3)}get isHost(){return!0}onConnection(e){console.log("host connection",e),e.on("open",()=>{this._connections.push(e),this.broadcastConnection(e)})}broadcastConnection(e){const i=this._connections.map(n=>{var o;return(o=n.metadata)==null?void 0:o.id}).filter(n=>n!==void 0);this.broadcast({type:"connection-list",connections:i})}broadcast(e){if(e!=null){console.log(">>",e);for(const i in this._peer.connections){const n=this._peer.connections[i];if(n)if(Array.isArray(n))for(const o of n)o&&o.send(e);else console.warn(n)}}}}var rn=(s=>(s[s.OnConnection=0]="OnConnection",s[s.OnRoomJoin=1]="OnRoomJoin",s[s.Queued=2]="Queued",s[s.Immediate=3]="Immediate",s))(rn||{});const q_="https://urls.needle.tools/default-networking-backend/index";let Qt="wss://networking.needle.tools/socket";const Yt=!!x("debugnet"),jl=!!(Yt||x("debugowner")),yf=x("debugnetbin");var g0=(s=>(s.ConnectionInfo="connection-start-info",s))(g0||{}),J=(s=>(s.Join="join-room",s.Leave="leave-room",s.JoinedRoom="joined-room",s.LeftRoom="left-room",s.UserJoinedRoom="user-joined-room",s.UserLeftRoom="user-left-room",s.RoomStateSent="room-state-sent",s))(J||{});class YS{constructor(){r(this,"room");r(this,"viewId");r(this,"allowEditing");r(this,"inRoom")}}class KS{constructor(){r(this,"room")}}class ZS{constructor(){r(this,"userId")}}var _0=(s=>(s.RequestHasOwner="request-has-owner",s.ResponseHasOwner="response-has-owner",s.RequestIsOwner="request-is-owner",s.ResponseIsOwner="response-is-owner",s.RequestOwnership="request-ownership",s.GainedOwnership="gained-ownership",s.RemoveOwnership="remove-ownership",s.LostOwnership="lost-ownership",s.GainedOwnershipBroadcast="gained-ownership-broadcast",s.LostOwnershipBroadcast="lost-ownership-broadcast",s))(_0||{});class Hm{constructor(t,e){r(this,"guid");r(this,"connection");r(this,"_hasOwnership",!1);r(this,"_isOwned");r(this,"_gainSubscription");r(this,"_lostSubscription");r(this,"_hasOwnerResponse");r(this,"_isWaitingForOwnershipResponseCallback",null);this.connection=t,this.guid=e,this._gainSubscription=this.onGainedOwnership.bind(this),this._lostSubscription=this.onLostOwnership.bind(this),t.beginListen("lost-ownership",this._lostSubscription),t.beginListen("gained-ownership-broadcast",this._gainSubscription),this._hasOwnerResponse=this.onHasOwnerResponse.bind(this),t.beginListen("response-has-owner",this._hasOwnerResponse)}get hasOwnership(){return this._hasOwnership}get isOwned(){return this._isOwned}get isConnected(){return this.connection.isConnected}updateIsOwned(){this.connection.send("request-has-owner",{guid:this.guid})}onHasOwnerResponse(t){t.guid===this.guid&&(this._isOwned=t.value)}requestOwnershipIfNotOwned(){return this._isWaitingForOwnershipResponseCallback!==null?this:(this._isWaitingForOwnershipResponseCallback=this.waitForHasOwnershipRequestResponse.bind(this),this.connection.beginListen("response-has-owner",this._isWaitingForOwnershipResponseCallback),this.connection.send("request-has-owner",{guid:this.guid}),this)}waitForHasOwnershipRequestResponse(t){t.guid===this.guid&&(this._isWaitingForOwnershipResponseCallback&&(this.connection.stopListen("response-has-owner",this._isWaitingForOwnershipResponseCallback),this._isWaitingForOwnershipResponseCallback=null),this._isOwned=t.value,t.value||(jl&&console.log("request ownership",this.guid),this.requestOwnership()))}requestOwnershipAsync(){return new Promise((t,e)=>{this.requestOwnership();let i=0;const n=()=>{if(i++>10)return e("Timeout");setTimeout(()=>{this.hasOwnership?t(this):n()},100)};n()})}requestOwnership(){return jl&&console.log("Request ownership",this.guid),this.connection.send("request-ownership",{guid:this.guid}),this}freeOwnership(){return this.connection.send("remove-ownership",{guid:this.guid}),this._isWaitingForOwnershipResponseCallback&&(this.connection.stopListen("response-has-owner",this._isWaitingForOwnershipResponseCallback),this._isWaitingForOwnershipResponseCallback=null),this}destroy(){this.connection.stopListen("gained-ownership",this._gainSubscription),this.connection.stopListen("lost-ownership",this._lostSubscription),this.connection.stopListen("response-has-owner",this._hasOwnerResponse),this._isWaitingForOwnershipResponseCallback&&(this.connection.stopListen("response-has-owner",this._isWaitingForOwnershipResponseCallback),this._isWaitingForOwnershipResponseCallback=null)}onGainedOwnership(t){t.guid===this.guid&&(this._isOwned=!0,this.connection.connectionId===t.owner?(jl&&console.log("GAINED OWNERSHIP",this.guid),this._hasOwnership=!0):this._hasOwnership=!1)}onLostOwnership(t){t===this.guid&&(jl&&console.log("LOST OWNERSHIP",this.guid),this._hasOwnership=!1,this._isOwned=!1)}}class y0{constructor(t){r(this,"context");r(this,"_peer",null);r(this,"_usersInRoomCopy",[]);r(this,"_defaultMessagesBuffer",[]);r(this,"_defaultMessagesBufferArray",[]);r(this,"netWebSocketUrlProvider");r(this,"_listeners",{});r(this,"_listenersBinary",{});r(this,"connected",!1);r(this,"channelId");r(this,"_connectionId",null);r(this,"_ws");r(this,"_waitingForSocket",{});r(this,"_isInRoom",!1);r(this,"_currentRoomName",null);r(this,"_currentRoomViewId",null);r(this,"_currentRoomAllowEditing",!0);r(this,"_currentInRoom",[]);r(this,"_state",{});r(this,"_currentDelay",-1);r(this,"_connectingToWebsocketPromise",null);this.context=t}get peer(){return this._peer||(this._peer=new m0),this._peer}tryGetState(t){return t==="invalid"?null:this._state[t]}get connectionId(){return this._connectionId}get isDebugEnabled(){return Yt}get isConnected(){return this.connected}get currentRoomName(){return this._currentRoomName}get allowEditing(){return this._currentRoomAllowEditing}get currentRoomViewId(){return this._currentRoomViewId}getViewOnlyUrl(){if(this.currentRoomViewId===null)return null;const t=new URL(window.location.href);return t.searchParams.set("view",this.currentRoomViewId),t.href}get isInRoom(){return this._isInRoom}get currentLatency(){return this._currentDelay}get currentServerUrl(){var t;return((t=this._ws)==null?void 0:t.url)??null}sendPing(){this.send("ping",{time:this.context.time.time})}userIsInRoom(t){return this._currentInRoom.indexOf(t)!==-1}usersInRoom(t=null){t||(t=this._usersInRoomCopy),t.length=0;for(const e of this._currentInRoom)t.push(e);return t}joinRoom(t,e=!1){return t?t.length>1024?(console.error('Room name too long, can not join: "'+t+'". Max length is 1024 characters.'),!1):(this.connect(),Yt&&console.log("join: "+t),this.send("join-room",{room:t,viewOnly:e},rn.OnConnection),!0):(console.error('Missing room name, can not join: "'+t+'"'),!1)}leaveRoom(t=null){return t||(t=this.currentRoomName),t?(this.send("leave-room",{room:t}),!0):(console.error('Missing room name, can not join: "'+t+'"'),!1)}send(t,e=null,i=rn.Queued){if(e===null&&(e={}),i===rn.Queued){this._defaultMessagesBuffer.push({key:t,value:e});return}return this.sendWithWebsocket(t,e,i)}sendDeleteRemoteState(t){this.send("delete-state",{guid:t,dontSave:!0}),delete this._state[t]}sendDeleteRemoteStateAll(){this.send("delete-all-state"),this._state={}}sendBinary(t){var e;yf&&console.log("<< send binary",this.context.time.frame,t.length/1024+" KB"),(e=this._ws)==null||e.send(t)}sendBufferedMessagesNow(){var i;if(!this._ws)return;this._defaultMessagesBufferArray.length=0;const t=Object.keys(this._defaultMessagesBuffer).length;for(const n in this._defaultMessagesBuffer){const o=this._defaultMessagesBuffer[n];if(t<=1){this.sendWithWebsocket(o.key,o.value,rn.Immediate);break}const a=this.toMessage(o.key,o.value);this._defaultMessagesBufferArray.push(a)}if(this._defaultMessagesBuffer.length=0,this._defaultMessagesBufferArray.length>0&&Yt&&console.log("SEND BUFFERED",this._defaultMessagesBufferArray.length),this._defaultMessagesBufferArray.length<=0)return;const e=JSON.stringify(this._defaultMessagesBufferArray);(i=this._ws)==null||i.send(e)}beginListen(t,e){return this._listeners[t]||(this._listeners[t]=[]),this._listeners[t].push(e),e}stopListening(t,e){return this.stopListen(t,e)}stopListen(t,e){if(!e||!this._listeners[t])return;const i=this._listeners[t].indexOf(e);i>=0&&this._listeners[t].splice(i,1)}beginListenBinary(t,e){return this._listenersBinary[t]||(this._listenersBinary[t]=[]),this._listenersBinary[t].push(e),e}stopListenBinary(t,e){if(!this._listenersBinary[t])return;const i=this._listenersBinary[t].indexOf(e);i>=0&&this._listenersBinary[t].splice(i,1)}registerProvider(t){this.netWebSocketUrlProvider=t}async connect(t){var i;if(this.connected&&t&&t!==Qt)return Promise.reject("Can not connect to different server url. Please disconnect first.");if(this.connected)return Promise.resolve(!0);t&&console.debug("Connecting to user provided url "+t);const e=t||((i=this.netWebSocketUrlProvider)==null?void 0:i.getWebsocketUrl());return e?Qt=e:kb()&&(Qt="wss://"+window.location.host+"/socket"),this.connectWebsocket()}disconnect(){var t;(t=this._ws)==null||t.close(),this._ws=void 0,Qt=void 0}connectWebsocket(){return this._connectingToWebsocketPromise?this._connectingToWebsocketPromise:this._connectingToWebsocketPromise=new Promise(async(t,e)=>{var d,u;let i=!1;const n=f=>{i||(i=!0,t(f))};if(Qt===void 0&&(console.log("Fetch default backend url: "+q_),Qt=await(await fetch(q_)).text()),Qt===void 0){n(!1);return}console.debug(`⊡ Connecting to networking backend on
`+Qt);const o=await Promise.resolve().then(()=>require("./vendor.light.umd.cjs")).then(f=>f.index),a=((d=o.default)==null?void 0:d.WebsocketBuilder)??o.WebsocketBuilder,l=((u=o.default)==null?void 0:u.ExponentialBackoff)??o.ExponentialBackoff,c=new a(Qt).withMaxRetries(10).withBackoff(new l(2e3,4)).onOpen(()=>{this._connectingToWebsocketPromise=null,this._ws=c,this.connected=!0,B()||Yt?console.log(`⊞ Connected to networking backend
`+Qt):console.debug("⊞ Connected to networking backend",Qt),n(!0),this.onSendQueued(rn.OnConnection)}).onClose(f=>{this._connectingToWebsocketPromise=null,this.connected=!1,this._isInRoom=!1,n(!1);let m="Websocket connection closed...";Qt!=null&&Qt.includes("/socket")||(m+=' Do you perhaps mean to connect to "/socket"?'),console.error(m)}).onError(f=>{console.error("⊠ Websocket connection failed..."),n(!1)}).onRetry(()=>{console.log("→ Retry connecting to networking websocket")}).build();c.addEventListener(o.WebsocketEvent.message,(f,m)=>{this.onMessage(f,m)})})}onMessage(t,e){const i=e.data;try{if(typeof i!="string"){i.size&&this.handleIncomingBinaryMessage(i);return}const n=JSON.parse(i);if(Array.isArray(n))for(const o of n)this.handleIncomingStringMessage(o);else this.handleIncomingStringMessage(n);return}catch(n){Yt&&i==="pong"?console.log("<<",i):B()&&console.error("Failed to parse message",n)}}async handleIncomingBinaryMessage(t){yf&&console.log("<< bin",this.context.time.frame);const e=await t.arrayBuffer();var i=new Uint8Array(e);const n=new oe.ByteBuffer(i),o=n.getBufferIdentifier(),a=this._listenersBinary[o],l=u0(n),c=f0(l);if(c&&typeof c=="string"&&(this._state[c]=l),!a)return;const d=l??n;for(const u of a)u(d)}handleIncomingStringMessage(t){var n,o;if(Yt&&console.log("<<",t.key??t),t.key)switch(t.key){case"connection-start-info":if(t.data){const c=t.data;c&&(console.assert(c.id!==void 0&&c.id!==null&&c.id.length>0,"server did not send connection id",c.id),console.debug("Your id is: "+c.id,this.context.alias??""),this._connectionId=c.id)}else console.warn("Expected connection id in "+t.key);break;case"joined-room":if(Yt&&console.log(t),t){this._isInRoom=!0;const c=t;this._currentRoomName=c.room,this._currentRoomViewId=c.viewId,this._currentRoomAllowEditing=c.allowEditing??!0,this._currentInRoom.length=0,this._currentInRoom.push(...c.inRoom),(yf||B())&&console.debug("Joined Needle Engine Room: "+c.room);const d=new URL(window.location.href);d.searchParams.has("room")&&d.searchParams.delete("room"),d.searchParams.set("view",this._currentRoomViewId),console.debug(`Room view id: ${this._currentRoomViewId}
${d.href}`)}this.onSendQueued(rn.OnRoomJoin);break;case"left-room":t.room===this.currentRoomName&&(this._isInRoom=!1,this._currentRoomName=null,this._currentInRoom.length=0);break;case"user-joined-room":if(t.data){const c=t.data;this._currentInRoom.push(c.userId),Yt&&console.log(c.userId+" joined","now in room:",this._currentInRoom)}break;case"user-left-room":if(t.data){const c=t.data,d=this._currentInRoom.indexOf(c.userId);d>=0&&(Yt&&console.log(c.userId+" left","now in room:",this._currentInRoom),this._currentInRoom.splice(d,1)),c.userId===this.connectionId&&console.log("you left the room")}break;case"all-room-state-deleted":Yt&&console.log("RECEIVED all-room-state-deleted"),this._state={};break;case"ping":case"pong":const l=(n=t.data)==null?void 0:n.time;l&&(this._currentDelay=this.context.time.time-l),Yt&&console.log("Current latency: "+this._currentDelay.toFixed(4)+" sec","Clients in room: "+((o=this._currentInRoom)==null?void 0:o.length));break}const e=t.data;e&&(this._state[e.guid]=e);let i=this._listeners[t.key];if(i){i=[...i];for(const a of i)try{a(t.data)}catch(l){console.error('Error invoking callback for "'+t.key+'"',l)}}}toMessage(t,e){return{key:t,data:e}}sendWithWebsocket(t,e,i=rn.OnRoomJoin){if(!this._ws){const o=this._waitingForSocket[i]||[];o.push(()=>this.sendWithWebsocket(t,e,i)),this._waitingForSocket[i]=o;return}const n=JSON.stringify(this.toMessage(t,e));Yt&&console.log(">>",t),this._ws.send(n)}onSendQueued(t){const e=this._waitingForSocket[t];if(e){for(const i of e)i();e.length=0}}}const tc=x("debugwebxr");class bf{constructor(t,e){r(this,"controllerStates",[]);r(this,"userId");r(this,"context");r(this,"userStateEvtName");r(this,"onReceivedControllerState",t=>{tc&&console.log(`XRSync: Received change for ${this.userId}: ${t.type} ${t.handedness}; tracked=${t.isTracking}`);let e=!1;for(let i=0;i<this.controllerStates.length;i++)if(this.controllerStates[i].index===t.index){this.controllerStates[i]=t,e=!0;break}e||this.controllerStates.push(t)});this.userId=t,this.context=e,this.userStateEvtName="xr-sync-user-state-"+t,this.context.connection.beginListen(this.userStateEvtName,this.onReceivedControllerState)}dispose(){this.context.connection.stopListen(this.userStateEvtName,this.onReceivedControllerState)}update(t){if(this.context.connection.isConnected!=!1){for(let e=this.controllerStates.length-1;e>=0;e--){const i=this.controllerStates[e];let n=!1;for(let o=0;o<t.controllers.length;o++)t.controllers[o].index===i.index&&(n=!0);n||(tc&&console.log(`XRSync: ${i.type} ${i.handedness} removed`,i.index),this.controllerStates.splice(e,1),this.sendControllerRemoved(i))}for(const e of t.controllers)this.updateControllerStates(e)}}onExitXR(t){for(const e of this.controllerStates)this.sendControllerRemoved(e);this.controllerStates.length=0}sendControllerRemoved(t){t.isTracking=!1,t.guid="",this.context.connection.send(this.userStateEvtName,t),this.context.connection.sendDeleteRemoteState(t.guid)}updateControllerStates(t){const e=this.controllerStates.find(i=>i.index===t.index);if(e){let i=!1;i||(i=e.isTracking!=t.isTracking),i&&(e.isTracking=t.isTracking,this.context.connection.send(this.userStateEvtName,e))}else{const i={guid:this.userId+"-"+t.index,isTracking:t.isTracking,handedness:t.side,index:t.index,type:t.hand?"hand":"controller"};this.controllerStates.push(i),this.context.connection.send(this.userStateEvtName,i),tc&&console.log(`XRSync: ${i.type} ${i.handedness} added`,i.index)}}}class b0{constructor(t){r(this,"context");r(this,"onJoinedRoom",()=>{if(this.context.connection.connectionId){this._states.has(this.context.connection.connectionId)||(tc&&console.log("XRSync: Local user joined room",this.context.connection.connectionId),this._states.set(this.context.connection.connectionId,new bf(this.context.connection.connectionId,this.context)));for(const t of this.context.connection.usersInRoom())this._states.has(t)||this._states.set(t,new bf(t,this.context))}});r(this,"onLeftRoom",()=>{if(this.context.connection.connectionId&&!this._states.has(this.context.connection.connectionId)){const t=this._states.get(this.context.connection.connectionId);t==null||t.dispose(),this._states.delete(this.context.connection.connectionId)}});r(this,"onOtherUserJoinedRoom",t=>{const e=t.userId;this._states.has(e)||(tc&&console.log("XRSync: Remote user joined room",e),this._states.set(e,new bf(e,this.context)))});r(this,"onOtherUserLeftRoom",t=>{const e=t.userId;if(!this._states.has(e)){const i=this._states.get(e);i==null||i.dispose(),this._states.delete(e)}});r(this,"_states",new Map);this.context=t,this.context.connection.beginListen(J.JoinedRoom,this.onJoinedRoom),this.context.connection.beginListen(J.LeftRoom,this.onLeftRoom),this.context.connection.beginListen(J.UserJoinedRoom,this.onOtherUserJoinedRoom),this.context.connection.beginListen(J.UserLeftRoom,this.onOtherUserLeftRoom)}hasState(t){return t?this._states.has(t):!1}isTracking(t,e){if(!t)return;const i=this._states.get(t);if(!i)return;const n=i.controllerStates.find(o=>o.handedness===e);return(n==null?void 0:n.isTracking)||!1}getDeviceType(t,e){if(!t)return;const i=this._states.get(t);if(!i)return;const n=i.controllerStates.find(o=>o.handedness===e);return(n==null?void 0:n.type)||"unknown"}destroy(){this.context.connection.stopListen(J.JoinedRoom,this.onJoinedRoom),this.context.connection.stopListen(J.LeftRoom,this.onLeftRoom),this.context.connection.stopListen(J.UserJoinedRoom,this.onOtherUserJoinedRoom),this.context.connection.stopListen(J.UserLeftRoom,this.onOtherUserLeftRoom)}onUpdate(t){if(this.context.connection.isConnected&&this.context.connection.connectionId){const e=this._states.get(this.context.connection.connectionId);e==null||e.update(t)}}onExitXR(t){if(this.context.connection.isConnected&&this.context.connection.connectionId){const e=this._states.get(this.context.connection.connectionId);e==null||e.onExitXR(t)}}}class X_{constructor(){r(this,"_fadeToColorQuad");r(this,"_fadeToColorMaterial");r(this,"_requestedFadeValue",0);r(this,"_transitionPromise",null);r(this,"_transitionResolve",null);this._fadeToColorMaterial=new h.MeshBasicMaterial({color:0,transparent:!0,depthTest:!1,fog:!1,side:h.DoubleSide}),this._fadeToColorQuad=new h.Mesh(new h.PlaneGeometry(10,10),this._fadeToColorMaterial)}dispose(){this._fadeToColorQuad.geometry.dispose(),this._fadeToColorMaterial.dispose()}update(t,e){const i=this._fadeToColorQuad,n=this._fadeToColorMaterial;i.parent!==t&&n.opacity>0?t.add(i):n.opacity===0&&i.removeFromParent(),i.layers.set(2),i.material=this._fadeToColorMaterial,i.position.z=-1,i.renderOrder=1/0;const o=this._requestedFadeValue;n.opacity=z.lerp(n.opacity,o,e/.03),Math.abs(n.opacity-o)<=.01&&this._transitionResolve&&(this._transitionResolve(),this._transitionResolve=null,this._transitionPromise=null,this._requestedFadeValue=0)}remove(){this._fadeToColorQuad.removeFromParent()}fadeTransition(){if(this._transitionPromise)return this._transitionPromise;this._requestedFadeValue=1;const t=new Promise(e=>{this._transitionResolve=e});return this._transitionPromise=t,t}}var lr=(s=>(s[s.Quad=0]="Quad",s[s.Cube=1]="Cube",s[s.Sphere=2]="Sphere",s[s.RoundedCube=10]="RoundedCube",s))(lr||{}),Lc,$p;class yo{static createText(t,e){let i=null;const n=(e==null?void 0:e.font)||eC((e==null?void 0:e.familyFamily)||null);n instanceof Y.Font?i=ml(this,Lc,$p).call(this,t,n,e):i==null&&(i=new h.BufferGeometry);const o=(e==null?void 0:e.color)||16777215,a=new h.Mesh(i,(e==null?void 0:e.material)??new h.MeshStandardMaterial({color:o}));return this.applyDefaultObjectOptions(a,e),n instanceof Promise?n.then(l=>{a.geometry=ml(this,Lc,$p).call(this,t,l,e),e!=null&&e.onGeometry&&e.onGeometry(a)}):e!=null&&e.onGeometry&&e.onGeometry(a),a}static createOccluder(t){const e=new h.MeshBasicMaterial({colorWrite:!1,depthWrite:!0,side:h.DoubleSide});return this.createPrimitive(t,{material:e})}static createPrimitive(t,e){let i;const n=(e==null?void 0:e.color)||16777215;switch(t){case"Quad":case 0:{const o=new h.PlaneGeometry(1,1,1,1),a=(e==null?void 0:e.material)??new h.MeshStandardMaterial({color:n});e!=null&&e.texture&&"map"in a&&(a.map=e.texture),i=new h.Mesh(o,a),i.name="Quad"}break;case"Cube":case 1:{const o=new h.BoxGeometry(1,1,1),a=(e==null?void 0:e.material)??new h.MeshStandardMaterial({color:n});e!=null&&e.texture&&"map"in a&&(a.map=e.texture),i=new h.Mesh(o,a),i.name="Cube"}break;case 10:case"RoundedCube":{const o=JS(1,1,1,.1,2),a=(e==null?void 0:e.material)??new h.MeshStandardMaterial({color:n});e!=null&&e.texture&&"map"in a&&(a.map=e.texture),i=new h.Mesh(o,a),i.name="RoundedCube"}break;case"Sphere":case 2:{const o=new h.SphereGeometry(.5,16,16),a=(e==null?void 0:e.material)??new h.MeshStandardMaterial({color:n});e!=null&&e.texture&&"map"in a&&(a.map=e.texture),i=new h.Mesh(o,a),i.name="Sphere"}break;case"ShaderBall":i=new h.Group,i.name="ShaderBall",tC(i,e);break}return this.applyDefaultObjectOptions(i,e),i}static createSprite(t){const i=new h.SpriteMaterial({color:16777215});t!=null&&t.texture&&"map"in i&&(i.map=t.texture);const n=new h.Sprite(i);return this.applyDefaultObjectOptions(n,t),n}static applyDefaultObjectOptions(t,e){t.receiveShadow=!0,t.castShadow=!0,e!=null&&e.name&&(t.name=e.name),e!=null&&e.position&&(Array.isArray(e.position)?t.position.set(e.position[0],e.position[1],e.position[2]):t.position.set(e.position.x,e.position.y,e.position.z)),e!=null&&e.rotation&&(Array.isArray(e.rotation)?t.rotation.set(e.rotation[0],e.rotation[1],e.rotation[2]):t.rotation.set(e.rotation.x,e.rotation.y,e.rotation.z)),e!=null&&e.scale&&(typeof e.scale=="number"?t.scale.set(e.scale,e.scale,e.scale):Array.isArray(e.scale)?t.scale.set(e.scale[0],e.scale[1],e.scale[2]):t.scale.set(e.scale.x,e.scale.y,e.scale.z)),(e==null?void 0:e.receiveShadow)!=null&&(t.receiveShadow=e.receiveShadow),(e==null?void 0:e.castShadow)!=null&&(t.castShadow=e.castShadow),e!=null&&e.parent&&e.parent.add(t)}}Lc=new WeakSet,$p=function(t,e,i){const n=(i==null?void 0:i.depth)||.1;return new Y.TextGeometry(t,{font:e,size:1,depth:n,height:n,bevelEnabled:(i==null?void 0:i.bevel)||!1,bevelThickness:.01,bevelOffset:.01,bevelSize:.01})},Ei(yo,Lc);function JS(s,t,e,i,n){const o=new h.Shape,a=1e-5,l=i-a;o.absarc(a,a,a,-Math.PI/2,-Math.PI,!0),o.absarc(a,t-l*2,a,Math.PI,Math.PI/2,!0),o.absarc(s-l*2,t-l*2,a,Math.PI/2,0,!0),o.absarc(s-l*2,a,a,0,-Math.PI/2,!0);const c=new h.ExtrudeGeometry(o,{bevelEnabled:!0,bevelSegments:n*2,steps:1,bevelSize:l,bevelThickness:i,curveSegments:n});return c.scale(1,1,1-i),c.center(),c.computeVertexNormals(),c}const Dh=new Map;function eC(s){let t="";switch(s){default:case"OpenSans":t="https://cdn.needle.tools/static/fonts/facetype/Open Sans_Regular_ascii.json";break;case"Helvetiker":t="https://raw.githubusercontent.com/mrdoob/three.js/master/examples/fonts/helvetiker_regular.typeface.json";break}if(Dh.has(t)){const n=Dh.get(t);if(n)return n}const e=new Y.FontLoader,i=new Promise((n,o)=>{e.load(t,a=>{Dh.set(t,a),n(a)},void 0,o)});return Dh.set(t,i),i}let vf=!1,wf=null;function tC(s,t){if(wf===null){const e="https://cdn.needle.tools/static/models/shaderball.glb",i=new Y.GLTFLoader,n=re.createLoaders(null);i.setDRACOLoader(n.dracoLoader),i.setKTX2Loader(n.ktx2Loader),vf=!0,wf=i.loadAsync(e).then(o=>{const a=o.scene;return a.position.y-=.5,a}).catch(o=>(console.warn("Failed to load shaderball mesh: "+o.message),Y_())).finally(()=>{vf=!1})}if(vf){const e=Y_();e.name="ShaderBall-Placeholder";const i=e.children[0];(i==null?void 0:i.type)==="Mesh"&&Q_(i,t),s.add(e)}wf.then(e=>{s.children.forEach(o=>{o.name==="ShaderBall-Placeholder"&&s.remove(o)});const i=e.clone(),n=i.children[0];(n==null?void 0:n.type)==="Mesh"&&Q_(n,t),s.add(i)})}function Q_(s,t){var i;if((t==null?void 0:t.color)||(t==null?void 0:t.material)||(t==null?void 0:t.texture)){const n=(t==null?void 0:t.material)??((i=s.material)==null?void 0:i.clone())??new h.MeshStandardMaterial;t.color&&"color"in n&&n.color instanceof h.Color&&n.color.set(t.color),t!=null&&t.texture&&"map"in n&&(n.map=t.texture),s.material=n}}function Y_(){return new h.Group().add(yo.createPrimitive("Sphere",{material:new h.MeshBasicMaterial({transparent:!0,opacity:.1})}))}const g_=class{constructor(t,e,i){r(this,"_session");r(this,"_mode");r(this,"_init");r(this,"_renderer");r(this,"_camera");r(this,"_scene");r(this,"onEnd",()=>{var t;(t=this._session)==null||t.removeEventListener("end",this.onEnd),this._renderer.setAnimationLoop(null),this._renderer.dispose(),this._scene.clear()});r(this,"_lastTime",0);r(this,"onFrame",(t,e)=>{const i=t-this._lastTime;this.update(t,i),this._camera.parent!==this._scene&&this._scene.add(this._camera),this._renderer.render(this._scene,this._camera)});r(this,"_objects",[]);this._mode=t,this._init=e,this._session=i,this._session.addEventListener("end",this.onEnd),this._renderer=new h.WebGLRenderer({alpha:!0}),this._renderer.setAnimationLoop(this.onFrame),this._renderer.xr.setSession(i),this._renderer.xr.enabled=!0,this._camera=new h.PerspectiveCamera,this._scene=new h.Scene,this._scene.fog=new h.Fog(4473924,10,250),this._scene.add(this._camera),this.setupScene()}static get active(){return this._active}static async start(t,e){if(this._active)return console.error("Cannot start a new XR session while one is already active"),null;if(this._requestInFlight)return console.error("Cannot start a new XR session while a request is already in flight"),null;if("xr"in navigator&&navigator.xr){if(!e)return console.error("XRSessionInit must be provided"),null;this._requestInFlight=!0;const i=await navigator.xr.requestSession(t,e);return i.addEventListener("end",()=>{this._active=null}),this._requestInFlight?(this._requestInFlight=!1,this._active=new g_(t,e,i),this._active):(i.end(),null)}return null}static async handoff(){return this._active?this._active.handoff():null}static async stop(){this._requestInFlight=!1,this._active&&(await this._active.end(),await un(100)),this._active=null}get isAR(){return this._mode==="immersive-ar"}end(){return this._session?this._session.end():Promise.resolve()}async handoff(){if(!this._session)throw new Error("Cannot handoff a session that has already ended");const t={session:this._session,mode:this._mode,init:this._init};return await this.onBeforeHandoff(),this.onEnd(),this._session=null,t}async onBeforeHandoff(){await un(1e3),this._scene.clear()}setupScene(){this._scene.background=new h.Color(0),this._scene.add(new h.GridHelper(5,10,1118481,1118481));const t=new h.DirectionalLight(16777215,1);t.position.set(0,20,0),t.castShadow=!1,this._scene.add(t);const e=new h.DirectionalLight(16777215,1);e.position.set(0,-1,0),e.castShadow=!1,this._scene.add(e);const i=new h.PointLight(16777215,1,100,1);i.position.set(0,2,0),i.castShadow=!1,i.distance=200,this._scene.add(i);const n=50;for(let o=0;o<100;o++){const a=new h.MeshStandardMaterial({color:2236962,metalness:1,roughness:.8});this.isAR&&(a.emissive=new h.Color(Math.random(),Math.random(),Math.random()),a.emissiveIntensity=Math.random());const l=z.random(0,1)>.5?lr.Sphere:lr.Cube,c=yo.createPrimitive(l,{material:a});c.position.x=z.random(-n,n),c.position.y=z.random(-2,n),c.position.z=z.random(-n,n),c.rotation.x=z.random(0,Math.PI*2),c.rotation.y=z.random(0,Math.PI*2),c.rotation.z=z.random(0,Math.PI*2),c.scale.multiplyScalar(.5+Math.random()*10);const d=c.position.distanceTo(this._camera.position)-c.scale.x;d<1&&c.position.multiplyScalar(1+1/d),this._objects.push(c),this._scene.add(c)}}update(t,e){const i=t*4e-4;for(let n=0;n<this._objects.length;n++){const o=this._objects[n];o.position.y+=Math.sin(i+n*.5)*.005,o.rotateY(.002)}}};let Qs=g_;r(Qs,"_active",null),r(Qs,"_requestInFlight",!1);var Sc;(s=>{const t=[];function e(){if(!(t!=null&&t.length))return!1;for(const o of t)o.exportAndOpen();return!0}s.exportAndOpen=e;function i(o){t.push(o)}s.registerExporter=i;function n(o){if(!t)return;const a=t.indexOf(o);a>=0&&t.splice(a,1)}s.unregisterExporter=n})(Sc||(Sc={}));const K_="NeedleXRSession onStart",Z_="NeedleXRSession onEnd",ot=x("debugwebxr"),J_=x("stats");let xf=0;function iC(s){let t=null;const e=s;return e.getAROverlayContainer?t=e.getAROverlayContainer():t=s,t}nC();async function nC(){var s;if(x("debugasap")){let t=globalThis["needle:XRSession"];if(t instanceof Promise){delete globalThis["needle:XRSession"],ce.addContextCreatedCallback(async e=>{if(!t)return;Ko(!0);const i=await t;if(i){const n=q.getDefaultSessionInit("immersive-vr");q.setSession("immersive-vr",i,n,e.context)}else console.error("NeedleXRSession: ASAP session was rejected");t=void 0});return}}if("xr"in navigator){if(/WebXRViewer\//i.test(navigator.userAgent)){console.warn("WebXRViewer does not support addEventListener");return}(s=navigator.xr)==null||s.addEventListener("sessiongranted",async()=>{Ko(!0),console.log("Received Session Granted..."),await un(100);const t=sessionStorage.getItem("needle_xr_session_mode"),e=sessionStorage.getItem("needle_xr_session_init")??null,i=e?JSON.parse(e):null;let n=null;if(v0()&&(await Qs.start(t||"immersive-vr",i||q.getDefaultSessionInit("immersive-vr")),await rC(),n=await Qs.handoff()),n)q.setSession(n.mode,n.session,n.init,Q.Current);else if(t&&e){console.log("Session Granted: Restore last session");const o=JSON.parse(e);q.start(t,o).catch(a=>console.warn(a))}else q.start("immersive-vr").catch(o=>console.warn("Session Granted failed:",o))},{once:!0})}}function sC(s,t){sessionStorage.setItem("needle_xr_session_mode",s),sessionStorage.setItem("needle_xr_session_init",JSON.stringify(t))}function oC(){sessionStorage.removeItem("needle_xr_session_mode"),sessionStorage.removeItem("needle_xr_session_init")}const qm=new Set;ce.registerCallback(he.ContextCreationStart,async s=>{qm.add(s.context)});ce.registerCallback(he.ContextCreated,async s=>{qm.delete(s.context)});function v0(){return qm.size>0}function rC(){return new Promise(s=>{const t=Date.now(),e=setInterval(()=>{(!v0()||Date.now()-t>6e4)&&(clearInterval(e),s())},100)})}exports.DeviceUtilities.isDesktop()&&B()&&window.addEventListener("keydown",s=>{(s.key==="x"||s.key==="Escape")&&q.active&&q.stop()});const ss=class{constructor(t,e,i,n){r(this,"context");r(this,"session");r(this,"mode");r(this,"controllers",[]);r(this,"_rigScale",1);r(this,"_lastRigScaleUpdate",-1);r(this,"_rigs",[]);r(this,"_viewerHitTestSource",null);r(this,"_defaultRig");r(this,"_xr_scripts");r(this,"_xr_update_scripts",[]);r(this,"_inactive_scripts",[]);r(this,"_controllerAdded");r(this,"_controllerRemoved");r(this,"_originalCameraWorldPosition");r(this,"_originalCameraWorldRotation");r(this,"_originalCameraWorldScale");r(this,"_originalCameraParent");r(this,"_mainCamera",null);r(this,"onRendererSessionSet",()=>{var t;this.running&&(this.context.renderer.xr.enabled=!0,this.context.renderer.xr.updateCamera(this.context.mainCamera),(t=this.context.mainCameraComponent)==null||t.applyClearFlags())});r(this,"onInputSourceAdded",t=>{if(t.targetRayMode==="screen")return;let e=0;for(let n=0;n<this.session.inputSources.length;n++)if(this.session.inputSources[n]===t){e=n;break}if(this.controllers.find(n=>n.inputSource===t)){console.debug("Controller already exists for input source",e);return}else if(this._newControllers.find(n=>n.inputSource===t)){console.debug("Controller already registered for input source",e);return}const i=new Vm(this,t,e);this._newControllers.push(i)});r(this,"_ended",!1);r(this,"_newControllers",[]);r(this,"onEnd",t=>{var o,a,l;if(this._ended)return;this._ended=!0,console.debug("XR Session ended"),oC(),this.onAfterRender(),this.revertCustomForward(),this._didStart=!1,this._previousCameraParent=null,_o(this.onBefore,ve.LateUpdate);const e=this.context.pre_render_callbacks.indexOf(this.onBeforeRender);e>=0&&this.context.pre_render_callbacks.splice(e,1);const i=this.context.post_render_callbacks.indexOf(this.onAfterRender);i>=0&&this.context.post_render_callbacks.splice(i,1),this.context.xr=null,this.context.renderer.xr.enabled=!1,this.context.pre_update_oneshot_callbacks.push(()=>{var c,d;(c=this.context.mainCameraComponent)==null||c.applyClearFlags(),(d=this.context.mainCameraComponent)==null||d.applyClippingPlane()}),c0({session:this});for(const c of ss._xrEndListeners)c({xr:this});const n=[...this.controllers];for(let c=0;c<n.length;c++)this.disconnectInputSource(n[c].inputSource);this._newControllers.length=0,this.controllers.length=0;for(const c of this._xr_scripts)(o=c==null?void 0:c.onLeaveXR)==null||o.call(c,{xr:this});(a=this.sync)==null||a.onExitXR(this),this.context.mainCamera&&((l=this._originalCameraParent)==null||l.add(this.context.mainCamera),this._originalCameraWorldPosition&&it(this.context.mainCamera,this._originalCameraWorldPosition),this._originalCameraWorldRotation&&Wi(this.context.mainCamera,this._originalCameraWorldRotation),this._originalCameraWorldScale&&Ea(this.context.mainCamera,this._originalCameraWorldScale)),this.context.requestSizeUpdate(),this._defaultRig.gameObject.removeFromParent(),Ko(!1),performance.mark(Z_),performance.measure("NeedleXRSession",K_,Z_)});r(this,"_didStart",!1);r(this,"onBefore",t=>{var n,o,a,l,c,d,u,f;const e=t.xrFrame;if(!e)return;performance.mark("NeedleXRSession onBefore start"),this.context.xr=this,this.context.mainCameraComponent&&this.context.mainCameraComponent!==this._mainCamera&&(this._mainCamera=this.context.mainCameraComponent),((n=this.rig)==null?void 0:n.isActive)==!1&&(ot&&console.warn("Latest rig is not active - trying to activate a different rig",this.rig),this.updateActiveXRRig()),this.rig&&((o=this._mainCamera)!=null&&o.gameObject)&&((l=(a=this._mainCamera)==null?void 0:a.gameObject)==null?void 0:l.parent)!==this.rig.gameObject&&this.rig.gameObject.add((c=this._mainCamera)==null?void 0:c.gameObject),this.internalUpdateState(),this.applyCustomForward();const i={xr:this};if(this._didStart){if(this.context.new_scripts_xr.length>0){const m=[...this.context.new_scripts_xr];for(let g=0;g<m.length;g++){const _=this.context.new_scripts_xr[g];if(!_||_.destroyed||((d=_.supportsXR)==null?void 0:d.call(_,this.mode))==!1){this.context.new_scripts_xr.splice(g,1);continue}if(!_.activeAndEnabled){this.context.new_scripts_xr.splice(g,1),this.markInactive(_);continue}if(this.addScript(_)){this.invokeCallback_EnterXR(_);for(const y of this.controllers)this.invokeCallback_ControllerAdded(_,y)}}}}else{if(this._didStart=!0,this.mode==="immersive-vr"){const g=si(this.context.scene.children);if(g){const _=g.getSize($());if(_.length()>0){const y=this._defaultRig.gameObject;y.position.set(g.min.x+_.x*.5,g.min.y,g.max.z+_.z*.5+1.5);const b=g.getCenter($());b.y=y.position.y,y.lookAt(b)}}}l0({session:this});for(const g of ss._xrStartListeners)g(i);const m=[...this._xr_scripts];ot&&console.log("NeedleXRSession start, handle scripts:",m);for(const g of m){if(g.destroyed){this._script_to_remove.push(g);continue}if(!g.activeAndEnabled){this.markInactive(g);continue}this.invokeCallback_EnterXR(g);for(const _ of this.controllers)this.invokeCallback_ControllerAdded(g,_)}}this.syncCameraCullingMask();for(const m of this.controllers)m.onUpdate(e);if(this._newControllers.length>0){const m=[...this._newControllers];this._newControllers.length=0;for(const g of m){if(!g.connected){console.warn("New controller is not connected",g);continue}this.controllers.push(g);for(const _ of this._xr_scripts){if(_.destroyed){this._script_to_remove.push(_);continue}_.activeAndEnabled!==!1&&this.invokeCallback_ControllerAdded(_,g)}}this.controllers.sort((g,_)=>g.index-_.index)}ot&&this.context.time.frame%30===0&&this.controllers.length<=0&&this.session.inputSources.length>0&&(Ko(!0),console.error("XRControllers are not added but inputSources are present")),performance.mark("NeedleXRSession update scripts start");for(const m of this._xr_update_scripts){if(m.destroyed===!0){this._script_to_remove.push(m);continue}if(m.activeAndEnabled===!1){this.markInactive(m);continue}m.onUpdateXR&&m.onUpdateXR(i)}if(performance.mark("NeedleXRSession update scripts end"),performance.measure("NeedleXRSession update scripts","NeedleXRSession update scripts start","NeedleXRSession update scripts end"),this.handleInactiveScripts(),this._script_to_remove.length>0){const m=[...new Set(this._script_to_remove)];this._script_to_remove.length=0;for(const g of m)!g.destroyed&&this.running&&((u=g.onLeaveXR)==null||u.call(g,i)),this.removeScript(g)}(f=this.sync)==null||f.onUpdate(this),this.onRenderDebug(),performance.mark("NeedleXRSession onBefore end"),performance.measure("NE XR frame","NeedleXRSession onBefore start","NeedleXRSession onBefore end")});r(this,"onBeforeRender",()=>{this.context.mainCamera&&this.updateFade(this.context.mainCamera)});r(this,"onAfterRender",()=>{if(this.onUpdateFade_PostRender(),exports.DeviceUtilities.isDesktop()||!this._renderOnceOnDevice){const t=this.context.renderer;if(t.xr.isPresenting&&this.context.mainCamera){this._renderOnceOnDevice=!0;const e=t.xr.enabled,i=t.getRenderTarget(),n=this.context.scene.background;t.xr.enabled=!1,t.setRenderTarget(null),this.isPassThrough&&(this.context.scene.background=null),this.context.composer?this.context.composer.render(this.context.time.deltaTime):t.render(this.context.scene,this.context.mainCamera),t.xr.enabled=e,t.setRenderTarget(i),this.context.scene.background=n}}});r(this,"_script_to_remove",[]);r(this,"_camera");r(this,"_cameraRenderParent",new h.Object3D().rotateY(Math.PI));r(this,"_previousCameraParent");r(this,"_customforward",!0);r(this,"originalCameraNearPlane");r(this,"_viewerPose");r(this,"_transformOrientation",new h.Quaternion);r(this,"_transformPosition",new h.Vector3);r(this,"_transition");var o,a;performance.mark(K_),sC(t,n.init),this.session=e,this.mode=t,this.context=i,(ot||x("console"))&&Ko(!0),this._xr_scripts=[...n.scripts],this._xr_update_scripts=this._xr_scripts.filter(l=>typeof l.onUpdateXR=="function"),this._controllerAdded=n.controller_added,this._controllerRemoved=n.controller_removed,bs(this.onBefore,ve.LateUpdate),this.context.pre_render_callbacks.push(this.onBeforeRender),this.context.post_render_callbacks.push(this.onAfterRender),((o=n.init.optionalFeatures)!=null&&o.includes("hit-test")||(a=n.init.requiredFeatures)!=null&&a.includes("hit-test"))&&e.requestReferenceSpace("viewer").then(l=>{var c,d;return(d=(c=e.requestHitTestSource)==null?void 0:c.call(e,{space:l}))==null?void 0:d.then(u=>this._viewerHitTestSource=u).catch(u=>console.error(u))}).catch(l=>console.error(l)),this.context.mainCamera&&(this._originalCameraWorldPosition=Z(this.context.mainCamera,new h.Vector3),this._originalCameraWorldRotation=_e(this.context.mainCamera,new h.Quaternion),this._originalCameraWorldScale=Ue(this.context.mainCamera,new h.Vector3),this._originalCameraParent=this.context.mainCamera.parent),this._defaultRig=new NS,this.context.scene.add(this._defaultRig.gameObject),this.addRig(this._defaultRig);for(let l=0;l<e.inputSources.length;l++){const c=e.inputSources[l];if(!c.handedness){console.warn("Input source in xr session has no handedness - ignoring",l);continue}this.onInputSourceAdded(c)}this.session.addEventListener("end",this.onEnd),this.session.addEventListener("inputsourceschange",l=>{for(const c of l.removed)this.disconnectInputSource(c);for(const c of l.added)this.onInputSourceAdded(c)}),this.context.xr=this,this.context.renderer.xr.setSession(this.session).then(this.onRendererSessionSet),"controllerAutoUpdate"in this.context.renderer.xr?(console.debug("Disabling three.js controllerAutoUpdate"),this.context.renderer.xr.controllerAutoUpdate=!1):ot&&console.warn("controllerAutoUpdate is not available in three.js - cannot disable it")}static getXRSync(t){return this._sync||(this._sync=new b0(t)),this._sync}static get currentSessionRequest(){return this._currentSessionRequestMode}static get active(){return this._activeSession}static get activeMode(){var t;return((t=this._activeSession)==null?void 0:t.mode)??null}static get xrSystem(){return"xr"in navigator?navigator.xr:void 0}static isXRSupported(){return Promise.all([this.isVRSupported(),this.isARSupported()]).then(t=>t.some(e=>e)).catch(()=>!1)}static isVRSupported(){return this.isSessionSupported("immersive-vr")}static isARSupported(){return this.isSessionSupported("immersive-ar")}static isSessionSupported(t){var e;return((e=this.xrSystem)==null?void 0:e.isSessionSupported(t).catch(i=>(ot&&console.error(i),!1)))??Promise.resolve(!1)}static onSessionRequestStart(t){this._sessionRequestStartListeners.push(t)}static offSessionRequestStart(t){const e=this._sessionRequestStartListeners.indexOf(t);e>=0&&this._sessionRequestStartListeners.splice(e,1)}static onSessionRequestEnd(t){this._sessionRequestEndListeners.push(t)}static offSessionRequestEnd(t){const e=this._sessionRequestEndListeners.indexOf(t);e>=0&&this._sessionRequestEndListeners.splice(e,1)}static onXRSessionStart(t){this._xrStartListeners.push(t)}static offXRSessionStart(t){const e=this._xrStartListeners.indexOf(t);e>=0&&this._xrStartListeners.splice(e,1)}static onXRSessionEnd(t){this._xrEndListeners.push(t)}static offXRSessionEnd(t){const e=this._xrEndListeners.indexOf(t);e>=0&&this._xrEndListeners.splice(e,1)}static onControllerAdded(t){this._controllerAddedListeners.push(t)}static offControllerAdded(t){const e=this._controllerAddedListeners.indexOf(t);e>=0&&this._controllerAddedListeners.splice(e,1)}static onControllerRemoved(t){this._controllerRemovedListeners.push(t)}static offControllerRemoved(t){const e=this._controllerRemovedListeners.indexOf(t);e>=0&&this._controllerRemovedListeners.splice(e,1)}static offerSession(t,e,i){return"xr"in navigator&&navigator.xr&&"offerSession"in navigator.xr?(typeof navigator.xr.offerSession=="function"&&(console.log("WebXR offerSession is available - requesting mode: "+t),e=="default"&&(e=this.getDefaultSessionInit(t)),navigator.xr.offerSession(t,{...e}).then(n=>ss.setSession(t,n,e,i)).catch(n=>{console.log("XRSession offer rejected (perhaps because another call to offerSession was made or a call to requestSession was made)")})),!0):!1}static getDefaultSessionInit(t){switch(t){case"immersive-ar":const e=["anchors","local-floor","layers","dom-overlay","hit-test","unbounded"];return exports.DeviceUtilities.isVisionOS()||e.push("hand-tracking"),{optionalFeatures:e};case"immersive-vr":const i=["local-floor","bounded-floor","high-fixed-foveation-level","layers"];return exports.DeviceUtilities.isVisionOS()||i.push("hand-tracking"),{optionalFeatures:i};default:return console.warn("No default session init for mode",t),{}}}static async start(t,e,i){var l,c,d,u;if(exports.DeviceUtilities.isiOS()){if(t==="ar")if(await this.isARSupported())t="immersive-ar";else return Sc.exportAndOpen(),null}else t=="ar"&&(t="immersive-ar");if(B()&&x("debugxrpreroom"))return console.warn("Debug: Starting temporary XR session"),await Qs.start(t,e||ss.getDefaultSessionInit(t)),null;if(this._currentSessionRequest)return console.warn("A XRSession is already being requested"),(ot||B())&&pe("A XRSession is already being requested"),this._currentSessionRequest.then(()=>this._activeSession);if(this._activeSession)return console.error("A XRSession is already running"),this._activeSession;if(i||(i=Q.Current),i||(i=ce.All[0]),!i)throw new Error("No Needle Engine Context found");switch(performance.mark("NeedleXRSession start"),e||(e={}),t){case"immersive-ar":{if(await((l=this.xrSystem)==null?void 0:l.isSessionSupported("immersive-ar"))!==!0)return console.error(t+" is not supported by this browser."),null;const m=this.getDefaultSessionInit(t),g=iC(i.domElement);g&&!exports.DeviceUtilities.isQuest()&&(m.domOverlay={root:g},m.optionalFeatures.push("dom-overlay")),e={...m,...e}}break;case"immersive-vr":{if(await((c=this.xrSystem)==null?void 0:c.isSessionSupported("immersive-vr"))!==!0)return console.error(t+" is not supported by this browser."),null;e={...this.getDefaultSessionInit(t),...e}}break;default:console.warn("No default session init for mode",t);break}e.optionalFeatures??(e.optionalFeatures=[]),e.requiredFeatures??(e.requiredFeatures=[]),await Qs.stop();const n=t=="immersive-ar"?i.scripts_immersive_ar:i.scripts_immersive_vr;ot?console.log(`%cRequesting ${t} session`,"font-weight:bold;",e,n):console.log(`%cRequesting ${t} session`,"font-weight:bold;");for(const f of n)f.onBeforeXR&&f.onBeforeXR(t,e);for(const f of this._sessionRequestStartListeners)f({mode:t,init:e});ot&&Te("Requesting "+t+" session ("+Date.now()+")"),this._currentSessionRequest=(d=navigator.xr)==null?void 0:d.requestSession(t,e),this._currentSessionRequestMode=t;const o=await((u=this._currentSessionRequest)==null?void 0:u.catch(f=>{console.error(f,"Code: "+f.code),f.code===9&&pe("Make sure your device has the required permissions (e.g. camera access)"),console.log("If the specified XR configuration is not supported (e.g. entering AR doesnt work) - make sure you access the website on a secure connection (HTTPS) and your device has the required permissions (e.g. camera access)"),location.protocol==="http:"&&pe("XR requires a secure connection (HTTPS)")}));this._currentSessionRequest=void 0,this._currentSessionRequestMode=null;for(const f of this._sessionRequestEndListeners)f({mode:t,init:e,newSession:o||null});if(!o)return console.warn("XR Session request was rejected"),null;const a=this.setSession(t,o,e,i);return performance.mark("NeedleXRSession end"),performance.measure("NeedleXRSession Startup","NeedleXRSession start","NeedleXRSession end"),a}static setSession(t,e,i,n){if(this._activeSession)return console.error("A XRSession is already running"),this._activeSession;const o=t=="immersive-ar"?n.scripts_immersive_ar:n.scripts_immersive_vr;return this._activeSession=new ss(t,e,n,{scripts:o,controller_added:this._controllerAddedListeners,controller_removed:this._controllerRemovedListeners,init:i}),e.addEventListener("end",this.onEnd),ot?console.log(`%cStarted ${t} session`,"font-weight:bold;",o):console.log(`%cStarted ${t} session`,"font-weight:bold;"),this._activeSession}static stop(){var t;(t=this._activeSession)==null||t.end()}get sync(){return ss._sync}get running(){return!this._ended&&this.session!=null}get interactionMode(){return this.session.interactionMode}get visibilityState(){return this.session.visibilityState}get isVisibleBlurred(){return this.session.visibilityState==="visible-blurred"}get isSystemKeyboardSupported(){return this.session.isSystemKeyboardSupported}get environmentBlendMode(){return this.session.environmentBlendMode}get frame(){return this.context.xrFrame}get leftController(){return this.controllers.find(t=>t.side==="left")}get rightController(){return this.controllers.find(t=>t.side==="right")}getController(t){return typeof t=="number"?this.controllers[t]||null:this.controllers.find(e=>e.side===t)||null}get isPassThrough(){return!!(this.environmentBlendMode!=="opaque"&&this.interactionMode==="world-space"||this.mode==="immersive-ar"&&this.environmentBlendMode!=="opaque"&&this.controllers.some(t=>t.inputSource.targetRayMode==="tracked-pointer")||B()&&exports.DeviceUtilities.isDesktop()&&this.mode==="immersive-ar")}get isAR(){return this.mode==="immersive-ar"}get isVR(){return this.mode==="immersive-vr"}get isScreenBasedAR(){return this.isAR&&!this.isPassThrough}get posePosition(){return this._transformPosition}get poseOrientation(){return this._transformOrientation}get referenceSpace(){return this.context.renderer.xr.getReferenceSpace()}get viewerPose(){return this._viewerPose}get isTrackingImages(){if(this.frame&&"getImageTrackingResults"in this.frame&&typeof this.frame.getImageTrackingResults=="function")try{const t=this.frame.getImageTrackingResults();for(const e of t)if(e.trackingState==="tracked")return!0}catch{return!1}return!1}get rig(){const t=this._rigs[0]??null;return t!=null&&t.gameObject&&cr(t.gameObject)||(t==null?void 0:t.isActive)===!1?(this.updateActiveXRRig(),this._rigs[0]??null):t}get rigScale(){return this._rigs[0]?(this._lastRigScaleUpdate!==this.context.time.frame&&(this._lastRigScaleUpdate=this.context.time.frame,this._rigScale=this._rigs[0].gameObject.worldScale.x),this._rigScale):1}addRig(t){this._rigs.indexOf(t)>=0||(t.priority===void 0&&(t.priority=0),this._rigs.push(t),this.updateActiveXRRig())}removeRig(t){const e=this._rigs.indexOf(t);e!==-1&&(this._rigs.splice(e,1),this.updateActiveXRRig())}setRigActive(t){const e=this._rigs.indexOf(t),i=this._rigs[0];this._rigs.splice(e,1),this._rigs.unshift(t),t.priority=(i==null?void 0:i.priority)??0,this.updateActiveXRRig()}getUserOffsetInRig(){var i;const t=(i=this.context.mainCamera)==null?void 0:i.position;if(!t||!this.rig)return $(0,0,0);const e=$(t);return e.x*=-1,e.z*=-1,e.applyQuaternion(on(this.rig.gameObject.quaternion)),e}updateActiveXRRig(){const t=this._rigs[0]??null;this._defaultRig.gameObject.parent!==this.context.scene&&this.context.scene.add(this._defaultRig.gameObject),this._defaultRig.gameObject.visible=!0,this._rigs.includes(this._defaultRig)||this._rigs.push(this._defaultRig);let e=this._rigs[0];e&&e.priority===void 0&&(e.priority=0);for(let i=1;i<this._rigs.length;i++){const n=this._rigs[i];if(n.isActive){if(cr(n.gameObject)){this._rigs.splice(i,1),i--;continue}(!e||e.isActive===!1||n.priority!==void 0&&n.priority>e.priority)&&(e=n)}}if(t!==e){const i=this._rigs.indexOf(e);i>=0&&this._rigs.splice(i,1),this._rigs.unshift(e)}ot&&(t===e?console.log("Updated Active XR Rig:",e,"prev:",t):console.log("Updated Active XRRig:",e," (the same as before)"))}getHitTest(t){if(t)return this.getControllerHitTest(t);if(!this._viewerHitTestSource)return null;const e=this._viewerHitTestSource,i=this.frame.getHitTestResults(e);if(i.length>0){const n=i[0];return this.convertHitTestResult(n)}return null}getControllerHitTest(t){const e=t.getHitTestSource();if(!e)return null;const i=this.frame.getHitTestResultsForTransientInput(e);for(const n of i)if(n.inputSource===t.inputSource)for(const o of n.results)return this.convertHitTestResult(o);return null}convertHitTestResult(t){const e=this.context.renderer.xr.getReferenceSpace(),i=e&&t.getPose(e);if(i){const n=$(i.transform.position),o=on(i.transform.orientation),a=this.context.mainCamera;if((a==null?void 0:a.parent)!==this._cameraRenderParent&&n.applyMatrix4(ya),a!=null&&a.parent){n.applyMatrix4(a.parent.matrixWorld),o.multiply(Ii);const l=_e(a.parent);l.premultiply(Ii),o.premultiply(l)}return{hit:t,position:n,quaternion:o}}return null}convertSpace(t){const e=$(t.position);e.applyMatrix4(ya);const i=on(t.orientation);return i.premultiply(Ii),{position:e,quaternion:i}}disconnectInputSource(t){const e=(i,n,o)=>{if(i.inputSource===t){ot&&console.log("Disconnecting controller",i.index),this.controllers.splice(o,1),this.invokeControllerEvent(i,this._controllerRemoved,"removed");const a={xr:this,controller:i,change:"removed"};for(const l of this._xr_scripts)l.onXRControllerRemoved&&l.onXRControllerRemoved(a);i.onDisconnected()}};for(let i=this.controllers.length-1;i>=0;i--){const n=this.controllers[i];e(n,this.controllers,i)}for(let i=this._newControllers.length-1;i>=0;i--){const n=this._newControllers[i];e(n,this._newControllers,i)}}end(){this._ended||this.session.end().catch(t=>console.warn(t))}onRenderDebug(){if(ot)for(const t of this.controllers)t.onRenderDebug();if((ot||J_)&&this.rig&&(xf++,xf>=20)){const t=this.rig.gameObject.worldPosition,e=this.rig.gameObject.worldForward;t.add(e.multiplyScalar(1.5));const i=this.rig.gameObject.worldUp;t.add(i.multiplyScalar(2.5));let n="";if(n+=`${this.context.time.smoothedFps.toFixed(0)} FPS`,n+=`, calls: ${this.context.renderer.info.render.calls}, tris: ${this.context.renderer.info.render.triangles.toLocaleString()}`,ot||J_)for(const o of this.controllers)n+=`
${o.hand?"hand":"ctrl"} ${o.inputSource.handedness}[${o.index}] con:${o.connected} tr:${o.isTracking} hts:${o.hasHitTestSource?"yes":"no"}`;xf=0,N.DrawLabel(t,n,void 0,1/60*20)}}addScript(t){return this._xr_scripts.includes(t)?!1:(ot&&console.log("Register new XRScript",t),this._xr_scripts.push(t),typeof t.onUpdateXR=="function"&&this._xr_update_scripts.push(t),!0)}markInactive(t){if(!(this._inactive_scripts.indexOf(t)>=0)){this.removeScript(t,!1),this._inactive_scripts.push(t);for(const e of this.controllers)this.invokeCallback_ControllerRemoved(t,e);this.invokeCallback_LeaveXR(t)}}handleInactiveScripts(){if(this._inactive_scripts.length>0)for(let t=this._inactive_scripts.length-1;t>=0;t--){const e=this._inactive_scripts[t];if(e.activeAndEnabled){this._inactive_scripts.splice(t,1),this.addScript(e),this.invokeCallback_EnterXR(e);for(const i of this.controllers)this.invokeCallback_ControllerAdded(e,i)}}}removeScript(t,e=!0){ot&&console.log("Remove XRScript",t);const i=this._xr_scripts.indexOf(t);i>=0&&this._xr_scripts.splice(i,1);const n=this._xr_update_scripts.indexOf(t);if(n>=0&&this._xr_update_scripts.splice(n,1),e){const o=this._inactive_scripts.indexOf(t);o>=0&&this._inactive_scripts.splice(o,1)}}invokeCallback_EnterXR(t){t.onEnterXR&&t.onEnterXR({xr:this})}invokeCallback_ControllerAdded(t,e){t.onXRControllerAdded&&t.onXRControllerAdded({xr:this,controller:e,change:"added"})}invokeCallback_ControllerRemoved(t,e){t.onXRControllerRemoved&&t.onXRControllerRemoved({xr:this,controller:e,change:"removed"})}invokeCallback_LeaveXR(t){t.onLeaveXR&&!t.destroyed&&t.onLeaveXR({xr:this})}syncCameraCullingMask(){var i;const t=this.context.xrCamera,e=(i=this.context.mainCameraComponent)==null?void 0:i.cullingMask;if(t&&e!==void 0){for(const n of t.cameras)n.layers.mask=e;t.layers.mask=e}else if(t){for(const n of t.cameras)n.layers.enableAll();t.layers.enableAll()}}invokeControllerEvent(t,e,i){for(let n=e.length-1;n>=0;n--){const o=e[n];if(o)try{o({xr:this,controller:t,change:i})}catch(a){console.error(a)}}}applyCustomForward(){var t;if(this.context.mainCamera&&this._customforward){this._camera=this.context.mainCamera,this._camera.parent!==this._cameraRenderParent&&(this._previousCameraParent=this._camera.parent,(t=this._previousCameraParent)==null||t.add(this._cameraRenderParent)),this._cameraRenderParent.name="XR Camera Render Parent",this._cameraRenderParent.add(this._camera);let e=.02;if(this.rig){const i=Ue(this.rig.gameObject);e*=i.x}this._camera instanceof h.PerspectiveCamera&&this._camera.near>e&&(this.originalCameraNearPlane=this._camera.near,this._camera.near=e)}}revertCustomForward(){this._camera&&this._previousCameraParent&&this._previousCameraParent.add(this._camera),this._previousCameraParent=null,this._camera instanceof h.PerspectiveCamera&&this.originalCameraNearPlane!=null&&(this._camera.near=this.originalCameraNearPlane)}internalUpdateState(){const t=this.context.renderer.xr.getReferenceSpace();if(!t){this._viewerPose=void 0;return}if(this._viewerPose=this.frame.getViewerPose(t),this._viewerPose){const e=this._viewerPose.transform;this._transformPosition.set(e.position.x,e.position.y,e.position.z),this._transformOrientation.set(e.orientation.x,e.orientation.y,e.orientation.z,e.orientation.w)}}get transition(){return this._transition||(this._transition=new X_),this._transition}fadeTransition(){return this._transition||(this._transition=new X_),this._transition.fadeTransition()}updateFade(t){this._transition&&t instanceof h.PerspectiveCamera&&this._transition.update(t,this.context.time.deltaTime)}onUpdateFade_PostRender(){var t;(t=this._transition)==null||t.remove()}};let q=ss;r(q,"_sync",null),r(q,"_currentSessionRequestMode",null),r(q,"_currentSessionRequest"),r(q,"_activeSession"),r(q,"_sessionRequestStartListeners",[]),r(q,"_sessionRequestEndListeners",[]),r(q,"_xrStartListeners",[]),r(q,"_xrEndListeners",[]),r(q,"_controllerAddedListeners",[]),r(q,"_controllerRemovedListeners",[]),r(q,"onEnd",()=>{ot&&console.log("XR Session ended"),ss._activeSession=null});const Sf=x("debugwebxr");class w0{static tryFindAvatarObjects(t,e,i){if(i.head&&i.leftHand&&i.rightHand)return;const n=t.name.toLocaleLowerCase();!i.head&&n.includes("head")&&(Sf&&console.log("FOUND AVATAR HEAD",t.name),i.head=new ee("",e,t)),n.includes("hand")&&(!i.leftHand&&n.includes("left")&&(Sf&&console.log("FOUND AVATAR LEFT HAND",t.name),i.leftHand=new ee("",e,t)),!i.rightHand&&n.includes("right")&&(Sf&&console.log("FOUND AVATAR RIGHT HAND",t.name),i.rightHand=new ee("",e,t)));for(let o=0;o<t.children.length;o++){if(i.head&&i.leftHand&&i.rightHand)return;const a=t.children[o];this.tryFindAvatarObjects(a,e,i)}}}const Ot=new h.Vector3,ey=new h.Vector3,ty=new h.Quaternion,aC=x("debuggizmos"),Zi=8947848,Cf=32,Li=class{constructor(){}static isGizmo(t){return t[Wp]!==void 0}static setVisible(t){for(const e of Se.timedObjectsBuffer)e.visible=t}static DrawLabel(t,e,i=.05,n=0,o,a,l){var u;if(!Li.enabled)return null;o||(o=Zi);const c=((u=q.active)==null?void 0:u.rigScale)??1,d=Se.getTextLabel(n,e,i*c,o,a);return l instanceof h.Object3D&&l.add(d),d.position.x=t.x,d.position.y=t.y,d.position.z=t.z,d}static DrawRay(t,e,i=Zi,n=0,o=!0){if(!Li.enabled)return;const a=Se.getLine(n),l=a.geometry.getAttribute("position");l.setXYZ(0,t.x,t.y,t.z),Ot.set(e.x,e.y,e.z).multiplyScalar(999999999),l.setXYZ(1,t.x+Ot.x,t.y+Ot.y,t.z+Ot.z),l.needsUpdate=!0,a.material.color.set(i),a.material.depthTest=o,a.material.depthWrite=!1}static DrawDirection(t,e,i=Zi,n=0,o=!0,a=1){if(!Li.enabled)return;const l=Se.getLine(n),c=l.geometry.getAttribute("position");c.setXYZ(0,t.x,t.y,t.z),e.w!==void 0?(Ot.set(0,0,-a),ty.set(e.x,e.y,e.z,e.w),Ot.applyQuaternion(ty)):(Ot.set(e.x,e.y,e.z),Ot.multiplyScalar(a)),c.setXYZ(1,t.x+Ot.x,t.y+Ot.y,t.z+Ot.z),c.needsUpdate=!0,l.material.color.set(i),l.material.depthTest=o,l.material.depthWrite=!1}static DrawLine(t,e,i=Zi,n=0,o=!0){if(!Li.enabled)return;const a=Se.getLine(n),l=a.geometry.getAttribute("position");l.setXYZ(0,t.x,t.y,t.z),l.setXYZ(1,e.x,e.y,e.z),l.needsUpdate=!0,a.material.color.set(i),a.material.depthTest=o,a.material.depthWrite=!1,a.material.fog=!1}static DrawCircle(t,e,i,n=Zi,o=0,a=!0){if(!Li.enabled)return;const l=Se.getCircle(o);l.position.set(t.x,t.y,t.z),l.scale.set(i,i,i),l.quaternion.setFromUnitVectors(this._up,Ot.set(e.x,e.y,e.z).normalize()),l.material.color.set(n),l.material.depthTest=a,l.material.depthWrite=!1,l.material.fog=!1}static DrawWireSphere(t,e,i=Zi,n=0,o=!0){if(!Li.enabled)return;const a=Se.getSphere(e,n,!0);ar(a,t.x,t.y,t.z),a.material.color.set(i),a.material.depthTest=o,a.material.depthWrite=!1,a.material.fog=!1}static DrawSphere(t,e,i=Zi,n=0,o=!0){if(!Li.enabled)return;const a=Se.getSphere(e,n,!1);ar(a,t.x,t.y,t.z),a.material.color.set(i),a.material.depthTest=o,a.material.depthWrite=!1}static DrawWireBox(t,e,i=Zi,n=0,o=!0){if(!Li.enabled)return;const a=Se.getBox(n);a.position.set(t.x,t.y,t.z),a.scale.set(e.x,e.y,e.z),a.material.color.set(i),a.material.depthTest=o,a.material.wireframe=!0,a.material.depthWrite=!1,a.material.fog=!1}static DrawWireBox3(t,e=Zi,i=0,n=!0){if(!Li.enabled)return;const o=Se.getBox(i);o.position.copy(t.getCenter(Ot)),o.scale.copy(t.getSize(Ot)),o.material.color.set(e),o.material.depthTest=n,o.material.wireframe=!0,o.material.depthWrite=!1,o.material.fog=!1}static DrawArrow(t,e,i=Zi,n=0,o=!0,a=!1){if(!Li.enabled)return;const l=Se.getArrowHead(n);l.position.set(e.x,e.y,e.z),l.quaternion.setFromUnitVectors(this._up.set(0,1,0),Ot.set(e.x,e.y,e.z).sub(ey.set(t.x,t.y,t.z)).normalize());const d=Ot.set(e.x,e.y,e.z).sub(ey.set(t.x,t.y,t.z)).length()*.1;l.scale.set(d,d,d),l.material.color.set(i),l.material.depthTest=o,l.material.wireframe=a,this.DrawLine(t,e,i,n,o)}static DrawWireMesh(t){const e=Se.getMesh(t.duration??0);"mesh"in t?(e.geometry=t.mesh.geometry,e.matrix.copy(t.mesh.matrixWorld)):(e.geometry=t.geometry,e.matrix.copy(t.matrix)),e.matrixAutoUpdate=!1,e.matrixWorldAutoUpdate=!1,e.material.color.set(t.color??Zi),e.material.depthTest=t.depthTest??!0,e.material.wireframe=!0}};let N=Li;r(N,"enabled",!0),r(N,"_up",new h.Vector3(0,1,0));const lC=new h.BoxGeometry(1,1,1);function Xm(s=null){const t=new h.Color(s??14540253),e=new h.EdgesGeometry(lC);return new h.LineSegments(e,new h.LineBasicMaterial({color:t}))}const Wp=Symbol("GizmoCache");class Se{static ensureFont(){let t=ie.__webpack_exports__default.FontLibrary.getFontFamily(this.familyName);if(!t){t=ie.__webpack_exports__default.FontLibrary.addFontFamily(this.familyName);const e=t.addVariant("normal","normal","https://uploads.needle.tools/include/font-msdf.json","https://uploads.needle.tools/include/font.png");e==null||e.addEventListener("ready",()=>{ie.__webpack_exports__default.update()})}}static getTextLabel(t,e,i,n,o){this.ensureFont();let a=this.textLabelCache.pop(),l=1;o&&typeof o=="string"&&(o==null?void 0:o.length)>=8&&o.startsWith("#")?(l=parseInt(o.substring(7),16)/255,o=o.substring(0,7),aC&&console.log(o,l)):typeof o=="object"&&o.a!==void 0&&(l=o.a);const c={boxSizing:"border-box",fontFamily:this.familyName,width:"auto",fontSize:i,color:n,lineHeight:1,backgroundColor:o??void 0,backgroundOpacity:l,textContent:e,borderRadius:.5*i,padding:.8*i,whiteSpace:"pre",offset:.05*i};if(a)a.set(c);else{a=new ie.__webpack_exports__Text(c);const d=this,u=a;u.setText=function(f){this.set({textContent:f}),d.tmuiNeedsUpdate=!0}}return this.tmuiNeedsUpdate=!0,this.registerTimedObject(Q.Current,a,t,this.textLabelCache),a}static getBox(t){let e=this.boxesCache.pop();if(!e){const i=new h.BoxGeometry(1,1,1);e=new h.Mesh(i)}return this.registerTimedObject(Q.Current,e,t,this.boxesCache),e}static getLine(t){let e=this.linesCache.pop();if(!e){e=new h.Line;let i=e.geometry.getAttribute("position");i||(i=new h.BufferAttribute(new Float32Array(2*3),3),e.geometry.setAttribute("position",i))}return e.frustumCulled=!1,this.registerTimedObject(Q.Current,e,t,this.linesCache),e}static getCircle(t){let e=this.circlesCache.pop();if(!e){e=new h.Line;let i=e.geometry.getAttribute("position");if(!i){i=new h.BufferAttribute(new Float32Array(Cf*3),3),e.geometry.setAttribute("position",i);const n=$(0,1,0),o=$(0,0,1),a=$(o);a.cross(n).normalize();const l=$(a),c=Math.PI*2/(Cf-1);for(let d=0;d<Cf+1;d++){const u=c*d;n.copy(l).multiplyScalar(Math.cos(u)*1),a.copy(o).multiplyScalar(Math.sin(u)*1);const f=n.add(a);i.setXYZ(d,f.x,f.y,f.z)}}}return e.frustumCulled=!1,this.registerTimedObject(Q.Current,e,t,this.circlesCache),e}static getSphere(t,e,i){let n=this.spheresCache.pop();return n||(n=new h.Mesh(new h.SphereGeometry(1,8,8))),n.scale.set(t,t,t),n.material.wireframe=i,this.registerTimedObject(Q.Current,n,e,this.spheresCache),n}static getArrowHead(t){let e=this.arrowHeadsCache.pop();return e||(e=new h.Mesh(new h.CylinderGeometry(0,.5,1,8))),this.registerTimedObject(Q.Current,e,t,this.arrowHeadsCache),e}static getMesh(t){let e=this.mesh.pop();return e||(e=new h.Mesh,e.material=new h.MeshBasicMaterial),this.registerTimedObject(Q.Current,e,t,this.mesh),e}static registerTimedObject(t,e,i,n){if(!t){console.error("No Needle Engine context available. Did you call a Gizmos function in global scope?");return}const o=this.contextBeforeRenderCallbacks.get(t),a=this.contextPostRenderCallbacks.get(t);if(o){if(t.pre_render_callbacks[t.pre_render_callbacks.length-1]!==o){const l=t.pre_render_callbacks.indexOf(o);l>=0&&t.pre_render_callbacks.splice(l,1),t.pre_render_callbacks.push(o)}}else{const l=()=>{this.onBeforeRender(t,this.timedObjectsBuffer)};this.contextBeforeRenderCallbacks.set(t,l),t.pre_render_callbacks.push(l)}if(a){if(t.post_render_callbacks[t.post_render_callbacks.length-1]!==a){const l=t.post_render_callbacks.indexOf(a);l>=0&&t.post_render_callbacks.splice(l,1),t.post_render_callbacks.push(a)}}else{const l=()=>{this.onPostRender(t,this.timedObjectsBuffer,this.timesBuffer)};this.contextPostRenderCallbacks.set(t,l),t.post_render_callbacks.push(l)}e.traverse(l=>{l.layers.disableAll(),l.layers.enable(2)}),e.renderOrder=999999,e[Wp]=n,e.castShadow=!1,e.receiveShadow=!1,e.isGizmo=!0,this.timedObjectsBuffer.push(e),this.timesBuffer.push(Q.Current.time.realtimeSinceStartup+i),t.scene.add(e)}static onBeforeRender(t,e){this.tmuiNeedsUpdate&&(this.tmuiNeedsUpdate=!1,ie.__webpack_exports__default.update());for(let i=0;i<e.length;i++){const n=e[i];if(t.mainCamera&&n instanceof ie.__webpack_exports__default.MeshUIBaseElement){if(cr(n))continue;const o=t.isInVR,a=!1,l=!o;zc(n,t.mainCamera,a,l)}}}static onPostRender(t,e,i){const n=t.time.realtimeSinceStartup;for(let o=e.length-1;o>=0;o--){const a=e[o];n>=i[o]-1e-6&&(e.splice(o,1),i.splice(o,1),a.removeFromParent(),cr(a)!=!0&&a[Wp].push(a))}}}r(Se,"familyName","needle-gizmos"),r(Se,"linesCache",[]),r(Se,"circlesCache",[]),r(Se,"spheresCache",[]),r(Se,"boxesCache",[]),r(Se,"arrowHeadsCache",[]),r(Se,"mesh",[]),r(Se,"textLabelCache",[]),r(Se,"timedObjectsBuffer",new Array),r(Se,"timesBuffer",new Array),r(Se,"contextPostRenderCallbacks",new Map),r(Se,"contextBeforeRenderCallbacks",new Map),r(Se,"tmuiNeedsUpdate",!1);const gi=x("debugphysics"),iy=new h.Layers;class Fn{constructor(){r(this,"ray");r(this,"cam");r(this,"screenPoint");r(this,"raycaster");r(this,"results");r(this,"targets");r(this,"recursive",!0);r(this,"minDistance");r(this,"maxDistance");r(this,"lineThreshold");r(this,"layerMask");r(this,"ignore");r(this,"testObject");r(this,"useAcceleratedRaycast")}screenPointFromOffset(t,e){this.screenPoint===void 0&&(this.screenPoint=new h.Vector2),this.screenPoint.x=t/window.innerWidth*2-1,this.screenPoint.y=-(e/window.innerHeight)*2+1}setLayer(t){iy.set(t),this.layerMask=iy}setMask(t){this.layerMask||(this.layerMask=new h.Layers);const e=this.layerMask;e?e.mask=t:this.layerMask=t}}r(Fn,"AllLayers",4294967295);class Qm{constructor(t,e,i){r(this,"distance");r(this,"point");r(this,"object");this.object=t,this.distance=e,this.point=i}}const hu=class{constructor(t){r(this,"context");r(this,"engine");r(this,"raycaster",new h.Raycaster);r(this,"defaultRaycastOptions",new Fn);r(this,"targetBuffer",new Array(1));r(this,"defaultThresholds",{Mesh:{},Line:{threshold:-1},LOD:{},Points:{threshold:0},Sprite:{}});r(this,"sphereResults",new Array);r(this,"sphereMask",new h.Layers);r(this,"sphere",new h.Sphere);r(this,"tempBoundingBox",new h.Box3);this.context=t}static get raycasting(){return this._raycasting>0}raycastPhysicsFast(t,e=void 0,i=1/0,n=!0){var o;return((o=this.context.physics.engine)==null?void 0:o.raycast(t,e,{maxDistance:i,solid:n}))??null}raycastPhysicsFastAndGetNormal(t,e=void 0,i=1/0,n=!0){var o;return((o=this.context.physics.engine)==null?void 0:o.raycastAndGetNormal(t,e,{maxDistance:i,solid:n}))??null}sphereOverlapPhysics(t,e){var i;return((i=this.context.physics.engine)==null?void 0:i.sphereOverlap(t,e))??null}sphereOverlap(t,e,i=!0,n=!1,o=null){if(this.sphereResults.length=0,!this.context.scene)return this.sphereResults;const a=this.sphereMask;a.enableAll(),a.disable(2);for(const l of this.context.scene.children)this.intersectSphere(l,t,e,a,this.sphereResults,i,n,o);return this.sphereResults.sort((l,c)=>l.distance-c.distance)}raycastFromRay(t,e=null){const i=e??this.defaultRaycastOptions;i.ray=t;const n=this.raycast(i);return i===this.defaultRaycastOptions&&(i.ray=void 0),n}raycast(t=null){gi&&performance.mark("raycast.start"),t||(t=this.defaultRaycastOptions);const e=t.screenPoint??this.context.input.mousePositionRC,i=t.raycaster??this.raycaster;if(i.near=t.minDistance??0,i.far=t.maxDistance??1/0,i.params=this.defaultThresholds,t.lineThreshold===void 0&&(t.lineThreshold=-1),i.params.Line={threshold:t.lineThreshold},t.ray)i.ray.copy(t.ray);else{const l=t.cam??this.context.mainCamera;if(!l)return gi&&console.error("Can not perform raycast - no main camera found"),this.defaultRaycastOptions.results&&(this.defaultRaycastOptions.results.length=0),this.defaultRaycastOptions.results??[];const c=this.context.xrCamera;this.context.isInXR&&c instanceof h.ArrayCamera&&c.cameras.length>0?i.setFromCamera(e,c.cameras[0]):i.setFromCamera(e,l)}let n=t.targets;n||(n=this.targetBuffer,n.length=1,n[0]=this.context.scene);let o=t.results;this.defaultRaycastOptions.results&&(this.defaultRaycastOptions.results.length=0),o||(this.defaultRaycastOptions.results||(this.defaultRaycastOptions.results=new Array),o=this.defaultRaycastOptions.results),t.layerMask!==void 0?t.layerMask instanceof h.Layers?i.layers.mask=t.layerMask.mask:i.layers.mask=t.layerMask:(i.layers.enableAll(),i.layers.disable(2)),gi&&console.time("raycast"),o.length=0,hu._raycasting++,this.intersect(this.raycaster,n,o,t),o.sort((l,c)=>l.distance-c.distance);const a=t.ignore;return a!==void 0&&a.length>0&&(o=o.filter(l=>!a.includes(l.object))),hu._raycasting--,gi&&(console.timeEnd("raycast"),console.warn("#"+this.context.time.frame+", hits:",o!=null&&o.length?[...o]:"nothing"),performance.mark("raycast.end"),performance.measure("raycast","raycast.start","raycast.end")),o}intersect(t,e,i,n){var o,a,l;for(const c of e){if(!c||c.visible===!1||N.isGizmo(c)||n.lineThreshold!==void 0&&n.lineThreshold<0&&c instanceof h.Line)continue;let d=!0;const u=c,f=u.geometry;if(n.testObject){const m=(o=n.testObject)==null?void 0:o.call(n,c);if(m===!1)continue;m==="continue in children"&&(d=!1)}if(d&&(f&&ny(f)||(d=!1)),d){const m=re.getRaycastMesh(c);m&&(u.geometry=m);const g=i.length;let _=!0;if(n.precise===!1&&(_=!1),_||(_=((l=(a=f.getAttribute("position"))==null?void 0:a.array)==null?void 0:l.length)<64),u instanceof Y.GroundedSkybox&&(_=!1),!_&&hC(u,t,i)||(n.useAcceleratedRaycast!==!1?Id.runMeshBVHRaycast(t,u,i,this.context):t.intersectObject(u,!1,i)),gi&&i.length!=g){const y=i[i.length-1],b=m?8969557:7798784;N.DrawWireSphere(y.point,.1,b,1,!1),N.DrawWireMesh({mesh:c,depthTest:!1,duration:.2,color:b})}u.geometry=f}n.recursive!==!1&&this.intersect(t,c.children,i,n)}return i}intersectSphere(t,e,i,n,o,a,l,c){let d=t&&t.isMesh&&t.layers.test(n)&&!N.isGizmo(t);d&&(d=t.visible),d&&(d=!(t instanceof h.Line)),d&&(d=!(t instanceof Y.GroundedSkybox));const u=t,f=u.geometry;if(d&&c){const m=c(t);if(m===!1)return;m==="continue in children"&&(d=!1)}if(f&&ny(f)||(d=!1),d){if(l){const m=this.sphere;m.center.copy(e),m.radius=i;const g=o.length;if(Id.runMeshBVHRaycast(this.sphere,u,o,this.context),g!=o.length&&!a)return}else if(f.boundingBox||f.computeBoundingBox(),f.boundingBox){u.matrixWorldNeedsUpdate&&u.updateWorldMatrix(!1,!1);const m=this.tempBoundingBox.copy(f.boundingBox).applyMatrix4(u.matrixWorld),g=this.sphere;if(g.center.copy(e),g.radius=i,g.intersectsBox(m)){const _=Z(t),y=_.distanceTo(g.center),b=new Qm(t,y,_);if(o.push(b),!a)return}}}if(t.children)for(const m of t.children){const g=o.length;if(this.intersectSphere(m,e,i,n,o,a,l,c),g!=o.length&&!a)return}}};let va=hu;r(va,"_raycasting",0);function ny(s){return!(s.index&&s.index.array.length<3)}const To=new h.Sphere,Lh=new h.Plane,cC=new h.Matrix3;function hC(s,t,e){const i=s._computeIntersections;if(!i)return!1;let n=s["_computeIntersections:Needle"];return n||(n=s["_computeIntersections:Needle"]=function(o,a,l){const c=this,d=c.geometry.boundingSphere;if(d){if(c instanceof Y.GroundedSkybox){Lh.setFromNormalAndCoplanarPoint($(0,1,0),$(0,-c.position.y,0)),Lh.applyMatrix4(c.matrixWorld,cC);const f=o.ray.intersectPlane(Lh,$());if(f){To.copy(d),To.applyMatrix4(c.matrixWorld);const g=$(f).sub(o.ray.origin).length(),_=To.radius*.5;g<_&&a.push({distance:g,point:f,object:c,normal:Lh.normal.clone()})}return}To.copy(d),To.applyMatrix4(c.matrixWorld);const u=o.ray.intersectSphere(To,$());if(u){const f=$(u).sub(o.ray.origin),m=f.length();if(m>To.radius){const g=f.clone().normalize();a.push({distance:m,point:u,object:c,normal:g})}}}}),s._computeIntersections=n,t.intersectObject(s,!1,e),s._computeIntersections=i,!0}var Id;(s=>{function t(v,w,P,k){var M,A,I;if(!w.geometry||!w.geometry.hasAttribute("position"))return!1;const O=w.geometry;if(w!=null&&w.isSkinnedMesh){const T=w,j=T.bvhNeedsUpdate;if(!T.staticGenerator)l(),o&&(T.staticGenerator=new o(w),T.staticGenerator.applyWorldTransforms=!1,T.staticGeometry=T.staticGenerator.generate(),O.boundsTree=a==null?void 0:a.call(T.staticGeometry),T.staticGeometryLastUpdate=performance.now()+Math.random()*200,T.autoUpdateMeshBVH===void 0&&(T.autoUpdateMeshBVH=!1));else if(O.boundsTree&&(T.autoUpdateMeshBVH===!0||j===!0)){const F=performance.now(),X=F-T.staticGeometryLastUpdate;(j||X>100)&&(T.bvhNeedsUpdate=!1,T.staticGeometryLastUpdate=F,(M=T.staticGenerator)==null||M.generate(T.staticGeometry),O.boundsTree.refit())}}else if(!O.boundsTree){d||b();let T=!0;if((k.xr||O[g]===!1||(A=O.getAttribute("position"))!=null&&A.isInterleavedBufferAttribute||O.index&&((I=O.index)!=null&&I.isInterleavedBufferAttribute))&&(T=!1),T&&f){if(O[m]===void 0){let j=null;if(y.length>0){const F=y.shift();F&&!F.running&&(j=F)}if(!j&&_.length<3&&(j=new f,_.push(j)),j!=null&&!j.running){const F=w.name;gi&&console.log("<<<< worker start",F,j),O[m]="queued",performance.mark("bvh.create.start");const X=O.clone();try{j.generate(X).then(E=>{O[m]="done",O.boundsTree=E}).catch(E=>{O[m]="failed - "+(E==null?void 0:E.message),O[g]=!1,gi&&console.error("Failed to generate mesh bvh on worker",E)}).finally(()=>{gi&&console.log(">>>>> worker done",F,{hasBoundsTre:O.boundsTree!=null}),y.push(j),X.dispose(),performance.mark("bvh.create.end"),performance.measure("bvh.create (worker)","bvh.create.start","bvh.create.end")})}catch(E){console.error("Failed to generate mesh bvh on worker",E)}}else gi&&console.warn("No worker available")}}else(!u||!T)&&(l(),n&&(performance.mark("bvh.create.start"),O.boundsTree=new n(O),performance.mark("bvh.create.end"),performance.measure("bvh.create","bvh.create.start","bvh.create.end")))}if(v instanceof h.Raycaster){const T=v,j=w.raycast;O.boundsTree?(l(),i&&(w.acceleratedRaycast||(w.acceleratedRaycast=i.bind(w),gi&&console.debug(`Physics: bind acceleratedRaycast fn to "${w.name}"`)),w.raycast=w.acceleratedRaycast)):gi&&console.warn("No bounds tree found for mesh",w.name,{workerTask:O[m],hasAcceleratedRaycast:i!=null});const F=T.firstHitOnly;return T.firstHitOnly=!1,T.intersectObject(w,!1,P),T.firstHitOnly=F,w.raycast=j,!0}else if(v instanceof h.Sphere){const T=O.boundsTree;if(T){const j=v;if(c.copy(w.matrixWorld).invert(),j.applyMatrix4(c),T.intersectsSphere(j)){const X=Z(w),E=X.distanceTo(j.center),L=new Qm(w,E,X);P.push(L)}}return!0}return!1}s.runMeshBVHRaycast=t;let e=!1,i=null,n=null,o=null,a=null;function l(){e||(e=!0,Promise.resolve().then(()=>require("./vendor.light.umd.cjs")).then(v=>v.index$1).then(v=>{i=v.acceleratedRaycast,n=v.MeshBVH,o=v.StaticGeometryGenerator,a=v.computeBoundsTree}).catch(v=>{(gi||B())&&console.error("Failed to load BVH library...",v.message)}))}const c=new h.Matrix4;let d=!1,u=!1,f=null;const m=Symbol("Needle:MeshBVH-Worker"),g=Symbol("Needle:MeshBVH-CanUseWorker"),_=[],y=[];function b(){d=!0,u=!0,Promise.resolve().then(()=>e2).then(v=>{f=v.GenerateMeshBVHWorker}).catch(v=>{(gi||B())&&console.warn("Failed to setup mesh bvh worker")}).finally(()=>{u=!1})}})(Id||(Id={}));const sy=Symbol("gltf-loader-internal-usage-tracker"),dC=x("debugusers"),fc=class{constructor(t){r(this,"parser");r(this,"_getDependency");r(this,"_loadingId");r(this,"_loadedObjects",new Set);this.parser=t,this._getDependency=this.parser.getDependency,this._loadingId=Date.now().toString()}get name(){return"NEEDLE_internal_usage_tracker"}static isLoading(t){return fc._loadingProcesses>0}beforeRoot(){fc._loadingProcesses++;const t=this,e=this._getDependency;return this.parser.getDependency=function(i,n){const o=e.call(this,i,n);return o.then(a=>(a&&(t._loadedObjects.add(a),a[sy]=t._loadingId),a)),o},null}afterRoot(t){fc._loadingProcesses--,this.parser.getDependency=this._getDependency;for(const e of this._loadedObjects)delete e[sy],e instanceof h.Object3D&&(e.parent||e instanceof h.Mesh&&setTimeout(()=>{dC&&console.warn("> GLTF LOADER: Mesh not used in scene!",e),e.material=null,e.geometry=null},1e3));return null}};let ic=fc;r(ic,"_loadingProcesses",0);class x0{constructor(){window.addEventListener("unhandledrejection",t=>{var i;if(t.defaultPrevented)return;const e=(i=t==null?void 0:t.reason)==null?void 0:i.path;if(e){const n=e[0];n&&n.tagName==="IMG"&&(console.warn(`Could not load image:
`+n.src),t.preventDefault())}})}}const Pu=x("trackresources");function S0(){return Pu==="dispose"}let mr=!0;Pu===0&&(mr=!1);function uC(s){mr=s}function C0(){return mr}const P0=Symbol("disposable");function Ym(s,t){s&&(s[P0]=t,Zo&&console.warn("Set disposable",t,s))}const O0=Symbol("disposed");function fC(s){return s[O0]===!0}function xe(s){var t;if(s){if(s[P0]===!1){Zo&&console.warn("Object is marked as not disposable",s);return}if(s[O0]=!0,s instanceof h.Scene)xe(s.environment),xe(s.background),xe(s.customDepthMaterial),xe(s.customDistanceMaterial);else if(s instanceof h.SkinnedMesh)xe(s.geometry),xe(s.material),xe(s.skeleton),xe(s.bindMatrix),xe(s.bindMatrixInverse),xe(s.customDepthMaterial),xe(s.customDistanceMaterial),s.geometry=null,s.material=null,s.visible=!1;else if(s instanceof h.Mesh)xe(s.geometry),xe(s.material),xe(s.customDepthMaterial),xe(s.customDistanceMaterial),s.geometry=null,s.material=null,s.visible=!1;else if(s instanceof h.BufferGeometry){$r(s);for(const e of Object.keys(s.attributes)){const i=s.attributes[e];xe(i)}}else if(s instanceof h.BufferAttribute||s instanceof h.InterleavedBufferAttribute)Zo&&console.warn("BufferAttribute dispose not supported",s.count);else if(s instanceof Array)for(const e of s)e instanceof h.Material&&xe(e);else if(s instanceof h.Material){$r(s);for(const i of Object.keys(s)){const n=s[i];n instanceof h.Texture&&(xe(n),s[i]=null)}const e=s.uniforms;if(e)for(const i of Object.keys(e)){const n=e[i];n instanceof h.Texture?(xe(n),e[i]=null):n instanceof h.Uniform$1&&(xe(n.value),n.value=null)}}else s instanceof h.Texture?($r(s),$r(s.source),((t=s.source)==null?void 0:t.data)instanceof ImageBitmap&&$r(s.source.data)):s instanceof h.Skeleton?($r(s.boneTexture),s.boneTexture=null):s instanceof h.Bone||!(s instanceof h.Object3D)&&Zo&&console.warn("Unknown object type",s)}}function $r(s){s&&((Zo||S0()||Pu)&&console.warn("🧨 FREE",s),s instanceof ImageBitmap?s.close():s instanceof h.Source?s.data=null:s.dispose())}function M0(s){(s instanceof h.Mesh||s instanceof h.SkinnedMesh)&&(s.material=null,s.geometry=null)}const pC=new Set;function Km(s,t,e=null,i){if(i||(i=pC,i.clear()),!s)return i;const n=s[Cc];if(n)for(const o of n)i.has(o)||(e==null?void 0:e.call(null,o))!==!1&&(i.add(o),t&&Km(o,!0,e,i));return i}function mC(s){return s[Bl]}const Zo=x("debugresourceusers")||x("debugmemory"),Cc=Symbol("needle-resource-users"),Bl=Symbol("needle-resource-users-count");function It(s,t){xu(s,t,function(e,i){mr&&!va.raycasting&&(jd(Cc,this,e,!1),jd(Cc,this,i,!0))})}mr&&(It(h.Mesh.prototype,"material"),It(h.Mesh.prototype,"geometry"),It(h.Material.prototype,"map"),It(h.Material.prototype,"bumpMap"),It(h.Material.prototype,"alphaMap"),It(h.Material.prototype,"normalMap"),It(h.Material.prototype,"displacementMap"),It(h.Material.prototype,"roughnessMap"),It(h.Material.prototype,"metalnessMap"),It(h.Material.prototype,"emissiveMap"),It(h.Material.prototype,"specularMap"),It(h.Material.prototype,"envMap"),It(h.Material.prototype,"lightMap"),It(h.Material.prototype,"aoMap"),It(h.Material.prototype,"gradientMap"));function gC(s){if(mr===!1)return;const t=s[Cc];if(t)for(const e of t)jd(Cc,e,s,!1)}mr&&xu(h.Material.prototype,"dispose",function(){gC(this)});let Gp=0;function jd(s,t,e,i){if(Gp>0)return;if(Array.isArray(e)){for(const o of e)jd(s,t,o,i);return}if(!e)return;let n=e[s];if(n||(n=new Set),i){if(t&&!n.has(t)){n.add(t);let o=e[Bl]||0;o+=1,e[Bl]=o,Zo&&console.warn(`🟢 Added user of "${e.type}"`,t,e,o,"users:",n)}}else if(t&&n.has(t)){n.delete(t);let o=e[Bl]||0;o>0&&(o-=1,e[Bl]=o),Zo&&console.warn(`🔴 Removed user of "${e.type}"`,t,e,o,"users:",n),o<=0&&(ic.isLoading(e)||(Pu&&console.warn(`🔴 Removed all user of "${e.type}"`,e),S0()&&xe(e)))}e[s]=n}try{xu(h.WebGLRenderer.prototype,"render",function(){Gp++},function(){Gp--})}catch(s){console.warn("Could not wrap WebGLRenderer.render",s)}const oy=x("debugcomponentevents");class Wc{static addComponentLifecylceEventListener(t,e){this.eventListeners.has(t)&&this.eventListeners.set(t,[]);let i=this.eventListeners.get(t);i||(i=[]),i.push(e),this.eventListeners.set(t,i),oy&&console.log("Added event listener for "+t,this.eventListeners)}static removeComponentLifecylceEventListener(t,e){const i=this.eventListeners.get(t);if(!i)return;const n=i.indexOf(e);n<0||i.splice(n,1)}static dispatchComponentLifecycleEvent(t,e){const i=this.eventListeners.get(t);if(oy&&console.log("Dispatching event "+t,i),!!i)for(const n of i)n(e)}}r(Wc,"eventListeners",new Map);const Pc=Symbol("NEEDLE_NEED_UPDATE_INSTANCE"),R0=Symbol("isUsingInstancing"),k0=Symbol("instancingRenderer"),Fl=Symbol("instancingAutoUpdateBounds");class Vi{static isUsingInstancing(t){return t[R0]===!0}static getRenderer(t){return t[k0]||null}setAutoUpdateBounds(t,e){const i=Vi.getRenderer(t);i&&(i[Fl]=e)}static markDirty(t,e=!0){if(t&&(this.isUsingInstancing(t)&&(t[Pc]=!0,t.matrixWorldNeedsUpdate=!0),e))for(const i of t.children)Vi.markDirty(i,!0)}}function wa(s,t){try{t?s(t):s()}catch(e){return console.error(e),!1}return!0}const Hp=x("debugnewscripts"),_C=x("debughierarchy"),Me=[];function yC(){return Me.length>0}function Bd(s){if(Hp&&console.log("Register new components",s.new_scripts.length,[...s.new_scripts],s.alias?"element: "+s.alias:s.hash,s),s.new_scripts_pre_setup_callbacks.length>0){for(const t of s.new_scripts_pre_setup_callbacks)t&&t();s.new_scripts_pre_setup_callbacks.length=0}if(!(s.new_scripts.length<=0)){Me.length=0,s.new_scripts.length>0&&Me.push(...s.new_scripts),s.new_scripts.length=0;for(let t=0;t<Me.length;t++)try{const e=Me[t];if(e.isComponent!==!0){(B()||Hp)&&console.error(`Registered script is not a Needle Engine component. 
The script will be ignored. Please make sure your component extends "Behaviour" imported from "@needle-tools/engine"
`,e),Me.splice(t,1),t--;continue}if(e.destroyed)continue;if(!e.gameObject){console.warn(`Component can not be initialized: no GameObject assigned.
Did you add and remove a component in the same frame?`),Me.splice(t,1),t--;continue}e.context=s,nc(e.gameObject),Zm(e,s)}catch(e){console.error(e),ls(Me[t],s),Me.splice(t,1),t--}for(let t=0;t<Me.length;t++)try{const e=Me[t];if(e.destroyed){ls(Me[t],s),Me.splice(t,1),t--;continue}if(e.registering)try{e.registering()}catch(i){console.error(i)}e.__internalAwake!==void 0&&(e.gameObject||console.error("Calling awake for a component without a GameObject",e,e.gameObject),nc(e.gameObject),e.activeAndEnabled&&wa(e.__internalAwake.bind(e)))}catch(e){console.error(e),ls(Me[t],s),Me.splice(t,1),t--}for(let t=0;t<Me.length;t++)try{const e=Me[t];if(e.destroyed||e.enabled===!1||(nc(e.gameObject),e.activeAndEnabled===!1))continue;e.__internalEnable!==void 0&&(e.enabled=!0,wa(e.__internalEnable.bind(e)))}catch(e){console.error(e),ls(Me[t],s),Me.splice(t,1),t--}for(let t=0;t<Me.length;t++)try{const e=Me[t];if(e.destroyed||!e.gameObject)continue;s.new_script_start.push(e)}catch(e){console.error(e),ls(Me[t],s),Me.splice(t,1),t--}Me.length=0;for(const t of s.new_scripts_post_setup_callbacks)t&&t();s.new_scripts_post_setup_callbacks.length=0}}function bC(s){s&&(s.__internalDisable(!0),ls(s,s.context))}function E0(s,t){for(let e=0;e<s.new_script_start.length;e++)try{const i=s.new_script_start[e];if(t!==void 0&&i.gameObject!==t||i.destroyed||i.activeAndEnabled===!1)continue;wa(i.__internalAwake.bind(i)),i.enabled&&(wa(i.__internalEnable.bind(i)),wa(i.__internalStart.bind(i)),s.new_script_start.splice(e,1),e--)}catch(i){console.error(i),ls(s.new_script_start[e],s),s.new_script_start.splice(e,1),e--}}function Zm(s,t){t.scripts.indexOf(s)===-1&&(t.scripts.push(s),s.earlyUpdate&&t.scripts_earlyUpdate.push(s),s.update&&t.scripts_update.push(s),s.lateUpdate&&t.scripts_lateUpdate.push(s),s.onBeforeRender&&t.scripts_onBeforeRender.push(s),s.onAfterRender&&t.scripts_onAfterRender.push(s),s.onPausedChanged&&t.scripts_pausedChanged.push(s),Pf(s,null)&&t.new_scripts_xr.push(s),Pf(s,"immersive-vr")&&t.scripts_immersive_vr.push(s),Pf(s,"immersive-ar")&&t.scripts_immersive_ar.push(s))}function ls(s,t){Ti(s,t.new_scripts),Ti(s,t.new_script_start),Ti(s,t.scripts),Ti(s,t.scripts_earlyUpdate),Ti(s,t.scripts_update),Ti(s,t.scripts_lateUpdate),Ti(s,t.scripts_onBeforeRender),Ti(s,t.scripts_onAfterRender),Ti(s,t.scripts_pausedChanged),Ti(s,t.new_scripts_xr),Ti(s,t.scripts_immersive_vr),Ti(s,t.scripts_immersive_ar),t.stopAllCoroutinesFrom(s)}function Ti(s,t){const e=t.indexOf(s);e>=0&&t.splice(e,1)}function Pf(s,t){var e;if(s){const i=s;if(i.onBeforeXR||i.onEnterXR||i.onUpdateXR||i.onLeaveXR||i.onXRControllerAdded||i.onXRControllerRemoved)return!(t!=null&&((e=i.supportsXR)==null?void 0:e.call(i,t))===!1)}return!1}function fd(s){if(s||(s=ce.Current.scene),!s){console.trace("Invalid call - no current context.");return}const t=Ua(s);T0(s,t,!0)||(Hp||B()?console.error(`Error updating hierarchy
Do you have circular references in your project? <a target="_blank" href="https://docs.needle.tools/circular-reference"> Click here for more information.`,s):console.error('Failed to update active state in hierarchy of "'+s.name+'"',s),console.warn(" ↑ this error might be caused by circular references. Please make sure you don't have files with circular references (e.g. one GLB 1 is loading GLB 2 which is then loading GLB 1 again)."))}function T0(s,t,e,i=0){if(i>1e3)return console.warn("Hierarchy is too deep (> 1000 level) - will abort updating active state"),!1;const n=Ua(s);if(t&&(t=n,t&&s.parent)){const c=s.parent;t=c[ps],t===void 0&&(c instanceof h.Scene||(t=!0))}const a=s[ps]!==t;s[ps]=t,a&&(_C&&console.warn("ACTIVE CHANGE",s.name,n,s.visible,t,"changed?"+a,s),e&&vC(s,c=>{t?c.enabled&&(wa(c.__internalAwake.bind(c)),c.enabled&&c.__internalEnable()):c.__didAwake&&c.enabled&&(c.__didEnable=!1,c.onDisable())}));let l=!0;if(s.children)for(const c of s.children)T0(c,t,e,i+1)===!1&&(l=!1);return l}function nc(s){let t=!0,e=s,i=!1;for(;e&&e;){if(e.type==="Scene"&&(i=!0),!Ua(e)){t=!1;break}e=e.parent}if(!s){console.error("GO is null");return}s[ps]=t&&i}function vC(s,t){var e;if((e=s.userData)!=null&&e.components)for(const i of s.userData.components)t(i)}const pd=new Map,A0=Symbol("prewarmFlag"),qp=Symbol("waitingForPrewarm"),Xp=x("debugprewarm");function wC(s,t){if(!s||s[A0]===!0||s[qp]===!0)return;pd.has(t)||pd.set(t,[]),s[qp]=!0,pd.get(t).push(s),Xp&&console.debug("register prewarm",s.name)}let ry=null,ay=null;function xC(s){if(!s)return;const t=pd.get(s);if(!(t!=null&&t.length))return;const e=s.mainCamera;if(e){Xp&&console.log("prewarm",t.length,"objects",[...t]);const i=s.renderer;if(i.compile){const n=s.scene;i.compile(n,e),ry??(ry=new h.WebGLCubeRenderTarget(64)),ay??(ay=new h.CubeCamera(.001,9999999,ry)),ay.update(i,n);for(const o of t)o[A0]=!0,o[qp]=!1;t.length=0,Xp&&console.log("prewarm done")}}}ce.registerCallback(he.ContextCreated,s=>{const t=s.context;B0(t),L0(t)});const Fd=x("debugcomponents"),ly="eff8ba80-635d-11ec-90d6-0242ac120003";class vt{constructor(t){r(this,"_originalSeed");r(this,"_seed");typeof t=="string"&&(t=vt.hash(t)),this._originalSeed=t,this._seed=t}get seed(){return this._seed}set seed(t){this._seed=t}reset(){this._seed=this._originalSeed}generateUUID(t){if(typeof t=="string")return oe.v5(t,ly);const e=this._seed;return this._seed-=1,oe.v5(e.toString(),ly)}initialize(t){typeof t=="string"?this._seed=vt.hash(t):this._seed=t}static createFromString(t){return new vt(this.hash(t))}static hash(t){let e=0;for(let i=0;i<t.length;i++)e=t.charCodeAt(i)+((e<<5)-e);return e}}var D0=(s=>(s.NewInstanceCreated="new-instance-created",s.InstanceDestroyed="instance-destroyed",s))(D0||{});class SC{constructor(t){r(this,"guid");r(this,"dontSave");this.guid=t}}function Gc(s,t,e=!0,i){if(!s)return;const n=s;if(Si(s,e),!t){console.warn("Can not send destroy: No networking connection provided",s.guid);return}if(!t.isConnected){B()&&console.debug("Can not send destroy: not connected",s.guid);return}let o=s.guid;if(!o&&n.uuid&&(o=n.uuid),!o){console.warn("Can not send destroy: failed to find guid",s);return}Jm(o,t,i)}function Jm(s,t,e){const i=new SC(s);(e==null?void 0:e.saveInRoom)===!1&&(i.dontSave=!0),t.send("instance-destroyed",i,rn.Queued)}function L0(s){s.connection.beginListen("instance-destroyed",t=>{Fd&&console.log("[Remote] Destroyed",s.scene,t);const e=og(t.guid,s.scene);e&&Si(e)})}class CC{constructor(t,e,i){r(this,"filename");r(this,"hash");r(this,"size");this.filename=t,this.hash=e,this.size=i}}class I0{constructor(t,e){r(this,"guid");r(this,"originalGuid");r(this,"seed");r(this,"visible");r(this,"hostData");r(this,"dontSave");r(this,"parent");r(this,"position");r(this,"rotation");r(this,"scale");r(this,"preventCreation");r(this,"deleteStateOnDisconnect");this.originalGuid=t,this.guid=e}}function eg(s,t,e,i){var c,d;const n=s;if(!n.guid)return console.warn("Can not instantiate: No guid",n),null;if(t.context||(t.context=Q.Current),!t.context)return console.error("Missing network instantiate options / reference to network connection in sync instantiate"),null;const o=t?{...t}:null,{instance:a,seed:l}=PC(n,t);if(a){const u=a;if(u.guid){Fd&&console.log("[Local] new instance","gameobject:",a==null?void 0:a.guid);const f=new I0(n.guid,u.guid);f.seed=l,t.deleteOnDisconnect===!0&&(f.deleteStateOnDisconnect=!0),o&&(o.position&&(f.position={x:o.position.x,y:o.position.y,z:o.position.z}),o.rotation&&(f.rotation={x:o.rotation.x,y:o.rotation.y,z:o.rotation.z,w:o.rotation.w}),o.scale&&(f.scale={x:o.scale.x,y:o.scale.y,z:o.scale.z})),f.position||(f.position={x:u.position.x,y:u.position.y,z:u.position.z}),f.rotation||(f.rotation={x:u.quaternion.x,y:u.quaternion.y,z:u.quaternion.z,w:u.quaternion.w}),f.scale||(f.scale={x:u.scale.x,y:u.scale.y,z:u.scale.z}),f.visible=n.visible,o!=null&&o.parent&&(typeof o.parent=="string"?f.parent=o.parent:f.parent=o.parent.guid),f.hostData=e,i===!1&&(f.dontSave=!0),!((c=t==null?void 0:t.context)==null?void 0:c.connection)&&B()&&console.debug("Object will be instantiated but it will not be synced: not connected",n.guid),t.context.connection.isInRoom&&ta.push(new WeakRef(u)),(d=t==null?void 0:t.context)==null||d.connection.send("new-instance-created",f)}else console.warn("Missing guid, can not send new instance event",u)}return a}function j0(){return Math.random()*9999999}const ta=new Array;function B0(s){s.connection.beginListen("new-instance-created",async t=>{const e=await OC(t.originalGuid,s.scene);if(t.preventCreation===!0)return;if(!e){console.warn("could not find object that was instantiated: "+t.guid);return}const i=new pn;t.position&&(i.position=new h.Vector3(t.position.x,t.position.y,t.position.z)),t.rotation&&(i.rotation=new h.Quaternion(t.rotation.x,t.rotation.y,t.rotation.z,t.rotation.w)),t.scale&&(i.scale=new h.Vector3(t.scale.x,t.scale.y,t.scale.z)),i.parent=t.parent,t.seed&&(i.idProvider=new vt(t.seed)),i.visible=t.visible,i.context=s,Fd&&s.alias&&console.log("[Remote] instantiate in: "+s.alias);const n=dr(e,i);ta.push(new WeakRef(n)),n&&(t.parent==="scene"&&s.scene.add(n),Fd&&console.log("[Remote] new instance","gameobject:",n==null?void 0:n.guid,e))}),s.connection.beginListen("left-room",()=>{ta.length>0&&console.debug(`Left networking room, cleaning up ${ta.length} instantiated objects`);for(const t of ta){const e=t.deref();e&&e.destroy()}ta.length=0})}function PC(s,t){const e=j0(),i=t??new pn;i.idProvider=new vt(e);const n=dr(s,i);return{seed:e,instance:n}}const F0={};function U0(s,t){F0[s]=t}async function OC(s,t){const e=F0[s];if(e!=null){const i=await e(s);if(i)return i}return z0(s,t)}function z0(s,t){if(t===null||!s)return null;if(t.guid===s)return t;if(t.children)for(const e of t.children){const i=z0(s,e);if(i)return i}return null}const Hc=x("gizmos"),lt=x("debugextension"),Of=x("debugtypes");class MC{constructor(){r(this,"_types",new Map);Of&&console.warn("TypeStore: Created",this)}add(t,e){Of&&console.warn("ADD TYPE",t);const i=this._types.get(t);i?Of&&i!==e&&console.warn("Type name exists multiple times in your project and may lead to runtime errors:",t):this._types.set(t,e)}get(t){return this._types.get(t)||null}getKey(t){for(const[e,i]of this._types)if(i===t)return e;return null}}const RC=Symbol("BuiltInType"),R=new MC,kC=function(s){R.get(s.name)||R.add(s.name,s)},tg=x("debugresolvedependencies"),EC=["/extensions/","extensions/"],TC=[{prefix:"/nodes/",dependencyName:"node"},{prefix:"/meshes/",dependencyName:"mesh"},{prefix:"/materials/",dependencyName:"material"},{prefix:"/textures/",dependencyName:"texture"},{prefix:"/animations/",dependencyName:"animation"},{prefix:"nodes/",dependencyName:"node"},{prefix:"meshes/",dependencyName:"mesh"},{prefix:"materials/",dependencyName:"material"},{prefix:"textures/",dependencyName:"texture"},{prefix:"animations/",dependencyName:"animation"}];async function ig(s,t){tg&&console.log(s,t);const e=[];Qp(TC,s,t,e);const i=await Promise.all(e);return typeof t=="string"&&i.length===1?i[0]:i}function N0(s,t){return!s||!t?!1:s["needle:identifier"]!=null&&t["needle:identifier"]!=null?s["needle:identifier"]===t["needle:identifier"]:!1}function AC(s,t){s["needle:identifier"]=t}function Qp(s,t,e,i){if(typeof e=="object"&&e!==void 0&&e!==null)for(const n of Object.keys(e)){const o=e[n];if(typeof o=="string"){const a=cy(t,o);if(a!=null)typeof a.then=="function"?i.push(a.then(l=>e[n]=l)):e[n]=a;else{const l=hy(s,t,o);if(l){i.push(l.then(c=>(e[n]=c,c)));continue}}}else if(Array.isArray(o))for(let a=0;a<o.length;a++){const l=o[a],c=cy(t,l);if(c!==null){typeof c.then=="function"?i.push(c.then(d=>o[a]=d)):o[a]=c;continue}for(const d of s){const u=V0(d.prefix,l);if(u>=0){tg&&console.log(d,u,d.dependencyName),i.push(t.getDependency(d.dependencyName,u).then(f=>o[a]=f));break}}typeof l=="object"&&Qp(s,t,l,i)}else typeof o=="object"&&Qp(s,t,o,i)}else if(typeof e=="string"){const n=hy(s,t,e);n&&i.push(n)}}function cy(s,t){if(s&&s.plugins&&typeof t=="string"){for(const e of EC)if(t.startsWith(e)){let i=t.substring(e.length);const n=i.indexOf("/");n>=0&&(i=i.substring(0,n));const o=s.plugins[i];if(lt&&console.log(i,o),typeof(o==null?void 0:o.resolve)=="function"){const a=t.substring(e.length+i.length+1);return o.resolve(s,a)}break}}return null}function hy(s,t,e){for(const i of s){const n=V0(i.prefix,e);if(n>=0)return tg&&console.warn("GET DEPENDENCY",i,n,i.dependencyName),t.getDependency(i.dependencyName,n)}return null}function V0(s,t){if(typeof t=="string"&&t.startsWith(s)){const e=t.substring(s.length),i=Number.parseInt(e);if(i>=0)return i}return-1}const Mf="NEEDLE_persistent_assets";function DC(s){return(s==null?void 0:s.___persistentAsset)===!0}class LC{constructor(t){r(this,"parser");this.parser=t}get name(){return Mf}async afterRoot(t){var n,o;if(!((o=(n=this.parser)==null?void 0:n.json)!=null&&o.extensions))return;const e=this.parser.json.extensions[Mf];if(!e)return;lt&&console.log(e);const i=new Array;for(const a of e==null?void 0:e.assets){const l=ig(this.parser,a);l&&i.push(l)}await Promise.all(i)}resolve(t,e){const i=Number.parseInt(e);if(i>=0){lt&&console.log(e);const n=t.json.extensions[Mf];if(n){const o=n==null?void 0:n.assets[i];if(o&&typeof o=="object"){o.___persistentAsset=!0;const a=o.__type;a&&R.get(a)}return o}}return null}}const Mn=x("debugserializer");class IC{constructor(){r(this,"typeMap",new Map)}register(t,e){if(this.typeMap.has(t)){const i=this.typeMap.get(t);if(i===e)return;Mn&&console.warn("Type: "+t+" is already registered",e,i)}Mn&&console.log("Register type serializer",e.name,e,t),this.typeMap.set(t,e)}getSerializer(t){if(t)return this.typeMap.get(t)}getSerializerForConstructor(t,e=0){if(e>20)return;if(!t||!t.constructor){Mn&&console.log("invalid type");return}const i=t.name,n=this.getSerializer(t);if(n!==void 0)return Mn&&console.log("FOUND SERIALIZER",n==null?void 0:n.name,t.name,t.constructor.name,"for type: "+i,n,t,this.typeMap),n;const o=Object.getPrototypeOf(t);if(o&&o!==t){const a=this.getSerializerForConstructor(o,++e);if(a){const l=o.constructor||o.prototype;Mn&&console.log("FOUND SERIALIZER(in constructor) "+l.constructor.name,l.name,l,a),this.register(l,a)}return a}Mn&&console.warn("No serializer found for "+i,t,t.name,t.constructor.name)}}const Ud=new IC;class Hi{constructor(t,e){r(this,"name");if(this.name=e,Array.isArray(t))for(const i of t)Ud.register(i,this);else Ud.register(t,this)}}class jC{constructor(){r(this,"isDevMode",Ht());r(this,"cache",{})}registerDefinedKeys(t,e){if(this.isDevMode&&this.cache[t]===void 0){this.cache[t]=Object.keys(e);const i=e;i.$serializedTypes&&Object.keys(i.$serializedTypes)&&this.cache[t].push(...Object.keys(i.$serializedTypes)),Mn&&console.log("registerDefinedKeys for "+t,this.cache[t],e)}}getDefinedKey(t,e){return this.cache[t]===void 0?!1:this.cache[t].includes(e)}}class ng{constructor(t){r(this,"root");r(this,"gltf");r(this,"gltfId");r(this,"object");r(this,"target");r(this,"nodeId");r(this,"nodeToObject");r(this,"objectToNode");r(this,"context");r(this,"path");r(this,"type");r(this,"serializable");r(this,"implementationInformation");this.root=t}}function $0(s,t){const e=s.$serializedTypes;if(e===void 0)return null;const i={};for(const o in e){const a=s[o];if(a!=null&&typeof a=="object"){const l=Ud.getSerializerForConstructor(a);if(l){i[o]=l.onSerialize(a,t);continue}}i[o]=a}function n(o){const a=R._types;for(const[l,c]of a)if(c===s.constructor)return l;return o.__name||o.constructor.name}return i.name=n(s),typeof s.guid=="string"&&(i.guid=s.guid),i}const md=[];function W0(s,t){if(!s)return t;typeof s.$serializedTypes=="object"&&(t||(t={}),Object.assign(t,s.$serializedTypes));const e=Object.getPrototypeOf(s);return W0(e,t)}function zd(s,t,e){if(!s)return!1;if(e.target=s,s.onBeforeDeserialize!==void 0){const n=s.onBeforeDeserialize(t,e);if(typeof n=="boolean")return n}const i=W0(s);if(t){if(typeof t.guid=="string"&&(s.guid=t.guid),i)for(const n in i){let o=function(c){const u=c.type;return u?Yp(l,u,e,void 0,s[n]):Yp(l,c,e,void 0,s[n])};const a=i[n],l=t[n];if(Mn&&console.log(n,l,s,a),!(s[n]!==void 0&&l===void 0)&&(e.type=void 0,e.path=n,e.serializable=a,!(s.onBeforeDeserializeMember!==void 0&&s.onBeforeDeserializeMember(n,l,e)===!0))){if(a===null)s[n]=l;else{if(Array.isArray(a))for(let c=0;c<a.length;c++){const d=a[c],u=o(d);if(u!==void 0||c===a.length-1){s[n]=u;break}}else s[n]=o(a);md.length=0}s.onAfterDeserializeMember!==void 0&&s.onAfterDeserializeMember(n,l,e)}}UC(s,t)}return FC(s,t,e.implementationInformation),s.onAfterDeserialize!==void 0&&s.onAfterDeserialize(t,e),!0}const BC=x("noerrors");function FC(s,t,e){var o,a;if(BC||!t||!Ht()||!s||s.constructor&&s.constructor[RC]===!0)return;const i=(o=s.constructor)==null?void 0:o.name,n=Object.getOwnPropertyNames(t);for(const l of n){if(l==="sourceId")continue;const c=s[l];if(c==null)continue;const d=t[l];if((e==null?void 0:e.getDefinedKey(i,l))===!1){const u=l.charAt(0).toUpperCase()+l.slice(1);e.getDefinedKey(i,u)&&(Tn(bi.Warn,'<strong>Please rename</strong> "'+u+'" to "'+l+'" in '+i),console.warn('Please use lowercase for field: "'+u+'" in '+i,d,s));continue}if(d!=null){if(typeof d=="object"&&(c===void 0||!c.isObject3D)){if(typeof d.node=="number"||typeof d.guid=="string"){if(d.could_not_resolve)continue;if(!(c!==void 0&&Object.keys(c).length>1)){Tn(bi.Warn,`<strong>Missing serialization for object reference!</strong>

Please change to: 
@serializable(Object3D)
${l}? : Object3D;

in ${i}.ts
<a href="https://docs.needle.tools/serializable" target="_blank">See documentation</a>`),console.warn(i,l,s[l],s);continue}}else if(!Array.isArray(c)){const u=(a=c.constructor)==null?void 0:a.name;if(u==="Object"&&!c.constructor["did_warn:missing_serializable"]){c.constructor["did_warn:missing_serializable"]=!0;const f='You might be missing a @serializable(Type) decorator for field "'+l+'" in '+i+".ts";console.warn(f+`
${l}:`,d,u),Tn(bi.Warn,"Dev Warning: Are you missing a type in @serializable? Please check the browser console for details")}}}if(typeof c=="string"&&typeof d=="string"&&(d.endsWith(".gltf")||d.endsWith(".glb"))){Tn(bi.Warn,`<strong>Missing serialization for object reference!</strong>

Please change to: 
@serializable(AssetReference)
${l}? : AssetReference;

in script ${i}.ts
<a href="https://docs.needle.tools/serializable" target="_blank">documentation</a>`),console.warn(i,l,s[l],s);continue}}}}function UC(s,t){for(const e of Object.keys(t)){const i=t[e];if(typeof i=="object"&&i!==null&&i!==void 0){const n=s[e];if(!n){Mn&&console.log(e,"is undefined on",s);continue}for(const o of Object.keys(i))if(n[o]===void 0&&dy(i[o])&&!dy(n)){const l=zC(n,o);if(l&&((l==null?void 0:l.writable)===void 0||(l==null?void 0:l.writable)===!1)&&l.set===void 0){Mn&&console.warn('Property is not writable "'+o+'"',n,l,i[o],n[o]);continue}n[o]=i[o]}}}}function zC(s,t){for(;s;){const e=Object.getOwnPropertyDescriptor(s,t);if(e)return e;s=Object.getPrototypeOf(s)}}function dy(s){switch(typeof s){case"number":case"string":case"boolean":return!0}return!1}function Yp(s,t,e,i,n){let o=typeof t=="function"&&t.prototype===void 0,a=t;if(o)try{if(a=t==null?void 0:t.call(t,n),o=!1,a==null)return}catch(u){console.error("Error in callback",u,s)}if(e.type=a,!o&&n&&(n instanceof h.Material||n instanceof h.Texture||n instanceof h.Mesh||n instanceof h.BufferGeometry||n instanceof h.AnimationClip))return n;if(i||(i={serializer:Ud.getSerializerForConstructor(a)}),n&&typeof n=="object"&&DC(n)){if(n.__concreteInstance)return n.__concreteInstance;const u=n;if(!u.$serializedTypes&&a.prototype.$serializedTypes&&(u.$serializedTypes=a.prototype.$serializedTypes),u.$serializedTypes&&zd(u,s,e),n&&a!==void 0)try{let f=null;i.serializer&&(f=i.serializer.onDeserialize(s,e)),f||(f=new a,lt&&console.log("Create concrete instance for persistent asset",n,"instance:",f),Da(f,n)),n.__concreteInstance=f,n=f}catch(f){console.error("Error creating instance or creating values on instance",f,n,a)}return n}if(Array.isArray(s)){const u=[];for(let f=0;f<s.length;f++){const m=s[f],g=Yp(m,t,e,i,m);u.push(g)}return u}const l=i==null?void 0:i.serializer;if(l)return l.onDeserialize(s,e);let c;if(s&&(s.isMaterial||s.isTexture||s.isObject3D||s instanceof h.AnimationClip))c=s;else{if(s===void 0)return;if(s===null&&(a===h.Material||a===h.Texture||a===h.Mesh||a===h.AnimationClip))return null;try{c=new a(...NC(s))}catch(u){console.error("Error creating "+e.path,e.target,u);return}}const d=c;return d.$serializedTypes&&zd(d,s,e),c}function NC(s){if(md.length=0,typeof s=="object"&&s!==null&&s!==void 0)for(const t of Object.keys(s))md.push(s[t]);return md}const Kp=Symbol("assigned component properties");function Da(s,t,e){var n;if(t==null||s==null)return;s[Kp]=!0;const i=((n=s.constructor)==null?void 0:n.name)??"unknown";e==null||e.registerDefinedKeys(i,s);for(const o of Object.keys(t)){const a=VC(s,o);typeof(a==null?void 0:a.value)!="function"&&(!a||a.writable===!0||(a==null?void 0:a.set)!==void 0)&&(s[o]=t[o])}delete s[Kp]}function VC(s,t){let e;do e=Object.getOwnPropertyDescriptor(s,t);while(!e&&(s=Object.getPrototypeOf(s)));return e}const G0=Symbol("customVisibilityFlag");function cs(s,t){s.layers[G0]=t}const uy=Symbol("DidPatchLayers");function $C(){const s=h.Layers.prototype;if(s[uy])return;s[uy]=!0;const t=s.test;s.test=function(e){return this[G0]===!1?!1:t.call(this,e)}}$C();Object.defineProperty(h.PerspectiveCamera.prototype,"fov",{get:function(){return this._fov},set:function(s){const t=s!==this._fov;this._fov=s,t&&this.view!==void 0&&this.updateProjectionMatrix()},configurable:!0});Object.defineProperty(h.PerspectiveCamera.prototype,"near",{get:function(){return this._near},set:function(s){const t=s!==this._near;this._near=s,t&&this.view!==void 0&&this.updateProjectionMatrix()},configurable:!0});Object.defineProperty(h.PerspectiveCamera.prototype,"far",{get:function(){return this._far},set:function(s){const t=s!==this._far;this._far=s,t&&this.view!==void 0&&this.updateProjectionMatrix()},configurable:!0});const H0=new Map;function q0(s,t){if(!s)return;if(!t){console.warn("No prototype found",s,s.prototype,s.constructor);return}const e=H0.get(t);e&&e.apply(s)}function X0(s){const t=WC(s.prototype);H0.set(s,t)}function WC(s){return new GC(s)}class GC{constructor(t){r(this,"$symbol");r(this,"extensions");r(this,"descriptors");this.$symbol=Symbol("prototype-extension"),this.extensions=Object.keys(t),this.descriptors=new Array;for(let e=0;e<this.extensions.length;e++){const i=this.extensions[e],n=Object.getOwnPropertyDescriptor(t,i);n&&this.descriptors.push(n)}}apply(t){if(!t[this.$symbol]){t[this.$symbol]=!0;for(let e=0;e<this.extensions.length;e++){const i=this.extensions[e],n=this.descriptors[e];n&&Object.defineProperty(t,i,n)}}}}const HC=x("debuggetcomponent"),fy=()=>HC||globalThis.NEEDLE_DEBUG_GETCOMPONENT===!0;function qC(s){return s==null||s.isObject3D?s:s.object&&s.object.isObject3D?s.object:s}function sg(s,t){if(!s||!s.userData.components)return t;const e=s.userData.components.indexOf(t);return e<0||(Wc.dispatchComponentLifecycleEvent("removing-component",t),t.gameObject=null,s.userData.components.splice(e,1)),t}function qc(s,t,e){const i=gr(s,t);return i||wi(s,t,e)}const Q0=new vt("addComponentIdProvider");function Jo(s,t,e=!0){s.userData||(s.userData={}),s.userData.components||(s.userData.components=[]),s.userData.components.push(t),t.gameObject=s,(t.guid===void 0||t.guid==="invalid")&&(t.guid=Q0.generateUUID()),Mu(s),Eu(t,t.context);try{e&&t.__internalAwake&&(nc(s),t.activeAndEnabled&&t.__internalAwake()),Wc.dispatchComponentLifecycleEvent("component-added",t)}catch(i){console.error(i)}return t}function wi(s,t,e,i){if(typeof t=="function"){const n=new t;e&&n.__internalNewInstanceCreated(e);let o=!0;return(i==null?void 0:i.callAwake)!=null&&(o=i.callAwake),Jo(s,n,o)}if(t.destroyed)return console.warn("Can not move/add a destroyed component",t),t;if(t.gameObject===s)return t;if(t.gameObject&&t.gameObject.userData.components){const n=t.gameObject.userData.components.indexOf(t);t.gameObject.userData.components.splice(n,1)}if(!s.userData.components)s.userData.components=[];else if(s.userData.components.includes(t))return t;return s.userData.components.push(t),t.gameObject=s,(t.guid===void 0||t.guid==="invalid")&&(t.guid=Q0.generateUUID()),e&&t._internalInit(e),Eu(t,t.context),t}function Y0(s){if(s.gameObject&&s.gameObject.userData.components){const t=s.gameObject.userData.components.indexOf(s);s.gameObject.userData.components.splice(t,1)}s.__internalDisable&&s.__internalDisable(),ls(s,s.context??Q.Current),s.destroy(),s.gameObject=null}let py=!1;function K0(s,t,e){var i;if(s==null)return null;if(!s.isObject3D)return console.error("Object is not object3D"),null;if(!((i=s==null?void 0:s.userData)!=null&&i.components)||(typeof t=="string"&&(py||(py=!0,console.warn(`Accessing components by name is not supported.
Please use the component type instead. This may keep working in local development but it will fail when bundling your application.

You can import other modules your main module to get access to types
or if you use npmdefs you can make types available globally using globalThis:
https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/globalThis`,t))),fy()&&console.log("[onGetComponent] FIND",t),t==null))return null;for(let n=0;n<s.userData.components.length;n++){const o=s.userData.components[n];let a=Object.getPrototypeOf(o);for(;a;){if(a===t.prototype)if(fy()&&console.log("[onGetComponent] MATCH BY PROTOYPE",a),e)e.push(o);else return o;a=Object.getPrototypeOf(a)}}return e||null}function gr(s,t){const e=K0(s,t);return e?Array.isArray(e)?e[0]:e:null}function Xc(s,t,e,i=!0){return e||(e=[]),i&&(e.length=0),K0(s,t,e),e}function Qc(s,t,e){var n;const i=gr(s,t);if(e===!1&&(i==null?void 0:i.enabled)===!1)return null;if(i)return i;for(let o=0;o<((n=s==null?void 0:s.children)==null?void 0:n.length);o++){const a=Qc(s.children[o],t);if(a)return a}return null}function Fa(s,t,e,i=!0){var n;e||(e=[]),i&&(e.length=0),Xc(s,t,e,!1);for(let o=0;o<((n=s==null?void 0:s.children)==null?void 0:n.length);o++)Fa(s.children[o],t,e,!1);return e}function Oc(s,t){if(!s)return null;if(Array.isArray(s)){for(let i=0;i<s.length;i++){const n=qC(s[i]),o=Oc(n,t);if(o)return o}return null}const e=gr(s,t);return e||(s.parent?Oc(s.parent,t):null)}function Ou(s,t,e,i=!0){return e||(e=[]),i&&(e.length=0),s?(Xc(s,t,e,!1),s.parent?Ou(s.parent,t,e,!1):e):e}function Yc(s,t=void 0,e=!0){if(!s)return null;if(!t&&(t=Q.Current,!t))return console.error("Can not search object without any needle context or scene!!!"),null;let i=t;if(i.isScene||(i=t==null?void 0:t.scene),!i)return null;for(const n in i.children){const o=i.children[n];if(e===!1&&o[ps]===!1)continue;const a=Qc(o,s);if(a)return a}return null}function Z0(s,t,e=void 0){if(!s)return t??[];if(t||(t=[]),t.length=0,!e&&(e=Q.Current,!e))return console.error("Can not search object without any needle context or scene!!!"),t;"scene"in e&&(e=e.scene);const i=e;if(!i)return t;for(const n in i.children){const o=i.children[n];Fa(o,s,t,!1)}return t}function Mu(s){s&&s.isObject3D===!0&&q0(s,h.Object3D)}h.Object3D.prototype.SetActive=function(s){this.visible=s};h.Object3D.prototype.setActive=function(s){this.visible=s};h.Object3D.prototype.destroy=function(){Si(this)};h.Object3D.prototype.addComponent=function(s,t){return wi(this,s,t)};h.Object3D.prototype.addNewComponent=function(s,t){return wi(this,s,t)};h.Object3D.prototype.removeComponent=function(s){return sg(this,s)};h.Object3D.prototype.getOrAddComponent=function(s,t){return qc(this,s,t)};h.Object3D.prototype.getComponent=function(s){return gr(this,s)};h.Object3D.prototype.getComponents=function(s,t){return Xc(this,s,t)};h.Object3D.prototype.getComponentInChildren=function(s){return Qc(this,s)};h.Object3D.prototype.getComponentsInChildren=function(s,t){return Fa(this,s,t)};h.Object3D.prototype.getComponentInParent=function(s){return Oc(this,s)};h.Object3D.prototype.getComponentsInParent=function(s,t){return Ou(this,s,t)};Object.getOwnPropertyDescriptor(h.Object3D.prototype,"activeSelf")||Object.defineProperty(h.Object3D.prototype,"activeSelf",{get:function(){return Ua(this)},set:function(s){sc(this,s)}});Object.getOwnPropertyDescriptor(h.Object3D.prototype,"worldPosition")||Object.defineProperty(h.Object3D.prototype,"worldPosition",{get:function(){return this instanceof Y.TransformControlsGizmo?Z(this.object):Z(this)},set:function(s){it(this,s)}});Object.getOwnPropertyDescriptor(h.Object3D.prototype,"worldQuaternion")||Object.defineProperty(h.Object3D.prototype,"worldQuaternion",{get:function(){return this instanceof Y.TransformControlsGizmo?_e(this.object):_e(this)},set:function(s){Wi(this,s)}});Object.getOwnPropertyDescriptor(h.Object3D.prototype,"worldRotation")||Object.defineProperty(h.Object3D.prototype,"worldRotation",{get:function(){return Nc(this)},set:function(s){Im(this,s)}});Object.getOwnPropertyDescriptor(h.Object3D.prototype,"worldScale")||Object.defineProperty(h.Object3D.prototype,"worldScale",{get:function(){return Ue(this)},set:function(s){Ea(this,s)}});Object.getOwnPropertyDescriptor(h.Object3D.prototype,"worldForward")||Object.defineProperty(h.Object3D.prototype,"worldForward",{get:function(){return $().set(0,0,1).applyQuaternion(_e(this))}});Object.getOwnPropertyDescriptor(h.Object3D.prototype,"worldRight")||Object.defineProperty(h.Object3D.prototype,"worldRight",{get:function(){return $().set(1,0,0).applyQuaternion(_e(this))}});Object.getOwnPropertyDescriptor(h.Object3D.prototype,"worldUp")||Object.defineProperty(h.Object3D.prototype,"worldUp",{get:function(){return $().set(0,1,0).applyQuaternion(_e(this))}});X0(h.Object3D);class me extends h.Color{constructor(e,i,n,o){var t=(...args)=>{super(...args);r(this,"alpha",1)};i!=null&&n!=null?(t(e,i,n),this.alpha=o):(t(e),this.alpha=1)}get isRGBAColor(){return!0}set a(e){this.alpha=e}get a(){return this.alpha}clone(){const e=super.clone();return e.alpha=this.alpha,e}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,"alpha"in e&&typeof e.alpha=="number"?this.alpha=e.alpha:typeof e.a=="number"&&(this.alpha=e.a),this}lerp(e,i){const n=e;return n.alpha!=null&&(this.alpha=z.lerp(this.alpha,n.alpha,i)),super.lerp(e,i)}lerpColors(e,i,n){const o=e,a=i;return o.alpha!=null&&a.alpha!=null&&(this.alpha=z.lerp(o.alpha,a.alpha,n)),super.lerpColors(e,i,n)}multiply(e){const i=e;return i.alpha!=null&&(this.alpha=this.alpha*i.alpha),super.multiply(e)}fromArray(e,i=0){return this.alpha=e[i+3],super.fromArray(e,i)}}const gd=x("debuggetcomponent"),_d=x("debuginstantiate");class pn{constructor(){r(this,"idProvider");r(this,"parent");r(this,"keepWorldPosition");r(this,"position");r(this,"rotation");r(this,"scale");r(this,"visible");r(this,"context");r(this,"components")}clone(){var e,i,n;const t=new pn;return t.idProvider=this.idProvider,t.parent=this.parent,t.keepWorldPosition=this.keepWorldPosition,t.position=(e=this.position)==null?void 0:e.clone(),t.rotation=(i=this.rotation)==null?void 0:i.clone(),t.scale=(n=this.scale)==null?void 0:n.clone(),t.visible=this.visible,t.context=this.context,t.components=this.components,t}cloneAssign(t){var e,i,n;this.idProvider=t.idProvider,this.parent=t.parent,this.keepWorldPosition=t.keepWorldPosition,this.position=(e=t.position)==null?void 0:e.clone(),this.rotation=(i=t.rotation)==null?void 0:i.clone(),this.scale=(n=t.scale)==null?void 0:n.clone(),this.visible=t.visible,this.context=t.context,this.components=t.components}}function Ua(s){return s.visible}function sc(s,t){return typeof t=="number"&&(t=t>.5),s.visible=t,s.visible}function J0(s){return s[ps]||Ru(s)}function ev(s,t){s[R0]=t}function Ru(s){return Vi.isUsingInstancing(s)}function og(s,t){return ka(s,t,!0,!0)}const tv=Symbol("isDestroyed");function cr(s){return s[tv]}function iv(s,t){s[tv]=t}const Zp=Symbol("isDontDestroy");function ia(s,t=!0){s[Zp]=t}const yd=[],bd=[];function Si(s,t=!0,e=!1){yd.length=0,bd.length=0,Jp(s,t,!0);for(const i of yd)i.gameObject=null,i.context=null;for(const i of bd)iv(i,!0),e&&xe(i),M0(i);bd.length=0,yd.length=0}function Jp(s,t=!0,e=!0){var a;if(s==null)return;const i=s;if(i.isComponent){if(i[Zp])return;yd.push(i);const l=i.gameObject;i.__internalDisable(),i.__internalDestroy(),i.gameObject=l;return}if(s[Zp])return;const n=s;gd&&console.log(n),bd.push(n);const o=(a=n.userData)==null?void 0:a.components;if(o!=null&&Array.isArray(o)){let l=o.length;for(let c=0;c<o.length;c++){const d=o[c];Jp(d,t,!1),o.length<l&&(l=o.length,c--)}}if(t&&n.children)for(const l of n.children)Jp(l,t,!1);e&&n.removeFromParent()}function hr(s,t,e=!0){return nv(s,t,e)}function*ku(s,t,e=!1,i=999,n=0){if(s!=null&&s.userData.components&&!(n>i)){for(const o of s.userData.components)t&&(o==null?void 0:o.isComponent)===!0&&o instanceof t?yield o:yield o;if(e===!0)for(const o of s.children)yield*ku(o,t,!0,i,n+1)}}function nv(s,t,e,i=0){var n;if(s){if(s.isObject3D,i>1e3){console.warn("Failed to iterate components: too many levels");return}if((n=s.userData)!=null&&n.components)for(let o=0;o<s.userData.components.length;o++){const a=s.userData.components[o];if((a==null?void 0:a.isComponent)===!0){const l=t(a);if(l!==void 0)return l}}if(e&&s.children){const o=i+1;for(let a=0;a<s.children.length;a++){const l=s.children[a];if(!l)continue;const c=nv(l,t,e,o);if(c!==void 0)return c}}}}function dr(s,t){if("isAssetReference"in s)return s.instantiate(t??void 0);let e=null;t!=null&&(t.x!==void 0?(e=new pn,e.position=t):e=t);let i=Q.Current;e!=null&&e.context&&(i=e.context),gd&&i.alias&&console.log("context",i.alias),e&&!e.idProvider&&(e.idProvider=new vt(Date.now()));const n=[],o={},a={},l=sv(i,s,e,n,o,a);l&&(QC(o),XC(a,o)),gd&&(Ld(s,!0),Ld(l,!0));const c={};if((e==null?void 0:e.components)!==!1){for(const d in n){const u=n[d],f=u.guid;e&&e.idProvider&&(u.guid=e.idProvider.generateUUID(),c[f]=u.guid,gd&&console.log(u.name,u.guid)),Eu(u,i),u.__internalNewInstanceCreated&&u.__internalNewInstanceCreated()}for(const d in n){const u=n[d];u.resolveGuids&&u.resolveGuids(c),u.enabled!==!1&&(u.enabled=!0)}Bd(i)}return l}function sv(s,t,e,i,n,o){var u;if(!t)return null;const a=t.userData;t.userData={};const l=t.children;t.children=[];const c=t.clone(!1);if(Mu(c),t.userData=a,t.children=l,n[t.uuid]={original:t,clone:c},_d&&console.log("ADD",t,c),t.type==="SkinnedMesh"&&(o[t.uuid]={original:t,clone:c}),(e==null?void 0:e.visible)!==void 0&&(c.visible=e.visible),e!=null&&e.idProvider){c.uuid=e.idProvider.generateUUID();const f=c;f&&(f.guid=c.uuid)}t.animations&&t.animations.length>0&&(c.animations=[...t.animations]);const d=t.parent;if(d&&d.add(c),e!=null&&e.position?it(c,e.position):c.position.copy(t.position),e!=null&&e.rotation?Wi(c,e.rotation):c.quaternion.copy(t.quaternion),e!=null&&e.scale?c.scale.copy(e.scale):c.scale.copy(t.scale),e!=null&&e.parent&&e.parent!=="scene"){let f=null;if(typeof e.parent=="string"?f=ka(e.parent,s.scene,!0):f=e.parent,f){const m=e.keepWorldPosition===!0?f.attach:f.add;m?m.call(f,c):console.error("Invalid parent object",f,"received when instantiating:",t)}else console.warn("could not find parent:",e.parent)}for(const[f,m]of Object.entries(t.userData))f!=="components"&&(c.userData[f]=m);if((u=t.userData)!=null&&u.components){const f=t.userData.components,m=[];c.userData.components=m;for(let g=0;g<f.length;g++){const _=f[g],y=new _.constructor;Da(y,_),_[ec]!==void 0&&(y[ec]=_[ec]),m.push(y),y.gameObject=c,i.push(y),n[_.guid]={original:_,clone:y},Wc.dispatchComponentLifecycleEvent("component-added",y)}}e&&(e.position=void 0,e.rotation=void 0,e.scale=void 0,e.parent=void 0);for(const f in t.children){const m=t.children[f],g=sv(s,m,e,i,n,o);g&&c.add(g)}return c}function XC(s,t){for(const e in s){const i=s[e],n=i.original,o=n.skeleton,a=i.clone;if(!o){console.warn("Skinned mesh has no skeleton?",i);continue}const l=o.bones,c=a.skeleton.clone();a.skeleton=c,a.bindMatrix.clone().copy(n.bindMatrix),a.bindMatrixInverse.copy(n.bindMatrixInverse);const d=[];c.bones=d;for(let u=0;u<l.length;u++){const f=l[u],g=t[f.uuid].clone;d.push(g)}}for(const e in s){const i=s[e].clone;i.skeleton.update(),i.bind(i.skeleton,i.bindMatrix),i.updateMatrixWorld(!0)}}function QC(s){var t;for(const e in s){const n=s[e].clone;if(n!=null&&n.isObject3D&&((t=n==null?void 0:n.userData)!=null&&t.components))for(let o=0;o<n.userData.components.length;o++){const a=n.userData.components[o],l=Object.entries(a);for(const[c,d]of l)if(Array.isArray(d)){const u=[];a[c]=u;for(let f=0;f<d.length;f++){const m=d[f];if(typeof m!="object"){u.push(m);continue}const g=my(a,c,m,s);g!==void 0?u.push(g):u.push(m)}}else if(typeof d=="object"){const u=my(a,c,d,s);u!==void 0&&(a[c]=u)}}}}function my(s,t,e,i){var n,o;if(e!=null)if(e.isComponent===!0){const a=e.gameObject;if(a){const l=a.uuid,c=(n=i[l])==null?void 0:n.clone;if(!c){_d&&console.log("reference did not change",t,s,e);return}const d=a.userData.components.indexOf(e);if(d>=0&&c.isObject3D)return _d&&console.log(t,l),c.userData.components[d];console.warn("could not find component",t,e)}}else if(e.isObject3D===!0){if(t==="gameObject")return;const a=e;if(a){const l=a.uuid,c=(o=i[l])==null?void 0:o.clone;if(c)return _d&&console.log(t,"old",e,"new",c),c}}else{if(e.isVector4||e.isVector3||e.isVector2||e.isQuaternion||e.isEuler)return e.clone();if(e.isColor===!0)return e.clone();if(e.isEventList===!0)return e.__internalOnInstantiate(i)}}exports.BlobStorage=void 0;(s=>{s.baseUrl="https://networking.needle.tools";function i(u){return oe.md5(new Uint8Array(u))}s.hashMD5=i;function n(u){const f=oe.md5(new Uint8Array(u),{encoding:"binary",asBytes:!0});return btoa(String.fromCharCode(...f))}s.hashMD5_Base64=n;function o(u){const f=new Uint8Array(u);return crypto.subtle.digest("SHA-256",f).then(g=>btoa(String.fromCharCode(...new Uint8Array(g))))}s.hashSha256=o;function a(u){const f=u.filesize/1024/1024;return hn()?f<50:f<5}s.canUpload=a;async function l(u,f){var P;const m=s.baseUrl;if(m){if(!u.name)return console.error("Upload: file name is missing"),null}else return console.error("Blob storage base url is not set"),null;let g=null;u instanceof File?g=await u.arrayBuffer():g=u.data;const _=g.byteLength,y=_/1024/1024;if(y>50)return(f==null?void 0:f.silent)!==!0&&pe(`File (${y.toFixed(1)}MB) is too large for uploading (see console for details)`),console.warn(`Your file is too large for uploading (${y.toFixed(1)}MB). Max allowed size is 50MB`),null;if(!hn()&&y>5)return(f==null?void 0:f.silent)!==!0&&pe('File is too large for uploading. Please get a <a href="https://needle.tools/pricing" target="_blank">commercial license</a> to upload files larger than 5MB'),console.warn(`Your file is too large for uploading (${y.toFixed(1)}MB). Max size is 5MB for non-commercial users. Please get a commercial license at https://needle.tools/pricing for larger files (up to 50MB)`),null;if(_<1)return console.warn(`Your file is too small for uploading (${y.toFixed(1)}MB). Min size is 1 byte`),null;const b=n(g),v={filename:u.name,"Content-Md5":b,"Content-Type":u.type||"application/octet-stream",FileSize:_.toString(),"Content-Disposition":`attachment; filename="${u.name}"`,"x-amz-server-side-encryption":"AES256"},w=await fetch(m+"/api/needle/blob",{method:"POST",headers:v,signal:f==null?void 0:f.abort}).then(k=>k.json()).catch(k=>(console.error(k),null));if(w==null)return console.warn("Upload failed..."),null;if("error"in w)return console.error(w.error),null;if("upload"in w&&w.upload){let k=function(A){var T;return(T=f==null?void 0:f.onProgress)==null||T.call(null,{progress01:0,state:"inprogress"}),fetch(A,{method:"PUT",headers:v,body:g,signal:f==null?void 0:f.abort}).then(j=>{var F;return(F=f==null?void 0:f.onProgress)==null||F.call(null,{progress01:1,state:"finished"}),j}).catch(j=>j)};console.debug("Uploading file",w.upload);let O=!1,M=null;for(let A=0;A<3;A++)try{if(O)break;if((P=f==null?void 0:f.abort)!=null&&P.aborted)return console.debug("Aborted upload"),null;const I=await k(w.upload);I instanceof Error?(M=I,await un(1e3*A)):I.ok&&(console.debug("File uploaded successfully"),O=!0)}catch(I){console.error(I)}if(!O)return console.error((M==null?void 0:M.message)||"Failed to upload file"),null}if("download"in w){const k=m+w.download;return console.debug("File found in blob storage",k),{key:w.key,success:!0,download_url:k}}return null}s.upload=l;function c(u){return`${s.baseUrl}/api/needle/blob/${u}`}s.getBlobUrlForKey=c;async function d(u,f){var k;const m=await fetch(u),g=(k=m.body)==null?void 0:k.getReader(),_=m.headers.get("Content-Length"),y=_?parseInt(_):0;if(!g)return null;let b=0;const v=[];for(;;){const{done:O,value:M}=await g.read();if(M&&(v.push(M),b+=M.length,f==null||f.call(null,new ProgressEvent("progress",{loaded:b,total:y}))),O)break}const w=new Uint8Array(b);let P=0;for(const O of v)w.set(O,P),P+=O.length;return w}s.download=d})(exports.BlobStorage||(exports.BlobStorage={}));const Ds=x("debugaddressables");class ov{constructor(t){r(this,"_context");r(this,"_assetReferences",{});r(this,"preUpdate",()=>{});this._context=t,this._context.pre_update_callbacks.push(this.preUpdate)}dispose(){const t=this._context.pre_update_callbacks.indexOf(this.preUpdate);t>=0&&this._context.pre_update_callbacks.splice(t,1);for(const e in this._assetReferences){const i=this._assetReferences[e];i==null||i.unload()}this._assetReferences={}}findAssetReference(t){return this._assetReferences[t]||null}registerAssetReference(t){return t.url&&(this._assetReferences[t.url]?console.warn("Asset reference already registered",t):this._assetReferences[t.url]=t),t}unregisterAssetReference(t){t.url&&delete this._assetReferences[t.url]}}const Rf=Symbol("assetReference"),Vo=class{constructor(t,e,i=null){r(this,"_loading");r(this,"_asset");r(this,"_glbRoot");r(this,"_url");r(this,"_urlName");r(this,"_progressListeners",[]);r(this,"_hash");r(this,"_hashedUri");r(this,"_isLoadingRawBinary",!1);r(this,"_rawBinary");this._url=t;const n=t.lastIndexOf("/");if(n>=0){this._urlName=t.substring(n+1);const o=this._urlName.lastIndexOf(".");o>=0&&(this._urlName=this._urlName.substring(0,o))}else this._urlName=t;this._hash=e,t.includes("?v=")?this._hashedUri=t:this._hashedUri=e?t+"?v="+e:t,i!==null&&(this.asset=i),U0(this._url,this.onResolvePrefab.bind(this))}static getOrCreateFromUrl(t,e){if(!e&&(e=Q.Current,!e))throw new Error('Context is required when sourceId is a string. When you call this method from a component you can call it with "getOrCreate(this, url)" where "this" is the component.');const i=e.addressables,n=i.findAssetReference(t);if(n)return n;const o=new Vo(t,e.hash);return i.registerAssetReference(o),o}static getOrCreate(t,e,i){if(typeof t=="string"){if(!i&&(i=Q.Current,!i))throw new Error('Context is required when sourceId is a string. When you call this method from a component you can call it with "getOrCreate(this, url)" where "this" is the component.')}else i=t.context,t=t.sourceId;const n=mo(t,e);Ds&&console.log("GetOrCreate Addressable from",t,e,"FinalPath=",n);const o=i.addressables,a=o.findAssetReference(n);if(a)return a;const l=new Vo(n,i.hash);return o.registerAssetReference(l),l}get isAssetReference(){return!0}get asset(){return this._glbRoot??this._asset}set asset(t){this._asset=t}get uri(){return this._url}get url(){return this._url}get urlName(){return this._urlName}get hasUrl(){return this._url!==void 0&&(this._url.startsWith("http")||this._url.startsWith("blob:")||this._url.startsWith("www.")||this._url.includes("/"))}get rawAsset(){return this._asset}async onResolvePrefab(t){return t===this.url&&(this.mustLoad&&await this.loadAssetAsync(),this.asset)?this.asset:null}get mustLoad(){return!this.asset||this.asset.__destroyed===!0||cr(this.asset)===!0}isLoaded(){return this._rawBinary||this.asset!==void 0}unload(){this.asset&&(Ds&&console.log("Unload",this.asset),"scene"in this.asset&&this.asset.scene&&Si(this.asset.scene,!0,!0),Si(this.asset,!0,!0)),this.asset=null,this._rawBinary=void 0,this._glbRoot=null,this._loading=void 0,Q.Current&&Q.Current.addressables.unregisterAssetReference(this)}async preload(){if(!this.mustLoad||this._isLoadingRawBinary)return null;if(this._rawBinary!==void 0)return this._rawBinary;this._isLoadingRawBinary=!0,Ds&&console.log("Preload",this._hashedUri);const t=await exports.BlobStorage.download(this._hashedUri,e=>{this.raiseProgressEvent(e)});return this._rawBinary=(t==null?void 0:t.buffer)??null,this._isLoadingRawBinary=!1,this._rawBinary}async loadAssetAsync(t){if(Ds&&console.log("loadAssetAsync",this.url),!this.mustLoad)return this.asset;if(t&&this._progressListeners.push(t),this._loading!==void 0)return this._loading.then(n=>this.asset);const e=Q.Current;if(this._rawBinary){if(!(this._rawBinary instanceof ArrayBuffer))return console.error("Invalid raw binary data",this._rawBinary),null;this._loading=dn().parseSync(e,this._rawBinary,this.url,null),this.raiseProgressEvent(new ProgressEvent("progress",{loaded:this._rawBinary.byteLength,total:this._rawBinary.byteLength}))}else Ds&&console.log("Load async",this.url),this._loading=dn().loadSync(e,this._hashedUri,this.url,null,n=>{this.raiseProgressEvent(n)});const i=await this._loading;return this._progressListeners.length=0,this._glbRoot=this.tryGetActualGameObjectRoot(i),this._loading=void 0,i?(i[Rf]=this,this._glbRoot&&(this._glbRoot[Rf]=this),this.asset&&(this.asset[Rf]=this),Bd(e),i.scene!==void 0&&(this.asset=i),this.asset):null}async instantiate(t){return this.onInstantiate(t,!1)}async instantiateSynced(t,e=!0){return this.onInstantiate(t,!0,e)}beginListenDownload(t){this._progressListeners.indexOf(t)<0&&this._progressListeners.push(t)}endListenDownload(t){const e=this._progressListeners.indexOf(t);e>=0&&this._progressListeners.splice(e,1)}raiseProgressEvent(t){for(const e of this._progressListeners)e(this,t)}async onInstantiate(t,e=!1,i){const n=Q.Current,o=new pn;if(t instanceof h.Object3D?o.parent=t:t&&(Object.assign(o,t),o.cloneAssign(t)),o.parent||(o.parent=n.scene),this.mustLoad&&await this.loadAssetAsync(),Ds&&console.log("Instantiate",this.url,"parent:",t),this.asset){Ds&&console.log("Add to scene",this.asset);let a=Vo.currentlyInstantiating.get(this.url);if(a!==void 0&&a>=1e4)return console.error("Recursive or too many instantiations of "+this.url+" in the same frame ("+a+")"),null;try{if(a===void 0&&(a=0),a+=1,Vo.currentlyInstantiating.set(this.url,a),e){o.context=n;const l=this.asset;l.guid=this.url;const c=eg(l,o,void 0,i);if(c)return c}else{const l=dr(this.asset,o);if(l)return l}}finally{n.post_render_callbacks.push(()=>{a===void 0||a<0?a=0:a-=1,Vo.currentlyInstantiating.set(this.url,a)})}}else Ds&&console.warn("Failed to load asset",this.url);return null}tryGetActualGameObjectRoot(t){if(t&&t.scene){const e=t.scene;return e.isGroup&&e.children.length===1&&e.children[0].name+"glb"===e.name?e.children[0]:e}return null}};let ee=Vo;r(ee,"currentlyInstantiating",new Map);class YC extends Hi{constructor(){super([ee],"AssetReferenceSerializer")}onSerialize(t,e){if(t&&t.uri!==void 0&&typeof t.uri=="string")return t.uri}onDeserialize(t,e){if(typeof t=="string")return e.context?e.gltfId?ee.getOrCreate(e.gltfId,t,e.context):(console.error("Missing source id"),null):(console.error("Missing context"),null);if(t instanceof h.Object3D){if(!e.context)return console.error("Missing context"),null;if(!e.gltfId)return console.error("Missing source id"),null;const i=t,n=e.context,o=i.guid??i.uuid,a=n.addressables.findAssetReference(o);if(a)return a;const l=new ee(o,void 0,i);return n.addressables.registerAssetReference(l),l}return null}}new YC;const KC=Promise.resolve(null),pc=class{constructor(t){r(this,"url");r(this,"_bitmap");r(this,"_bitmapObject");r(this,"loader",null);this.url=t}static getOrCreate(t){let e=pc.imageReferences.get(t);return e||(e=new pc(t),pc.imageReferences.set(t,e)),e}dispose(){this._bitmapObject&&this._bitmapObject.close(),this._bitmap=void 0}createHTMLImage(){const t=new Image;return t.src=this.url,t}createTexture(){return this.url?(this.loader||(this.loader=new h.TextureLoader),this.loader.setCrossOrigin("anonymous"),this.loader.loadAsync(this.url).then(t=>{var e;return t&&!((e=t.name)!=null&&e.length)&&(t.name=this.url.split("/").pop()??this.url),t})):(console.error("Can not load texture without url"),KC)}getBitmap(){return this._bitmap?this._bitmap:(this._bitmap=new Promise((t,e)=>{const i=document.createElement("img");i.addEventListener("load",()=>{this._bitmap=createImageBitmap(i).then(n=>(this._bitmapObject=n,t(n),n))}),i.addEventListener("error",n=>{console.error("Failed to load image:"+this.url,n),t(null)}),i.src=this.url}),this._bitmap)}};let xa=pc;r(xa,"imageReferences",new Map);class rv extends Hi{constructor(){super([xa],"ImageReferenceSerializer")}onSerialize(t,e){return null}onDeserialize(t,e){if(typeof t=="string"){const i=mo(e.gltfId,t);return xa.getOrCreate(i)}}}new rv;const mc=class{constructor(t){r(this,"url");r(this,"res");this.url=t}static getOrCreate(t){let e=mc.cache.get(t);return e||(e=new mc(t),mc.cache.set(t,e)),e}async loadRaw(){return this.res||(this.res=fetch(this.url)),this.res.then(t=>t.blob())}async loadText(){return this.res||(this.res=fetch(this.url)),this.res.then(t=>t.text())}};let Sa=mc;r(Sa,"cache",new Map);class av extends Hi{constructor(){super([Sa],"FileReferenceSerializer")}onSerialize(t,e){return null}onDeserialize(t,e){if(typeof t=="string"){const i=mo(e.gltfId,t);return Sa.getOrCreate(i)}}}new av;class ZC{constructor(t){r(this,"context");r(this,"mixers",[]);this.context=t}onDestroy(){this.mixers.forEach(t=>t.stopAllAction()),this.mixers.length=0}registerAnimationMixer(t){if(!t){console.warn("AnimationsRegistry.registerAnimationMixer called with null or undefined mixer");return}this.mixers.includes(t)||this.mixers.push(t)}unregisterAnimationMixer(t){if(!t){console.warn("AnimationsRegistry.unregisterAnimationMixer called with null or undefined mixer");return}const e=this.mixers.indexOf(t);e!==-1&&this.mixers.splice(e,1)}}class La{static tryGetActionsFromMixer(t){const e=t._actions;return e||null}static tryGetAnimationClipsFromObjectHierarchy(t,e){if(e||(e=new Array),t)t.animations&&e.push(...t.animations);else return e;if(t.children)for(const i of t.children)this.tryGetAnimationClipsFromObjectHierarchy(i,e);return e}static assignAnimationsFromFile(t,e){if(!t||!t.animations){console.debug("No animations found in file");return}for(let n=0;n<t.animations.length;n++){const o=t.animations[n];if(!o.tracks||o.tracks.length<=0){console.warn("Animation has no tracks");continue}for(const a in o.tracks){const l=o.tracks[a],c=h.PropertyBinding.parseTrackName(l.name);let d=h.PropertyBinding.findNode(t.scene,c.nodeName);if(!d){const f=l.__objectName??l.name.substring(0,l.name.indexOf("."));if(d=t.scene.getObjectByProperty("uuid",f),!d)continue}let u=i(d);if(!u){if(!(e!=null&&e.createAnimationComponent)){console.warn("No AnimationComponent found in parent hierarchy of object and no 'createAnimationComponent' callback was provided in options.");continue}u=e.createAnimationComponent(t.scene,o)}u.addClip&&u.addClip(o)}}function i(n){var a;if(!n)return null;const o=(a=n.userData)==null?void 0:a.components;if(o&&o.length>0){for(let l=0;l<o.length;l++)if(o[l].isAnimationComponent===!0)return n}return i(n.parent)}}}var Nd=(s=>(s.Visible="application-visible",s.Hidden="application-hidden",s.MuteChanged="application-mutechanged",s))(Nd||{});let Vd=!1;const ha=[];function _r(){if(Vd)return;B()&&console.debug("User interaction registered: audio can now be played"),Vd=!0;const s=[...ha];ha.length=0,s.forEach(t=>t())}document.addEventListener("mousedown",_r);document.addEventListener("pointerup",_r);document.addEventListener("click",_r);document.addEventListener("dragstart",_r);document.addEventListener("touchend",_r);document.addEventListener("keydown",_r);q.onXRSessionStart(()=>{_r()});const __=class extends EventTarget{constructor(e){super();r(this,"_mute",!1);r(this,"context");r(this,"_isVisible",!0);this.context=e,window.addEventListener("visibilitychange",this.onVisiblityChanged.bind(this),!1)}static get userInteractionRegistered(){return Vd}static registerWaitForInteraction(e){if(e!==null){if(Vd){e();return}ha.indexOf(e)===-1&&ha.push(e)}}static unregisterWaitForInteraction(e){const i=ha.indexOf(e);i!==-1&&ha.splice(i,1)}get muted(){return this._mute}set muted(e){e!==this._mute&&(this._mute=e,this.dispatchEvent(new Event("application-mutechanged")))}get hasFocus(){return document.hasFocus()}get isVisible(){return this._isVisible}onVisiblityChanged(e){switch(e.target.visibilityState){case"hidden":this._isVisible=!1,this.dispatchEvent(new Event("application-hidden"));break;case"visible":this._isVisible=!0,this.dispatchEvent(new Event("application-visible"));break}}};let cn=__;r(cn,"registerWaitForAllowAudio",__.registerWaitForInteraction);function*rg(s,t=null){const e=t?t.time:Q.Current.time,i=e.time;for(;e.time-i<s;)yield}function*JC(s){for(let t=0;t<s;t++)yield}function*lv(s){let t=!0;for(s.then(()=>t=!1),s.catch(()=>t=!1);t;)yield}const gy="NEEDLE_lightmaps",yl=x("debuglightmapsextension")||x("debuglightmaps");var Ys=(s=>(s[s.Lightmap=0]="Lightmap",s[s.Skybox=1]="Skybox",s[s.Reflection=2]="Reflection",s))(Ys||{});class e1{constructor(t,e,i){r(this,"parser");r(this,"registry");r(this,"source");this.parser=t,this.registry=e,this.source=i}get name(){return gy}afterRoot(t){const e=this.parser.json.extensions;if(e){const i=e[gy];if(i){const n=i.textures;return n!=null&&n.length?(yl&&console.log(i),new Promise(async(o,a)=>{const l=[];for(const d of n)if(d.pointer){yl&&console.log(d);let u=null;if(d.pointer.startsWith("/textures/"))yl&&console.log("Load texture from gltf",d.pointer),u=ig(this.parser,d.pointer).then(f=>this.resolveTexture(d,f));else if(typeof d.pointer=="string"){yl&&console.log("Load texture from path",d.pointer);const f=mo(this.source,d.pointer);let m;f.endsWith(".exr")?m=new Y.EXRLoader(this.parser.options.manager):f.endsWith(".hdr")?m=new Y.RGBELoader(this.parser.options.manager):m=new h.TextureLoader(this.parser.options.manager),u=m.loadAsync(f,void 0).then(g=>this.resolveTexture(d,g))}else d.pointer;u&&l.push(u)}const c=await Rm(l);c!=null&&c.anyFailed&&B()&&console.error("Failed to load lightmap extension",c),o()})):null}}return null}resolveTexture(t,e){const i=e;yl&&console.log("Lightmap loaded:",i),i!=null&&i.isTexture&&(this.registry?(i.colorSpace=h.LinearSRGBColorSpace,this.registry.registerTexture(this.source,t.type,i,t.index)):console.log(Ys[t.type],t.pointer,i))}}const _y=!!x("debuglightmaps");class t1{constructor(t){r(this,"_context");r(this,"_lightmaps",new Map);this._context=t}clear(){this._lightmaps.clear()}registerTexture(t,e,i,n){_y&&console.log("Registering ",Ys[e]+' "'+t+'"',i),this._lightmaps.has(t)||this._lightmaps.set(t,new Map);const o=this._lightmaps.get(t),a=(o==null?void 0:o.get(e))??[];a.length<n&&(a.length=n+1),a[n]=i,o==null||o.set(e,a)}tryGetLightmap(t,e=0){return this.tryGet(t,Ys.Lightmap,e)}tryGetSkybox(t){return this.tryGet(t,Ys.Skybox,0)}tryGetReflection(t){return this.tryGet(t,Ys.Reflection,0)}tryGet(t,e,i){if(!t)return _y&&console.warn("Missing source id"),null;const n=this._lightmaps.get(t);if(!n)return null;const o=n.get(e);return o===void 0||!(o!=null&&o.length)||o.length<=i?null:o[i]}}h.ShaderChunk.lights_fragment_maps=h.ShaderChunk.lights_fragment_maps.replace("vec4 lightMapTexel = texture2D( lightMap, vLightMapUv );",`
    vec2 lUv = vLightMapUv.xy * lightmapScaleOffset.xy + vec2(lightmapScaleOffset.z, (1. - (lightmapScaleOffset.y + lightmapScaleOffset.w)));
    vec4 lightMapTexel = texture2D( lightMap, lUv);
    // The range of RGBM lightmaps goes from 0 to 34.49 (5^2.2) in linear space, and from 0 to 5 in gamma space.
    lightMapTexel.rgb *= lightMapTexel.a * 8.; // no idea where that "8" comes from... heuristically derived
    lightMapTexel.a = 1.;
    lightMapTexel = conv_sRGBToLinear(lightMapTexel);
    `);h.ShaderChunk.lightmap_pars_fragment=`
    #ifdef USE_LIGHTMAP
        uniform sampler2D lightMap;
        uniform float lightMapIntensity;
        uniform vec4 lightmapScaleOffset;
        
        // took from threejs 05fc79cd52b79e8c3e8dec1e7dca72c5c39983a4
        vec4 conv_sRGBToLinear( in vec4 value ) {
            return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );
        }
    #endif
    `;h.ShaderChunk.lights_fragment_begin=h.ShaderChunk.lights_fragment_begin.replace("irradiance += getLightProbeIrradiance( lightProbe, geometry.normal );",`
#if defined(USE_LIGHTMAP)
irradiance += 0.;
#else
irradiance += getLightProbeIrradiance( lightProbe, geometry.normal );
#endif`);h.UniformsLib.lightmap.lightmapScaleOffset={value:new h.Vector4(1,1,0,0)};const kf=x("debugprogressive"),Ih=new h.Box3,jh=new h.Sphere;class i1{constructor(t){r(this,"context");r(this,"_lodsManager");this.context=t}get manager(){return this._lodsManager}get targetTriangleDensity(){var t;return((t=this._lodsManager)==null?void 0:t.targetTriangleDensity)??-1}set targetTriangleDensity(t){this._lodsManager&&(this._lodsManager.targetTriangleDensity=t)}setRenderer(t){var e;(e=this._lodsManager)==null||e.disable(),re.LODsManager.removePlugin(this),re.LODsManager.addPlugin(this),re.LODsManager.debugDrawLine=N.DrawLine,this._lodsManager=re.LODsManager.get(t),this._lodsManager.enable()}disable(){var t;(t=this._lodsManager)==null||t.disable(),re.LODsManager.removePlugin(this)}onAfterUpdatedLOD(t,e,i,n,o){kf&&this.onRenderDebug(i,n,o)}onRenderDebug(t,e,i){var l,c,d;if(!e.geometry||!re.NEEDLE_progressive.hasLODLevelAvailable(e.geometry)&&!re.NEEDLE_progressive.hasLODLevelAvailable(e.material))return;const n=re.LODsManager.getObjectLODState(e);if(!n)return;let o=i.mesh_lod;const a=i.mesh_lod!=n.lastLodLevel_Mesh||i.texture_lod!=n.lastLodLevel_Texture;if(kf&&e.geometry.boundingSphere){const u=e.geometry.boundingSphere;jh.copy(u),jh.applyMatrix4(e.matrixWorld);const f=jh.center,m=jh.radius,g=["#76c43e","#bcc43e","#c4ac3e","#c4673e","#ff3e3e"];if(a)N.DrawWireSphere(f,m,g[o],.1);else{const _=((l=e.geometry.index)==null?void 0:l.count)??0,y=(c=re.NEEDLE_progressive.getMeshLODInformation(e.geometry))==null?void 0:c.lods;o=y?Math.min((y==null?void 0:y.length)-1,o):0;let b="";if(y&&n.lastScreenCoverage>0)for(let P=0;P<y.length;P++){const k=y[P].density,O=P==y.length-1;b+=k.toFixed(0)+">"+(k/n.lastScreenCoverage).toFixed(0)+(O?"":",")}const v=y?(d=y[o])==null?void 0:d.density:-1;let w="LOD "+i.mesh_lod+`
TEX `+i.texture_lod;if(kf=="density"&&(w+=`
`+_+` tris
`+(v/n.lastScreenCoverage).toFixed(0)+` dens
`+(n.lastScreenCoverage*100).toFixed(1)+`% cov
`+(n.lastCentrality*100).toFixed(1)+`% centr
`+(Ih.min.x.toFixed(2)+"-"+Ih.max.x.toFixed(2)+"x"+Ih.min.y.toFixed(2)+"-"+Ih.max.y.toFixed(2))+" scr"),n.lastScreenCoverage>.1){const P=t,k=P.worldForward,O=P.worldPosition,A=$(k).multiplyScalar(m*.7).add(f),I=A.distanceTo(O),T=g[Math.min(g.length-1,Math.max(0,o))]+"88",j=this.context.domHeight>0?screen.height/this.context.domHeight:1,F=t.isPerspectiveCamera?Math.tan(t.fov*Math.PI/180/2):1;N.DrawLabel(A,w,I*.012*j*F,void 0,16777215,T)}}}}}const n1=x("debugplayerview");var to=(s=>(s.Browser="browser",s.Headset="headset",s.Handheld="handheld",s))(to||{});class cv{constructor(t,e){r(this,"userId");r(this,"context");r(this,"viewDevice","browser");r(this,"removed",!1);r(this,"_object");this.userId=t,this.context=e}get currentObject(){return this._object}set currentObject(t){this._object=t}get isConnected(){return this.context.connection.userIsInRoom(this.userId)}}class hv{constructor(t){r(this,"context");r(this,"playerViews",new Map);this.context=t}setPlayerView(t,e,i){let n=this.playerViews.get(t);n||(n=new cv(t,this.context),this.playerViews.set(t,n)),n.viewDevice=i,n.currentObject=e,n.removed=!1}getPlayerView(t){if(!t)return;if(!this.context.connection.userIsInRoom(t)){this.playerViews.delete(t);return}return this.playerViews.get(t)}removePlayerView(t,e){const i=this.playerViews.get(t);(i==null?void 0:i.viewDevice)===e&&(n1&&console.log("REMOVE",t),i.removed=!0,this.playerViews.delete(t))}}new h.FileLoader;const Kc=new Uint8Array(4);Kc[0]=255;Kc[1]=255;Kc[2]=255;Kc[3]=255;const s1=new h.DataTexture(Kc,1,1,h.RGBAFormat);function ag(s,t=1){const e="alpha"in s,i=t*t,n=new Uint8Array(4*i),o=Math.floor(s.r*255),a=Math.floor(s.g*255),l=Math.floor(s.b*255);for(let d=0;d<i;d++){const u=d*4;n[u+0]=o,n[u+1]=a,n[u+2]=l,e?n[u+3]=Math.floor(s.alpha*255):n[u+3]=255}const c=new h.DataTexture(n,t,t);return c.needsUpdate=!0,c}function o1(s,t,e,i=1,n=3){const a=i*n,l=[s,t,e],c=l.length,d=new Uint8Array(4*c*a),u=new h.Color;for(let m=0;m<n;m++){const g=Math.floor(m/n*c),_=z.clamp(g+1,0,c-1),y=l[g],b=l[_],v=m/n*c%1;u.lerpColors(y,b,v);const w=Math.floor(u.r*255),P=Math.floor(u.g*255),k=Math.floor(u.b*255);for(let O=0;O<i;O++){const M=(m*i+O)*4;d[M+0]=w,d[M+1]=P,d[M+2]=k,d[M+3]=255}}const f=new h.DataTexture(d,i,n);return f.needsUpdate=!0,f}function $d(s,t){const e=s.elements;t||(t=[]),t.length=0;for(let i=0;i<16;i+=4){const n=e[i],o=e[i+1],a=e[i+2],l=e[i+3],c=new h.Vector4(n,o,a,l);t.push(c)}return t}const Ef=[],yy=[];function r1(s,t){if(Ef.length===0)for(let e=0;e<27;e++)Ef.push(0);t||(t=Ef);for(let e=0;e<27;e++)yy[e]=t[e];t=yy,s.unity_SHAr={value:new h.Vector4(t[9],t[3],t[6],t[0])},s.unity_SHBr={value:new h.Vector4(t[12],t[15],t[18],t[21])},s.unity_SHAg={value:new h.Vector4(t[10],t[4],t[7],t[1])},s.unity_SHBg={value:new h.Vector4(t[13],t[16],t[19],t[22])},s.unity_SHAb={value:new h.Vector4(t[11],t[5],t[8],t[2])},s.unity_SHBb={value:new h.Vector4(t[14],t[17],t[20],t[23])},s.unity_SHC={value:new h.Vector4(t[24],t[25],t[26],1)}}class a1{constructor(t,e,i){r(this,"vertexShader");r(this,"fragmentShader");r(this,"technique");this.vertexShader=t,this.fragmentShader=e,this.technique=i}}async function l1(s,t){if(!s)return console.error("Can not find technique: no shader data"),null;const e=s.programs[t],i=e.vertexShader,n=e.fragmentShader;if(i!==void 0&&n!==void 0){const o=s.shaders[i],a=s.shaders[n];if(o.uri&&a.uri||o.code&&a.code){if(!o.code&&o.uri&&await by(o),!a.code&&a.uri&&await by(a),!o.code||!a.code)return null;const l=s.techniques[t];return new a1(o.code,a.code,l)}}return console.error("Shader technique not found",t),null}async function by(s){const t=s.uri;if(t)if(t.endsWith(".glsl")){const i=await new h.FileLoader().loadAsync(t);s.code=i.toString()}else s.code=c1(s.uri)}function c1(s){return decodeURIComponent(Array.prototype.map.call(atob(s),function(t){return"%"+("00"+t.charCodeAt(0).toString(16)).slice(-2)}).join(""))}const Ji=x("debugenvlight");var Ca=(s=>(s[s.Skybox=0]="Skybox",s[s.Trilight=1]="Trilight",s[s.Flat=3]="Flat",s[s.Custom=4]="Custom",s))(Ca||{}),Wd=(s=>(s[s.Skybox=0]="Skybox",s[s.Custom=1]="Custom",s))(Wd||{});class dv{constructor(t){r(this,"context");r(this,"_currentLightSettingsId");r(this,"_sceneLightSettings");r(this,"_timevec4",new h.Vector4);r(this,"__currentReflectionId",null);r(this,"_lighting",{});this.context=t,this.context.pre_update_callbacks.push(this.preUpdate.bind(this))}preUpdate(){const t=this.context.time;this._timevec4.x=t.time,this._timevec4.y=Math.sin(t.time),this._timevec4.z=Math.cos(t.time),this._timevec4.w=t.deltaTime}get timeVec4(){return this._timevec4}get environmentIntensity(){if(!this._sceneLightSettings||!this._currentLightSettingsId)return 1;const t=this._sceneLightSettings.get(this._currentLightSettingsId);return t?t.ambientIntensity:1}get sceneLightSettings(){var t;return(t=this._sceneLightSettings)==null?void 0:t.values()}enable(t){var i;t instanceof ee&&(t=t.url);const e=(i=this._sceneLightSettings)==null?void 0:i.get(t);return e?(Ji&&console.log("Enable scene light settings",t,e),t!==this._currentLightSettingsId&&this._currentLightSettingsId&&this.disable(this._currentLightSettingsId),this._currentLightSettingsId=t,e.enabled=!0,!0):(Ji&&console.warn("No light settings found for",t),!1)}disable(t){var i;if(t instanceof ee&&(t=t.url),t==null)return!1;const e=(i=this._sceneLightSettings)==null?void 0:i.get(t);return e?(Ji&&console.log("Disable scene light settings",t,e),e.enabled=!1,!0):!1}disableCurrent(){if(this._currentLightSettingsId){const t=this._currentLightSettingsId;return this.disable(this._currentLightSettingsId),t}return null}internalRegisterSceneLightSettings(t){const e=t.sourceId;if(!e){console.error("Missing source id for scene light settings, can not register:",t);return}Ji&&console.log("Register "+(t==null?void 0:t.sourceId)+" lighting",t),this._sceneLightSettings||(this._sceneLightSettings=new Map),this._sceneLightSettings.set(e,t)}internalUnregisterSceneLightSettings(t){const e=t.sourceId;if(!e){console.error("Missing source id for scene light settings, can not unregister:",t);return}Ji&&console.log("Unregister "+(t==null?void 0:t.sourceId)+" lighting",t),this._sceneLightSettings&&this._sceneLightSettings.delete(e)}internalRegisterReflection(t,e){Ji&&console.log("Register reflection",t,e);const i=new uv(this.context,e,1);this._lighting[t]=i}internalGetReflection(t){return this._lighting[t]}internalEnableReflection(t){var i;this.__currentReflectionId=t;const e=(i=this._sceneLightSettings)==null?void 0:i.get(t);switch(Ji&&console.log("Enable reflection",t,e?Ca[e.ambientMode]:"Unknown ambient mode",e),e==null?void 0:e.ambientMode){case 0:case 4:const n=this.internalGetReflection(t);if(n&&n.Source){Ji&&console.log("Setting environment reflection",n);const o=this.context.scene,a=n.Source;a.mapping=h.EquirectangularReflectionMapping,o.environment=a;return}else Ji&&console.warn("Could not find reflection for source",t);break}if((e==null?void 0:e.environmentReflectionSource)===1)switch(e==null?void 0:e.ambientMode){case 1:if(e.ambientTrilight){const n=e.ambientTrilight,o=o1(n[0],n[1],n[2],64,64);o.colorSpace=h.SRGBColorSpace,o.mapping=h.EquirectangularReflectionMapping,this.context.scene.environment=o}else console.error("Missing ambient trilight",e.sourceId);return;case 3:if(e.ambientLight){const n=ag(e.ambientLight,64);n.colorSpace=h.SRGBColorSpace,n.mapping=h.EquirectangularReflectionMapping,this.context.scene.environment=n}else console.error("Missing ambientlight",e.sourceId);return;default:return}}internalDisableReflection(t){if(t&&t!==this.__currentReflectionId){Ji&&console.log("Not disabling reflection for",t,"because it is not the current light settings id",this.__currentReflectionId);return}Ji&&console.log("Disable reflection",t);const e=this.context.scene;e.environment=null}}class uv{constructor(t,e,i=1){r(this,"_source");this._source=e,e.mapping=h.EquirectangularReflectionMapping}get Source(){return this._source}}const vy=x("timescale");let em=1;typeof vy=="number"&&(em=vy);class fv{constructor(){r(this,"_time",0);r(this,"_deltaTime",0);r(this,"_deltaTimeUnscaled",0);r(this,"timeScale",1);r(this,"_frame",0);r(this,"clock",new h.Clock);r(this,"_smoothedFps",0);r(this,"_smoothedDeltaTime",0);r(this,"_fpsSamples",[]);r(this,"_fpsSampleIndex",0);typeof em=="number"&&(this.timeScale=em)}get time(){return this._time}set time(t){this._time=t}get deltaTime(){return this._deltaTime}set deltaTime(t){this._deltaTime=t}get deltaTimeUnscaled(){return this._deltaTimeUnscaled}get frame(){return this._frame}set frame(t){this._frame=t}get frameCount(){return this.frame}get realtimeSinceStartup(){return this.clock.elapsedTime}get fps(){return 1/this.deltaTime}get smoothedFps(){return this._smoothedFps}get smoothedDeltaTime(){return 1/this._smoothedFps}update(){this.deltaTime=this.clock.getDelta(),this.deltaTime=Math.min(.1,this.deltaTime),this._deltaTimeUnscaled=this.deltaTime,this.deltaTime<=0&&(this.deltaTime=1e-12),this.deltaTime*=this.timeScale,this.frame+=1,this.time+=this.deltaTime,this._fpsSamples.length<60?this._fpsSamples.push(this.deltaTime):this._fpsSamples[this._fpsSampleIndex++%60]=this.deltaTime;let t=0;for(let e=0;e<this._fpsSamples.length;e++)t+=this._fpsSamples[e];this._smoothedDeltaTime=t/this._fpsSamples.length,this._smoothedFps=1/this._smoothedDeltaTime}}let wy=!1;function pv(s){wy||(wy=!0,h1(),d1())}pv();function h1(){const s=`
float startCompression = 0.8;
float desaturation = 0.5;
// Patched tonemapping function
vec3 NeutralToneMapping( vec3 color ) {
    color *= toneMappingExposure;
    
    float d = 1. - startCompression;
    // float peak = dot(color, vec3(0.299, 0.587, 0.114));
    float peak = max(color.r, max(color.g, color.b));
    if (peak < startCompression) return color;
    float newPeak = 1. - d * d / (peak + d - startCompression);
    float invPeak = 1. / peak;
    
    float extraBrightness = dot(color * (1. - startCompression * invPeak), vec3(1, 1, 1));
    
    color *= newPeak * invPeak;
    float g = 1. - 3. / (desaturation * extraBrightness + 3.);
    return mix(color, vec3(1, 1, 1), g);
}
`,t="vec3 NeutralToneMapping( vec3 color ) {",e=`return mix( color, vec3( newPeak ), g );
}`,i=h.ShaderChunk.tonemapping_pars_fragment.indexOf(t),n=h.ShaderChunk.tonemapping_pars_fragment.indexOf(e,i);if(i>=0&&n>=0){const o=h.ShaderChunk.tonemapping_pars_fragment.substring(i,n+e.length);h.ShaderChunk.tonemapping_pars_fragment=h.ShaderChunk.tonemapping_pars_fragment.replace(o,s)}else B()&&console.error("Couldn't find NeutralToneMapping in ShaderChunk.tonemapping_pars_fragment")}function d1(){const s=`
// 0: Default, 1: Golden, 2: Punchy
#define AGX_LOOK 0        

vec3 userSlope = vec3(1.0);
vec3 userOffset = vec3(0.0);
vec3 userPower = vec3(1.0);
float userSaturation = 1.0;

// Mean error^2: 3.6705141e-06
vec3 _agxDefaultContrastApprox(vec3 x) {
    vec3 x2 = x * x;
    vec3 x4 = x2 * x2;
    
    return  + 15.5     * x4 * x2
            - 40.14    * x4 * x
            + 31.96    * x4
            - 6.868    * x2 * x
            + 0.4298   * x2
            + 0.1191   * x
            - 0.00232;
}

vec3 _agx(vec3 val) {
    const mat3 agx_mat = mat3(
        0.842479062253094, 0.0423282422610123, 0.0423756549057051,
        0.0784335999999992,  0.878468636469772,  0.0784336,
        0.0792237451477643, 0.0791661274605434, 0.879142973793104);
    
    const float min_ev = -12.47393;
    const float max_ev = 4.026069;

    // val = pow(val, vec3(2.2)); 

    // Input transform (inset)
    val = agx_mat * val;
    
    // Log2 space encoding
    val = clamp(log2(val), min_ev, max_ev);
    val = (val - min_ev) / (max_ev - min_ev);
    
    // Apply sigmoid function approximation
    val = _agxDefaultContrastApprox(val);

    return val;
}

vec3 _agxEotf(vec3 val) {
    const mat3 agx_mat_inv = mat3(
        1.19687900512017, -0.0528968517574562, -0.0529716355144438,
        -0.0980208811401368, 1.15190312990417, -0.0980434501171241,
        -0.0990297440797205, -0.0989611768448433, 1.15107367264116);
        
    // Inverse input transform (outset)
    val = agx_mat_inv * val;
    
    // sRGB IEC 61966-2-1 2.2 Exponent Reference EOTF Display
    // NOTE: We're linearizing the output here. Comment/adjust when
    // *not* using a sRGB render target
    val = pow(val, vec3(2.2)); 

    return val;
}

vec3 _agxLook(vec3 val) {
    const vec3 lw = vec3(0.2126, 0.7152, 0.0722);
    float luma = dot(val, lw);
    
    // Default
    vec3 offset = vec3(0.0);
    vec3 slope = vec3(1.0);
    vec3 power = vec3(1.0);
    float sat = 1.0;
    
    #if AGX_LOOK == 1
    // Golden
    slope = vec3(1.0, 0.9, 0.5);
    power = vec3(0.8);
    sat = 0.8;
    #elif AGX_LOOK == 2
    // Punchy
    slope = vec3(1.0);
    power = vec3(1.35, 1.35, 1.35);
    sat = 1.4;
    #endif        
    
    // Needle
    slope = vec3(1.05);
    power = vec3(1.10, 1.10, 1.10);
    sat = 1.15;

    // User
    // slope = userSlope;
    // offset = userOffset;
    // power = userPower;
    // sat = userSaturation;
    
    // ASC CDL
    val = pow(val * slope + offset, power);
    return luma + sat * (val - luma);
}


vec3 AgXToneMapping( vec3 color ) {
    // apply AGX
    color *= toneMappingExposure;
    color = _agx(color);
    color = _agxLook(color); // Optional
    color = _agxEotf(color);
    return color;
`,t="vec3 AgXToneMapping( vec3 color ) {",e="return color;",i=h.ShaderChunk.tonemapping_pars_fragment.indexOf(t),n=h.ShaderChunk.tonemapping_pars_fragment.indexOf(e,i);if(i>=0&&n>=0){const o=h.ShaderChunk.tonemapping_pars_fragment.substring(i,n+e.length);h.ShaderChunk.tonemapping_pars_fragment=h.ShaderChunk.tonemapping_pars_fragment.replace(o,s)}else B()&&console.error("Couldn't find AgXToneMapping in ShaderChunk.tonemapping_pars_fragment")}function yt(s){const t=document.createElement("span");return t.style.maxWidth="48px",t.style.maxHeight="48px",t.style.overflow="hidden",t.classList.add("material-symbols-outlined","notranslate"),t.setAttribute("translate","no"),t.innerText=s,t}function mv(s){var e;return((e=s.classList)==null?void 0:e.contains("material-symbols-outlined"))||!1}const Bh=new Map;async function tm(s){const t="Material Symbols Outlined";if(document.fonts.check(`1em '${t}'`)||(console.log("Font not loaded yet"),await document.fonts.ready),Bh.has(s))return Bh.get(s);const e=document.createElement("canvas"),i=48;e.width=i,e.height=i;const n=e.getContext("2d");if(n){n.font=`${i}px '${t}'`,n.fillStyle="black",n.fillText(s,0,i);const o=e.toDataURL(),a=new h.Texture;return a.name=s+" icon",a.image=new Image,a.image.src=o,a.needsUpdate=!0,Bh.set(s,a),a}return Bh.set(s,null),null}const du=class{constructor(){r(this,"_fullscreenButton");r(this,"_muteButton");r(this,"_qrButton")}static getOrCreate(){return this._instance||(this._instance=new du),this._instance}static create(){return new du}get fullscreenButton(){return this._fullscreenButton}createFullscreenButton(t){if(this._fullscreenButton)return this._fullscreenButton;if(!document.fullscreenEnabled)return B()&&console.warn("NeedleMenu: Fullscreen button could not be created, device doesn't support the Fullscreen API"),null;const e=document.createElement("button");this._fullscreenButton=e,e.classList.add("fullscreen-button"),e.title="Click to enter fullscreen mode";const i=yt("fullscreen"),n=yt("fullscreen_exit");return e.appendChild(i),e.onclick=()=>{document.fullscreenElement?document.exitFullscreen():"webkitRequestFullscreen"in t.domElement&&typeof t.domElement.webkitRequestFullscreen=="function"?t.domElement.webkitRequestFullscreen():"requestFullscreen"in t.domElement&&t.domElement.requestFullscreen()},document.addEventListener("fullscreenchange",()=>{document.fullscreenElement?(i.remove(),e.appendChild(n),e.title="Click to enter fullscreen mode"):(n.remove(),e.appendChild(i),e.title="Click to exit fullscreen mode")}),globalThis.addEventListener("needle-xrsession-start",()=>{e.style.display="none"}),globalThis.addEventListener("needle-xrsession-end",()=>{e.style.display=""}),e}get muteButton(){return this._muteButton}createMuteButton(t){if(this._muteButton)return this._muteButton;const e=document.createElement("button");this._muteButton=e,e.classList.add("mute-button"),e.title="Click to mute/unmute";const i=yt("volume_off"),n=yt("volume_up");return t.application.muted?e.appendChild(i):e.appendChild(n),e.onclick=()=>{t.application.muted?(i.remove(),e.appendChild(n),t.application.muted=!1):(n.remove(),e.appendChild(i),t.application.muted=!0)},e}get qrButton(){return this._qrButton}createQRCode(){if(this._qrButton)return this._qrButton;const t=document.createElement("button");this._qrButton=t,t.innerText="QR Code",t.prepend(yt("qr_code")),t.title="Scan this QR code with your phone to open this page",this.hideElementDuringXRSession(t);const e=document.createElement("div");e.style.cssText=`
            position: fixed;
            display: inline-block;
            padding: 1rem;
            background-color: white;
            border-radius: 0.4rem;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 0 12px rgba(0, 0, 0, 0.2);
        `;const i=document.createElement("div");i.classList.add("qr-code-container"),e.appendChild(i),t.addEventListener("click",()=>{if(e.parentNode)return o();window.location.href.includes("://localhost")&&pe("To access your website from another device in the same local network you have to use the IP address instead of localhost."),n()});async function n(){await a(),document.body.appendChild(e);const l=i.getBoundingClientRect(),c=t.getBoundingClientRect();e.style.left=c.left+c.width*.5-l.width*.5+"px",c.top<l.height?e.style.top=`calc(${c.bottom}px + ${e.style.padding} * .6)`:e.style.top=`calc(${c.top-l.height}px - ${e.style.padding} * 2.5)`,e.style.opacity="0",e.style.pointerEvents="all",e.style.transition="opacity 0.2s ease-in-out",setTimeout(()=>{e.style.opacity="1",window.addEventListener("click",o,{once:!0})}),window.addEventListener("resize",o),window.addEventListener("scroll",o),document.fullscreenElement?document.fullscreenElement.appendChild(e):document.body.appendChild(e)}function o(){e.style.pointerEvents="none",e.style.transition="opacity 0.2s",e.style.opacity="0",setTimeout(()=>{var l;return(l=e.parentNode)==null?void 0:l.removeChild(e)},500),window.removeEventListener("click",o),window.removeEventListener("resize",o),window.removeEventListener("scroll",o)}async function a(){const c=await Bb({text:window.location.href,width:200,height:200});i.innerHTML="",i.appendChild(c)}return t.addEventListener("pointerenter",()=>{a()},{once:!0}),t}hideElementDuringXRSession(t){Su(e=>{t["previous-display"]=t.style.display,t.style.display="none"}),Nm(e=>{t["previous-display"]!=null&&(t.style.display=t["previous-display"])})}};let an=du;r(an,"_instance");function Gd(s,t){const e=(t==null?void 0:t.element)||document.head,i=Array.from(e.querySelectorAll(`link[rel=stylesheet][href*='${s}']`));if(i.length<=0){const n=document.createElement("link");n.href=s,n.rel="stylesheet",e.appendChild(n),i.push(n)}if(t!=null&&t.loadedCallback)for(let n=0;n<i.length;n++)t!=null&&t.loadedCallback&&i[n].addEventListener("load",t.loadedCallback)}function gv(){Gd("https://fonts.googleapis.com/css2?family=Roboto+Flex:opsz,wght@8..144,100..1000&display=swap")}const im="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&display=block",Hd="needle-logo-element";class _v extends HTMLElement{constructor(){super();r(this,"_root");r(this,"wrapper");r(this,"logoElement",document.createElement("img"));r(this,"textElement",document.createElement("span"));this._root=this.attachShadow({mode:"closed"});const e=document.createElement("template");e.innerHTML=`<style>
        :host {
            position: relative;
            min-width: fit-content;
            /* height: 100%; can not have height 100% because of align-items: stretch; in the parent */
            display: flex;
        }

        .wrapper {
            position: relative;
            display: grid;
            grid-template-columns: auto auto;
            padding: .1rem;
        }
        .wrapper:hover {
            cursor: pointer;
        }
        img {
            width: 95px;
            height: 100%;
            align-self: end;
            margin-left: 0.6rem;
        }
        span {
            font-size: 1rem;
            white-space: nowrap;
        }
        </style>
        <div class="wrapper">
            <img class="logo" src=${DS} />
        </div>
        `,this._root.appendChild(e.content.cloneNode(!0)),this.wrapper=this._root.querySelector(".wrapper"),this._root.appendChild(this.wrapper),this.addEventListener("click",()=>{globalThis.open("https://needle.tools","_blank")}),this.wrapper.setAttribute("title","Made with Needle Engine")}static get elementName(){return Hd}static create(){return document.createElement(Hd)}setLogoVisible(e){this.logoElement.style.display=e?"block":"none"}}customElements.get(Hd)||customElements.define(Hd,_v);const Tf=x("debugspatialmenu");class u1{constructor(t,e){r(this,"_context");r(this,"needleMenu");r(this,"htmlButtonsMap",new Map);r(this,"enabled",!0);r(this,"userRequestedMenu",!1);r(this,"uiisDirty",!1);r(this,"_showNeedleLogo");r(this,"_wasInXR",!1);r(this,"preRender",()=>{var e;if(!this.enabled){(e=this.menu)==null||e.removeFromParent();return}Tf&&exports.DeviceUtilities.isDesktop()&&this.updateMenu();const t=this._context.xr;if(!(t!=null&&t.running)){this._wasInXR&&(this._wasInXR=!1,this.onExitXR());return}this._wasInXR||(this._wasInXR=!0,this.onEnterXR()),this.updateMenu()});r(this,"_menuTarget",new h.Object3D);r(this,"positionFilter",new Em(90,.5));r(this,"familyName","Needle Spatial Menu");r(this,"menu");r(this,"_poweredByNeedleElement");var n;this._context=t,this._context.pre_render_callbacks.push(this.preRender),this.needleMenu=e;const i=(n=this.needleMenu.shadowRoot)==null?void 0:n.querySelector(".options");i?new MutationObserver(a=>{if(this.enabled&&!(this._context.isInXR==!1&&!Tf))for(const l of a)l.type==="childList"&&(l.addedNodes.forEach(c=>{this.createButtonFromHTMLNode(c)}),l.removedNodes.forEach(c=>{const d=c,u=this.htmlButtonsMap.get(d);u&&(this.htmlButtonsMap.delete(d),u.remove(),ie.__webpack_exports__default.update())}))}).observe(i,{childList:!0}):console.error("Could not find options container in needle menu")}setEnabled(t){var e;this.enabled=t,t||(e=this.menu)==null||e.removeFromParent()}setDisplay(t){return this.enabled?(this.userRequestedMenu=t,!0):!1}onDestroy(){const t=this._context.pre_render_callbacks.indexOf(this.preRender);t>-1&&this._context.pre_render_callbacks.splice(t,1)}markDirty(){this.uiisDirty=!0}showNeedleLogo(t){this._showNeedleLogo=t}onEnterXR(){var e;const t=(e=this.needleMenu.shadowRoot)==null?void 0:e.querySelector(".options");t&&t.childNodes.forEach(i=>{this.createButtonFromHTMLNode(i)})}onExitXR(){var t;(t=this.menu)==null||t.removeFromParent()}createButtonFromHTMLNode(t){const e=this.getMenu(),i=this.htmlButtonsMap.get(t);if(i){i.add();return}if(t instanceof HTMLButtonElement){const n=this.createButton(e,t);this.htmlButtonsMap.set(t,n),n.add()}else t instanceof HTMLSlotElement&&t.assignedNodes().forEach(n=>{this.createButtonFromHTMLNode(n)})}updateMenu(){var o,a;performance.mark("NeedleSpatialMenu updateMenu start");const t=this.getMenu();this.handleNeedleWatermark(),this._context.scene.add(t);const e=this._context.mainCamera,i=this._context.xr,n=(i==null?void 0:i.rigScale)||1;if(e){const l=e.worldPosition,c=e.worldForward.multiplyScalar(-1),d=c.y>.6,u=c.y>.4,f=(t.visible?u:d)||this.userRequestedMenu,m=!t.visible&&f;t.visible=f||exports.DeviceUtilities.isDesktop()&&Tf,c.multiplyScalar(3*n),l.add(c),(m||!1)&&(t.position.copy(this._menuTarget.position),t.position.y+=.25,this._menuTarget.position.copy(t.position),this.positionFilter.reset(t.position),t.quaternion.copy(this._menuTarget.quaternion),this.markDirty());const _=this._menuTarget.position.distanceTo(l);(m||_>1.5*n)&&(this.ensureRenderOnTop(this.menu),this._menuTarget.position.copy(l),this._context.scene.add(this._menuTarget),zc(this._menuTarget,this._context.mainCamera,!0,!0),this._menuTarget.removeFromParent()),this.positionFilter.filter(this._menuTarget.position,t.position,this._context.time.time);const y=5;(o=this.menu)==null||o.quaternion.slerp(this._menuTarget.quaternion,this._context.time.deltaTime*y),(a=this.menu)==null||a.scale.setScalar(n)}this.uiisDirty&&(performance.mark("SpatialMenu.update.uiisDirty.start"),this.uiisDirty=!1,ie.__webpack_exports__default.update(),performance.mark("SpatialMenu.update.uiisDirty.end"),performance.measure("SpatialMenu.update.uiisDirty","SpatialMenu.update.uiisDirty.start","SpatialMenu.update.uiisDirty.end")),performance.mark("NeedleSpatialMenu updateMenu end"),performance.measure("SpatialMenu.update","NeedleSpatialMenu updateMenu start","NeedleSpatialMenu updateMenu end")}ensureRenderOnTop(t,e=0){t instanceof h.Mesh&&(t.material.depthTest=!1,t.material.depthWrite=!1),t.renderOrder=1e3+e*2;for(const i of t.children)this.ensureRenderOnTop(i,e+1)}get isVisible(){var t;return(t=this.menu)==null?void 0:t.visible}getMenu(){if(this.menu)return this.menu;this.ensureFont(),this.menu=new ie.__webpack_exports__default.Block({boxSizing:"border-box",fontFamily:this.familyName,height:"auto",fontSize:.1,color:0,lineHeight:1,backgroundColor:16777215,backgroundOpacity:.55,borderRadius:1,whiteSpace:"pre-wrap",flexDirection:"row",alignItems:"center",padding:new h.Vector4(0,.05,0,.05),borderColor:0,borderOpacity:.05,borderWidth:.005});const t=R.get("ObjectRaycaster");return t&&Jo(this.menu,new t),this.menu}handleNeedleWatermark(){var t;if(!this._poweredByNeedleElement){this._poweredByNeedleElement=new ie.__webpack_exports__default.Block({width:"auto",height:"auto",fontSize:.05,whiteSpace:"pre-wrap",flexDirection:"row",flexWrap:"wrap",justifyContent:"center",margin:.02,borderRadius:.02,padding:.02,backgroundColor:16777215,backgroundOpacity:1}),this._poweredByNeedleElement["needle:use_eventsystem"]=!0;const e=new xy(this._context,()=>globalThis.open("https://needle.tools","_self"));Jo(this._poweredByNeedleElement,e);const i=new ie.__webpack_exports__default.Text({textContent:"Powered by",width:"auto",height:"auto"}),n=new ie.__webpack_exports__default.Text({textContent:"needle",width:"auto",height:"auto",fontSize:.07,margin:new h.Vector4(0,0,0,.02)});this._poweredByNeedleElement.add(i),this._poweredByNeedleElement.add(n),(t=this.menu)==null||t.add(this._poweredByNeedleElement),this.markDirty(),new h.TextureLoader().load("./include/needle/poweredbyneedle.webp",a=>{var c;e.allowModifyUI=!1,i.removeFromParent(),n.removeFromParent();const l=a.image.width/a.image.height;(c=this._poweredByNeedleElement)==null||c.set({backgroundImage:a,backgroundOpacity:1,width:.1*l,height:.1}),this.markDirty()})}if(this.menu){const e=this.menu.children.indexOf(this._poweredByNeedleElement);if(!this._showNeedleLogo&&io())e>=0&&(this._poweredByNeedleElement.removeFromParent(),this.markDirty());else{this._poweredByNeedleElement.visible=!0,this.menu.add(this._poweredByNeedleElement);const i=this.menu.children.indexOf(this._poweredByNeedleElement);e!==i&&this.markDirty()}}}ensureFont(){let t=ie.__webpack_exports__default.FontLibrary.getFontFamily(this.familyName);if(!t){t=ie.__webpack_exports__default.FontLibrary.addFontFamily(this.familyName);const e=t.addVariant("normal","normal","./include/needle/arial-msdf.json","./include/needle/arial.png");e==null||e.addEventListener("ready",()=>{this.markDirty()})}}createButton(t,e){const i=new ie.__webpack_exports__default.Block({width:"auto",height:"auto",whiteSpace:"pre-wrap",flexDirection:"row",flexWrap:"wrap",justifyContent:"center",backgroundColor:16777215,backgroundOpacity:0,padding:.02,margin:.01,borderRadius:.02,cursor:"pointer",fontSize:.05}),n=new ie.__webpack_exports__default.Text({textContent:"",width:"auto",justifyContent:"center",alignItems:"center",backgroundOpacity:0,backgroundColor:16777215,fontFamily:this.familyName,color:0,borderRadius:.02,padding:.01});i.add(n),i["needle:use_eventsystem"]=!0;const o=new xy(this._context,()=>e.click());return Jo(i,o),new f1(this,t,e,i,n)}}class f1{constructor(t,e,i,n,o){r(this,"menu");r(this,"root");r(this,"htmlbutton");r(this,"spatialContainer");r(this,"spatialText");r(this,"spatialIcon");r(this,"_lastText","");r(this,"_lastTexture");this.menu=t,this.root=e,this.htmlbutton=i,this.spatialContainer=n,this.spatialText=o,new MutationObserver(l=>{for(const c of l)c.type==="attributes"?c.attributeName==="style"&&this.updateVisible():c.type==="childList"&&this.updateText()}).observe(i,{attributes:!0,childList:!0}),this.updateText()}add(){this.spatialContainer.parent!=this.root&&(this.root.add(this.spatialContainer),this.menu.markDirty(),this.updateVisible(),this.updateText())}remove(){this.spatialContainer.parent&&(this.spatialContainer.removeFromParent(),this.menu.markDirty())}updateVisible(){const t=this.spatialContainer.visible;this.spatialContainer.visible=this.htmlbutton.style.display!=="none",t!==this.spatialContainer.visible&&this.menu.markDirty()}updateText(){let t="",e="";this.htmlbutton.childNodes.forEach(i=>{i.nodeType===Node.TEXT_NODE?t+=i.textContent:i instanceof HTMLElement&&mv(i)&&i.textContent&&(e=i.textContent)}),this._lastText!==t&&(this._lastText=t,this.spatialText.name=t,this.spatialText.set({textContent:t}),this.menu.markDirty()),t.length<=0?this.spatialText.parent&&(this.spatialText.removeFromParent(),this.menu.markDirty()):this.spatialText.parent||(this.spatialContainer.add(this.spatialText),this.menu.markDirty()),e&&this.createIcon(e)}async createIcon(t){var i;if(!this.spatialIcon){const n=await tm(t);if(n&&!this.spatialIcon){const a=new ie.__webpack_exports__default.Block({width:.08,height:.08,backgroundColor:16777215,backgroundImage:n,backgroundOpacity:1,margin:new h.Vector4(0,.005,0,0)});this.spatialIcon=a,this.spatialContainer.add(a),this.menu.markDirty()}}if(t!=this._lastTexture){this._lastTexture=t;const n=await tm(t);n&&((i=this.spatialIcon)==null||i.set({backgroundImage:n}),this.menu.markDirty())}const e=this.spatialContainer.children.indexOf(this.spatialIcon);e>0&&(this.spatialContainer.children.splice(e,1),this.spatialContainer.children.unshift(this.spatialIcon),this.menu.markDirty())}}class xy{constructor(t,e){r(this,"isComponent",!0);r(this,"enabled",!0);r(this,"gameObject");r(this,"allowModifyUI",!0);r(this,"context");r(this,"onclick");this.context=t,this.onclick=e}get activeAndEnabled(){return!0}__internalAwake(){}__internalEnable(){}__internalDisable(){}__internalStart(){}onEnable(){}onDisable(){}get element(){return this.gameObject}onPointerEnter(){this.context.input.setCursor("pointer"),this.allowModifyUI&&(this.element.set({backgroundOpacity:1}),ie.__webpack_exports__default.update())}onPointerExit(){this.context.input.unsetCursor("pointer"),this.allowModifyUI&&(this.element.set({backgroundOpacity:0}),ie.__webpack_exports__default.update())}onPointerDown(t){t.use()}onPointerUp(t){t.use()}onPointerClick(t){t.use(),this.onclick()}}const Uo="needle-menu",oc=x("debugmenu"),Sy=x("debugnoncommercial");let p1=class{constructor(t){r(this,"_context");r(this,"_menu");r(this,"_spatialMenu");r(this,"onPostMessage",t=>{if(t.origin===globalThis.location.origin&&typeof t.data=="object"){const e=t.data,i=e.type;if(i==="needle:menu"){const n=e.button;if(n){if(!n.label)return console.error("NeedleMenu: buttoninfo.label is required");if(!n.onclick)return console.error("NeedleMenu: buttoninfo.onclick is required");const o=document.createElement("button");if(o.textContent=n.label,n.icon){const a=yt(n.icon);o.prepend(a)}n.priority&&o.setAttribute("priority",n.priority.toString()),o.onclick=()=>{if(n.onclick){const a=n.onclick.startsWith("http")||n.onclick.startsWith("www."),l=n.target||"_blank";a?globalThis.open(n.onclick,l):console.error("NeedleMenu: onclick is not a valid link",n.onclick)}},this._menu.appendChild(o)}else oc&&console.error("NeedleMenu: unknown postMessage event",e)}else oc&&console.warn("NeedleMenu: unknown postMessage type",i,e)}});r(this,"onStartXR",t=>{t.session.isScreenBasedAR&&(this._menu.previousParent=this._menu.parentNode,this._context.arOverlayElement.appendChild(this._menu),t.session.session.addEventListener("end",this.onExitXR),this._menu.closeFoldout())});r(this,"onExitXR",()=>{this._menu.previousParent&&(this._menu.previousParent.appendChild(this._menu),delete this._menu.previousParent)});r(this,"_muteButton");r(this,"_fullscreenButton");this._menu=qd.getOrCreate(t.domElement,t),this._context=t,this._spatialMenu=new u1(t,this._menu),window.addEventListener("message",this.onPostMessage),Su(this.onStartXR)}onDestroy(){window.removeEventListener("message",this.onPostMessage),this._menu.remove(),this._spatialMenu.onDestroy()}setPosition(t){this._menu.setPosition(t)}setVisible(t){this._menu.setVisible(t)}showNeedleLogo(t){var e;this._menu.showNeedleLogo(t),(e=this._spatialMenu)==null||e.showNeedleLogo(t)}showSpatialMenu(t){this._spatialMenu.setEnabled(t)}setSpatialMenuVisible(t){this._spatialMenu.setDisplay(t)}get spatialMenuIsVisible(){return this._spatialMenu.isVisible}showQRCodeButton(t){if(t==="desktop-only"&&(t=!exports.DeviceUtilities.isMobileDevice()),t){const e=an.getOrCreate().createQRCode();return e.style.display="",this._menu.appendChild(e),e}else{const e=an.getOrCreate().qrButton;return e&&(e.style.display="none"),e??null}}showAudioPlaybackOption(t){var e;if(!t){(e=this._muteButton)==null||e.remove();return}this._muteButton=an.getOrCreate().createMuteButton(this._context),this._muteButton.setAttribute("priority","100"),this._menu.appendChild(this._muteButton)}showFullscreenOption(t){var e;if(!t){(e=this._fullscreenButton)==null||e.remove();return}this._fullscreenButton=an.getOrCreate().createFullscreenButton(this._context),this._fullscreenButton&&(this._fullscreenButton.setAttribute("priority","150"),this._menu.appendChild(this._fullscreenButton))}appendChild(t){return this._menu.appendChild(t)}};var Ic;const y_=class extends HTMLElement{constructor(){var f,m,g,_,y,b;super();r(this,"_domElement",null);r(this,"_context",null);r(this,"_sizeChangeInterval");Ei(this,Ic,e=>{if(!e.defaultPrevented&&e.target==this._domElement&&e instanceof PointerEvent&&e.button===0&&this.root.classList.contains("open")){const i=this.foldout.getBoundingClientRect(),n=e;n.clientX>i.left&&n.clientX<i.right&&n.clientY>i.top&&n.clientY<i.bottom||this.root.classList.toggle("open",!1)}});r(this,"_userRequestedLogoVisible");r(this,"_userRequestedMenuVisible");r(this,"root");r(this,"wrapper");r(this,"options");r(this,"logoContainer");r(this,"compactMenuButton");r(this,"foldout");r(this,"_isHandlingChange",!1);r(this,"_didSort",new Map);r(this,"_lastAvailableWidthChange",0);r(this,"_timeoutHandle",0);r(this,"handleSizeChange",(e,i)=>{if(!this._domElement)return;const n=this._domElement.clientWidth;if(n<100){clearTimeout(this._timeoutHandle),this.root.classList.add("compact"),this.foldout.classList.add("floating-panel-style");return}const o=20*2,a=n-o;if(!i&&Math.abs(a-this._lastAvailableWidthChange)<1)return;this._lastAvailableWidthChange=a,clearTimeout(this._timeoutHandle),this._timeoutHandle=setTimeout(()=>{const d=c();d<0?(this.root.classList.add("compact"),this.foldout.classList.add("floating-panel-style")):d>0&&(this.root.classList.remove("compact"),this.foldout.classList.remove("floating-panel-style"),c()<0&&(this.root.classList.add("compact"),this.foldout.classList.add("floating-panel-style")))},5);const l=()=>this.options.clientWidth+this.logoContainer.clientWidth,c=()=>a-l()});const e=document.createElement("template");e.innerHTML=`<style>

        #root {
            position: absolute;
            width: auto;
            max-width: 95%;
            left: 50%;
            transform: translateX(-50%);
            top: min(20px, 10vh);
            padding: 0.3rem;
            display: flex;
            visibility: visible;
            flex-direction: row-reverse; /* if we overflow this should be right aligned so the logo is always visible */
            pointer-events: all;
            z-index: 1000;
        }

        /** hide the menu if it's empty **/
        #root.has-no-options.logo-hidden {
            display: none; 
        }

        /** using a div here because then we can change the class for placement **/
        #root.bottom {
            top: auto;
            bottom: min(30px, 10vh);
        }
        #root.top {
            top: calc(.7rem + env(safe-area-inset-top));
        }
        
        .wrapper {
            position: relative;
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: stretch;
            gap: 0px;
            padding: 0 0rem;
        }

        .wrapper > *, .options > button, .options > select, ::slotted(*) {
            position: relative;
            border: none;
            border-radius: 0;
            outline: 1px solid rgba(0,0,0,0);
            display: flex;
            justify-content: center;
            align-items: center;
            max-height: 2.3rem;
            max-width: 100%;

            /** basic font settings for all entries **/
            font-size: 1rem;
            font-family: 'Roboto Flex', sans-serif;
            font-optical-sizing: auto;
            font-weight: 500;
            font-weight: 200;
            font-variation-settings: "wdth" 100;
            color: rgb(20,20,20);
        }

        .options > select[multiple]:hover {
            max-height: 300px;
        }

        .floating-panel-style {
            background: rgba(255, 255, 255, .4);
            outline: rgb(0 0 0 / 5%) 1px solid;
            border: 1px solid rgba(255, 255, 255, .1);
            box-shadow: 0px 7px 0.5rem 0px rgb(0 0 0 / 6%), inset 0px 0px 1.3rem rgba(0,0,0,.05);
            border-radius: 1.5rem;
            /** 
             * to make nested background filter work 
             * https://stackoverflow.com/questions/60997948/backdrop-filter-not-working-for-nested-elements-in-chrome 
             **/
            &::before {
                content: '';
                position: absolute;
                width: 100%;
                height: 100%;
                top: 0;
                left: 0;
                z-index: -1;
                border-radius: 1.5rem;
                -webkit-backdrop-filter: blur(8px);
                backdrop-filter: blur(8px);
            }
        }

        a {
            color: inherit;
            text-decoration: none;
        }

        .options {
            display: flex;
            flex-direction: row;
            align-items: center;
        }

        .options > *, ::slotted(*) {
            max-height: 2.25rem;
            padding: .4rem .5rem;
        }
        
        :host .options > *, ::slotted(*) {
            background: transparent;
            border: none;
            white-space: nowrap;
            transition: all 0.1s linear .02s;
            border-radius: 1.5rem;
            user-select: none;
        }
        :host .options > *:hover, ::slotted(*:hover) {
            cursor: pointer;
            color: black;
            background: rgba(245, 245, 245, .8);
            box-shadow: inset 0 0 1rem rgba(0,0,30,.2);
            outline: rgba(0,0,0,.1) 1px solid;
        }
        :host .options > *:active, ::slotted(*:active) {
            background: rgba(255, 255, 255, .8);
            box-shadow: inset 0px 1px 1px rgba(255,255,255,.5), inset 0 0 2rem rgba(0,0,30,.2), inset 0px 2px 4px rgba(0,0,20,.5);
            transition: all 0.05s linear;
        }
        :host .options > *:focus, ::slotted(*:focus) {
            outline: rgba(255,255,255,.5) 1px solid;
        }
        :host .options > *:focus-visible, ::slotted(*:focus-visible) {
            outline: rgba(0,0,0,.5) 1px solid;
        }

        :host .options > *:disabled, ::slotted(*:disabled) {
            background: rgba(0,0,0,.05);
            color: rgba(60,60,60,.7);
            pointer-events: none;
        }

        button, ::slotted(button) {
            gap: 0.3rem;
        }

        /** XR button animation **/
        :host button.this-mode-is-requested {
            background: repeating-linear-gradient(to right, #fff 0%, #fff 40%, #aaffff 55%, #fff 80%);
            background-size: 200% auto;
            background-position: 0 100%;
            animation: AnimationName .7s ease infinite forwards;
        }
        :host button.other-mode-is-requested {
            opacity: .5;
        }
        
        @keyframes AnimationName {
            0% { background-position: 0% 0 }
            100% { background-position: -200% 0 }
        }




        .logo {
            cursor: pointer;
            padding-left: 0.6rem;
            padding-bottom: .02rem;
            margin-right: 0.5rem;
        }
        .logo-hidden {
            .logo {
                display: none;
            }
        }
        :host .has-options .logo {
            border-left: 1px solid rgba(40,40,40,.4);
            margin-left: 0.3rem;
            margin-right: 0.5rem;
        }

        .logo > span {
            white-space: nowrap;
        }



        /** COMPACT */

        /** Hide the menu button normally **/
        .compact-menu-button { display: none; }
        /** And show it when we're in compact mode **/
        .compact .compact-menu-button {
            position: relative;
            display: block;
            background: none;
            border: none;
            border-radius: 2rem;

            margin: 0;
            padding: 0 .3rem;
            padding-top: .2rem;

            z-index: 100;

            color: #000;

            &:hover {
                background: rgba(255,255,255,.2);
                cursor: pointer;
            }
            &:focus {
                outline: 1px solid rgba(255,255,255,.5);
            }
            &:focus-visible {
                outline: 1px solid rgba(0,0,0,.5);
            }
            & .expanded-click-area {
                position: absolute;
                left: 0;
                right: 0;
                top: 10%;
                bottom: 10%;
                transform: scale(1.8);
            }
        }  
        .has-no-options .compact-menu-button {
            display: none;
        }
        .open .compact-menu-button {
            background: rgba(255,255,255,.2);
        }
        .logo-visible .compact-menu-button { 
            margin-left: .2rem;
        }
        
        /** Open and hide menu **/
        .compact .foldout { 
            display: none;
        }
        .open .options, .open .foldout {
            display: flex;
            justify-content: center;
        }
        .compact .wrapper {
            padding: 0;
        }
        .compact .wrapper, .compact .options {
            height: auto;
            max-height: initial;
            flex-direction: row;
            gap: .12rem;
        }
        .compact .options { 
            flex-wrap: wrap;
            gap: .3rem;
        }
        .compact .top .options {
            height: auto;
            flex-direction: row;
        }
        .compact .bottom .wrapper {
            height: auto;
            flex-direction: column;
        }

        .compact .foldout {
            max-height: min(100ch, calc(100vh - 100px));
            overflow: auto;
            overflow-x: hidden;
            align-items: center;

            position: fixed;
            bottom: calc(100% + 5px);
            z-index: 100;
            width: auto;
            left: .2rem;
            right: .2rem;
            padding: .2rem;

        }
        .compact.logo-hidden .foldout {
            /** for when there's no logo we want to center the foldout **/
            min-width: 24ch;
            margin-left: 50%;
            transform: translateX(calc(-50% - .2rem));
        }
        
        .compact.top .foldout {
            top: calc(100% + 5px);
            bottom: auto;
        }

        ::-webkit-scrollbar {
            max-width: 7px;
            background: rgba(100,100,100,.2);
            border-radius: .2rem;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, .3);
            border-radius: .2rem;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgb(150,150,150);
        }

        .compact .options > *, .compact .options > ::slotted(*) {
            font-size: 1.2rem;
            padding: .6rem .5rem;
            width: 100%;
        }
        .compact.has-options .logo {
            border: none;
            padding-left: 0;
            margin-left: 1rem;
            margin-bottom: .02rem;
        }
        .compact .options {
            /** e.g. if we have a very wide menu item like a select with long option names we don't want to overflow **/
            max-width: 100%;

            & > button, & > select {
                display: flex;
                flex-basis: 100%;
                min-height: 3rem;
            }
            & > button.row2 {
                //border: 1px solid red !important;
                display: flex;
                flex: 1;
                flex-basis: 30%;
            }
        }

        /** If there's really not enough space then just hide all options **/
        @media (max-width: 100px) or (max-height: 100px){
            .foldout {
                display: none !important;
            }
            .compact-menu-button {
                display: none !important;
            }
        }
        
        /* dark mode */
        /*
        @media (prefers-color-scheme: dark) {
            :host {
                background: rgba(0,0,0, .6);
            }
            :host button {
                color: rgba(200,200,200);
            }
            :host button:hover {
                background: rgba(100,100,100, .8);
            }
        }
        */

        </style>
        
        <div id="root" class="logo-visible floating-panel-style bottom">
            <div class="wrapper">
                <div class="foldout">
                    <div class="options" part="options">
                        <slot></slot>
                    </div>
                    <div class="options" part="options">
                        <slot name="end"></slot>
                    </div>
                </div>
                <div style="user-select:none" class="logo">
                    <span class="madewith notranslate">powered by</span>
                </div>
            </div>
            <button class="compact-menu-button">
                <div class="expanded-click-area"></div>
            </button>
        </div>
        `;const i=this.attachShadow({mode:"open"});gv(),Gd(im,{loadedCallback:()=>{this.handleSizeChange()}}),Gd(im,{element:i});const n=e.content.cloneNode(!0);i==null||i.appendChild(n),this.root=i.querySelector("#root"),this.wrapper=(f=this.root)==null?void 0:f.querySelector(".wrapper"),this.options=(m=this.root)==null?void 0:m.querySelector(".options"),this.logoContainer=(g=this.root)==null?void 0:g.querySelector(".logo"),this.compactMenuButton=(_=this.root)==null?void 0:_.querySelector(".compact-menu-button"),this.compactMenuButton.append(yt("more_vert")),this.foldout=(y=this.root)==null?void 0:y.querySelector(".foldout"),(b=this.root)==null||b.appendChild(this.wrapper),this.wrapper.classList.add("wrapper");const o=_v.create();o.style.minHeight="1rem",this.logoContainer.append(o),this.logoContainer.addEventListener("click",()=>{globalThis.open("https://needle.tools","_blank")});try{window.requestAnimationFrame(()=>w1(v=>{if(v==!0&&hn()&&!Sy){let w=this._userRequestedLogoVisible;w===void 0&&(w=!1),this.___onSetLogoVisible(w)}}))}catch(v){console.error("[Needle Menu] License check failed.",v)}this.compactMenuButton.addEventListener("click",v=>{v.preventDefault(),this.root.classList.toggle("open")});let a=this._context;setTimeout(()=>a=this._context);let l=0;const c=(v,w)=>{var P,k,O;oc&&console.log("Set menu visible",w),a!=null&&a.isInAR&&a.arOverlayElement?v!=a.arOverlayElement&&a.arOverlayElement.appendChild(this):this.parentNode!=((P=this._domElement)==null?void 0:P.shadowRoot)&&((O=(k=this._domElement)==null?void 0:k.shadowRoot)==null||O.appendChild(this)),this.style.display=w?"flex":"none",this.style.visibility="visible",this.style.opacity="1"};let d=!1;new MutationObserver(v=>{var w;if(!d)try{d=!0,this.onChangeDetected(v);const P=this==null?void 0:this.parentNode;if((this.style.display!="flex"||this.style.visibility!="visible"||this.style.opacity!="1"||P!=((w=this._domElement)==null?void 0:w.shadowRoot))&&!hn()){const k=l++;Ht()&&this._userRequestedMenuVisible===!1?(k===0&&c(P,this._userRequestedMenuVisible),k===1&&console.warn("Needle Menu Warning: You need a PRO license to hide the Needle Engine menu → The menu will be visible in your deployed website if you don't have a PRO license. See https://needle.tools/pricing for details.")):k===0?c(P,!0):setTimeout(()=>c(P,!0),5)}}finally{d=!1}}).observe(this.root,{childList:!0,subtree:!0,attributes:!0}),oc&&this.___insertDebugOptions()}static create(){return document.createElement(Uo,{is:Uo})}static getOrCreate(e,i){let n=e.querySelector(Uo);return!n&&e.shadowRoot&&(n=e.shadowRoot.querySelector(Uo)),n||(n=window.document.body.querySelector(Uo)),n||(n=y_.create(),e.shadowRoot?e.shadowRoot.appendChild(n):e.appendChild(n)),n._domElement=e,n._context=i,n}connectedCallback(){window.addEventListener("resize",this.handleSizeChange),this.handleMenuVisible(),this._sizeChangeInterval=setInterval(()=>this.handleSizeChange(void 0,!0),5e3),setTimeout(()=>{var e,i;(e=this._domElement)==null||e.addEventListener("resize",this.handleSizeChange),(i=this._domElement)==null||i.addEventListener("click",le(this,Ic))},1)}disconnectedCallback(){var e,i;window.removeEventListener("resize",this.handleSizeChange),clearInterval(this._sizeChangeInterval),(e=this._domElement)==null||e.removeEventListener("resize",this.handleSizeChange),(i=this._context)==null||i.domElement.removeEventListener("click",le(this,Ic))}showNeedleLogo(e){this._userRequestedLogoVisible=e,!(!e&&(!hn()||Sy)&&(console.warn("Needle Menu: You need a PRO license to hide the Needle Engine logo."),!Ht()))&&this.___onSetLogoVisible(e)}___onSetLogoVisible(e){this.logoContainer.style.display="",this.logoContainer.style.opacity="1",this.logoContainer.style.visibility="visible",e?(this.root.classList.remove("logo-hidden"),this.root.classList.add("logo-visible")):(this.root.classList.remove("logo-visible"),this.root.classList.add("logo-hidden"))}setPosition(e){if(e!=="top"&&e!=="bottom")return console.error("NeedleMenu.setPosition: invalid position",e);this.root.classList.remove("top","bottom"),this.root.classList.add(e)}setVisible(e){this._userRequestedMenuVisible=e,this.style.display=e?"flex":"none"}closeFoldout(){this.root.classList.remove("open")}append(...e){for(const i of e)if(typeof i=="string"){const n=document.createTextNode(i);this.options.appendChild(n)}else this.options.appendChild(i)}appendChild(e){var n;if(!(e instanceof Node)){const o=document.createElement("button");if(o.textContent=e.label,o.onclick=e.onClick,o.setAttribute("priority",((n=e.priority)==null?void 0:n.toString())??"0"),e.title&&(o.title=e.title),e.icon){const a=yt(e.icon);e.iconSide==="right"?o.appendChild(a):o.prepend(a)}e.class&&o.classList.add(e.class),e=o}return this.options.appendChild(e)}prepend(...e){for(const i of e)if(typeof i=="string"){const n=document.createTextNode(i);this.options.prepend(n)}else this.options.prepend(i)}onChangeDetected(e){if(!this._isHandlingChange){this._isHandlingChange=!0;try{this.handleMenuVisible();for(const i of e)i.target==this.options&&this.onOptionsChildrenChanged(i)}finally{this._isHandlingChange=!1}}}onOptionsChildrenChanged(e){if(this.root.classList.toggle("has-options",this.hasAnyVisibleOptions),this.root.classList.toggle("has-no-options",!this.hasAnyVisibleOptions),this.handleSizeChange(void 0,!0),e.type==="childList"&&e.addedNodes.length>0){const i=Array.from(this.options.children);i.sort((o,a)=>{const l=parseInt(o.getAttribute("priority")||"0"),c=parseInt(a.getAttribute("priority")||"0");return l-c});let n=!1;for(let o=0;o<i.length;o++){const a=this.options.children[o],l=i[o];if(a!==l){n=!0;break}}if(n)for(const o of i)this.options.appendChild(o)}}handleMenuVisible(){oc&&console.log("Update VisibleState: Any Content?",this.hasAnyContent),this.hasAnyContent?this.root.style.display="":this.root.style.display="none",this.root.classList.toggle("has-options",this.hasAnyVisibleOptions),this.root.classList.toggle("has-no-options",!this.hasAnyVisibleOptions)}get hasAnyContent(){return!!(this.logoContainer.style.display!="none"||this.hasAnyVisibleOptions)}get hasAnyVisibleOptions(){for(let e=0;e<this.options.children.length;e++){const i=this.options.children[e];if(i.tagName==="SLOT"){const o=i.assignedNodes();for(const a of o)if(a instanceof HTMLElement&&a.style.display!="none")return!0}else if(i.style.display!="none")return!0}return!1}___insertDebugOptions(){window.addEventListener("keydown",n=>{n.key==="p"&&this.setPosition(this.root.classList.contains("top")?"bottom":"top")});const e=document.createElement("button");e.textContent="Hide Buttons",e.onclick=()=>{const n=new Array(this.options.children.length);for(let o=0;o<this.options.children.length;o++)n[o]=this.options.children[o];for(const o of n)this.options.removeChild(o);setTimeout(()=>{for(const o of n)this.options.appendChild(o)},1e3)},this.appendChild(e);const i=document.createElement("button");i.textContent="Toggle Logo",i.addEventListener("click",()=>{this.logoContainer.style.display=this.logoContainer.style.display==="none"?"":"none"}),this.appendChild(i)}};let qd=y_;Ic=new WeakMap;customElements.get(Uo)||customElements.define(Uo,qd);const qe=x("debugcontext"),m1=x("stats"),g1=x("debugactive"),_1=x("debugframerate"),y1=x("debugcoroutine"),b1={};class v1{constructor(){r(this,"name");r(this,"alias");r(this,"hash");r(this,"runInBackground");r(this,"domElement");r(this,"renderer");r(this,"camera");r(this,"scene")}}var ve=(s=>(s[s.Start=-1]="Start",s[s.EarlyUpdate=0]="EarlyUpdate",s[s.Update=1]="Update",s[s.LateUpdate=2]="LateUpdate",s[s.OnBeforeRender=3]="OnBeforeRender",s[s.OnAfterRender=4]="OnAfterRender",s[s.PrePhysicsStep=9]="PrePhysicsStep",s[s.PostPhysicsStep=10]="PostPhysicsStep",s[s.Undefined=-1]="Undefined",s))(ve||{});function Eu(s,t){if(!s)return;if(!s.isComponent){(B()||qe)&&console.error(`Registered script is not a Needle Engine component. 
The script will be ignored. Please make sure your component extends "Behaviour" imported from "@needle-tools/engine"
`,s);return}t||(t=Q.Current,qe&&console.warn("> Registering component without context"));const e=t==null?void 0:t.new_scripts;e.includes(s)||e.push(s)}const we=class{constructor(t){r(this,"name");r(this,"alias");r(this,"isManagedExternally",!1);r(this,"isPaused",!1);r(this,"runInBackground",!1);r(this,"targetFrameRate");r(this,"physicsSteps",1);r(this,"hash");r(this,"domElement");r(this,"_resolutionScaleFactor",1);r(this,"_boundingClientRectFrame",-1);r(this,"_boundingClientRect",null);r(this,"_domX");r(this,"_domY");r(this,"xr",null);r(this,"_xrFrame",null);r(this,"_currentFrameEvent",-1);r(this,"scene");r(this,"renderer");r(this,"composer",null);r(this,"scripts",[]);r(this,"scripts_pausedChanged",[]);r(this,"scripts_earlyUpdate",[]);r(this,"scripts_update",[]);r(this,"scripts_lateUpdate",[]);r(this,"scripts_onBeforeRender",[]);r(this,"scripts_onAfterRender",[]);r(this,"scripts_WithCorroutines",[]);r(this,"scripts_immersive_vr",[]);r(this,"scripts_immersive_ar",[]);r(this,"coroutines",{});r(this,"post_setup_callbacks",[]);r(this,"pre_update_callbacks",[]);r(this,"pre_render_callbacks",[]);r(this,"post_render_callbacks",[]);r(this,"pre_update_oneshot_callbacks",[]);r(this,"new_scripts",[]);r(this,"new_script_start",[]);r(this,"new_scripts_pre_setup_callbacks",[]);r(this,"new_scripts_post_setup_callbacks",[]);r(this,"new_scripts_xr",[]);r(this,"mainCameraComponent");r(this,"_mainCamera",null);r(this,"_fallbackCamera",null);r(this,"application");r(this,"animations");r(this,"time");r(this,"input");r(this,"physics");r(this,"connection");r(this,"assets");r(this,"mainLight",null);r(this,"sceneLighting");r(this,"addressables");r(this,"lightmaps");r(this,"players");r(this,"lodsManager");r(this,"menu");r(this,"_sizeChanged",!1);r(this,"_isCreated",!1);r(this,"_isCreating",!1);r(this,"_isVisible",!1);r(this,"_stats",m1?new Y.Stats:null);r(this,"_intersectionObserver",null);r(this,"_disposeCallbacks",[]);r(this,"maxRenderResolution");r(this,"_originalCreationArgs");r(this,"onUnhandledRejection",t=>{this.onError(t.reason)});r(this,"_cameraStack",[]);r(this,"_onBeforeRenderListeners",new Map);r(this,"_onAfterRenderListeners",new Map);r(this,"_requireDepthTexture",!1);r(this,"_requireColorTexture",!1);r(this,"_renderTarget");r(this,"_isRendering",!1);r(this,"_createId",0);r(this,"_renderlooperrors",0);r(this,"_lastTimestamp",0);r(this,"_accumulatedTime",0);r(this,"_dispatchReadyAfterFrame",!1);r(this,"_contextRestoreTries",0);r(this,"_wasPaused",!1);this.name=(t==null?void 0:t.name)||"",this.alias=t==null?void 0:t.alias,this.domElement=(t==null?void 0:t.domElement)||document.body,this.hash=t==null?void 0:t.hash,t!=null&&t.renderer&&(this.renderer=t.renderer,this.isManagedExternally=!0),(t==null?void 0:t.runInBackground)!==void 0&&(this.runInBackground=t.runInBackground),t!=null&&t.scene?this.scene=t.scene:this.scene=new h.Scene,t!=null&&t.camera&&(this._mainCamera=t.camera),this.application=new cn(this),this.time=new fv,this.input=new h0(this),this.physics=new va(this),this.connection=new y0(this),this.assets=new x0,this.sceneLighting=new dv(this),this.addressables=new ov(this),this.lightmaps=new t1(this),this.players=new hv(this),this.menu=new p1(this),this.lodsManager=new i1(this),this.animations=new ZC(this);const e=()=>this._sizeChanged=!0;window.addEventListener("resize",e),this._disposeCallbacks.push(()=>window.removeEventListener("resize",e));const i=new ResizeObserver(n=>this._sizeChanged=!0);i.observe(this.domElement),this._disposeCallbacks.push(()=>i.disconnect()),this._intersectionObserver=new IntersectionObserver(n=>{this._isVisible=n[0].isIntersecting}),this._disposeCallbacks.push(()=>{var n;return(n=this._intersectionObserver)==null?void 0:n.disconnect()}),ce.register(this)}static get DefaultTargetFrameRate(){return we._defaultTargetFramerate.value}static set DefaultTargetFrameRate(t){we._defaultTargetFramerate.value=t}static get DefaultWebGLRendererParameters(){return we._defaultWebglRendererParameters}get version(){return ln}static get Current(){return ce.Current}static set Current(t){ce.Current=t}static get All(){return ce.All}appendHTMLElement(t){return this.domElement.shadowRoot?this.domElement.shadowRoot.appendChild(t):this.domElement.appendChild(t)}get resolutionScaleFactor(){return this._resolutionScaleFactor}set resolutionScaleFactor(t){if(t!==this._resolutionScaleFactor&&typeof t=="number"){if(t<=0){console.error("Invalid resolution scale factor",t);return}this._resolutionScaleFactor=t,this.updateSize()}}calculateBoundingClientRect(){if(this.xr){this._domX=0,this._domY=0;return}this._boundingClientRectFrame!==this.time.frame&&(this._boundingClientRectFrame=this.time.frame,this._boundingClientRect=this.domElement.getBoundingClientRect(),this._domX=this._boundingClientRect.x,this._domY=this._boundingClientRect.y)}get domWidth(){return this.isInAR?window.innerWidth:this.domElement.clientWidth}get domHeight(){return this.isInAR?window.innerHeight:this.domElement.clientHeight}get domX(){return this.calculateBoundingClientRect(),this._domX}get domY(){return this.calculateBoundingClientRect(),this._domY}get isInXR(){var t,e;return((e=(t=this.renderer)==null?void 0:t.xr)==null?void 0:e.isPresenting)||!1}get xrSessionMode(){var t;return(t=this.xr)==null?void 0:t.mode}get isInVR(){return this.xrSessionMode==="immersive-vr"}get isInAR(){return this.xrSessionMode==="immersive-ar"}get isInPassThrough(){return this.xr?this.xr.isPassThrough:!1}get xrSession(){var t,e;return(e=(t=this.renderer)==null?void 0:t.xr)==null?void 0:e.getSession()}get xrFrame(){return this._xrFrame}get xrCamera(){var t,e;return this.renderer.xr.isPresenting?(e=(t=this.renderer)==null?void 0:t.xr)==null?void 0:e.getCamera():void 0}get arOverlayElement(){const t=this.domElement;return typeof t.getAROverlayContainer=="function"?t.getAROverlayContainer():this.domElement}get currentFrameEvent(){return this._currentFrameEvent}get mainCamera(){if(this._mainCamera)return this._mainCamera;if(this.mainCameraComponent){const t=this.mainCameraComponent;return t.threeCamera||t.buildCamera(),t.threeCamera}return this._fallbackCamera||(this._fallbackCamera=new h.PerspectiveCamera(75,this.domWidth/this.domHeight,.1,1e3)),this._fallbackCamera}set mainCamera(t){this._mainCamera=t}get rendererData(){return this.sceneLighting}get isCreated(){return this._isCreated}createNewRenderer(t){var e,i,n;if((e=this.renderer)==null||e.dispose(),t={...we.DefaultWebGLRendererParameters,...t},!t.canvas){const o=(n=(i=this.domElement)==null?void 0:i.shadowRoot)==null?void 0:n.querySelector("canvas");o&&(t.canvas=o,qe&&console.log("Using canvas from shadow root",o))}qe&&console.log("Using Renderer Parameters:",t,this.domElement),this.renderer=new h.WebGLRenderer(t),this.renderer.debug.checkShaderErrors=B()||x("checkshadererrors")===!0,this.renderer.toneMappingExposure=1,this.renderer.toneMapping=h.NoToneMapping,this.renderer.setClearColor(new h.Color("lightgrey"),0),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=h.PCFSoftShadowMap$1,this.renderer.setSize(this.domWidth,this.domHeight),this.renderer.outputColorSpace=h.SRGBColorSpace,this.renderer.nodes={library:new h.BasicNodeLibrary,modelViewMatrix:null,modelNormalViewMatrix:null},this.lodsManager.setRenderer(this.renderer),this.input.bindEvents()}internalOnUpdateVisible(){var t,e;(t=this._intersectionObserver)==null||t.disconnect(),(e=this._intersectionObserver)==null||e.observe(this.domElement)}requestSizeUpdate(){this._sizeChanged=!0}updateSize(t=!1){var e,i,n;if(t||!this.isManagedExternally&&((e=this.renderer.xr)==null?void 0:e.isPresenting)===!1){this._sizeChanged=!1;const o=this.resolutionScaleFactor;let a=this.domWidth*o,l=this.domHeight*o;this.maxRenderResolution&&(this.maxRenderResolution.x=Math.max(1,this.maxRenderResolution.x),a=Math.min(this.maxRenderResolution.x,a),this.maxRenderResolution.y=Math.max(1,this.maxRenderResolution.y),l=Math.min(this.maxRenderResolution.y,l));const c=this.mainCamera;this.updateAspect(c),this.renderer.setSize(a,l,!0),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.domElement.style.width="100%",this.renderer.domElement.style.height="100%",this.composer&&((i=this.composer.setSize)==null||i.call(this.composer,a,l),"setPixelRatio"in this.composer&&typeof this.composer.setPixelRatio=="function"&&((n=this.composer.setPixelRatio)==null||n.call(this.composer,window.devicePixelRatio)))}}updateAspect(t,e,i){if(!t)return;e===void 0&&(e=this.domWidth),i===void 0&&(i=this.domHeight);const n=e/i;if(t.isPerspectiveCamera){const o=t,a=o.aspect;o.aspect=n,a!==o.aspect&&t.updateProjectionMatrix()}else if(t.isOrthographicCamera){const o=t,a=o.top-o.bottom,c=a*n/2,d=a/2;(o.left!=-c||o.top!=d)&&(o.left=-c,o.right=c,o.top=d,o.bottom=-d,t.updateProjectionMatrix())}}recreate(){this.clear(),this.create(this._originalCreationArgs)}async onCreate(t){return this.create(t)}async create(t){try{this._isCreating=!0,t!==this._originalCreationArgs&&(this._originalCreationArgs=Fc(t)),window.addEventListener("unhandledrejection",this.onUnhandledRejection);const e=await this.internalOnCreate(t);return this._isCreated=e,e}finally{window.removeEventListener("unhandledrejection",this.onUnhandledRejection),this._isCreating=!1}}onError(t){this.domElement.dispatchEvent(new CustomEvent("error",{detail:t}))}clear(){var t,e,i,n;ce.dispatchCallback(he.ContextClearing,this),wn(this,he.ContextClearing),Si(this.scene,!0,!0),this.scene=new h.Scene,(t=this.addressables)==null||t.dispose(),(e=this.lightmaps)==null||e.clear(),(n=(i=this.physics)==null?void 0:i.engine)==null||n.clearCaches(),this.lodsManager.disable(),this.isManagedExternally||this.renderer&&(this.renderer.renderLists.dispose(),this.renderer.state.reset(),this.renderer.resetState()),ce.dispatchCallback(he.ContextCleared,this)}dispose(){this.internalOnDestroy()}onDestroy(){this.internalOnDestroy()}internalOnDestroy(){var t,e;we.Current=this,ce.dispatchCallback(he.ContextDestroying,this),wn(this,he.ContextDestroying),this.clear(),(t=this.renderer)==null||t.setAnimationLoop(null),this.renderer&&(this.renderer.setClearAlpha(0),this.renderer.clear(),this.isManagedExternally||(qe&&console.log("Disposing renderer"),this.renderer.dispose())),this.scene=null,this.renderer=null,this.input.dispose(),this.menu.onDestroy(),this.animations.onDestroy();for(const i of this._disposeCallbacks)try{i()}catch(n){console.error("Error in on dispose callback:",n,i)}(e=this.domElement)!=null&&e.parentElement&&this.domElement.parentElement.removeChild(this.domElement),this._isCreated=!1,ce.dispatchCallback(he.ContextDestroyed,this),wn(this,he.ContextDestroyed),ce.unregister(this),we.Current===this&&(we.Current=null)}registerCoroutineUpdate(t,e,i){return typeof(e==null?void 0:e.next)!="function"?(console.error("Registered invalid coroutine function from "+t.name+`
Coroutine functions must be generators: "*myCoroutine() {...}"
Start a coroutine from a component by calling "this.startCoroutine(myCoroutine())"`),e):(this.coroutines[i]||(this.coroutines[i]=[]),this.coroutines[i].push({comp:t,main:e}),e)}unregisterCoroutineUpdate(t,e){if(!this.coroutines[e])return;const i=this.coroutines[e].findIndex(n=>n.main===t);i>=0&&this.coroutines[e].splice(i,1)}stopAllCoroutinesFrom(t){for(const e in this.coroutines){const i=this.coroutines[e];for(let n=i.length-1;n>=0;n--)i[n].comp===t&&i.splice(n,1)}}setCurrentCamera(t){var n;if(!t)return;if(t.threeCamera||t.buildCamera(),!t.threeCamera){console.warn("Camera component is missing camera",t);return}const e=this._cameraStack.indexOf(t);e>=0&&this._cameraStack.splice(e,1),this._cameraStack.push(t),this.mainCameraComponent=t;const i=t.threeCamera;i.isPerspectiveCamera&&this.updateAspect(i),(n=this.mainCameraComponent)==null||n.applyClearFlagsIfIsActiveCamera()}removeCamera(t){if(!t)return;const e=this._cameraStack.indexOf(t);if(e>=0&&this._cameraStack.splice(e,1),this.mainCameraComponent===t&&(this.mainCameraComponent=void 0,this._cameraStack.length>0)){const i=this._cameraStack[this._cameraStack.length-1];this.setCurrentCamera(i)}}addBeforeRenderListener(t,e){this._onBeforeRenderListeners.has(t.uuid)||(this._onBeforeRenderListeners.set(t.uuid,[]),t.onBeforeRender=this._createRenderCallbackWrapper(t,this._onBeforeRenderListeners)),this._onBeforeRenderListeners.get(t.uuid).push(e)}removeBeforeRenderListener(t,e){if(this._onBeforeRenderListeners.has(t.uuid)){const i=this._onBeforeRenderListeners.get(t.uuid),n=i.indexOf(e);n>=0&&i.splice(n,1)}}addAfterRenderListener(t,e){var i;this._onAfterRenderListeners.has(t.uuid)||(this._onAfterRenderListeners.set(t.uuid,[]),t.onAfterRender=this._createRenderCallbackWrapper(t,this._onAfterRenderListeners)),(i=this._onAfterRenderListeners.get(t.uuid))==null||i.push(e)}removeAfterRenderListener(t,e){if(this._onAfterRenderListeners.has(t.uuid)){const i=this._onAfterRenderListeners.get(t.uuid),n=i.indexOf(e);n>=0&&i.splice(n,1)}}_createRenderCallbackWrapper(t,e){return(i,n,o,a,l,c)=>{const d=e.get(t.uuid);if(d)for(let u=0;u<d.length;u++){const f=d[u];f(i,n,o,a,l,c)}}}get isRendering(){return this._isRendering}setRequireDepth(t){this._requireDepthTexture=t}setRequireColor(t){this._requireColorTexture=t}get depthTexture(){var t;return((t=this._renderTarget)==null?void 0:t.depthTexture)||null}get opaqueColorTexture(){var t;return((t=this._renderTarget)==null?void 0:t.texture)||null}get isVisibleToUser(){if(this.isInXR)return!0;if(!this._isVisible)return!1;const t=getComputedStyle(this.domElement);return t.visibility!=="hidden"&&t.display!=="none"&&t.opacity!=="0"}async internalOnCreate(t){var l,c,d,u,f,m,g,_;const e=++this._createId;qe&&console.log("Creating context",this.name,t);const i=globalThis["needle:dependencies:ready"];i instanceof Promise&&(qe&&console.log("Waiting for dependencies to be ready"),await i.catch(y=>{if(qe||B()){if($c("Needle Engine dependencies failed to load. Please check the console for more details"),y instanceof ReferenceError){let b="YourComponentName";const v=y.message.indexOf("'");if(v>0){const w=y.message.indexOf("'",v+1);if(w>0){const P=y.message.substring(v+1,w);P.length>3&&(b=P)}}console.error(`Needle Engine dependencies failed to load:

# Make sure you don't have circular imports in your scripts!

Possible solutions: 
→ Replace @serializable(${b}) in your script with @serializable(Behaviour)
→ If you only need type information try importing the type only, e.g: import { type ${b} }

---`,y);return}console.error("Needle Engine dependencies failed to load",y)}}).then(()=>{qe&&console.log("Needle Engine dependencies are ready")})),this.clear(),this.isManagedExternally===!1&&(this.createNewRenderer(),(l=this.renderer)==null||l.setAnimationLoop(null)),await un(1),we.Current=this,await ce.dispatchCallback(he.ContextCreationStart,this);let n=!0,o;try{we.Current=this,t?o=await this.internalLoadInitialContent(e,t):o=[]}catch(y){console.error(y),n=!1}if(!n)return this.onError("Failed to load initial content"),!1;if(e!==this._createId||(c=t==null?void 0:t.abortSignal)!=null&&c.aborted)return!1;if(this.internalOnUpdateVisible(),!this.renderer)return qe&&console.warn("Context has no renderer (perhaps it was disconnected?",this.domElement.isConnected),!1;!this.isManagedExternally&&!this.domElement.shadowRoot&&this.domElement.prepend(this.renderer.domElement),we.Current=this,we.Current=this;for(let y=0;y<this.new_scripts.length;y++){const b=this.new_scripts[y];if(b.gameObject!==void 0&&b.gameObject!==null){b.gameObject.userData===void 0&&(b.gameObject.userData={}),b.gameObject.userData.components===void 0&&(b.gameObject.userData.components=[]);const v=b.gameObject.userData.components;v.includes(b)||v.push(b)}}if(this.post_setup_callbacks)for(let y=0;y<this.post_setup_callbacks.length;y++)we.Current=this,await this.post_setup_callbacks[y](this);if(!this._mainCamera){we.Current=this;let y=null;hr(this.scene,b=>{const v=b;if(v!=null&&v.isCamera){if(nc(v.gameObject),!v.activeAndEnabled)return;if(v.tag==="MainCamera")return y=v,!0;y=v}}),y?this.setCurrentCamera(y):!ce.dispatchCallback(he.MissingCamera,this,{files:o})&&!this.mainCamera&&!this.isManagedExternally&&console.warn("Missing camera in main scene",this)}this.input.bindEvents(),we.Current=this,Bd(this),this.physics.engine&&((d=this.physics.engine)==null||d.step(0),(u=this.physics.engine)==null||u.postStep()),!this.isManagedExternally&&this.composer&&this.mainCamera,this._sizeChanged=!0,this._stats&&(this._stats.showPanel(0),this._stats.dom.style.position="absolute",(f=this.domElement.shadowRoot)==null||f.appendChild(this._stats.dom)),qe&&Ld(this.scene,!0),this.targetFrameRate===void 0?(qe&&console.warn("No target framerate set, using default",we.DefaultTargetFrameRate),this.targetFrameRate=we._defaultTargetFramerate):qe&&console.log("Target framerate set to",this.targetFrameRate),this._dispatchReadyAfterFrame=!0;const a=ce.dispatchCallback(he.ContextCreated,this,{files:o});return a&&("internalSetLoadingMessage"in this.domElement&&typeof this.domElement.internalSetLoadingMessage=="function"&&((m=this.domElement)==null||m.internalSetLoadingMessage("finish loading")),await a),(g=t==null?void 0:t.abortSignal)!=null&&g.aborted?!1:(wn(this,he.ContextCreated),qe&&console.log("Context Created...",this.renderer,this.renderer.domElement),this._isCreating=!1,!this.isManagedExternally&&!((_=t==null?void 0:t.abortSignal)!=null&&_.aborted)&&this.restartRenderLoop(),!0)}async internalLoadInitialContent(t,e){var c,d,u,f;const i=new Array;if(e.files.length===0)return i;const n=[...e.files],o={name:"",progress:null,index:0,count:n.length},a=dn(),l=0;for(let m=0;m<n.length;m++){if((c=e.abortSignal)!=null&&c.aborted){qe&&console.log("Aborting loading because of abort signal");break}if(t!==this._createId){qe&&console.log("Aborting loading because create id changed",t,this._createId);break}const g=n[m];(d=e==null?void 0:e.onLoadingStart)==null||d.call(this,m,g),qe&&console.log("Context Load "+g);const _=await a.loadSync(this,g,g,l,y=>{var b,v;(b=e.abortSignal)!=null&&b.aborted||(o.name=g,o.progress=y,o.index=m,o.count=n.length,(v=e.onLoadingProgress)==null||v.call(this,o))});(u=e==null?void 0:e.onLoadingFinished)==null||u.call(this,m,g,_??null),_?i.push({src:g,file:_}):console.warn("Could not load file: "+g)}if(t!==this._createId||(f=e.abortSignal)!=null&&f.aborted){qe&&console.log("Aborting loading because create id changed or abort signal was set",t,this._createId);for(const m of i)if(m&&m.file)for(const g of m.file.scenes)Si(g,!0,!0)}else{let m=!1;for(const g of i)g&&g.file&&(g.file.scene?(m=!0,this.scene.add(g.file.scene)):console.warn("No scene found in loaded file"));if(!m){for(const g of i)if(g&&g.file&&"parser"in g.file){let _=0;if(!Array.isArray(g.file.parser.json.materials))continue;for(let y=0;y<g.file.parser.json.materials.length;y++){const b=await g.file.parser.getDependency("material",y),v=new h.Object3D;v.position.x=y*1.1,v.position.y=_,this.scene.add(v),yo.createPrimitive("ShaderBall",{parent:v,material:b})}_+=1}}}return i}restartRenderLoop(){return this.renderer?this._isCreating?(console.warn("Can not start render loop while creating context"),!1):(this.renderer.setAnimationLoop((t,e)=>{this.isManagedExternally||this.update(t,e)}),!0):(console.error("Can not start render loop without renderer"),!1)}update(t,e){if(e===void 0&&(e=null),B()||qe||yC())try{performance.mark("update.start"),this.internalStep(t,e),this._renderlooperrors=0,performance.mark("update.end"),performance.measure("NE Frame","update.start","update.end")}catch(i){this._renderlooperrors+=1,(B()||qe)&&(i instanceof Error||i instanceof TypeError)&&Te("Caught unhandled exception during render-loop - see console for details.",bi.Error),console.error("Frame #"+this.time.frame+`
`,i),this._renderlooperrors>=3&&(console.warn("Stopping render loop due to error"),this.renderer.setAnimationLoop(null)),this.domElement.dispatchEvent(new CustomEvent("error",{detail:i}))}else this.internalStep(t,e)}updatePhysics(t){this.internalUpdatePhysics(t)}internalStep(t,e){this.internalOnBeforeRender(t,e)!==!1&&(this.internalOnRender(),this.internalOnAfterRender())}internalOnBeforeRender(t,e){var n;this.renderer.info.autoReset=!0;const i=e!==null&&this._xrFrame===null;if(this._xrFrame=e,i&&this.domElement.dispatchEvent(new CustomEvent("xr-session-started",{detail:{context:this,session:this.xrSession,frame:e}})),this._currentFrameEvent=-1,this.isManagedExternally===!1&&this.isInXR===!1&&this.targetFrameRate!==void 0){this._lastTimestamp===0&&(this._lastTimestamp=t),this._accumulatedTime+=(t-this._lastTimestamp)/1e3,this._lastTimestamp=t;let o=this.targetFrameRate;if(typeof o=="object"&&(o=o.value),this._accumulatedTime<1/(o+1))return!1;this._accumulatedTime=0}if((n=this._stats)==null||n.begin(),we.Current=this,this.onHandlePaused())return!1;for(we.Current=this,this.time.update(),_1&&console.log("FPS",this.time.smoothedFps.toFixed(0)),Bd(this),fd(this.scene),E0(this),wn(this,-1);this._cameraStack.length>0&&(!this.mainCameraComponent||this.mainCameraComponent.destroyed);){this._cameraStack.splice(this._cameraStack.length-1,1);const o=this._cameraStack[this._cameraStack.length-1];this.setCurrentCamera(o)}if(this.pre_update_oneshot_callbacks){for(const o in this.pre_update_oneshot_callbacks)this.pre_update_oneshot_callbacks[o]();this.pre_update_oneshot_callbacks.length=0}if(this.pre_update_callbacks)for(const o in this.pre_update_callbacks)this.pre_update_callbacks[o]();this._currentFrameEvent=0;for(let o=0;o<this.scripts_earlyUpdate.length;o++){const a=this.scripts_earlyUpdate[o];a.activeAndEnabled&&a.earlyUpdate!==void 0&&(we.Current=this,a.earlyUpdate())}if(this.executeCoroutines(0),wn(this,0),this.onHandlePaused())return!1;this._currentFrameEvent=1;for(let o=0;o<this.scripts_update.length;o++){const a=this.scripts_update[o];a.activeAndEnabled&&a.update!==void 0&&(we.Current=this,a.update())}if(this.executeCoroutines(1),wn(this,1),this.onHandlePaused())return!1;this._currentFrameEvent=2;for(let o=0;o<this.scripts_lateUpdate.length;o++){const a=this.scripts_lateUpdate[o];a.activeAndEnabled&&a.lateUpdate!==void 0&&(we.Current=this,a.lateUpdate())}if(this.executeCoroutines(2),wn(this,2),this.onHandlePaused()||(this.physicsSteps===void 0&&(this.physicsSteps=1),this.physics.engine&&this.physicsSteps>0&&this.internalUpdatePhysics(this.physicsSteps),this.onHandlePaused()))return!1;if(this.isVisibleToUser||this.runInBackground){this._currentFrameEvent=3;for(let o=0;o<this.scripts_onBeforeRender.length;o++){const a=this.scripts_onBeforeRender[o];a.activeAndEnabled&&a.onBeforeRender!==void 0&&(we.Current=this,a.onBeforeRender(e))}if(this.executeCoroutines(3),wn(this,3),this._sizeChanged&&this.updateSize(),this.pre_render_callbacks)for(const o in this.pre_render_callbacks)this.pre_render_callbacks[o](e)}return!0}internalUpdatePhysics(t){if(!this.physics.engine)return!1;const e=t,i=this.time.deltaTime/e;for(let n=0;n<e;n++)this._currentFrameEvent=9,this.executeCoroutines(9),this.physics.engine.step(i),this._currentFrameEvent=10,this.executeCoroutines(10);return this.physics.engine.postStep(),!0}internalOnRender(){this.isManagedExternally||(xC(this),this._currentFrameEvent=-1,Y.nodeFrame.update(),this.renderNow(),this._currentFrameEvent=4)}internalOnAfterRender(){if(this.isVisibleToUser||this.runInBackground){for(let t=0;t<this.scripts_onAfterRender.length;t++){const e=this.scripts_onAfterRender[t];e.activeAndEnabled&&e.onAfterRender!==void 0&&(we.Current=this,e.onAfterRender())}if(this.executeCoroutines(4),wn(this,4),this.post_render_callbacks)for(const t in this.post_render_callbacks)this.post_render_callbacks[t]()}this._currentFrameEvent=-1,this.connection.sendBufferedMessagesNow(),this._stats&&(this._stats.end(),this.time.frameCount%150===0&&console.log(this.renderer.info.render.calls+" DrawCalls",`
Render:`,{...this.renderer.info.render},`
Memory:`,{...this.renderer.info.memory},`
Target Framerate: `+this.targetFrameRate)),this._dispatchReadyAfterFrame&&(this._dispatchReadyAfterFrame=!1,this.domElement.dispatchEvent(new CustomEvent("ready")),ce.dispatchCallback(he.ContextFirstFrameRendered,this))}renderNow(t){var e;return!t&&(t=this.mainCamera,!t)?!1:(this.handleRendererContextLost(),this._isRendering=!0,this.renderRequiredTextures(),this.renderer.toneMapping!==h.NoToneMapping&&pv(),this.composer&&!this.isInXR?(t&&"setMainCamera"in this.composer&&((e=this.composer.passes[0])==null?void 0:e.mainCamera)!=t&&this.composer.setMainCamera(t),this.composer.render(this.time.deltaTime)):t&&(this.isInXR&&exports.DeviceUtilities.isMacOS()&&this.renderer.clearDepth(),this.renderer.render(this.scene,t)),this._isRendering=!1,!0)}handleRendererContextLost(){this.time.frame%10&&this.renderer.getContext().isContextLost()&&this._contextRestoreTries++<100&&(console.warn("Attempting to recover WebGL context..."),this.renderer.forceContextRestore())}onHandlePaused(){const t=this.evaluatePaused();if(this._wasPaused!==t){g1&&console.log("Paused?",t,"context:"+this.alias);for(let e=0;e<this.scripts_pausedChanged.length;e++){const i=this.scripts_pausedChanged[e];i.activeAndEnabled&&i.onPausedChanged!==void 0&&(we.Current=this,i.onPausedChanged(t,this._wasPaused))}}return this._wasPaused=t,t}evaluatePaused(){return this.isInXR?!1:this.isPaused?!0:this.runInBackground?!1:!this.isVisibleToUser}renderRequiredTextures(){if(!this.mainCamera||!this._requireDepthTexture&&!this._requireColorTexture)return;if(!this._renderTarget){if(this._renderTarget=new h.WebGLRenderTarget(this.domWidth,this.domHeight),this._requireDepthTexture){const i=new h.DepthTexture(this.domWidth,this.domHeight);this._renderTarget.depthTexture=i}this._requireColorTexture&&(this._renderTarget.texture=new h.Texture,this._renderTarget.texture.generateMipmaps=!1,this._renderTarget.texture.minFilter=h.NearestFilter,this._renderTarget.texture.magFilter=h.NearestFilter,this._renderTarget.texture.format=h.RGBAFormat)}const t=this._renderTarget;t.texture&&(t.texture.colorSpace=this.renderer.outputColorSpace);const e=this.renderer.getRenderTarget();this.renderer.setRenderTarget(t),this.renderer.render(this.scene,this.mainCamera),this.renderer.setRenderTarget(e)}executeCoroutines(t){var i;if(this.coroutines[t]){const n=this.coroutines[t];for(let o=0;o<n.length;o++)try{const a=n[o];if(!a.comp||a.comp.destroyed||!a.main||a.comp.enabled===!1){y1&&console.log("Removing coroutine",a.comp,a.comp.enabled),n.splice(o,1),--o;continue}const c=a.chained;if(c&&c.length>0){const m=c[c.length-1].next();if(m.done&&c.pop(),e(m)&&(a.chained||(a.chained=[]),a.chained.push(m.value)),!m.done)continue}const d=a.main.next();if(d.done===!0){n.splice(o,1),--o;continue}const u=d.value;if(e(u)){if(u.next().done)continue;a.chained||(a.chained=[]),a.chained.push(u)}else if(u instanceof Promise){const f=u;a.chained||(a.chained=[]);const m=lv(f);(i=a.chained)==null||i.push(m);continue}}catch(a){console.error(a)}}function e(n){return!!(n&&n.next&&n.return)}}};let Q=we;r(Q,"_defaultTargetFramerate",{value:90,toString(){return this.value}}),r(Q,"_defaultWebglRendererParameters",{antialias:!0,alpha:!1,powerPreference:exports.DeviceUtilities.isiOS()||exports.DeviceUtilities.isMacOS()?"default":"high-performance",stencil:!0});const Fi=x("debuglicense"),yv=[];let er="basic";Fi&&console.log("License Type: "+er);function io(){switch(er){case"pro":case"enterprise":return!0}return!1}function lg(){switch(er){case"indie":return!0}return!1}function hn(){return io()||lg()}function w1(s){if(io()||lg())return s(!0);yv.push(s)}function x1(s){for(const t of yv)try{t(s)}catch{}}ce.registerCallback(he.ContextRegistered,s=>{P1(s.context),M1(),C1(s.context)});let no,nm=!1,Ul="";async function S1(){if(no)return no;if(er==="basic")try{const s="https://engine.needle.tools/licensing/check?location="+encodeURIComponent(window.location.href)+"&version="+ln+"&generator="+encodeURIComponent(wu),t=await fetch(s,{method:"GET"}).catch(e=>{Fi&&console.error("License check failed",e)});(t==null?void 0:t.status)===200?(nm=!1,Fi&&console.log("License check succeeded"),er="pro",x1(!0)):(t==null?void 0:t.status)===403?(nm=!0,Ul=await t.text()):Fi&&console.log("License check failed with status "+(t==null?void 0:t.status))}catch(s){Fi&&console.error("License check failed",s)}else Fi&&console.log('Runtime license check is skipped because license is already applied as "'+er+'"')}no=S1();async function C1(s){function t(){const n=document.createElement("div");n.className="needle-forbidden",n.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: all;
        zIndex: 2147483647;
        line-height: 1.5;
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        `;const o=n.style.cssText,a=document.createElement("div");n.appendChild(a),a.style.cssText=`
        position: absolute;
        left: 0;
        right: 0;
        top:0;
        bottom: 0;
        padding: 10%;
        color: white;
        font-size: 20px;
        font-family: sans-serif;
        text-align: center;
        pointer-events: all;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: rgba(0,0,0,.3);
        text-shadow: 0 0 2px black;
        `;const l=a.style.cssText,c=(Ul==null?void 0:Ul.length)>1?Ul:"This web application has been paused.<br/>You might be in violation of the Needle Engine terms of use.<br/>Please contact the Needle support if you think this is a mistake.";return a.innerHTML=c,setInterval(()=>{a.innerHTML!==c&&(a.innerHTML=c),a.parentNode!==n&&n.appendChild(a),n.style.cssText!==o&&(n.style.cssText=o),a.style.cssText!==l&&(a.style.cssText=l)},500),n}let e=t();const i=e.style.cssText;setInterval(()=>{var n;nm===!0&&(e.style.cssText!==i&&(e=t()),s.domElement.shadowRoot?e.parentNode!==s.domElement.shadowRoot&&((n=s.domElement.shadowRoot)==null||n.appendChild(e)):e.parentNode!=document.body&&document.body.appendChild(e))},500)}async function P1(s){try{if(hn()!==!0)return Af(s)}catch(t){return Fi&&console.log("License check failed",t),Af(s)}Fi&&Af(s)}async function Af(s){s.domElement.addEventListener("ready",()=>!0),await(no==null?void 0:no.catch(()=>{})),!hn()&&O1()}let Cy=0;async function O1(s){var a;const t=Date.now();if(t-Cy<2e3)return;Cy=t;const i=`
        position: relative;
        display: block;
        font-size: 18px;
        background-size: 20px;
        background-position: 10px 5px;
        background-repeat:no-repeat;
        background-image:url('data:image/webp;base64,UklGRrABAABXRUJQVlA4WAoAAAAQAAAAHwAAHwAAQUxQSKEAAAARN6CmbSM4WR7vdARON11EBDq3fLiNbVtVzpMCPlKAEzsx0Y/x+Ovuv4dn0EFE/ydAvz6YggXzgh5sVgXM/zOC/4sii7qgGvB5N7hmuQYwkvazWAu1JPW41FXSHq6pnaQWvqYH18Fc0j1hO/BFTtIeSBlJi5w6qIIO7IOrwhFsB2Yxukif0FTRLpXswHR8MxbslKe9VZsn/Ub5C7YFOpqSTABWUDgg6AAAAFAGAJ0BKiAAIAA+7VyoTqmkpCI3+qgBMB2JbACdMt69DwMIQBLhkTO6XwY00UEDK6cNIDnuNibPf0EgAP7Y1myuiQHLDsF/0h5unrGh6WAbv7aegg2ZMd3uRKfT/3SJztcaujYfTvMXspfCTmYcoO6a+vhC3ss4M8uM58t4siiu59I4aOl59e9Sr6xoxYlHf2v+NnBNpJYeJf8jABQAId/PXuBkLEFkiCucgSGEcfhvajql/j3reCGl0M5/9gQWy7ayNPs+wlvIxFnNfSlfuND4CZOCyxOHhRqOmHN4ULHo3tCSrUNvgAA=');
        background-max-size: 40px;
        margin-bottom: 5px;
        margin-top: .3em;
        margin-bottom: .5em;
        padding: .2em;
        padding-left: 25px;
        border-radius: .5em;
        border: 2px solid rgba(160,160,160,.3);
    `,o=`Needle Engine — No license active, commercial use is not allowed. Visit https://needle.tools/pricing for more information and licensing options! v${ln}`;(a=Q.Current)!=null&&a.xr?console.log(o):console.log("%c "+o,i)}async function M1(){var s;if(!window.crossOriginIsolated)try{const t="https://needle-engine-analytics-v2-r26roub2hq-lz.a.run.app";if(t){Fi&&console.log("Analytics backend url",t);const e=window.location.href.split("?")[0];let i="api/v2/new/request";t.endsWith("/")||(i="/"+i);const n=er,o=`${t}${i}`;Fi&&console.log("Sending non-commercial usage message to analytics backend",o);const a={license:n,url:e,hostname:window.location.hostname,pathname:window.location.pathname,version:ln,generator:wu,build_time:Um,public_key:Jl},l=(s=navigator.sendBeacon)==null?void 0:s.call(navigator,o,JSON.stringify(a));Fi&&console.log("Send beacon result",l)}}catch(t){Fi&&console.log("Failed to send non-commercial usage message to analytics backend",t)}}const zo=x("debugloading"),bl=x("debugloadingrendering"),Py=x("debuglicense");class R1{constructor(){r(this,"className");r(this,"additionalClasses")}}let vl=0,Oy;function cg(s){zo&&console.log(s.progress.loaded.toFixed(0)+"/"+s.progress.total.toFixed(0),s);const t=s.count,e=s.progress.total;e===0||e===void 0?(Oy!==s.name&&(vl=0),Oy=s.name,vl+=(1-vl)*.001,zo&&pe("Loading "+s.name+" did not report total size")):vl=s.progress.loaded/e;const i=s.index/t+vl/t;return z.clamp01(i)}const uu=class{constructor(t,e){r(this,"loadingProgress",0);r(this,"_element");r(this,"_progress",0);r(this,"_allowCustomLoadingElement",!0);r(this,"_loadingElement");r(this,"_loadingTextContainer",null);r(this,"_loadingBar",null);r(this,"_messageContainer",null);r(this,"_loadingElementOptions");r(this,"_progressLoop");this._element=t,this._loadingElementOptions=e}async onLoadingBegin(t){const e=this._element.shadowRoot||this._element;if(zo&&console.warn("Begin Loading"),!this._loadingElement){for(let i=0;i<e.children.length;i++){const n=e.children[i];if(n.classList.contains(uu.LoadingContainerClassName)){if(!this._allowCustomLoadingElement){zo&&console.warn("Remove custom loading container"),e.removeChild(n);continue}this._loadingElement=this.createLoadingElement(n)}}this._loadingElement||(this._loadingElement=this.createLoadingElement())}this._progress=0,this.loadingProgress=0,this._loadingElement.style.display="flex",e.appendChild(this._loadingElement),this.smoothProgressLoop(),this.setMessage(t??"")}onLoadingUpdate(t,e){var n;if(!((n=this._loadingElement)!=null&&n.parentNode))return;let i=0;typeof t=="number"?i=t:("index"in t&&(i=cg(t)),!e&&"name"in t&&this.setMessage("loading "+t.name)),this.loadingProgress=i,e&&this.setMessage(e),this.updateDisplay()}onLoadingFinished(){zo&&console.warn("Finished Loading"),bl||(this.loadingProgress=1,this.onDoneLoading())}setMessage(t){this._messageContainer&&(this._messageContainer.innerText=t)}smoothProgressLoop(){if(this._progressLoop)return;let t=1/12;bl&&(t=1/500,typeof bl=="number"&&(t*=bl)),this._progressLoop=setInterval(()=>{this.loadingProgress>=.95&&!bl&&(t=.9),this._progress=z.lerp(this._progress,this.loadingProgress,t*this.loadingProgress),this.updateDisplay()},t)}onDoneLoading(){this._loadingElement&&(zo&&console.log("Hiding loading element"),this._loadingElement.style.display="none",this._loadingElement.remove()),this._progressLoop&&clearInterval(this._progressLoop),this._progressLoop=null}updateDisplay(){const t=this._progress,e=(t*100).toFixed(0)+"%";this._loadingBar&&(this._loadingBar.style.width=t*100+"%"),this._loadingTextContainer&&(this._loadingTextContainer.textContent=e)}createLoadingElement(t){var g,_;zo&&!t&&console.log("Creating loading element"),this._loadingElement=t||document.createElement("div");let e=this._element.getAttribute("loading-style");(!e||e==="auto")&&(window.matchMedia("(prefers-color-scheme: dark)").matches?e="dark":e="light");const i=io();if(!t&&(this._loadingElement.style.position="absolute",this._loadingElement.style.width="100%",this._loadingElement.style.height="100%",this._loadingElement.style.left="0",this._loadingElement.style.top="0",e==="light"?this._loadingElement.style.backgroundColor="#ddd":this._loadingElement.style.backgroundColor="#222",this._loadingElement.style.display="flex",this._loadingElement.style.alignItems="center",this._loadingElement.style.justifyContent="center",this._loadingElement.style.zIndex=Number.MAX_SAFE_INTEGER.toString(),this._loadingElement.style.flexDirection="column",this._loadingElement.style.pointerEvents="none",this._loadingElement.style.color="white",this._loadingElement.style.fontFamily='system-ui, Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"',this._loadingElement.style.fontSize="1rem",e==="light"?this._loadingElement.style.color="rgba(0,0,0,.6)":this._loadingElement.style.color="rgba(255,255,255,.3)",i&&this._element)){const y=this._element.getAttribute("loading-background-color");y&&(this._loadingElement.style.backgroundColor=y);const b=this._element.getAttribute("loading-text-color");b&&(this._loadingElement.style.color=b)}const n=((g=this._loadingElementOptions)==null?void 0:g.className)??uu.LoadingContainerClassName;if(this._loadingElement.classList.add(n),(_=this._loadingElementOptions)!=null&&_.additionalClasses)for(const y of this._loadingElementOptions.additionalClasses)this._loadingElement.classList.add(y);const o=document.createElement("div");this._loadingElement.appendChild(o);const a=document.createElement("img"),l=120;if(a.style.width=`${l}px`,a.style.height=`${l}px`,a.style.paddingTop="20px",a.style.paddingBottom="10px",a.style.margin="0px",a.style.userSelect="none",a.style.objectFit="contain",a.style.transition="transform 1.5s ease-out, opacity .3s ease-in-out",a.style.transform="translateY(30px)",a.style.opacity="0.05",setTimeout(()=>{a.style.opacity="1",a.style.transform="translateY(0px)"},1),a.src=RS,i&&this._element){const y=this._element.getAttribute("loading-logo-src");y&&(a.src=y)}o.appendChild(a);const c=document.createElement("div");c.style.cssText=`
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        opacity: 0;
        transition: opacity 1s ease-in-out 4s;
        `,setTimeout(()=>{c.style.opacity="1"},1),this._loadingElement.appendChild(c);const d=document.createElement("div"),u=100;d.style.display="flex",d.style.width=u+"%",d.style.height="3px",d.style.position="absolute",d.style.left="0",d.style.bottom="0px",d.style.opacity="0",d.style.transition="opacity 1s ease-in-out 2s",setTimeout(()=>{d.style.opacity="1"},1),e==="light"?d.style.backgroundColor="rgba(0,0,0,.2)":d.style.backgroundColor="rgba(255,255,255,.2)",this._loadingElement.appendChild(d),this._loadingBar=document.createElement("div"),d.appendChild(this._loadingBar);const f=function(y){return z.lerp(0,u,y)+"%"};if(this._loadingBar.style.background=`linear-gradient(90deg, #204f49 ${f(0)}, #0BA398 ${f(.3)}, #66A22F ${f(.6)}, #D7DB0A ${f(1)})`,this._loadingBar.style.backgroundAttachment="fixed",this._loadingBar.style.width="0%",this._loadingBar.style.height="100%",i&&this._element){const y=this._element.getAttribute("primary-color"),b=this._element.getAttribute("secondary-color");y&&b?this._loadingBar.style.background=`linear-gradient(90deg, ${y} ${f(0)}, ${b} ${f(1)})`:y?this._loadingBar.style.background=y:b&&(this._loadingBar.style.background=b)}this._loadingTextContainer=document.createElement("div"),this._loadingTextContainer.style.display="flex",this._loadingTextContainer.style.justifyContent="center",this._loadingTextContainer.style.marginTop=".2rem",c.appendChild(this._loadingTextContainer);const m=document.createElement("div");if(this._messageContainer=m,m.style.display="flex",m.style.fontSize=".8rem",m.style.paddingTop=".1rem",m.style.justifyContent="center",c.appendChild(m),i&&this._element){const y=this._element.getAttribute("loading-text-color");y&&(m.style.color=y)}return this.handleRuntimeLicense(this._loadingElement),this._loadingElement}async handleRuntimeLicense(t){let e=hn();if(e)return;Py&&console.log("Loading UI has commercial license?",e);const i=document.createElement("div");i.style.paddingTop=".6em",i.style.fontSize=".8em",i.style.textTransform="uppercase",i.innerText=`NEEDLE ENGINE NON COMMERCIAL VERSION
CLICK HERE TO GET A LICENSE`,i.style.cursor="pointer",i.style.userSelect="none",i.style.textAlign="center",i.style.pointerEvents="all",i.addEventListener("click",()=>window.open("https://needle.tools/pricing","_self")),i.style.opacity="0",t.appendChild(i),!B()&&no&&(Py&&console.log("Waiting for runtime license check"),await no,e=hn()),!e&&(i.style.transition="opacity .5s ease-in-out",i.style.opacity="1")}};let rc=uu;r(rc,"LoadingContainerClassName","loading");const wl=x("debugoverlay"),bv="ar",k1="quit-ar";class E1{constructor(){r(this,"arContainer",null);r(this,"currentSession",null);r(this,"_createdAROnlyElements",[]);r(this,"_reparentedObjects",[]);r(this,"contentElement",null);r(this,"originalDomOverlayParent",null);r(this,"requestEndAR",()=>{this.onRequestedEndAR()})}get ARContainer(){return this.arContainer}onBegin(t,e,i){var n;if(this.currentSession=i,this.arContainer=e,exports.DeviceUtilities.isMozillaXR()){const o=t.domElement.children;for(let a=0;a<(o==null?void 0:o.length);a++){const l=o[a];if(!l||l===this.arContainer)return;this._reparentedObjects.push({el:l,previousParent:l.parentElement}),(n=this.arContainer)==null||n.appendChild(l)}e?(this.originalDomOverlayParent=e.parentNode,this.originalDomOverlayParent&&(console.log("Reparent DOM Overlay to body",e,e.style.display),e.style.display="",e.style.visibility="",document.body.appendChild(e))):console.warn("WebXRViewer: No DOM Overlay found")}this.ensureQuitARButton(this.arContainer)}onEnd(t){var e;for(const i of this._createdAROnlyElements)i.remove&&i.remove();for(const i of this._reparentedObjects){const n=i.el;(e=i.previousParent)==null||e.appendChild(n)}this._reparentedObjects.length=0,exports.DeviceUtilities.isMozillaXR()&&setTimeout(()=>{var a;const i=t.renderer.domElement;i&&((a=t.domElement.shadowRoot)==null||a.prepend(i));const n=document.querySelectorAll("*");for(var o=0;o<n.length;o++){const l=n[o];l&&l._displayChanged!==void 0&&l._displayWas!==void 0&&(l.style.display=l._displayWas)}},10)}createOverlayContainer(t){if(this.contentElement)return this.contentElement;wl&&console.log("Setup overlay container");const e=t.shadowRoot.querySelector(".content");this.contentElement=e;const i=t.shadowRoot.querySelector(".overlay-content");return i&&e.appendChild(i),wl&&!exports.DeviceUtilities.isMobileDevice()&&this.ensureQuitARButton(e),e}onRequestedEndAR(){this.currentSession&&(this.currentSession.end(),this.currentSession=null)}ensureQuitARButton(t){const e=document.createElement("slot");e.setAttribute("name","quit-ar"),this.appendElement(e,t),this._createdAROnlyElements.push(e),e.style.pointerEvents="auto";const i=document.querySelector(`.${k1}`);if(i){i.addEventListener("click",this.requestEndAR),wl&&i.addEventListener("click",()=>console.log("Clicked quit-ar button"));return}e.addEventListener("click",this.requestEndAR),wl&&e.addEventListener("click",()=>console.log("Clicked fallback close button"));const n=document.createElement("div");n.style.cssText=`
            position: fixed;
            top: 0;
            right: 0;
            z-index: 600;
            pointer-events: all;
        `,this.appendElement(n,e);var o=document.createElementNS("http://www.w3.org/2000/svg","svg");o.classList.add("quit-ar-button"),o.setAttribute("width","40px"),o.setAttribute("height","40px"),o.style.cssText=`
            background: rgba(255, 255, 255, .4);
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(0,0,0,.3);
            outline: 1px solid rgba(255, 255, 255, .6);
            display: flex;
            justify-content: center;
            align-items: center;
        `,n.appendChild(o);var a=document.createElementNS("http://www.w3.org/2000/svg","path");a.setAttribute("d","M 12,12 L 28,28 M 28,12 12,28"),a.setAttribute("stroke","#000000"),a.setAttribute("stroke-width","2px"),a.style.cssText=`
            /**filter: drop-shadow(0 0px 1.2px rgba(0,0,0,.7));**/
        `,o.appendChild(a),wl&&console.log("Created fallback close button",o,t)}appendElement(t,e){return e.shadowRoot?e.shadowRoot.appendChild(t):e.appendChild(t)}}const T1=x("debugdecoders");let Df=null;function vv(){if(!Df){const s=re.createLoaders(null);Df={dracoLoader:s.dracoLoader,ktx2Loader:s.ktx2Loader,meshoptDecoder:s.meshoptDecoder}}return Df}function My(s){s!==void 0&&typeof s=="string"&&re.setDracoDecoderLocation(s)}function Ry(s){if(s!==void 0&&typeof s=="string"&&s!=="js"){const t=vv();T1&&console.log("Setting draco decoder type to",s),t.dracoLoader.setDecoderConfig({type:s})}}function ky(s){s!==void 0&&typeof s=="string"&&re.setKTX2TranscoderLocation(s)}function Tu(s,t){const e=vv();return t.renderer?e.ktx2Loader.detectSupport(t.renderer):console.warn("No renderer provided to detect ktx2 support - loading KTX2 textures will probably fail"),re.addDracoAndKTX2Loaders(s),s.dracoLoader||s.setDRACOLoader(e.dracoLoader),s.ktx2Loader||s.setKTX2Loader(e.ktx2Loader),s.meshoptDecoder||s.setMeshoptDecoder(e.meshoptDecoder),re.configureLoader(s,{progressive:!0}),s}const yr=function(s){return p(s)},p=function(s){if(s===void 0&&(s=null),!Array.isArray(s))s=Ey(s);else for(let t=0;t<s.length;t++){const e=s[t];s[t]=Ey(e)}return function(t,e){if(!t){console.error("Found @serializable decorator without a target");return}typeof e!="string"&&(e=e.name),Object.getOwnPropertyDescriptor(t,"$serializedTypes")||(t.$serializedTypes={});const i=t.$serializedTypes=t.$serializedTypes||{};i[e]=s}};function Ey(s){var t,e;switch((e=(t=s==null?void 0:s.prototype)==null?void 0:t.constructor)==null?void 0:e.name){case"Number":case"String":case"Boolean":return null}return s}class S extends h.Object3D{constructor(){super(...arguments);r(this,"guid")}static isDestroyed(e){return cr(e)}static setActive(e,i,n=!0){e&&(sc(e,i),fd(e),i&&n&&E0(Q.Current,e))}static isActiveSelf(e){return Ua(e)}static isActiveInHierarchy(e){return J0(e)}static markAsInstancedRendered(e,i){ev(e,i)}static isUsingInstancing(e){return Ru(e)}static foreachComponent(e,i,n=!0){return hr(e,i,n)}static instantiateSynced(e,i){return e?eg(e,i):null}static instantiate(e,i=null){return"isAssetReference"in e,dr(e,i)}static destroySynced(e,i,n=!0){if(!e)return;const o=e;i=i??Q.Current,Gc(o,i.connection,n)}static destroy(e,i=!0){return Si(e,i)}static add(e,i,n){if(!(!e||!i)){if(e===i){console.warn("Can not add object to self",e);return}n||(n=Q.Current),i.add(e),sc(e,!0),fd(e),n?S.foreachComponent(e,o=>{Zm(o,n),!o.__internalDidAwakeAndStart&&n.new_script_start.includes(o)===!1&&n.new_script_start.push(o)},!0):console.warn("Missing context")}}static remove(e){var i;e&&((i=e.parent)==null||i.remove(e),sc(e,!1),fd(e),S.foreachComponent(e,n=>{bC(n)},!0))}static invokeOnChildren(e,i,...n){this.invoke(e,i,!0,n)}static invoke(e,i,n=!1,...o){e&&this.foreachComponent(e,a=>{const l=a[i];l&&typeof l=="function"&&(l==null||l.call(a,...o))},n)}static addNewComponent(e,i,n,o=!0){return wi(e,i,n,{callAwake:o})}static addComponent(e,i,n,o){return wi(e,i,n,o)}static moveComponent(e,i){return wi(e,i)}static removeComponent(e){return sg(e.gameObject,e),e}static getOrAddComponent(e,i){return qc(e,i)}static getComponent(e,i){return e===null?null:gr(e,i)}static getComponents(e,i,n=null){return e===null?n??[]:Xc(e,i,n)}static findByGuid(e,i){return og(e,i)}static findObjectOfType(e,i,n=!0){return Yc(e,i??Q.Current,n)}static findObjectsOfType(e,i){const n=[];return Z0(e,n,i),n}static getComponentInChildren(e,i){return Qc(e,i)}static getComponentsInChildren(e,i,n=null){return Fa(e,i,n??void 0)}static getComponentInParent(e,i){return Oc(e,i)}static getComponentsInParent(e,i,n=null){return Ou(e,i,n)}static getAllComponents(e){var o;const i=(o=e.userData)==null?void 0:o.components;return i?[...i]:[]}static*iterateComponents(e){var n;const i=(n=e==null?void 0:e.userData)==null?void 0:n.components;if(i&&Array.isArray(i))for(let o=0;o<i.length;o++)yield i[o]}}const gc=class{constructor(t){r(this,"__context");r(this,"__name");r(this,"gameObject");r(this,"guid","invalid");r(this,"sourceId");r(this,"__didAwake",!1);r(this,"__didStart",!1);r(this,"__didEnable",!1);r(this,"__isEnabled");r(this,"__destroyed",!1);r(this,"_eventListeners",new Map);this.__didAwake=!1,this.__didStart=!1,this.__didEnable=!1,this.__isEnabled=void 0,this.__destroyed=!1,this._internalInit(t)}get isComponent(){return!0}get context(){return this.__context??Q.Current}set context(t){this.__context=t}get scene(){return this.context.scene}get layer(){var t,e;return(e=(t=this.gameObject)==null?void 0:t.userData)==null?void 0:e.layer}get name(){var t,e;return(t=this.gameObject)!=null&&t.name?this.gameObject.name:(e=this.gameObject)==null?void 0:e.userData.name}set name(t){this.gameObject?(this.gameObject.userData||(this.gameObject.userData={}),this.gameObject.userData.name=t,this.__name=t):this.__name=t}get tag(){var t;return(t=this.gameObject)==null?void 0:t.userData.tag}set tag(t){this.gameObject&&(this.gameObject.userData||(this.gameObject.userData={}),this.gameObject.userData.tag=t)}get static(){var t;return(t=this.gameObject)==null?void 0:t.userData.static}set static(t){this.gameObject&&(this.gameObject.userData||(this.gameObject.userData={}),this.gameObject.userData.static=t)}get activeAndEnabled(){return!(this.destroyed||this.__isEnabled===!1||!this.__isActiveInHierarchy)}get __isActive(){return this.gameObject.visible}get __isActiveInHierarchy(){if(!this.gameObject)return!1;const t=this.gameObject[ps];return t===void 0?!0:t}set __isActiveInHierarchy(t){this.gameObject&&(this.gameObject[ps]=t)}awake(){}onEnable(){}onDisable(){}onDestroy(){this.__destroyed=!0}startCoroutine(t,e=ve.Update){return this.context.registerCoroutineUpdate(this,t,e)}stopCoroutine(t,e=ve.Update){this.context.unregisterCoroutineUpdate(t,e)}get destroyed(){return this.__destroyed}destroy(){this.__destroyed||this.__internalDestroy()}get __internalDidAwakeAndStart(){return this.__didAwake&&this.__didStart}__internalNewInstanceCreated(t){return this.__didAwake=!1,this.__didStart=!1,this.__didEnable=!1,this.__isEnabled=void 0,this.__destroyed=!1,this._internalInit(t),this}_internalInit(t){if(typeof t=="object")for(const e of Object.keys(t)){const i=t[e];typeof i!="function"&&(this[e]=i)}}__internalAwake(){this.__didAwake||(this.__didAwake=!0,this.awake())}__internalStart(){this.__didStart||(this.__didStart=!0,this.start&&this.start())}__internalEnable(t){return this.__destroyed?(B()&&console.warn("[Needle Engine Dev] Trying to enable destroyed component"),!1):this.__didAwake?this.__didEnable?(t!==!0&&(this.__isEnabled=!0),!1):(this.__didEnable=!0,this.__isEnabled=!0,this.onEnable(),!0):!1}__internalDisable(t){if(this.__didAwake){if(!this.__didEnable){t!==!0&&(this.__isEnabled=!1);return}this.__didEnable=!1,this.__isEnabled=!1,this.onDisable()}}__internalDestroy(){var t;this.__destroyed||(this.__destroyed=!0,this.__didAwake&&((t=this.onDestroy)==null||t.call(this),this.dispatchEvent(new CustomEvent("destroyed",{detail:this}))),Y0(this))}get enabled(){return typeof this.__isEnabled=="boolean"?this.__isEnabled:!0}set enabled(t){if(this.__destroyed){B()&&console.warn(`[Needle Engine Dev] Trying to ${t?"enable":"disable"} destroyed component`);return}if(typeof t=="number"&&(t>=.5?t=!0:t=!1),!this.__didAwake){this.__isEnabled=t;return}t?this.__internalEnable():this.__internalDisable()}get worldPosition(){return Z(this.gameObject)}set worldPosition(t){it(this.gameObject,t)}setWorldPosition(t,e,i){ar(this.gameObject,t,e,i)}get worldQuaternion(){return _e(this.gameObject)}set worldQuaternion(t){Wi(this.gameObject,t)}setWorldQuaternion(t,e,i,n){Am(this.gameObject,t,e,i,n)}get worldEuler(){return Dm(this.gameObject)}set worldEuler(t){Lm(this.gameObject,t)}get worldRotation(){return this.gameObject.worldRotation}set worldRotation(t){this.setWorldRotation(t.x,t.y,t.z,!0)}setWorldRotation(t,e,i,n=!0){Vc(this.gameObject,t,e,i,n)}get forward(){return gc._forward.set(0,0,-1).applyQuaternion(this.worldQuaternion)}get right(){return gc._right.set(1,0,0).applyQuaternion(this.worldQuaternion)}get up(){return gc._up.set(0,1,0).applyQuaternion(this.worldQuaternion)}addEventListener(t,e){this._eventListeners[t]=this._eventListeners[t]||[],this._eventListeners[t].push(e)}removeEventListener(t,e){if(!this._eventListeners[t])return;const i=this._eventListeners[t].indexOf(e);i>=0&&this._eventListeners[t].splice(i,1)}dispatchEvent(t){if(!t||!this._eventListeners[t.type])return!1;const e=this._eventListeners[t.type];for(let i=0;i<e.length;i++)e[i](t);return!1}};let D=gc;r(D,"_forward",new h.Vector3),r(D,"_right",new h.Vector3),r(D,"_up",new h.Vector3);const A1=Object.freeze(Object.defineProperty({__proto__:null,Behaviour:D,Component:D,GameObject:S},Symbol.toStringTag,{value:"Module"}));var D1=Object.defineProperty,L1=Object.getOwnPropertyDescriptor,wv=(s,t,e,i)=>{for(var n=i>1?void 0:i?L1(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&D1(t,e,n),n};class Zc extends D{constructor(){super(...arguments);r(this,"from");r(this,"to");r(this,"width",0);r(this,"centered",!0);r(this,"_centerPos")}awake(){this._centerPos=new h.Vector3}update(){if(!this.from||!this.to)return;const e=Z(this.from).clone(),i=Z(this.to).clone(),n=e.distanceTo(i);this._centerPos.copy(e),this._centerPos.add(i),this._centerPos.multiplyScalar(.5),it(this.gameObject,this.centered?this._centerPos:e),this.gameObject.lookAt(Z(this.to).clone()),this.gameObject.scale.set(this.width,this.width,n)}}wv([p(S)],Zc.prototype,"from",2);wv([p(S)],Zc.prototype,"to",2);var I1=Object.defineProperty,j1=Object.getOwnPropertyDescriptor,br=(s,t,e,i)=>{for(var n=i>1?void 0:i?j1(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&I1(t,e,n),n};const Ls=x("debuganimation");let xv=class{constructor(){r(this,"x");r(this,"y")}};class kt extends D{constructor(){super(...arguments);r(this,"playAutomatically",!0);r(this,"randomStartTime",!0);r(this,"minMaxSpeed");r(this,"minMaxOffsetNormalized");r(this,"loop",!0);r(this,"clampWhenFinished",!1);r(this,"_tempAnimationClipBeforeGameObjectExisted",null);r(this,"_tempAnimationsArray");r(this,"mixer");r(this,"_actions");r(this,"_handles")}get isAnimationComponent(){return!0}addClip(e){this.animations||(this.animations=[]),this.animations.push(e)}get time(){if(this.actions){for(const e of this.actions)if(e.isRunning())return e.time}return 0}set time(e){if(this.actions)for(const i of this.actions)i.time=e}get clip(){var e;return(e=this.animations)!=null&&e.length?this.animations[0]:null}set clip(e){if(!this.__didAwake){Ls&&console.warn("Assign clip during serialization",e),this._tempAnimationClipBeforeGameObjectExisted=e;return}e&&(this.gameObject.animations||(this.gameObject.animations=[]),!this.animations.includes(e)&&(this.animations.length>0?this.animations.splice(0,0,e):this.animations.push(e)))}set clips(e){this.animations=e}set animations(e){e==null||!Array.isArray(e)||(this.gameObject?this.gameObject.animations=e:this._tempAnimationsArray=e)}get animations(){return this.gameObject.animations||this._tempAnimationsArray||[]}get actions(){return this._actions}set actions(e){this._actions=e}awake(){this.mixer=void 0,Ls&&console.log("Animation Awake",this.name,this),this._tempAnimationsArray&&(this.animations=this._tempAnimationsArray,this._tempAnimationsArray=void 0),this._tempAnimationClipBeforeGameObjectExisted&&(this.clip=this._tempAnimationClipBeforeGameObjectExisted,this._tempAnimationClipBeforeGameObjectExisted=null),this.actions=[],this._handles=[]}onEnable(){var e;if(this.playAutomatically&&((e=this.animations)==null?void 0:e.length)>0){const i=Math.floor(Math.random()*this.animations.length),n=this.animations[i];this.play(i,{exclusive:!0,fadeDuration:0,startTime:this.randomStartTime?Math.random()*n.duration:0,loop:this.loop,clampWhenFinished:this.clampWhenFinished})}}update(){this.mixer&&(this.mixer.update(this.context.time.deltaTime),this._handles.forEach(e=>e.update()))}onDisable(){this.mixer&&this.mixer.stopAllAction()}onDestroy(){this.context.animations.unregisterAnimationMixer(this.mixer)}getAction(e){var i;return((i=this.actions)==null?void 0:i.find(n=>n.getClip().name===e))||null}get isPlaying(){if(this.actions){for(let e=0;e<this.actions.length;e++)if(this.actions[e].isRunning())return!0}return!1}stopAll(e){if(this.actions)for(const i of this.actions)e!=null&&e.fadeDuration?i.fadeOut(e.fadeDuration):i.stop()}stop(e,i){if(e===void 0){this.stopAll();return}else if(typeof e=="number"){if(e>=this.animations.length){Ls&&console.log("No animation at index",e);return}e=this.animations[e]}else typeof e=="string"&&(e=this.animations.find(o=>o.name===e));if(!e){console.error("Could not find clip",e);return}const n=this.actions.find(o=>o.getClip()===e);if(!n){console.error("Could not find action",e);return}i!=null&&i.fadeDuration?n.fadeOut(i.fadeDuration):n.stop()}pause(e,i=!1){if(e===void 0){for(const o of this.actions)o.paused=!i;return}else if(typeof e=="number"){if(e>=this.animations.length){Ls&&console.log("No animation at index",e);return}e=this.animations[e]}else typeof e=="string"&&(e=this.animations.find(o=>o.name===e));if(!e){console.error("Could not find clip",e);return}const n=this.actions.find(o=>o.getClip()===e);if(!n){console.error("Could not find action",e);return}n.paused=!i}resume(){for(const e of this.actions)e.paused=!1}play(e=0,i){if(Ls&&console.log("PLAY",e),this.ensureMixer(),!this.mixer){Ls&&console.warn("Missing mixer",this);return}e===void 0&&(e=0);let n=e;if(typeof e=="number"){if(e>=this.animations.length){Ls&&console.log("No animation at index",e);return}n=this.animations[e]}else typeof e=="string"&&(n=this.animations.find(a=>a.name===e));if(!n){console.error("Could not find clip",e);return}i||(i={});for(const a of this.actions)if(a.getClip()===n)return this.internalOnPlay(a,i);if(!n.tracks){console.warn("Clip is no AnimationClip",n);return}const o=this.mixer.clipAction(n);return this.actions.push(o),this.internalOnPlay(o,i)}internalOnPlay(e,i){var n=this.actions.find(l=>l===e);if(n===e&&n.isRunning()&&n.time<n.getClip().duration){const l=this.tryFindHandle(e);if(n.paused&&(n.paused=!1),l)return l.waitForFinish()}if(i.loop===void 0&&(i.loop=this.loop),i.clampWhenFinished===void 0&&(i.clampWhenFinished=this.clampWhenFinished),i.minMaxOffsetNormalized===void 0&&this.randomStartTime&&(i.minMaxOffsetNormalized=this.minMaxOffsetNormalized),i.minMaxSpeed===void 0&&(i.minMaxSpeed=this.minMaxSpeed),(i==null?void 0:i.exclusive)??!0)for(const l of this.actions)l!=n&&(i.fadeDuration?l.fadeOut(i.fadeDuration):l.stop());if(i!=null&&i.fadeDuration&&e.fadeIn(i.fadeDuration),e.enabled=!0,(i==null?void 0:i.startTime)!=null)e.time=i.startTime;else if(i!=null&&i.minMaxOffsetNormalized&&i.minMaxOffsetNormalized.x!=0&&i.minMaxOffsetNormalized.y!=0){const l=e.getClip();e.time=z.lerp(i.minMaxOffsetNormalized.x,i.minMaxOffsetNormalized.y,Math.random())*l.duration}else e.time>=e.getClip().duration&&(e.time=0);i!=null&&i.minMaxSpeed?e.timeScale=z.lerp(i.minMaxSpeed.x,i.minMaxSpeed.y,Math.random()):e.timeScale=(i==null?void 0:i.speed)??1,(i==null?void 0:i.loop)!=null?e.loop=i.loop?h.LoopRepeat:h.LoopOnce:e.loop=h.LoopOnce,i!=null&&i.clampWhenFinished&&(e.clampWhenFinished=!0),e.paused=!1,e.play(),Ls&&console.log("PLAY",e.getClip().name,e);const a=new B1(e,this.mixer,i,l=>{this._handles.splice(this._handles.indexOf(a),1)});return this._handles.push(a),a.waitForFinish()}tryFindHandle(e){for(const i of this._handles)if(i.action===e)return i}ensureMixer(){if(!this.mixer){const e="animationMixer";this.gameObject[e]&&(this.mixer=this.gameObject[e]),(!this.mixer||!this.mixer.clipAction)&&(this.mixer=new h.AnimationMixer(this.gameObject),this.gameObject[e]=this.mixer)}this.context.animations.registerAnimationMixer(this.mixer)}}br([p()],kt.prototype,"playAutomatically",2);br([p()],kt.prototype,"randomStartTime",2);br([p(xv)],kt.prototype,"minMaxSpeed",2);br([p(xv)],kt.prototype,"minMaxOffsetNormalized",2);br([p()],kt.prototype,"loop",2);br([p()],kt.prototype,"clampWhenFinished",2);br([p(h.AnimationClip)],kt.prototype,"clips",1);class B1{constructor(t,e,i,n){r(this,"mixer");r(this,"action");r(this,"promise",null);r(this,"_options");r(this,"_resolveCallback",null);r(this,"_resolvedOrRejectedCallback");r(this,"onFinished",t=>{t.action===this.action&&this.onResolve()});this.action=t,this.mixer=e,this._resolvedOrRejectedCallback=n,this._options=i}waitForFinish(){return this.promise?this.promise:(this.promise=new Promise(t=>{this._resolveCallback=t}),this.mixer.addEventListener("finished",this.onFinished),this.promise)}update(){this._options&&this._options.endTime!==void 0&&this.action.time>this._options.endTime&&(this._options.loop===!0?this.action.time=this._options.startTime??0:(this.action.time=this._options.endTime,this.action.timeScale=0,this.onResolve()))}onResolve(){var t,e;this.dispose(),(t=this._resolvedOrRejectedCallback)==null||t.call(this,this),(e=this._resolveCallback)==null||e.call(this,this.action)}dispose(){this.mixer.removeEventListener("finished",this.onFinished)}}const vd=Symbol("objectIsAnimatedData");function Ty(s,t,e){if(!s)return;if(s[vd]===void 0){if(!e)return;s[vd]=new Set}const i=s[vd];e?i.add(t):i.has(t)&&i.delete(t)}function F1(s){if(!s)return!1;const t=s[vd];return t!==void 0&&t.size>0}class U1{constructor(){r(this,"_context")}get context(){return this._context??Q.Current}get isStateMachineBehaviour(){return!0}}class zl{constructor(t,e,i,n){r(this,"name");r(this,"nameHash");r(this,"normalizedTime");r(this,"length");r(this,"speed");r(this,"action");r(this,"hasTransitions");var o;this.name=t.name,this.nameHash=t.hash,this.normalizedTime=e,this.length=i,this.speed=n,this.action=t.motion.action||null,this.hasTransitions=((o=t.transitions)==null?void 0:o.length)>0||!1}}function Sv(s,t){return{name:"Empty",isLooping:!1,guid:(t==null?void 0:t.generateUUID())??h.MathUtils.generateUUID(),index:-1,clip:new h.AnimationClip(s,0,[])}}var Ws=(s=>(s[s.If=1]="If",s[s.IfNot=2]="IfNot",s[s.Greater=3]="Greater",s[s.Less=4]="Less",s[s.Equals=6]="Equals",s[s.NotEqual=7]="NotEqual",s))(Ws||{}),hg=(s=>(s[s.Float=1]="Float",s[s.Int=3]="Int",s[s.Bool=4]="Bool",s[s.Trigger=9]="Trigger",s))(hg||{});const Ke=x("debuganimatorcontroller"),Fh=x("debugrootmotion");class $i{constructor(t){r(this,"_speed",1);r(this,"normalizedStartOffset",0);r(this,"animator");r(this,"model");r(this,"_mixer");r(this,"_activeState");r(this,"_activeStates",[]);r(this,"_heldActions",[]);r(this,"rootMotionHandler");this.model=t,Ke&&console.log(this)}static createFromClips(t,e={looping:!1,autoTransition:!0,transitionDuration:0}){const i=[];for(let a=0;a<t.length;a++){const l=t[a],c=[];if(e.autoTransition!==!1){const u=e.transitionDuration??0,f=u/l.duration;let m=a;(e.autoTransition===void 0||e.autoTransition===!0)&&(m=(a+1)%t.length),c.push({exitTime:1-f,offset:0,duration:u,hasExitTime:!0,destinationState:m,conditions:[]})}const d={name:l.name,hash:a,motion:{name:l.name,clip:l,isLooping:(e==null?void 0:e.looping)??!1},transitions:c,behaviours:[]};i.push(d)}const n={name:"AnimatorController",guid:new vt(Date.now()).generateUUID(),parameters:[],layers:[{name:"Base Layer",stateMachine:{defaultState:0,states:i}}]};return new $i(n)}play(t,e=-1,i=Number.NEGATIVE_INFINITY,n=0){if(e<0)e=0;else if(e>=this.model.layers.length){console.warn("invalid layer");return}const a=this.model.layers[e].stateMachine;for(const l of a.states)if(l.name===t||l.hash===t){Ke&&console.log("transition to ",l),this.transitionTo(l,n,i);return}console.warn("Could not find "+t+" to play")}reset(){this.setStartTransition()}setBool(t,e){var n,o;const i=typeof t=="string"?"name":"hash";return(o=(n=this.model)==null?void 0:n.parameters)==null?void 0:o.filter(a=>a[i]===t).forEach(a=>a.value=e)}getBool(t){var i,n,o;const e=typeof t=="string"?"name":"hash";return((o=(n=(i=this.model)==null?void 0:i.parameters)==null?void 0:n.find(a=>a[e]===t))==null?void 0:o.value)??!1}setFloat(t,e){var o,a;const i=typeof t=="string"?"name":"hash",n=(a=(o=this.model)==null?void 0:o.parameters)==null?void 0:a.filter(l=>l[i]===t);return n.forEach(l=>l.value=e),(n==null?void 0:n.length)>0}getFloat(t){var i,n,o;const e=typeof t=="string"?"name":"hash";return((o=(n=(i=this.model)==null?void 0:i.parameters)==null?void 0:n.find(a=>a[e]===t))==null?void 0:o.value)??0}setInteger(t,e){var n,o;const i=typeof t=="string"?"name":"hash";return(o=(n=this.model)==null?void 0:n.parameters)==null?void 0:o.filter(a=>a[i]===t).forEach(a=>a.value=e)}getInteger(t){var i,n,o;const e=typeof t=="string"?"name":"hash";return((o=(n=(i=this.model)==null?void 0:i.parameters)==null?void 0:n.find(a=>a[e]===t))==null?void 0:o.value)??0}setTrigger(t){var i,n;Ke&&console.log("SET TRIGGER",t);const e=typeof t=="string"?"name":"hash";return(n=(i=this.model)==null?void 0:i.parameters)==null?void 0:n.filter(o=>o[e]===t).forEach(o=>o.value=!0)}resetTrigger(t){var i,n;const e=typeof t=="string"?"name":"hash";return(n=(i=this.model)==null?void 0:i.parameters)==null?void 0:n.filter(o=>o[e]===t).forEach(o=>o.value=!1)}getTrigger(t){var i,n,o;const e=typeof t=="string"?"name":"hash";return((o=(n=(i=this.model)==null?void 0:i.parameters)==null?void 0:n.find(a=>a[e]===t))==null?void 0:o.value)??!1}isInTransition(){return this._activeStates.length>1}setSpeed(t){this._speed=t}FindState(t){return this.findState(t)}findState(t){if(!t)return null;if(Array.isArray(this.model.layers)){for(const e of this.model.layers)for(const i of e.stateMachine.states)if(i.name===t||i.hash==t)return i}return null}getCurrentStateInfo(){if(!this._activeState)return null;const t=this._activeState.motion.action;if(!t)return null;const e=this._activeState.motion.clip.duration,i=e<=0?0:Math.abs(t.time/e);return new zl(this._activeState,i,e,this._speed)}get currentAction(){if(!this._activeState)return null;const t=this._activeState.motion.action;return t||null}get context(){var t;return(t=this.animator)==null?void 0:t.context}get mixer(){return this._mixer}dispose(){var t;if(this._mixer.stopAllAction(),this.animator){this._mixer.uncacheRoot(this.animator.gameObject);for(const e of this._activeStates)e.motion.clip&&this.mixer.uncacheAction(e.motion.clip,this.animator.gameObject)}(t=this.context)==null||t.animations.unregisterAnimationMixer(this._mixer)}bind(t){var e,i;t?this.animator!==t&&(this._mixer&&(this._mixer.stopAllAction(),(e=this.context)==null||e.animations.unregisterAnimationMixer(this._mixer)),this.animator=t,this._mixer=new h.AnimationMixer(this.animator.gameObject),(i=this.context)==null||i.animations.registerAnimationMixer(this._mixer),this.createActions(this.animator)):console.error("AnimatorController.bind: animator is null")}clone(){if(typeof this.model=="string")return console.warn("AnimatorController has not been resolved, can not create model from string",this.model),null;Ke&&console.warn("AnimatorController clone()",this.model);const t=Fc(this.model,(i,n,o)=>o==null?!0:!(o.type==="Object3D"||o.isObject3D===!0||Qb(o)||o.tracks!==void 0||o instanceof $i));return console.assert(t!==this.model),new $i(t)}update(t){var i,n;if(!this.animator)return;this.evaluateTransitions(),this.updateActiveStates(t);const e=this.animator.context.time.deltaTime;this.animator.applyRootMotion&&((i=this.rootMotionHandler)==null||i.onBeforeUpdate(t)),this._mixer.update(e),this.animator.applyRootMotion&&((n=this.rootMotionHandler)==null||n.onAfterUpdate(t))}get activeState(){return this._activeState}updateActiveStates(t){for(let e=0;e<this._activeStates.length;e++){const i=this._activeStates[e],n=i.motion;if(!n.action)this._activeStates.splice(e,1),e--;else{const o=n.action;o.weight=t,o.getEffectiveWeight()<=0&&!o.isRunning()&&(Ke&&console.debug("REMOVE",i.name,o.getEffectiveWeight(),o.isRunning(),o.isScheduled()),this._activeStates.splice(e,1),e--)}}}setStartTransition(){var t;this.model.layers.length>1&&(Ke||B())&&console.warn("Multiple layers are not supported yet "+((t=this.animator)==null?void 0:t.name));for(const e of this.model.layers){const i=e.stateMachine;i.defaultState===void 0&&(Ke&&console.warn("AnimatorController default state is undefined, will assign state 0 as default",e),i.defaultState=0);const n=i.states[i.defaultState];this.transitionTo(n,0,this.normalizedStartOffset);break}}evaluateTransitions(){var o;let t=!1;if(!this._activeState){if(this.setStartTransition(),!this._activeState)return;t=!0}const e=this._activeState,i=e.motion.action;for(const a of e.transitions){if(!a.hasExitTime&&a.conditions.length<=0)continue;let l=!0;for(const c of a.conditions)if(!this.evaluateCondition(c)){l=!1;break}if(l)if(i){const c=e.motion.clip.duration,d=c<=0?1:Math.abs(i.time/c);let u=a.exitTime;i.timeScale<0&&(u=1-u);let f=!1;if(a.hasExitTime?i.timeScale>0?f=d>=a.exitTime:i.timeScale<0&&(f=1-d>=a.exitTime):f=!0,f){for(const m of a.conditions){const g=this.model.parameters.find(_=>_.name===m.parameter);(g==null?void 0:g.type)===hg.Trigger&&g.value&&(g.value=!1)}if(i.clampWhenFinished=!0,Ke){const m=this.getState(a.destinationState,0);console.log(`Transition to ${a.destinationState} / ${m==null?void 0:m.name}`,a,`
Timescale: `+i.timeScale,`
Normalized time: `+d.toFixed(3),`
Exit Time: `+u,a.hasExitTime)}this.transitionTo(a.destinationState,a.duration,a.offset);return}}else{this.transitionTo(a.destinationState,a.duration,a.offset);return}}i&&this.setTimescale(i,e);let n=!1;if(e.motion.isLooping&&i&&(i.time>=i.getClip().duration?(n=!0,i.reset(),i.time=0,i.play()):i.time<=0&&i.timeScale<0&&(n=!0,i.reset(),i.time=i.getClip().duration,i.play())),!n&&e&&!t&&i&&this.animator&&e.behaviours){const a=i==null?void 0:i.getClip().duration,l=i.time/a,c=new zl(this._activeState,l,a,this._speed);for(const d of e.behaviours)d.instance&&((o=d.instance.onStateUpdate)==null||o.call(d.instance,this.animator,c,0))}}setTimescale(t,e){let i=e.speed??1;e.speedParameter&&(i*=this.getFloat(e.speedParameter)),i!==void 0&&(t.timeScale=i*this._speed)}getState(t,e){return typeof t=="number"&&(t==-1&&(t=this.model.layers[e].stateMachine.defaultState,t===void 0&&(Ke&&console.warn("AnimatorController default state is undefined: ",this.model,"Layer: "+e),t=0)),t=this.model.layers[e].stateMachine.states[t]),t}releaseHeldActions(t){for(const e of this._heldActions)e.fadeOut(t);this._heldActions.length=0}transitionTo(t,e,i){var u,f,m,g,_,y,b,v;if(!this.animator)return;const n=0;if(t=this.getState(t,n),!(t!=null&&t.motion)||!t.motion.clip||!(t.motion.clip instanceof h.AnimationClip))return;const o=this._activeState===t;if(o){const w=t.motion;if(!w.action_loopback&&w.clip){const P=this.rootMotionHandler?this.animator.gameObject.matrix.clone():null;this._mixer.uncacheAction(w.clip,this.animator.gameObject),P&&P.decompose(this.animator.gameObject.position,this.animator.gameObject.quaternion,this.animator.gameObject.scale),w.action_loopback=this.createAction(w.clip)}}if((u=this._activeState)!=null&&u.behaviours&&this._activeState.motion.action){const w=(f=this._activeState)==null?void 0:f.motion.clip.duration,P=this._activeState.motion.action.time/w,k=new zl(this._activeState,P,w,this._speed);for(const O of this._activeState.behaviours)(g=(m=O.instance)==null?void 0:m.onStateExit)==null||g.call(O.instance,this.animator,k,n)}const a=(_=this._activeState)==null?void 0:_.motion.action;o&&(t.motion.action=t.motion.action_loopback,t.motion.action_loopback=a);const l=this._activeState;this._activeState=t;const c=(y=t.motion)==null?void 0:y.action,d=t.motion.clip;if((d==null?void 0:d.duration)<=0&&d.tracks.length<=0?a&&this._heldActions.push(a):a&&(a.fadeOut(e),this.releaseHeldActions(e)),c){if(i=Math.max(0,Math.min(1,i)),t.cycleOffsetParameter){let P=this.getFloat(t.cycleOffsetParameter);typeof P=="number"?(P<0&&(P+=1),i+=P,i%=1):Ke&&console.warn("AnimatorController cycle offset parameter is not a number",t.cycleOffsetParameter)}else typeof t.cycleOffset=="number"&&(i+=t.cycleOffset,i%=1);c.isRunning()&&c.stop(),c.reset(),c.enabled=!0,this.setTimescale(c,t);const w=t.motion.clip.duration;if(c.time=o?0:i*w,c.timeScale<0&&(c.time=w-c.time),c.clampWhenFinished=!0,c.setLoop(h.LoopOnce,0),e>0?c.fadeIn(e):c.weight=1,c.play(),this.rootMotionHandler&&this.rootMotionHandler.onStart(c),this._activeStates.includes(t)||this._activeStates.push(t),this._activeState.behaviours){const P=new zl(t,i,w,this._speed);for(const k of this._activeState.behaviours)(v=(b=k.instance)==null?void 0:b.onStateEnter)==null||v.call(k.instance,this.animator,P,n)}}else Ke&&(t.__warned_no_motion||(t.__warned_no_motion=!0,console.warn("No action",t.motion,this)));Ke&&console.log("TRANSITION FROM "+(l==null?void 0:l.name)+" TO "+t.name,e,a,c,c==null?void 0:c.getEffectiveTimeScale(),c==null?void 0:c.getEffectiveWeight(),c==null?void 0:c.isRunning(),c==null?void 0:c.isScheduled(),c==null?void 0:c.paused)}createAction(t){var i,n;if(this._mixer.existingAction(t)&&this._mixer.uncacheAction(t,(i=this.animator)==null?void 0:i.gameObject),(n=this.animator)!=null&&n.applyRootMotion){this.rootMotionHandler||(this.rootMotionHandler=new z1(this));const o=this.animator.gameObject;return this.rootMotionHandler.createClip(this._mixer,o,t)}else return this._mixer.clipAction(t)}evaluateCondition(t){const e=this.model.parameters.find(i=>i.name===t.parameter);if(!e)return!1;switch(t.mode){case Ws.If:return e.value===!0;case Ws.IfNot:return e.value===!1;case Ws.Greater:return e.value>t.threshold;case Ws.Less:return e.value<t.threshold;case Ws.Equals:return e.value===t.threshold;case Ws.NotEqual:return e.value!==t.threshold}return!1}createActions(t){var e,i,n,o;Ke&&console.log("AnimatorController createActions",this.model);for(const a of this.model.layers){const l=a.stateMachine;for(let c=0;c<l.states.length;c++){const d=l.states[c];d.transitions||(d.transitions=[]);for(const u of d.transitions)u.conditions||(u.conditions=[]);if(d.motion||(Ke&&console.warn("No motion",d),d.motion=Sv(d.name)),this.animator&&d.motion.clips){const u=(e=d.motion.clips)==null?void 0:e.find(f=>{var m,g;return f.node.name===((g=(m=this.animator)==null?void 0:m.gameObject)==null?void 0:g.name)});u?d.motion.clip=u.clip:(Ke||B())&&console.warn('Could not find clip for animator "'+((n=(i=this.animator)==null?void 0:i.gameObject)==null?void 0:n.name)+'"',d.motion.clips.map(f=>f.node.name))}if(!d.motion.clip){Ke&&console.warn("No clip assigned to state",d);const u=new h.AnimationClip(void 0,void 0,[]);d.motion.clip=u}if((o=d.motion)!=null&&o.clip){const u=d.motion.clip;if(u instanceof h.AnimationClip){const f=this.createAction(u);d.motion.action=f}else(Ke||B())&&console.warn("No valid animationclip assigned",d)}if(d.behaviours&&Array.isArray(d.behaviours))for(const u of d.behaviours){if(!(u!=null&&u.typeName))continue;const f=R.get(u.typeName);if(f){const m=new f;m.isStateMachineBehaviour&&(m._context=this.context??void 0,Da(m,u.properties),u.instance=m),Ke&&console.log("Created animator controller behaviour",d.name,u.typeName,u.properties,m)}else(Ke||B())&&console.warn("Could not find AnimatorBehaviour type: "+u.typeName)}}}}*enumerateActions(){if(this.model.layers)for(const t of this.model.layers){const e=t.stateMachine;for(let i=0;i<e.states.length;i++){const n=e.states[i];n!=null&&n.motion&&(n.motion.action&&(yield n.motion.action),n.motion.action_loopback&&(yield n.motion.action_loopback))}}}}class Ay{constructor(t,e){r(this,"track");r(this,"createdInterpolant");r(this,"originalEvaluate");r(this,"customEvaluate");this.track=t;const i=t,n=i.createInterpolant.bind(t);i.createInterpolant=()=>(i.createInterpolant=n,this.createdInterpolant=n(),this.originalEvaluate=this.createdInterpolant.evaluate.bind(this.createdInterpolant),this.customEvaluate=o=>{if(!this.originalEvaluate)return;const a=this.originalEvaluate(o);return e(o,a)},this.createdInterpolant.evaluate=this.customEvaluate,this.createdInterpolant)}dispose(){this.createdInterpolant&&this.originalEvaluate&&(this.createdInterpolant.evaluate=this.originalEvaluate),this.track=void 0,this.createdInterpolant=null,this.originalEvaluate=void 0,this.customEvaluate=void 0}}const et=class{constructor(t,e,i,n,o){r(this,"_action");r(this,"root");r(this,"clip");r(this,"positionWrapper",null);r(this,"rotationWrapper",null);r(this,"context");r(this,"positionChange",new h.Vector3);r(this,"rotationChange",new h.Quaternion);r(this,"_prevTime",0);if(this.context=t,this.root=e,this.clip=i,et.firstKeyframeRotation[this.cacheId]||(et.firstKeyframeRotation[this.cacheId]=new h.Quaternion),o){const a=o.values;et.firstKeyframeRotation[this.cacheId].set(a[0],a[1],a[2],a[3])}et.spaceRotation[this.cacheId]||(et.spaceRotation[this.cacheId]=new h.Quaternion),et.effectiveSpaceRotation[this.cacheId]||(et.effectiveSpaceRotation[this.cacheId]=new h.Quaternion),et.clipOffsetRotation[this.cacheId]=new h.Quaternion,o&&et.clipOffsetRotation[this.cacheId].set(o.values[0],o.values[1],o.values[2],o.values[3]).invert(),this.handlePosition(i,n),this.handleRotation(i,o)}set action(t){this._action=t}get action(){return this._action}get cacheId(){return this.root.uuid}onStart(t){if(t.getClip()!==this.clip)return;et.lastObjRotation[this.cacheId]||(et.lastObjRotation[this.cacheId]=this.root.quaternion.clone());const e=et.lastObjRotation[this.cacheId];if(et.spaceRotation[this.cacheId].copy(e),Fh){const i=new h.Euler().setFromQuaternion(e);console.log("START",this.clip.name,z.toDegrees(i.y),this.root.position.z)}}getClipRotationOffset(){return et.clipOffsetRotation[this.cacheId]}handlePosition(t,e){if(e){const i=this.root;Fh&&i.add(new h.AxesHelper),et.lastObjPosition[this.cacheId]||(et.lastObjPosition[this.cacheId]=this.root.position.clone());const n=new h.Vector3,o=new h.Vector3;this.positionWrapper=new Ay(e,(a,l)=>{const c=this.action.getEffectiveWeight();return Fh&&i.position.length()>8&&i.position.set(0,i.position.y,0),a>this._prevTime&&(n.set(l[0],l[1],l[2]),n.sub(o),n.multiplyScalar(c),n.applyQuaternion(this.getClipRotationOffset()),n.applyQuaternion(i.quaternion),this.positionChange.copy(n)),o.fromArray(l),this._prevTime=a,l[0]=0,l[1]=0,l[2]=0,l})}}handleRotation(t,e){if(e){if(Fh){const a=e.values,l=new h.Euler().setFromQuaternion(new h.Quaternion(a[0],a[1],a[2],a[3]));console.log(t.name,e.name,"FIRST ROTATION IN TRACK",z.toDegrees(l.y));const c=e.values.length-4,d=new h.Quaternion().set(a[c],a[c+1],a[c+2],a[c+3]),u=new h.Euler().setFromQuaternion(d);console.log(t.name,e.name,"LAST ROTATION IN TRACK",z.toDegrees(u.y))}let i=0;const n=new h.Quaternion,o=new h.Quaternion;this.rotationWrapper=new Ay(e,(a,l)=>(a>i&&(o.set(l[0],l[1],l[2],l[3]),n.invert(),o.multiply(n),this.rotationChange.copy(o)),n.fromArray(l),i=a,l[0]=0,l[1]=0,l[2]=0,l[3]=1,l))}}onBeforeUpdate(t){this.positionChange.set(0,0,0),this.rotationChange.set(0,0,0,1)}onAfterUpdate(t){return!this.action||(t*=this.action.getEffectiveWeight(),t<=0)?!1:(this.positionChange.multiplyScalar(t),this.rotationChange.slerp(et.identityQuaternion,1-t),!0)}};let Sn=et;r(Sn,"lastObjPosition",{}),r(Sn,"lastObjRotation",{}),r(Sn,"firstKeyframeRotation",{}),r(Sn,"spaceRotation",{}),r(Sn,"effectiveSpaceRotation",{}),r(Sn,"clipOffsetRotation",{}),r(Sn,"identityQuaternion",new h.Quaternion);class z1{constructor(t){r(this,"controller");r(this,"handler",[]);r(this,"root");r(this,"basePosition",new h.Vector3);r(this,"baseQuaternion",new h.Quaternion);r(this,"baseRotation",new h.Euler);r(this,"summedPosition",new h.Vector3);r(this,"summedRotation",new h.Quaternion);this.controller=t}createClip(t,e,i){this.root=e,e&&"name"in e&&e.name;const n=this.findRootTrack(i,".position"),o=this.findRootTrack(i,".quaternion"),a=new Sn(this.controller.context,e,i,n,o);this.handler.push(a);const l=t.clipAction(i);return a.action=l,l}onStart(t){for(const e of this.handler)e.onStart(t)}onBeforeUpdate(t){this.basePosition.copy(this.root.position),this.baseQuaternion.copy(this.root.quaternion);for(const e of this.handler)e.onBeforeUpdate(t)}onAfterUpdate(t){if(!(t<=0)){this.root.position.copy(this.basePosition),this.root.quaternion.copy(this.baseQuaternion),this.summedPosition.set(0,0,0),this.summedRotation.set(0,0,0,1);for(const e of this.handler)e.onAfterUpdate(t)&&(this.summedPosition.add(e.positionChange),this.summedRotation.multiply(e.rotationChange));this.root.position.add(this.summedPosition),this.root.quaternion.multiply(this.summedRotation)}}findRootTrack(t,e){const i=t.tracks;if(!i)return null;for(const n of i)if(n.name.endsWith(e))return n;return null}}class N1 extends Hi{onSerialize(t,e){}onDeserialize(t,e){if(e.type===$i&&(t==null?void 0:t.__type)==="AnimatorController")return new $i(t)}}new N1($i);var V1=Object.defineProperty,$1=Object.getOwnPropertyDescriptor,Au=(s,t,e,i)=>{for(var n=i>1?void 0:i?$1(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&V1(t,e,n),n};const Ai=x("debuganimator");class xt extends D{constructor(){super(...arguments);r(this,"applyRootMotion",!1);r(this,"hasRootMotion",!1);r(this,"keepAnimatorControllerStateOnDisable",!1);r(this,"_parametersAreDirty",!1);r(this,"_isDirty",!1);r(this,"_speed",1);r(this,"_normalizedStartOffset",0);r(this,"_animatorController",null);r(this,"_initializeWithRuntimeAnimatorController")}get isAnimationComponent(){return!0}set runtimeAnimatorController(e){var i;this._animatorController&&this._animatorController.model===e||(e?e instanceof $i?(e.animator&&e.animator!==this&&(console.warn("AnimatorController can not be bound to multiple animators",(i=e.model)==null?void 0:i.name),e.model||console.error("AnimatorController has no model"),e=new $i(e.model)),this._animatorController=e,this._animatorController.bind(this)):(Ai&&console.log("Assign animator controller",e,this),this._animatorController=new $i(e),this.__didAwake&&this._animatorController.bind(this)):this._animatorController=null)}get runtimeAnimatorController(){return this._animatorController}getCurrentStateInfo(){var e;return(e=this.runtimeAnimatorController)==null?void 0:e.getCurrentStateInfo()}get currentAction(){var e;return((e=this.runtimeAnimatorController)==null?void 0:e.currentAction)||null}get parametersAreDirty(){return this._parametersAreDirty}get isDirty(){return this._isDirty}Play(e,i=-1,n=Number.NEGATIVE_INFINITY,o=0){this.play(e,i,n,o)}play(e,i=-1,n=Number.NEGATIVE_INFINITY,o=0){var a;(a=this.runtimeAnimatorController)==null||a.play(e,i,n,o),this._isDirty=!0}Reset(){this.reset()}reset(){var e;(e=this._animatorController)==null||e.reset(),this._isDirty=!0}SetBool(e,i){this.setBool(e,i)}setBool(e,i){var n,o;Ai&&console.log("setBool",e,i),((n=this.runtimeAnimatorController)==null?void 0:n.getBool(e))!==i&&(this._parametersAreDirty=!0),(o=this.runtimeAnimatorController)==null||o.setBool(e,i)}GetBool(e){return this.getBool(e)}getBool(e){var n;const i=((n=this.runtimeAnimatorController)==null?void 0:n.getBool(e))??!1;return Ai&&console.log("getBool",e,i),i}toggleBool(e){this.setBool(e,!this.getBool(e))}SetFloat(e,i){this.setFloat(e,i)}setFloat(e,i){var n,o;((n=this.runtimeAnimatorController)==null?void 0:n.getFloat(e))!==i&&(this._parametersAreDirty=!0),Ai&&console.log("setFloat",e,i),(o=this.runtimeAnimatorController)==null||o.setFloat(e,i)}GetFloat(e){return this.getFloat(e)}getFloat(e){var n;const i=((n=this.runtimeAnimatorController)==null?void 0:n.getFloat(e))??-1;return Ai&&console.log("getFloat",e,i),i}SetInteger(e,i){this.setInteger(e,i)}setInteger(e,i){var n,o;((n=this.runtimeAnimatorController)==null?void 0:n.getInteger(e))!==i&&(this._parametersAreDirty=!0),Ai&&console.log("setInteger",e,i),(o=this.runtimeAnimatorController)==null||o.setInteger(e,i)}GetInteger(e){return this.getInteger(e)}getInteger(e){var n;const i=((n=this.runtimeAnimatorController)==null?void 0:n.getInteger(e))??-1;return Ai&&console.log("getInteger",e,i),i}SetTrigger(e){this.setTrigger(e)}setTrigger(e){var i;this._parametersAreDirty=!0,Ai&&console.log("setTrigger",e),(i=this.runtimeAnimatorController)==null||i.setTrigger(e)}ResetTrigger(e){this.resetTrigger(e)}resetTrigger(e){var i;this._parametersAreDirty=!0,Ai&&console.log("resetTrigger",e),(i=this.runtimeAnimatorController)==null||i.resetTrigger(e)}GetTrigger(e){this.getTrigger(e)}getTrigger(e){var n;const i=(n=this.runtimeAnimatorController)==null?void 0:n.getTrigger(e);return Ai&&console.log("getTrigger",e,i),i}IsInTransition(){return this.isInTransition()}isInTransition(){var e;return((e=this.runtimeAnimatorController)==null?void 0:e.isInTransition())??!1}SetSpeed(e){return this.setSpeed(e)}setSpeed(e){var i;e!==this._speed&&(Ai&&console.log("setSpeed",e),this._speed=e,((i=this._animatorController)==null?void 0:i.animator)==this&&this._animatorController.setSpeed(e))}set minMaxSpeed(e){var i;this._speed=z.lerp(e.x,e.y,Math.random()),((i=this._animatorController)==null?void 0:i.animator)==this&&this._animatorController.setSpeed(this._speed)}set minMaxOffsetNormalized(e){var i;this._normalizedStartOffset=z.lerp(e.x,e.y,Math.random()),((i=this.runtimeAnimatorController)==null?void 0:i.animator)==this&&(this.runtimeAnimatorController.normalizedStartOffset=this._normalizedStartOffset)}awake(){Ai&&console.log("ANIMATOR",this.name,this),this.gameObject&&this.initializeRuntimeAnimatorController()}initializeRuntimeAnimatorController(e=!1){const i=e||this.runtimeAnimatorController!==this._initializeWithRuntimeAnimatorController;if(this.runtimeAnimatorController&&i){const n=this.runtimeAnimatorController.clone();this._initializeWithRuntimeAnimatorController=n,n?(console.assert(this.runtimeAnimatorController!==n),this.runtimeAnimatorController=n,console.assert(this.runtimeAnimatorController===n),this.runtimeAnimatorController.bind(this),this.runtimeAnimatorController.setSpeed(this._speed),this.runtimeAnimatorController.normalizedStartOffset=this._normalizedStartOffset):console.warn("Could not clone animator controller",this.runtimeAnimatorController)}}onDisable(){var e;this.keepAnimatorControllerStateOnDisable||(e=this._animatorController)==null||e.reset()}onBeforeRender(){this._isDirty=!1,this._parametersAreDirty=!1,!F1(this.gameObject)&&this._animatorController&&this._animatorController.update(1)}}Au([p()],xt.prototype,"applyRootMotion",2);Au([p()],xt.prototype,"hasRootMotion",2);Au([p()],xt.prototype,"keepAnimatorControllerStateOnDisable",2);Au([p()],xt.prototype,"runtimeAnimatorController",1);const Dy=Symbol("previous-visibility"),fa=class extends h.WebGLRenderTarget{render(t,e,i){if("addPass"in i)this._unsupported_effectcomposer_warning||(console.warn("RenderTexture.render() does not yet support EffectComposer"),this._unsupported_effectcomposer_warning=!0);else if(i instanceof h.WebGLRenderer){this.onBeforeRender();const o=i.getRenderTarget(),a=i.xr.enabled;i.xr.enabled=!1,i.setRenderTarget(this),i.clear(!0,!0,!0),i.render(t,e),i.setRenderTarget(o),i.xr.enabled=a,this.onAfterRender()}}onBeforeRender(){fa._userSet.clear();const t=Km(this.texture,!0,null,fa._userSet);for(const e of t)e instanceof h.Mesh&&(e[Dy]=e.visible,e.visible=!1)}onAfterRender(){for(const t of fa._userSet)t instanceof h.Mesh&&(t.visible=t[Dy]);fa._userSet.clear()}};let so=fa;r(so,"_userSet",new Set);var W1=Object.defineProperty,G1=Object.getOwnPropertyDescriptor,Jc=(s,t,e,i)=>{for(var n=i>1?void 0:i?G1(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&W1(t,e,n),n};const Uh=x("debuggroundprojection");class Vn extends D{constructor(){super(...arguments);r(this,"applyOnAwake",!1);r(this,"autoFit",!0);r(this,"_radius",50);r(this,"_height",3);r(this,"_arblending",0);r(this,"_lastBackground");r(this,"_lastRadius");r(this,"_lastHeight");r(this,"_projection");r(this,"_watcher");r(this,"_needsTextureUpdate",!1);r(this,"_blurrynessShader",null);r(this,"_lastBlurriness",-1)}set radius(e){this._radius=e,this._projection&&this.updateProjection()}get radius(){return this._radius}set height(e){this._height=e,this._projection&&this.updateProjection()}get height(){return this._height}set arBlending(e){this._arblending=e,this._needsTextureUpdate=!0}get arBlending(){return this._arblending}awake(){this.applyOnAwake&&this.updateAndCreate()}onEnable(){this.context.time.frameCount>0&&this.applyOnAwake&&this.updateAndCreate(),this._watcher||(this._watcher=new fs(this.context.scene,"background"),this._watcher.subscribeWrite(e=>{Uh&&console.log("Background changed",this.context.scene.background),this._needsTextureUpdate=!0}))}onDisable(){var e,i;(e=this._watcher)==null||e.revoke(),(i=this._projection)==null||i.removeFromParent()}onEnterXR(){this.activeAndEnabled&&(this._needsTextureUpdate=!0,this.updateProjection())}async onLeaveXR(){this.activeAndEnabled&&(await Uc(1),this.updateProjection())}onBeforeRender(){this._projection&&this.scene.backgroundRotation&&this._projection.rotation.copy(this.scene.backgroundRotation),this.context.scene.backgroundBlurriness!==void 0&&this._lastBlurriness!=this.context.scene.backgroundBlurriness&&this.context.scene.backgroundBlurriness>.001?this.updateProjection():this._needsTextureUpdate&&this.context.scene.background instanceof h.Texture&&this.updateBlurriness(this.context.scene.background,this.context.scene.backgroundBlurriness)}updateAndCreate(){var e;this.updateProjection(),(e=this._watcher)==null||e.apply()}updateProjection(){var a,l,c,d,u,f;if(!this.context.scene.background){(a=this._projection)==null||a.removeFromParent();return}const e=this.context.scene.background;if(!(e instanceof h.Texture)){(l=this._projection)==null||l.removeFromParent();return}if(((c=this.context.xr)!=null&&c.isPassThrough||(d=this.context.xr)!=null&&d.isAR)&&this.arBlending===0){(u=this._projection)==null||u.removeFromParent();return}if(!this.gameObject||this.destroyed)return;let i=!0;const n=0,o=e!==this._lastBackground||this._height!==this._lastHeight||this._radius!==this._lastRadius;if(!this._projection||o){Uh&&console.log("Create/Update Ground Projection",e.name),(f=this._projection)==null||f.removeFromParent();try{this._projection=new Y.GroundedSkybox(e,this._height,this._radius,64)}catch(m){console.error("Error creating three GroundProjection",m);return}this._projection.position.y=this._height-n,this._projection.name="GroundProjection",jm(this._projection,!1)}else i=!1;if(this._projection.parent||this.gameObject.add(this._projection),this.autoFit&&i){this._projection.updateWorldMatrix(!0,!0);const m=si(this.context.scene.children,[this._projection]),g=m.min.y;if(g<1/0){const _=$();_.x=m.min.x+(m.max.x-m.min.x)*.5;const y=Ue(this.gameObject).x;_.y=g+this._height*y-n,_.z=m.min.z+(m.max.z-m.min.z)*.5,it(this._projection,_)}Uh&&N.DrawWireBox3(m,65280,5)}this.context.scene.backgroundBlurriness>.001&&this._needsTextureUpdate&&this.updateBlurriness(e,this.context.scene.backgroundBlurriness),this._lastBackground=e,this._lastHeight=this._height,this._lastRadius=this._radius,this._needsTextureUpdate=!1}updateBlurriness(e,i){var o;if(this._projection){if(!e)return}else return;this._needsTextureUpdate=!1,Uh&&console.log("Update Blurriness",i),this._blurrynessShader??(this._blurrynessShader=new h.ShaderMaterial({name:"GroundProjectionBlurriness",uniforms:{map:{value:e},blurriness:{value:i},blending:{value:0},alphaFactor:{value:1}},vertexShader:H1,fragmentShader:q1})),this._blurrynessShader.depthWrite=!1,this._blurrynessShader.uniforms.map.value=e,this._blurrynessShader.uniforms.blurriness.value=1,this._lastBlurriness=i,e.needsUpdate=!0;const n=this._projection.material.transparent;this._projection.material.transparent=(((o=this.context.xr)==null?void 0:o.isAR)===!0&&this.arBlending>1e-6)??!1,this._projection.material.transparent?this._blurrynessShader.uniforms.blending.value=this.arBlending:this._blurrynessShader.uniforms.blending.value=0,this.context.isInPassThrough?this._blurrynessShader.uniforms.alphaFactor.value=.95:this._blurrynessShader.uniforms.alphaFactor.value=1,n!==this._projection.material.transparent&&(this._projection.material.needsUpdate=!0),this._projection.material.map=ji.copyTexture(e,this._blurrynessShader),this._projection.material.depthTest=!0,this._projection.material.depthWrite=!1}}Jc([p()],Vn.prototype,"applyOnAwake",2);Jc([p()],Vn.prototype,"autoFit",2);Jc([p()],Vn.prototype,"radius",1);Jc([p()],Vn.prototype,"height",1);Jc([p()],Vn.prototype,"arBlending",1);const H1=`
  varying vec2 vUv;

  void main() {
    vUv = uv;
    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
  }
`,q1=`
  uniform sampler2D map;
  uniform float blurriness;
  uniform float alphaFactor;
  uniform float blending;
  varying vec2 vUv;

  const float PI = 3.14159265359;

  // Gaussian function
  float gaussian(float x, float sigma) {
    return exp(-(x * x) / (2.0 * sigma * sigma)) / (sqrt(2.0 * PI) * sigma);
  }

  // Custom smoothstep function for desired falloff
  float customSmoothstep(float edge0, float edge1, float x) {
    float t = clamp((x - edge0) / (edge1 - edge0), 0.0, 1.0);
    return t * t * (3.0 - 2.0 * t);
  }

  void main() {
    vec2 center = vec2(0.0, 0.0);
    vec2 pos = vUv;
    pos.x = 0.0; // Only consider vertical distance
    float distance = length(pos - center);
    
    // Calculate blur amount based on custom falloff
    float blurAmount = customSmoothstep(0.5, 1.0, distance * 2.0);
    blurAmount = clamp(blurAmount, 0.0, 1.0); // Ensure blur amount is within valid range

    // Gaussian blur
    vec2 pixelSize = 1.0 / vec2(textureSize(map, 0));
    vec4 color = vec4(0.0);
    float totalWeight = 0.0;
    int blurSize = int(60.0 * min(1.0, blurriness) * blurAmount); // Adjust blur size based on distance and blurriness
    float lodLevel = log2(float(blurSize)) * 0.5; // Compute LOD level

    for (int x = -blurSize; x <= blurSize; x++) {
        for (int y = -blurSize; y <= blurSize; y++) {
            vec2 offset = vec2(float(x), float(y)) * pixelSize * blurAmount;
            float weight = gaussian(length(vec2(float(x), float(y))), 1000.0 * blurAmount); // Use a fixed sigma value
            color += textureLod(map, vUv + offset, lodLevel) * weight;
            totalWeight += weight;
        }
    }

    color = totalWeight > 0.0 ? color / totalWeight : texture2D(map, vUv);

    gl_FragColor = color;

    float brightness = dot(gl_FragColor.rgb, vec3(0.299, 0.587, 0.114));
    float stepFactor = blending - brightness * .1;
    gl_FragColor.a = pow(1.0 - blending * customSmoothstep(0.35 * stepFactor, 0.45 * stepFactor, distance), 5.);
    gl_FragColor.a *= alphaFactor;
    // gl_FragColor.rgb = vec3(1.0);

    // #include <tonemapping_fragment>
    // #include <colorspace_fragment>
    
    // Uncomment to visualize blur amount
    // gl_FragColor = vec4(blurAmount, 0.0, 0.0, 1.0);
  }
`;var X1=Object.defineProperty,Q1=Object.getOwnPropertyDescriptor,dg=(s,t,e,i)=>{for(var n=i>1?void 0:i?Q1(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&X1(t,e,n),n};class vr extends D{constructor(){super(...arguments);r(this,"constraintActive",!0);r(this,"locked",!1);r(this,"sources",[])}}dg([p()],vr.prototype,"constraintActive",2);dg([p()],vr.prototype,"locked",2);dg([p(h.Object3D)],vr.prototype,"sources",2);function Cv(s,t){return bs(s,he.ContextCreated,t),()=>_o(s,he.ContextCreated)}function Y1(s,t){return bs(s,he.ContextClearing,t),()=>_o(s,he.ContextClearing)}function K1(s,t){return bs(s,he.ContextDestroying,t),()=>_o(s,he.ContextDestroying)}function Pv(s,t){return bs(s,ve.Start,t),()=>_o(s,ve.Start)}function Ov(s,t){return bs(s,ve.Update,t),()=>_o(s,ve.Update)}function Z1(s,t){return bs(s,ve.OnBeforeRender,t),()=>_o(s,ve.OnBeforeRender)}function J1(s,t){return bs(s,ve.OnAfterRender,t),()=>_o(s,ve.OnAfterRender)}let tr=class{constructor(){r(this,"bb",null);r(this,"bb_pos",0)}__init(t,e){return this.bb_pos=t,this.bb=e,this}x(){return this.bb.readFloat32(this.bb_pos)}y(){return this.bb.readFloat32(this.bb_pos+4)}z(){return this.bb.readFloat32(this.bb_pos+8)}static sizeOf(){return 12}static createVec3(t,e,i,n){return t.prep(4,12),t.writeFloat32(n),t.writeFloat32(i),t.writeFloat32(e),t.offset()}};class Mv{constructor(){r(this,"bb",null);r(this,"bb_pos",0)}__init(t,e){return this.bb_pos=t,this.bb=e,this}position(t){return(t||new tr).__init(this.bb_pos,this.bb)}rotation(t){return(t||new tr).__init(this.bb_pos+12,this.bb)}scale(t){return(t||new tr).__init(this.bb_pos+24,this.bb)}static sizeOf(){return 36}static createTransform(t,e,i,n,o,a,l,c,d,u){return t.prep(4,36),t.prep(4,12),t.writeFloat32(u),t.writeFloat32(d),t.writeFloat32(c),t.prep(4,12),t.writeFloat32(l),t.writeFloat32(a),t.writeFloat32(o),t.prep(4,12),t.writeFloat32(n),t.writeFloat32(i),t.writeFloat32(e),t.offset()}}class hs{constructor(){r(this,"bb",null);r(this,"bb_pos",0)}__init(t,e){return this.bb_pos=t,this.bb=e,this}static getRootAsSyncedTransformModel(t,e){return(e||new hs).__init(t.readInt32(t.position())+t.position(),t)}static getSizePrefixedRootAsSyncedTransformModel(t,e){return t.setPosition(t.position()+oe.SIZE_PREFIX_LENGTH),(e||new hs).__init(t.readInt32(t.position())+t.position(),t)}guid(t){const e=this.bb.__offset(this.bb_pos,4);return e?this.bb.__string(this.bb_pos+e,t):null}fast(){const t=this.bb.__offset(this.bb_pos,6);return t?!!this.bb.readInt8(this.bb_pos+t):!1}transform(t){const e=this.bb.__offset(this.bb_pos,8);return e?(t||new Mv).__init(this.bb_pos+e,this.bb):null}dontSave(){const t=this.bb.__offset(this.bb_pos,10);return t?!!this.bb.readInt8(this.bb_pos+t):!1}static startSyncedTransformModel(t){t.startObject(4)}static addGuid(t,e){t.addFieldOffset(0,e,0)}static addFast(t,e){t.addFieldInt8(1,+e,0)}static addTransform(t,e){t.addFieldStruct(2,e,0)}static addDontSave(t,e){t.addFieldInt8(3,+e,0)}static endSyncedTransformModel(t){return t.endObject()}static finishSyncedTransformModelBuffer(t,e){t.finish(e)}static finishSizePrefixedSyncedTransformModelBuffer(t,e){t.finish(e,void 0,!0)}}exports.MODULES=void 0;(s=>{(t=>{t.MAYBEMODULE=null;const e=[];function i(){return t.MODULE?Promise.resolve(t.MODULE):new Promise(o=>{e.push(o)})}t.ready=i;async function n(){if(t.MODULE)return t.MODULE;const o=await Promise.resolve().then(()=>require("./rapier.light.umd.cjs"));return t.MODULE=o,t.MAYBEMODULE=o,e.forEach(a=>a(o)),e.length=0,o}t.load=n})(s.RAPIER_PHYSICS||(s.RAPIER_PHYSICS={})),(t=>{t.MAYBEMODULE=null;const e=[];function i(){return t.MODULE?Promise.resolve(t.MODULE):new Promise(o=>{e.push(o)})}t.ready=i;async function n(){if(t.MODULE)return t.MODULE;const o=await Promise.resolve().then(()=>require("./postprocessing.light.umd.cjs")).then(a=>a.index);return t.MODULE=o,t.MAYBEMODULE=o,e.forEach(a=>a(o)),e.length=0,o}t.load=n})(s.POSTPROCESSING||(s.POSTPROCESSING={})),(t=>{t.MAYBEMODULE=null;const e=[];function i(){return t.MODULE?Promise.resolve(t.MODULE):new Promise(o=>{e.push(o)})}t.ready=i;async function n(){if(t.MODULE)return t.MODULE;const o=await Promise.resolve().then(()=>require("./postprocessing.light.umd.cjs")).then(a=>a.N8AO);return t.MODULE=o,t.MAYBEMODULE=o,e.forEach(a=>a(o)),e.length=0,o}t.load=n})(s.POSTPROCESSING_AO||(s.POSTPROCESSING_AO={}))})(exports.MODULES||(exports.MODULES={}));var at=(s=>(s[s.Average=0]="Average",s[s.Multiply=1]="Multiply",s[s.Minimum=2]="Minimum",s[s.Maximum=3]="Maximum",s))(at||{}),Du=(s=>(s[s.Discrete=0]="Discrete",s[s.Continuous=1]="Continuous",s))(Du||{}),We=(s=>(s[s.None=0]="None",s[s.FreezePositionX=2]="FreezePositionX",s[s.FreezePositionY=4]="FreezePositionY",s[s.FreezePositionZ=8]="FreezePositionZ",s[s.FreezePosition=14]="FreezePosition",s[s.FreezeRotationX=16]="FreezeRotationX",s[s.FreezeRotationY=32]="FreezeRotationY",s[s.FreezeRotationZ=64]="FreezeRotationZ",s[s.FreezeRotation=112]="FreezeRotation",s[s.FreezeAll=126]="FreezeAll",s))(We||{}),da=(s=>(s[s.None=0]="None",s[s.X=2]="X",s[s.Y=4]="Y",s[s.Z=8]="Z",s[s.All=-1]="All",s))(da||{});const Ct=function(s,t){return function(e,i,n){eP(e,i,n,s,t)}};function eP(s,t,e,i,n){if(!n&&!i&&!s.onValidate)return;if(e!==void 0){console.error("Invalid usage of validate decorator. Only fields can be validated.",s,t,e),Te("Invalid usage of validate decorator. Only fields can be validated. Property: "+t,bi.Error);return}let o="";if(typeof t=="string"?o=t:o=t.name,s.__internalAwake){const a=Symbol(o),l=s.__internalAwake;s.__internalAwake=function(){var c;if(!this.onValidate){B()&&console.warn('Usage of @validate decorate detected but there is no onValidate method in your class: "'+((c=s.constructor)==null?void 0:c.name)+'"');return}if(this[a]===void 0){this[a]=this[o];const d=this[o];if(d instanceof h.Vector2||d instanceof h.Vector3||d instanceof h.Vector4||d instanceof h.Quaternion){const u=this[o];vu(u,()=>{this.onValidate(o)})}Object.defineProperty(this,o,{set:function(u){var f;if(this[Kp]===!0)this[a]=u;else{i==null||i.call(this,u);const m=this[a];this[a]=u,(f=this.onValidate)==null||f.call(this,o,m)}},get:function(){return n==null||n.call(this),this[a]}})}l.call(this)}}}const tP=function(s){return function(t,e,i){let n="";typeof e=="string"?n=e:n=e.name;const o=s.prototype,a=Object.getOwnPropertyDescriptor(o,n);if(!(a!=null&&a.value)){console.warn("Can not apply prefix: type does not have method named",e,s);return}const l=a.value,c=t[n];Object.defineProperty(o,n,{value:function(...d){const u=c==null?void 0:c.call(this,...d);if(u instanceof Promise){u.then(f=>{if(f!==!1)return l.call(this,...d)});return}if(u!==!1)return l.call(this,...d)}})}};var iP=Object.defineProperty,nP=Object.getOwnPropertyDescriptor,Oi=(s,t,e,i)=>{for(var n=i>1?void 0:i?nP(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&iP(t,e,n),n};class sP{constructor(t,e){r(this,"positionChanged",!1);r(this,"rotationChanged",!1);r(this,"position");r(this,"quaternion");r(this,"_positionKeys",["x","y","z"]);r(this,"_quaternionKeys",["_x","_y","_z","_w"]);r(this,"mute",!1);r(this,"context");r(this,"obj");r(this,"_positionWatch");r(this,"_rotationWatch");this.context=e,this.obj=t}get isDirty(){return this.positionChanged||this.rotationChanged}reset(t=!1){if(this.positionChanged=!1,this.rotationChanged=!1,this.mute=!1,t){if(this.position)for(const e of this._positionKeys)delete this.position[e];if(this.quaternion)for(const e of this._quaternionKeys)delete this.quaternion[e]}}syncValues(){for(const t of this._positionKeys)this.position[t]=this.obj.position[t];for(const t of this._quaternionKeys)this.quaternion[t]=this.obj.quaternion[t]}applyValues(){if(this.positionChanged&&this.position)for(const t of this._positionKeys){const e=this.position[t];e!==void 0&&(this.obj.position[t]=e)}if(this.rotationChanged&&this.quaternion)for(const t of this._quaternionKeys){const e=this.quaternion[t];e!==void 0&&(this.obj.quaternion[t]=e)}}start(t,e){this.reset(),t&&(this._positionWatch||(this._positionWatch=new fs(this.obj.position,["x","y","z"])),this._positionWatch.apply(),this.position={},this._positionWatch.subscribeWrite((o,a)=>{var c;if((c=this.context.physics.engine)!=null&&c.isUpdating||this.mute)return;const l=this.position[a];Math.abs(l-o)<1e-5||(this.position[a]=o,this.positionChanged=!0)})),e&&(this._rotationWatch||(this._rotationWatch=new fs(this.obj.quaternion,["_x","_y","_z","_w"])),this._rotationWatch.apply(),this.quaternion={},this._rotationWatch.subscribeWrite((o,a)=>{var c;if((c=this.context.physics.engine)!=null&&c.isUpdating||this.mute)return;const l=this.quaternion[a];Math.abs(l-o)<1e-5||(this.quaternion[a]=o,this.rotationChanged=!0)}));const i=this.obj.matrixWorld.multiplyMatrices.bind(this.obj.matrixWorld),n=new h.Matrix4;this.obj.matrixWorld.multiplyMatrices=(o,a)=>{var l;return(l=this.context.physics.engine)!=null&&l.isUpdating||this.mute||n.equals(o)||(this.positionChanged=!0,this.rotationChanged=!0,n.copy(o)),i(o,a)}}stop(){var t,e;(t=this._positionWatch)==null||t.revoke(),(e=this._rotationWatch)==null||e.revoke()}}var bp;const wd=(bp=class extends D{constructor(){super(...arguments);r(this,"autoMass",!0);r(this,"_mass",0);r(this,"useGravity",!0);r(this,"centerOfMass",new h.Vector3(0,0,0));r(this,"constraints",We.None);r(this,"isKinematic",!1);r(this,"drag",0);r(this,"angularDrag",1);r(this,"detectCollisions",!0);r(this,"sleepThreshold",.01);r(this,"collisionDetectionMode",Du.Discrete);r(this,"_gravityScale",1);r(this,"dominanceGroup",0);r(this,"_propertiesChanged",!1);r(this,"_currentVelocity",new h.Vector3);r(this,"_smoothedVelocity",new h.Vector3);r(this,"_smoothedVelocityGetter",new h.Vector3);r(this,"_lastPosition",new h.Vector3);r(this,"_watch")}get isRigidbody(){return!0}set mass(t){t!==this._mass&&(this._mass=t,this._propertiesChanged=!0,this.__didAwake&&(this.autoMass=!1))}get mass(){var t,e;return this.autoMass?((e=(t=this.context.physics.engine)==null?void 0:t.getBody(this))==null?void 0:e.mass())??-1:this._mass}get lockPositionX(){return(this.constraints&We.FreezePositionX)!==0}get lockPositionY(){return(this.constraints&We.FreezePositionY)!==0}get lockPositionZ(){return(this.constraints&We.FreezePositionZ)!==0}get lockRotationX(){return(this.constraints&We.FreezeRotationX)!==0}get lockRotationY(){return(this.constraints&We.FreezeRotationY)!==0}get lockRotationZ(){return(this.constraints&We.FreezeRotationZ)!==0}set lockPositionX(t){t?this.constraints|=We.FreezePositionX:this.constraints&=~We.FreezePositionX}set lockPositionY(t){t?this.constraints|=We.FreezePositionY:this.constraints&=~We.FreezePositionY}set lockPositionZ(t){t?this.constraints|=We.FreezePositionZ:this.constraints&=~We.FreezePositionZ}set lockRotationX(t){t?this.constraints|=We.FreezeRotationX:this.constraints&=~We.FreezeRotationX}set lockRotationY(t){t?this.constraints|=We.FreezeRotationY:this.constraints&=~We.FreezeRotationY}set lockRotationZ(t){t?this.constraints|=We.FreezeRotationZ:this.constraints&=~We.FreezeRotationZ}set gravityScale(t){this._gravityScale=t}get gravityScale(){return this._gravityScale}awake(){this._watch=void 0,this._propertiesChanged=!1}onEnable(){this._watch||(this._watch=new sP(this.gameObject,this.context)),this._watch.start(!0,!0),this.startCoroutine(this.beforePhysics(),ve.LateUpdate),B()&&(globalThis.false?exports.MODULES.RAPIER_PHYSICS.ready().then(async()=>{var t;await Uc(3),(t=this.context.physics.engine)!=null&&t.getBody(this)||console.warn(`Rigidbody could not be created. Ensure "${this.name}" has a Collider component.`)}):console.warn("Rigidbody could not be created: Rapier physics are explicitly disabled."))}onDisable(){var t,e;(t=this._watch)==null||t.stop(),(e=this.context.physics.engine)==null||e.removeBody(this)}onDestroy(){var t;(t=this.context.physics.engine)==null||t.removeBody(this)}onValidate(){this._propertiesChanged=!0}*beforePhysics(){var t,e,i,n;for(;;)this._propertiesChanged&&(this._propertiesChanged=!1,(t=this.context.physics.engine)==null||t.updateProperties(this)),(e=this._watch)!=null&&e.isDirty?(this._watch.mute=!0,this._watch.applyValues(),(i=this.context.physics.engine)==null||i.updateBody(this,this._watch.positionChanged,this._watch.rotationChanged),this._watch.reset()):(n=this._watch)==null||n.syncValues(),this.captureVelocity(),yield}teleport(t,e=!0){var i;(i=this._watch)==null||i.reset(!0),e?this.gameObject.position.set(t.x,t.y,t.z):this.setWorldPosition(t.x,t.y,t.z),this.resetForcesAndTorques(),this.resetVelocities()}resetForces(t=!0){var e;(e=this.context.physics.engine)==null||e.resetForces(this,t)}resetTorques(t=!0){var e;(e=this.context.physics.engine)==null||e.resetTorques(this,t)}resetVelocities(){this.setVelocity(0,0,0),this.setAngularVelocity(0,0,0)}resetForcesAndTorques(){this.resetForces(),this.resetTorques()}wakeUp(){var t;(t=this.context.physics.engine)==null||t.wakeup(this)}get isSleeping(){var t;return(t=this.context.physics.engine)==null?void 0:t.isSleeping(this)}updateProperties(){var t;return this._propertiesChanged=!1,(t=this.context.physics.engine)==null?void 0:t.updateProperties(this)}applyForce(t,e,i=!0){var n;this._propertiesChanged&&this.updateProperties(),(n=this.context.physics.engine)==null||n.addForce(this,t,i)}applyImpulse(t,e=!0){var i;this._propertiesChanged&&this.updateProperties(),(i=this.context.physics.engine)==null||i.applyImpulse(this,t,e)}setForce(t,e,i,n=!0){var o,a,l;(o=this.context.physics.engine)==null||o.resetForces(this,n),typeof t=="number"?(e??(e=0),i??(i=0),(a=this.context.physics.engine)==null||a.addForce(this,{x:t,y:e,z:i},n)):(l=this.context.physics.engine)==null||l.addForce(this,t,n)}getVelocity(){var e;const t=(e=this.context.physics.engine)==null?void 0:e.getLinearVelocity(this);return t?(this._currentVelocity.x=t.x,this._currentVelocity.y=t.y,this._currentVelocity.z=t.z,this._currentVelocity):this._currentVelocity.set(0,0,0)}setVelocity(t,e,i,n=!0){var o,a;if(t instanceof h.Vector3){const l=t;(o=this.context.physics.engine)==null||o.setLinearVelocity(this,l,n);return}e===void 0||i===void 0||(a=this.context.physics.engine)==null||a.setLinearVelocity(this,{x:t,y:e,z:i},n)}getAngularVelocity(){var e;const t=(e=this.context.physics.engine)==null?void 0:e.getAngularVelocity(this);return t?(this._currentVelocity.x=t.x,this._currentVelocity.y=t.y,this._currentVelocity.z=t.z,this._currentVelocity):this._currentVelocity.set(0,0,0)}setAngularVelocity(t,e,i,n=!0){var o,a;if(typeof t=="object"){const l=t;(o=this.context.physics.engine)==null||o.setAngularVelocity(this,l,n);return}if(e===void 0||i===void 0||typeof e=="boolean"){console.warn("setAngularVelocity expects either a Vec3 or 3 numbers");return}(a=this.context.physics.engine)==null||a.setAngularVelocity(this,{x:t,y:e,z:i},n)}setTorque(t,e,i){typeof t=="number"?this.setAngularVelocity(t,e,i):this.setAngularVelocity(t)}get smoothedVelocity(){return this._smoothedVelocityGetter.copy(this._smoothedVelocity),this._smoothedVelocityGetter.multiplyScalar(1/this.context.time.deltaTime)}setBodyFromGameObject(t=null){}captureVelocity(){const t=this.gameObject.matrixWorld;wd.tempPosition.setFromMatrixPosition(t);const e=wd.tempPosition.sub(this._lastPosition);this._lastPosition.copy(wd.tempPosition),this._smoothedVelocity.lerp(e,this.context.time.deltaTime/.1)}},r(bp,"tempPosition",new h.Vector3),bp);let ue=wd;Oi([Ct()],ue.prototype,"autoMass",2);Oi([p()],ue.prototype,"mass",1);Oi([Ct(),p()],ue.prototype,"useGravity",2);Oi([p(h.Vector3)],ue.prototype,"centerOfMass",2);Oi([Ct(),p()],ue.prototype,"constraints",2);Oi([Ct(),p()],ue.prototype,"isKinematic",2);Oi([Ct(),p()],ue.prototype,"drag",2);Oi([Ct(),p()],ue.prototype,"angularDrag",2);Oi([Ct(),p()],ue.prototype,"detectCollisions",2);Oi([Ct(),p()],ue.prototype,"sleepThreshold",2);Oi([Ct(),p()],ue.prototype,"collisionDetectionMode",2);Oi([Ct()],ue.prototype,"_gravityScale",2);Oi([Ct()],ue.prototype,"dominanceGroup",2);new h.Vector3;new h.Vector3;const zs=x("debugsync"),Mc="STRS";Wm(Mc,hs.getRootAsSyncedTransformModel);const xn=new oe.Builder;function Rv(s,t,e=!0){xn.clear();const i=xn.createString(s);hs.startSyncedTransformModel(xn),hs.addGuid(xn,i),hs.addFast(xn,e);const n=t.worldPosition,o=t.worldEuler,a=t.gameObject.scale;hs.addTransform(xn,Mv.createTransform(xn,n.x,n.y,n.z,o.x,o.y,o.z,a.x,a.y,a.z));const l=hs.endSyncedTransformModel(xn);return xn.finish(l,Mc),xn.asUint8Array()}let sm=0,ac=0;Ov(s=>{var i;const e=((i=s.connection.currentServerUrl)==null?void 0:i.includes("glitch"))?10:40;ac=Math.floor(sm/e),sm=0,zs&&ac>0&&console.log("Sync Transform Fast Interval",ac)});class Un extends D{constructor(){super(...arguments);r(this,"overridePhysics",!0);r(this,"interpolatePosition",!0);r(this,"interpolateRotation",!0);r(this,"fastMode",!1);r(this,"syncDestroy",!1);r(this,"_model",null);r(this,"_needsUpdate",!0);r(this,"rb",null);r(this,"_wasKinematic",!1);r(this,"_receivedDataBefore",!1);r(this,"_targetPosition");r(this,"_targetRotation");r(this,"_receivedFastUpdate",!1);r(this,"_shouldRequestOwnership",!1);r(this,"joinedRoomCallback",null);r(this,"receivedDataCallback",null);r(this,"tempEuler",new h.Euler);r(this,"receivedUpdate",!1);r(this,"lastPosition");r(this,"lastRotation");r(this,"lastScale")}requestOwnership(){zs&&console.log("Request ownership"),this._model?this._model.requestOwnership():(this._shouldRequestOwnership=!0,this._needsUpdate=!0)}hasOwnership(){var e;return((e=this._model)==null?void 0:e.hasOwnership)??void 0}isOwned(){var e;return(e=this._model)==null?void 0:e.isOwned}awake(){zs&&console.log("new instance",this.guid,this),this._receivedDataBefore=!1,this._targetPosition=new h.Vector3,this._targetRotation=new h.Quaternion,this.lastPosition=new h.Vector3,this.lastRotation=new h.Quaternion,this.lastScale=new h.Vector3,this.rb=S.getComponentInChildren(this.gameObject,ue),this.rb&&(this._wasKinematic=this.rb.isKinematic),this.receivedUpdate=!0,this._model=new Hm(this.context.connection,this.guid),this.context.connection.isConnected&&this.tryGetLastState(),this.joinedRoomCallback=this.tryGetLastState.bind(this),this.context.connection.beginListen(J.JoinedRoom,this.joinedRoomCallback),this.receivedDataCallback=this.onReceivedData.bind(this),this.context.connection.beginListenBinary(Mc,this.receivedDataCallback)}onDestroy(){this.syncDestroy&&Jm(this.guid,this.context.connection),this._model=null,this.context.connection.stopListen(J.JoinedRoom,this.joinedRoomCallback),this.context.connection.stopListenBinary(Mc,this.receivedDataCallback)}tryGetLastState(){const e=this.context.connection.tryGetState(this.guid);e&&this.onReceivedData(e)}onReceivedData(e){var i;if(!this.destroyed&&typeof e.guid=="function"&&e.guid()===this.guid){zs&&console.log("new data",this.context.connection.connectionId,this.context.time.frameCount,this.guid,e),this.receivedUpdate=!0,this._receivedFastUpdate=e.fast();const n=e.transform();if(n){Vi.markDirty(this.gameObject,!0);const o=n.position();o&&(this.interpolatePosition&&((i=this._targetPosition)==null||i.set(o.x(),o.y(),o.z())),(!this.interpolatePosition||!this._receivedDataBefore)&&this.setWorldPosition(o.x(),o.y(),o.z()));const a=n.rotation();a&&(this.tempEuler.set(a.x(),a.y(),a.z()),this.interpolateRotation&&this._targetRotation.setFromEuler(this.tempEuler),(!this.interpolateRotation||!this._receivedDataBefore)&&Lm(this.gameObject,this.tempEuler));const l=n.scale();l&&this.gameObject.scale.set(l.x(),l.y(),l.z())}this._receivedDataBefore=!0}}onEnable(){this.lastPosition.copy(this.worldPosition),this.lastRotation.copy(this.worldQuaternion),this.lastScale.copy(this.gameObject.scale),this._needsUpdate=!0,this._model&&this._model.updateIsOwned()}onDisable(){this._model&&this._model.freeOwnership()}onBeforeRender(){if(!this.activeAndEnabled||!this.context.connection.isConnected)return;if(!this.context.connection.isInRoom||!this._model){zs&&console.log("no model or room",this.name,this.guid,this.context.connection.isInRoom);return}this._shouldRequestOwnership&&(this._shouldRequestOwnership=!1,this._model.requestOwnership());const e=this.worldPosition,i=this.worldQuaternion,n=this.gameObject.scale;if(this._model.isOwned&&!this.receivedUpdate){const l=this._model.hasOwnership||this.fastMode?1e-4:.001;(e.distanceTo(this.lastPosition)>l||i.angleTo(this.lastRotation)>l||n.distanceTo(this.lastScale)>l)&&(this._model.hasOwnership?this._needsUpdate=!0:(zs&&console.log(this.guid,"reset because not owned but",this.gameObject.name,this.lastPosition),this.worldPosition=this.lastPosition,e.copy(this.lastPosition),this.worldQuaternion=this.lastRotation,i.copy(this.lastRotation),this.gameObject.scale.copy(this.lastScale),Vi.markDirty(this.gameObject,!0),this._needsUpdate=!1))}if(this._model&&!this._model.hasOwnership&&this._model.isOwned&&this._receivedDataBefore){const c=this._receivedFastUpdate||this.fastMode?.5:.3;let d=!1;if(this.interpolatePosition&&this._targetPosition){const u=this.worldPosition;u.lerp(this._targetPosition,c),this.worldPosition=u,d=!0}if(this.interpolateRotation&&this._targetRotation){const u=this.worldQuaternion;u.slerp(this._targetRotation,c),this.worldQuaternion=u,d=!0}d&&Vi.markDirty(this.gameObject,!0)}if(this.receivedUpdate=!1,this.lastPosition.copy(e),this.lastRotation.copy(i),this.lastScale.copy(n),!this._model||!this._model||this._model.hasOwnership===void 0||!this._model.hasOwnership)return;this.rb&&this.overridePhysics&&this._wasKinematic!==void 0&&(zs&&console.log("reset kinematic",this.rb.name,this._wasKinematic),this.rb.isKinematic=this._wasKinematic);const o=10,a=this.rb||this.fastMode;if(this._needsUpdate&&(this.context.time.frameCount%o===0||a)){if(sm++,a&&ac>0&&this.context.time.frameCount%ac!==0)return;zs&&console.log("send update",this.context.connection.connectionId,this.guid,this.gameObject.name,this.gameObject.guid),this._needsUpdate=!1;const l=Rv(this.guid,this,!!a);this.context.connection.sendBinary(l)}}}const oP=x("debugshadowcomponents");ie.__webpack_exports__Block.prototype.interactable={get(){return this.interactive},set(s){this.interactable=s}};const Ui=Symbol("shadowDomOwner");class Gi extends D{constructor(){super(...arguments);r(this,"_shadowComponent",null);r(this,"_controlsChildLayout",!0);r(this,"_root");r(this,"_parentComponent")}isRoot(){var e;return((e=this.Root)==null?void 0:e.gameObject)===this.gameObject}get canvas(){const e=this.Root;return e!=null&&e.isCanvas?e:null}get Canvas(){return this.canvas}markDirty(){Gt.markUIDirty(this.context)}get shadowComponent(){return this._shadowComponent}set shadowComponent(e){this._shadowComponent=e}get controlsChildLayout(){return this._controlsChildLayout}set controlsChildLayout(e){this._controlsChildLayout=e,this.shadowComponent&&(this.shadowComponent.autoLayout=e)}get Root(){return this._root===void 0&&(this._root=S.getComponentInParent(this.gameObject,eh)),this._root}__internalNewInstanceCreated(e){return super.__internalNewInstanceCreated(e),this.shadowComponent=null,this._root=void 0,this._parentComponent=void 0,this}onEnable(){super.onEnable()}addShadowComponent(e,i){var a;if(!e)return;this.removeShadowComponent();const n=this.isRoot()?this.gameObject:this.gameObject.parent;if(this._parentComponent=S.getComponentInParent(n,Gi),!this._parentComponent){console.warn(`Component "${this.name}" doesn't have a UI parent anywhere. Do you have an UI element outside a Canvas? UI components must be a child of a Canvas component`,this);return}e.name=this.name+" ("+(this.constructor.name??"UI")+")",e.autoLayout=this._parentComponent.controlsChildLayout,e[Ui]=this,this.setShadowComponentOwner(e);let o=!1;if(((a=this.Root)==null?void 0:a.gameObject)===this.gameObject)this.gameObject.add(e);else{const l=this._parentComponent.shadowComponent;l&&(l==null||l.add(e),o=!0)}this.shadowComponent=e,i&&i.shadowComponent&&this.shadowComponent&&i.shadowComponent.add(this.shadowComponent),Hc&&e.add(new h.AxesHelper(.5)),this.onAfterAddedToScene(),o&&ie.__webpack_exports__update(),oP&&console.warn("Added shadow component",this.shadowComponent)}setShadowComponentOwner(e){if(e&&(e[Ui]===void 0||e[Ui]===this)&&(e[Ui]=this,e.children))for(const i of e.children)this.setShadowComponentOwner(i)}traverseOwnedShadowComponents(e,i,n){if(e&&e[Ui]===i){n(e);for(const o of e.children)this.traverseOwnedShadowComponents(o,i,n)}}removeShadowComponent(){this.shadowComponent&&this.shadowComponent.removeFromParent()}onAfterAddedToScene(){}setInteractable(e){this.shadowComponent&&(this.shadowComponent.interactable=e)}}class eh extends Gi{awake(){super.awake()}}class th{constructor(t,e){r(this,"event");r(this,"button");r(this,"buttonName");r(this,"_used",!1);r(this,"_propagationStopped",!1);r(this,"z__pointer_ctured",!1);r(this,"z__pointer_cture_rleased",!1);r(this,"inputSource");r(this,"object");r(this,"point");r(this,"normal");r(this,"face");r(this,"distance");r(this,"instanceId");r(this,"intersection");r(this,"isDown");r(this,"isUp");r(this,"isPressed");r(this,"isClick");r(this,"isDoubleClick");r(this,"input");this.event=e,this.input=t,this.button=e.button}get deviceIndex(){return this.event.deviceIndex}get pointerId(){return this.event.pointerId}get pressure(){return this.event.pressure}get used(){return this._used}use(){this._used||(this._used=!0,this.event.use())}get propagationStopped(){return this._propagationStopped}stopPropagation(){this._propagationStopped=!0,this.event.stopImmediatePropagation()}stopImmediatePropagation(){this._propagationStopped=!0,this.event.stopImmediatePropagation()}setPointerCapture(){this.z__pointer_ctured=!0}releasePointerCapture(){this.z__pointer_cture_rleased=!0}get mode(){return this.event.mode}clone(){const t=new th(this.input,this.event);return Object.assign(t,this),t}Use(){this.use()}StopPropagation(){this.event.stopImmediatePropagation()}}function Xd(s,t){return S.foreachComponent(s,i=>{if(!i.enabled)return;const n=i;if(t)switch(t){case"pointerdown":if(n.onPointerDown)return!0;break;case"pointerup":if(n.onPointerUp||n.onPointerClick)return!0;break;case"pointermove":if(n.onPointerEnter||n.onPointerExit||n.onPointerMove)return!0;break}else if(n.onPointerDown||n.onPointerUp||n.onPointerEnter||n.onPointerExit||n.onPointerClick)return!0},!1)===!0}const Xn=new Array;class ds{constructor(t,e,i,n){r(this,"enabled",!0);r(this,"target");r(this,"methodName");r(this,"arguments");this.target=t,this.methodName=e||null,this.arguments=i,n!=null&&(this.enabled=n)}get canClone(){return this.target instanceof Object}invoke(...t){if(this.enabled!==!1){if(typeof this.target=="function")this.arguments?(Xn.length=0,t!==void 0&&t.length>0&&Xn.push(...t),Xn.push(...this.arguments),this.target(...this.arguments),Xn.length=0):this.target(...t);else if(this.methodName!=null){const e=this.target[this.methodName];typeof e=="function"?this.arguments?(Xn.length=0,t!==void 0&&t.length>0&&Xn.push(...t),Xn.push(...this.arguments),e.call(this.target,...Xn),Xn.length=0):e.call(this.target,...t):this.arguments?this.target[this.methodName]=this.arguments[0]||t[0]:this.target[this.methodName]=t[0]}}}}const rP=s=>/^[A-Z]*$/.test(s);class Lu extends Event{constructor(){super(...arguments);r(this,"args")}}class ge{constructor(t){r(this,"isEventList",!0);r(this,"target");r(this,"key");r(this,"_isInvoking",!1);r(this,"methods",[]);r(this,"_methodsCopy",[]);if(this.methods=[],Array.isArray(t))for(const e of t)e instanceof ds?this.methods.push(e):typeof e=="function"&&this.methods.push(new ds(e));else typeof t=="function"&&this.methods.push(new ds(t))}__internalOnInstantiate(t){var n;const e=new Array;for(let o=0;o<this.methods.length;o++){const a=this.methods[o];if(!(a.target instanceof Function)){const l=a.target;let c=l==null?void 0:l.uuid;if(l&&(c=l.guid),c){const d=t[c];if(d){const u=(n=a.arguments)==null?void 0:n.map(f=>f instanceof Object&&f.uuid?t[f.uuid]:f!=null&&f.isComponent?t[f.guid]:f);e.push(new ds(d.clone,a.methodName,u,a.enabled))}else B()&&console.warn("Could not find target for event listener")}}}return new ge(e)}setEventTarget(t,e){if(this.key=t,this.target=e,this.key!==void 0){let i="",n=!1;for(const o of this.key)n&&rP(o)&&(i+="-"),n=!0,i+=o.toLowerCase();this.key=i}}get listenerCount(){var t;return((t=this.methods)==null?void 0:t.length)??0}get isInvoking(){return this._isInvoking}static from(...t){return new ge(t)}invoke(...t){var e;if(this._isInvoking)return console.warn("Circular event invocation detected. Please check your event listeners for circular references.",this),!1;if(((e=this.methods)==null?void 0:e.length)<=0)return!1;this._isInvoking=!0;try{this._methodsCopy.length=0,this._methodsCopy.push(...this.methods);for(const i of this._methodsCopy)i.invoke(...t);if(typeof this.target=="object"&&typeof this.key=="string"){const i=this.target.dispatchEvent;if(typeof i=="function"){const n=new Lu(this.key);n.args=t,i.call(this.target,n)}}}finally{this._isInvoking=!1,this._methodsCopy.length=0}return!0}addEventListener(t){return this.methods.push(new ds(t)),t}removeEventListener(t){if(t)for(let e=this.methods.length-1;e>=0;e--)this.methods[e].target===t&&(this.methods[e].enabled=!1,this.methods.splice(e,1))}removeAllEventListeners(){this.methods.length=0}}class aP extends Hi{constructor(){super([h.Color,me],"ColorSerializer")}onDeserialize(t){if(t!=null)return t.a!==void 0?new me(t.r,t.g,t.b,t.a):t.alpha!==void 0?new me(t.r,t.g,t.b,t.alpha):new h.Color(t.r,t.g,t.b)}onSerialize(t){if(t!=null)return t.a!==void 0?{r:t.r,g:t.g,b:t.b,a:t.a}:{r:t.r,g:t.g,b:t.b}}}const lP=new aP;class cP extends Hi{constructor(){super([h.Euler],"EulerSerializer")}onDeserialize(t,e){if(t!=null){if(t.order)return new h.Euler(t.x,t.y,t.z,t.order);if(t.x!=null)return new h.Euler(t.x,t.y,t.z)}}onSerialize(t,e){return{x:t.x,y:t.y,z:t.z,order:t.order}}}const hP=new cP;class dP extends Hi{constructor(){super(h.Object3D,"ObjectSerializer")}onSerialize(t,e){if(e.objectToNode!==void 0&&t.uuid){const i=e.objectToNode[t.uuid];return lt&&console.log(i,t.name,t.uuid),{node:i}}}onDeserialize(t,e){var i,n,o;if(typeof t=="string"){if(t.endsWith(".glb")||t.endsWith(".gltf")){if(e.serializable instanceof Array&&e.serializable.includes(ee))return;B()&&pe("Detected wrong usage of @serializable with Object3D or GameObject. Instead you should use AssetReference here! Please see the console for details.");const a=(n=(i=e.target)==null?void 0:i.constructor)==null?void 0:n.name;console.warn(`Wrong usage of @serializable detected in your script "${a}"

It looks like you used @serializable(Object3D) or @serializable(GameObject) for a prefab or scene reference which is exported to a separate glTF file.

To fix this please change your code to:

@serializable(AssetReference)
${e.path}! : AssetReference;
\0`)}return}if(t){if(t.node!==void 0&&e.nodeToObject){const a=e.nodeToObject[t.node];return lt&&console.log("Deserialized object reference?",t,a,e==null?void 0:e.nodeToObject),a||console.warn("Did not find node: "+t.node,e.nodeToObject,e.object),a}else if(t.guid){if(!e.context){console.error("Missing context");return}let a;const l=(o=e.gltf)==null?void 0:o.scene;return l&&(a=S.findByGuid(t.guid,l)),a||(a=S.findByGuid(t.guid,e.context.scene)),a?(a&&a.isComponent===!0&&(lt&&console.warn("Deserialized object reference is a component"),a=a.gameObject),lt&&console.log("Deserialized object reference?",t,a,e==null?void 0:e.nodeToObject)):((B()||lt)&&console.warn("Could not resolve object reference",e.path,t,e.target,e.context.scene),t.could_not_resolve=!0),a}}}}const kv=new dP;class uP extends Hi{constructor(){super([D,D],"ComponentSerializer")}onSerialize(t,e){if(t!=null&&t.guid)return{guid:t.guid}}onDeserialize(t,e){var i;if(t!=null&&t.guid){if(t.___persistentAsset){lt&&console.log("Skipping component deserialization because it's a persistent asset",t);return}const n=e.path;lt&&console.log(t.guid,e.root,e.object,e.target);let o=this.findObjectForGuid(t.guid,e.root);if(o||e.context&&(o=this.findObjectForGuid(t.guid,(i=e.context)==null?void 0:i.scene),o))return o;(B()||lt)&&console.warn('Could not resolve component reference: "'+n+'" using guid '+t.guid,e.target),t.could_not_resolve=!0;return}}findObjectForGuid(t,e){if(e.guid===t)return e;const i=S.foreachComponent(e,n=>{if(n.guid===t)return n},!1);if(i!==void 0)return i;for(let n=0;n<e.children.length;n++){const o=e.children[n],a=this.findObjectForGuid(t,o);if(a)return a}}}const xd=new uP;class fP extends Hi{constructor(){super([ge])}onSerialize(t,e){console.log("TODO: SERIALIZE EVENT")}onDeserialize(t,e){var i,n,o;if(typeof t=="function")return new ge([new ds(t,null,[],!0)]);if(t&&t.type==="EventList"){lt&&console.log("DESERIALIZE EVENT",t);const a=new Array;if(t.calls&&Array.isArray(t.calls))for(const d of t.calls){let u=function(g){if(typeof g=="object"){let _=kv.onDeserialize(g,e);if(_||(_=xd.onDeserialize(g,e)),_)return _}return g};lt&&console.log(d);let f=xd.findObjectForGuid(d.target,e.root);!f&&((i=e.context)!=null&&i.scene)&&(f=xd.findObjectForGuid(d.target,(n=e.context)==null?void 0:n.scene));const m=((o=d.method)==null?void 0:o.length)>0;if(f&&m){const g=()=>{const y=d.method[0].toUpperCase()+d.method.slice(1);if(typeof f[y]=="function"){console.warn(`EventList method:
Could not find method ${d.method} on object ${f.name}. Please rename ${d.method} to ${y}?
`,f[y],`
 in script: `,f),pe("EventList methods must start with lowercase letter, see console for details");return}else console.warn(`EventList method:
Could not find method ${d.method} on object ${f.name}`,f,typeof f[d.method])};if(typeof f[d.method]!="function"){let y=!1,b=f;for(;b;){const v=Object.getOwnPropertyDescriptor(b,d.method);if(v&&(v.writable===!0||v.set)){y=!0;break}b=Object.getPrototypeOf(b)}!y&&(B()||lt)&&g()}}if(f){let g=d.argument;if(g!==void 0?g=u(g):d.arguments!==void 0&&(g=d.arguments.map(u)),!f[d.method])console.warn(`EventList method not found: "${d.method}" on ${f==null?void 0:f.name}`);else{g!==void 0&&!Array.isArray(g)&&(g=[g]);const y=new ds(f,d.method,g,d.enabled);a.push(y)}}else B()&&console.warn("[Debug] EventList: Could not find event listener in scene",d,e.object,t)}const l=new ge(a);lt&&console.log(l);const c=e.target;return c!==void 0&&e.path!==void 0&&l.setEventTarget(e.path,c),l}}}const pP=new fP,Qd=new WeakMap,mP=h.Texture.prototype.clone;h.Texture.prototype.clone=function(){const s=mP.call(this);return Qd.has(s)||Qd.set(s,this),s};class Ev extends Hi{constructor(){super([so,h.WebGLRenderTarget])}onSerialize(t,e){}onDeserialize(t,e){if(t instanceof h.Texture&&e.type===so){let i=t;Qd.has(i)&&(i=Qd.get(i)),i.isRenderTargetTexture=!0,i.flipY=!0,i.offset.y=1,i.repeat.y=-1,i.needsUpdate=!0,i.mipmaps=[],i instanceof h.CompressedTexture&&(i.isCompressedTexture=!1,i.format=h.RGBAFormat);const n=new so(i.image.width,i.image.height,{colorSpace:h.LinearSRGBColorSpace});return n.texture=i,n}}}new Ev;class Tv extends Hi{constructor(){super([URL])}onSerialize(t,e){return null}onDeserialize(t,e){if(typeof t=="string"&&t.length>0)return mo(e.gltfId,t)}}new Tv;var gP=Object.defineProperty,_P=Object.getOwnPropertyDescriptor,yP=(s,t,e,i)=>{for(var n=i>1?void 0:i?_P(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&gP(t,e,n),n};class Ia extends D{awake(){Gt.createIfNoneExists(this.context)}onEnable(){var t;(t=Gt.get(this.context))==null||t.register(this)}onDisable(){var t;(t=Gt.get(this.context))==null||t.unregister(this)}}class Ci extends Ia{constructor(){super(...arguments);r(this,"targets",null);r(this,"raycastHits",[]);r(this,"ignoreSkinnedMeshes",!1)}start(){this.targets=[this.gameObject]}performRaycast(e=null){if(!this.targets)return null;e??(e=new Fn),e.targets=this.targets,e.results=this.raycastHits,e.useAcceleratedRaycast=!0;const i=e.testObject;this.ignoreSkinnedMeshes&&(e.testObject=o=>o instanceof h.SkinnedMesh?"continue in children":i?i(o):!0);const n=this.context.physics.raycast(e);return e.testObject=i,n}}yP([p()],Ci.prototype,"ignoreSkinnedMeshes",2);class Iu extends Ci{constructor(){super(),this.ignoreSkinnedMeshes=!0}}const b_=class extends Ia{performRaycast(t){if(!q.active||!b_.allow||!(t!=null&&t.ray))return null;const e=t.ray.origin,i=.015;return this.context.physics.sphereOverlap(e,i,!1,!0)}};let oo=b_;r(oo,"allow",!0);class ug{static getObject(t){const e=t[Ui];return e&&(e.isComponent===!0?t=e.gameObject:t=e),t}static isInteractable(t,e){if(e&&(e.canvasGroup=void 0,e.graphic=void 0),t==null||!t.visible||(t=this.getObject(t),!t.visible))return!1;const i=this.tryFindCanvasGroup(t);if((i==null?void 0:i.isCanvasGroup)===!0&&(e&&(e.canvasGroup=i),i.blocksRaycasts===!1||i.interactable===!1))return!1;const n=hr(t,o=>{if(o.isGraphic===!0)return o},!1);return e&&(n==null?void 0:n.isGraphic)===!0&&(e.graphic=n),!((n==null?void 0:n.raycastTarget)===!1||(n==null?void 0:n.layer)===2)}static tryFindCanvasGroup(t){if(!t)return null;const e=hr(t,i=>{const n=i;if(n.blocksRaycasts!==void 0&&n.interactable!==void 0)return n},!1);return e!==void 0?e:this.tryFindCanvasGroup(t.parent)}}function fg(s){const t=s[Ui];return t||(s.parent?fg(s.parent):null)}function bP(s){return s.isUI===!0||typeof s[Ui]=="object"}function Yd(s,t){if(!s)return;const e=s.material;if((e==null?void 0:e.isMaterial)===!0){const i=s.parent;i&&i.isText,e.side=t.doubleSided??!0?h.DoubleSide:h.FrontSide,e.shadowSide=t.doubleSided?h.DoubleSide:h.FrontSide,s.castShadow=t.castShadows?t.castShadows:!1,s.receiveShadow=t.receiveShadows?t.receiveShadows:!1}for(const i of s.children)Yd(i,t)}function na(s,t,e){s[t]===void 0&&console.warn("Field",t,"is undefined on",s);const i=Proxy.revocable(s[t],{set(a,l,c,d){const u=a[l],f=Reflect.set(a,l,c,d);return e(c,u),f}}),n=i.revoke,o=s[t];return i.revoke=()=>{s[t]=o,n()},s[t]=i.proxy,i}const Ly=Symbol("Scheduled action");function vP(s,t,e=ve.OnBeforeRender){let i=s[Ly];i||(i=s[Ly]={});const n=t.name;i[e]||(i[e]={});const o=i[e];if(o[n])return;function*l(){t==null||t.call(s),o[n]=null}const c=s.startCoroutine(l(),e);o[n]=c}const Ns=x("debugeventsystem");var om=(s=>(s.BeforeHandleInput="BeforeHandleInput",s.AfterHandleInput="AfterHandleInput",s))(om||{});Cv(s=>{Gt.createIfNoneExists(s)});class Gt extends D{constructor(){super(...arguments);r(this,"raycaster",[]);r(this,"pressedByID",new Map);r(this,"hoveredByID",new Map);r(this,"onPointerEvent",e=>{if(e===void 0||e.propagationStopped||e.defaultPrevented||e.used)return;const i=new th(this.context.input,e);this._currentPointerEventName=e.type,i.inputSource=this.context.input,i.isClick=e.isClick,i.isDoubleClick=e.isDoubleClick,i.isDown=e.type==ke.PointerDown,i.isUp=e.type==ke.PointerUp,i.isPressed=this.context.input.getPointerPressed(e.pointerId),Ns&&(i.isDown?console.log("DOWN",i.pointerId):i.isUp&&console.log("UP",i.pointerId),i.isClick&&console.log("CLICK",i.pointerId));const n=new Fn;e.hasRay?n.ray=e.ray:n.screenPoint=this.context.input.getPointerPositionRC(e.pointerId);const o=this.performRaycast(n);if(o){for(const l of o)l.event=e,e.intersections.push(l);e.origin.onPointerHits&&e.origin.onPointerHits({sender:this,event:e,hits:o})}Ns&&i.isClick&&Te("EventSystem: "+i.pointerId+" - "+this.context.time.frame+" - Up:"+i.isUp+", Down:"+i.isDown);const a={sender:this,args:i,hasActiveUI:this.currentActiveMeshUIComponents.length>0};this.dispatchEvent(new CustomEvent("BeforeHandleInput",{detail:a})),this.handleIntersections(o,i),this.dispatchEvent(new CustomEvent("AfterHandleInput",{detail:a}))});r(this,"_sortedHits",[]);r(this,"_testObjectsCache",new Map);r(this,"_currentlyActiveRaycaster",null);r(this,"_currentPointerEventName",null);r(this,"shouldRaycastObject",e=>{var a;const i=e&&"getComponent"in e?e.getComponent(Ia):null;if(i&&i!=this._currentlyActiveRaycaster)return!1;let n=null;if(bP(e)&&(n=(a=e[Ui])==null?void 0:a.gameObject),this._testObjectsCache.has(e)||n&&this._testObjectsCache.has(n))return this._testObjectsCache.get(e)===!1?"continue in children":!0;{let l=Xd(e,this._currentPointerEventName);if(!l&&n&&(l=Xd(n,this._currentPointerEventName)),l){this._testObjectsCache.set(e,!0);for(const c of e.children)this.shouldRaycastObject_AddToYesCache(c);return!0}return this._testObjectsCache.set(e,!1),"continue in children"}});r(this,"_sortingBuffer",[]);r(this,"_noDepthTestingResults",[]);r(this,"out",{});r(this,"_capturedPointer",{});r(this,"pointerEnterSymbol",Symbol("pointerEnter"));r(this,"pointerExitSymbol",Symbol("pointerExit"));r(this,"currentActiveMeshUIComponents",[])}static ensureUpdateMeshUI(e,i,n=!1){Hs.update(e,i,n)}static markUIDirty(e){Hs.markDirty()}static createIfNoneExists(e){e.scene.getComponent(Gt)||e.scene.addComponent(Gt)}static get(e){return this.createIfNoneExists(e),e.scene.getComponent(Gt)}static get instance(){return this.get(Q.Current)}register(e){var i;e&&this.raycaster&&!this.raycaster.includes(e)&&((i=this.raycaster)==null||i.push(e))}unregister(e){var n,o;const i=(n=this.raycaster)==null?void 0:n.indexOf(e);i!==void 0&&i!==-1&&((o=this.raycaster)==null||o.splice(i,1))}get hasActiveUI(){return this.currentActiveMeshUIComponents.length>0}get isHoveringObjects(){return this.hoveredByID.size>0}awake(){this.gameObject!==this.context.scene&&(this.enabled=!1)}start(){this.context.scene.getComponent(Ia)||this.context.scene.addComponent(Ci)}onEnable(){this.context.input.addEventListener(ke.PointerDown,this.onPointerEvent),this.context.input.addEventListener(ke.PointerUp,this.onPointerEvent),this.context.input.addEventListener(ke.PointerMove,this.onPointerEvent)}onDisable(){this.context.input.removeEventListener(ke.PointerDown,this.onPointerEvent),this.context.input.removeEventListener(ke.PointerUp,this.onPointerEvent),this.context.input.removeEventListener(ke.PointerMove,this.onPointerEvent)}onBeforeRender(){this.resetMeshUIStates()}shouldRaycastObject_AddToYesCache(e){this._testObjectsCache.set(e,!0);for(const i of e.children)this.shouldRaycastObject_AddToYesCache(i)}performRaycast(e){if(!this.raycaster)return null;this._testObjectsCache.clear(),this._sortedHits.length=0,e||(e=new Fn),e.testObject=this.shouldRaycastObject;for(const i of this.raycaster){if(!i.activeAndEnabled)continue;this._currentlyActiveRaycaster=i;const n=i.performRaycast(e);this._currentlyActiveRaycaster=null,n&&n.length>0&&this._sortedHits.push(...n)}return this._sortedHits.sort((i,n)=>i.distance-n.distance),this._sortedHits}assignHitInformation(e,i){i?(e.intersection=i,e.point=i.point,e.normal=i.normal,e.face=i.face,e.distance=i.distance,e.instanceId=i.instanceId):(e.intersection=void 0,e.point=void 0,e.normal=void 0,e.face=void 0,e.distance=void 0,e.instanceId=void 0)}handleIntersections(e,i){var o;if(e!=null&&e.length){e=this.sortCandidates(e);for(const a of e){if(i.event.immediatePropagationStopped)return!1;if(this.assignHitInformation(i,a),this.handleEventOnObject(a.object,i))return!0}}this.assignHitInformation(i,e==null?void 0:e[0]),this.invokePointerCapture(i);const n=this.hoveredByID.get(i.pointerId);return n&&this.propagatePointerExit(n.obj,n.data,null),this.hoveredByID.delete(i.pointerId),i.isUp&&((o=this.pressedByID.get(i.pointerId))==null||o.handlers.forEach(a=>this.invokeOnPointerUp(i,a)),this.pressedByID.delete(i.pointerId)),!1}sortCandidates(e){this._sortingBuffer.length=0,this._noDepthTestingResults.length=0;for(let i=0;i<e.length;i++){const n=e[i],o=n.object;if(o.material&&o.material.depthTest===!1){this._noDepthTestingResults.push(n);continue}this._sortingBuffer.push(n)}for(const i of this._sortingBuffer)this._noDepthTestingResults.push(i);return this._noDepthTestingResults}handleEventOnObject(e,i){if(!this.testIsVisible(e))return i.isClick&&Ns&&console.log("not allowed",e),!1;if(i.pointerId===void 0)return Ns&&console.error("Event without pointer can't be handled",i),!1;i.object=e;const n=e.parent,o=i.isClick??!1;let a=null;if(n&&n.isUI){const f=(i.isPressed||i.isClick)??!1;if(n[Ui]){const m=n[Ui].gameObject;if(m){if(!ug.isInteractable(m,this.out))return!1;a=this.out.canvasGroup??null,this.handleMeshUIIntersection(e,f),e=m}}}o&&Ns&&console.log(this.context.time.frame,e);const l=this.hoveredByID.get(i.pointerId),c=l==null?void 0:l.obj;c!==e&&c&&this.propagatePointerExit(c,l.data,e);const u=this.hoveredByID.get(i.pointerId);if(u?(u.obj=e,u.data=i):this.hoveredByID.set(i.pointerId,{obj:e,data:i}),i.isDown){const f=this.pressedByID.get(i.pointerId);f?(f.obj=e,f.data=i):this.pressedByID.set(i.pointerId,{obj:e,data:i,handlers:new Set})}return(a===null||a.interactable)&&this.handleMainInteraction(e,i,c??null),!0}propagate(e,i){for(;e;)S.foreachComponent(e,n=>{i(n)},!1),e=e.parent}handleMainInteraction(e,i,n){const o=this.pressedByID.get(i.pointerId),a=n!==e;let l=!0;switch(i.event.pointerType){case"mouse":case"touch":const c=this.context.input.getPointerPositionLastFrame(i.pointerId),d=this.context.input.getPointerPosition(i.pointerId);l=c&&!z.approximately(c,d);break}this.propagate(e,c=>{var u;const d=c;d.interactable!==!1&&(!d.activeAndEnabled||!d.enabled||(d.onPointerEnter&&a&&this.handlePointerEnter(d,i),i.isDown&&d.onPointerDown&&(d.onPointerDown(i),o==null||o.handlers.add(d),this.handlePointerCapture(i,d)),d.onPointerMove&&(l&&d.onPointerMove(i),this.handlePointerCapture(i,d)),i.isUp&&(d.onPointerUp&&(this.invokeOnPointerUp(i,d),o==null||o.handlers.delete(d)),d.onPointerExit&&((u=i.event)==null?void 0:u.pointerType)===Cu.Touch&&(this.handlePointerExit(d,i),this.hoveredByID.delete(i.pointerId))),i.isClick&&d.onPointerClick&&d.onPointerClick(i)))}),i.isUp&&(o==null||o.handlers.forEach(c=>{this.invokeOnPointerUp(i,c)}),this.pressedByID.delete(i.pointerId))}propagatePointerExit(e,i,n){this.propagate(e,o=>{if(!o.gameObject||o.destroyed)return;const a=o;if(a.onPointerExit||a.onPointerEnter){if(n&&this.isChild(n,o.gameObject))return;this.handlePointerExit(a,i)}})}invokeOnPointerUp(e,i){var n;(n=i.onPointerUp)==null||n.call(i,e),this.releasePointerCapture(e,i)}handlePointerEnter(e,i){e.onPointerEnter&&this.updatePointerState(e,i.pointerId,this.pointerEnterSymbol,!0)&&e.onPointerEnter(i),this.updatePointerState(e,i.pointerId,this.pointerExitSymbol,!1)}handlePointerExit(e,i){e.onPointerExit&&this.updatePointerState(e,i.pointerId,this.pointerExitSymbol,!0)&&e.onPointerExit(i),this.updatePointerState(e,i.pointerId,this.pointerEnterSymbol,!1)}updatePointerState(e,i,n,o){let a=e[n];if(o)return a&&a.includes(i)?!1:(a=a||[],a.push(i),e[n]=a,!0);{if(!a||!a.includes(i))return!1;const l=a.indexOf(i);return l!==-1&&a.splice(l,1),!0}}handlePointerCapture(e,i){if(e.z__pointer_ctured){e.z__pointer_ctured=!1;const n=e.pointerId;if(i.onPointerMove){const o=this._capturedPointer[n]||[];o.push(i),this._capturedPointer[n]=o}else B()&&!i.z__warned_no_pointermove&&(i.z__warned_no_pointermove=!0,console.warn("PointerCapture was requested but the component doesn't implement onPointerMove. It will not receive any pointer events"))}else e.z__pointer_cture_rleased&&(e.z__pointer_cture_rleased=!1,this.releasePointerCapture(e,i))}releasePointerCapture(e,i){const n=e.pointerId;if(this._capturedPointer[n]){const o=this._capturedPointer[n].indexOf(i);o!==-1&&(this._capturedPointer[n].splice(o,1),Ns&&console.log("released pointer capture",n,i,this._capturedPointer))}}invokePointerCapture(e){var i;if(e.event.type===ke.PointerMove){const n=e.pointerId,o=this._capturedPointer[n];if(o){Ns&&console.log("Captured",n,o);for(let a=0;a<o.length;a++){const l=o[a];if(l.destroyed){o.splice(a,1),a--;continue}(i=l.onPointerMove)==null||i.call(l,e)}}}}isChild(e,i){return!e||!i?!1:e===i?!0:e.parent?this.isChild(e.parent,i):!1}handleMeshUiObjectWithoutShadowDom(e,i){return!e||!e.isUI?!0:this.handleMeshUIIntersection(e,i)}handleMeshUIIntersection(e,i){const n=Hs.updateState(e,i);return n&&this.currentActiveMeshUIComponents.push(n),n!==null}resetMeshUIStates(){if(this.context.input.getPointerPressedCount()>0&&Hs.resetLastSelected(),!(!this.currentActiveMeshUIComponents||this.currentActiveMeshUIComponents.length<=0)){for(let e=0;e<this.currentActiveMeshUIComponents.length;e++){const i=this.currentActiveMeshUIComponents[e];Hs.resetState(i)}this.currentActiveMeshUIComponents.length=0}}testIsVisible(e){return e?S.isActiveSelf(e)?this.testIsVisible(e.parent):!1:!0}}class Hs{static markDirty(){this.needsUpdate=!0}static update(t,e,i=!1){if(i){t.update();return}const n=e.time.frameCount;for(const o of this.lastUpdateFrame)if(o.context===e){if(n===o.frame)return;o.frame=n;let a=this.needsUpdate||n<1;o.nextUpdate<=n&&(a=!0),a&&(Ns&&console.log("Update threemeshui"),this.needsUpdate=!1,o.nextUpdate=n+60,t.update());return}this.lastUpdateFrame=[{context:e,frame:n,nextUpdate:n+60}],t.update(),this.needsUpdate=!1}static updateState(t,e){let i=null;if(t&&(i=this.findBlockOrTextInParent(t),i&&i!==this.lastSelected)){if(i.interactable===!1)return null;this.needsUpdate=!0}return i}static resetLastSelected(){const t=this.lastSelected;t&&(this.lastSelected=null,this.resetState(t))}static resetState(t){t&&(this.needsUpdate=!0)}static findBlockOrTextInParent(t){return t?t.isBlock||t.isText?t:this.findBlockOrTextInParent(t.parent):null}}r(Hs,"lastSelected",null),r(Hs,"lastUpdateFrame",[]),r(Hs,"needsUpdate",!1);var wP=Object.defineProperty,xP=Object.getOwnPropertyDescriptor,Ae=(s,t,e,i)=>{for(var n=i>1?void 0:i?xP(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&wP(t,e,n),n};const Is=x("debugorbit"),Lf=x("freecam"),zh=x("debugcamerafit"),Nh=x("smoothcam"),SP={LEFT:"",UP:"",RIGHT:"",BOTTOM:""};let If;class Rc extends CustomEvent{constructor(t,e){super("target-reached",{detail:{controls:t,type:e}})}}class fe extends D{constructor(){super(...arguments);r(this,"autoTarget",!0);r(this,"autoFit",!1);r(this,"enableRotate",!0);r(this,"autoRotate",!1);r(this,"autoRotateSpeed",1);r(this,"minAzimuthAngle",1/0);r(this,"maxAzimuthAngle",1/0);r(this,"minPolarAngle",0);r(this,"maxPolarAngle",Math.PI);r(this,"enableKeys",!1);r(this,"enableDamping",!0);r(this,"dampingFactor",.1);r(this,"enableZoom",!0);r(this,"minZoom",0);r(this,"maxZoom",1/0);r(this,"zoomSpeed",1);r(this,"zoomToCursor",!1);r(this,"enablePan",!0);r(this,"lookAtConstraint",null);r(this,"lookAtConstraint01",1);r(this,"allowInterrupt",!0);r(this,"middleClickToFocus",!0);r(this,"doubleClickToFocus",!0);r(this,"clickBackgroundToFitScene",2);r(this,"debugLog",!1);r(this,"targetLerpDuration",1);r(this,"_controls",null);r(this,"_cameraObject",null);r(this,"_lookTargetLerpActive",!1);r(this,"_lookTargetStartPosition",new h.Vector3);r(this,"_lookTargetEndPosition",new h.Vector3);r(this,"_lookTargetLerp01",0);r(this,"_lookTargetLerpDuration",0);r(this,"_cameraLerpActive",!1);r(this,"_cameraStartPosition",new h.Vector3);r(this,"_cameraEndPosition",new h.Vector3);r(this,"_cameraLerp01",0);r(this,"_cameraLerpDuration",0);r(this,"_fovLerpActive",!1);r(this,"_fovLerpStartValue",0);r(this,"_fovLerpEndValue",0);r(this,"_fovLerp01",0);r(this,"_fovLerpDuration",0);r(this,"_inputs",0);r(this,"_enableTime",0);r(this,"_startedListeningToKeyEvents",!1);r(this,"_eventSystem");r(this,"_afterHandleInputFn");r(this,"_camera",null);r(this,"_syncedTransform");r(this,"_didSetTarget",0);r(this,"targetElement",null);r(this,"_activePointerEvents");r(this,"_lastTimeClickOnBackground",-1);r(this,"_clickOnBackgroundCount",0);r(this,"_onPointerDown",e=>{this._activePointerEvents.push(e)});r(this,"_onPointerDownLate",e=>{e.used&&this._controls&&(this._controls.enabled=!1)});r(this,"_onPointerUp",e=>{for(let i=this._activePointerEvents.length-1;i>=0;i--){const n=this._activePointerEvents[i];if(n.pointerId===e.pointerId&&n.button===e.button){this._activePointerEvents.splice(i,1);break}}if(this.clickBackgroundToFitScene>0&&e.isClick&&e.button===0){if(e.hasRay||e.intersections.push(...this.context.physics.raycast()),e.intersections.length<=0){const i=this.context.time.time-this._lastTimeClickOnBackground;this._lastTimeClickOnBackground=this.context.time.time,this.clickBackgroundToFitScene<=1||i<this.clickBackgroundToFitScene*.15?(this._clickOnBackgroundCount+=1,this._clickOnBackgroundCount>=this.clickBackgroundToFitScene-1&&this.fitCamera(this.context.scene.children,{immediate:!1})):this._clickOnBackgroundCount=0}Is&&console.log(this.clickBackgroundToFitScene,e.intersections.length,this._clickOnBackgroundCount)}});r(this,"_onPointerUpLate",e=>{this.doubleClickToFocus&&e.isDoubleClick&&!e.used&&this.setTargetFromRaycast()});r(this,"_orbitStartAngle",0);r(this,"onControlsChangeStarted",()=>{this._controls&&(this._orbitStartAngle=this._controls.getAzimuthalAngle()+this._controls.getPolarAngle()),this._syncedTransform&&this._syncedTransform.requestOwnership()});r(this,"onControlsChangeEnded",()=>{if(this._controls&&this.autoTarget){const i=this._controls.getAzimuthalAngle()+this._controls.getPolarAngle()-this._orbitStartAngle;Math.abs(i)<.01?(Is&&console.debug("OrbitControls: No movement detected, updating target now"),this.updateTargetNow()):Is&&console.debug("OrbitControls: Movement detected",i)}});r(this,"_shouldDisable",!1);r(this,"__onPreRender",()=>{const e=this.context.pre_render_callbacks.indexOf(this.__onPreRender);e>=0&&this.context.pre_render_callbacks.splice(e,1),this.autoFit&&(this.autoFit=!1,this.fitCamera({centerCamera:"y",immediate:!0,objects:this.scene.children}))});r(this,"_haveAttachedKeyboardEvents",!1)}get isCameraController(){return!0}get controls(){return this._controls}get controllerObject(){return this._cameraObject}onStartInteraction(e){var i;(i=this.controls)==null||i.addEventListener("start",e)}get targetLerpSpeed(){return 5}set targetLerpSpeed(e){this.targetLerpDuration=1/e}awake(){Is&&console.debug("OrbitControls",this),this._didSetTarget=0,this._startedListeningToKeyEvents=!1}start(){this._eventSystem=Gt.get(this.context)??void 0,this._eventSystem&&(this._afterHandleInputFn=this.afterHandleInput.bind(this),this._eventSystem.addEventListener(om.AfterHandleInput,this._afterHandleInputFn))}onDestroy(){var e,i;(e=this._controls)==null||e.dispose(),(i=this._eventSystem)==null||i.removeEventListener(om.AfterHandleInput,this._afterHandleInputFn)}onEnable(){this._didSetTarget=0,this._enableTime=this.context.time.time;const e=S.getComponent(this.gameObject,ye);this._camera=e;let i=e==null?void 0:e.threeCamera;if(!i&&this.gameObject instanceof h.PerspectiveCamera&&(i=this.gameObject),i&&Bp(i,this,!0),!this._controls&&i instanceof h.Object3D){this._cameraObject=i;const n=this.targetElement??this.context.renderer.domElement,o=i==null?void 0:i.quaternion.clone();this._controls=new Y.OrbitControls(i,n),i==null||i.quaternion.copy(o),If===void 0&&(If={...this._controls.keys});const a=Z(i),l=this.gameObject.worldForward,c=2.5,d=a.clone().sub(l.multiplyScalar(c));this._controls.target.copy(d)}if(this._controls)if(Lf&&(this.enablePan=!0,this.enableZoom=!0,this.middleClickToFocus=!0,exports.DeviceUtilities.isMobileDevice()&&(this.doubleClickToFocus=!0)),this._controls.addEventListener("start",this.onControlsChangeStarted),this._controls.addEventListener("end",this.onControlsChangeEnded),!this._startedListeningToKeyEvents&&this.enableKeys)this._startedListeningToKeyEvents=!0,this._controls.listenToKeyEvents(this.context.domElement);else try{this._controls.stopListenToKeyEvents()}catch{}this._syncedTransform=S.getComponent(this.gameObject,Un)??void 0,this.context.pre_render_callbacks.push(this.__onPreRender),this._activePointerEvents=[],this.context.input.addEventListener("pointerdown",this._onPointerDown,{queue:ei.Early}),this.context.input.addEventListener("pointerdown",this._onPointerDownLate,{queue:ei.Late}),this.context.input.addEventListener("pointerup",this._onPointerUp,{queue:ei.Early}),this.context.input.addEventListener("pointerup",this._onPointerUpLate,{queue:ei.Late})}onDisable(){var e;if((e=this._camera)!=null&&e.threeCamera&&Bp(this._camera.threeCamera,this,!1),this._controls){this._controls.enabled=!1,this._controls.autoRotate=!1,this._controls.removeEventListener("start",this.onControlsChangeStarted),this._controls.removeEventListener("end",this.onControlsChangeEnded);try{this._controls.stopListenToKeyEvents()}catch{}this._startedListeningToKeyEvents=!1}this._activePointerEvents.length=0,this.context.input.removeEventListener("pointerdown",this._onPointerDown),this.context.input.removeEventListener("pointerdown",this._onPointerDownLate),this.context.input.removeEventListener("pointerup",this._onPointerUp),this.context.input.removeEventListener("pointerup",this._onPointerUpLate)}updateTargetNow(){var o,a,l;const e=new h.Ray((o=this._cameraObject)==null?void 0:o.worldPosition,(a=this._cameraObject)==null?void 0:a.worldForward.multiplyScalar(-1)),i=this.context.physics.raycastFromRay(e),n=i.length>0?i[0]:void 0;n&&n.distance>this.minZoom&&n.distance<this.maxZoom&&(Is&&N.DrawWireSphere(n.point,.1,16711680,2),(l=this._controls)==null||l.target.copy(i[0].point))}afterHandleInput(e){e.detail.args.pointerId===0&&(e.detail.args.isDown?this._controls&&this._eventSystem&&(this._shouldDisable=this._eventSystem.hasActiveUI):(!e.detail.args.isPressed||e.detail.args.isUp)&&(this._shouldDisable=!1))}onBeforeRender(){var i,n,o,a;if(!this._controls)return;if(this._cameraObject!==this.context.mainCamera){this._controls.enabled=!1;return}if(this._controls.enabled=!0,(this.context.input.getPointerDown(1)||this.context.input.getPointerDown(2)||this.context.input.mouseWheelChanged||this.context.input.getPointerPressed(0)&&((i=this.context.input.getPointerPositionDelta(0))!=null&&i.length())||0>.1)&&(this._inputs+=1),this._inputs>0&&this.allowInterrupt&&(this.enableRotate&&(this.autoRotate=!1),this._cameraLerpActive=!1,this._lookTargetLerpActive=!1),this._inputs=0,this.autoTarget&&this._didSetTarget++===0){const l=S.getComponent(this.gameObject,ye);if(l&&!this.setLookTargetFromConstraint()){this.debugLog&&console.log("NO TARGET");const c=Z(l.threeCamera),d=Math.max(.01,c.length()),u=new h.Vector3(0,0,-d).applyMatrix4(l.threeCamera.matrixWorld);this.setLookTargetPosition(u,!0)}if(!this.setLookTargetFromConstraint()){const c=new Fn;c.screenPoint=new h.Vector2(0,0),c.lineThreshold=.1;const d=this.context.physics.raycast(c);d.length>0&&this.setLookTargetPosition(d[0].point,!0),zh&&console.log("OrbitControls hits",...d)}}if(this.middleClickToFocus&&this.context.input.getPointerClicked(1)&&this.setTargetFromRaycast(),this._lookTargetLerpActive||this._cameraLerpActive||this._fovLerpActive){if(this._cameraLerpActive&&this._cameraObject)if(this._cameraLerp01+=this.context.time.deltaTime/this._cameraLerpDuration,this._cameraLerp01>=1)this._cameraObject.position.copy(this._cameraEndPosition),this._cameraLerpActive=!1,this.dispatchEvent(new Rc(this,"camera"));else{const l=z.easeInOutCubic(this._cameraLerp01);this._cameraObject.position.lerpVectors(this._cameraStartPosition,this._cameraEndPosition,l)}if(this._lookTargetLerpActive)if(this._lookTargetLerp01+=this.context.time.deltaTime/this._lookTargetLerpDuration,this._lookTargetLerp01>=1)this._controls.target.copy(this._lookTargetEndPosition),this._lookTargetLerpActive=!1,this.dispatchEvent(new Rc(this,"lookat"));else{const l=z.easeInOutCubic(this._lookTargetLerp01);this._controls.target.lerpVectors(this._lookTargetStartPosition,this._lookTargetEndPosition,l)}if(this._fovLerpActive&&this._cameraObject){const l=this._cameraObject;if(this._fovLerp01+=this.context.time.deltaTime/this._fovLerpDuration,this._fovLerp01>=1)l.fov=this._fovLerpEndValue,this._fovLerpActive=!1;else{const c=z.easeInOutCubic(this._fovLerp01);l.fov=z.lerp(this._fovLerpStartValue,this._fovLerpEndValue,c)}l.updateProjectionMatrix()}}if(this._controls){if(this.debugLog&&(this._controls.domElement=this.context.renderer.domElement),this._controls.enabled=!this._shouldDisable&&this._camera===this.context.mainCameraComponent&&!this.context.isInXR&&!this._activePointerEvents.some(l=>l.used),this._controls.keys=this.enableKeys?If:SP,this._controls.autoRotate=this.autoRotate,this._controls.autoRotateSpeed=this.autoRotateSpeed,this._controls.enableZoom=this.enableZoom,this._controls.zoomSpeed=this.zoomSpeed,this._controls.zoomToCursor=this.zoomToCursor,this._controls.enableDamping=this.enableDamping,this._controls.dampingFactor=this.dampingFactor,this._controls.enablePan=this.enablePan,this._controls.enableRotate=this.enableRotate,this._controls.minAzimuthAngle=this.minAzimuthAngle,this._controls.maxAzimuthAngle=this.maxAzimuthAngle,this._controls.minPolarAngle=this.minPolarAngle,this._controls.maxPolarAngle=this.maxPolarAngle,Lf||(((o=(n=this._camera)==null?void 0:n.threeCamera)==null?void 0:o.type)==="PerspectiveCamera"?(this._controls.minDistance=this.minZoom,this._controls.maxDistance=this.maxZoom,this._controls.minZoom=0,this._controls.maxZoom=1/0):(this._controls.minDistance=0,this._controls.maxDistance=1/0,this._controls.minZoom=this.minZoom,this._controls.maxZoom=this.maxZoom)),typeof Nh=="number"||Nh===!0){this._controls.enableDamping=!0;const l=typeof Nh=="number"?Nh:.99;this._controls.dampingFactor=Math.max(.001,1-Math.min(1,l))}this.allowInterrupt||(this._lookTargetLerpActive&&(this._controls.enablePan=!1),this._cameraLerpActive&&(this._controls.enableRotate=!1,this._controls.autoRotate=!1),(this._lookTargetLerpActive||this._cameraLerpActive)&&(this._controls.enableZoom=!1)),this.context.isInXR||(!Lf&&((a=this.lookAtConstraint)!=null&&a.locked)&&this.setLookTargetFromConstraint(0,this.lookAtConstraint01),this._controls.update(this.context.time.deltaTime),Is&&N.DrawWireSphere(this._controls.target,.1,65280))}}setCameraAndLookTarget(e,i=!1){if(!e)return B()&&console.warn("[OrbitControls] setCameraAndLookTarget target is null"),!1;if(!(e instanceof h.Object3D)&&!(e instanceof ye))return B()&&console.warn("[OrbitControls] setCameraAndLookTarget target is not an Object3D or Camera"),!1;e instanceof ye&&(e=e.gameObject);const n=e.worldPosition,o=e.worldForward,a=new h.Ray(n,o.multiplyScalar(-1));return Is&&N.DrawRay(a.origin,a.direction,16711680,10),this.setTargetFromRaycast(a,i)||this.setLookTargetPosition(a.at(2,$()),i),this.setCameraTargetPosition(n,i),!0}setCameraTargetPosition(e,i=!1){var n;e&&(e instanceof h.Object3D&&(e=Z(e)),this._cameraEndPosition||(this._cameraEndPosition=new h.Vector3),this._cameraEndPosition.copy(e),i===!0?(this._cameraLerpActive=!1,this._cameraObject&&this._cameraObject.position.copy(this._cameraEndPosition)):this._cameraObject&&(this._cameraLerpActive=!0,this._cameraLerp01=0,this._cameraStartPosition.copy((n=this._cameraObject)==null?void 0:n.position),typeof i=="number"?this._cameraLerpDuration=i:this._cameraLerpDuration=this.targetLerpDuration))}get cameraLerpActive(){return this._cameraLerpActive}stopCameraLerp(){this._cameraLerpActive=!1}setFieldOfView(e,i=!1){var o;if(!this._controls||typeof e!="number")return;const n=(o=this._camera)==null?void 0:o.threeCamera;n&&(i===!0?n.fov=e:(this._fovLerpActive=!0,this._fovLerp01=0,this._fovLerpStartValue=n.fov,this._fovLerpEndValue=e,typeof i=="number"?this._fovLerpDuration=i:this._fovLerpDuration=this.targetLerpDuration))}setLookTargetPosition(e=null,i=!1){this._controls&&e&&(e instanceof h.Object3D&&(e=Z(e)),this._lookTargetEndPosition.copy(e),this._didSetTarget++,Is&&(console.warn("OrbitControls: setLookTargetPosition",e,i),N.DrawWireSphere(this._lookTargetEndPosition,.2,16711680,2)),i===!0?this._controls.target.copy(this._lookTargetEndPosition):(this._lookTargetLerpActive=!0,this._lookTargetLerp01=0,this._lookTargetStartPosition.copy(this._controls.target),typeof i=="number"?this._lookTargetLerpDuration=i:this._lookTargetLerpDuration=this.targetLerpDuration))}get lookTargetLerpActive(){return this._lookTargetLerpActive}stopLookTargetLerp(){this._lookTargetLerpActive=!1}setLookTargetFromConstraint(e=0,i=1){var o,a;if(!this._controls||((o=this.lookAtConstraint)==null?void 0:o.enabled)===!1)return!1;const n=(a=this.lookAtConstraint)==null?void 0:a.sources;if(n&&n.length>0){const l=n[e];if(l)return l.getWorldPosition(this._lookTargetEndPosition),this.lerpLookTarget(this._lookTargetEndPosition,i),!0}return!1}lerpTarget(e,i){return this.lerpLookTarget(e,i)}lerpLookTarget(e,i){this._controls&&(i>=1?this._controls.target.copy(e):this._controls.target.lerp(e,i))}setTargetFromRaycast(e,i=!1){if(!this.controls)return!1;const n=e?this.context.physics.raycastFromRay(e):this.context.physics.raycast();for(const o of n)if(o.distance>0&&S.isActiveInHierarchy(o.object)){const a=fg(o.object);if(a){const l=a.canvas;if(l!=null&&l.screenspace)break}return this.setLookTargetPosition(o.point,i),!0}return!1}fitCamera(e,i){var X,E;if(this.context.isInXR)return;let n;if(Array.isArray(e)?n=e:e&&"type"in e?n=e.children:e&&"objects"in e&&(n=e==null?void 0:e.objects,i=e),n&&!Array.isArray(n)&&(n=n.children),(!Array.isArray(n)||n&&n.length<=0)&&(n=this.context.scene.children),!Array.isArray(n)||n.length<=0){console.warn("No objects to fit camera to...");return}const o=this._cameraObject,a=this._controls;if(!o||!a){console.warn("No camera or controls found to fit camera to objects...");return}i||(i={});const{immediate:l=!1,centerCamera:c="y",cameraNearFar:d="auto",fitOffset:u=1.1,fov:f=o==null?void 0:o.fov}=i,m=new h.Vector3,g=new h.Vector3,_=si(n,void 0,(E=(X=this._camera)==null?void 0:X.threeCamera)==null?void 0:E.layers),y=_.clone();o.updateMatrixWorld(),o.updateProjectionMatrix(),_.getCenter(g);const b=new h.Vector3;if(_.getSize(b),_.applyMatrix4(o.matrixWorldInverse),_.getSize(m),_.setFromCenterAndSize(g,m),Number.isNaN(m.x)||Number.isNaN(m.y)||Number.isNaN(m.z)){console.warn("Camera fit size resultet in NaN",o,_,[...n]);return}if(m.length()<=1e-10){zh&&console.warn("Camera fit size is zero",_,[...n]);return}const v=i.fov||o.fov,w=2*Math.atan(Math.tan(v*Math.PI/360/2)*o.aspect)/Math.PI*360,P=m.y/(2*Math.atan(Math.PI*v/360)),k=m.x/(2*Math.atan(Math.PI*w/360)),O=u*Math.max(P,k)+m.z/2;zh&&console.log("Fit camera to objects",{fitHeightDistance:P,fitWidthDistance:k,distance:O,verticalFov:v,horizontalFov:w}),this.maxZoom=O*10,this.minZoom=O*.01;const M=.05,A=g.clone();if(A.y-=m.y*M,this.setLookTargetPosition(A,l),this.setFieldOfView(i.fov,l),d==null||d=="auto"){const L=S.findObjectOfType(Vn),V=L?L.radius:0,G=Math.max(b.x,b.y,b.z,V);o.near=O/100,o.far=G+O*10,L&&(this.maxZoom=Math.max(Math.min(this.maxZoom,V*.5),O))}const I=a.getDistance();I<this.minZoom&&(this.minZoom=I*.9),I>this.maxZoom&&(this.maxZoom=I*1.1),o.updateMatrixWorld(),o.updateProjectionMatrix();const T=Z(o),j=g.clone();j.sub(T),c==="y"&&(j.y=0),j.normalize(),j.multiplyScalar(O),c==="y"&&(j.y+=-M*4*O);let F=g.clone().sub(j);if(o.parent&&(F=o.parent.worldToLocal(F)),this.setCameraTargetPosition(F,l),zh){const L=new h.Box3Helper(_);this.context.scene.add(L),Im(L,Nc(o)),setTimeout(()=>{this.context.scene.remove(L)},1e4),N.DrawWireBox3(y,65280,10),this._haveAttachedKeyboardEvents||(this._haveAttachedKeyboardEvents=!0,document.body.addEventListener("keydown",V=>{if(V.code==="KeyF"){let G;this._cameraObject instanceof h.PerspectiveCamera&&(G=Math.random()*Math.random()*170+10),this.fitCamera({objects:n,fitOffset:u,immediate:!1,fov:G})}V.code==="KeyV"&&this._cameraObject instanceof h.PerspectiveCamera&&(this._cameraObject.fov=60)}))}a.update()}}Ae([p()],fe.prototype,"autoTarget",2);Ae([p()],fe.prototype,"autoFit",2);Ae([p()],fe.prototype,"enableRotate",2);Ae([p()],fe.prototype,"autoRotate",2);Ae([p()],fe.prototype,"autoRotateSpeed",2);Ae([p()],fe.prototype,"minAzimuthAngle",2);Ae([p()],fe.prototype,"maxAzimuthAngle",2);Ae([p()],fe.prototype,"minPolarAngle",2);Ae([p()],fe.prototype,"maxPolarAngle",2);Ae([p()],fe.prototype,"enableKeys",2);Ae([p()],fe.prototype,"enableDamping",2);Ae([p()],fe.prototype,"dampingFactor",2);Ae([p()],fe.prototype,"enableZoom",2);Ae([p()],fe.prototype,"minZoom",2);Ae([p()],fe.prototype,"maxZoom",2);Ae([p()],fe.prototype,"zoomSpeed",2);Ae([p()],fe.prototype,"enablePan",2);Ae([p(vr)],fe.prototype,"lookAtConstraint",2);Ae([p()],fe.prototype,"lookAtConstraint01",2);Ae([p()],fe.prototype,"allowInterrupt",2);Ae([p()],fe.prototype,"middleClickToFocus",2);Ae([p()],fe.prototype,"doubleClickToFocus",2);Ae([p()],fe.prototype,"clickBackgroundToFitScene",2);Ae([p()],fe.prototype,"targetLerpDuration",2);var CP=Object.defineProperty,PP=Object.getOwnPropertyDescriptor,qt=(s,t,e,i)=>{for(var n=i>1?void 0:i?PP(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&CP(t,e,n),n},ro=(s=>(s[s.None=0]="None",s[s.Skybox=1]="Skybox",s[s.SolidColor=2]="SolidColor",s[s.Uninitialized=4]="Uninitialized",s))(ro||{});const Vs=x("debugcam"),Iy=x("debugscreenpointtoray");var sd;const Nl=(sd=class extends D{constructor(){super(...arguments);r(this,"_nearClipPlane",.1);r(this,"_farClipPlane",1e3);r(this,"orthographic",!1);r(this,"orthographicSize",5);r(this,"ARBackgroundAlpha",0);r(this,"_cullingMask",4294967295);r(this,"_backgroundBlurriness");r(this,"_backgroundIntensity");r(this,"_backgroundRotation");r(this,"_environmentIntensity");r(this,"_targetTexture",null);r(this,"_backgroundColor");r(this,"_fov");r(this,"_cam",null);r(this,"_clearFlags",2);r(this,"_skybox");r(this,"_frustum");r(this,"_projScreenMatrix",new h.Matrix4)}get isCamera(){return!0}get aspect(){return this._cam instanceof h.PerspectiveCamera?this._cam.aspect:this.context.domWidth/this.context.domHeight}set aspect(t){this._cam instanceof h.PerspectiveCamera&&this._cam.aspect!==t&&(this._cam.aspect=t,this._cam.updateProjectionMatrix())}get fieldOfView(){return this._cam instanceof h.PerspectiveCamera?this._cam.fov:this._fov}set fieldOfView(t){const e=this.fieldOfView!=t;if(this._fov=t,e&&this._cam&&this._cam instanceof h.PerspectiveCamera){if(this._fov===void 0){console.warn("Can not set undefined fov on PerspectiveCamera");return}this._cam.fov=this._fov,this._cam.updateProjectionMatrix()}}get nearClipPlane(){return this._nearClipPlane}set nearClipPlane(t){const e=this._nearClipPlane!=t;this._nearClipPlane=t,this._cam&&(e||this._cam.near!=t)&&(this._cam.near=t,this._cam.updateProjectionMatrix())}get farClipPlane(){return this._farClipPlane}set farClipPlane(t){const e=this._farClipPlane!=t;this._farClipPlane=t,this._cam&&(e||this._cam.far!=t)&&(this._cam.far=t,this._cam.updateProjectionMatrix())}applyClippingPlane(){this._cam&&(this._cam.near=this._nearClipPlane,this._cam.far=this._farClipPlane,this._cam.updateProjectionMatrix())}get clearFlags(){return this._clearFlags}set clearFlags(t){if(typeof t=="string")switch(t){case"skybox":t=1;break;case"solidcolor":t=2;break;default:t=0;break}t!==this._clearFlags&&(this._clearFlags=t,this.applyClearFlagsIfIsActiveCamera())}set cullingMask(t){this._cullingMask=t,this._cam&&(this._cam.layers.mask=t)}get cullingMask(){return this._cam?this._cam.layers.mask:this._cullingMask}set cullingLayer(t){this.cullingMask=(1<<t|0)>>>0}set backgroundBlurriness(t){t!==this._backgroundBlurriness&&(t===void 0?this._backgroundBlurriness=void 0:this._backgroundBlurriness=Math.min(Math.max(t,0),1),this.applyClearFlagsIfIsActiveCamera())}get backgroundBlurriness(){return this._backgroundBlurriness}set backgroundIntensity(t){t!==this._backgroundIntensity&&(t===void 0?this._backgroundIntensity=void 0:this._backgroundIntensity=Math.min(Math.max(t,0),10),this.applyClearFlagsIfIsActiveCamera())}get backgroundIntensity(){return this._backgroundIntensity}set backgroundRotation(t){t!==this._backgroundRotation&&(t===void 0?this._backgroundRotation=void 0:this._backgroundRotation=t,this.applyClearFlagsIfIsActiveCamera())}get backgroundRotation(){return this._backgroundRotation}set environmentIntensity(t){this._environmentIntensity=t}get environmentIntensity(){return this._environmentIntensity}get backgroundColor(){return this._backgroundColor??null}set backgroundColor(t){t&&(this._backgroundColor||(this._backgroundColor=new me(1,1,1,1)),this._backgroundColor.copy(t),(!("alpha"in t)||t.alpha===void 0)&&(this._backgroundColor.alpha=1),this.applyClearFlagsIfIsActiveCamera())}set targetTexture(t){this._targetTexture=t}get targetTexture(){return this._targetTexture}get cam(){return this.threeCamera}get threeCamera(){return this.activeAndEnabled&&this.buildCamera(),this._cam}screenPointToRay(t,e,i){const n=this.threeCamera,o=Nl._origin;o.set(t,e,-1),this.context.input.convertScreenspaceToRaycastSpace(o),Iy&&console.log("screenPointToRay",t.toFixed(2),e.toFixed(2),"now:",o.x.toFixed(2),o.y.toFixed(2),"isInXR:"+this.context.isInXR),o.z=-1,o.unproject(n);const a=Nl._direction.set(o.x,o.y,o.z),l=Z(n);return a.sub(l),a.normalize(),i?(i.set(l,a),i):new h.Ray(l.clone(),a.clone())}getFrustum(){return this._frustum||(this._frustum=new h.Frustum,this.updateFrustum()),this._frustum}updateFrustum(){this._frustum||(this._frustum=new h.Frustum),this._frustum.setFromProjectionMatrix(this.getProjectionScreenMatrix(this._projScreenMatrix,!0),this.context.renderer.coordinateSystem)}getProjectionScreenMatrix(t,e){return e&&this._projScreenMatrix.multiplyMatrices(this.threeCamera.projectionMatrix,this.threeCamera.matrixWorldInverse),t===this._projScreenMatrix?t:t.copy(this._projScreenMatrix)}awake(){Iy&&window.addEventListener("pointerdown",t=>{const e=t.clientX,i=t.clientY;console.log("touch",e.toFixed(2),i.toFixed(2));const n=this.screenPointToRay(e,i),o="#"+Math.floor(Math.random()*16777215).toString(16);N.DrawRay(n.origin,n.direction,o,10)})}onEnable(){Vs&&console.log(`Camera enabled: "${this.name}". ClearFlags=${ro[this._clearFlags]}`,this),this.buildCamera(),(this.tag=="MainCamera"||!this.context.mainCameraComponent)&&(this.context.setCurrentCamera(this),MP(this)),this.applyClearFlagsIfIsActiveCamera({applySkybox:!0})}onDisable(){this.context.removeCamera(this)}onBeforeRender(){if(this._cam&&(this._frustum&&this.updateFrustum(),this._clearFlags===2&&this.applyClearFlagsIfIsActiveCamera(),this._targetTexture)){this.context.isManagedExternally&&(this._warnedAboutExternalRenderer||(this._warnedAboutExternalRenderer=!0,console.warn("Rendering with external renderer is not supported yet. This may not work or throw errors. Please remove the the target texture from your camera: "+this.name,this.targetTexture))),this.context.composer;const t=this.context.renderer;if(t){const e=this.context.mainCameraComponent;this.applyClearFlags(),this._targetTexture.render(this.context.scene,this._cam,t),e==null||e.applyClearFlags()}}}buildCamera(){if(this._cam)return;const t=this.gameObject.isCamera;let e=null;if(t?(e=this.gameObject,e==null||e.layers.enableAll(),e instanceof h.PerspectiveCamera&&(this._fov=e.fov)):e=this.gameObject.children[0],e&&e.isCamera)e instanceof h.PerspectiveCamera&&(this._fov&&(e.fov=this._fov),e.near=this._nearClipPlane,e.far=this._farClipPlane,e.updateProjectionMatrix());else if(!this.orthographic)e=new h.PerspectiveCamera(this.fieldOfView,window.innerWidth/window.innerHeight,this._nearClipPlane,this._farClipPlane),this.fieldOfView&&(e.fov=this.fieldOfView),this.gameObject.add(e);else{const i=this.orthographicSize*100;e=new h.OrthographicCamera(window.innerWidth/-i,window.innerWidth/i,window.innerHeight/i,window.innerHeight/-i,this._nearClipPlane,this._farClipPlane),this.gameObject.add(e)}this._cam=e,this._cam.layers.mask=this._cullingMask,this.tag=="MainCamera"&&this.context.setCurrentCamera(this)}applyClearFlagsIfIsActiveCamera(t){this.context.mainCameraComponent===this&&this.applyClearFlags(t)}applyClearFlags(t){var e;if(!this._cam){Vs&&console.log("Camera does not exist (apply clear flags)");return}if(this.fieldOfView=this._fov,Vs){const i=`Camera "${this.name}" clear flags: ${ro[this._clearFlags]}`;console.debug(i)}switch(this._clearFlags){case 0:return;case 1:if(Nl.backgroundShouldBeTransparent(this.context)&&(!this.ARBackgroundAlpha||this.ARBackgroundAlpha<.001)){this.context.scene.background=null,this.context.renderer.setClearColor(0,0);return}(!this.scene.background||!this._skybox||(t==null?void 0:t.applySkybox)===!0)&&this.applySceneSkybox(),this._backgroundBlurriness!==void 0?this.context.scene.backgroundBlurriness=this._backgroundBlurriness:Vs&&console.warn(`Camera "${this.name}" has no background blurriness`),this._backgroundIntensity!==void 0&&(this.context.scene.backgroundIntensity=this._backgroundIntensity),this._backgroundRotation!==void 0?this.context.scene.backgroundRotation=this._backgroundRotation:Vs&&console.warn(`Camera "${this.name}" has no background intensity`);break;case 2:if(this._backgroundColor){let i=this._backgroundColor.alpha;Nl.backgroundShouldBeTransparent(this.context)&&(i=this.ARBackgroundAlpha??0),this.context.scene.background=null,(e=this.context.xr)!=null&&e.isVR?this.context.renderer.setClearColor(qb(this._backgroundColor).convertLinearToSRGB()):this.context.renderer.setClearColor(this._backgroundColor,i)}else Vs&&console.warn(`Camera "${this.name}" has no background color`,this);break;case 4:this.context.scene.background=null,this.context.renderer.setClearColor(0,0);break}}applySceneSkybox(){this._skybox||(this._skybox=new OP(this)),this._skybox.apply()}static backgroundShouldBeTransparent(t){var o,a,l,c;const e=(o=t.renderer.xr)==null?void 0:o.getSession();if(!e)return!1;if(typeof e._transparent=="boolean")return e._transparent;const i=e.environmentBlendMode;Vs&&Te("Environment blend mode: "+i+" on "+navigator.userAgent);let n=i==="additive"||i==="alpha-blend";return t.isInAR&&i==="opaque"&&((a=navigator.userAgent)!=null&&a.includes("OculusBrowser")||(l=navigator.userAgent)!=null&&l.includes("Mozilla")&&((c=navigator.userAgent)!=null&&c.includes("Mobile WebXRViewer/v2")))&&(n=!0),e._transparent=n,n}},r(sd,"_origin",new h.Vector3),r(sd,"_direction",new h.Vector3),sd);let ye=Nl;qt([p()],ye.prototype,"aspect",1);qt([p()],ye.prototype,"fieldOfView",1);qt([p()],ye.prototype,"nearClipPlane",1);qt([p()],ye.prototype,"farClipPlane",1);qt([p()],ye.prototype,"clearFlags",1);qt([p()],ye.prototype,"orthographic",2);qt([p()],ye.prototype,"orthographicSize",2);qt([p()],ye.prototype,"ARBackgroundAlpha",2);qt([p()],ye.prototype,"cullingMask",1);qt([p()],ye.prototype,"backgroundBlurriness",1);qt([p()],ye.prototype,"backgroundIntensity",1);qt([p(h.Euler)],ye.prototype,"backgroundRotation",1);qt([p()],ye.prototype,"environmentIntensity",1);qt([p(me)],ye.prototype,"backgroundColor",1);qt([p(so)],ye.prototype,"targetTexture",1);class OP{constructor(t){r(this,"_camera");r(this,"_skybox");this._camera=t}get context(){var t;return(t=this._camera)==null?void 0:t.context}apply(){this._skybox=this.context.lightmaps.tryGetSkybox(this._camera.sourceId),this._skybox?this.context.scene.background!==this._skybox&&(Vs&&console.log(`Camera "${this._camera.name}" set skybox`,this._camera,this._skybox),this._skybox.mapping=h.EquirectangularReflectionMapping,this.context.scene.background=this._skybox):this._did_log_failed_to_find_skybox||(this._did_log_failed_to_find_skybox=!0,console.warn(`Camera "${this._camera.name}" has no skybox texture. ${this._camera.sourceId}`))}}function MP(s){x("freecam")&&s.context.mainCameraComponent===s&&S.getOrAddComponent(s.gameObject,fe)}class us extends D{constructor(){super(...arguments);r(this,"_listener",null);r(this,"onInteraction",()=>{this.destroyed||this.listener==null||this.addListenerIfItExists()})}get listener(){return this._listener==null&&(this._listener=new h.AudioListener),this._listener}onEnable(){cn.registerWaitForInteraction(this.onInteraction),this.addListenerIfItExists()}onDisable(){cn.unregisterWaitForInteraction(this.onInteraction),this.removeListenerIfItExists()}addListenerIfItExists(){const e=this._listener;if(!e||e!=null&&e.parent)return;const i=this.context.mainCameraComponent||S.getComponentInParent(this.gameObject,ye);i!=null&&i.threeCamera?i.threeCamera.add(e):this.gameObject.add(e),e.filter?(e.gain.connect(e.filter),e.filter.connect(e.context.destination)):e.gain.connect(e.context.destination)}removeListenerIfItExists(){const e=this._listener;e&&(e.removeFromParent(),e.filter&&e.filter.disconnect(),e.gain&&e.gain.disconnect())}}var RP=Object.defineProperty,kP=Object.getOwnPropertyDescriptor,mn=(s,t,e,i)=>{for(var n=i>1?void 0:i?kP(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&RP(t,e,n),n};const Mt=x("debugaudio"),$s=class extends D{constructor(){super(...arguments);r(this,"clip","");r(this,"playOnAwake",!1);r(this,"preload",!1);r(this,"playInBackground",!0);r(this,"_spatialBlend",0);r(this,"_minDistance",1);r(this,"_maxDistance",100);r(this,"_volume",1);r(this,"rollOffMode",0);r(this,"_loop",!1);r(this,"sound",null);r(this,"helper",null);r(this,"wasPlaying",!1);r(this,"audioLoader",null);r(this,"shouldPlay",!1);r(this,"_lastClipStartedLoading",null);r(this,"_audioElement",null);r(this,"onVisibilityChanged",()=>{switch(document.visibilityState){case"hidden":(this.playInBackground===!1||exports.DeviceUtilities.isMobileDevice())&&(this.wasPlaying=this.isPlaying,this.isPlaying&&this.pause());break;case"visible":Mt&&console.log("visible",this.enabled,this.playOnAwake,!this.isPlaying,$s.userInteractionRegistered,this.wasPlaying),this.enabled&&this.playOnAwake&&!this.isPlaying&&$s.userInteractionRegistered&&this.wasPlaying&&this.play();break}});r(this,"onApplicationMuteChanged",()=>{var t,e;this.context.application.muted?(t=this.sound)==null||t.setVolume(0):(e=this.sound)==null||e.setVolume(this.volume)});r(this,"createAudio",t=>{Mt&&console.log("AudioBuffer finished loading",t);const e=this.Sound;if(!e){Mt&&console.warn("Failed getting sound?",this.name);return}e.isPlaying&&e.stop(),t&&e.setBuffer(t),e.loop=this._loop,this.context.application.muted?e.setVolume(0):e.setVolume(this.volume),e.autoplay=this.shouldPlay&&$s.userInteractionRegistered,this.applySpatialDistanceSettings(),e.isPlaying&&e.stop(),$s.registerWaitForAllowAudio(this.__onAllowAudioCallback)});r(this,"__onAllowAudioCallback",()=>{this.shouldPlay&&this.play()});r(this,"_lastContextTime",0);r(this,"_hasEnded",!0);r(this,"_needUpdateSpatialDistanceSettings",!1)}static get userInteractionRegistered(){return cn.userInteractionRegistered}static registerWaitForAllowAudio(t){cn.registerWaitForInteraction(t)}get isPlaying(){var t;return((t=this.sound)==null?void 0:t.isPlaying)??!1}get duration(){var t,e;return(e=(t=this.sound)==null?void 0:t.buffer)==null?void 0:e.duration}get time01(){var e;const t=this.duration;return t&&this.sound?((e=this.sound)==null?void 0:e.context.currentTime)/t:0}set time01(t){const e=this.duration;e&&this.sound&&(this.time=t*e)}get time(){var t,e;return(t=this.sound)!=null&&t.source?((e=this.sound.source)==null?void 0:e.context.currentTime)-this._lastContextTime+this.sound.offset:0}set time(t){if(this.sound){if(t===this.sound.offset)return;const e=this.isPlaying;this.stop(),this.sound.offset=t,e&&this.play()}}get loop(){return this.sound&&(this._loop=this.sound.getLoop()),this._loop}set loop(t){this._loop=t,this.sound&&this.sound.setLoop(t)}get spatialBlend(){return this._spatialBlend}set spatialBlend(t){t!==this._spatialBlend&&(this._spatialBlend=t,this._needUpdateSpatialDistanceSettings=!0)}get minDistance(){return this._minDistance}set minDistance(t){this._minDistance!==t&&(this._minDistance=t,this._needUpdateSpatialDistanceSettings=!0)}get maxDistance(){return this._maxDistance}set maxDistance(t){this._maxDistance!==t&&(this._maxDistance=t,this._needUpdateSpatialDistanceSettings=!0)}get volume(){return this._volume}set volume(t){this._volume=t,this.sound&&!this.context.application.muted&&(Mt&&console.log(this.name,"audio set volume",t),this.sound.setVolume(t))}set pitch(t){this.sound&&this.sound.setPlaybackRate(t)}get pitch(){return this.sound?this.sound.getPlaybackRate():1}get Sound(){var t;if(!this.sound&&$s.userInteractionRegistered){let e=this.gameObject.getComponent(us)??this.context.mainCamera.getComponent(us)??Yc(us,this.context,!1);!e&&this.context.mainCamera&&(e=this.context.mainCamera.addComponent(us)),e!=null&&e.listener?(this.sound=new h.PositionalAudio(e.listener),(t=this.gameObject)==null||t.add(this.sound)):Mt&&console.warn("No audio listener found in scene - can not play audio")}return this.sound}get ShouldPlay(){return this.shouldPlay}get audioContext(){var t;return(t=this.sound)==null?void 0:t.context}awake(){Mt&&console.log(this),this.audioLoader=new h.AudioLoader,this.playOnAwake&&(this.shouldPlay=!0),this.preload&&typeof this.clip=="string"&&this.audioLoader.load(this.clip,this.createAudio,()=>{},console.error)}onEnable(){this.sound&&this.gameObject.add(this.sound),$s.userInteractionRegistered?this.playOnAwake&&this.context.application.isVisible&&this.play():$s.registerWaitForAllowAudio(()=>{this.enabled&&!this.destroyed&&this.shouldPlay&&this.onNewClip(this.clip)}),globalThis.addEventListener("visibilitychange",this.onVisibilityChanged),this.context.application.addEventListener(Nd.MuteChanged,this.onApplicationMuteChanged)}onDisable(){globalThis.removeEventListener("visibilitychange",this.onVisibilityChanged),this.context.application.removeEventListener(Nd.MuteChanged,this.onApplicationMuteChanged),this.pause()}applySpatialDistanceSettings(){const t=this.sound;if(!t)return;this._needUpdateSpatialDistanceSettings=!1;const e=z.lerp(10*this._maxDistance/Math.max(1e-4,this.spatialBlend),this._minDistance,this.spatialBlend);switch(Mt&&console.log(this.name,this._minDistance,this._maxDistance,this.spatialBlend,"Ref distance="+e),t.setRefDistance(e),t.setMaxDistance(Math.max(.01,this._maxDistance)),this.rollOffMode){case 0:t.setDistanceModel("exponential");break;case 1:t.setDistanceModel("linear");break;case 2:console.warn("Custom rolloff for AudioSource is not supported: "+this.name);break}this.spatialBlend>0?Mt&&!this.helper&&(this.helper=new Y.PositionalAudioHelper(t,t.getRefDistance()),t.add(this.helper)):this.helper&&this.helper.parent&&this.helper.removeFromParent()}async onNewClip(t){if(t&&(this.clip=t),typeof t=="string")if(Mt&&console.log(t),t.endsWith(".mp3")||t.endsWith(".wav")){if(this.audioLoader||(this.audioLoader=new h.AudioLoader),this.shouldPlay=!0,this._lastClipStartedLoading===t){Mt&&console.log("Is currently loading:",this._lastClipStartedLoading,this);return}this._lastClipStartedLoading=t,Mt&&console.log("load audio",t);const e=await this.audioLoader.loadAsync(t).catch(console.error);this._lastClipStartedLoading=null,e&&this.createAudio(e)}else console.warn("Unsupported audio clip type",t);else this.shouldPlay=!0,this.createAudio()}play(t=void 0){var i,n,o;!t&&this.clip&&(t=this.clip),t!==void 0&&typeof t!="string"&&!(t instanceof MediaStream)&&(B()&&console.warn("Called play on AudioSource with unknown argument type:",t+`
Using the assigned clip instead:`,this.clip),t=this.clip);let e=!this.sound||t&&t!==this.clip;if(typeof t=="string"&&!this.audioLoader&&(e=!0),(t instanceof MediaStream||typeof t=="string")&&(this.clip=t),e){this.shouldPlay=!0,this.onNewClip(t);return}if(this.shouldPlay=!0,this._hasEnded=!1,Mt&&console.log("play",(i=this.sound)==null?void 0:i.getVolume(),this.sound),this.sound&&!this.sound.isPlaying){const a=this.context.application.muted;a&&this.sound.setVolume(0),(n=this.gameObject)==null||n.add(this.sound),this.clip instanceof MediaStream?(this.sound.setMediaStreamSource(this.clip),this._audioElement||(this._audioElement=document.createElement("audio"),this._audioElement.style.display="none"),this._audioElement.parentNode||(o=this.context.domElement.shadowRoot)==null||o.append(this._audioElement),this._audioElement.srcObject=this.clip,this._audioElement.autoplay=!1):(this._audioElement&&this._audioElement.remove(),this.sound.play(a?.1:0))}}pause(){var t,e;Mt&&console.log("Pause",this),this._hasEnded=!0,this.shouldPlay=!1,this.sound&&this.sound.isPlaying&&this.sound.source&&(this._lastContextTime=(t=this.sound)==null?void 0:t.context.currentTime,this.sound.pause()),(e=this._audioElement)==null||e.remove()}stop(){var t,e;Mt&&console.log("Pause",this),this._hasEnded=!0,this.shouldPlay=!1,this.sound&&this.sound.source&&(this._lastContextTime=(t=this.sound)==null?void 0:t.context.currentTime,Mt&&console.log(this._lastContextTime),this.sound.stop()),(e=this._audioElement)==null||e.remove()}update(){this.helper&&(this.isPlaying&&this.helper.update(),this.helper.visible=this.isPlaying),this._needUpdateSpatialDistanceSettings&&this.applySpatialDistanceSettings(),this.sound&&!this.sound.isPlaying&&this.shouldPlay&&!this._hasEnded&&(this._hasEnded=!0,Mt&&console.log("Audio clip ended",this.clip),this.dispatchEvent(new CustomEvent("ended",{detail:this})))}};let Ie=$s;mn([p(URL)],Ie.prototype,"clip",2);mn([p()],Ie.prototype,"playOnAwake",2);mn([p()],Ie.prototype,"preload",2);mn([p()],Ie.prototype,"playInBackground",2);mn([p()],Ie.prototype,"loop",1);mn([p()],Ie.prototype,"spatialBlend",1);mn([p()],Ie.prototype,"minDistance",1);mn([p()],Ie.prototype,"maxDistance",1);mn([p()],Ie.prototype,"volume",1);mn([p()],Ie.prototype,"pitch",1);mn([p()],Ie.prototype,"rollOffMode",2);const EP=x("debugavatar"),tn=class extends D{constructor(){super(...arguments);r(this,"connectionId");r(this,"avatar")}static getAvatar(e){return e>=0&&e<tn.instances.length?tn.instances[e]:null}static onAvatarMarkerCreated(e){return tn._onNewAvatarMarkerAdded.push(e),e}static onAvatarMarkerDestroyed(e){return tn._onAvatarMarkerDestroyed.push(e),e}awake(){tn.instances.push(this),EP&&console.log(this);for(const e of tn._onNewAvatarMarkerAdded)e({avatarMarker:this,gameObject:this.gameObject})}onDestroy(){tn.instances.splice(tn.instances.indexOf(this),1);for(const e of tn._onAvatarMarkerDestroyed)e({avatarMarker:this,gameObject:this.gameObject})}isLocalAvatar(){return this.connectionId===this.context.connection.connectionId}};let tt=tn;r(tt,"instances",[]),r(tt,"_onNewAvatarMarkerAdded",[]),r(tt,"_onAvatarMarkerDestroyed",[]);class ms{static Add(t,e,i=null){if(e){for(const n of this.Pois)if(n.obj===e)return;this.Pois.push({obj:e,avatar:i}),this.LastChangeTime=t.time.time}}static Remove(t,e){var i;if(e){for(const n of this.Pois)if(n.obj===e){this.Pois.splice(this.Pois.indexOf(n),1),this.LastChangeTime=(t==null?void 0:t.time.time)??((i=Q.Current)==null?void 0:i.time.time);return}}}}r(ms,"Pois",[]),r(ms,"LastChangeTime",0);class TP{constructor(){r(this,"guid");r(this,"position",new h.Vector3)}}class kc extends D{constructor(){super(...arguments);r(this,"target",null);r(this,"avatar",null);r(this,"_model",null);r(this,"_targetModel",new TP);r(this,"_currentTargetObject",null);r(this,"_lastUpdateTime",0);r(this,"_lookDuration",0);r(this,"_lastPoiChangedTime",0)}set controlledTarget(e){this.target=e;const i=R.get("MoveRandom");if(i&&this.target){const n=S.getComponent(this.target,i);n&&n.destroy()}}awake(){if(this.avatar=S.getComponentInParent(this.gameObject,tt),this.avatar){const e=S.getComponentInParent(this.gameObject,tt);this._model=new Hm(this.context.connection,this.guid),e!=null&&e.isLocalAvatar&&this._model.requestOwnership()}this.context.connection.beginListen("avatar-look-target-changed",e=>{var i;this.target&&e&&e.guid===((i=this.avatar)==null?void 0:i.guid)&&it(this.target,e.position)})}update(){var i;if((!this.context.connection.isConnected||(i=this._model)!=null&&i.hasOwnership)&&(ms.LastChangeTime!==this._lastPoiChangedTime&&(this._lastPoiChangedTime=ms.LastChangeTime,this._lookDuration=0),this.selectTarget(),this._currentTargetObject&&this.context.time.frameCount%10===0&&this.target)){const n=Z(this._currentTargetObject);it(this.target,n),this.context.connection.isConnected&&this.avatar&&(this.context.connection.send("avatar-look-target-changed",this._targetModel),this._targetModel.guid=this.avatar.guid,this._targetModel.position.copy(n))}}selectTarget(){if(this.context.time.time-this._lastUpdateTime>this._lookDuration){this._lastUpdateTime=this.context.time.time,this._lookDuration=Math.random()*.5+.2;const i=ms.Pois;if(i.length>0){const n=i[Math.floor(Math.random()*i.length)];if(n&&n.obj){if(n.avatar&&n.avatar===this.avatar)return;this._currentTargetObject=n.obj}}}}}var ju=(s=>(s[s.None=0]="None",s[s.DontExport=1]="DontExport",s))(ju||{});function Av(s){return s&&s.isComponent}const AP=Symbol("object"),jf=new xi(()=>new h.Vector3,20);class Dv{constructor(t,e,i,n,o,a){r(this,"_point");r(this,"_normal");r(this,"_tangentVelocity");r(this,"distance");r(this,"impulse");r(this,"friction");this._point=t,this.distance=e,this._normal=i,this.impulse=n,this.friction=o,this._tangentVelocity=a}get point(){return jf.get().set(this._point.x,this._point.y,this._point.z)}get normal(){return jf.get().set(this._normal.x,this._normal.y,this._normal.z)}get tangentVelocity(){return jf.get().set(this._tangentVelocity.x,this._tangentVelocity.y,this._tangentVelocity.z)}}class Lv{constructor(t,e,i){r(this,"contacts");r(this,"me");r(this,"_collider");r(this,"_gameObject");this.me=t,this._collider=e,this._gameObject=e.gameObject,this.contacts=i}get collider(){return this._collider}get gameObject(){return this._gameObject}get rigidBody(){var t;return(t=this.collider)==null?void 0:t.attachedRigidbody}}class Iv{constructor(t,e){r(this,"object");r(this,"collider");this.object=t,this.collider=e}}const Ge=x("debugnetworkingstreams");var Dn=(s=>(s.Connected="peer-user-connected",s.StreamReceived="receive-stream",s.StreamEnded="call-ended",s.Disconnected="peer-user-disconnected",s.UserJoined="user-joined",s))(Dn||{});class pg{constructor(t,e){r(this,"type","call-ended");r(this,"userId");r(this,"direction");this.userId=t,this.direction=e}}class jv{constructor(t,e,i){r(this,"type","receive-stream");r(this,"userId");r(this,"stream");r(this,"target");this.userId=t,this.stream=e,this.target=i}}class DP{constructor(t,e){r(this,"guid");r(this,"peerId");r(this,"dontSave",!0);this.guid=t.id,this.peerId=e}}var Bv=(s=>(s.Incoming="incoming",s.Outgoing="outgoing",s))(Bv||{});class LP extends h.EventDispatcher{constructor(e,i,n,o=null){super();r(this,"peerId");r(this,"userId");r(this,"direction");r(this,"call");r(this,"_stream",null);r(this,"_isDisposed",!1);this.peerId=i.peer,this.userId=e,this.call=i,this.direction=n,this._stream=o,i.on("stream",a=>{if(Ge&&console.log("Receive stream",`
Audio:`,a.getAudioTracks(),`
Video:`,a.getVideoTracks()),this._stream=a,n==="incoming"){const l=new jv(e,a,this);this.dispatchEvent(l)}}),i.on("close",()=>{this.dispatchEvent(new pg(e,n))})}get stream(){return this._stream}close(){this._isDisposed||(this._isDisposed=!0,this.call.close(),Ln(this._stream))}get isOpen(){var e;return((e=this.call.peerConnection)==null?void 0:e.connectionState)==="connected"}get isOpening(){var e;return((e=this.call.peerConnection)==null?void 0:e.connectionState)==="connecting"}get isClosed(){return!this.isOpen||this._isDisposed}}function jy(s){return s=s.replace("a=fmtp:111 minptime=10;useinbandfec=1","a=fmtp:111 ptime=5;useinbandfec=1;stereo=1;maxplaybackrate=48000;maxaveragebitrat=128000;sprop-stereo=1"),s}const pa=class extends h.EventDispatcher{constructor(e,i){super();r(this,"updateCalls",()=>{var e;for(let i=this._incomingCalls.length-1;i>=0;i--){const n=this._incomingCalls[i];n.isClosed&&!n.isOpening&&this._incomingCalls.splice(i,1)}for(let i=this._outgoingCalls.length-1;i>=0;i--){const n=this._outgoingCalls[i];let o=!1;n.isClosed&&!n.isOpening&&((e=n.stream)!=null&&e.active?Ge&&console.warn("!!! Stream is still active, don't remove call",n.userId,"Your id: "+this.context.connection.connectionId):(Ge&&console.warn("!!! Remove closed call",n.userId),o=!0)),this.context.connection.userIsInRoom(n.userId)===!1&&(Ge&&console.warn("!!! User is not in room anymore, remove call",n.userId),o=!0),o&&(n.close(),this._outgoingCalls.splice(i,1))}});r(this,"id");r(this,"context");r(this,"_incomingCalls",[]);r(this,"_outgoingCalls",[]);r(this,"_peer");r(this,"_enabled",!1);r(this,"_enabledPeer",!1);r(this,"onConnectRoomFn",this.onConnectRoom.bind(this));r(this,"onPeerConnect",e=>{if(Ge&&console.log("PEER opened as",e),e===null){console.error("Peer connection failed",e);return}this.context.connection.send("peer-user-connected",new DP(this,e))});r(this,"onPeerClose",()=>{Ge&&console.log("PEER closed"),this.updateCalls()});r(this,"onPeerDisconnected",()=>{Ge&&console.log("PEER disconnected"),this.updateCalls()});r(this,"onPeerError",e=>{Ge&&console.error("PEER error",e)});r(this,"onPeerReceivingCall",e=>{e.answer(void 0,{sdpTransform:i=>jy(i)}),this.registerCall(e,"incoming",null)});this.context=e,this.id=i,this.setupPeer(),navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia}static getOrCreate(e,i){if(pa.instances.has(i))return pa.instances.get(i);const n=new pa(e,i);return pa.instances.set(i,n),n}getMyPeerId(){if(this.context.connection.connectionId)return this.getPeerIdFromUserId(this.context.connection.connectionId)}getPeerIdFromUserId(e){return this.id+"-"+e}getUserIdFromPeerId(e){return e.substring(this.id.length+1)}makeCall(e,i){var a;if(!(i!=null&&i.id)){Ge?console.warn("Can not make a call: mediastream has no id or is undefined"):console.debug("Can not make a call: mediastream has no id or is undefined");return}const n={metadata:{userId:this.context.connection.connectionId,streamId:i.id},sdpTransform:l=>jy(l)},o=(a=this._peer)==null?void 0:a.call(e,i,n);if(o){const l=this.registerCall(o,"outgoing",i);return Ge&&console.warn(`📞 CALL ${e}`,`
Outgoing:`,this._outgoingCalls,`
Incoming:`,this._incomingCalls),l}else Ge&&console.error("Failed to make call",e,i,this._peer)}closeAll(){for(const e of this._incomingCalls)e.close();for(const e of this._outgoingCalls)e.close();this.updateCalls()}get peer(){return this._peer}get incomingCalls(){return this._incomingCalls}enable(){this._enabled||(this._enabled=!0,this.context.connection.beginListen(J.JoinedRoom,this.onConnectRoomFn),this.subscribePeerEvents())}disable(){this._enabled&&(this._enabled=!1,this.context.connection.stopListen(J.JoinedRoom,this.onConnectRoomFn),this.unsubscribePeerEvents())}onConnectRoom(){this.setupPeer()}setupPeer(){if(this.context.connection.connectionId&&!this._enabledPeer){if(this._enabledPeer=!0,!this._peer){const e=this.getMyPeerId();e?this._peer=p0(e):console.error("Failed to setup peerjs because we dont have a connection id",this.context.connection.connectionId)}this._enabled&&this.subscribePeerEvents()}}subscribePeerEvents(){this._peer&&(this._peer.on("open",this.onPeerConnect),this._peer.on("close",this.onPeerClose),this._peer.on("call",this.onPeerReceivingCall),this._peer.on("disconnected",this.onPeerDisconnected),this._peer.on("error",this.onPeerError))}unsubscribePeerEvents(){this._peer&&(this._peer.off("open",this.onPeerConnect),this._peer.off("close",this.onPeerClose),this._peer.off("call",this.onPeerReceivingCall),this._peer.off("disconnected",this.onPeerDisconnected),this._peer.off("error",this.onPeerError))}registerCall(e,i,n){const o=e.metadata;(!o||!o.userId)&&console.error("Missing call metadata",e);const a=o.userId;i==="incoming"&&Ge?console.warn("← Receive call from",e.metadata,e.connectionId):Ge&&console.warn("→ Make call to",e.metadata);const l=i==="incoming"?this._incomingCalls:this._outgoingCalls,c=new LP(a,e,i,n);return l.push(c),e.on("error",d=>{console.error("Call error",d)}),e.on("close",()=>{Ge&&console.log("Call ended",e.metadata);const d=l.indexOf(c);d!==-1&&l.splice(d,1),c.close(),this.dispatchEvent(new pg(a,i))}),c.addEventListener("call-ended",d=>{this.dispatchEvent(d)}),i==="incoming"&&(c.addEventListener("receive-stream",d=>{this.dispatchEvent(d)}),e.on("stream",()=>{Ge&&console.log("Received stream for call",e.metadata);let d=0;const u=setInterval(()=>{const f=d===0;!c.isOpen&&f&&(Ge&&console.warn("Close call because stream is not active",e.metadata),d+=1,clearInterval(u),c.close())},2e3)})),c}};let ir=pa;r(ir,"instances",new Map);class ih extends h.EventDispatcher{constructor(e,i){super();r(this,"context");r(this,"peer");r(this,"_sendingStreams",new Map);r(this,"debug",!1);r(this,"_enabled",!1);r(this,"_tickIntervalId");r(this,"tick",()=>{this.updateSendingCalls()});r(this,"onJoinedRoom",e=>{this._sendingStreams.size>0&&(this.debug&&console.warn(`${e!=null&&e.userId?`User ${e.userId}`:"You"} joined room`,e,this._sendingStreams.size),this.updateSendingCalls())});r(this,"onLeftRoom",e=>{this.debug&&console.warn(`${(e==null?void 0:e.userId)||"You"} left room`,e),this.stopCallsToUsersThatAreNotInTheRoomAnymore(),this.peer.closeAll()});r(this,"onCallStreamReceived",e=>{this.debug&&console.log("Call with "+e.userId+" started"),this.dispatchEvent({type:"receive-stream",target:this,stream:e.stream,userId:e.userId}),this.debug&&this.debugLogCurrentState()});r(this,"onCallEnded",e=>{this.debug&&console.log("Call with "+e.userId+" ended"),this.dispatchEvent(e),this.debug&&this.debugLogCurrentState()});r(this,"onUserConnected",e=>{if(this.peer.id===e.guid){this.debug&&console.log("PEER USER CONNECTED",e.guid,e,this._sendingStreams.size);const i=this._sendingStreams.keys().next().value;this.peer.makeCall(e.peerId,i)}else Ge&&console.log("Unknown user connected",e.guid,e.peerId)});r(this,"onUserLeft",e=>{this.debug&&console.log("User left room: "+e.userId),this.stopCallsToUsersThatAreNotInTheRoomAnymore()});if(Av(e)){const n=e;e=n.context,i=ir.getOrCreate(n.context,n.guid)}else typeof i=="string"&&(i=ir.getOrCreate(e,i));if(e){if(!(e instanceof Q))throw new Error("Failed to create NetworkedStreams because context is not an instance of Context")}else throw new Error("Failed to create NetworkedStreams because context is undefined");if(!i)throw new Error("Failed to create NetworkedStreams because peer is undefined");this.context=e,this.peer=i,Ge&&(this.debug=!0)}static create(e,i){const n=ir.getOrCreate(e.context,i||e.context.connection.connectionId||e.guid);return new ih(e.context,n)}startSendingStream(e){this._sendingStreams.has(e)?console.warn("Received start sending stream with stream that is already being sent"):(this._sendingStreams.set(e,[]),this.updateSendingCalls())}stopSendingStream(e){if(e){const i=this._sendingStreams.get(e);if(i){for(const n of i)n.close();i.length=0}this._sendingStreams.delete(e),i&&this.debug&&this.debugLogCurrentState()}this.updateSendingCalls()}get enabled(){return this._enabled}enable(){this._enabled||(this._enabled=!0,this.peer.enable(),this.peer.addEventListener("receive-stream",this.onCallStreamReceived),this.peer.addEventListener("call-ended",this.onCallEnded),this.context.connection.beginListen("peer-user-connected",this.onUserConnected),this.context.connection.beginListen(J.JoinedRoom,this.onJoinedRoom),this.context.connection.beginListen(J.UserJoinedRoom,this.onJoinedRoom),this.context.connection.beginListen(J.UserLeftRoom,this.onUserLeft),this.context.connection.beginListen(J.LeftRoom,this.onLeftRoom),this._tickIntervalId=setInterval(this.tick,5e3))}disable(){this._enabled&&(this._enabled=!1,this.peer.disable(),this.peer.removeEventListener("receive-stream",this.onCallStreamReceived),this.peer.removeEventListener("call-ended",this.onCallEnded),this.context.connection.stopListen("peer-user-connected",this.onUserConnected),this.context.connection.stopListen(J.JoinedRoom,this.onJoinedRoom),this.context.connection.stopListen(J.UserJoinedRoom,this.onJoinedRoom),this.context.connection.stopListen(J.UserLeftRoom,this.onUserLeft),this.context.connection.stopListen(J.LeftRoom,this.onLeftRoom),this._tickIntervalId!=null&&(clearInterval(this._tickIntervalId),this._tickIntervalId=void 0))}updateSendingCalls(){const e=this.context.connection.connectionId;for(const i of this._sendingStreams.keys()){const n=this._sendingStreams.get(i)||[];for(const o of this.context.connection.usersInRoom()){if(o===e)continue;const a=this.peer.getPeerIdFromUserId(o);if(n.find(c=>{var d;return c.peerId===a&&c.direction==="outgoing"&&!c.isClosed&&((d=c.stream)==null?void 0:d.active)}))Ge&&console.debug("Already have a call with user "+o+" / peer "+a);else{const c=this.peer.makeCall(a,i);c&&n.push(c)}}this._sendingStreams.set(i,n)}this.stopCallsToUsersThatAreNotInTheRoomAnymore()}stopCallsToUsersThatAreNotInTheRoomAnymore(){for(const e of this._sendingStreams.keys()){const i=this._sendingStreams.get(e);if(i)for(let n=i.length-1;n>=0;n--){const o=i[n];this.context.connection.userIsInRoom(o.userId)?Ge&&(this.context.connection.connectionId===o.userId?console.warn(`You are still in the room [${n}] ${o.userId}`):console.log(`User is still in room [${n}] ${o.userId}`)):(Ge&&console.log(`Remove call ${[n]} to user that is not in room anymore ${o.userId}`),o.close(),i.splice(n,1))}}this.peer.updateCalls(),this.debug&&this.debugLogCurrentState()}debugLogCurrentState(){console.warn(`You (${this.context.connection.connectionId}) are currently sending ${this._sendingStreams.size} and receiving ${this.peer.incomingCalls.length} calls (${this.peer.incomingCalls.map(e=>e.userId).join(", ")})`,this.peer.incomingCalls)}}function Ln(s){if(s&&s instanceof MediaStream)for(const t of s.getTracks())t.stop()}var IP=Object.defineProperty,jP=Object.getOwnPropertyDescriptor,mg=(s,t,e,i)=>{for(var n=i>1?void 0:i?jP(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&IP(t,e,n),n};const BP="noVoip",FP=x("debugvoip");class bo extends D{constructor(){super(...arguments);r(this,"autoConnect",!0);r(this,"runInBackground",!0);r(this,"createMenuButton",!0);r(this,"debug",!1);r(this,"_net");r(this,"_menubutton");r(this,"_allowSending",!0);r(this,"_outputStream",null);r(this,"onJoinedRoom",async()=>{this.debug&&console.log("VOIP: Joined room"),await un(300),this.autoConnect&&!this.isSending&&this._allowSending&&this.connect()});r(this,"onLeftRoom",()=>{this.debug&&console.log("VOIP: Left room"),this.disconnect();for(const e of this._incomingStreams.values())Ln(e.srcObject);this._incomingStreams.clear()});r(this,"_incomingStreams",new Map);r(this,"onReceiveStream",e=>{const i=e.target.userId,n=e.stream;let o=this._incomingStreams.get(i);o||(o=new Audio,this._incomingStreams.set(i,o)),o.srcObject=n,o.setAttribute("autoplay","true"),cn.registerWaitForInteraction(()=>{o==null||o.play().catch(a=>{console.error("VOIP: Failed to play audio",a)})})});r(this,"onStreamEnded",e=>{const i=this._incomingStreams.get(e.userId);Ln(i==null?void 0:i.srcObject),this._incomingStreams.delete(e.userId)});r(this,"onEnabledChanged",()=>{for(const e of this._incomingStreams){const i=e[1];i.muted=!this.enabled}});r(this,"onVisibilityChanged",()=>{if(this.runInBackground)return;const i=!(document.visibilityState==="visible");this.setMuted(i);for(const n of this._incomingStreams){const o=n[1];o.muted=i}})}awake(){FP&&(this.debug=!0),this.debug&&(console.log("VOIP debugging: press 'v' to toggle mute or 'c' to toggle connect/disconnect"),window.addEventListener("keydown",async e=>{switch(e.key.toLowerCase()){case"v":console.log("MUTE?",!this.isMuted),this.setMuted(!this.isMuted);break;case"c":this.isSending?this.disconnect():this.connect();break}}),window.addEventListener("blur",()=>{console.log("VOIP: MUTE ON BLUR"),this.setMuted(!0)}),window.addEventListener("focus",()=>{console.log("VOIP: UNMUTE ON FOCUS"),this.setMuted(!1)}))}onEnable(){this._net||(this._net=ih.create(this)),this.debug&&(this._net.debug=!0),this._net.addEventListener(Dn.StreamReceived,this.onReceiveStream),this._net.addEventListener(Dn.StreamEnded,this.onStreamEnded),this._net.enable(),this.autoConnect&&this.context.connection.isConnected&&this.connect(),this.context.connection.beginListen(J.JoinedRoom,this.onJoinedRoom),this.context.connection.beginListen(J.LeftRoom,this.onLeftRoom),this.onEnabledChanged(),this.updateButton(),window.addEventListener("visibilitychange",this.onVisibilityChanged)}onDisable(){var e;this._net&&(this._net.stopSendingStream(this._outputStream),this._net.removeEventListener(Dn.StreamReceived,this.onReceiveStream),this._net.removeEventListener(Dn.StreamEnded,this.onStreamEnded),(e=this._net)==null||e.disable()),this.context.connection.stopListen(J.JoinedRoom,this.onJoinedRoom),this.context.connection.stopListen(J.LeftRoom,this.onLeftRoom),this.onEnabledChanged(),this.updateButton(),window.removeEventListener("visibilitychange",this.onVisibilityChanged)}onDestroy(){var e;(e=this._menubutton)==null||e.remove(),this._menubutton=void 0}get isSending(){return this._outputStream!=null&&this._outputStream.active}async connect(e){var i,n;if(!this._net)return console.error("Cannot connect to voice chat - NetworkedStreams not initialized. Make sure the component is enabled before calling this method."),!1;if(this.context.connection.isConnected){if(!await exports.DeviceUtilities.microphonePermissionsGranted())return console.error("Cannot connect to voice chat - microphone permissions not granted"),this.updateButton(),!1}else return console.error("Cannot connect to voice chat - not connected to server"),this.updateButton(),!1;return this._allowSending=!0,(i=this._net)==null||i.stopSendingStream(this._outputStream),Ln(this._outputStream),this._outputStream=await this.getAudioStream(e),this._outputStream?(this.debug&&console.log("VOIP: Got audio stream"),(n=this._net)==null||n.startSendingStream(this._outputStream),this.updateButton(),!0):(this.updateButton(),await exports.DeviceUtilities.microphonePermissionsGranted()?console.error("VOIP: Could not get audio stream - please make sure to connect an audio device and grant microphone permissions"):$c("Microphone permissions not granted: Please grant microphone permissions to use voice chat"),(this.debug||B())&&console.log("VOIP: Failed to get audio stream"),!1)}disconnect(e){var i;e!=null&&e.remember&&(this._allowSending=!1),(i=this._net)==null||i.stopSendingStream(this._outputStream),Ln(this._outputStream),this._outputStream=null,this.updateButton()}setMuted(e){var n;const i=(n=this._outputStream)==null?void 0:n.getAudioTracks();if(i)for(const o of i)o.enabled=!e}get isMuted(){var i;if(this._outputStream===null)return!1;const e=(i=this._outputStream)==null?void 0:i.getAudioTracks();if(e){for(const n of e)if(!n.enabled)return!0}return!1}async updateButton(){var e;if(this.createMenuButton){if(this._menubutton||(this._menubutton=document.createElement("button"),this._menubutton.addEventListener("click",()=>{this.isSending?this.disconnect({remember:!0}):this.connect(),exports.DeviceUtilities.microphonePermissionsGranted().then(i=>{i||pe("<strong>Microphone permissions not granted</strong>. Please allow your browser to use the microphone to be able to talk. Click on the button on the left side of your browser's address bar to allow microphone permissions.")})})),this._menubutton){this.context.menu.appendChild(this._menubutton),this.activeAndEnabled?this._menubutton.style.display="":this._menubutton.style.display="none",this._menubutton.title=this.isSending?"Click to disable your microphone":"Click to enable your microphone";let i=(this.isSending,""),n=this.isSending?"mic":"mic_off";await exports.DeviceUtilities.microphonePermissionsGranted()||(i="No Permission",n="mic_off",this._menubutton.title="Microphone permissions not granted. Please allow your browser to use the microphone to be able to talk. This can usually be done in the addressbar of the webpage."),this._menubutton.innerText=i,this._menubutton.prepend(yt(n)),this.context.connection.isConnected==!1?this._menubutton.setAttribute("disabled",""):this._menubutton.removeAttribute("disabled")}}else this.activeAndEnabled||(e=this._menubutton)==null||e.remove()}getFrequency(e){return this.unsupported_getfrequency||(this.unsupported_getfrequency=!0,B()&&pe("VOIP: getFrequency is currently not supported"),console.warn("VOIP: getFrequency is currently not supported")),null}async getAudioStream(e){if(!navigator.mediaDevices.getUserMedia)return console.error("No getDisplayMedia support"),null;const i=async o=>await navigator.mediaDevices.getUserMedia({audio:o??!0,video:!1}).catch(a=>(console.warn("VOIP failed getting audio stream",a),null)),n=await i(e);if(!n)return null;if(exports.DeviceUtilities.isiOS()&&(e==null?void 0:e.deviceId)===void 0){const a=(await navigator.mediaDevices.enumerateDevices()).find(l=>(l.kind==="audioinput"||l.kind==="audiooutput")&&!l.label.includes("iPhone"));if(a){const l=Object.assign({},e);return l.deviceId=a.deviceId,await i(l)}}return n}}mg([p()],bo.prototype,"autoConnect",2);mg([p()],bo.prototype,"runInBackground",2);mg([p()],bo.prototype,"createMenuButton",2);var UP=Object.defineProperty,zP=Object.getOwnPropertyDescriptor,Fv=(s,t,e,i)=>{for(var n=i>1?void 0:i?zP(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&UP(t,e,n),n};const NP=x("debugmouth");class nh extends D{constructor(){super(...arguments);r(this,"idle",[]);r(this,"talking",[]);r(this,"marker",null);r(this,"voip",null);r(this,"lastMouthChangeTime",0);r(this,"mouthChangeLength",0)}awake(){setTimeout(()=>{this.voip=S.findObjectOfType(bo,this.context),this.marker||(this.marker=S.getComponentInParent(this.gameObject,tt))},3e3)}update(){var n;if(!this.voip||this.context.time.frameCount%10!==0)return;let e=((n=this.marker)==null?void 0:n.connectionId)??null;if(!e){NP&&(e=null);return}const i=this.voip.getFrequency(e)??0;this.updateLips(i)}updateLips(e){if(this.context.time.time-this.lastMouthChangeTime>this.mouthChangeLength){if(this.mouthChangeLength=.05+Math.random()*.1,this.talking&&this.talking.length>0&&e>30){this.lastMouthChangeTime=this.context.time.time;const i=Math.floor(Math.random()*this.talking.length);this.setMouthShapeActive(this.talking,i)}else if(this.idle.length>0&&this.context.time.time-this.lastMouthChangeTime>.5){this.lastMouthChangeTime=this.context.time.time;const i=Math.floor(Math.random()*this.idle.length);this.setMouthShapeActive(this.idle,i)}}}setMouthShapeActive(e,i){if(e){e!=this.idle?this.idle.map(n=>n.visible=!1):this.talking.map(n=>n.visible=!1);for(let n=0;n<e.length;n++){const o=e[n];o&&(o.visible=n===i)}}}}Fv([p(h.Object3D)],nh.prototype,"idle",2);Fv([p(h.Object3D)],nh.prototype,"talking",2);class gg extends D{constructor(){super(...arguments);r(this,"voip",null);r(this,"marker",null);r(this,"_startPosition",null)}awake(){this.voip=S.findObjectOfType(bo,this.context),this.marker=S.getComponentInParent(this.gameObject,tt)}update(){if(!this.voip||!this.marker||this.context.time.frameCount%10!==0)return;const e=this.marker.connectionId,i=this.voip.getFrequency(e);if(i==null)return;this._startPosition||(this._startPosition=this.gameObject.position.clone());const n=i/100;this.gameObject.position.y=this._startPosition.y+n*.07}}var VP=Object.defineProperty,$P=Object.getOwnPropertyDescriptor,WP=(s,t,e,i)=>{for(var n=i>1?void 0:i?$P(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&VP(t,e,n),n};const sa=x("debugxrflags"),Uv=x("disablexrflags");Uv&&console.warn("XRFlags are disabled");var En=(s=>(s[s.Never=0]="Never",s[s.Browser=1]="Browser",s[s.AR=2]="AR",s[s.VR=4]="VR",s[s.FirstPerson=8]="FirstPerson",s[s.ThirdPerson=16]="ThirdPerson",s[s.All=4294967295]="All",s))(En||{});const v_=class{constructor(){r(this,"Mask",17)}Has(t){return(this.Mask&t)!==0}Set(t){sa&&console.warn("Set XR flag state to",t),this.Mask=t,_i.Apply()}Enable(t){this.Mask|=t,_i.Apply()}Disable(t){this.Mask&=~t,_i.Apply()}Toggle(t){this.Mask^=t,_i.Apply()}EnableAll(){this.Mask=-1,_i.Apply()}DisableAll(){this.Mask=0,_i.Apply()}};let Rt=v_;r(Rt,"Global",new v_);var Tl;const Jn=(Tl=class extends D{constructor(){super(...arguments);r(this,"visibleIn")}static Apply(){for(const t of this.registry)t.UpdateVisible(Rt.Global)}awake(){Jn.registry.push(this)}onEnable(){Jn.firstApply?this.UpdateVisible(Rt.Global):(Jn.firstApply=!0,Jn.Apply())}onDestroy(){const t=Jn.registry.indexOf(this);t>=0&&Jn.registry.splice(t,1)}get isOn(){return this.gameObject.visible}UpdateVisible(t=null){if(Uv)return;let e;const i=t;if(i&&typeof i=="number"&&(console.assert(typeof i=="number","XRFlag.UpdateVisible: state must be a number",i),sa&&console.log(i),Jn.buffer.Mask=i,t=Jn.buffer),t instanceof Rt?(sa&&console.warn(this.name,"use passed in mask",t.Mask,this.visibleIn),e=t.Has(this.visibleIn)):(sa&&console.log(this.name,"use global mask"),Rt.Global.Has(this.visibleIn)),e!==void 0)if(e)sa&&console.log(this.name,"is visible",this.gameObject.uuid),S.setActive(this.gameObject,!0);else{if(sa&&console.log(this.name,"is not visible",this.gameObject.uuid),!this.gameObject.visible)return;this.gameObject.visible=!1}}},r(Tl,"registry",[]),r(Tl,"firstApply"),r(Tl,"buffer",new Rt),Tl);let _i=Jn;WP([p()],_i.prototype,"visibleIn",2);var GP=Object.defineProperty,HP=Object.getOwnPropertyDescriptor,Bu=(s,t,e,i)=>{for(var n=i>1?void 0:i?HP(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&GP(t,e,n),n};class wr extends D{constructor(){super(...arguments);r(this,"eyes",[]);r(this,"lastBlinkTime",0);r(this,"blinkLength",0);r(this,"eyesOpen",!0);r(this,"state",null)}awake(){this.state=S.getComponentInParent(this.gameObject,_i)}update(){if(!this.gameObject||!this.gameObject.visible||!this.eyes||!Array.isArray(this.eyes)||this.eyes.length===0)return;if(this.context.time.time-this.lastBlinkTime>this.blinkLength){if(this.lastBlinkTime=this.context.time.time,this.state&&!this.state.isOn||!this.activeAndEnabled)return;if(this.eyesOpen=!this.eyesOpen,this.blinkLength=Math.random(),this.eyesOpen?(this.blinkLength*=3,this.blinkLength+=.5,Math.random()<.1&&(this.blinkLength=.1+Math.random()*.2)):(this.blinkLength*=Math.random()*.2,this.blinkLength+=.1),Math.random()<.1&&(this.blinkLength*=3),this.blinkLength=Math.max(.2,this.blinkLength),this.blinkLength=Math.min(3,this.blinkLength),this.eyes)for(const i of this.eyes)i&&(i.visible=this.eyesOpen)}}}Bu([p(h.Object3D)],wr.prototype,"eyes",2);Bu([p()],wr.prototype,"lastBlinkTime",2);Bu([p()],wr.prototype,"blinkLength",2);Bu([p()],wr.prototype,"eyesOpen",2);var qP=Object.defineProperty,XP=Object.getOwnPropertyDescriptor,_g=(s,t,e,i)=>{for(var n=i>1?void 0:i?XP(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&qP(t,e,n),n},vp;const zv=(vp=class extends D{constructor(){super(...arguments);r(this,"head",null);r(this,"eyes",null);r(this,"target",null);r(this,"brain",null);r(this,"vec",new h.Vector3);r(this,"currentTargetPoint",new h.Vector3)}awake(){this.brain||(this.brain=S.getComponentInParent(this.gameObject,kc)),this.brain||(this.brain=S.addComponent(this.gameObject,kc)),this.brain&&this.target&&(this.brain.controlledTarget=this.target)}update(){const t=this.target;if(t&&this.head){const e=this.eyes;if(e){const i=Z(t);this.currentTargetPoint.lerp(i,this.context.time.deltaTime/.1);const n=Z(this.head),o=this.vec.copy(this.currentTargetPoint).sub(n).normalize();if(o.length()<.1)return;const a=zv.forward;if(a.set(0,0,1),a.applyQuaternion(_e(this.head)),a.dot(o)>.45)for(let c=0;c<e.length;c++)e[c].lookAt(this.currentTargetPoint)}}}},r(vp,"forward",new h.Vector3(0,0,1)),vp);let za=zv;_g([p(h.Object3D)],za.prototype,"head",2);_g([p(h.Object3D)],za.prototype,"eyes",2);_g([p(h.Object3D)],za.prototype,"target",2);var QP=Object.defineProperty,YP=Object.getOwnPropertyDescriptor,yg=(s,t,e,i)=>{for(var n=i>1?void 0:i?YP(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&QP(t,e,n),n};class Na extends D{constructor(){super(...arguments);r(this,"length",1);r(this,"depthTest",!0);r(this,"isGizmo",!1);r(this,"_axes",null)}onEnable(){if(this.isGizmo&&!Hc)return;this._axes||(this._axes=new h.AxesHelper(this.length)),this._axes.layers.disableAll(),this._axes.layers.set(this.layer),this.gameObject.add(this._axes);const e=this._axes.material;e&&e.depthTest!==void 0&&(e.depthTest=this.depthTest)}onDisable(){this._axes&&this.gameObject.remove(this._axes)}}yg([p()],Na.prototype,"length",2);yg([p()],Na.prototype,"depthTest",2);yg([p()],Na.prototype,"isGizmo",2);class bg extends D{constructor(){super(...arguments);r(this,"from");r(this,"to");r(this,"hint");r(this,"desiredDistance",1)}onEnable(){}update(){if(!this.from||!this.to||!this.hint)return;const e=Z(this.to).clone(),i=Z(this.from).clone(),n=e.distanceTo(i),o=e.clone();o.sub(i);const a=i.clone();a.add(e),a.multiplyScalar(.5);const l=Z(this.hint).clone();l.sub(a);const c=new h.Vector3;c.crossVectors(l,o),c.crossVectors(o,c),c.normalize();const d=n*.5,u=Math.max(this.desiredDistance,d),f=Math.sqrt(u*u-d*d),m=c.clone();m.multiplyScalar(f),m.add(a),it(this.gameObject,m);const g=a.clone();g.sub(c),this.gameObject.lookAt(g)}}const KP=x("gizmos"),ZP=x("debugboxhelper"),nn=class extends D{constructor(){super(...arguments);r(this,"box",null);r(this,"_lastMatrixUpdateFrame",-1);r(this,"_helper",null);r(this,"_color",null)}isInBox(e){var n;if(!e)return;if(this.box||(this.box=new h.Box3),si([e],void 0,void 0,nn.testBox),nn.testBox.isEmpty()){const o=Z(e,nn._position);nn.testBox.setFromCenterAndSize(o,nn._emptyObjectSize)}this.updateBox();const i=(n=this.box)==null?void 0:n.intersectsBox(nn.testBox);return i&&ZP&&N.DrawWireBox3(nn.testBox,16711680,5),i}intersects(e){return e?this.updateBox(!1).intersectsBox(e):!1}updateBox(e=!1){if(this.box||(this.box=new h.Box3),e||this.context.time.frameCount!=this._lastMatrixUpdateFrame){const i=this._lastMatrixUpdateFrame<0;this._lastMatrixUpdateFrame=this.context.time.frameCount;const n=i,o=Z(this.gameObject,nn._position,n),a=Ue(this.gameObject,nn._size);this.box.setFromCenterAndSize(o,a)}return this.box}awake(){this._helper=null,this._color=null,this.box=null}showHelper(e=null,i=!1){var n;if(!(!KP&&!i)){if(this._helper){e&&((n=this._color)==null||n.set(e)),this.gameObject.add(this._helper);return}this._helper=Xm(e),this.gameObject.add(this._helper)}}};let ti=nn;r(ti,"testBox",new h.Box3),r(ti,"_position",new h.Vector3),r(ti,"_size",new h.Vector3(.01,.01,.01)),r(ti,"_emptyObjectSize",new h.Vector3(.01,.01,.01));var JP=Object.defineProperty,eO=Object.getOwnPropertyDescriptor,oi=(s,t,e,i)=>{for(var n=i>1?void 0:i?eO(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&JP(t,e,n),n};class ri extends D{constructor(){super(...arguments);r(this,"attachedRigidbody",null);r(this,"isTrigger",!1);r(this,"sharedMaterial");r(this,"membership",[0]);r(this,"filter");r(this,"updateProperties",()=>{var e;(e=this.context.physics.engine)==null||e.updateProperties(this)})}get isCollider(){return!0}awake(){super.awake(),this.attachedRigidbody||(this.attachedRigidbody=this.gameObject.getComponentInParent(ue))}start(){this.attachedRigidbody||(this.attachedRigidbody=this.gameObject.getComponentInParent(ue))}onEnable(){this.attachedRigidbody||(this.attachedRigidbody=this.gameObject.getComponentInParent(ue))}onDisable(){var e;(e=this.context.physics.engine)==null||e.removeBody(this)}get body(){var e;return(e=this.context.physics.engine)==null?void 0:e.getBody(this)}updatePhysicsMaterial(){var e;(e=this.context.physics.engine)==null||e.updatePhysicsMaterial(this)}}oi([p(ue)],ri.prototype,"attachedRigidbody",2);oi([p()],ri.prototype,"isTrigger",2);oi([p()],ri.prototype,"sharedMaterial",2);oi([p()],ri.prototype,"membership",2);oi([p()],ri.prototype,"filter",2);class Va extends ri{constructor(){super(...arguments);r(this,"radius",.5);r(this,"center",new h.Vector3(0,0,0))}onEnable(){var e;super.onEnable(),(e=this.context.physics.engine)==null||e.addSphereCollider(this),vu(this.gameObject.scale,this.updateProperties)}onDisable(){super.onDisable(),Mm(this.gameObject.scale,this.updateProperties)}onValidate(){this.updateProperties()}}oi([Ct(),p()],Va.prototype,"radius",2);oi([p(h.Vector3)],Va.prototype,"center",2);const Nv=class extends ri{constructor(){super(...arguments);r(this,"size",new h.Vector3(1,1,1));r(this,"center",new h.Vector3(0,0,0))}static add(t,e){const i=wi(t,Nv);return i.autoFit(),(e==null?void 0:e.rigidbody)===!0&&wi(t,ue,{isKinematic:!1}),i}onEnable(){var t;super.onEnable(),(t=this.context.physics.engine)==null||t.addBoxCollider(this,this.size),vu(this.gameObject.scale,this.updateProperties)}onDisable(){super.onDisable(),Mm(this.gameObject.scale,this.updateProperties)}onValidate(){this.updateProperties()}autoFit(t){const e=this.gameObject,i=e.position.clone(),n=e.quaternion.clone(),o=e.scale.clone(),a=e.parent;e.position.set(0,0,0),e.quaternion.set(0,0,0,1),e.scale.set(1,1,1),e.parent=null,e.updateMatrix();const l=si([e]);e.position.copy(i),e.quaternion.copy(n),e.scale.copy(o),e.parent=a,(t==null?void 0:t.debug)===!0&&N.DrawWireBox3(l,16768256,20),this.size=l.getSize(new h.Vector3)||new h.Vector3(1,1,1),this.center=l.getCenter(new h.Vector3)||new h.Vector3(0,0,0),this.size.length()<=0&&this.size.set(.01,.01,.01)}};let $a=Nv;oi([Ct(),p(h.Vector3)],$a.prototype,"size",2);oi([p(h.Vector3)],$a.prototype,"center",2);class vo extends ri{constructor(){super(...arguments);r(this,"sharedMesh");r(this,"convex",!1)}onEnable(){var i,n,o;if(super.onEnable(),!this.context.physics.engine)return;(i=this.sharedMesh)!=null&&i.isMesh||(this.gameObject instanceof h.Mesh||this.gameObject instanceof h.Group)&&(this.sharedMesh=this.gameObject);const e=0;if((n=this.sharedMesh)!=null&&n.isMesh)this.context.physics.engine.addMeshCollider(this,this.sharedMesh,this.convex),re.NEEDLE_progressive.assignMeshLOD(this.sharedMesh,e).then(a=>{a&&this.activeAndEnabled&&this.context.physics.engine&&this.sharedMesh&&(this.context.physics.engine.removeBody(this),this.sharedMesh.geometry=a,this.context.physics.engine.addMeshCollider(this,this.sharedMesh,this.convex))});else{const a=this.sharedMesh;if(a!=null&&a.isGroup){console.warn(`MeshCollider mesh is a group "${((o=this.sharedMesh)==null?void 0:o.name)||this.gameObject.name}", adding all children as colliders. This is currently not fully supported (colliders can not be removed from world again)`,this);const l=new Array;for(const c in a.children){const d=a.children[c];d.isMesh&&(this.context.physics.engine.addMeshCollider(this,d,this.convex),l.push(re.NEEDLE_progressive.assignMeshLOD(d,e)))}Promise.all(l).then(c=>{var u,f;if(c.some(m=>m)==!1)return;(u=this.context.physics.engine)==null||u.removeBody(this);const d=new h.Mesh;for(const m of c)m&&this.activeAndEnabled&&(d.geometry=m,(f=this.context.physics.engine)==null||f.addMeshCollider(this,d,this.convex))})}else(B()||x("showcolliders"))&&console.warn(`[MeshCollider] A MeshCollider mesh is assigned to an unknown object on "${this.gameObject.name}", but it's neither a Mesh nor a Group. Please double check that you attached the collider component to the right object and report a bug otherwise!`,this)}}}oi([p(h.Mesh)],vo.prototype,"sharedMesh",2);oi([p()],vo.prototype,"convex",2);class ys extends ri{constructor(){super(...arguments);r(this,"center",new h.Vector3(0,0,0));r(this,"radius",.5);r(this,"height",2)}onEnable(){var e;super.onEnable(),(e=this.context.physics.engine)==null||e.addCapsuleCollider(this,this.height,this.radius)}}oi([p(h.Vector3)],ys.prototype,"center",2);oi([p()],ys.prototype,"radius",2);oi([p()],ys.prototype,"height",2);var tO=Object.defineProperty,iO=Object.getOwnPropertyDescriptor,vs=(s,t,e,i)=>{for(var n=i>1?void 0:i?iO(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&tO(t,e,n),n};const By=x("debugcharactercontroller");class xr extends D{constructor(){super(...arguments);r(this,"center",new h.Vector3(0,0,0));r(this,"radius",.5);r(this,"height",2);r(this,"_rigidbody",null);r(this,"_activeGroundCollisions");r(this,"_contactVelocity",new h.Vector3)}get rigidbody(){return this._rigidbody?this._rigidbody:(this._rigidbody=this.gameObject.getComponent(ue),this._rigidbody||(this._rigidbody=this.gameObject.addComponent(ue)),this.rigidbody)}awake(){this._activeGroundCollisions=new Set}onEnable(){const e=this.rigidbody;let i=this.gameObject.getComponent(ys);i||(i=this.gameObject.addComponent(ys)),i.center.copy(this.center),i.radius=this.radius,i.height=this.height;const n=new h.Vector3(0,0,1),o=new h.Vector3(1,0,0),a=new h.Vector3(0,1,0),l=this.gameObject.getWorldDirection(new h.Vector3);l.y=0;const c=o.dot(l)<0?-1:1,d=n.angleTo(l)*c;this.gameObject.setRotationFromAxisAngle(a,d),e.lockRotationX=!0,e.lockRotationY=!0,e.lockRotationZ=!0}move(e){this.gameObject.position.add(e)}onCollisionEnter(e){(e.contacts.length==0||e.contacts.some(i=>i.normal.y>.2))&&(this._activeGroundCollisions.add(e),By&&console.log(`Collision(${this._activeGroundCollisions.size}): ${e.contacts.map(i=>i.normal.y.toFixed(2)).join(", ")} - ${this.isGrounded}`))}onCollisionExit(e){this._activeGroundCollisions.delete(e),By&&console.log(`Collision(${this._activeGroundCollisions.size}) - ${this.isGrounded}`)}get isGrounded(){return this._activeGroundCollisions.size>0}get contactVelocity(){var e;this._contactVelocity.set(0,0,0);for(const i of this._activeGroundCollisions){const n=(e=this.context.physics.engine)==null?void 0:e.getLinearVelocity(i.collider);n&&(this._contactVelocity.x+=n.x,this._contactVelocity.y+=n.y,this._contactVelocity.z+=n.z)}return this._contactVelocity}}vs([p(h.Vector3)],xr.prototype,"center",2);vs([p()],xr.prototype,"radius",2);vs([p()],xr.prototype,"height",2);class ws extends D{constructor(){super(...arguments);r(this,"controller");r(this,"movementSpeed",2);r(this,"rotationSpeed",2);r(this,"jumpForce",1);r(this,"doubleJumpForce",2);r(this,"animator");r(this,"lookForward",!0);r(this,"lookInput",new h.Vector2(0,0));r(this,"moveInput",new h.Vector2(0,0));r(this,"jumpInput",!1);r(this,"_currentSpeed",new h.Vector3(0,0,0));r(this,"_currentAngularSpeed",new h.Vector3(0,0,0));r(this,"_temp",new h.Vector3(0,0,0));r(this,"_jumpCount",0);r(this,"_currentRotation");r(this,"_raycastOptions",new Fn)}awake(){this._currentRotation=new h.Quaternion}update(){const e=this.context.input;e.isKeyPressed("KeyW")?this.moveInput.y+=1:e.isKeyPressed("KeyS")&&(this.moveInput.y-=1),e.isKeyPressed("KeyD")?this.lookInput.x+=1:e.isKeyPressed("KeyA")&&(this.lookInput.x-=1),this.jumpInput||(this.jumpInput=e.isKeyDown("Space"))}move(e){this.moveInput.add(e)}look(e){this.lookInput.add(e)}jump(){this.jumpInput=!0}onBeforeRender(){this.handleInput(this.moveInput,this.lookInput,this.jumpInput),this.lookInput.set(0,0),this.moveInput.set(0,0),this.jumpInput=!1}handleInput(e,i,n){var o,a,l,c,d,u,f,m,g,_,y;if((o=this.controller)!=null&&o.isGrounded&&(this._jumpCount=0,this.doubleJumpForce>0&&((a=this.animator)==null||a.setBool("doubleJump",!1))),this._currentSpeed.z+=e.y*this.movementSpeed*this.context.time.deltaTime,(l=this.animator)==null||l.setBool("running",e.length()>.01),(d=this.animator)==null||d.setBool("jumping",((c=this.controller)==null?void 0:c.isGrounded)===!0&&n),this._temp.copy(this._currentSpeed),this._temp.applyQuaternion(this.gameObject.quaternion),this.controller?this.controller.move(this._temp):this.gameObject.position.add(this._temp),this._currentAngularSpeed.y+=z.toRadians(-i.x*this.rotationSpeed)*this.context.time.deltaTime,this.lookForward&&Math.abs(this._currentAngularSpeed.y)<.01){const b=this.context.mainCameraComponent.forward;b.y=0,b.normalize(),this._currentRotation.setFromUnitVectors(new h.Vector3(0,0,1),b),this.gameObject.quaternion.slerp(this._currentRotation,this.context.time.deltaTime*10)}if(this.gameObject.rotateY(this._currentAngularSpeed.y),this._currentSpeed.multiplyScalar(1-this.context.time.deltaTime*10),this._currentAngularSpeed.y*=1-this.context.time.deltaTime*10,this.controller&&n&&this.jumpForce>0){let b=(u=this.controller)==null?void 0:u.isGrounded;if(this.doubleJumpForce>0&&!((f=this.controller)!=null&&f.isGrounded)&&this._jumpCount===1&&(b=!0,(m=this.animator)==null||m.setBool("doubleJump",!0)),b){this._jumpCount+=1;const v=this.controller.rigidbody,w=this._jumpCount===2?this.doubleJumpForce:this.jumpForce;v.applyImpulse(new h.Vector3(0,1,0).multiplyScalar(w))}}if(this.controller){const b=(g=this.controller)==null?void 0:g.rigidbody.getVelocity().y;if(b<-1){this._raycastOptions.ray||(this._raycastOptions.ray=new h.Ray),this._raycastOptions.ray.origin.copy(Z(this.gameObject)),this._raycastOptions.ray.direction.set(0,-1,0);const v=this.layer;this.gameObject.layers.disableAll(),this.gameObject.layers.set(2);const w=this.context.physics.raycast(this._raycastOptions);this.gameObject.layers.set(v),(w.length&&w[0].distance>2||b<-10)&&((_=this.animator)==null||_.setBool("falling",!0))}else(y=this.animator)==null||y.setBool("falling",!1)}}}vs([p(xr)],ws.prototype,"controller",2);vs([p()],ws.prototype,"movementSpeed",2);vs([p()],ws.prototype,"rotationSpeed",2);vs([p()],ws.prototype,"jumpForce",2);vs([p()],ws.prototype,"doubleJumpForce",2);vs([p(xt)],ws.prototype,"animator",2);var nO=Object.defineProperty,sO=Object.getOwnPropertyDescriptor,Wa=(s,t,e,i)=>{for(var n=i>1?void 0:i?sO(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&nO(t,e,n),n};const xl=x("debugcontactshadows");Pv(s=>{const t=s.domElement.getAttribute("contactshadows")||s.domElement.getAttribute("contact-shadows");if(t!=null&&t!="0"&&t!="false"){console.debug("Auto-creating ContactShadows because of `contactshadows` attribute");const e=gn.auto(s),i=parseFloat(t);isNaN(i)||(e.opacity=i,e.darkness=i)}});var wp;const Vl=(wp=class extends D{constructor(){super(...arguments);r(this,"autoFit",!1);r(this,"darkness",.5);r(this,"opacity",.5);r(this,"blur",4);r(this,"occludeBelowGround",!1);r(this,"backfaceShadows",!0);r(this,"minSize");r(this,"shadowsRoot",new h.Object3D);r(this,"shadowCamera");r(this,"shadowGroup",new h.Group);r(this,"renderTarget");r(this,"renderTargetBlur");r(this,"plane");r(this,"occluderMesh");r(this,"blurPlane");r(this,"depthMaterial");r(this,"horizontalBlurMaterial");r(this,"verticalBlurMaterial");r(this,"textureSize",512)}static auto(t){if(t||(t=Q.Current),!t)throw new Error("No context provided and no current context set.");let e=this._instances.get(t);if(!e||e.destroyed){const i=new h.Object3D;e=wi(i,Vl,{autoFit:!1,occludeBelowGround:!1}),this._instances.set(t,e)}return t.scene.add(e.gameObject),e.fitShadows(),e}fitShadows(){xl&&console.warn("Fitting shadows to scene"),Ad(this.shadowsRoot,!1);const t=si(this.context.scene.children,[this.shadowsRoot]),e=Math.max(1,this.blur/32),i=t.max.x-t.min.x,n=t.max.z-t.min.z;t.expandByVector(new h.Vector3(e*i,0,e*n)),xl&&N.DrawWireBox3(t,16776960,60),this.gameObject.parent&&t.applyMatrix4(this.gameObject.parent.matrixWorld.clone().invert());const o=t.min,a=Math.max(1e-5,(t.max.y-o.y)*.002);t.max.y+=a,this.shadowsRoot.position.set((o.x+t.max.x)/2,o.y-a,(o.z+t.max.z)/2),this.shadowsRoot.scale.set(t.max.x-o.x,t.max.y-o.y,t.max.z-o.z),this.applyMinSize(),this.shadowsRoot.matrixWorldNeedsUpdate=!0,xl&&console.log("Fitted shadows to scene",this.shadowsRoot.scale.clone())}awake(){Vl._instances.set(this.context,this),this.shadowsRoot.hideFlags=ju.DontExport,Ad(this.shadowsRoot,!1)}start(){xl&&console.log("Create ContactShadows on "+this.gameObject.name,this),this.gameObject.add(this.shadowsRoot),this.shadowsRoot.add(this.shadowGroup),this.renderTarget=new h.WebGLRenderTarget(this.textureSize,this.textureSize),this.renderTarget.texture.generateMipmaps=!1,this.renderTargetBlur=new h.WebGLRenderTarget(this.textureSize,this.textureSize),this.renderTargetBlur.texture.generateMipmaps=!1;const t=new h.PlaneGeometry(1,1).rotateX(Math.PI/2);this.gameObject instanceof h.Mesh&&(console.warn("ContactShadows can not be added to a Mesh. Please add it to a Group or an empty Object"),cs(this.gameObject,!1));const e=new h.MeshBasicMaterial({map:this.renderTarget.texture,opacity:this.opacity,color:0,transparent:!0,depthWrite:!1,side:h.FrontSide});this.plane=new h.Mesh(t,e),this.plane.scale.y=-1,this.plane.layers.set(2),this.shadowsRoot.add(this.plane),this.plane&&(this.plane.renderOrder=1),this.occluderMesh=new h.Mesh(this.plane.geometry,new h.MeshBasicMaterial({depthWrite:!0,stencilWrite:!0,colorWrite:!1,side:h.BackSide})).translateY(-1e-4),this.occluderMesh.renderOrder=-100,this.occluderMesh.layers.set(2),this.shadowsRoot.add(this.occluderMesh),this.blurPlane=new h.Mesh(t),this.blurPlane.visible=!1,this.shadowGroup.add(this.blurPlane);const i=0,n=1;this.shadowCamera=new h.OrthographicCamera(-1/2,1/2,1/2,-1/2,i,n),this.shadowCamera.layers.enableAll(),this.shadowCamera.rotation.x=Math.PI/2,this.shadowGroup.add(this.shadowCamera),this.depthMaterial=new h.MeshDepthMaterial,this.depthMaterial.userData.darkness={value:this.darkness},this.depthMaterial.blending=h.CustomBlending,this.depthMaterial.blendEquation=h.MaxEquation,this.depthMaterial.onBeforeCompile=o=>{this.depthMaterial&&(o.uniforms.darkness=this.depthMaterial.userData.darkness,o.fragmentShader=`
                uniform float darkness;
                ${o.fragmentShader.replace("gl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );","gl_FragColor = vec4( vec3( 1.0 ), ( 1.0 - fragCoordZ ) * darkness * opacity * (gl_FrontFacing ? 1.0 : 0.66) );")}
            `)},this.depthMaterial.depthTest=!1,this.depthMaterial.depthWrite=!1,this.horizontalBlurMaterial=new h.ShaderMaterial(Y.HorizontalBlurShader),this.horizontalBlurMaterial.depthTest=!1,this.verticalBlurMaterial=new h.ShaderMaterial(Y.VerticalBlurShader),this.verticalBlurMaterial.depthTest=!1,this.shadowGroup.visible=!1,this.autoFit?this.fitShadows():this.applyMinSize()}onDestroy(){var e,i,n,o,a,l,c,d;Vl._instances.get(this.context)===this&&Vl._instances.delete(this.context),(e=this.renderTarget)==null||e.dispose(),(i=this.renderTargetBlur)==null||i.dispose(),(n=this.depthMaterial)==null||n.dispose(),(o=this.horizontalBlurMaterial)==null||o.dispose(),(a=this.verticalBlurMaterial)==null||a.dispose(),(l=this.blurPlane)==null||l.geometry.dispose(),(c=this.plane)==null||c.geometry.dispose(),(d=this.occluderMesh)==null||d.geometry.dispose()}onBeforeRender(t){if(!this.renderTarget||!this.renderTargetBlur||!this.depthMaterial||!this.shadowCamera||!this.blurPlane||!this.shadowGroup||!this.plane||!this.horizontalBlurMaterial||!this.verticalBlurMaterial){xl&&console.error("ContactShadows: not initialized yet");return}const e=this.context.scene,i=this.context.renderer,n=i.getRenderTarget();this.shadowGroup.visible=!0,this.occluderMesh&&(this.occluderMesh.visible=!1);const o=this.plane.visible;this.plane.visible=!1,this.gameObject instanceof h.Mesh&&cs(this.gameObject,!1);const a=e.background;e.background=null,e.overrideMaterial=this.depthMaterial,this.backfaceShadows?this.depthMaterial.side=h.DoubleSide:this.depthMaterial.side=h.FrontSide;const l=i.getClearAlpha();i.setClearAlpha(0);const c=i.xr.enabled;i.xr.enabled=!1;const d=this.context.scene.matrixWorldAutoUpdate;this.context.scene.matrixWorldAutoUpdate=!1;const u=i.renderLists.get(e,0),f=u.transparent;Fy.length=0,u.transparent=Fy,Bf.length=0;for(const g of u.opaque){if(!g.object.visible)continue;const _=g.material;let y=g.material.colorWrite==!1||_.wireframe===!0||Kb(g.object)===!1;!y&&g.material.isLineMaterial&&(y=!0),!y&&g.material.isPointsMaterial&&(y=!0),y&&(Bf.push(g.object),g.object["needle:visible"]=g.object.visible,g.object.visible=!1)}i.setRenderTarget(this.renderTarget),i.clear(),i.render(e,this.shadowCamera),u.transparent=f;for(const g of Bf)g["needle:visible"]!=null&&(g.visible=g["needle:visible"]);e.overrideMaterial=null;const m=Math.max(this.blur,.05);this.blurShadow(m*2),this.blurShadow(m*.5),this.shadowGroup.visible=!1,this.occluderMesh&&(this.occluderMesh.visible=this.occludeBelowGround),this.plane.visible=o,i.setRenderTarget(n),i.setClearAlpha(l),e.background=a,i.xr.enabled=c,this.context.scene.matrixWorldAutoUpdate=d}blurShadow(t){if(!this.blurPlane||!this.shadowCamera||!this.renderTarget||!this.renderTargetBlur||!this.horizontalBlurMaterial||!this.verticalBlurMaterial)return;this.blurPlane.visible=!0;const e=this.shadowsRoot.worldScale,i=(e.x+e.z)/2,n=e.z/i,o=e.x/i;this.blurPlane.material=this.horizontalBlurMaterial,this.blurPlane.material.uniforms.tDiffuse.value=this.renderTarget.texture,this.horizontalBlurMaterial.uniforms.h.value=t*1/this.textureSize*n;const a=this.context.renderer,l=a.getRenderTarget();a.setRenderTarget(this.renderTargetBlur),a.render(this.blurPlane,this.shadowCamera),this.blurPlane.material=this.verticalBlurMaterial,this.blurPlane.material.uniforms.tDiffuse.value=this.renderTargetBlur.texture,this.verticalBlurMaterial.uniforms.v.value=t*1/this.textureSize*o,a.setRenderTarget(this.renderTarget),a.render(this.blurPlane,this.shadowCamera),this.blurPlane.visible=!1,a.setRenderTarget(l)}applyMinSize(){this.minSize&&this.shadowsRoot.scale.set(Math.max(this.minSize.x||0,this.shadowsRoot.scale.x),Math.max(this.minSize.y||0,this.shadowsRoot.scale.y),Math.max(this.minSize.z||0,this.shadowsRoot.scale.z))}},r(wp,"_instances",new Map),wp);let gn=Vl;Wa([p()],gn.prototype,"autoFit",2);Wa([p()],gn.prototype,"darkness",2);Wa([p()],gn.prototype,"opacity",2);Wa([p()],gn.prototype,"blur",2);Wa([p()],gn.prototype,"occludeBelowGround",2);Wa([p()],gn.prototype,"backfaceShadows",2);const Fy=[],Bf=new Array,oO=x("logstats");class vg extends D{onEnable(){console.log(this),oO&&this.startCoroutine(this.run(),ve.OnAfterRender)}*run(){for(;this.enabled;){const t=this.context.renderer.info;console.log(t.memory,t.render,t.programs),yield}}}class sh extends D{constructor(){super(...arguments);r(this,"isUsed",!0);r(this,"usedBy",null)}}class wg extends D{}const Uy=x("debugdeletable"),_c=class extends ti{onEnable(){_c._instances.push(this)}onDisable(){const t=_c._instances.indexOf(this);t>=0&&_c._instances.splice(t,1)}};let nr=_c;r(nr,"_instances",[]);class xg extends D{update(){for(const t of nr._instances){const e=this.gameObject;if(t.isInBox(e)===!0){const n=S.getComponentInParent(this.gameObject,sh);if(n)Uy&&console.warn("DeleteBox: Not deleting object with usage marker",this.guid,n);else{if(Uy)try{if(t.box){const o=t.box,a=ti.testBox;N.DrawWireBox3(o,16711680,5),N.DrawWireBox3(a,255,5),console.log("DeleteBox: Destroying",this.gameObject,{deleteBoxArea:o,deletedObjectArea:a})}else console.log("DeleteBox: Destroying",this.gameObject)}catch{}Gc(this.gameObject,this.context.connection)}}}}}var rO=Object.defineProperty,aO=Object.getOwnPropertyDescriptor,lO=(s,t,e,i)=>{for(var n=i>1?void 0:i?aO(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&rO(t,e,n),n};class Fu extends D{constructor(){super(...arguments);r(this,"visibleOn")}onEnable(){this.apply()}apply(){this.test()||S.setActive(this.gameObject,!1)}test(){return this.visibleOn<0?!0:exports.DeviceUtilities.isMobileDevice()?(this.visibleOn&2)!==0:(this.visibleOn&1)!==0}}lO([p()],Fu.prototype,"visibleOn",2);var cO=Object.defineProperty,hO=Object.getOwnPropertyDescriptor,Sr=(s,t,e,i)=>{for(var n=i>1?void 0:i?hO(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&cO(t,e,n),n};const In=x("debugdrag"),Ff=[];var Sg=(s=>(s[s.XZPlane=0]="XZPlane",s[s.Attached=1]="Attached",s[s.HitNormal=2]="HitNormal",s[s.DynamicViewAngle=3]="DynamicViewAngle",s[s.SnapToSurfaces=4]="SnapToSurfaces",s[s.None=5]="None",s))(Sg||{}),Al;const Di=(Al=class extends D{constructor(){super(...arguments);r(this,"dragMode",3);r(this,"snapGridResolution",0);r(this,"keepRotation",!0);r(this,"xrDragMode",1);r(this,"xrKeepRotation",!1);r(this,"xrDistanceDragFactor",1);r(this,"showGizmo",!1);r(this,"_rigidbody",null);r(this,"_targetObject",null);r(this,"_dragHelper",null);r(this,"_draggingRigidbodies",[]);r(this,"_potentialDragStartEvt",null);r(this,"_dragHandlers",new Map);r(this,"_totalMovement",new h.Vector3);r(this,"_marker",null);r(this,"_isDragging",!1);r(this,"_didDrag",!1)}static get HasAnySelected(){return this._active>0}static get CurrentlySelected(){Ff.length=0;for(const t of this._instances)t._isDragging&&Ff.push(t);return Ff}get draggedObject(){return this._targetObject}setTargetObject(t){var i,n;this._targetObject=t;for(const o of this._dragHandlers.values())o.setTargetObject(t);const e="_rigidbody-was-kinematic";((i=this._rigidbody)==null?void 0:i[e])===!1&&(this._rigidbody.isKinematic=!1,this._rigidbody[e]=void 0),this._rigidbody=null,t&&(this._rigidbody=S.getComponentInChildren(t,ue),((n=this._rigidbody)==null?void 0:n.isKinematic)===!1&&(this._rigidbody.isKinematic=!0,this._rigidbody[e]=!1))}awake(){this._potentialDragStartEvt=null,this._dragHandlers=new Map,this._totalMovement=new h.Vector3,this._marker=null,this._isDragging=!1,this._didDrag=!1,this._dragHelper=null,this._draggingRigidbodies=[]}start(){this.gameObject.getComponentInParent(Ci)||this.gameObject.addComponent(Ci)}onEnable(){Di._instances.push(this)}onDisable(){Di._instances=Di._instances.filter(t=>t!==this)}allowEdit(t=null){return this.context.connection.allowEditing}onPointerEnter(t){if(!this.allowEdit(this.gameObject)||t.mode!=="screen"||(t.event.mode==="tracked-pointer"||t.event.mode==="transient-pointer"?this.xrDragMode:this.dragMode)===5)return;const n=S.getComponentInParent(t.object,Di);!n||n!==this||(Di.lastHovered=t.object,this.context.domElement.style.cursor="pointer")}onPointerMove(t){(this._isDragging||this._potentialDragStartEvt!==null)&&t.use()}onPointerExit(t){this.allowEdit(this.gameObject)&&t.mode==="screen"&&Di.lastHovered===t.object&&(this.context.domElement.style.cursor="auto")}onPointerDown(t){if(!(!this.allowEdit(this.gameObject)||t.used||(t.mode==="tracked-pointer"||t.mode==="transient-pointer"?this.xrDragMode:this.dragMode)===5)&&(Di.lastHovered=t.object,t.button===0)){this._dragHandlers.size===0&&(this._didDrag=!1,this._totalMovement.set(0,0,0),this._potentialDragStartEvt=t),this._targetObject||this.setTargetObject(this.gameObject),Di._active+=1;const n=new Uf(this,this._targetObject);if(this._dragHandlers.set(t.event.space,n),n.onDragStart(t),this._dragHandlers.size===2){const o=this._dragHandlers.values(),a=o.next().value,l=o.next().value;if(a instanceof Uf&&l instanceof Uf){const c=new dO(this,this._targetObject,a,l);this._dragHandlers.set(this.gameObject,c),c.onDragStart(t)}else console.error("Attempting to construct a MultiTouchDragHandler with invalid DragPointerHandlers. This is likely a bug.",{a,b:l})}t.use()}}onPointerUp(t){if(In&&N.DrawLabel(t.point??this.gameObject.worldPosition,"POINTERUP:"+t.pointerId+", "+t.button,.03,3),!this.allowEdit(this.gameObject)||t.button!==0)return;this._potentialDragStartEvt=null;const e=this._dragHandlers.get(t.event.space),i=this._dragHandlers.get(this.gameObject);i&&(i.handlerA===e||i.handlerB===e)&&(this._dragHandlers.delete(this.gameObject),i.onDragEnd(t)),e&&(Di._active>0&&(Di._active-=1),this.setTargetObject(null),e.onDragEnd&&e.onDragEnd(t),this._dragHandlers.delete(t.event.space),this._dragHandlers.size===0&&this.onLastDragEnd(t),t.use())}update(){for(const t of this._dragHandlers.values())t.collectMovementInfo&&t.collectMovementInfo(),t.getTotalMovement&&this._totalMovement.add(t.getTotalMovement());if(this._potentialDragStartEvt){if(!this._didDrag)if(this._totalMovement.length()>3e-4)this._didDrag=!0;else return;const t=this._potentialDragStartEvt;this._potentialDragStartEvt=null,this.onFirstDragStart(t)}for(const t of this._dragHandlers.values())t.onDragUpdate&&t.onDragUpdate(this._dragHandlers.size);this._dragHelper&&this._dragHelper.hasSelected&&this.onAnyDragUpdate()}onFirstDragStart(t){if(!t||!t.object)return;const e=S.getComponentInParent(t.object,Di);if(!e||e!==this&&e._isDragging)return;const i=this._targetObject||this.gameObject;if(!i)return;this._isDragging=!0;const n=S.getComponentInChildren(i,Un);In&&console.log("DRAG START",n,i),n&&(n.fastMode=!0,n==null||n.requestOwnership()),this._marker=S.addComponent(i,sh),this._draggingRigidbodies.length=0;const o=S.getComponentsInChildren(i,ue);o&&this._draggingRigidbodies.push(...o)}onAnyDragUpdate(){if(!this._dragHelper)return;this._dragHelper.showGizmo=this.showGizmo,this._dragHelper.onUpdate(this.context);for(const e of this._draggingRigidbodies)e.wakeUp(),e.resetVelocities(),e.resetForcesAndTorques();const t=this._targetObject||this.gameObject;Vi.markDirty(t)}onLastDragEnd(t){if(!this||!this._isDragging)return;this._isDragging=!1;for(const i of this._draggingRigidbodies)i.setVelocity(i.smoothedVelocity);if(this._draggingRigidbodies.length=0,this._targetObject=null,t!=null&&t.object){const i=S.getComponentInChildren(t.object,Un);i&&(i.fastMode=!1)}if(this._marker&&this._marker.destroy(),!this._dragHelper)return;const e=this._dragHelper.selected;In&&console.log("DRAG END",e,e==null?void 0:e.visible),this._dragHelper.setSelected(null,this.context)}},r(Al,"_active",0),r(Al,"_instances",[]),r(Al,"lastHovered"),Al);let ii=Di;Sr([p()],ii.prototype,"dragMode",2);Sr([p()],ii.prototype,"snapGridResolution",2);Sr([p()],ii.prototype,"keepRotation",2);Sr([p()],ii.prototype,"xrDragMode",2);Sr([p()],ii.prototype,"xrKeepRotation",2);Sr([p()],ii.prototype,"xrDistanceDragFactor",2);Sr([p()],ii.prototype,"showGizmo",2);class dO{constructor(t,e,i,n){r(this,"handlerA");r(this,"handlerB");r(this,"context");r(this,"settings");r(this,"gameObject");r(this,"_handlerAAttachmentPoint",new h.Vector3);r(this,"_handlerBAttachmentPoint",new h.Vector3);r(this,"_followObject");r(this,"_manipulatorObject");r(this,"_deviceMode");r(this,"_followObjectStartWorldQuaternion",new h.Quaternion);r(this,"_manipulatorPosOffset",new h.Vector3);r(this,"_manipulatorRotOffset",new h.Quaternion);r(this,"_manipulatorScaleOffset",new h.Vector3);r(this,"_tempVec1",new h.Vector3);r(this,"_tempVec2",new h.Vector3);r(this,"_tempVec3",new h.Vector3);r(this,"tempLookMatrix",new h.Matrix4);r(this,"_initialScale",new h.Vector3);r(this,"_initialDistance",0);var a,l;this.context=t.context,this.settings=t,this.gameObject=e,this.handlerA=i,this.handlerB=n,this._followObject=new h.Object3D,this._manipulatorObject=new h.Object3D,this.context.scene.add(this._manipulatorObject);const o=(l=(a=q.active)==null?void 0:a.rig)==null?void 0:l.gameObject;if(!this.handlerA||!this.handlerB||!this.handlerA.hitPointInLocalSpace||!this.handlerB.hitPointInLocalSpace){console.error("Invalid: MultiTouchDragHandler needs two valid DragPointerHandlers with hitPointInLocalSpace set.");return}if(this._tempVec1.copy(this.handlerA.hitPointInLocalSpace),this._tempVec2.copy(this.handlerB.hitPointInLocalSpace),this.gameObject.localToWorld(this._tempVec1),this.gameObject.localToWorld(this._tempVec2),o&&(o.worldToLocal(this._tempVec1),o.worldToLocal(this._tempVec2)),this._initialDistance=this._tempVec1.distanceTo(this._tempVec2),this._initialDistance<.02?(In&&console.log("Finding alternative drag attachment points since initial distance is too low: "+this._initialDistance.toFixed(2)),this.handlerA.followObject.parent.getWorldPosition(this._tempVec1),this.handlerB.followObject.parent.getWorldPosition(this._tempVec2),this._handlerAAttachmentPoint.copy(this._tempVec1),this._handlerBAttachmentPoint.copy(this._tempVec2),this.gameObject.worldToLocal(this._handlerAAttachmentPoint),this.gameObject.worldToLocal(this._handlerBAttachmentPoint),this._initialDistance=this._tempVec1.distanceTo(this._tempVec2),this._initialDistance<.001&&(console.warn("Not supported right now – controller drag points for multitouch are too close!"),this._initialDistance=1)):(this._handlerAAttachmentPoint.copy(this.handlerA.hitPointInLocalSpace),this._handlerBAttachmentPoint.copy(this.handlerB.hitPointInLocalSpace)),this._tempVec3.lerpVectors(this._tempVec1,this._tempVec2,.5),this._initialScale.copy(e.scale),In){this._followObject.add(new h.AxesHelper(2)),this._manipulatorObject.add(new h.AxesHelper(5));const c=d=>`${d.x.toFixed(2)}, ${d.y.toFixed(2)}, ${d.z.toFixed(2)}`;N.DrawLine(this._tempVec1,this._tempVec2,65535,0,!1),N.DrawLabel(this._tempVec3,"A:B "+this._initialDistance.toFixed(2)+`
`+c(this._tempVec1)+`
`+c(this._tempVec2),.03,5)}}onDragStart(t){this.gameObject.add(this._followObject),this._followObject.matrixAutoUpdate=!1,this._followObject.matrix.identity(),this._deviceMode=t.mode,this._followObjectStartWorldQuaternion.copy(this._followObject.worldQuaternion),this.alignManipulator(),this._manipulatorObject.attach(this._followObject),this._manipulatorPosOffset.copy(this._followObject.position),this._manipulatorRotOffset.copy(this._followObject.quaternion),this._manipulatorScaleOffset.copy(this._followObject.scale)}onDragEnd(t){if(!this.handlerA||!this.handlerB){console.error("onDragEnd called on MultiTouchDragHandler without valid handlers. This is likely a bug.");return}this.handlerA.recenter(),this.handlerB.recenter(),this._manipulatorObject.removeFromParent(),this._followObject.removeFromParent(),this._manipulatorObject.destroy(),this._followObject.destroy()}alignManipulator(){if(!this.handlerA||!this.handlerB){console.error("alignManipulator called on MultiTouchDragHandler without valid handlers. This is likely a bug.",this);return}if(!this.handlerA.followObject||!this.handlerB.followObject){console.error("alignManipulator called on MultiTouchDragHandler without valid follow objects. This is likely a bug.",this.handlerA,this.handlerB);return}this._tempVec1.copy(this._handlerAAttachmentPoint),this._tempVec2.copy(this._handlerBAttachmentPoint),this.handlerA.followObject.localToWorld(this._tempVec1),this.handlerB.followObject.localToWorld(this._tempVec2),this._tempVec3.lerpVectors(this._tempVec1,this._tempVec2,.5),this._manipulatorObject.position.copy(this._tempVec3);const t=this.context.mainCamera;this.tempLookMatrix.lookAt(this._tempVec3,this._tempVec2,t.worldUp),this._manipulatorObject.quaternion.setFromRotationMatrix(this.tempLookMatrix);const e=this._tempVec1.distanceTo(this._tempVec2);this._manipulatorObject.scale.copy(this._initialScale).multiplyScalar(e/this._initialDistance),this._manipulatorObject.updateMatrix(),this._manipulatorObject.updateMatrixWorld(!0),In&&(N.DrawLabel(this._tempVec3.clone().add(new h.Vector3(0,.2,0)),"A:B "+e.toFixed(2),.03),N.DrawLine(this._tempVec1,this._tempVec2,65280,0,!1))}onDragUpdate(){this.alignManipulator();const t=30,e=1;this._followObject.position.copy(this._manipulatorPosOffset),this._followObject.quaternion.copy(this._manipulatorRotOffset),this._followObject.scale.copy(this._manipulatorScaleOffset);const i=this.gameObject,n=this._followObject;if(!i){console.error("MultiTouchDragHandler has no dragged object. This is likely a bug.");return}n.updateMatrix(),n.updateMatrixWorld(!0);const a=this._deviceMode==="tracked-pointer"||this._deviceMode==="transient-pointer"?this.settings.xrKeepRotation:this.settings.keepRotation;if(this.settings.snapGridResolution>0){const f=this._followObject.worldPosition,m=this.settings.snapGridResolution;f.x=Math.round(f.x/m)*m,f.y=Math.round(f.y/m)*m,f.z=Math.round(f.z/m)*m,this._followObject.worldPosition=f,this._followObject.updateMatrix()}a&&(this._followObject.worldQuaternion=this._followObjectStartWorldQuaternion,this._followObject.updateMatrix());const l=z.clamp01(this.context.time.deltaTime*t*e),c=i.worldPosition;c.lerp(n.worldPosition,l),i.worldPosition=c;const d=i.worldQuaternion;d.slerp(n.worldQuaternion,l),i.worldQuaternion=d;const u=i.worldScale;u.lerp(n.worldScale,l),i.worldScale=u}setTargetObject(t){this.gameObject=t}}class Uf{constructor(t,e){r(this,"context");r(this,"gameObject");r(this,"settings");r(this,"_lastRig");r(this,"_followObject");r(this,"_totalMovement",new h.Vector3);r(this,"_totalMovementAlongRayDirection",0);r(this,"_grabStartDistance",0);r(this,"_deviceMode");r(this,"_followObjectStartPosition",new h.Vector3);r(this,"_followObjectStartQuaternion",new h.Quaternion);r(this,"_followObjectStartWorldQuaternion",new h.Quaternion);r(this,"_lastDragPosRigSpace");r(this,"_tempVec",new h.Vector3);r(this,"_tempMat",new h.Matrix4);r(this,"_hitPointInLocalSpace",new h.Vector3);r(this,"_hitNormalInLocalSpace",new h.Vector3);r(this,"_bottomCenter",new h.Vector3);r(this,"_backCenter",new h.Vector3);r(this,"_backBottomCenter",new h.Vector3);r(this,"_bounds",new h.Box3);r(this,"_dragPlane",new h.Plane(new h.Vector3(0,1,0)));r(this,"_draggedOverObject",null);r(this,"_draggedOverObjectLastSetUp",null);r(this,"_draggedOverObjectLastNormal",new h.Vector3);r(this,"_draggedOverObjectDuration",0);r(this,"_hasLastSurfaceHitPoint",!1);r(this,"_lastSurfaceHitPoint",new h.Vector3);this.settings=t,this.context=t.context,this.gameObject=e,this._followObject=new h.Object3D}getTotalMovement(){return this._totalMovement}get followObject(){return this._followObject}get hitPointInLocalSpace(){return this._hitPointInLocalSpace}setTargetObject(t){this.gameObject=t}recenter(){var o,a;if(!this._followObject.parent){console.warn("Error: space follow object doesn't have parent but recenter() is called. This is likely a bug");return}if(!this.gameObject){console.warn("Error: space follow object doesn't have a gameObject");return}const t=this._followObject.parent;this.gameObject.add(this._followObject),this._followObject.matrixAutoUpdate=!1,this._followObject.position.set(0,0,0),this._followObject.quaternion.set(0,0,0,1),this._followObject.scale.set(1,1,1),this._followObject.updateMatrix(),this._followObject.updateMatrixWorld(!0),t.attach(this._followObject),this._followObjectStartPosition.copy(this._followObject.position),this._followObjectStartQuaternion.copy(this._followObject.quaternion),this._followObjectStartWorldQuaternion.copy(this._followObject.worldQuaternion),this._followObject.updateMatrix(),this._followObject.updateMatrixWorld(!0);const e=this._hitPointInLocalSpace.clone();this.gameObject.localToWorld(e),this._grabStartDistance=e.distanceTo(t.worldPosition);const i=(a=(o=q.active)==null?void 0:o.rig)==null?void 0:a.gameObject,n=(i==null?void 0:i.worldScale.x)||1;this._grabStartDistance/=n,this._totalMovementAlongRayDirection=0,this._lastDragPosRigSpace=void 0,In&&(N.DrawLine(e,t.worldPosition,65280,.5,!1),N.DrawLabel(t.worldPosition.add(new h.Vector3(0,.1,0)),this._grabStartDistance.toFixed(2),.03,.5))}onDragStart(t){if(!this.gameObject){console.warn("Error: space follow object doesn't have a gameObject");return}if(t.event.space.add(this._followObject),this._lastDragPosRigSpace=void 0,t.point&&t.normal)this._hitPointInLocalSpace.copy(t.point),this.gameObject.worldToLocal(this._hitPointInLocalSpace),this._hitNormalInLocalSpace.copy(t.normal);else if(t){const y=t.event.space,b=y.worldPosition;this.gameObject.worldToLocal(b),this._hitPointInLocalSpace.copy(b);const v=y.worldUp;this._tempMat.copy(this.gameObject.matrixWorld).invert(),v.transformDirection(this._tempMat),this._hitNormalInLocalSpace.copy(v)}this.recenter(),this._totalMovement.set(0,0,0),this._deviceMode=t.mode;const i=this._followObject.parent.worldForward,o=this._deviceMode==="tracked-pointer"||this._deviceMode==="transient-pointer"?this.settings.xrDragMode:this.settings.dragMode,a=this._hitPointInLocalSpace.clone();switch(this.gameObject.localToWorld(a),o){case 0:const y=new h.Vector3(0,1,0);this.gameObject.parent&&y.transformDirection(this.gameObject.parent.matrixWorld.clone().invert()),this._dragPlane.setFromNormalAndCoplanarPoint(y,a);break;case 2:const b=this._hitNormalInLocalSpace.clone();b.transformDirection(this.gameObject.matrixWorld),this._dragPlane.setFromNormalAndCoplanarPoint(b,a);break;case 1:this._dragPlane.setFromNormalAndCoplanarPoint(i,a);break;case 3:this.setPlaneViewAligned(a,!0);break;case 4:this.setPlaneViewAligned(a,!1);break}const l=this.gameObject.parent,c=this.gameObject.position.clone(),d=this.gameObject.quaternion.clone(),u=this.gameObject.scale.clone(),f=this.gameObject.matrixWorld.clone();l&&l.remove(this.gameObject),this.gameObject.position.set(0,0,0),this.gameObject.quaternion.set(0,0,0,1),this.gameObject.scale.set(1,1,1);const m=si([this.gameObject]);m.expandByPoint(this.gameObject.worldPosition);const g=new h.Vector3;m.getCenter(g);const _=new h.Vector3;m.getSize(_),this._bottomCenter.copy(g.clone().add(new h.Vector3(0,-_.y/2,0))),this._backCenter.copy(g.clone().add(new h.Vector3(0,0,_.z/2))),this._backBottomCenter.copy(g.clone().add(new h.Vector3(0,-_.y/2,_.z/2))),this._bounds.copy(m),l&&l.add(this.gameObject),this.gameObject.position.copy(c),this.gameObject.quaternion.copy(d),this.gameObject.scale.copy(u),this.gameObject.matrixWorld.copy(f),this._draggedOverObject=null,this._draggedOverObjectLastSetUp=null,this._draggedOverObjectLastNormal.set(0,1,0),this._draggedOverObjectDuration=0}collectMovementInfo(){var o,a;if(!this._followObject.parent)return;const t=this._followObject.parent;this._followObject.updateMatrix();const e=t.worldPosition,i=(a=(o=q.active)==null?void 0:o.rig)==null?void 0:a.gameObject;i&&i.worldToLocal(e),(this._lastDragPosRigSpace===void 0||i!=this._lastRig)&&(this._lastDragPosRigSpace=e.clone(),this._lastRig=i),this._tempVec.copy(e).sub(this._lastDragPosRigSpace);const n=t.worldForward;if(i&&(this._tempMat.copy(i.matrixWorld).invert(),n.transformDirection(this._tempMat)),this._totalMovementAlongRayDirection+=n.dot(this._tempVec),this._tempVec.x=Math.abs(this._tempVec.x),this._tempVec.y=Math.abs(this._tempVec.y),this._tempVec.z=Math.abs(this._tempVec.z),this._totalMovement.add(this._tempVec),this._lastDragPosRigSpace.copy(e),In){let l=e;i&&(l=l.clone(),l.transformDirection(i.matrixWorld)),N.DrawRay(l,n,255)}}onDragUpdate(t){if(t>1)return;const e=this.gameObject;if(!e||!this._followObject){console.warn("Warning: DragPointerHandler doesn't have a dragged object. This is likely a bug.");return}const i=this._followObject.parent;if(!i){console.warn("Warning: DragPointerHandler doesn't have a drag source. This is likely a bug.");return}this._followObject.updateMatrix();const n=i.worldPosition,o=i.worldForward,a=this._deviceMode==="tracked-pointer"||this._deviceMode==="transient-pointer",l=a?this.settings.xrKeepRotation:this.settings.keepRotation,c=a?this.settings.xrDragMode:this.settings.dragMode;if(c===5)return;const d=10;l&&(this._followObject.worldQuaternion=this._followObjectStartWorldQuaternion),this._followObject.updateMatrix(),this._followObject.updateMatrixWorld(!0);let u=1,f=2;if(a&&this._grabStartDistance>.5){const w=1+this._totalMovementAlongRayDirection*(2*this.settings.xrDistanceDragFactor);u=Math.max(0,w),u=u*u*u}else this._grabStartDistance<=.5&&(f=3);this._followObject.position.copy(this._followObjectStartPosition),l||this._followObject.quaternion.copy(this._followObjectStartQuaternion),this._followObject.position.multiplyScalar(u),this._followObject.updateMatrix();const m=this._hasLastSurfaceHitPoint;this._hasLastSurfaceHitPoint=!1;const g=new h.Ray(n,o);if(c==4){const w=this.context.physics.raycastFromRay(g,{testObject:P=>P!==this.followObject&&P!==i&&P!==e});if(w.length>0){const P=w[0];if(this._draggedOverObject===P.object?this._draggedOverObjectDuration+=this.context.time.deltaTime:(this._draggedOverObject=P.object,this._draggedOverObjectDuration=0),P.face){this._hasLastSurfaceHitPoint=!0,this._lastSurfaceHitPoint.copy(P.point);const k=.15,O=this._draggedOverObjectDuration>=k,M=.001,A=this._totalMovement.length()>=M,I=$(P.normal||P.face.normal).applyQuaternion(P.object.worldQuaternion);if((O||A)&&(this._draggedOverObjectLastSetUp!==this._draggedOverObject||this._draggedOverObjectLastNormal.dot(I)<.999999||this.context.time.frame%60===0)){this._draggedOverObjectLastSetUp=this._draggedOverObject,this._draggedOverObjectLastNormal.copy(P.face.normal);const T=$(),j=$();this._bounds.getCenter(T),this._bounds.getSize(j),T.sub(j.multiplyScalar(.5).multiply(I)),this._hitPointInLocalSpace.copy(T),this._hitNormalInLocalSpace.copy(P.face.normal),this._bounds.getCenter(T),this._bounds.getSize(j),T.add(j.multiplyScalar(.5).multiply(P.face.normal));const F=$(this._hitPointInLocalSpace).add(T);this._followObject.localToWorld(F);const X=P.point;this._dragPlane.setFromNormalAndCoplanarPoint(I,X)}else if(!(O||A))return}}else m&&this.gameObject&&this.setPlaneViewAligned(this.gameObject.worldPosition,!1)}if(c!==1&&g.intersectPlane(this._dragPlane,this._tempVec)){this._followObject.worldPosition=this._tempVec,this._followObject.updateMatrix(),this._followObject.updateMatrixWorld(!0);const w=$(this._hitPointInLocalSpace);this._followObject.localToWorld(w),In&&N.DrawLine(w,this._tempVec,65535,0,!1),this._followObject.worldPosition=this._tempVec.multiplyScalar(2).sub(w),this._followObject.updateMatrix(),this._followObject.updateMatrix()}if(this.settings.snapGridResolution>0){const w=this._followObject.worldPosition,P=this.settings.snapGridResolution;w.x=Math.round(w.x/P)*P,w.y=Math.round(w.y/P)*P,w.z=Math.round(w.z/P)*P,this._followObject.worldPosition=w,this._followObject.updateMatrix()}l&&(this._followObject.worldQuaternion=this._followObjectStartWorldQuaternion,this._followObject.updateMatrix());const _=z.clamp01(this.context.time.deltaTime*d*f),y=z.clamp01(this.context.time.deltaTime*d*.5*f),b=e.worldPosition;b.lerp(this._followObject.worldPosition,_),e.worldPosition=b;const v=e.worldQuaternion;if(v.slerp(this._followObject.worldQuaternion,y),e.worldQuaternion=v,In){const w=this._hitPointInLocalSpace.clone();e.localToWorld(w),N.DrawSphere(w,.02,16711680);const P=this._hitNormalInLocalSpace.clone();P.applyQuaternion(v),N.DrawRay(w,P,16711680),N.DrawLabel(b.add(new h.Vector3(0,.25,0)),`Distance: ${this._totalMovement.length().toFixed(2)}

                Along Ray: ${this._totalMovementAlongRayDirection.toFixed(2)}

                Session: ${!!q.active}

                Device: ${this._deviceMode}

                `,.03);const k=this._bottomCenter.clone(),O=this._backCenter.clone(),M=this._backBottomCenter.clone();e.localToWorld(k),e.localToWorld(O),e.localToWorld(M),N.DrawSphere(k,.01,65280,0,!1),N.DrawSphere(O,.01,255,0,!1),N.DrawSphere(M,.01,16711935,0,!1),N.DrawLine(k,M,65535,0,!1),N.DrawLine(M,O,65535,0,!1)}}onDragEnd(t){console.assert(this._followObject.parent===t.event.space,"Drag end: _followObject is not parented to the space object"),this._followObject.removeFromParent(),this._followObject.destroy(),this._lastDragPosRigSpace=void 0}setPlaneViewAligned(t,e){if(!this._followObject.parent)return!1;const i=this._followObject.parent.worldForward,n=$(0,1,0),o=i,a=n.angleTo(o),l=.5;return e&&(a>Math.PI/2+l||a<Math.PI/2-l)?this._dragPlane.setFromNormalAndCoplanarPoint(n,t):this._dragPlane.setFromNormalAndCoplanarPoint(i,t),!0}}const w_=class{constructor(t){r(this,"showGizmo",!0);r(this,"useViewAngle",!0);r(this,"_selected",null);r(this,"_context",null);r(this,"_camera");r(this,"_cameraPlane",new h.Plane);r(this,"_hasGroundPlane",!1);r(this,"_groundPlane",new h.Plane);r(this,"_groundOffset",new h.Vector3);r(this,"_groundOffsetFactor",0);r(this,"_groundDistance",0);r(this,"_groundPlanePoint",new h.Vector3);r(this,"_raycaster",new h.Raycaster);r(this,"_cameraPlaneOffset",new h.Vector3);r(this,"_intersection",new h.Vector3);r(this,"_worldPosition",new h.Vector3);r(this,"_inverseMatrix",new h.Matrix4);r(this,"_rbs",[]);r(this,"_groundLine");r(this,"_groundMarker");r(this,"_groundOffsetVector",new h.Vector3(0,1,0));r(this,"_requireUpdateGroundPlane",!0);r(this,"_didDragOnGroundPlaneLastFrame",!1);this._camera=t;const e=new h.Line(w_.geometry),i=e.material;i.color=new h.Color(.4,.4,.4),e.layers.set(2),e.name="line",e.scale.y=1,this._groundLine=e;const n=new h.SphereGeometry(.5,22,22),o=new h.MeshBasicMaterial({color:i.color}),a=new h.Mesh(n,o);a.visible=!1,a.layers.set(2),this._groundMarker=a}get hasSelected(){return this._selected!==null&&this._selected!==void 0}get selected(){return this._selected}setSelected(t,e){if(this._selected&&e)for(const i of this._rbs)i.wakeUp(),i.setVelocity(0,0,0);if(this._selected&&ms.Remove(e,this._selected),this._selected=t,this._context=e,this._rbs.length=0,t?(e.scene.add(this._groundLine),e.scene.add(this._groundMarker)):(this._groundLine.removeFromParent(),this._groundMarker.removeFromParent()),this._selected){if(!e){console.error("DragHelper: no context");return}ms.Add(e,this._selected,null),this._groundOffsetFactor=0,this._hasGroundPlane=!0,this._groundOffset.set(0,0,0),this._requireUpdateGroundPlane=!0,this.onUpdateScreenSpacePlane()}}onUpdate(t){this._selected}onUpdateWorldPosition(t,e,i){if(this._selected){if(i){const n=Z(this._selected);n.y=t.y,t=n}if(it(this._selected,t),it(this._groundLine,t),this._hasGroundPlane?this._groundLine.scale.y=this._groundDistance:this._groundLine.scale.y=1e3,this._groundLine.visible=this.showGizmo,this._groundMarker.visible=e!==null&&this.showGizmo,e){const n=Z(this._camera).distanceTo(e)*.01;this._groundMarker.scale.set(n,n,n),it(this._groundMarker,e)}}}onUpdateScreenSpacePlane(){if(!this._selected||!this._context)return;const t=this._context.input.getPointerPositionRC(0);t&&(this._raycaster.setFromCamera(t,this._camera),this._cameraPlane.setFromNormalAndCoplanarPoint(this._camera.getWorldDirection(this._cameraPlane.normal),this._worldPosition.setFromMatrixPosition(this._selected.matrixWorld)),this._raycaster.ray.intersectPlane(this._cameraPlane,this._intersection)&&this._selected.parent&&(this._inverseMatrix.copy(this._selected.parent.matrixWorld).invert(),this._cameraPlaneOffset.copy(this._intersection).sub(this._worldPosition.setFromMatrixPosition(this._selected.matrixWorld))))}onUpdateGroundPlane(){if(!this._selected||!this._context)return;const t=Z(this._selected),e=new h.Ray($(0,.1,0).add(t),$(0,-1,0)),i=new Fn;i.testObject=o=>o!==this._selected;const n=this._context.physics.raycastFromRay(e,i);for(let o=0;o<n.length;o++){const a=n[o];if(!a.face||this.contains(this._selected,a.object))continue;const l=$(0,1,0);this._groundPlane.setFromNormalAndCoplanarPoint(l,a.point);break}this._hasGroundPlane=!0,this._groundPlane.setFromNormalAndCoplanarPoint(e.direction.multiplyScalar(-1),e.origin),this._raycaster.ray.intersectPlane(this._groundPlane,this._intersection),this._groundDistance=this._intersection.distanceTo(t),this._groundOffset.copy(this._intersection).sub(t)}contains(t,e){if(t===e)return!0;if(t.children){for(const i of t.children)if(this.contains(i,e))return!0}return!1}};let zf=w_;r(zf,"geometry",new h.BufferGeometry().setFromPoints([new h.Vector3(0,0,0),new h.Vector3(0,-1,0)]));var Vv=(s=>(s.File_Spawned="file-spawned",s))(Vv||{});class uO{constructor(t,e,i,n,o,a,l,c,d){r(this,"guid");r(this,"file_name");r(this,"file_hash");r(this,"file_size");r(this,"position");r(this,"scale");r(this,"seed");r(this,"sender");r(this,"downloadUrl");r(this,"parentGuid");r(this,"boundsSize");this.seed=e,this.guid=i,this.file_name=n,this.file_hash=o,this.file_size=a,this.position=l,this.scale=c,this.sender=t,this.downloadUrl=d}}exports.PreviewHelper=void 0;(s=>{const t=new Map;function e(n){var f;t.has(n.guid)&&i(n.guid);const o=new h.Object3D;t.set(n.guid,o);const a=new h.Object3D;a.position.y=-.5,o.add(a);const l=new h.Mesh(new h.BoxGeometry(1,1,1,1,1,1),new h.MeshBasicMaterial({color:14540253,wireframe:!0,transparent:!0,opacity:.3}));l.position.y=.5,a.add(l);const c=new h.Object3D;a.add(c);const d=new h.Mesh(new h.BoxGeometry(1,1,1,1,1,1),new h.MeshBasicMaterial({color:12307660,transparent:!0,opacity:.4}));d.position.y=.5,c.scale.y=.01,c.add(d);const u=new h.Mesh(new h.PlaneGeometry(1,1,1,1),new h.MeshBasicMaterial({color:34,transparent:!0,opacity:.05,depthTest:!1}));return u.rotateX(-Math.PI/2),u.position.y=.51,d.add(u),n.parent.add(o),o.rotateY(Math.PI/2),n.position&&((f=o.position)==null||f.copy(n.position)),n.size&&(o.worldScale=new h.Vector3().copy(n.size)),o.position.y=o.scale.y/2,{object:o,onProgress:m=>{c instanceof h.Object3D&&c.scale.set(1,m,1)}}}s.addPreview=e;function i(n){const o=t.get(n);o&&(t.delete(n),o.removeFromParent())}s.removePreview=i})(exports.PreviewHelper||(exports.PreviewHelper={}));var fO=Object.defineProperty,pO=Object.getOwnPropertyDescriptor,Ga=(s,t,e,i)=>{for(var n=i>1?void 0:i?pO(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&fO(t,e,n),n};const sn=x("debugdroplistener");class mO extends CustomEvent{constructor(t){super("object-added",{detail:t})}}const gO="blob";class xs extends D{constructor(){super(...arguments);r(this,"useNetworking",!0);r(this,"dropArea");r(this,"fitIntoVolume",!1);r(this,"fitVolumeSize",new h.Vector3(1,1,1));r(this,"placeAtHitPosition",!0);r(this,"onDropped",new ge);r(this,"onNetworkEvent",e=>{var i;if(!this.useNetworking){sn&&console.debug("[DropListener] Ignoring networked event because networking is disabled",e);return}if((i=e.guid)!=null&&i.startsWith(this.guid)){const n=e.url;if(console.debug("[DropListener] Received networked event",e),n)if(Array.isArray(n))for(const o of n)this.addFromUrl(o,{screenposition:new h.Vector2,point:e.point,size:e.size},!0);else this.addFromUrl(n,{screenposition:new h.Vector2,point:e.point,size:e.size},!0)}});r(this,"handlePaste",e=>{if(this.context.connection.allowEditing===!1||e.defaultPrevented)return;navigator.clipboard.readText().then(n=>{if(n&&(n.startsWith("http")||n.startsWith("https")||n.startsWith("blob"))){const a={screenposition:new h.Vector2(this.context.input.mousePosition.x,this.context.input.mousePosition.y)};this.testIfIsInDropArea(a)&&this.addFromUrl(n,a,!1)}}).catch(console.warn)});r(this,"onDrag",e=>{this.context.connection.allowEditing!==!1&&e.preventDefault()});r(this,"onDrop",async e=>{if(this.context.connection.allowEditing===!1||(sn&&console.log(e),!(e!=null&&e.dataTransfer))||e["droplistener:handled"])return;e.preventDefault();const i={screenposition:new h.Vector2(e.offsetX,e.offsetY)};if(this.dropArea&&this.testIfIsInDropArea(i)===!1)return;e["droplistener:handled"]=!0;const n=e.dataTransfer.items;if(!n)return;const o=[];for(const a in n){const l=n[a];if(l.kind==="file"){const c=l.getAsFile();if(!c)continue;o.push(c)}else l.kind==="string"&&l.type=="text/plain"&&l.getAsString(c=>{this.addFromUrl(c,i,!1)})}o.length>0&&await this.addDroppedFiles(o,i)});r(this,"_abort",null);r(this,"_addedObjects",new Array);r(this,"_addedModels",new Array)}onEnable(){this.context.renderer.domElement.addEventListener("dragover",this.onDrag),this.context.renderer.domElement.addEventListener("drop",this.onDrop),window.addEventListener("paste",this.handlePaste),this.context.connection.beginListen("droplistener",this.onNetworkEvent)}onDisable(){this.context.renderer.domElement.removeEventListener("dragover",this.onDrag),this.context.renderer.domElement.removeEventListener("drop",this.onDrop),window.removeEventListener("paste",this.handlePaste),this.context.connection.stopListen("droplistener",this.onNetworkEvent)}loadFromURL(e,i){this.addFromUrl(e,{screenposition:new h.Vector2,point:i==null?void 0:i.point,size:i==null?void 0:i.size},!0)}forgetObjects(){this.removePreviouslyAddedObjects(!1)}async addFromUrl(e,i,n){sn&&console.log("dropped url",e);try{if(e.startsWith("https://github.com/")){const l=e.split("/"),c=l[3],d=l[4],u=l[6],f=l.slice(7).join("/");e=`https://raw.githubusercontent.com/${c}/${d}/${u}/${f}`}else e.startsWith("https://polyhaven.com/a")&&(e=_O(e));if(!e)return null;const o=e.toLowerCase();if(o.endsWith(".hdr")||o.endsWith(".hdri")||o.endsWith(".exr")||o.endsWith(".png")||o.endsWith(".jpg")||o.endsWith(".jpeg"))return null;this.removePreviouslyAddedObjects();const a=await Kd.loadFileFromURL(new URL(e),{guid:this.guid,context:this.context,parent:this.gameObject,point:i.point,size:i.size});if(a&&this._addedObjects.length<=0)return i.url=e,this.addObject(a,i,n)}catch{console.warn("String is not a valid URL",e)}return null}async addDroppedFiles(e,i){var n,o;if(sn&&console.log("Add files",e),!!Array.isArray(e)&&e.length){this.deleteDropEvent(),this.removePreviouslyAddedObjects(),wc(gO,null),(n=this._abort)==null||n.abort("New files dropped"),this._abort=new AbortController;for(const a of e){if(!a)continue;console.debug("Load file "+a.name);const l=await Kd.loadFile(a,this.context,{guid:this.guid});if(l){this.dispatchEvent(new CustomEvent("file-dropped",{detail:a})),i.file=a;const c=this.addObject(l,i,!1);c&&this.context.connection.isConnected&&this.useNetworking&&(console.debug("Uploading dropped file to blob storage"),exports.BlobStorage.upload(a,{abort:(o=this._abort)==null?void 0:o.signal}).then(d=>{d!=null&&d.download_url&&this._addedObjects.includes(c)&&this.sendDropEvent(d.download_url,c,l.contentMD5)}).catch(console.warn));break}}}}removePreviouslyAddedObjects(e=!0){if(e)for(const i of this._addedObjects)i.parent===this.gameObject&&Si(i,!0,!0);this._addedObjects.length=0,this._addedModels.length=0}addObject(e,i,n){var u,f;const{model:o,contentMD5:a}=e;if(sn&&console.log(`Dropped ${this.gameObject.name}`,o),!(o!=null&&o.scene))return console.warn("No object specified to add to scene",o),null;this.removePreviouslyAddedObjects();const l=o.scene;this.gameObject.attach(l),l.position.set(0,0,0),l.quaternion.identity(),this._addedObjects.push(l),this._addedModels.push(o);const c=new h.Box3().setFromCenterAndSize(new h.Vector3(0,this.fitVolumeSize.y*.5,0).add(this.gameObject.worldPosition),this.fitVolumeSize);if(sn&&N.DrawWireBox3(c,255,5),this.fitIntoVolume&&Zb(l,c,{position:!this.placeAtHitPosition}),this.placeAtHitPosition&&i&&i.screenposition){l.visible=!1;const m=this.context.physics.raycast({screenPoint:this.context.input.convertScreenspaceToRaycastSpace(i.screenposition.clone())});if(l.visible=!0,m&&m.length>0)for(const g of m){const _=g.point.clone();sn&&console.log("Place object at hit",g),Jb(l,_);break}}La.assignAnimationsFromFile(o,{createAnimationComponent:m=>wi(m,kt)});const d=new mO({sender:this,gltf:o,model:o,object:l,contentMD5:a,dropped:i.file||(i.url?new URL(i.url):void 0)});return this.dispatchEvent(d),(u=this.onDropped)==null||u.invoke(d.detail),!n&&((f=i.url)!=null&&f.startsWith("http"))&&this.context.connection.isConnected&&l&&this.sendDropEvent(i.url,l,a),l}async sendDropEvent(e,i,n){if(!this.useNetworking){sn&&console.debug("[DropListener] Ignoring networked event because networking is disabled",e);return}if(this.context.connection.isConnected){console.debug('Sending drop event "'+i.name+'"',e);const o=si([i]),a={name:i.name,guid:this.guid,url:e,point:i.worldPosition.clone(),size:o.getSize(new h.Vector3),contentMD5:n};this.context.connection.send("droplistener",a)}}deleteDropEvent(){this.context.connection.sendDeleteRemoteState(this.guid)}testIfIsInDropArea(e){if(this.dropArea){const i=this.context.input.convertScreenspaceToRaycastSpace(e.screenposition.clone());if(!this.context.physics.raycast({targets:[this.dropArea],screenPoint:i,recursive:!0,testObject:o=>!this._addedObjects.includes(o)}).length)return B()&&console.log(`Dropped outside of drop area for DropListener "${this.name}".`),!1}return!0}}Ga([p()],xs.prototype,"useNetworking",2);Ga([p(h.Object3D)],xs.prototype,"dropArea",2);Ga([p()],xs.prototype,"fitIntoVolume",2);Ga([p(h.Vector3)],xs.prototype,"fitVolumeSize",2);Ga([p()],xs.prototype,"placeAtHitPosition",2);Ga([p(ge)],xs.prototype,"onDropped",2);function _O(s){if(!s.startsWith("https://polyhaven.com/"))return s;const t="https://dl.polyhaven.org/file/ph-assets/Models/gltf/4k/",n=new URL(s).pathname.split("/").pop(),o=`${t}${n}/${n}_4k.gltf`;return console.log("Resolved polyhaven asset url",s,"→",o),o}var Kd;(s=>{async function t(i,n,o){const a=i.name.toLowerCase();return a.endsWith(".gltf")||a.endsWith(".glb")||a.endsWith(".fbx")||a.endsWith(".obj")||a.endsWith(".usdz")||a.endsWith(".vrm")||i.type==="model/gltf+json"||i.type==="model/gltf-binary"?new Promise((l,c)=>{const d=new FileReader;d.readAsArrayBuffer(i),d.onloadend=async u=>{const f=d.result,m=o.guid,g=new vt(m),_=await dn().parseSync(n,f,i.name,g);if(_){const y=exports.BlobStorage.hashMD5(f);l({model:_,contentMD5:y})}}}):(console.warn("Unsupported file type: "+a,i.type),null)}s.loadFile=t;async function e(i,n){return new Promise(async(o,a)=>{const l=new vt(n.guid),c=i.toString();sn&&N.DrawWireSphere(n.point,.1,16711680,3);const d=exports.PreviewHelper.addPreview({guid:n.guid,parent:n.parent,position:n==null?void 0:n.point,size:n==null?void 0:n.size}),u=await dn().loadSync(n.context,c,c,l,f=>{d.onProgress(f.loaded/f.total)}).catch(console.warn);if(u){const f=await fetch(c).then(g=>g.arrayBuffer()),m=exports.BlobStorage.hashMD5(f);sn?setTimeout(()=>exports.PreviewHelper.removePreview(n.guid),3e3):exports.PreviewHelper.removePreview(n.guid),o({model:u,contentMD5:m})}else sn?setTimeout(()=>exports.PreviewHelper.removePreview(n.guid),3e3):exports.PreviewHelper.removePreview(n.guid),console.warn("Unsupported file type: "+i.toString())})}s.loadFileFromURL=e})(Kd||(Kd={}));var yO=Object.defineProperty,bO=Object.getOwnPropertyDescriptor,Cg=(s,t,e,i)=>{for(var n=i>1?void 0:i?bO(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&yO(t,e,n),n};const $v=class extends D{constructor(){super(...arguments);r(this,"parent",null);r(this,"object",null);r(this,"limitCount",60);r(this,"_currentCount",0);r(this,"_startPosition",null);r(this,"_startQuaternion",null);r(this,"_forwardPointerEvents",new Map)}start(){var t,e;if(this._currentCount=0,this._startPosition=null,this._startQuaternion=null,this.object||(this.object=this.gameObject),this.object){if(this.object===this.gameObject){const n=new vt(this.guid);this.object=S.instantiate(this.object,{idProvider:n,keepWorldPosition:!1});const o=S.getComponent(this.object,$v);o==null||o.destroy();let a=this.object.getComponentInChildren(ii);a||(a=this.object.addComponent(ii,{dragMode:Sg.SnapToSurfaces}),a.guid=n.generateUUID());let l=S.getComponent(a.gameObject,Un);l||(l=a.gameObject.addComponent(Un),l.guid=n.generateUUID())}this.object.visible=!1;const i=this.gameObject.getComponent(ii);i&&(i.enabled=!1),this._startPosition=((t=this.object.position)==null?void 0:t.clone())??new h.Vector3(0,0,0),this._startQuaternion=((e=this.object.quaternion)==null?void 0:e.clone())??new h.Quaternion(0,0,0,1)}this.gameObject.getComponentInParent(Ci)||this.gameObject.addComponent(Ci)}onEnable(){this.startCoroutine(this.cloneLimitIntervalFn())}onPointerEnter(t){t.used||this.object&&this.context.connection.allowEditing&&t.button===0&&this.context.input.setCursor("pointer")}onPointerExit(t){t.used||this.object&&this.context.connection.allowEditing&&t.button===0&&this.context.input.unsetCursor("pointer")}onPointerDown(t){if(t.used||!this.object||!this.context.connection.allowEditing||t.button!==0)return;const e=this.handleDuplication();if(e){const i=S.getComponent(e,ii);i?(i.onPointerDown(t),this._forwardPointerEvents.set(t.event.space,i)):console.warn("Duplicated object does not have DragControls",e)}else this._currentCount>=this.limitCount?console.warn(`[Duplicatable] Limit of ${this.limitCount} objects created within a few seconds reached. Please wait a moment before creating more objects.`):console.warn("[Duplicatable] Could not duplicate object.")}onPointerUp(t){if(t.used)return;const e=this._forwardPointerEvents.get(t.event.space);e&&(e.onPointerUp(t),this._forwardPointerEvents.delete(t.event.space))}*cloneLimitIntervalFn(){for(;this.activeAndEnabled&&!this.destroyed;)this._currentCount>0?this._currentCount-=1:this._currentCount<0&&(this._currentCount=0),yield rg(1)}handleDuplication(){var i;if(!this.object||this.limitCount>0&&this._currentCount>=this.limitCount||this.object===this.gameObject)return null;if(S.isDestroyed(this.object))return this.object=null,null;this.object.visible=!0,this._startPosition&&this.object.position.copy(this._startPosition),this._startQuaternion&&this.object.quaternion.copy(this._startQuaternion);const t=new pn;this.parent||(this.parent=this.gameObject.parent),this.parent&&(t.parent=this.parent.guid??((i=this.parent.userData)==null?void 0:i.guid),t.keepWorldPosition=!0),t.position=this.worldPosition,t.rotation=this.worldQuaternion,t.context=this.context,this._currentCount+=1;const e=S.instantiateSynced(this.object,t);return console.assert(e!==this.object,"Duplicated object is original"),this.object.visible=!1,this._startPosition&&this.object.position.clone().copy(this._startPosition),this._startQuaternion&&this.object.quaternion.clone().copy(this._startQuaternion),e}};let Ha=$v;Cg([p(h.Object3D)],Ha.prototype,"parent",2);Cg([p(h.Object3D)],Ha.prototype,"object",2);Cg([p()],Ha.prototype,"limitCount",2);var es=(s=>(s[s.PointerEnter=0]="PointerEnter",s[s.PointerExit=1]="PointerExit",s[s.PointerDown=2]="PointerDown",s[s.PointerUp=3]="PointerUp",s[s.PointerClick=4]="PointerClick",s[s.Drag=5]="Drag",s[s.Drop=6]="Drop",s[s.Scroll=7]="Scroll",s[s.UpdateSelected=8]="UpdateSelected",s[s.Select=9]="Select",s[s.Deselect=10]="Deselect",s[s.Move=11]="Move",s[s.InitializePotentialDrag=12]="InitializePotentialDrag",s[s.BeginDrag=13]="BeginDrag",s[s.EndDrag=14]="EndDrag",s[s.Submit=15]="Submit",s[s.Cancel=16]="Cancel",s))(es||{}),vO=Object.defineProperty,wO=Object.getOwnPropertyDescriptor,Pg=(s,t,e,i)=>{for(var n=i>1?void 0:i?wO(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&vO(t,e,n),n};class Og{constructor(){r(this,"eventID");r(this,"callback",new ge)}}Pg([p()],Og.prototype,"eventID",2);Pg([p(ge)],Og.prototype,"callback",2);class Uu extends D{constructor(){super(...arguments);r(this,"triggers",[])}invoke(e){var i;if(this.triggers)for(const n of this.triggers)n.eventID===e&&((i=n.callback)==null||i.invoke())}hasTrigger(e){var i;return((i=this.triggers)==null?void 0:i.some(n=>n.eventID===e))??!1}shouldChangeCursor(){return this.hasTrigger(es.PointerClick)||this.hasTrigger(es.PointerDown)||this.hasTrigger(es.PointerUp)}onPointerClick(e){this.invoke(es.PointerClick)}onPointerEnter(e){this.shouldChangeCursor()&&this.context.input.setCursor("pointer"),this.invoke(es.PointerEnter)}onPointerExit(e){this.shouldChangeCursor()&&this.context.input.unsetCursor("pointer"),this.invoke(es.PointerExit)}onPointerDown(e){this.invoke(es.PointerDown)}onPointerUp(e){this.invoke(es.PointerUp)}}Pg([p(Og)],Uu.prototype,"triggers",2);class Wv{constructor(t){r(this,"writer");this.writer=t}writeNode(t){}}class xO extends Wv{beforeWriteNode(t,e){N.isGizmo(t)&&(e.keep=!1)}}class Gv extends Wv{beforeWriteTexture(t,e){t.isRenderTargetTexture&&(e.newTexture=ag(new me(1,1,1,0)))}}function rm(s){const t=ju.DontExport;return!(s.hideFlags&t)}const Nf=x("debugexr");class SO{constructor(t){r(this,"parser");this.parser=t,Nf&&console.log(t)}get name(){return"EXT_texture_exr"}loadTexture(t){const e=this.name,i=this.parser,o=i.json.textures[t];if(Nf&&console.log("EXT_texture_exr.loadTexture",t,o),!o.extensions||!o.extensions[e])return null;const a=o.extensions[e],l=new Y.EXRLoader(i.options.manager);return Nf&&console.log("EXT_texture_exr.loadTexture",a),i.loadTextureImage(t,a.source,l)}}typeof window<"u"&&window.addEventListener("unhandledrejection",s=>{});const Qn=lt,Vh="$___Export_Components",CO="NEEDLE_components";var t2;class PO{constructor(){r(this,t2)}}t2=Fo;class OO{constructor(t,e,i){r(this,"node");r(this,"nodeIndex");r(this,"nodeDef");this.node=t,this.nodeIndex=e,this.nodeDef=i}}class Hv{constructor(){r(this,"parser");r(this,"nodeToObjectMap",{});r(this,"gltf",null);r(this,"exportContext");r(this,"objectToNodeMap",{});r(this,"context");r(this,"writer")}get name(){return CO}registerExport(t){t.register(e=>{if("serializeUserData"in e){const i=e.serializeUserData.bind(e);this.writer=e,e.serializeUserData=(n,o)=>{try{this.serializeUserData(n,o)&&(e.extensionsUsed[this.name]=!0),i(n,o)}finally{this.afterSerializeUserData(n,o)}}}return this})}beforeParse(){this.exportContext={},this.objectToNodeMap={}}serializeUserData(t,e){var n;const i=(n=t.userData)==null?void 0:n.components;return!i||i.length<=0?!1:(delete t.userData.components,t[Vh]=i,!0)}afterSerializeUserData(t,e){if(t.type==="Scene"&&Qn&&console.log("DONE",JSON.stringify(e)),t[Vh]===void 0)return;const i=t[Vh];delete t[Vh],i!==null&&(t.userData.components=i)}writeNode(t,e){const i=this.writer.json.nodes.length;Qn&&console.log(t.name,i,t.uuid);const n=new OO(t,i,e);this.exportContext[i]=n,this.objectToNodeMap[t.uuid]=i}afterParse(t){var e;Qn&&console.log("AFTER",t);for(const i in this.exportContext){const n=this.exportContext[i],o=n.node,a=n.nodeDef,l=n.nodeIndex,c=(e=o.userData)==null?void 0:e.components;if(!c||c.length<=0)continue;const d=new PO;a.extensions=a.extensions||{},a.extensions[this.name]=d,this.context.object=o,this.context.nodeId=l,this.context.objectToNode=this.objectToNodeMap;const u=[];for(const f of c){this.context.target=f;const m=dn().writeBuiltinComponentData(f,this.context);m!==null&&u.push(m)}u.length>0&&(d[Fo]=u,Qn&&console.log("DID WRITE",o,"nodeIndex",l,u))}}beforeRoot(){return Qn&&console.log("BEGIN LOAD"),this.nodeToObjectMap={},null}async afterRoot(t){this.gltf=t;const e=t.parser,i=e==null?void 0:e.extensions;if(!i)return;const n=i[this.name];Qn&&console.log("After root",t,this.parser,i);const o=[];if(n===!0){const a=e.json.nodes;if(a){for(let l=0;l<a.length;l++){const c=await e.getDependency("node",l);this.nodeToObjectMap[l]=c}for(let l=0;l<a.length;l++){const c=a[l],d=l,u=c.extensions;if(!u)continue;const f=u[this.name];if(!f)continue;Qn&&console.log("NODE",c);const m=this.nodeToObjectMap[d];if(!m){console.error("Could not find object for node index: "+d,c,e);continue}Mu(m),o.push(this.createComponents(m,f))}}}await Promise.all(o);for(const a of e.associations.keys()){const l=e.associations.get(a);if((l==null?void 0:l.materials)!=null){const c="/materials/"+l.materials;AC(a,c)}}}async createComponents(t,e){if(!e)return;const i=e[Fo];if(i){const n=new Array;Qn&&console.log(t.name,i);for(const o in i){const a=i[o];Qn&&console.log("Serialized data",JSON.parse(JSON.stringify(a))),a&&this.parser&&n.push(ig(this.parser,a).catch(l=>console.error(`Error while resolving references (see console for details)
`,l,t,a))),t.userData=t.userData||{},t.userData[Fo]=t.userData[Fo]||[],t.userData[Fo].push(a)}await Promise.all(n).catch(o=>{console.error("Error while loading components",o)})}}}const zy="NEEDLE_gameobject_data";class MO{constructor(t){r(this,"parser");this.parser=t}get name(){return zy}afterRoot(t){var i;const e=[];for(let n=0;n<((i=this.parser.json.nodes)==null?void 0:i.length);n++){const o=this.parser.json.nodes[n];if(o&&o.extensions){const a=o.extensions[zy];if(a){const l=this.findAndApplyExtensionData(n,a);e.push(l)}}}return Promise.all(e).then(()=>null)}async findAndApplyExtensionData(t,e){const i=await this.parser.getDependency("node",t);i&&this.applyExtensionData(i,e)}applyExtensionData(t,e){e.layers===void 0&&(e.layers=0),t.userData.layer=e.layers,t.layers.disableAll(),t.layers.set(e.layers),t.userData.tag=e.tag??"none",t.hideFlags=0,t.userData.static=e.static??!1,t.visible=e.activeSelf??!0,t.guid=e.guid}}const Ny="NEEDLE_lighting_settings",oa=x("debugenvlight");class RO{constructor(t,e,i){r(this,"parser");r(this,"sourceId");r(this,"context");this.parser=t,this.sourceId=e,this.context=i}get name(){return Ny}afterRoot(t){const e=this.parser.json.extensions;if(e){const i=e[Ny];if(i){oa&&console.log('Loaded "'+this.name+'", src: "'+this.sourceId+'"',i);let n;if(t.scene.children.length===1){const o=t.scene.children[0];n=S.addComponent(o,Zd,{},{callAwake:!1})}else{const o=new h.Object3D;o.name="LightSettings "+this.sourceId,t.scene.add(o),n=S.addComponent(o,Zd,{},{callAwake:!1})}n.sourceId=this.sourceId,n.ambientIntensity=i.ambientIntensity,n.ambientLight=new h.Color().fromArray(i.ambientLight),Array.isArray(i.ambientTrilight)&&(n.ambientTrilight=i.ambientTrilight.map(o=>new h.Color().fromArray(o))),n.ambientMode=i.ambientMode,n.environmentReflectionSource=i.environmentReflectionSource}}return null}}ce.registerCallback(he.ContextCreated,s=>{const t=s.context,e=S.findObjectOfType(Zd,t);e!=null&&e.sourceId&&(e.enabled=!0)});class Zd extends D{constructor(){super(...arguments);r(this,"ambientMode",Ca.Skybox);r(this,"ambientLight");r(this,"ambientTrilight");r(this,"ambientIntensity",1);r(this,"environmentReflectionSource",Wd.Skybox);r(this,"_hasReflection",!1);r(this,"_ambientLightObj");r(this,"_hemisphereLightObj")}awake(){var i;if(this.sourceId){const n=this.environmentReflectionSource===Wd.Skybox?Ys.Skybox:Ys.Reflection,o=this.context.lightmaps.tryGet(this.sourceId,n,0);this._hasReflection=o!=null,o&&this.context.sceneLighting.internalRegisterReflection(this.sourceId,o)}this.enabled=!1,this.context.sceneLighting.internalRegisterSceneLightSettings(this),oa&&window.addEventListener("keydown",n=>{if(!this.destroyed)switch(n.key){case"l":this.enabled=!this.enabled;break}});const e=(i=this.gameObject.userData)==null?void 0:i.components;if(e){const n=e.indexOf(this);e.splice(n,1),e.push(this)}}onDestroy(){this.context.sceneLighting.internalUnregisterSceneLightSettings(this)}calculateIntensityFactor(e){const i=Math.max(e.r,e.g,e.b);return 2.2*z.lerp(0,1.33,i)}onEnable(){if(oa&&console.warn("💡🟡 >>> Enable lighting",this.sourceId,this.enabled,this),this.ambientMode==Ca.Flat){if(this.ambientLight&&!this._ambientLightObj){const e=this.calculateIntensityFactor(this.ambientLight);this._ambientLightObj=new h.AmbientLight(this.ambientLight,this.ambientIntensity*e),oa&&console.log("Created ambient light",this.sourceId,this._ambientLightObj,this.ambientIntensity,e)}this._ambientLightObj&&this.gameObject.add(this._ambientLightObj)}else if(this.ambientMode===Ca.Trilight){if(this.ambientTrilight){const e=this.ambientTrilight[0],i=this.ambientTrilight[this.ambientTrilight.length-1],n=this.calculateIntensityFactor(i);this._hemisphereLightObj=new h.HemisphereLight(i,e,this.ambientIntensity*n),this.gameObject.add(this._hemisphereLightObj),oa&&console.log("Created hemisphere ambient light",this.sourceId,this._hemisphereLightObj,this.ambientIntensity,n)}}else this._ambientLightObj&&this._ambientLightObj.removeFromParent(),this._hemisphereLightObj&&this._hemisphereLightObj.removeFromParent();this.sourceId&&this.context.sceneLighting.internalEnableReflection(this.sourceId)}onDisable(){oa&&console.warn("💡⚫ <<< Disable lighting:",this.sourceId,this),this._ambientLightObj&&this._ambientLightObj.removeFromParent(),this._hemisphereLightObj&&this._hemisphereLightObj.removeFromParent(),this.sourceId&&this.context.sceneLighting.internalDisableReflection(this.sourceId)}}const Vf=x("debugstencil");function kO(s,t){return(s&1<<t.layer)!=0}const EO=Symbol("stencils"),$o=class{constructor(t,e){r(this,"parser");r(this,"source");this.parser=t,this.source=e}get name(){return"NEEDLE_render_objects"}static applyStencil(t){if(!t)return;const e=t.sourceId;if(Vf&&console.log(e,$o.stencils),!e)return;const i=$o.stencils[e];if(i)for(let n=i.length-1;n>=0;n--){const o=i[n];if(kO(o.layer,t)){Vf&&console.log(o),setTimeout(()=>{Ht()&&Ru(t.gameObject)&&(pe("Stencil not supported on instanced objects"),console.warn("Stencil not supported on instanced objects",t))},500);for(let a=0;a<t.sharedMaterials.length;a++){let l=t.sharedMaterials[a];l&&(l=l.clone(),l[EO]=!0,l.stencilWrite=!0,l.stencilWriteMask=255,l.stencilFuncMask=255,l.stencilRef=o.value,l.stencilFunc=o.compareFunc,l.stencilZPass=o.passOp,l.stencilFail=o.failOp,l.stencilZFail=o.zFailOp,t.sharedMaterials[a]=l)}t.gameObject.renderOrder=o.event*1e3+o.index*50;break}}}afterRoot(t){const e=this.parser.json.extensions;if(e){const i=e[AO];if(i){Vf&&console.log(i);const n=i.stencil;if(n&&Array.isArray(n))for(const o of n){const a={...o};a.compareFunc=TO(a.compareFunc),a.passOp=$f(a.passOp),a.failOp=$f(a.failOp),a.zFailOp=$f(a.zFailOp),$o.stencils[this.source]||($o.stencils[this.source]=[]),$o.stencils[this.source].push(a)}}}return null}};let lc=$o;r(lc,"stencils",{});function $f(s){switch(s){case 0:return h.KeepStencilOp;case 1:return h.ZeroStencilOp;case 2:return h.ReplaceStencilOp;case 3:return h.IncrementStencilOp;case 4:return h.DecrementStencilOp;case 6:return h.IncrementWrapStencilOp;case 7:return h.DecrementWrapStencilOp;case 5:return h.InvertStencilOp}return 0}function TO(s){switch(s){case 1:return h.NeverStencilFunc;case 2:return h.LessStencilFunc;case 3:return h.EqualStencilFunc;case 4:return h.LessEqualStencilFunc;case 5:return h.GreaterStencilFunc;case 6:return h.NotEqualStencilFunc;case 7:return h.GreaterEqualStencilFunc;case 8:return h.AlwaysStencilFunc}return h.NeverStencilFunc}const AO="NEEDLE_render_objects";var qv=(s=>(s[s.INT=5124]="INT",s[s.FLOAT=5126]="FLOAT",s[s.FLOAT_VEC2=35664]="FLOAT_VEC2",s[s.FLOAT_VEC3=35665]="FLOAT_VEC3",s[s.FLOAT_VEC4=35666]="FLOAT_VEC4",s[s.INT_VEC2=35667]="INT_VEC2",s[s.INT_VEC3=35668]="INT_VEC3",s[s.INT_VEC4=35669]="INT_VEC4",s[s.BOOL=35670]="BOOL",s[s.BOOL_VEC2=35671]="BOOL_VEC2",s[s.BOOL_VEC3=35672]="BOOL_VEC3",s[s.BOOL_VEC4=35673]="BOOL_VEC4",s[s.FLOAT_MAT2=35674]="FLOAT_MAT2",s[s.FLOAT_MAT3=35675]="FLOAT_MAT3",s[s.FLOAT_MAT4=35676]="FLOAT_MAT4",s[s.SAMPLER_2D=35678]="SAMPLER_2D",s[s.SAMPLER_3D=35680]="SAMPLER_3D",s[s.SAMPLER_CUBE=35681]="SAMPLER_CUBE",s[s.UNKNOWN=0]="UNKNOWN",s))(qv||{});const Pn=x("debugcustomshader"),Wr="NEEDLE_techniques_webgl";class DO{constructor(){r(this,"objectToWorldMatrix",new h.Matrix4);r(this,"worldToObjectMatrix",new h.Matrix4);r(this,"objectToWorld",new Array);r(this,"worldToObject",new Array)}updateFrom(t){this.objectToWorldMatrix.copy(t.matrixWorld),$d(this.objectToWorldMatrix,this.objectToWorld),this.worldToObjectMatrix.copy(t.matrixWorld).invert(),$d(this.worldToObjectMatrix,this.worldToObject)}}const Re=class extends h.RawShaderMaterial{constructor(e,...i){super(...i);r(this,"identifier");r(this,"onBeforeRenderSceneCallback",this.onBeforeRenderScene.bind(this));r(this,"_sphericalHarmonicsName","unity_SpecCube0");r(this,"_objToWorldName","hlslcc_mtx4x4unity_ObjectToWorld");r(this,"_worldToObjectName","hlslcc_mtx4x4unity_WorldToObject");r(this,"_viewProjectionName","hlslcc_mtx4x4unity_MatrixVP");r(this,"_viewMatrixName","hlslcc_mtx4x4unity_MatrixV");r(this,"_rendererData",new DO);this.identifier=e,Pn&&console.log(this),this.type="NEEDLE_CUSTOM_SHADER",this.uniforms[this._objToWorldName]||(this.uniforms[this._objToWorldName]={value:[]}),this.uniforms[this._worldToObjectName]||(this.uniforms[this._worldToObjectName]={value:[]}),this.uniforms[this._viewProjectionName]||(this.uniforms[this._viewProjectionName]={value:[]}),this.uniforms[this._sphericalHarmonicsName],(this.depthTextureUniform||this.opaqueTextureUniform)&&Q.Current.pre_render_callbacks.push(this.onBeforeRenderSceneCallback)}clone(){const e=super.clone();return Xv(e),e}dispose(){super.dispose();const e=Q.Current.pre_render_callbacks.indexOf(this.onBeforeRenderSceneCallback);e>=0&&Q.Current.pre_render_callbacks.splice(e,1)}get depthTextureUniform(){if(this.uniforms)return this.uniforms._CameraDepthTexture}get opaqueTextureUniform(){if(this.uniforms)return this.uniforms._CameraOpaqueTexture}onBeforeRenderScene(){this.opaqueTextureUniform&&Q.Current.setRequireColor(!0),this.depthTextureUniform&&Q.Current.setRequireDepth(!0)}onBeforeRender(e,i,n,o,a,l){o.attributes.tangent||o.computeTangents(),this.onUpdateUniforms(n,a)}onUpdateUniforms(e,i){const n=Q.Current;if(e&&(Re.viewProjection&&this.uniforms[this._viewProjectionName]&&(Re.viewProjection.copy(e.projectionMatrix).multiply(e.matrixWorldInverse),$d(Re.viewProjection,Re._viewProjectionValues)),Re.viewMatrix&&this.uniforms[this._viewMatrixName]&&(Re.viewMatrix.copy(e.matrixWorldInverse),$d(Re.viewMatrix,Re._viewMatrixValues)),this.uniforms[Re._worldSpaceCameraPosName]&&Re._worldSpaceCameraPos.setFromMatrixPosition(e.matrixWorld)),this.uniforms._TimeParameters&&(this.uniforms._TimeParameters.value=n.sceneLighting.timeVec4),this.uniforms._Time){const c=this.uniforms._Time.value;c.x=n.sceneLighting.timeVec4.x/20,c.y=n.sceneLighting.timeVec4.x,c.z=n.sceneLighting.timeVec4.x*2,c.w=n.sceneLighting.timeVec4.x*3}if(this.uniforms._SinTime){const c=this.uniforms._SinTime.value;c.x=Math.sin(n.sceneLighting.timeVec4.x/8),c.y=Math.sin(n.sceneLighting.timeVec4.x/4),c.z=Math.sin(n.sceneLighting.timeVec4.x/2),c.w=Math.sin(n.sceneLighting.timeVec4.x)}if(this.uniforms._CosTime){const c=this.uniforms._CosTime.value;c.x=Math.cos(n.sceneLighting.timeVec4.x/8),c.y=Math.cos(n.sceneLighting.timeVec4.x/4),c.z=Math.cos(n.sceneLighting.timeVec4.x/2),c.w=Math.cos(n.sceneLighting.timeVec4.x)}if(this.uniforms.unity_DeltaTime){const c=this.uniforms.unity_DeltaTime.value;c.x=n.time.deltaTime,c.y=1/n.time.deltaTime,c.z=n.time.smoothedDeltaTime,c.w=1/n.time.smoothedDeltaTime}const o=n.mainLight;if(o){const c=Z(o.gameObject,Re._mainLightPosition);this.uniforms._MainLightPosition={value:c.normalize()},Re._mainLightColor.set(o.color.r,o.color.g,o.color.b,0),this.uniforms._MainLightColor={value:Re._mainLightColor};const d=o.intensity;Re._lightData.z=d,this.uniforms.unity_LightData={value:Re._lightData}}if(e&&(Re.viewProjection&&this.uniforms[this._viewProjectionName]&&(this.uniforms[this._viewProjectionName].value=Re._viewProjectionValues),Re.viewMatrix&&this.uniforms[this._viewMatrixName]&&(this.uniforms[this._viewMatrixName].value=Re._viewMatrixValues),this.uniforms[Re._worldSpaceCameraPosName]&&(this.uniforms[Re._worldSpaceCameraPosName]={value:Re._worldSpaceCameraPos}),n.mainCameraComponent)){if(this.uniforms._ProjectionParams){const c=this.uniforms._ProjectionParams.value;c.x=1,c.y=n.mainCameraComponent.nearClipPlane,c.z=n.mainCameraComponent.farClipPlane,c.w=1/c.z,this.uniforms._ProjectionParams.value=c}if(this.uniforms._ZBufferParams){const c=this.uniforms._ZBufferParams.value,d=n.mainCameraComponent;c.x=1-d.farClipPlane/d.nearClipPlane,c.y=d.farClipPlane/d.nearClipPlane,c.z=c.x/d.farClipPlane,c.w=c.y/d.farClipPlane,this.uniforms._ZBufferParams.value=c}if(this.uniforms._ScreenParams){const c=this.uniforms._ScreenParams.value;c.x=n.domWidth,c.y=n.domHeight,c.z=1+1/c.x,c.w=1+1/c.y,this.uniforms._ScreenParams.value=c}if(this.uniforms._ScaledScreenParams){const c=this.uniforms._ScaledScreenParams.value;c.x=n.domWidth,c.y=n.domHeight,c.z=1+1/c.x,c.w=1+1/c.y,this.uniforms._ScaledScreenParams.value=c}}const a=this.depthTextureUniform;a&&(a.value=n.depthTexture);const l=this.opaqueTextureUniform;if(l&&(l.value=n.opaqueColorTexture),i){const c=this._rendererData;c.updateFrom(i),this.uniforms[this._worldToObjectName].value=c.worldToObject,this.uniforms[this._objToWorldName].value=c.objectToWorld}this.uniformsNeedUpdate=!0}};let fi=Re;r(fi,"viewProjection",new h.Matrix4),r(fi,"_viewProjectionValues",[]),r(fi,"viewMatrix",new h.Matrix4),r(fi,"_viewMatrixValues",[]),r(fi,"_worldSpaceCameraPosName","_WorldSpaceCameraPos"),r(fi,"_worldSpaceCameraPos",new h.Vector3),r(fi,"_mainLightColor",new h.Vector4),r(fi,"_mainLightPosition",new h.Vector3),r(fi,"_lightData",new h.Vector4);class LO{constructor(t,e){r(this,"parser");r(this,"identifier");this.parser=t,this.identifier=e}get name(){return Wr}loadMaterial(t){const e=this.parser.json.materials[t];if(!e)return Pn&&console.log(t,this.parser.json.materials),null;if(!e.extensions||!e.extensions[Wr])return Pn&&console.log(`Material ${t} does not use NEEDLE_techniques_webgl`),null;Pn&&console.log(`Material ${t} uses NEEDLE_techniques_webgl`,e);const i=e.extensions[Wr].technique;if(i<0)return console.debug(`Material ${t} does not have a valid technique index`),null;const n=this.parser.json.extensions[Wr];if(!n)return Pn?console.error("Missing shader data",this.parser.json.extensions):console.debug("Missing custom shader data in parser.json.extensions"),null;Pn&&console.log(n);const o=n.techniques[i];return o?new Promise(async(a,l)=>{var v,w,P;const c=await l1(n,o.program),d=c==null?void 0:c.fragmentShader,u=c==null?void 0:c.vertexShader;if(!d||!u)return l();Pn&&console.log("loadMaterial",e,c);const f={},m=o.uniforms;(u.includes("_Time")||d.includes("_Time"))&&(f._Time={value:new h.Vector4(0,0,0,0)}),(u.includes("_SinTime")||d.includes("_SinTime"))&&(f._SinTime={value:new h.Vector4(0,0,0,0)}),(u.includes("_CosTime")||d.includes("_CosTime"))&&(f._CosTime={value:new h.Vector4(0,0,0,0)}),(u.includes("unity_DeltaTime")||d.includes("unity_DeltaTime"))&&(f.unity_DeltaTime={value:new h.Vector4(0,0,0,0)});for(const k in m){const O=k;switch(O){case"_TimeParameters":const M=new h.Vector4;f[O]={value:M};break;case"hlslcc_mtx4x4unity_MatrixV":case"hlslcc_mtx4x4unity_MatrixVP":f[O]={value:[]};break;case"_MainLightPosition":case"_MainLightColor":case"_WorldSpaceCameraPos":f[O]={value:[0,0,0,1]};break;case"unity_OrthoParams":break;case"unity_SpecCube0":f[O]={value:null};break;default:case"_ScreenParams":case"_ZBufferParams":case"_ProjectionParams":f[O]={value:[0,0,0,0]};break;case"_CameraOpaqueTexture":case"_CameraDepthTexture":f[O]={value:null};break}}let g=!1;if(e.extensions&&e.extensions[Wr]){const k=e.extensions[Wr];if(k.technique===i){Pn&&console.log(e.name,"Material Properties",k);for(const O in k.values){const M=k.values[O];if(typeof M=="string"){if(M.startsWith("/textures/")){const A=M.substring(10),I=Number.parseInt(A);if(I>=0){const T=await this.parser.getDependency("texture",I);T instanceof h.Texture&&(T.colorSpace=h.LinearSRGBColorSpace,T.needsUpdate=!0),f[O]={value:T};continue}}switch(O){case"alphaMode":M==="BLEND"&&(g=!0);continue}}if(Array.isArray(M)&&M.length===4){f[O]={value:new h.Vector4(M[0],M[1],M[2],M[3])};continue}f[O]={value:M}}}}const _=new fi(this.identifier,{name:e.name??"",uniforms:f,vertexShader:u,fragmentShader:d,lights:!1});switch(_.glslVersion=h.GLSL3,_.vertexShader=_.vertexShader.replace("#version 300 es",""),_.fragmentShader=_.fragmentShader.replace("#version 300 es",""),(v=f._Cull)==null?void 0:v.value){case 0:_.side=h.DoubleSide;break;case 1:_.side=h.BackSide;break;case 2:_.side=h.FrontSide;break;default:_.side=h.FrontSide;break}switch((w=f._ZTest)==null?void 0:w.value){case 3:_.depthTest=!0,_.depthFunc=h.EqualDepth;break;case 6:_.depthTest=!0,_.depthFunc=h.NotEqualDepth;break;case 2:_.depthTest=!0,_.depthFunc=h.LessDepth;break;case 4:_.depthTest=!0,_.depthFunc=h.LessEqualDepth;break;case 5:_.depthTest=!0,_.depthFunc=h.GreaterDepth;break;case 7:_.depthTest=!0,_.depthFunc=h.GreaterEqualDepth;break;case 8:_.depthTest=!1,_.depthFunc=h.AlwaysDepth;break}_.transparent=g,g&&(_.depthWrite=!1),r1(f),_.onUpdateUniforms();for(const k in m){const O=k,M=m[k].type;if(((P=f[O])==null?void 0:P.value)===void 0)switch(M){case qv.SAMPLER_2D:f[O]={value:s1},console.warn("Missing/unassigned texture, fallback to white: "+O);break;default:O==="unity_OrthoParams"||console.warn("TODO: EXPECTED UNIFORM / fallback NOT SET: "+O,m[k]);break}}Pn&&console.log(_.uuid,f),Xv(_),a(_)}):null}}function Xv(s){if(s.uniforms){Pn&&console.log("Uniforms:",s.uniforms);for(const e in s.uniforms)switch(t(e,e),e){case"_Color":t("color",e);break}}function t(e,i){Object.getOwnPropertyDescriptor(s,e)||Object.defineProperty(s,e,{get:()=>s.uniforms[i].value,set:n=>{s.uniforms[i].value=n,s.needsUpdate=!0}})}}const IO=x("debugextensions");let Jd;const jO=Promise.resolve().then(()=>require("./three-examples.light.umd.cjs")).then(s=>s.GLTFLoaderAnimationPointer).then(async s=>(Jd=s.GLTFAnimationPointerExtension,Jd)).catch(s=>{console.warn("Failed to import GLTFLoaderAnimationPointer. Please use @needle-tools/three for full KHR_animation support",s)}),ur=new Array;function BO(s){ur.includes(s)||ur.push(s)}function FO(s){const t=ur.indexOf(s);t>=0&&ur.splice(t,1)}function zu(s){const t=new Hv;return s.register(e=>(t.parser=e,t)),t}class UO{resolvePath(t){return t.includes("/extensions/builtin_components/")?t.replace("/extensions/builtin_components/","/userData/components/"):t.includes("extensions/builtin_components/")?t.replace("extensions/builtin_components/","/userData/components/"):t}}async function eu(s,t,e){const i=e.indexOf("?");i>=0&&(e=e.substring(0,i)),s.register(n=>new MO(n)),s.register(n=>new LC(n)),s.register(n=>new e1(n,t.lightmaps,e)),s.register(n=>new RO(n,e,t)),s.register(n=>new LO(n,e)),s.register(n=>new lc(n,e)),s.register(n=>new re.NEEDLE_progressive(n,e)),s.register(n=>new SO(n)),C0()&&s.register(n=>new ic(n)),await jO.catch(n=>{}),s.register(n=>{if(Jd){const o=new Jd(n);return o.setAnimationPointerResolver.bind(o)(new UO),o}else return(IO||B())&&console.error("Missing KHR_animation_pointer extension..."),{name:"KHR_animation_pointer_NOT_AVAILABLE"}});for(const n of ur)n.onImport&&n.onImport(s,e,t)}function Mg(s,t){for(const e of ur)e.onExport&&e.onExport(s,t)}function Rg(s,t,e){for(const i of ur)i.onLoaded&&i.onLoaded(s,t,e)}class Qv{constructor(t){this.writer=t,this.name="EXT_mesh_gpu_instancing"}writeNode(t,e){if(t.constructor.name!=="InstancedMesh")return;const i=this.writer,n=i.extensionsUsed,o={};e.extensions=e.extensions||{},e.extensions[this.name]=o;let a=new h.Matrix4;const l=new Array,c=new Array,d=new Array;for(let g=0;g<t.count;g++){t.getMatrixAt(g,a);let _=new h.Vector3,y=new h.Quaternion,b=new h.Vector3;a.decompose(_,y,b),l.push(_.x,_.y,_.z),c.push(y.x,y.y,y.z,y.w),d.push(b.x,b.y,b.z)}const u=new Float32Array(l),f=new Float32Array(c),m=new Float32Array(d);o.attributes={TRANSLATION:i.processAccessor(new h.BufferAttribute(u,3)),ROTATION:i.processAccessor(new h.BufferAttribute(f,4)),SCALE:i.processAccessor(new h.BufferAttribute(m,3))},n[this.name]=!0}}var zO=Object.defineProperty,NO=Object.getOwnPropertyDescriptor,Yv=(s,t,e,i)=>{for(var n=i>1?void 0:i?NO(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&zO(t,e,n),n};const $h=x("debugreflectionprobe"),Vy=x("noreflectionprobe"),VO=Symbol("reflectionProbeKey"),$O=Symbol("original material");var od;const ts=(od=class extends D{constructor(){var t;super();r(this,"_texture");r(this,"center");r(this,"size");r(this,"_boxHelper");ts._probes.has(this.context)||ts._probes.set(this.context,[]),(t=ts._probes.get(this.context))==null||t.push(this)}static get(t,e,i,n){if(!t||t.isObject3D!==!0||Vy)return null;const o=ts._probes.get(e);if(o){for(const a of o)if(a.__didAwake||a.__internalAwake(),a.enabled&&n&&a.gameObject===n)return a}return $h&&console.debug("Did not find reflection probe",t.name,i,t),null}set texture(t){if(t&&!(t instanceof h.Texture)){console.error("ReflectionProbe.texture must be a Texture",t);return}this._texture=t,t&&(t.mapping=h.EquirectangularReflectionMapping,t.colorSpace=h.SRGBColorSpace,t.needsUpdate=!0)}get texture(){return this._texture}isInBox(t){var e;return(e=this._boxHelper)==null?void 0:e.isInBox(t)}awake(){this._boxHelper=this.gameObject.addComponent(ti),this._boxHelper.updateBox(!0),$h&&this._boxHelper.showHelper(5592320,!0),this.texture&&(this.texture.mapping=h.EquirectangularReflectionMapping,this.texture.colorSpace=h.SRGBColorSpace,this.texture.needsUpdate=!0)}onDestroy(){const t=ts._probes.get(this.context);if(t){const e=t.indexOf(this);e>=0&&t.splice(e,1)}}onSet(t){var i;if(Vy||!this.enabled||((i=t.sharedMaterials)==null?void 0:i.length)<=0||!this.texture)return;let e=ts._rendererMaterialsCache.get(t);e||(e=[],ts._rendererMaterialsCache.set(t,e));for(let n=0;n<t.sharedMaterials.length;n++){const o=t.sharedMaterials[n];if(!o||o.envMap===void 0||o instanceof h.MeshBasicMaterial)continue;let a=e[n];const l=o===(a==null?void 0:a.copy),c=!a||a.material.uuid!==o.uuid||a.copy.version!==o.version;if(!l&&c){if($h){let f="";a?a.material!==o?f="reference changed; cached instance?: "+l:a.copy.version!==o.version&&(f="version changed"):f="not cached",console.warn("Cloning material",o.name,o.version,"Reason:",f,`
`,o.uuid,`
`,a==null?void 0:a.copy.uuid,`
`,t.name)}const u=o.clone();u.version=o.version,a?(a.copy=u,a.material=o):(a={material:o,copy:u},e.push(a)),u[VO]=this,u[$O]=o,$h&&console.log("Set reflection",t.name,t.guid)}a&&a.copy&&(a.copy.onBeforeCompile=o.onBeforeCompile);const d=a==null?void 0:a.copy;d.envMap=this.texture,t.sharedMaterials[n]=d}}onUnset(t){const e=ts._rendererMaterialsCache.get(t);if(e)for(let i=0;i<e.length;i++){const n=e[i];t.sharedMaterials[i]=n.material}}},r(od,"_probes",new Map),r(od,"_rendererMaterialsCache",new Map),od);let qa=ts;Yv([p(h.Vector3)],qa.prototype,"center",2);Yv([p(h.Vector3)],qa.prototype,"size",2);const Kt=x("debuginstancing"),fu=class{constructor(){r(this,"objs",[])}setup(t,e,i,n,o,a=0){t.applySettings(e);const l=this.tryCreateOrAddInstance(e,i,o);if(l){n===null&&(n=[]),n.push(l),re.NEEDLE_progressive.assignTextureLOD(l.renderer.material,0);for(let c=0;c<t.sharedMeshes.length;c++){const d=t.sharedMeshes[c],u=d.geometry;re.NEEDLE_progressive.assignMeshLOD(d,0).then(f=>{f&&t.activeAndEnabled&&u!=f&&l.setGeometry(f)})}}else if(a<=0&&e.type!=="Mesh"){const c=a+1;for(const d of e.children)n=this.setup(t,d,i,n,o,c)}return a===0&&o.useMatrixWorldAutoUpdate&&n&&n.length>=0&&this.autoUpdateInstanceMatrix(e),n}tryCreateOrAddInstance(t,e,i){if(t.type==="Mesh"){const n=i.foundMeshes;if(i.foundMeshes+=1,!i.rend.enableInstancing)return null;if(i.rend.enableInstancing!==!0){if(n>=i.rend.enableInstancing.length)return Kt&&console.error("Something is wrong with instance setup",t,i.rend.enableInstancing,n),null;if(!i.rend.enableInstancing[n])return null}const o=t,a=o.material;for(const f of this.objs){if(!f.canAdd(o.geometry,a))continue;return f.addInstance(o)}let l=fu.getStartInstanceCount(t);(!l||l<0)&&(l=4);let c=t.name;c!=null&&c.length||(c=Ab());const d=new Kv(c,o.geometry,a,l,e);return this.objs.push(d),d.addInstance(o)}return null}autoUpdateInstanceMatrix(t){const e=t.matrixWorld.multiplyMatrices.bind(t.matrixWorld),i=t.matrixWorld.clone(),n=(o,a)=>{const l=e(o,a);return(t[Pc]||i.equals(l)===!1)&&(i.copy(l),t[Pc]=!0),l};t.matrixWorld.multiplyMatrices=n}};let Ks=fu;r(Ks,"instance",new fu),r(Ks,"getStartInstanceCount",t=>4);const yc=class{constructor(t,e){r(this,"object");r(this,"renderer");r(this,"__instanceIndex",-1);r(this,"__reservedVertexRange",0);r(this,"__reservedIndexRange",0);r(this,"__geometryIndex",-1);r(this,"meshInformation");this.__instanceIndex=-1,this.object=t,this.renderer=e,t[k0]=e,this.meshInformation=No(t.geometry),yc.all.push(this)}get name(){return this.object.name}get isActive(){return this.__instanceIndex>=0}get vertexCount(){return this.object.geometry.attributes.position.count}get maxVertexCount(){return Math.max(this.meshInformation.vertexCount,this.vertexCount)}get reservedVertexCount(){return this.__reservedVertexRange}get indexCount(){return this.object.geometry.index?this.object.geometry.index.count:0}get maxIndexCount(){return Math.max(this.meshInformation.indexCount,this.indexCount)}get reservedIndexCount(){return this.__reservedIndexRange}updateMeshInformation(){const t=No(this.object.geometry),e=this.meshInformation.vertexCount,i=this.meshInformation.indexCount;return Object.assign(this.meshInformation,t),e!==this.meshInformation.vertexCount||i!==this.meshInformation.indexCount}updateInstanceMatrix(t=!1,e=!0){this.__instanceIndex<0||(e&&this.object.updateWorldMatrix(!0,t),this.renderer.updateInstance(this.object.matrixWorld,this.__instanceIndex))}setMatrix(t){this.__instanceIndex<0||this.renderer.updateInstance(t,this.__instanceIndex)}setGeometry(t){if(this.__geometryIndex<0)return!1;const e=this;if(this.vertexCount>this.__reservedVertexRange)return i(`Instancing: Can not update geometry (${this.name}), reserved vertex range is too small: ${this.__reservedVertexRange.toLocaleString()} < ${this.vertexCount.toLocaleString()} vertices for ${this.name}`);if(this.indexCount>this.__reservedIndexRange)return i(`Instancing: Can not update geometry (${this.name}), reserved index range is too small: ${this.__reservedIndexRange.toLocaleString()} < ${this.indexCount.toLocaleString()} indices for ${this.name}`);return this.renderer.updateGeometry(t,this.__geometryIndex);function i(n){return e.updateMeshInformation()&&(e.renderer.remove(e,!0),e.renderer.add(e))?!0:((B()||Kt)&&console.error(n),!1)}}add(){this.__instanceIndex>=0||(this.renderer.add(this),S.markAsInstancedRendered(this.object,!0))}remove(t){if(!(this.__instanceIndex<0)&&(this.renderer.remove(this,t),S.markAsInstancedRendered(this.object,!1),t)){const e=yc.all.indexOf(this);e>=0&&yc.all.splice(e,1)}}};let Pa=yc;r(Pa,"all",[]);class Kv{constructor(t,e,i,n,o){r(this,"allowResize",!0);r(this,"name","");r(this,"geometry");r(this,"material");r(this,"_context");r(this,"_batchedMesh");r(this,"_handles",[]);r(this,"_geometryIds",new Map);r(this,"_maxInstanceCount");r(this,"_currentInstanceCount",0);r(this,"_currentVertexCount",0);r(this,"_currentIndexCount",0);r(this,"_maxVertexCount");r(this,"_maxIndexCount");r(this,"_needUpdateBounds",!1);r(this,"_debugMaterial",null);r(this,"onBeforeRender",()=>{this._batchedMesh.layers.enableAll(),this._needUpdateBounds&&this._batchedMesh[Fl]===!0&&(Kt==="verbose"&&console.log("Update instancing bounds",this.name,this._batchedMesh.matrixWorldNeedsUpdate),this.updateBounds())});r(this,"onAfterRender",()=>{this._batchedMesh.layers.disableAll()});this.name=t,this.geometry=e,this.material=i,this._context=o,this._maxInstanceCount=Math.max(2,n),Kt&&(this._debugMaterial=$y());const a=this.tryEstimateVertexCountSize(this._maxInstanceCount,[e],n);this._maxVertexCount=a.vertexCount,this._maxIndexCount=a.indexCount,this._batchedMesh=new h.BatchedMesh(this._maxInstanceCount,this._maxVertexCount,this._maxIndexCount,this._debugMaterial??this.material),this._batchedMesh[Fl]=!0,this._batchedMesh.visible=!0,this._context.scene.add(this._batchedMesh),i instanceof h.RawShaderMaterial&&(i.defines.USE_INSTANCING=!0,i.needsUpdate=!0),o.pre_render_callbacks.push(this.onBeforeRender),o.post_render_callbacks.push(this.onAfterRender),Kt&&console.log(`Instanced renderer created with ${this._maxInstanceCount} instances, ${this._maxVertexCount} max vertices and ${this._maxIndexCount} max indices for "${t}"`)}get batchedMesh(){return this._batchedMesh}get visible(){return this._batchedMesh.visible}set visible(t){this._batchedMesh.visible=t}get castShadow(){return this._batchedMesh.castShadow}set castShadow(t){this._batchedMesh.castShadow=t}set receiveShadow(t){this._batchedMesh.receiveShadow=t}get count(){return this._currentInstanceCount}updateBounds(t=!0,e=!0){if(this._needUpdateBounds=!1,t&&this._batchedMesh.computeBoundingBox(),e&&this._batchedMesh.computeBoundingSphere(),Kt&&this._batchedMesh.boundingSphere){const i=this._batchedMesh.boundingSphere;N.DrawWireSphere(i.center,i.radius,65280)}}canAdd(t,e){return this._maxVertexCount>1e7||e!==this.material||!this.validateGeometry(t)?!1:!!(!this.mustGrow(t)||this.allowResize)}dispose(){Kt&&console.warn("Dispose instanced renderer",this.name),this._context.scene.remove(this._batchedMesh),this._batchedMesh.dispose(),this._batchedMesh=null,this._handles=[]}addInstance(t){const e=new Pa(t,this);t.castShadow===!0&&this._batchedMesh.castShadow===!1&&(this._batchedMesh.castShadow=!0),t.receiveShadow===!0&&this._batchedMesh.receiveShadow===!1&&(this._batchedMesh.receiveShadow=!0);try{this.add(e)}catch(i){if(console.error(`Failed adding mesh to instancing (object name: "${t.name}", instances: ${this._currentInstanceCount.toLocaleString()}/${this._maxInstanceCount.toLocaleString()}, vertices: ${this._currentVertexCount.toLocaleString()}/${this._maxVertexCount.toLocaleString()}, indices: ${this._currentIndexCount.toLocaleString()}/${this._maxIndexCount.toLocaleString()})
`,i),B()){$c("Failed instancing mesh. See the browser console for details.");debugger}return null}return e}add(t){const e=t.object.geometry;if(!e||!e.attributes)return console.error("Cannot add object to instancing without geometry",t.name),!1;if(this.mustGrow(e))if(this.allowResize)this.grow(e);else return console.error("Cannot add instance, max count reached",this.name,this.count,this._maxInstanceCount),!1;return t.object.updateWorldMatrix(!0,!0),this.addGeometry(t),this._handles[t.__instanceIndex]=t,this._currentInstanceCount+=1,this.markNeedsUpdate(),this._currentInstanceCount>0&&(this._batchedMesh.visible=!0),!0}remove(t,e){t&&(t.__instanceIndex<0||this._handles[t.__instanceIndex]!=t||this._currentInstanceCount<=0||(this.removeGeometry(t,e),this._handles[t.__instanceIndex]=null,t.__instanceIndex=-1,this._currentInstanceCount>0&&(this._currentInstanceCount-=1),this._currentInstanceCount<=0&&(this._batchedMesh.visible=!1),this.markNeedsUpdate()))}updateInstance(t,e){this._batchedMesh.setMatrixAt(e,t),this.markNeedsUpdate()}updateGeometry(t,e){return this.validateGeometry(t)?(this.mustGrow()&&this.grow(t),Kt&&console.debug("[Instancing] UPDATE GEOMETRY at "+e,this._batchedMesh._geometryCount,t.name,No(t),t.attributes.position.count,t.index?t.index.count:0),this._batchedMesh.setGeometryAt(e,t),this._geometryIds.set(t,e),this.markNeedsUpdate(),!0):!1}validateGeometry(t){const e=this.geometry;for(const i in e.attributes)if(i!=="batchId"&&!t.hasAttribute(i))return B()&&console.warn(`BatchedMesh: Added geometry missing "${i}". All geometries must have consistent attributes.`),!1;return!0}markNeedsUpdate(){Kt==="verbose"&&console.warn("Marking instanced mesh dirty",this.name),this._needUpdateBounds=!0}mustGrow(t){if(this.count>=this._maxInstanceCount)return!0;if(!t||!t.attributes)return!1;const e=No(t),i=e.vertexCount,n=e.indexCount;return this._currentVertexCount+i>this._maxVertexCount||this._currentIndexCount+n>this._maxIndexCount}grow(t){var d,u;const i=Math.ceil(this._maxInstanceCount*2),n=this.tryEstimateVertexCountSize(i,[t]),o=Math.max(this._maxVertexCount,n.vertexCount),a=Math.max(this._maxIndexCount,n.indexCount,Math.ceil(this._maxVertexCount*2));if(Kt){const f=No(t);console.warn(`[Instancing] Growing Buffer
Mesh: "${this.name}${(d=t.name)!=null&&d.length?"/"+t.name:""}"
${f.vertexCount} vertices, ${f.indexCount} indices
Max count ${this._maxInstanceCount} → ${i}
Max vertex count ${this._maxVertexCount} -> ${o}
Max index count ${this._maxIndexCount} -> ${a}`),this._debugMaterial=$y()}else B()&&console.debug(`[Instancing] Growing Buffer
Mesh: "${this.name}${(u=t.name)!=null&&u.length?"/"+t.name:""}"
Max count ${this._maxInstanceCount} → ${i}
Max vertex count ${this._maxVertexCount} -> ${o}
Max index count ${this._maxIndexCount} -> ${a}`);this._maxVertexCount=o,this._maxIndexCount=a;const l=new h.BatchedMesh(i,this._maxVertexCount,this._maxIndexCount,this._debugMaterial??this.material);l.layers=this._batchedMesh.layers,l.castShadow=this._batchedMesh.castShadow,l.receiveShadow=this._batchedMesh.receiveShadow,l.visible=this._batchedMesh.visible,l[Fl]=this._batchedMesh[Fl],l.matrixAutoUpdate=this._batchedMesh.matrixAutoUpdate,l.matrixWorldNeedsUpdate=this._batchedMesh.matrixWorldNeedsUpdate,l.matrixAutoUpdate=this._batchedMesh.matrixAutoUpdate,l.matrixWorld.copy(this._batchedMesh.matrixWorld),l.matrix.copy(this._batchedMesh.matrix),this._batchedMesh.dispose(),this._batchedMesh.removeFromParent(),this._geometryIds.clear(),this._batchedMesh=l,this._maxInstanceCount=i;const c=[...this._handles];this._handles=[];for(const f of c)f&&f.__instanceIndex>=0&&(this.addGeometry(f),this._handles[f.__instanceIndex]=f);this._context.scene.add(l)}tryEstimateVertexCountSize(t,e,i=1){const n=new Map;for(const f of this._handles)if(f&&f.__instanceIndex>=0&&f.object.geometry)if(n.has(f.object.geometry)){const m=n.get(f.object.geometry);m.count+=1}else{const g={count:1,...No(f.object.geometry)};n.set(f.object.geometry,g)}let o=0,a=0;for(const[f,m]of n)o+=m.vertexCount*m.count,a+=m.indexCount*m.count;let c=Math.ceil(o/Math.max(1,this._currentInstanceCount))*t,u=Math.ceil(a/Math.max(1,this._currentInstanceCount))*t*2;if(e)for(const f of e){const m=No(f);m!=null&&(c+=m.vertexCount*i,u+=m.indexCount*i)}return{vertexCount:c,indexCount:u}}addGeometry(t){const i=t.object.geometry;if(!i)return;let n=this._geometryIds.get(i);n==null?(Kt&&console.debug(`[Instancing] > ADD NEW GEOMETRY "${t.name} (${i.name}; ${i.uuid})"
${this._currentInstanceCount} instances, ${t.maxVertexCount} max vertices, ${t.maxIndexCount} max indices`),n=this._batchedMesh.addGeometry(i,t.maxVertexCount,t.maxIndexCount),this._geometryIds.set(i,n)):Kt==="verbose"&&console.log(`[Instancing] > ADD INSTANCE "${t.name}"
GEOMETRY_ID=${n}
${this._currentInstanceCount} instances`),this._currentVertexCount+=t.maxVertexCount,this._currentIndexCount+=t.maxIndexCount;const o=this._batchedMesh.addInstance(n);t.__geometryIndex=n,t.__instanceIndex=o,t.__reservedVertexRange=t.maxVertexCount,t.__reservedIndexRange=t.maxIndexCount,this._batchedMesh.setMatrixAt(o,t.object.matrixWorld),Kt&&console.debug(`[Instancing] > ADDED INSTANCE "${t.name}"
GEOMETRY_ID=${n}
${this._currentInstanceCount} instances
Index: ${t.__instanceIndex}`)}removeGeometry(t,e){if(t.__instanceIndex<0){console.warn("Cannot remove geometry, instance index is invalid",t.name);return}Kt&&console.debug(`[Instancing] < REMOVE INSTANCE "${t.name}" at [${t.__instanceIndex}]
GEOMETRY_ID=${t.__geometryIndex}
${this._currentInstanceCount} instances
Index: ${t.__instanceIndex}`),this._batchedMesh.deleteInstance(t.__instanceIndex)}}r(Kv,"nullMatrix",new h.Matrix4);function No(s){var n,o;if(!s)return B()&&console.error("Cannot get mesh information from null geometry"),{vertexCount:0,indexCount:0};let t=((o=(n=s.attributes)==null?void 0:n.position)==null?void 0:o.count)||0,e=s.index?s.index.count:0;const i=re.NEEDLE_progressive.getMeshLODInformation(s);if(i){const a=i.lods[0];let l=a.vertexCount,c=a.indexCount;const d=Math.min(200,Math.ceil(l*.05));l+=d,c+=20,t=Math.max(t,l),e=Math.max(e,c)}return t=Math.ceil(t),e=Math.ceil(e),{vertexCount:t,indexCount:e}}function $y(){const s=new h.MeshStandardMaterial({color:new h.Color(Math.random(),Math.random(),Math.random())});return s.emissive=s.color,s.emissiveIntensity=.3,x("wireframe")&&(s.wireframe=!0),s}const Gr=x("debuglightmaps");class tu{constructor(t,e){r(this,"lightmapIndex",-1);r(this,"lightmapScaleOffset",new h.Vector4(1,1,0,0));r(this,"context");r(this,"gameObject");r(this,"lightmapTexture",null);r(this,"lightmapScaleOffsetUniform",{value:new h.Vector4(1,1,0,0)});r(this,"lightmapUniform",{value:null});r(this,"onBeforeCompile",(t,e)=>{Gr&&console.log(`Lightmaps, before compile
`,t),this.lightmapScaleOffsetUniform.value=this.lightmapScaleOffset,this.lightmapUniform.value=this.lightmapTexture,t.uniforms.lightmapScaleOffset=this.lightmapScaleOffsetUniform});this.gameObject=t,this.context=e}get lightmap(){return this.lightmapTexture}set lightmap(t){t!==this.lightmapTexture&&(this.lightmapTexture=t,this.applyLightmap(),this.lightmapTexture&&re.NEEDLE_progressive.assignTextureLOD(this.lightmapTexture,0).then(e=>{e!=null&&e.isTexture&&(this.lightmapTexture=e)}))}init(t,e,i){console.assert(this.gameObject!==void 0&&this.gameObject!==null,"Missing gameobject",this),this.lightmapIndex=t,!(this.lightmapIndex<0)&&(this.lightmapScaleOffset=e,this.lightmapTexture=i,re.NEEDLE_progressive.assignTextureLOD(i,0).then(n=>{n!=null&&n.isTexture&&(this.lightmapTexture=n)}),Gr=="show"?(console.log("Lightmap:",this.gameObject.name,t,`
ScaleOffset:`,e,`
Texture:`,i),this.setLightmapDebugMaterial()):Gr&&console.log("Use debuglightmaps=show to render lightmaps only in the scene."),this.applyLightmap())}updateLightmapUniforms(t){const e=t.uniforms;e&&e.lightmap&&(this.lightmapScaleOffsetUniform.value=this.lightmapScaleOffset,e.lightmapScaleOffset=this.lightmapScaleOffsetUniform)}applyLightmap(){if(this.gameObject.type==="Object3D"){Gr&&console.warn("Can not add lightmap. Is this object missing a renderer?",this.gameObject.name);return}if(this.gameObject.type==="Group"){this.gameObject["Needle:Multimaterial-LightmapWarning"]===void 0&&(this.gameObject["Needle:Multimaterial-LightmapWarning"]=!0,console.warn("Lightmap on multimaterial object is not supported yet... please open a feature request on https://github.com/needle-tools/needle-engine-support if your project requires it"));return}console.assert(this.gameObject.type==="Mesh","Lightmap only works on meshes",this);const t=this.gameObject;if(t.geometry.getAttribute("uv1")||t.geometry.setAttribute("uv1",t.geometry.getAttribute("uv")),Array.isArray(this.gameObject.material)){const e=this.gameObject.material;for(let i=0;i<e.length;i++)e[i]=this.ensureLightmapMaterial(e[i])}else this.gameObject.material=this.ensureLightmapMaterial(this.gameObject.material);if(this.lightmapIndex>=0&&this.lightmapTexture){this.lightmapTexture.channel=1;const e=this.gameObject.material;if(Array.isArray(e))for(const i of e)this.assignLightmapTexture(i);else e&&this.assignLightmapTexture(e)}}ensureLightmapMaterial(t){return t.userData||(t.userData={}),t["NEEDLE:lightmap-material-version"]!=t.version&&t["NEEDLE:lightmap-material-version"]==null&&(Gr&&console.warn("Cloning material for lightmap "+t.name),t=t.clone(),t.onBeforeCompile=this.onBeforeCompile),t}assignLightmapTexture(t){!t||t instanceof h.MeshPhysicalMaterial&&t.transmission>0||!(t.lightMap!==this.lightmapTexture||t["NEEDLE:lightmap-material-version"]!==t.version)||(Gr&&console.log("Assigning lightmap",t.name,t.version),t.lightMap=this.lightmapTexture,t["NEEDLE:lightmap-material-version"]=t.version)}setLightmapDebugMaterial(){this.gameObject.material=new h.ShaderMaterial({vertexShader:`
                varying vec2 vUv1;
                void main()
                {
                    vUv1 = uv1;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
                }
                `,fragmentShader:`
                uniform sampler2D lightMap;
                uniform float lightMapIntensity;
                uniform vec4 lightmapScaleOffset;
                varying vec2 vUv1;

                // took from threejs 05fc79cd52b79e8c3e8dec1e7dca72c5c39983a4
                vec4 conv_sRGBToLinear( in vec4 value ) {
                    return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );
                }

                void main() {
                    vec2 lUv = vUv1.xy * lightmapScaleOffset.xy + vec2(lightmapScaleOffset.z, (1. - (lightmapScaleOffset.y + lightmapScaleOffset.w)));
                    
                    vec4 lightMapTexel = texture2D( lightMap, lUv);
                    gl_FragColor = lightMapTexel;
                    gl_FragColor.a = 1.;
                }
                `,defines:{USE_LIGHTMAP:""}})}}var WO=Object.defineProperty,GO=Object.getOwnPropertyDescriptor,Ss=(s,t,e,i)=>{for(var n=i>1?void 0:i?GO(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&WO(t,e,n),n};const $l=x("debugrenderer"),Wy=x("debugskinnedmesh"),Gy=x("noinstancing"),HO=x("wireframe");class Zv{constructor(){r(this,"path",null);r(this,"asset",null);r(this,"default")}}class qO{constructor(t,e){r(this,"_renderer");r(this,"_targets",[]);r(this,"_indexMapMaxIndex");r(this,"_indexMap");r(this,"_changed",!1);this._renderer=t;const i=this.setMaterial.bind(this),n=this.getMaterial.bind(this),o=t.gameObject;if(this._targets=[],o)switch(o.type){case"Group":this._targets=[...o.children];break;case"SkinnedMesh":case"Mesh":this._targets.push(o);break}let a=!1,l,c=0;for(let d=0;d<this._targets.length;d++){const u=this._targets[d];if(!u)continue;const f=u.material;if(f){f.shadowSide=f.side;for(let m=0;m<e.length;m++){const g=e[m];if(!g){a=!0;continue}if(f.name===g.name){l===void 0&&(l=new Map),l.set(m,d),c=Math.max(c,m);break}}}}if(a){this._indexMapMaxIndex=c,this._indexMap=l;const d=`Renderer ${t.name} was initialized with missing materials - this may lead to unexpected behaviour when trying to access sharedMaterials by index.`;console.warn(d),Ht()&&pe("Found renderer with missing materials: please check the console for details.")}return new Proxy(this,{get(d,u){if(typeof u=="string"){const f=parseInt(u);if(!isNaN(f))return n(f)}return d[u]},set(d,u,f){return typeof u=="string"&&i(f,Number.parseInt(u)),Reflect.set(d,u,f)?(f instanceof h.Material&&(d.changed=!0),!0):!1}})}get changed(){return this._changed}set changed(t){t===!0&&$l&&console.warn("SharedMaterials have changed: "+this._renderer.name,this),this._changed=t}is(t){return this._renderer===t}get length(){return this._indexMapMaxIndex!==void 0?this._indexMapMaxIndex+1:this._targets.length}*[Symbol.iterator](){for(let t=0;t<this.length;t++)yield this.getMaterial(t)}resolveIndex(t){const e=this._indexMap;return e&&e.has(t)?e.get(t):t}setMaterial(t,e){if(e=this.resolveIndex(e),e<0||e>=this._targets.length)return;const i=this._targets[e];!i||i.material===void 0||(i.material=t,this.changed=!0)}getMaterial(t){if(t=this.resolveIndex(t),t<0)return null;const e=this._targets;if(t>=e.length)return null;const i=e[t];return i?i.material:null}}const Sd=class extends D{constructor(){super(...arguments);r(this,"receiveShadows",!1);r(this,"shadowCastingMode",0);r(this,"lightmapIndex",-1);r(this,"lightmapScaleOffset",new h.Vector4(1,1,0,0));r(this,"enableInstancing");r(this,"renderOrder");r(this,"allowOcclusionWhenDynamic",!0);r(this,"probeAnchor");r(this,"reflectionProbeUsage",0);r(this,"_lightmaps");r(this,"_sharedMeshes",[]);r(this,"_sharedMaterials");r(this,"_originalMaterials");r(this,"_probeAnchorLastFrame");r(this,"_lightmapTextureOverride");r(this,"allowProgressiveLoading",!0);r(this,"_firstFrame",-1);r(this,"_isInstancingEnabled",!1);r(this,"_handles");r(this,"_handlesTempArray",[]);r(this,"onBeforeRenderThree",(t,e,i,n,o,a)=>{var l;if(o.envMapIntensity!==void 0){const c=this.hasLightmap?Math.PI:1,d=((l=this.context.mainCameraComponent)==null?void 0:l.environmentIntensity)??1;o.envMapIntensity=Math.max(0,d*this.context.sceneLighting.environmentIntensity/c),o.envMap||(o.envMap=this.context.scene.environment)}if(this._lightmaps)for(const c of this._lightmaps)c.updateLightmapUniforms(o),c.applyLightmap()});r(this,"_reflectionProbe",null)}static setInstanced(t,e){const i=qc(t,Sd);return i.setInstancingEnabled(e),i}static isInstanced(t){const e=gr(t,Sd);return e?e.isInstancingActive:Vi.isUsingInstancing(t)}static setVisible(t,e){cs(t,e)}get sharedMesh(){if(this.gameObject.type==="Mesh")return this.gameObject;if(this.gameObject.type==="SkinnesMesh")return this.gameObject;if(this.gameObject.type==="Group")return this.gameObject.children[0]}get sharedMeshes(){if(this.destroyed||!this.gameObject)return this._sharedMeshes;if(this._sharedMeshes.length=0,this.gameObject.type==="Group")for(const t of this.gameObject.children)(t.type==="Mesh"||t.type==="SkinnedMesh")&&this._sharedMeshes.push(t);else(this.gameObject.type==="Mesh"||this.gameObject.type==="SkinnedMesh")&&this._sharedMeshes.push(this.gameObject);return this._sharedMeshes}get sharedMaterial(){return this.sharedMaterials[0]}set sharedMaterial(t){this.sharedMaterials[0]!==t&&(this.sharedMaterials[0]=t,this.applyLightmapping())}get material(){return this.sharedMaterials[0]}set material(t){this.sharedMaterial=t}set sharedMaterials(t){if(!this._originalMaterials)this._originalMaterials=t;else if(t){let e=!1;for(let i=0;i<this._sharedMaterials.length;i++){const n=i<t.length?t[i]:null;n&&n instanceof h.Material?this.sharedMaterials[i]=n:e||(e=!0,console.warn("Can not assign null as material: "+this.name,n))}}}get sharedMaterials(){return(!this._sharedMaterials||!this._sharedMaterials.is(this))&&(this._originalMaterials||(this._originalMaterials=[]),this._sharedMaterials=new qO(this,this._originalMaterials)),this._sharedMaterials}static get shouldSuppressInstancing(){return Gy}get lightmap(){var t;return(t=this._lightmaps)!=null&&t.length?this._lightmaps[0].lightmap:null}set lightmap(t){var e;if(this._lightmapTextureOverride=t,t===void 0&&(t=this.context.lightmaps.tryGetLightmap(this.sourceId,this.lightmapIndex)),(e=this._lightmaps)!=null&&e.length)for(const i of this._lightmaps)i.lightmap=t}get hasLightmap(){const t=this.lightmap;return t!=null}registering(){this.enabled||this.setVisibility(!1)}awake(){if(this._firstFrame=this.context.time.frame,$l&&console.log("Renderer ",this.name,this),this.clearInstancingState(),this.probeAnchor&&$l&&this.probeAnchor.add(new h.AxesHelper(.2)),this._reflectionProbe=null,this.isMultiMaterialObject(this.gameObject)){for(const t of this.gameObject.children)this.context.addBeforeRenderListener(t,this.onBeforeRenderThree),t.layers.mask=this.gameObject.layers.mask;if(this.renderOrder!==void 0){let t=0;for(let e=0;e<this.gameObject.children.length;e++){const i=this.gameObject.children[e];if(!(!this.isMeshOrSkinnedMesh(i)||S.getComponent(i,Sd))){if(this.renderOrder.length<=t){console.warn("Incorrect renderOrder element count",this,this.renderOrder.length+" but expected "+this.gameObject.children.length,"Index: "+t,"ChildElement:",i);continue}i.renderOrder=this.renderOrder[t],t+=1}}}}else this.isMeshOrSkinnedMesh(this.gameObject)?(this.context.addBeforeRenderListener(this.gameObject,this.onBeforeRenderThree),this.renderOrder!==void 0&&this.renderOrder.length>0&&(this.gameObject.renderOrder=this.renderOrder[0])):this.context.addBeforeRenderListener(this.gameObject,this.onBeforeRenderThree);if(this.applyLightmapping(),HO)for(let t=0;t<this.sharedMaterials.length;t++){const e=this.sharedMaterials[t];e&&(e.wireframe=!0)}}applyLightmapping(){var t;if(this.lightmapIndex>=0){const e=this.gameObject.type,i=this._lightmapTextureOverride!==void 0?this._lightmapTextureOverride:this.context.lightmaps.tryGetLightmap(this.sourceId,this.lightmapIndex);if(i){if(this._lightmaps||(this._lightmaps=[]),e==="Mesh"){const n=this.gameObject.material;if(n!=null&&n.isMeshBasicMaterial)n&&console.warn("Lightmapping is not supported on MeshBasicMaterial",n.name);else{if(this._lightmaps.length<=0){const a=new tu(this.gameObject,this.context);this._lightmaps.push(a)}this._lightmaps[0].init(this.lightmapIndex,this.lightmapScaleOffset,i)}}else if(this.isMultiMaterialObject(this.gameObject)&&this.sharedMaterials.length>0)for(let n=0;n<this.gameObject.children.length;n++){const o=this.gameObject.children[n];if(!((t=o.material)!=null&&t.isMeshBasicMaterial)){let a;n>=this._lightmaps.length?(a=new tu(o,this.context),this._lightmaps.push(a)):a=this._lightmaps[n],a.init(this.lightmapIndex,this.lightmapScaleOffset,i)}}}else $l&&console.warn("Lightmap not found",this.sourceId,this.lightmapIndex)}}get isInstancingActive(){return this._handles!=null&&this._handles.length>0&&this._isInstancingEnabled}get instances(){if(!this._handles||this._handles.length<=0)return null;if(this._handlesTempArray.length=0,this._handles)for(const t of this._handles)this._handlesTempArray.push(t);return this._handlesTempArray}setInstancingEnabled(t){if(this._isInstancingEnabled===t)return t&&(this._handles===void 0||this._handles!=null&&this._handles.length>0);if(this._isInstancingEnabled=t,t){if(this.enableInstancing===void 0&&(this.enableInstancing=!0),this._handles===void 0){if(this._handles=Ks.instance.setup(this,this.gameObject,this.context,null,{rend:this,foundMeshes:0,useMatrixWorldAutoUpdate:this.useInstanceMatrixWorldAutoUpdate()}),this._handles)return S.markAsInstancedRendered(this.gameObject,!0),!0}else if(this._handles!==null){for(const e of this._handles)e.updateInstanceMatrix(!0),e.add();return S.markAsInstancedRendered(this.gameObject,!0),!0}}else{if(this._handles)for(const e of this._handles)e.remove(this.destroyed);return!0}return!1}clearInstancingState(){this._isInstancingEnabled=!1,this._handles=void 0}useInstanceMatrixWorldAutoUpdate(){return!0}start(){if(this.enableInstancing&&!Gy&&(this.setInstancingEnabled(!0),Vi.markDirty(this.gameObject)),this.gameObject.frustumCulled=this.allowOcclusionWhenDynamic,this.isMultiMaterialObject(this.gameObject))for(let t=0;t<this.gameObject.children.length;t++){const e=this.gameObject.children[t];e.frustumCulled=this.allowOcclusionWhenDynamic}}onEnable(){this.sharedMeshes,this.setVisibility(!0),this._isInstancingEnabled||this.enableInstancing==!0||Array.isArray(this.enableInstancing)&&this.enableInstancing.some(e=>e)?this.__internalDidAwakeAndStart&&this.setInstancingEnabled(!0):this.enabled&&this.applyStencil(),this.updateReflectionProbe()}onDisable(){this.setVisibility(!1),this._handles&&this._handles.length>0&&this.setInstancingEnabled(!1)}onDestroy(){if(this._handles=null,this.isMultiMaterialObject(this.gameObject))for(const t of this.gameObject.children)this.context.removeBeforeRenderListener(t,this.onBeforeRenderThree);else this.context.removeBeforeRenderListener(this.gameObject,this.onBeforeRenderThree)}onBeforeRender(){var t,e,i;if(this.gameObject){if(this._probeAnchorLastFrame!==this.probeAnchor&&((t=this._reflectionProbe)==null||t.onUnset(this),this.updateReflectionProbe()),$l==this.name&&this.gameObject instanceof h.Mesh){this.gameObject.geometry.computeBoundingSphere();const n=$(this.gameObject.geometry.boundingSphere.center).applyMatrix4(this.gameObject.matrixWorld);N.DrawWireSphere(n,this.gameObject.geometry.boundingSphere.radius,56831)}if(this.isMultiMaterialObject(this.gameObject)&&((e=this.gameObject.children)==null?void 0:e.length)>0)for(const n of this.gameObject.children)this.applySettings(n);else this.applySettings(this.gameObject);if(this.sharedMaterials.changed&&(this.sharedMaterials.changed=!1,this.applyLightmapping()),(i=this._handles)!=null&&i.length&&this.gameObject[Pc]===!0){this.gameObject[Pc]=!1;for(let o=this._handles.length-1;o>=0;o--)this._handles[o].updateInstanceMatrix();this.gameObject.matrixWorldNeedsUpdate=!1}if(this._handles&&this._handles.length<=0&&S.markAsInstancedRendered(this.gameObject,!1),this._isInstancingEnabled&&this._handles)for(let n=0;n<this._handles.length;n++){const o=this._handles[n];cs(o.object,!1)}this.reflectionProbeUsage!==0&&this._reflectionProbe&&this._reflectionProbe.onSet(this)}}onAfterRender(){if(this._isInstancingEnabled&&this._handles)for(let t=0;t<this._handles.length;t++){const e=this._handles[t];cs(e.object,!0)}this.reflectionProbeUsage!==0&&this._reflectionProbe&&this._reflectionProbe.onUnset(this),this.static&&this.gameObject.matrixAutoUpdate&&(this.gameObject.matrixAutoUpdate=!1)}applyStencil(){lc.applyStencil(this)}applySettings(t){t.receiveShadow=this.receiveShadows,this.shadowCastingMode==1?t.castShadow=!0:t.castShadow=!1}updateReflectionProbe(){this._reflectionProbe=null,this.reflectionProbeUsage!==0&&(this.startCoroutine(this._updateReflectionProbe(),ve.LateUpdate),this._probeAnchorLastFrame=this.probeAnchor)}*_updateReflectionProbe(){const t=this.probeAnchor||this.gameObject,e=!!this.probeAnchor;this._reflectionProbe=qa.get(t,this.context,e,this.probeAnchor)}setVisibility(t){if(!this.isMultiMaterialObject(this.gameObject))cs(this.gameObject,t);else for(const e of this.gameObject.children)this.isMeshOrSkinnedMesh(e)&&cs(e,t)}isMultiMaterialObject(t){return t.type==="Group"}isMeshOrSkinnedMesh(t){return t.type==="Mesh"||t.type==="SkinnedMesh"}};let ze=Sd;Ss([p()],ze.prototype,"receiveShadows",2);Ss([p()],ze.prototype,"shadowCastingMode",2);Ss([p()],ze.prototype,"lightmapIndex",2);Ss([p(h.Vector4)],ze.prototype,"lightmapScaleOffset",2);Ss([p()],ze.prototype,"enableInstancing",2);Ss([p()],ze.prototype,"renderOrder",2);Ss([p()],ze.prototype,"allowOcclusionWhenDynamic",2);Ss([p(h.Object3D)],ze.prototype,"probeAnchor",2);Ss([p()],ze.prototype,"reflectionProbeUsage",2);class oh extends ze{}class kg extends oh{constructor(){super(...arguments);r(this,"_needUpdateBoundingSphere",!1)}awake(){var e;super.awake(),Wy&&console.log('SkinnedMeshRenderer for "'+this.name+'"',this),this.allowOcclusionWhenDynamic=!1;for(const i of this.sharedMeshes)(e=i.parent)==null||e.updateWorldMatrix(!1,!0),this.markBoundsDirty()}onAfterRender(){if(super.onAfterRender(),this._needUpdateBoundingSphere){for(const e of this.sharedMeshes)if(e instanceof h.SkinnedMesh){this._needUpdateBoundingSphere=!1;try{const i=e.geometry,n=re.getRaycastMesh(e);n&&(e.geometry=n),e.computeBoundingSphere(),e.geometry=i}catch(i){console.error(`Error updating bounding sphere for ${e.name}`,i)}}}if(Wy){for(const e of this.sharedMeshes)if(e instanceof h.SkinnedMesh&&e.boundingSphere){const i=$(e.boundingSphere.center).applyMatrix4(e.matrixWorld);N.DrawWireSphere(i,e.boundingSphere.radius,"red")}}}markBoundsDirty(){this._needUpdateBoundingSphere=!0}}var XO=Object.defineProperty,QO=Object.getOwnPropertyDescriptor,Jv=(s,t,e,i)=>{for(var n=i>1?void 0:i?QO(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&XO(t,e,n),n};const Wh=x("debuggltfexport");class Eg extends ti{constructor(){super(...arguments);r(this,"sceneRoot")}}const ra=class extends D{constructor(){super(...arguments);r(this,"binary",!0);r(this,"objects",[]);r(this,"ext")}async exportNow(t,e){Wh&&console.log("Exporting objects as glTF",this.objects),t||(t="scene"),(!this.objects||this.objects.length<=0)&&(this.objects=[this.context.scene]);const i={binary:this.binary,pivot:ra.calculateCenter(this.objects),...e},n=await this.export(this.objects,i).catch(o=>(console.error(o),!1));return n===!1?!1:(this.binary?t.endsWith(".glb")||(t+=".glb"):t.endsWith(".gltf")||(t+=".gltf"),this.binary?ra.saveArrayBuffer(n,t):ra.saveJson(n,t),!0)}async export(t,e){if(!t||t.length<=0){console.warn("No objects set to export");return}const i=new Y.GLTFExporter;i.register(d=>new Qv(d)),i.register(d=>new Gv(d)),Mg(i,this.context),ra.filterTopmostParent(t);const n={trs:!1,onlyVisible:!0,truncateDrawRange:!1,binary:!0,maxTextureSize:1/0,embedImages:!0,includeCustomExtensions:!0,animations:(e==null?void 0:e.animations)||ra.collectAnimations(t),...e},o=new Array,a=new h.Object3D;e!=null&&e.pivot&&a.position.sub(e.pivot),Wh&&console.log("EXPORT",t),t.forEach(d=>{d&&rm(d)&&(a.children.push(d),d.matrixAutoUpdate=!1,d.matrix.copy(d.matrixWorld),S.getComponentsInChildren(d,ze).forEach(u=>{S.isActiveInHierarchy(u.gameObject)&&u.setInstancingEnabled(!1)}),d.traverse(u=>{if(!rm(u)){const f=u.parent;u.removeFromParent(),o.push(()=>{f&&f.add(u)})}}))});const l=new ng(a);return e!=null&&e.needleComponents&&(this.ext=new Hv),this.ext&&(this.ext.registerExport(i),this.ext.context=l),new Promise((d,u)=>{Wh&&console.log("Starting glTF export.");try{i==null||i.parse(a,f=>{c(),d(f)},f=>{c(),u(f)},n)}catch(f){console.error(f),u(f)}finally{o.forEach(f=>f()),Wh&&console.log("Finished glTF export.")}});function c(){t.forEach(d=>{d&&(d.matrixAutoUpdate=!0,S.getComponentsInChildren(d,ze).forEach(u=>{S.isActiveInHierarchy(u.gameObject)&&u.setInstancingEnabled(!1)}))})}}static saveArrayBuffer(t,e){this.save(new Blob([t],{type:"application/octet-stream"}),e)}static saveJson(t,e){this.save("data: text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(t)),e)}static save(t,e){const i=document.createElement("a");i.style.display="none",document.body.appendChild(i),typeof t=="string"?i.href=t:i.href=URL.createObjectURL(t),i.download=e,i.click(),i.remove()}static collectAnimations(t,e){e=e||[];for(const i of t)i&&i.traverseVisible(n=>{n.animations&&n.animations.length>0&&e.push(...n.animations)});return e}static calculateCenter(t,e){const i=e||new h.Vector3;return i.set(0,0,0),t.forEach(n=>{i.add(Z(n))}),i.divideScalar(t.length),i}static filterTopmostParent(t){if(!(t.length<=0))for(let e=0;e<t.length;e++){let i=t[e];if(!i){t.splice(e,1),e--;continue}for(;i.parent;){if(t.includes(i.parent)){t.splice(e,1),e--;break}i=i.parent}}}};let rh=ra;Jv([p()],rh.prototype,"binary",2);Jv([p(h.Object3D)],rh.prototype,"objects",2);typeof globalThis!==void 0&&!("OffscreenCanvas"in globalThis)&&(globalThis.OffscreenCanvas=class{constructor(t,e){r(this,"canvas");return this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=e,this.canvas.convertToBlob=(i,n)=>new Promise(o=>{this.canvas.toBlob(o,i,n)}),this.canvas}});const YO=x("debugprogress");function ew(s){s=s||new Date;const t=s.getMonth()+1,e=s.getDate(),i=s.getHours(),n=s.getMinutes(),o=s.getSeconds(),a=(t<10?"0":"")+t,l=(e<10?"0":"")+e,c=(i<10?"0":"")+i,d=(n<10?"0":"")+n,u=(o<10?"0":"")+o;return s.getFullYear()+a+l+"-"+c+d+u}class se{static start(t,e){typeof e=="string"&&(e={parentScope:e});const i=new KO(t,e);Wl.set(t,i)}static report(t,e){const i=Wl.get(t);if(!i){console.warn("Reporting progress for non-existing scope",t);return}typeof e=="string"&&(e={message:e,autoStep:!0}),i.report(e)}static end(t){const e=Wl.get(t);e&&(e.end(),Wl.delete(t))}}const Wl=new Map;class KO{constructor(t,e){r(this,"scopeLabel");r(this,"parentScope");r(this,"childScopes",[]);r(this,"parentDepth",0);r(this,"lastStep",0);r(this,"lastAutoStepWeight",1);r(this,"lastTotalSteps",0);r(this,"onProgress");r(this,"showLogs",!1);r(this,"selfProgress",0);r(this,"totalProgress",0);r(this,"selfReports",0);r(this,"totalReports",0);this.parentScope=e!=null&&e.parentScope?Wl.get(e.parentScope):void 0,this.parentScope&&(this.parentScope.childScopes.push(this),this.parentDepth=this.parentScope.parentDepth+1),this.scopeLabel=" ".repeat(this.parentDepth*2)+t,this.showLogs=(e==null?void 0:e.logTimings)??!!YO,this.showLogs&&console.time(this.scopeLabel),this.onProgress=e==null?void 0:e.onProgress}report(t,e=!1){if(t){if(t.totalSteps!==void 0&&(this.lastTotalSteps=t.totalSteps),t.currentStep!==void 0&&(this.lastStep=t.currentStep),t.autoStep!==void 0){if(t.currentStep===void 0){this.lastStep===void 0&&(this.lastStep=0);const n=typeof t.autoStep=="number"?t.autoStep:1;this.lastStep+=this.lastAutoStepWeight,this.lastAutoStepWeight=n,t.currentStep=this.lastStep}t.totalSteps=this.lastTotalSteps}t.progress!==void 0?this.selfProgress=t.progress:t.currentStep!==void 0&&t.totalSteps!==void 0&&(this.selfProgress=t.currentStep/t.totalSteps)}if(this.childScopes.length>0){let n=0,o=0;for(const l of this.childScopes)n+=l.selfProgress,o+=1;o>0&&(n/=o);const a=this.lastAutoStepWeight/(this.lastTotalSteps??1);this.totalProgress=this.selfProgress+n*a}else this.totalProgress=this.selfProgress;this.selfProgress=Math.min(1,this.selfProgress),this.totalProgress=Math.min(1,this.totalProgress);let i=(this.totalProgress*100).toFixed(3)+"%";this.childScopes.length>0&&(i+=" ("+(this.selfProgress*100).toFixed(3)+"% self)"),t!=null&&t.message&&(i=t.message+" – "+i),this.lastStep!==void 0&&this.lastTotalSteps!==void 0&&(i="Step "+(this.lastStep+(this.lastAutoStepWeight!=1?"–"+(this.lastStep+this.lastAutoStepWeight):"")+"/"+this.lastTotalSteps)+" "+i),e?this.totalReports++:(this.selfReports++,this.totalReports++),this.showLogs&&console.timeLog(this.scopeLabel,i),this.onProgress&&this.onProgress(this.totalProgress),this.parentScope&&this.parentScope.report(void 0,!0)}end(){this.report({progress:1,autoStep:!0},!0),this.showLogs&&(console.timeLog(this.scopeLabel,"Total reports: "+this.totalReports,"Self reports: "+this.selfReports),console.timeEnd(this.scopeLabel));let t=!1;for(const e of this.childScopes)if(!(e.selfProgress>=1)){t=!0;break}t&&console.warn("Progress end with child scopes that are still running",this),this.onProgress=void 0}}function fn(s){return s=s.replace(/[^a-zA-Z0-9_]/g,""),s.match(/^[a-zA-Z_]/)||(s="_"+s),s}function tw(s){return s=s.replace('"','\\"'),s}function iw(s){if(s.length===0)return null;const t=s.map(i=>{const n=new Array;for(;i.parent;)n.unshift(i.parent),i=i.parent;return n});return t[0].findLast(i=>t.every(n=>n.includes(i)))||null}function nw(s){const t=iw(s),e=new Set;for(const i of s){let n=i.parent;for(;n&&n!==t;)s.includes(n)||e.add(n),n=n.parent}return e}const ZO=new h.Vector3,JO=new h.Quaternion,eM=new h.Vector3(1,1,1),Wo=class{constructor(t,e,i=null,n=null,o=null,a=null,l=null,c=null){r(this,"uuid");r(this,"name");r(this,"type");r(this,"extraSchemas",[]);r(this,"displayName");r(this,"visibility");r(this,"transform",null);r(this,"_isDynamic");r(this,"geometry");r(this,"material");r(this,"camera");r(this,"parent");r(this,"skinnedMesh");r(this,"children",[]);r(this,"animations");r(this,"_eventListeners");r(this,"needsTranslate",!1);r(this,"needsOrient",!1);r(this,"needsScale",!1);var d,u,f;this.uuid=t,this.name=fn(e),this.displayName=e,i?this.transform={position:((d=i.position)==null?void 0:d.clone())||null,quaternion:((u=i.quaternion)==null?void 0:u.clone())||null,scale:((f=i.scale)==null?void 0:f.clone())||null}:this.transform=null,this.geometry=n,this.material=o,this.camera=a,this.parent=null,this.children=[],this._eventListeners={},this._isDynamic=!1,this.skinnedMesh=l,this.animations=c}getMatrix(){if(!this.transform)return new h.Matrix4;const{position:t,quaternion:e,scale:i}=this.transform,n=new h.Matrix4;return n.compose(t||ZO,e||JO,i||eM),n}setMatrix(t){if(!t||!(t instanceof h.Matrix4)){this.transform=null;return}const e=new h.Vector3,i=new h.Quaternion,n=new h.Vector3;t.decompose(e,i,n),this.transform={position:e,quaternion:i,scale:n}}get matrix(){return this.getMatrix()}set matrix(t){this.setMatrix(t)}get isDynamic(){return this._isDynamic}set isDynamic(t){this._isDynamic=t}static createEmptyParent(t){const e=new Wo(h.MathUtils.generateUUID(),t.name+"_empty_"+Wo.USDObject_export_id++,t.transform),i=t.parent;return i&&i.add(e),e.add(t),e.isDynamic=!0,t.transform=null,e}static createEmpty(){const t=new Wo(h.MathUtils.generateUUID(),"Empty_"+Wo.USDObject_export_id++);return t.isDynamic=!0,t}is(t){return t?this.uuid===t.uuid:!1}isEmpty(){return!this.geometry}clone(){const t=new Wo(h.MathUtils.generateUUID(),this.name,this.transform,this.geometry,this.material);return t.isDynamic=this.isDynamic,t}deepClone(){const t=this.clone();for(const e of this.children)e&&t.add(e.deepClone());return t}getPath(){let t=this.parent,e=this.name;for(;t;)e=(t.parent?t.name:t.name+"/Scenes/Scene")+"/"+e,t=t.parent;return"</"+e+">"}add(t){t.parent&&t.parent.remove(t),t.parent=this,this.children.push(t)}remove(t){const e=this.children.indexOf(t);e>=0&&(t.parent===this&&(t.parent=null),this.children.splice(e,1))}addEventListener(t,e){this._eventListeners[t]||(this._eventListeners[t]=[]),this._eventListeners[t].push(e)}removeEventListener(t,e){if(!this._eventListeners[t])return;const i=this._eventListeners[t].indexOf(e);i>=0&&this._eventListeners[t].splice(i,1)}onSerialize(t,e){const i=this._eventListeners.serialize;i&&i.forEach(n=>n(t,e))}};let bt=Wo;r(bt,"USDObject_export_id",0);class Tg extends bt{constructor(){super(void 0,"StageRoot",null,null,null,null);r(this,"stageLength");this.children=[],this.stageLength=200}get isDocumentRoot(){return!0}get isDynamic(){return!1}add(e){e.parent=this,this.children.push(e)}remove(e){const i=this.children.indexOf(e);i>=0&&(e.parent===this&&(e.parent=null),this.children.splice(i,1))}traverse(e,i=null){if(i!==null?e(i):i=this,i.children)for(const n of i.children)this.traverse(e,n)}findById(e){let i=!1;function n(o){if(!i){if(o.uuid===e)return i=!0,o;if(o.children)for(const a of o.children){if(!a)continue;const l=n(a);if(l)return l}}}return n(this)}buildHeader(e){var f,m,g;const i=(f=e.extensions)==null?void 0:f.find(_=>(_==null?void 0:_.extensionName)==="animation"),n=(m=e.extensions)==null?void 0:m.find(_=>(_==null?void 0:_.extensionName)==="Behaviour"),o=(g=e.extensions)==null?void 0:g.find(_=>(_==null?void 0:_.extensionName)==="Physics"),a=(i==null?void 0:i.getStartTimeCode())??0,l=(i==null?void 0:i.getEndTimeCode())??0;let c="";const d=i==null?void 0:i.registeredClips;if(d)for(const _ of d)c+=`	# Animation: ${_.name}, start=${i.getStartTimeByClip(_)*60}, length=${_.duration*60}
`;const u=c;return`#usda 1.0
(
	customLayerData = {
		string creator = "Needle Engine ${ln}"
		dictionary Needle = {
			bool animations = ${i?1:0}
			bool interactive = ${n?1:0}
			bool physics = ${o?1:0}
			bool quickLookCompatible = ${e.quickLookCompatible?1:0}
		}
	}
	defaultPrim = "${fn(this.name)}"
	metersPerUnit = 1
	upAxis = "Y"
	startTimeCode = ${a}
	endTimeCode = ${l}
	timeCodesPerSecond = 60
	framesPerSecond = 60
	doc = """Generated by Needle Engine USDZ Exporter ${ln}"""
${u}
)
`}}const Hr=`
`,jt="</StageRoot/Materials";class sw{constructor(){r(this,"str");r(this,"indent");this.str="",this.indent=0}clear(){this.str="",this.indent=0}beginBlock(t=void 0,e="{",i=!0){t!==void 0?(t=this.applyIndent(t),this.str+=t,i?(this.str+=Hr,this.str+=this.applyIndent(e)):this.str+=" "+e):this.str+=this.applyIndent(e),this.str+=Hr,this.indent+=1}closeBlock(t="}"){this.indent-=1,this.str+=this.applyIndent(t)+Hr}beginArray(t){t=this.applyIndent(t+" = ["),this.str+=t,this.str+=Hr,this.indent+=1}closeArray(){this.indent-=1,this.str+=this.applyIndent("]")+Hr}appendLine(t=""){t=this.applyIndent(t),this.str+=t,this.str+=Hr}toString(){return this.str}applyIndent(t){let e="";for(let i=0;i<this.indent;i++)e+="	";return e+t}}class tM{constructor(t,e,i){r(this,"root");r(this,"exporter");r(this,"extensions",[]);r(this,"quickLookCompatible");r(this,"exportInvisible");r(this,"materials");r(this,"textures");r(this,"files");r(this,"document");r(this,"output");r(this,"animations");this.root=t,this.exporter=e,this.quickLookCompatible=i.quickLookCompatible,this.exportInvisible=i.exportInvisible,i.extensions&&(this.extensions=i.extensions),this.materials=new Map,this.textures={},this.files={},this.document=new Tg,this.output="",this.animations=[]}}class Wf{constructor(){r(this,"ar",{anchoring:{type:"plane"},planeAnchoring:{alignment:"horizontal"}});r(this,"quickLookCompatible",!1);r(this,"extensions",[]);r(this,"maxTextureSize",4096);r(this,"exportInvisible",!1)}}let ow=class{constructor(){r(this,"debug");r(this,"pruneUnusedNodes");r(this,"sceneAnchoringOptions",new Wf);r(this,"extensions",[]);r(this,"keepObject");r(this,"beforeWritingDocument");this.debug=!1,this.pruneUnusedNodes=!0}async parse(t,e=new Wf){var w,P;e=Object.assign(new Wf,e),this.sceneAnchoringOptions=e;const i=new tM(t,this,e);this.extensions=i.extensions;const n=i.files,o="model.usda";n[o]=null;const a=i.materials,l=i.textures;se.report("export-usdz","Invoking onBeforeBuildDocument"),await Cd(i,"onBeforeBuildDocument"),se.report("export-usdz","Done onBeforeBuildDocument"),se.report("export-usdz","Reparent bones to common ancestor");const c=[],d=new Set;t==null||t.traverse(k=>{if(!(!e.exportInvisible&&!k.visible)&&k instanceof h.SkinnedMesh){const O=k.skeleton.bones,M=iw(O);if(M){const A={object:k,originalParent:k.parent,newParent:M};c.push(A),d.add(A.object.uuid),A.newParent&&d.add(A.newParent.uuid),A.originalParent&&d.add(A.originalParent.uuid)}}});for(const k of c){const{object:O,originalParent:M,newParent:A}=k;A.add(O)}se.report("export-usdz","Traversing hierarchy"),t&&rw(t,i.document,i,this.keepObject),se.report("export-usdz","Invoking onAfterBuildDocument"),await Cd(i,"onAfterBuildDocument");const u=i.extensions.find(k=>k.extensionName==="Behaviour"),f=(u==null?void 0:u.getAllTargetUuids())??new Set;if(this.pruneUnusedNodes){const k={allBehaviorTargets:f,debug:!1,boneReparentings:d,quickLookCompatible:i.quickLookCompatible};this.debug&&Hy(i.document,"Hierarchy BEFORE pruning",k),aw(i.document,k),this.debug&&Hy(i.document,"Hierarchy AFTER pruning")}else this.debug&&console.log("Pruning of empty nodes is disabled. This may result in a larger USDZ file.");se.report("export-usdz",{message:"Parsing document",autoStep:10}),await iM(i,()=>(se.report("export-usdz","Building materials"),hM(a,l,e.quickLookCompatible))),se.report("export-usdz","Invoking onAfterSerialize"),await Cd(i,"onAfterSerialize");for(const k of c){const{object:O,originalParent:M,newParent:A}=k;M&&M.add(O)}(P=(w=i.exporter)==null?void 0:w.beforeWritingDocument)==null||P.call(w);const g=i.document.buildHeader(i)+`
`+i.output;this.debug&&console.log(g),n[o]=Y.strToU8(g),i.output="",se.report("export-usdz",{message:"Exporting textures",autoStep:10}),se.start("export-usdz-textures",{parentScope:"export-usdz",logTimings:!1});const _=new h.WebGLRenderer({antialias:!1,alpha:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!0}),y=Object.keys(l).length;se.report("export-usdz-textures",{totalSteps:y*3,currentStep:0});const b=async k=>{const O=l[k],M=O.texture,A=fw.includes(M.format);let I={imageData:M.image};se.report("export-usdz-textures",{message:"read back texture",autoStep:!0});const T=O.scale!==void 0&&O.scale.x!==1&&O.scale.y!==1&&O.scale.z!==1&&O.scale.w!==1;(M.isCompressedTexture||M.isRenderTargetTexture||T)&&(I=await cw(M,e.maxTextureSize,_,O.scale)),se.report("export-usdz-textures",{message:"convert texture to canvas",autoStep:!0});const j=await sM(I.imageBitmap||I.imageData,e.maxTextureSize).catch(F=>{console.error("Error converting texture to canvas",M,F)});if(j){se.report("export-usdz-textures",{message:"convert canvas to blob",autoStep:!0});const F=await j.convertToBlob({type:A?"image/png":"image/jpeg",quality:.95});n[`textures/${k}.${A?"png":"jpg"}`]=new Uint8Array(await F.arrayBuffer())}else console.warn("Can`t export texture: ",M)};for(const k in l)await b(k);_.dispose(),se.end("export-usdz-textures");let v=0;for(const k in n){const O=n[k],M=34+k.length;v+=M;const A=v&63;if(A!==4){const I=64-A,T=new Uint8Array(I);n[k]=[O,{extra:{12345:T}}]}v=O.length}return se.report("export-usdz","zip archive"),Y.zipSync(n,{level:0})}};function rw(s,t,e,i){var c;if(!e.exportInvisible&&!s.visible)return;let n,o,a;const l={position:s.position,quaternion:s.quaternion,scale:s.scale};if(s.position.x===0&&s.position.y===0&&s.position.z===0&&(l.position=null),s.quaternion.x===0&&s.quaternion.y===0&&s.quaternion.z===0&&s.quaternion.w===1&&(l.quaternion=null),s.scale.x===1&&s.scale.y===1&&s.scale.z===1&&(l.scale=null),(s instanceof h.Mesh||s instanceof h.SkinnedMesh)&&(o=s.geometry,a=s.material),i&&!i(s)&&(o=void 0,a=void 0),(s instanceof h.Mesh||s instanceof h.SkinnedMesh)&&a&&(a instanceof h.MeshStandardMaterial||a instanceof h.MeshBasicMaterial||a instanceof h.Material&&a.type==="MeshLineMaterial")){const d=qh(s),u=s instanceof h.SkinnedMesh?s:null;n=new bt(s.uuid,d,l,o,a,void 0,u,s.animations)}else if(s instanceof h.PerspectiveCamera||s instanceof h.OrthographicCamera){const d=qh(s);n=new bt(s.uuid,d,l,void 0,void 0,s)}else{const d=qh(s);n=new bt(s.uuid,d,l,void 0,void 0,void 0,void 0,s.animations)}if(n){if(n.displayName=((c=s.userData)==null?void 0:c.name)||s.name,n.visibility=s.visible?void 0:"invisible",t&&t.add(n),t=n,e.extensions)for(const d of e.extensions)d.onExportObject&&d.onExportObject.call(d,s,n,e)}else{const d=qh(s),u=new bt(s.uuid,d,{position:s.position,quaternion:s.quaternion,scale:s.scale});t&&t.add(u),t=u}for(const d of s.children)rw(d,t,e,i)}function Hy(s,t,...e){const i={};let n=0;function o(a,l){n++;let c=a.displayName||a.name;c+=" ("+a.uuid+")",(a.geometry||a.material||a.camera||a.skinnedMesh)&&(c+=" ("+(a.geometry?"geo, ":"")+(a.material?"mat, ":"")+(a.camera?"cam, ":"")+(a.skinnedMesh?"skin, ":"")+")"),l[c]={};const u={object:a};a.material&&(u.mat=!0),a.geometry&&(u.geo=!0),a.camera&&(u.cam=!0),a.skinnedMesh&&(u.skin=!0),l[c]._self=u;for(const f of a.children)f&&o(f,l[c])}o(s,i),console.log(t+" ("+n+" nodes)",i,...e)}function aw(s,t){var d;let e=!0;const i=new Array,n=new Array;if(s.children.length===0)e=!0;else{const u=[...s.children];for(const f of u)if(f){const m=aw(f,t);t.debug&&(m?i.push(f):n.push(f)),e=e&&m}}const o=t.allBehaviorTargets.has(s.uuid),a=s.geometry||s.material||s.camera&&!t.quickLookCompatible||s.skinnedMesh||!1,l=t.boneReparentings.has(s.uuid),c=e&&!o&&!a&&!l;return c?(t.debug&&console.log("Pruned object:",(s.displayName||s.name)+" ("+s.uuid+")",{isVisible:a,isBehaviorSourceOrTarget:o,allChildsWerePruned:e,isBoneReparenting:l,object:s,prunedChilds:i,keptChilds:n}),(d=s.parent)==null||d.remove(s)):t.debug&&console.log("Kept object:",(s.displayName||s.name)+" ("+s.uuid+")",{isVisible:a,isBehaviorSourceOrTarget:o,allChildsWerePruned:e,isBoneReparenting:l,object:s,prunedChilds:i,keptChilds:n}),c}async function iM(s,t){se.start("export-usdz-resources","export-usdz");const e=[];for(const c of s.document.children)lw(c,s,e);const i=e.length;for(let c=0;c<i;c++)se.report("export-usdz-resources",{totalSteps:i,currentStep:c}),await new Promise((d,u)=>{e[c](),d()});se.end("export-usdz-resources");const n=new sw,o=s.exporter.sceneAnchoringOptions.ar;n.beginBlock(`def Xform "${s.document.name}"`),n.beginBlock(`def Scope "Scenes" (
		kind = "sceneLibrary"
	)`),n.beginBlock('def Xform "Scene"',"(",!1),n.appendLine('apiSchemas = ["Preliminary_AnchoringAPI"]'),n.appendLine("customData = {"),n.appendLine("	bool preliminary_collidesWithEnvironment = 0"),n.appendLine('	string sceneName = "Scene"'),n.appendLine("}"),n.appendLine('sceneName = "Scene"'),n.closeBlock(")"),n.beginBlock(),n.appendLine(`token preliminary:anchoring:type = "${o.anchoring.type}"`),o.anchoring.type==="plane"&&n.appendLine(`token preliminary:planeAnchoring:alignment = "${o.planeAnchoring.alignment}"`),o.anchoring.type==="image"&&n.appendLine(`rel preliminary:imageAnchoring:referenceImage = </${s.document.name}/Scenes/Scene/AnchoringReferenceImage>`),n.appendLine();const a=c=>{if(!c)return 0;let d=1;for(const u of c.children)d+=a(u);return d},l=a(s.document);se.start("export-usdz-xforms","export-usdz"),se.report("export-usdz-xforms",{totalSteps:l,currentStep:1});for(const c of s.document.children)dw(c,n,s);se.end("export-usdz-xforms"),se.report("export-usdz","invoke onAfterHierarchy"),Cd(s,"onAfterHierarchy",n),n.closeBlock(),n.closeBlock(),n.appendLine(t()),n.closeBlock(),se.report("export-usdz","write to string"),s.output+=n.toString()}function lw(s,t,e){if(!s)return;const i=s.geometry,n=s.material;if(i)if(n&&("isMeshStandardMaterial"in n&&n.isMeshStandardMaterial||"isMeshBasicMaterial"in n&&n.isMeshBasicMaterial||n.type==="MeshLineMaterial")){const o="geometries/"+am(i,s.name)+".usda";if(!(o in t.files)){const a=()=>{var c,d;const l=aM(i,(d=(c=s.skinnedMesh)==null?void 0:c.skeleton)==null?void 0:d.bones,t.quickLookCompatible);t.files[o]=rM(l)};e.push(a)}}else console.warn("NeedleUSDZExporter: Unsupported material type (USDZ only supports MeshStandardMaterial)",n==null?void 0:n.name);n&&(n.uuid in t.materials||(t.materials[n.uuid]=n));for(const o of s.children)lw(o,t,e)}async function Cd(s,t,e=null){if(s.extensions){for(const i of s.extensions)if(i&&typeof i[t]=="function"){const o=i[t].call(i,s,e);o instanceof Promise&&await o}}}let Gh=null,Bt=null,Gf,qr,Hh;async function cw(s,t=1/0,e=null,i=void 0){Gf||(Gf=new h.PlaneGeometry(2,2,1,1)),qr||(qr=new h.ShaderMaterial({uniforms:{blitTexture:new h.Uniform$1(s),flipY:new h.Uniform$1(!1),scale:new h.Uniform$1(new h.Vector4(1,1,1,1))},vertexShader:`
            varying vec2 vUv;
			uniform bool flipY;
            void main(){
                vUv = uv;
				if (flipY)
					vUv.y = 1. - vUv.y;
                gl_Position = vec4(position.xy * 1.0,0.,.999999);
            }`,fragmentShader:`
            uniform sampler2D blitTexture;
			uniform vec4 scale; 
            varying vec2 vUv;

            void main(){ 
                gl_FragColor = vec4(vUv.xy, 0, 1);
                
                #ifdef IS_SRGB
                gl_FragColor = sRGBTransferOETF( texture2D( blitTexture, vUv) );
                #else
                gl_FragColor = texture2D( blitTexture, vUv);
                #endif
				
				gl_FragColor.rgba *= scale.rgba;
            }`}));const n=qr.uniforms;n.blitTexture.value=s,n.flipY.value=!1,n.scale.value=new h.Vector4(1,1,1,1),i!==void 0&&n.scale.value.copy(i),qr.defines.IS_SRGB=s.colorSpace==h.SRGBColorSpace,qr.needsUpdate=!0,Hh||(Hh=new h.Mesh(Gf,qr),Hh.frustumCulled=!1);const o=new h.PerspectiveCamera,a=new h.Scene;a.add(Hh),e||(e=Gh=new h.WebGLRenderer({antialias:!1,alpha:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!0}));const l=Math.min(s.image.width,t),c=Math.min(s.image.height,t);Bt&&(Bt.width!==l||Bt.height!==c)&&(Bt.dispose(),Bt=null),Bt||(Bt=new h.WebGLRenderTarget(l,c,{format:h.RGBAFormat,type:h.UnsignedByteType,minFilter:h.LinearFilter,magFilter:h.LinearFilter})),e.setRenderTarget(Bt),e.setSize(l,c),e.clear(),e.render(a,o),Gh&&(Gh.dispose(),Gh=null);const d=new Uint8ClampedArray(Bt.width*Bt.height*4);e.readRenderTargetPixels(Bt,0,0,Bt.width,Bt.height,d);const u=new ImageData(d,Bt.width,Bt.height,void 0),f=await createImageBitmap(u,{premultiplyAlpha:"none"});return{imageData:u,imageBitmap:f}}function nM(s){return typeof HTMLImageElement<"u"&&s instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&s instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&s instanceof OffscreenCanvas||typeof ImageBitmap<"u"&&s instanceof ImageBitmap}async function sM(s,t=4096){const e=t/Math.max(s.width,s.height),i=s.width*Math.min(1,e),n=s.height*Math.min(1,e),o=new OffscreenCanvas(i,n),a={premultiplyAlpha:"none"};s.width!==i&&(a.resizeWidth=i),s.height!==n&&(a.resizeHeight=n);const l=await createImageBitmap(s,a),c=o.getContext("bitmaprenderer");return c&&c.transferFromImageBitmap(l),o}async function hw(s,t=void 0,e=!1,i=4096){if(nM(s)){const n=i/Math.max(s.width,s.height),o=new OffscreenCanvas(s.width*Math.min(1,n),s.height*Math.min(1,n)),a=o.getContext("2d",{alpha:!0,premultipliedAlpha:!1});if(!a)throw new Error("Could not get canvas 2D context");if(e===!0&&(a.translate(0,o.height),a.scale(1,-1)),a.drawImage(s,0,0,o.width,o.height),t!==void 0){const l=t.x,c=t.y,d=t.z,u=t.w,f=a.getImageData(0,0,o.width,o.height),m=f.data;for(let g=0;g<m.length;g+=4)m[g+0]=m[g+0]*l,m[g+1]=m[g+1]*c,m[g+2]=m[g+2]*d,m[g+3]=m[g+3]*u;a.putImageData(f,0,0)}return o}else throw new Error("NeedleUSDZExporter: No valid image data found. Unable to process texture.")}const Ce=7;function oM(){return`#usda 1.0
(
    customLayerData = {
        string creator = "Needle Engine USDZExporter"
    }
    metersPerUnit = 1
    upAxis = "Y"
)
`}function rM(s,t){let e=oM();return e+=s,Y.strToU8(e)}function qh(s){return s.name.replace(/[-<>\(\)\[\]§$%&\/\\\=\?\,\;]/g,"")+"_"+s.id}function qy(s){return fn(s.name||"bone_"+s.uuid)}function am(s,t){return fn(s.name||"Geometry")+"_"+s.id}function Ag(s){return fn(s.name||"Material")+"_"+s.id}function Oa(s,t){let e=qy(s),i=s.parent;for(;i&&i!==t;)e=qy(i)+"/"+e,i=i.parent;return e}function dw(s,t,e){var g;if(s==null)return;se.report("export-usdz-xforms",{message:"buildXform "+s.displayName||s.name,autoStep:!0});const i=s.transform,n=s.geometry,o=s.material,a=s.camera,l=s.name;if(s.animations)for(const _ of s.animations)e.animations.push(_);const c=n&&n.isBufferGeometry&&n.attributes.skinIndex!==void 0&&n.attributes.skinIndex.count>0,d=c?"SkelRoot":"Xform",u=new Array,f=o&&o instanceof h.MeshBasicMaterial&&o.color&&o.color.r===1&&o.color.g===1&&o.color.b===1&&!o.map&&o.opacity===1&&(n==null?void 0:n.attributes.color);if(n!=null&&n.attributes.color&&!f&&console.warn("NeedleUSDZExporter: Geometry has vertex colors. Vertex colors will only be shown in QuickLook for unlit materials with white color and no texture. Otherwise, they will be ignored.",s.displayName),t.appendLine(),n?(t.beginBlock(`def ${d} "${l}"`,"(",!1),e.quickLookCompatible&&o&&o.side===h.DoubleSide&&!c?t.appendLine(`prepend references = @./geometries/${am(n)}.usda@</Geometry_doubleSided>`):t.appendLine(`prepend references = @./geometries/${am(n)}.usda@</Geometry>`),f||u.push("MaterialBindingAPI"),c&&u.push("SkelBindingAPI")):a&&!e.quickLookCompatible?t.beginBlock(`def Camera "${l}"`,"(",!1):s.type!==void 0?t.beginBlock(`def ${s.type} "${l}"`):t.beginBlock(`def Xform "${l}"`,"(",!1),s.type===void 0&&((g=s.extraSchemas)!=null&&g.length&&u.push(...s.extraSchemas),u.length&&t.appendLine(`prepend apiSchemas = [${u.map(_=>`"${_}"`).join(", ")}]`)),s.displayName&&t.appendLine(`displayName = "${tw(s.displayName)}"`),(a||s.type===void 0)&&(t.closeBlock(")"),t.beginBlock()),n&&o){if(!f){const _=Ag(o);t.appendLine(`rel material:binding = </StageRoot/Materials/${_}>`)}!e.quickLookCompatible&&o.side===h.DoubleSide&&(t.beginBlock('over "Geometry" '),t.appendLine("uniform bool doubleSided = 1"),t.closeBlock())}let m=!1;if(c?(t.appendLine("rel skel:skeleton = <Rig>"),t.appendLine("rel skel:animationSource = <Rig/_anim>"),m=!1):s.type===void 0&&i&&(m=m||i.position!==null||i.quaternion!==null||i.scale!==null,i.position&&(s.needsTranslate=!0,t.appendLine(`double3 xformOp:translate = (${ne(i.position.x)}, ${ne(i.position.y)}, ${ne(i.position.z)})`)),i.quaternion&&(s.needsOrient=!0,t.appendLine(`quatf xformOp:orient = (${ne(i.quaternion.w)}, ${ne(i.quaternion.x)}, ${ne(i.quaternion.y)}, ${ne(i.quaternion.z)})`)),i.scale&&(s.needsScale=!0,t.appendLine(`double3 xformOp:scale = (${ne(i.scale.x)}, ${ne(i.scale.y)}, ${ne(i.scale.z)})`))),s.visibility!==void 0&&t.appendLine(`token visibility = "${s.visibility}"`),a&&!e.quickLookCompatible&&("isOrthographicCamera"in a&&a.isOrthographicCamera?(t.appendLine(`float2 clippingRange = (${a.near}, ${a.far})`),t.appendLine(`float horizontalAperture = ${((Math.abs(a.left)+Math.abs(a.right))*10).toPrecision(Ce)}`),t.appendLine(`float verticalAperture = ${((Math.abs(a.top)+Math.abs(a.bottom))*10).toPrecision(Ce)}`),t.appendLine('token projection = "orthographic"')):"isPerspectiveCamera"in a&&a.isPerspectiveCamera&&(t.appendLine(`float2 clippingRange = (${a.near.toPrecision(Ce)}, ${a.far.toPrecision(Ce)})`),t.appendLine(`float focalLength = ${a.getFocalLength().toPrecision(Ce)}`),t.appendLine(`float focusDistance = ${a.focus.toPrecision(Ce)}`),t.appendLine(`float horizontalAperture = ${a.getFilmWidth().toPrecision(Ce)}`),t.appendLine('token projection = "perspective"'),t.appendLine(`float verticalAperture = ${a.getFilmHeight().toPrecision(Ce)}`))),s.onSerialize&&s.onSerialize(t,e),s.type===void 0){const _=new Array;s.needsTranslate&&_.push('"xformOp:translate"'),s.needsOrient&&_.push('"xformOp:orient"'),s.needsScale&&_.push('"xformOp:scale"'),_.length&&t.appendLine(`uniform token[] xformOpOrder = [${_.join(", ")}]`)}if(s.children){t.appendLine();for(const _ of s.children)dw(_,t,e)}t.closeBlock()}function ne(s){return Number.isInteger(s)?s.toString():s.toFixed(10)}function Xy(s){const t=s.elements;return`( ${Xh(t,0)}, ${Xh(t,4)}, ${Xh(t,8)}, ${Xh(t,12)} )`}function Xh(s,t){return`(${ne(s[t+0])}, ${ne(s[t+1])}, ${ne(s[t+2])}, ${ne(s[t+3])})`}function aM(s,t=[],e=!0){return`
def "Geometry"
${lM(s,t,e)}
`}function lM(s,t=[],e=!0){const i="Geometry",n=s.attributes,o=n.position.count,a=t&&t.length>0,l=[],c=[];let d=new Array,u=n.skinIndex;if(a){const m=[];for(const b of t)l.push({bone:b,index:t.indexOf(b)}),m.push(b.uuid);let g=1e4;for(;m.length<t.length&&g-- >0;)for(const b of l){const v=b.bone.children;for(const w of v)m.indexOf(w.uuid)===-1&&t.indexOf(w)!==-1&&(l.push({bone:w,index:t.indexOf(w)}),m.push(w.uuid))}g<=0&&console.error("Failed to sort bones in skinned mesh",l,t,m);for(const b of nw(t))l.push({bone:b,index:l.length});const _=l[0].bone.parent;l.sort((b,v)=>Oa(b.bone,_)>Oa(v.bone,_)?1:-1),l.map(b=>'"'+Oa(b.bone,_)+'"').join(", ");for(const b in l)c[l[b].index]=parseInt(b);const y=n.skinIndex;d=new Array;for(let b=0;b<y.count;b++){const v=y.getX(b),w=y.getY(b),P=y.getZ(b),k=y.getW(b);d.push(c[v],c[w],c[P],c[k])}u=new h.BufferAttribute(new Uint16Array(d),4)}const f=n.skinWeight&&n.skinIndex;return`
{	
    def Mesh "${i}" ${f?`(
        prepend apiSchemas = ["SkelBindingAPI"]
    )`:""}
    {
        int[] faceVertexCounts = [${Hf(s)}]
        int[] faceVertexIndices = [${qf(s)}]
		${n.normal||e?`normal3f[] normals = [${Pd(n.normal,o)}] (
            interpolation = "vertex"
        )`:""}
        point3f[] points = [${Pd(n.position,o)}]
        ${n.uv?`texCoord2f[] primvars:st = [${uw(n.uv,o,!0)}] (
            interpolation = "vertex"
        )`:""}
		${n.uv1?Xf("st1",n.uv1):""}
		${n.uv2?Xf("st2",n.uv2):""}
		${n.uv3?Xf("st3",n.uv3):""}
		${f?`matrix4d primvars:skel:geomBindTransform = ( (1, 0, 0, 0), (0, 1, 0, 0), (0, 0, 1, 0), (0, 0, 0, 1) ) (
				elementSize = 1
				interpolation = "constant"
			)`:""}
		${n.skinIndex?`int[] primvars:skel:jointIndices = [${Qy(u,!0)}] (
			elementSize = 4
			interpolation = "vertex"
		)`:""}
		${n.skinWeight?`float[] primvars:skel:jointWeights = [${Qy(n.skinWeight)}] (
			elementSize = 4
			interpolation = "vertex"
		)`:""}
		${n.color?`color3f[] primvars:displayColor = [${Pd(n.color,o)}] (
			interpolation = "vertex"
		)`:""}
        uniform token subdivisionScheme = "none"
    }
}
${e?`
# This is a workaround for QuickLook/RealityKit not supporting the doubleSided attribute. We're adding a second
# geometry definition here, that uses the same mesh data but appends extra faces with reversed winding order.
def "${i}_doubleSided" (
	prepend references = </Geometry>
)
{
	over "Geometry"
	{
		int[] faceVertexCounts = [${Hf(s)+", "+Hf(s)}]
		int[] faceVertexIndices = [${qf(s)+", "+qf(s,!0)}]
	}
}
`:""}
`}function Hf(s){const t=s.index!==null?s.index.count:s.attributes.position.count;return Array(Math.floor(t/3)).fill(3).join(", ")}function qf(s,t=!1){const e=s.index,i=[];if(e!==null)for(let n=0;n<e.count;n++){let o=n;t&&(o=n%3===0?n+2:n%3===2?n-2:n),i.push(e.getX(o))}else{const n=s.attributes.position.count;for(let o=0;o<n;o++){let a=o;t&&(a=o%3===0?o+2:o%3===2?o-2:o),i.push(a)}}return i.join(", ")}function Xf(s,t){const e=t.itemSize;switch(e){case 2:return`texCoord2f[] primvars:${s} = [${uw(t,e,!0)}] (
				interpolation = "vertex"
			)`;case 3:return`texCoord3f[] primvars:${s} = [${Pd(t,e)}] (
				interpolation = "vertex"
			)`;case 4:return`double4[] primvars:${s} = [${cM(t,e)}] (
				interpolation = "vertex"
			)`;default:return console.warn("USDZExporter: Attribute with "+e+" components are currently not supported. Results may be undefined for "+s+"."),""}}function Pd(s,t){if(s===void 0)return console.warn("USDZExporter: A mesh attribute is missing and will be set with placeholder data. The result may look incorrect."),Array(t).fill("(0, 0, 1)").join(", ");const e=[];for(let i=0;i<s.count;i++){const n=s.getX(i),o=s.getY(i),a=s.getZ(i);e.push(`(${n.toPrecision(Ce)}, ${o.toPrecision(Ce)}, ${a.toPrecision(Ce)})`)}return e.join(", ")}function cM(s,t){if(s===void 0)return console.warn("USDZExporter: Attribute is missing. Results may be undefined."),Array(t).fill("(0, 0, 0, 0)").join(", ");const e=[];for(let i=0;i<s.count;i++){const n=s.getX(i),o=s.getY(i),a=s.getZ(i)||0,l=s.getW(i)||0;e.push(`(${n.toPrecision(Ce)}, ${o.toPrecision(Ce)}, ${a.toPrecision(Ce)}, ${l.toPrecision(Ce)})`)}return e.join(", ")}function Qy(s,t=!1){const e=[];for(let i=0;i<s.count;i++){const n=s.getX(i),o=s.getY(i),a=s.getZ(i),l=s.getW(i);e.push(`${t?n:n.toPrecision(Ce)}`),e.push(`${t?o:o.toPrecision(Ce)}`),e.push(`${t?a:a.toPrecision(Ce)}`),e.push(`${t?l:l.toPrecision(Ce)}`)}return e.join(", ")}function uw(s,t,e=!1){if(s===void 0)return console.warn("USDZExporter: UVs missing."),Array(t).fill("(0, 0)").join(", ");const i=[];for(let n=0;n<s.count;n++){const o=s.getX(n);let a=s.getY(n);e&&(a=1-a),i.push(`(${o.toPrecision(Ce)}, ${a.toPrecision(Ce)})`)}return i.join(", ")}function hM(s,t,e=!1){const i=[];for(const n in s){const o=s[n];i.push(dM(o,t,e))}return`
	def "Materials"
    {
${i.join("")}
    }`}function dM(s,t,e=!1){var _,y,b;const i=Ag(s);if(s.colorWrite===!1||((_=s.userData)==null?void 0:_.isShadowCatcherMaterial)||((y=s.userData)==null?void 0:y.isLightBlendMaterial)){const v=s.userData.isLightBlendMaterial||s.userData.isShadowCatcherMaterial?"ND_realitykit_shadowreceiver_surfaceshader":"ND_realitykit_occlusion_surfaceshader";return`

		def Material "${i}" ${s.name?`(
			displayName = "${s.name}"
		)`:""}
		{
			token outputs:mtlx:surface.connect = ${jt}/${i}/Occlusion.outputs:out>

			def Shader "Occlusion"
			{
				uniform token info:id = "${v}"
				token outputs:out
			}
		}`}const o="                ",a=[],l=[],c=new Set;function d(v){var w;return fn(v.name)+"_"+(((w=v.source)==null?void 0:w.id)??v.id)}function u(v,w,P=void 0,k=void 0){const O=d(v),M=O+(k!==void 0&&k!==1?"_"+k:""),A=e&&k!==void 0&&k!==1,I=A?new h.Vector4(1,1,1,k):void 0;k===void 0&&(k=1),A&&(k=1),I&&I.w<=.05&&(I.w=.05),t[M]={texture:v,scale:I};const T=v.channel>0?"st"+v.channel:"st";c.add(v.channel);const j=fw.includes(v.format),F={1e3:"repeat",1001:"clamp",1002:"mirror"},X=v.repeat.clone(),E=v.offset.clone(),L=v.rotation,V=Math.sin(L),G=Math.cos(L);E.y=1-E.y-X.y,e?(X.x===0&&(X.x=1e-4),X.y===0&&(X.y=1e-4),E.x=E.x/X.x,E.y=E.y/X.y,E.x+=V/X.x,E.y+=G-1):(E.x+=V*X.x,E.y+=(1-G)*X.y);const K=X.x!=1||X.y!=1||E.x!=0||E.y!=0||L!=0,te=`${jt}/${i}/${"uvReader_"+T}.outputs:result>`,ae=`${jt}/${i}/Transform2d_${w}.outputs:result>`,Pe=w!=="normal"&&P&&(P.r!==1||P.g!==1||P.b!==1||k!==1)||!1,ft=w==="normal",Xt=s instanceof h.MeshStandardMaterial&&s.normalScale?s.normalScale.x*2:2,Lt=Xt.toFixed(Ce),Vr=(-1*(Xt/2)).toFixed(Ce),As=(1-Xt).toFixed(Ce);return`
			${K?`def Shader "Transform2d_${w}" (
				sdrMetadata = {
					string role = "math"
				}
			)
			{
				uniform token info:id = "UsdTransform2d"
				float2 inputs:in.connect = ${te}
				float2 inputs:scale = ${Ky(X)}
				float2 inputs:translation = ${Ky(E)}
				float inputs:rotation = ${(L/Math.PI*180).toFixed(Ce)}
				float2 outputs:result
			}
			`:""}
			def Shader "${O}_${w}"
			{
				uniform token info:id = "UsdUVTexture"
				asset inputs:file = @textures/${M}.${j?"png":"jpg"}@
				token inputs:sourceColorSpace = "${v.colorSpace==="srgb"?"sRGB":"raw"}"
				float2 inputs:st.connect = ${K?ae:te}
				${Pe?`
				float4 inputs:scale = (${P?P.r+", "+P.g+", "+P.b:"1, 1, 1"}, ${k})
				`:""}
				${ft?`
				float4 inputs:scale = (${Lt}, ${Lt}, ${Lt}, 1)
				float4 inputs:bias = (${Vr}, ${Vr}, ${As}, 0)
				`:""}
				token inputs:wrapS = "${F[v.wrapS]}"
				token inputs:wrapT = "${F[v.wrapT]}"
				float outputs:r
				float outputs:g
				float outputs:b
				float3 outputs:rgb
				${s.transparent||s.alphaTest>0?"float outputs:a":""}
			}`}let f=s.transparent||s.alphaTest?s.opacity:1,m=!1,g=!1;if(s instanceof h.MeshPhysicalMaterial&&s.transmission!==void 0&&(f*=1-s.transmission*(1-s.roughness*.5)),s.map?(a.push(`${o}color3f inputs:diffuseColor.connect = ${jt}/${i}/${d(s.map)}_diffuse.outputs:rgb>`),s instanceof h.MeshBasicMaterial&&s.transparent&&s.alphaTest==0&&e?(a.push(`${o}float inputs:opacity.connect = ${jt}/${i}/${d(s.map)}_diffuse.outputs:a>`),m=!0,a.push(`${o}float inputs:opacityThreshold = ${1e-10}`),g=!0):s.transparent?(a.push(`${o}float inputs:opacity.connect = ${jt}/${i}/${d(s.map)}_diffuse.outputs:a>`),m=!0):s.alphaTest>0&&(a.push(`${o}float inputs:opacity.connect = ${jt}/${i}/${d(s.map)}_diffuse.outputs:a>`),m=!0,a.push(`${o}float inputs:opacityThreshold = ${s.alphaTest}`),g=!0),l.push(u(s.map,"diffuse",s.color,f))):a.push(`${o}color3f inputs:diffuseColor = ${Yy(s.color)}`),s.alphaHash&&e&&(g?console.warn("Opacity threshold for "+s.name+" was already connected. Skipping alphaHash opacity threshold."):(a.push(`${o}float inputs:opacityThreshold = 0.0000000001`),g=!0)),s.aoMap&&(a.push(`${o}float inputs:occlusion.connect = ${jt}/${i}/${d(s.aoMap)}_occlusion.outputs:r>`),l.push(u(s.aoMap,"occlusion"))),s.alphaMap?(a.push(`${o}float inputs:opacity.connect = ${jt}/${i}/${d(s.alphaMap)}_opacity.outputs:r>`),a.push(`${o}float inputs:opacityThreshold = 0.0000000001`),m=!0,g=!0,l.push(u(s.alphaMap,"opacity",new h.Color(1,1,1),f))):(m?console.warn("Opacity for "+s.name+" was already connected. Skipping default opacity."):(a.push(`${o}float inputs:opacity = ${f}`),m=!0),s.alphaTest>0&&(g?console.warn("Opacity threshold for "+s.name+" was already connected. Skipping default opacity threshold."):(a.push(`${o}float inputs:opacityThreshold = ${s.alphaTest}`),g=!0))),s instanceof h.MeshStandardMaterial){if(s.emissiveMap){a.push(`${o}color3f inputs:emissiveColor.connect = ${jt}/${i}/${d(s.emissiveMap)}_emissive.outputs:rgb>`);const v=s.emissive.clone();v.multiplyScalar(s.emissiveIntensity),l.push(u(s.emissiveMap,"emissive",v))}else if(((b=s.emissive)==null?void 0:b.getHex())>0){const v=s.emissive.clone();v.multiplyScalar(s.emissiveIntensity),a.push(`${o}color3f inputs:emissiveColor = ${Yy(v)}`)}s.normalMap&&(a.push(`${o}normal3f inputs:normal.connect = ${jt}/${i}/${d(s.normalMap)}_normal.outputs:rgb>`),l.push(u(s.normalMap,"normal"))),s.roughnessMap&&s.roughness===1?(a.push(`${o}float inputs:roughness.connect = ${jt}/${i}/${d(s.roughnessMap)}_roughness.outputs:g>`),l.push(u(s.roughnessMap,"roughness"))):a.push(`${o}float inputs:roughness = ${s.roughness!==void 0?s.roughness:1}`),s.metalnessMap&&s.metalness===1?(a.push(`${o}float inputs:metallic.connect = ${jt}/${i}/${d(s.metalnessMap)}_metallic.outputs:b>`),l.push(u(s.metalnessMap,"metallic"))):a.push(`${o}float inputs:metallic = ${s.metalness!==void 0?s.metalness:0}`)}return s instanceof h.MeshPhysicalMaterial&&(a.push(`${o}float inputs:clearcoat = ${s.clearcoat}`),a.push(`${o}float inputs:clearcoatRoughness = ${s.clearcoatRoughness}`),a.push(`${o}float inputs:ior = ${s.ior}`),!s.transparent&&!(s.alphaTest>0)&&s.transmissionMap&&(a.push(`${o}float inputs:opacity.connect = ${jt}/${i}/${d(s.transmissionMap)}_transmission.outputs:r>`),l.push(u(s.transmissionMap,"transmission")))),c.size>2?console.warn("USDZExporter: Material "+s.name+" uses more than 2 UV channels. Currently, only UV0 and UV1 are supported."):c.size===2&&(!c.has(0)||!c.has(1))&&console.warn("USDZExporter: Material "+s.name+" uses UV channels other than 0 and 1. Currently, only UV0 and UV1 are supported."),`

		def Material "${i}" ${s.name?`(
			displayName = "${tw(s.name)}"
		)`:""}
		{
			token outputs:surface.connect = ${jt}/${i}/PreviewSurface.outputs:surface>

			def Shader "PreviewSurface"
			{
				uniform token info:id = "UsdPreviewSurface"
${a.join(`
`)}
				int inputs:useSpecularWorkflow = ${s instanceof h.MeshBasicMaterial?"1":"0"}
				token outputs:surface
			}
${l.length>0?`
${c.has(0)?`
			def Shader "uvReader_st"
			{
				uniform token info:id = "UsdPrimvarReader_float2"
				token inputs:varname = "st"
				float2 inputs:fallback = (0.0, 0.0)
				float2 outputs:result
			}
`:""}
${c.has(1)?`
			def Shader "uvReader_st1"
			{
				uniform token info:id = "UsdPrimvarReader_float2"
				token inputs:varname = "st1"
				float2 inputs:fallback = (0.0, 0.0)
				float2 outputs:result
			}
`:""}
${l.join(`
`)}`:""}
		}`}function Yy(s){return`(${s.r}, ${s.g}, ${s.b})`}function Ky(s){return`(${s.x}, ${s.y})`}const fw=[1023,33777,33778,33779,35842,35843,37496,37808,37809,37810,37811,37812,37813,37814,37815,37816,37817,37818,37819,37820,37821,36492];x("debugusdz");const x_=class{constructor(t,e,i){r(this,"id");r(this,"trigger");r(this,"action");r(this,"exclusive",!1);this.id="Behavior_"+fn(t)+"_"+x_.global_id++,this.trigger=e,this.action=i}makeExclusive(t){return this.exclusive=t,this}writeTo(t,e,i){if(!this.trigger||!this.action)return;i.beginBlock(`def Preliminary_Behavior "${this.id}"`);let n="";if(Array.isArray(this.trigger)){n="[";for(let o=0;o<this.trigger.length;o++){const a=this.trigger[o];n+="<"+a.id+">",o+1<this.trigger.length&&(n+=", ")}n+="]"}else n=`<${this.trigger.id}>`;if(i.appendLine(`rel triggers = ${n}`),i.appendLine(`rel actions = <${this.action.id}>`),i.appendLine(`uniform bool exclusive = ${this.exclusive?1:0}`),i.appendLine(),Array.isArray(this.trigger))for(const o of this.trigger)o.writeTo(e,i),i.appendLine();else this.trigger.writeTo(e,i);i.appendLine(),this.action.writeTo(e,i),i.closeBlock()}};let ct=x_;r(ct,"global_id",0);const Xr=new Set;function lm(s,t){var i,n;let e="";if(Array.isArray(s)){Xr.clear();let o="[ ";for(let a=0;a<s.length;a++){let l=s[a];if(!l){console.warn("Invalid target object in behavior",s+". Is the object exported?");continue}if(typeof l=="string"){if(Xr.has(l))continue;o+=l,Xr.add(l)}else if(typeof l=="object"){if(l.isObject3D&&(l=t.findById(l.uuid),!l)){console.warn("Invalid target object in behavior",s+". Is the object exported?");continue}const c=(i=l.getPath)==null?void 0:i.call(l);if(Xr.has(c))continue;o+=c,Xr.add(c)}a+1<s.length&&(o+=", ")}o+=" ]",e=o,Xr.clear()}else if(typeof s=="object"){const o=s;if(o.isObject3D&&(s=t.findById(o.uuid)),!s)throw console.error("Invalid target object in behavior, the target object is likely missing from USDZ export. Is the object exported?",o),new Error(`Invalid target object in behavior, the target object is likely missing from USDZ export. Please report a bug. uuid: ${o.uuid}.`);e=(n=s.getPath)==null?void 0:n.call(s)}return e}const S_=class{constructor(t,e){r(this,"id");r(this,"targetId");r(this,"tokenId");r(this,"type");r(this,"distance");t&&(this.targetId=t),e?this.id=e:this.id="Trigger_"+S_.global_id++}writeTo(t,e){e.beginBlock(`def Preliminary_Trigger "${this.id}"`),this.targetId&&(typeof this.targetId!="string"&&(this.targetId=lm(this.targetId,t)),e.appendLine("rel affectedObjects = "+this.targetId)),this.tokenId&&e.appendLine(`token info:id = "${this.tokenId}"`),this.type&&e.appendLine(`token type = "${this.type}"`),typeof this.distance=="number"&&e.appendLine(`double distance = ${this.distance}`),e.closeBlock()}};let gs=S_;r(gs,"global_id",0);function Zy(s,t={direct:!0,indirect:!0}){const e=bt.createEmpty();e.name="InputTarget_"+e.name,e.displayName=void 0,e.type="RealityKitComponent",e.onSerialize=i=>{i.appendLine("bool allowsDirectInput = "+(t.direct?1:0)),i.appendLine("bool allowsIndirectInput = "+(t.indirect?1:0)),i.appendLine('uniform token info:id = "RealityKit.InputTarget"')},s.add(e)}class wt{static sceneStartTrigger(){if(this.__sceneStartTrigger!==void 0)return this.__sceneStartTrigger;const t=new gs(void 0,"SceneStart");return t.tokenId="SceneTransition",t.type="enter",this.__sceneStartTrigger=t,t}static tapTrigger(t,e={direct:!0,indirect:!0}){const i=new gs(t);if(Array.isArray(t)&&t.length>1)for(const n of t)n instanceof bt&&Zy(n,e);else t instanceof bt&&Zy(t,e);return i.tokenId="TapGesture",i}static isTapTrigger(t){return(t==null?void 0:t.tokenId)==="TapGesture"}static proximityToCameraTrigger(t,e){const i=new gs(t);return i.tokenId="ProximityToCamera",i.distance=e,i}}r(wt,"__sceneStartTrigger");class Zs{constructor(t,e){r(this,"id");r(this,"actions");r(this,"loops",0);r(this,"performCount",1);r(this,"type","serial");r(this,"multiplePerformOperation");this.id=t,this.actions=e}static getId(){return this.global_id++}addAction(t){return this.actions.push(t),this}makeParallel(){return this.type="parallel",this}makeSequence(){return this.type="serial",this}makeLooping(){return this.loops=1,this.performCount=0,this}makeRepeat(t){return this.performCount=t,this}writeTo(t,e){e.beginBlock(`def Preliminary_Action "${this.id}"`),e.beginArray("rel actions");for(const i of this.actions){if(!i)continue;const n=i===this.actions[this.actions.length-1];e.appendLine("<"+i.id+">"+(n?"":", "))}e.closeArray(),e.appendLine(),e.appendLine('token info:id = "Group"'),e.appendLine(`bool loops = ${this.loops}`),e.appendLine(`int performCount = ${this.loops>0?0:Math.max(0,this.performCount)}`),e.appendLine(`token type = "${this.type}"`),typeof this.multiplePerformOperation=="string"&&e.appendLine(`token multiplePerformOperation = "${this.multiplePerformOperation}"`),e.appendLine();for(const i of this.actions)i&&(i.writeTo(t,e),e.appendLine());e.closeBlock()}}r(Zs,"global_id",0);const pu=class{constructor(t,e){r(this,"id");r(this,"tokenId");r(this,"affectedObjects");r(this,"easeType");r(this,"motionType");r(this,"duration");r(this,"moveDistance");r(this,"style");r(this,"type");r(this,"front");r(this,"up");r(this,"start");r(this,"animationSpeed");r(this,"reversed");r(this,"pingPong");r(this,"xFormTarget");r(this,"audio");r(this,"gain");r(this,"auralMode");r(this,"multiplePerformOperation");r(this,"velocity");r(this,"comment");r(this,"animationName");t&&(this.affectedObjects=t),e?this.id=e:this.id="Action",this.id+="_"+pu.global_id++}clone(){const t=new pu,e=t.id;return Object.assign(t,this),t.id=e,t}writeTo(t,e){e.beginBlock(`def Preliminary_Action "${this.id}"`),this.comment&&e.appendLine(`# ${this.comment}`),this.affectedObjects&&(typeof this.affectedObjects!="string"&&(this.affectedObjects=lm(this.affectedObjects,t)),e.appendLine("rel affectedObjects = "+this.affectedObjects)),typeof this.duration=="number"&&(typeof this.animationSpeed=="number"&&this.animationSpeed!==1?e.appendLine(`double duration = ${this.duration/this.animationSpeed} `):e.appendLine(`double duration = ${this.duration} `)),this.easeType&&e.appendLine(`token easeType = "${this.easeType}"`),this.tokenId&&e.appendLine(`token info:id = "${this.tokenId}"`),this.tokenId==="ChangeScene"&&e.appendLine("rel scene = </StageRoot/Scenes/Scene>"),this.motionType!==void 0&&e.appendLine(`token motionType = "${this.motionType}"`),typeof this.moveDistance=="number"&&e.appendLine(`double moveDistance = ${this.moveDistance} `),this.style&&e.appendLine(`token style = "${this.style}"`),this.type&&e.appendLine(`token type = "${this.type}"`),this.front&&e.appendLine(`vector3d front = (${this.front.x}, ${this.front.y}, ${this.front.z})`),this.up&&e.appendLine(`vector3d upVector = (${this.up.x}, ${this.up.y}, ${this.up.z})`),typeof this.start=="number"&&e.appendLine(`double start = ${this.start} `),typeof this.animationSpeed=="number"&&e.appendLine(`double animationSpeed = ${this.animationSpeed.toFixed(2)} `),typeof this.reversed=="boolean"&&e.appendLine(`bool reversed = ${this.reversed}`),typeof this.pingPong=="boolean"&&e.appendLine(`bool reverses = ${this.pingPong}`),this.xFormTarget&&(typeof this.xFormTarget!="string"&&(this.xFormTarget=lm(this.xFormTarget,t)),e.appendLine(`rel xformTarget = ${this.xFormTarget}`)),typeof this.audio=="string"&&e.appendLine(`asset audio = @${this.audio}@`),typeof this.gain=="number"&&e.appendLine(`double gain = ${this.gain}`),typeof this.auralMode=="string"&&e.appendLine(`token auralMode = "${this.auralMode}"`),typeof this.multiplePerformOperation=="string"&&e.appendLine(`token multiplePerformOperation = "${this.multiplePerformOperation}"`),typeof this.velocity=="object"&&e.appendLine(`vector3d velocity = (${this.velocity.x}, ${this.velocity.y}, ${this.velocity.z})`),e.closeBlock()}};let Jt=pu;r(Jt,"global_id",0);class zi{constructor(t,e,i){r(this,"x",0);r(this,"y",0);r(this,"z",0);this.x=t,this.y=e,this.z=i}static get up(){return new zi(0,1,0)}static get right(){return new zi(1,0,0)}static get forward(){return new zi(0,0,1)}static get back(){return new zi(0,0,-1)}static get zero(){return new zi(0,0,0)}}class de{static sequence(...t){return new Zs("Group_"+Zs.getId(),t).makeSequence()}static parallel(...t){return new Zs("Group_"+Zs.getId(),t).makeParallel()}static fadeAction(t,e,i){const n=new Jt(t);return n.tokenId="Visibility",n.type=i?"show":"hide",n.duration=e,n.style="basic",n.motionType="none",n.moveDistance=0,n.easeType="none",n}static startAnimationAction(t,e,i=!1,n=!1){const o=new Jt(t);o.tokenId="StartAnimation";const a=e.start,l=e.duration,c=e.speed,d=e.clipName;if(o.comment=`Animation: ${d}, start=${a*60}, length=${l*60}, end=${(a+l)*60}`,o.animationName=d,o.start=a,o.duration=l,o.animationSpeed=c,o.reversed=i,o.pingPong=n,o.multiplePerformOperation="allow",i&&(o.start-=l),n){o.pingPong=!1;const u=o.clone();return u.reversed=!i,u.start=o.start,u.reversed&&(u.start-=l),de.sequence(o,u)}return o}static waitAction(t){const e=new Jt;return e.tokenId="Wait",e.duration=t,e.motionType=void 0,e}static lookAtCameraAction(t,e,i,n){const o=new Jt(t);return o.tokenId="LookAtCamera",o.duration=e===void 0?9999999999999:e,o.front=i??zi.forward,o.up=n??zi.up,o}static emphasize(t,e,i="bounce",n=1,o="basic"){const a=new Jt(t);return a.tokenId="Emphasize",a.duration=e,a.style=o??"basic",a.motionType=i,a.moveDistance=n,a}static transformAction(t,e,i,n,o="inout"){const a=new Jt(t);return a.tokenId="Transform",a.duration=i,a.duration=Math.max(1e-6,i),a.type=n,a.easeType=i>0?o:"none",Array.isArray(e)&&console.error("Transform target must not be an array",e),a.xFormTarget=e,a}static playAudioAction(t,e,i="play",n=1,o="spatial"){const a=new Jt(t);return a.tokenId="Audio",a.type=i,a.audio=e,a.gain=n,a.auralMode=o,a.multiplePerformOperation="allow",a}static impulseAction(t,e){const i=new Jt(t);return i.tokenId="Impulse",i.velocity=e,i}}class uM{constructor(t){r(this,"object");r(this,"model");this.object=t}get id(){return this.object.uuid}apply(t){if(!this.model&&(this.model=t.findById(this.object.uuid),!this.model)){console.error("could not find model with id "+this.object.uuid);return}this.onApply(t)}}class Dg extends uM{constructor(e,i,n,o){super(e);r(this,"matrix");r(this,"material");r(this,"geometry");r(this,"_enableAction");r(this,"_disableAction");this.matrix=i,this.material=n,this.geometry=o}onApply(e){var o,a;const i=this.model;if(!i)return;(o=i.parent)!=null&&o.isDynamic||bt.createEmptyParent(i);const n=i.clone();this.matrix&&n.setMatrix(this.matrix),this.material&&(n.material=this.material),this.geometry&&(n.geometry=this.geometry),(a=i.parent)==null||a.add(n)}enable(){return this._enableAction?this._enableAction:(this._enableAction=de.fadeAction(this.object,0,!0),this._enableAction)}disable(){return this._disableAction?this._disableAction:(this._disableAction=de.fadeAction(this.object,0,!1),this._disableAction)}}class pw{constructor(t){r(this,"actions");r(this,"sortedActions");this.actions=[...t]}organize(){this.sortedActions={};for(const t of this.actions){const e=t.id;this.sortedActions[e]||(this.sortedActions[e]=[]),this.sortedActions[e].push(t)}}getActions(t){return this.sortedActions||this.organize(),this.sortedActions[t.uuid]}}const Rn=x("debugusdzanimation"),cm=x("debugusdzanimationserialization");class Js{constructor(t,e,i){r(this,"_start");r(this,"ext");r(this,"root");r(this,"_nearestAnimatedRoot");r(this,"clip");r(this,"speed");this.ext=t,this.root=e,this.clip=i,this._nearestAnimatedRoot=this.getNearestAnimatedRoot()}get start(){return this._start===void 0&&(this._start=this.ext.getStartTimeByClip(this.clip)),this._start}get duration(){var t;return((t=this.clip)==null?void 0:t.duration)??Ee.restPoseClipDuration}get nearestAnimatedRoot(){return this._nearestAnimatedRoot}get clipName(){var t;return((t=this.clip)==null?void 0:t.name)??"rest"}static isDescendantOf(t,e){let i=e;if(!i||!t)return!1;for(;i;){if(!i)return!1;if(i===t)return!0;i=i.parent}return!1}getNearestAnimatedRoot(){var e;let t;try{for(const i of((e=this.clip)==null?void 0:e.tracks)??[]){const n=h.PropertyBinding.parseTrackName(i.name);let o=h.PropertyBinding.findNode(this.root,n.nodeName);if(o)if(!t)t=o;else{if(o===t||Js.isDescendantOf(t,o))continue;if(!Js.isDescendantOf(o,t)){for(;!Js.isDescendantOf(o,t)&&o.parent;)o=o.parent;Js.isDescendantOf(o,t)||console.error("USDZExporter: Animation clip targets multiple roots that are not parent/child. Please report a bug",this.root,this.clip,t,o)}t=o}}}catch(i){console.error("USDZExporter: Exception when trying to find nearest animated root. Please report a bug",i),t=void 0}return t}}const bc=class{constructor(t,e,i){r(this,"clip");r(this,"pos");r(this,"rot");r(this,"scale");r(this,"root");r(this,"target");r(this,"duration",0);r(this,"useRootMotion",!1);if(this.root=t,this.target=e,this.clip=i,i?this.duration=i.duration:this.duration=bc.restPoseClipDuration,i&&i.tracks){const o=Math.max(...i.tracks.map(a=>a.times[a.times.length-1]));o!==this.duration&&(console.warn("USDZExporter: Animation clip duration does not match the maximum time value in the tracks.",i,o,this.duration),this.duration=o)}const n=S.getComponent(t,xt);n&&(this.useRootMotion=n.applyRootMotion)}addTrack(t){var e,i;if(!this.clip){console.error("This is a rest clip but you're trying to add tracks to it – this is likely a bug");return}t.name.endsWith("position")?this.pos=t:t.name.endsWith("quaternion")?this.rot=t:t.name.endsWith("scale")?this.scale=t:(t.name.endsWith("activeSelf")?console.warn("[USDZ] Animation of enabled/disabled state is not supported for USDZ export and will NOT be exported: "+t.name+" on "+(((e=this.root)==null?void 0:e.name)??this.target.name)+". Animate scale 0/1 instead."):console.warn("[USDZ] Animation track type not supported for USDZ export and will NOT be exported: "+t.name+" on "+(((i=this.root)==null?void 0:i.name)??this.target.name)+". Only .position, .rotation, .scale are supported."),B()&&pe("[USDZ] Some animations can't be exported. See console for details."))}getFrames(){var t,e,i,n,o,a;return this.clip?Math.max(((e=(t=this.pos)==null?void 0:t.times)==null?void 0:e.length)??0,((n=(i=this.rot)==null?void 0:i.times)==null?void 0:n.length)??0,((a=(o=this.scale)==null?void 0:o.times)==null?void 0:a.length)??0):2}getDuration(){return this.duration}getSortedTimesArray(t=!0,e=!0,i=!0){var c,d,u;if(!this.clip)return[0,this.duration];const n=(c=this.pos)==null?void 0:c.times,o=(d=this.rot)==null?void 0:d.times,a=(u=this.scale)==null?void 0:u.times,l=[];if(t&&n)for(const f of n)l.push(f);if(e&&o)for(const f of o)l.push(f);if(i&&a)for(const f of a)l.push(f);return l.includes(0)||l.push(0),l.sort((f,m)=>f-m),[...new Set(l)]}*getValues(t,e=!0,i=!0,n=!0){var g,_,y;const o=new h.Vector3,a=new h.Quaternion,l=new h.Vector3(1,1,1),c=this.target,d=e?(g=this.pos)==null?void 0:g.createInterpolant():void 0,u=i?(_=this.rot)==null?void 0:_.createInterpolant():void 0,f=n?(y=this.scale)==null?void 0:y.createInterpolant():void 0;d||o.set(c.position.x,c.position.y,c.position.z),u||a.set(c.quaternion.x,c.quaternion.y,c.quaternion.z,c.quaternion.w),f||l.set(c.scale.x,c.scale.y,c.scale.z),d&&d.valueSize!==3&&(d.valueSize=3),u&&u.valueSize!==4&&(u.valueSize=4),f&&f.valueSize!==3&&(f.valueSize=3);const m=0;for(let b=0-m;b<t.length+m;b++){let v=0,w=0;if(b<0?(v=t[0],w=v-bc.animationDurationPadding/2+1/60):b>=t.length?(v=t[t.length-1],w=v+bc.animationDurationPadding/2-1/60):(v=t[b],w=v),d){const P=d.evaluate(v);o.set(P[0],P[1],P[2])}if(u){const P=u.evaluate(v);a.set(P[0],P[1],P[2],P[3])}if(f){const P=f.evaluate(v);l.set(P[0],P[1],P[2])}if(this.useRootMotion&&c===this.root){const P=new h.Matrix4;P.compose(o,a,l),P.multiply(c.matrix),P.decompose(o,a,l)}yield{time:w,translation:o,rotation:a,scale:l,index:b}}}};let Ee=bc;r(Ee,"frameRate",60),r(Ee,"animationDurationPadding",6/60),r(Ee,"restPoseClipDuration",6/60);class Nu{constructor(t){r(this,"dict",new Map);r(this,"rootTargetMap",new Map);r(this,"rootAndClipToRegisteredAnimationMap",new Map);r(this,"rootToRegisteredClip",new Map);r(this,"lastClipEndTime",0);r(this,"clipToStartTime",new Map);r(this,"clipToHoldClip",new Map);r(this,"serializers",[]);r(this,"injectRestPoses",!1);r(this,"injectImplicitBehaviours",!1);this.injectRestPoses=t,this.injectImplicitBehaviours=t}get extensionName(){return"animation"}get animationData(){return this.dict}get registeredClips(){return this.clipToStartTime.keys()}get animatedRoots(){return this.rootTargetMap.keys()}get holdClipMap(){return this.clipToHoldClip}getStartTimeCode(){return!this.injectRestPoses||this.rootAndClipToRegisteredAnimationMap.size===0?0:(Ee.restPoseClipDuration+Ee.animationDurationPadding)*60}getEndTimeCode(){let t=0;for(const[e,i]of this.rootAndClipToRegisteredAnimationMap){const n=i.start+i.duration;n>t&&(t=n)}return t*60}getClipCount(t){var i;return((i=this.rootToRegisteredClip.get(t))==null?void 0:i.length)??0??0}getStartTimeByClip(t){return t?this.clipToStartTime.has(t)?this.clipToStartTime.get(t):(console.error("USDZExporter: Missing start time for clip – please report a bug.",t),0):0}registerAnimation(t,e){var d;if(!t)return null;this.rootTargetMap.has(t)||this.rootTargetMap.set(t,[]);const i=t.uuid+((e==null?void 0:e.uuid)??"-rest");if(this.rootAndClipToRegisteredAnimationMap.has(i))return this.rootAndClipToRegisteredAnimationMap.get(i);Rn&&console.log("registerAnimation",t,e);const n=this.injectRestPoses?1:0,o=(((d=this.rootToRegisteredClip.get(t))==null?void 0:d.length)??0)+n,a=this.rootTargetMap.get(t),l=new Set(a);if(e&&e.tracks)for(const u of e.tracks){const f=h.PropertyBinding.parseTrackName(u.name),m=h.PropertyBinding.findNode(t,f.nodeName);if(!m){console.warn("no object found for track",u.name,"using "+t.name+" instead");continue}this.dict.has(m)||this.dict.set(m,[]);const g=this.dict.get(m);if(!g){console.warn("no transform data found for target ",m,"at slot "+o+", this is likely a bug");continue}l.delete(m),this.injectRestPoses&&!g[0]&&(console.log("Injecting rest pose",m,e,"at slot",o),g[0]=new Ee(null,m,null));let _=g[o];_||(_=new Ee(t,m,e),g[o]=_),_.addTrack(u),a!=null&&a.includes(m)||a==null||a.push(m)}Rn&&console.log("Unregistered nodes for this clip",l,"clip",e,"at slot",o,"for root",t,"targets",a);for(const u of l){const f=this.dict.get(u);if(!f)continue;if(this.injectRestPoses&&!f[0]){console.warn("Adding rest pose for ",u,e,"at slot",o,"This is likely a bug, should have been added earlier.");const g=new Ee(null,u,null);f[0]=g}let m=f[o];m||(Rn&&console.log("Adding padding clip for ",u,e,"at slot",o),m=new Ee(t,u,e),f[o]=m)}const c=new Js(this,t,e);if(this.rootAndClipToRegisteredAnimationMap.set(i,c),Rn&&console.log({root:t,clip:e,info:c}),e){const u=this.rootToRegisteredClip.get(t);if(u?u.push(e):this.rootToRegisteredClip.set(t,[e]),!this.clipToStartTime.get(e)){this.lastClipEndTime==null&&(this.lastClipEndTime=Ee.restPoseClipDuration);let m=this.lastClipEndTime+Ee.animationDurationPadding,g=m+e.duration;const _=Math.round(m*60)/60,y=Math.round(g*60)/60;Math.abs(_-m)<.01&&(m=_),Math.abs(y-g)<.01&&(g=y),m=Math.ceil(m),g=m+e.duration,this.clipToStartTime.set(e,m),this.lastClipEndTime=g}}return c}onAfterHierarchy(t){Rn&&console.log("Animation clips per animation target node",this.dict)}onAfterBuildDocument(t){var e,i;Rn&&console.log("Animation data",{dict:this.dict,rootTargetMap:this.rootTargetMap,rootToRegisteredClip:this.rootToRegisteredClip});for(const n of this.rootTargetMap.keys()){const o=this.rootTargetMap.get(n);if(!o)continue;let a;const l=[];for(const c of o){const d=this.dict.get(c);if(!d){console.error("No data found for target on USDZ export – please report a bug!",c);continue}a===void 0&&(a=d==null?void 0:d.length),a!==(d==null?void 0:d.length)&&console.error("Different array lengths for targets – please report a bug!",d);for(let u=0;u<d.length;u++){let f=d[u];if(!f){const g=u-(this.injectRestPoses?1:0);d[u]=new Ee(null,c,this.rootToRegisteredClip.get(n)[g]),f=d[u]}const m=f.getDuration();if(l[u]===void 0)l[u]=m;else if(l[u]!==m){console.error("Error during UDSZ export: Encountered different animation durations for animated targets. Please report a bug!",{datas:d,target:c}),l[u]=m;continue}}}}for(const n of this.serializers){const o=(e=n.model)==null?void 0:e.parent,a=(o==null?void 0:o.isDynamic)===!0;cm&&console.log(a,(i=n.model)==null?void 0:i.parent),a&&n.registerCallback(o)}}onExportObject(t,e,i){S.foreachComponent(t,o=>{const a=o;typeof a.createAnimation=="function"&&a.createAnimation(this,e,i)},!1);const n=new fM(t,this);this.serializers.push(n),n.registerCallback(e)}}class fM{constructor(t,e){r(this,"model");r(this,"object");r(this,"animationData");r(this,"ext");r(this,"callback");this.object=t,this.animationData=e.animationData,this.ext=e}registerCallback(t){this.model&&this.callback&&this.model.removeEventListener("serialize",this.callback),this.callback||(this.callback=this.onSerialize.bind(this)),cm&&console.log("REPARENT",t),this.model=t,this.callback&&this.model.addEventListener("serialize",this.callback)}skinnedMeshExport(t,e,i){var a;const n=this.model,o=this.animationData;if(n&&n.skinnedMesh){let l=function(E){const L=[];for(const[V,G]of E){let K=`${V} : [`;const te=[];for(const ae of G)te.push(`(${ne(ae.x)}, ${ne(ae.y)}, ${ne(ae.z)})`);K=K.concat(te.join(", ")),K=K.concat("],"),L.push(K)}return L},c=function(E){const L=[];for(const[V,G]of E){let K=`${V} : [`;const te=[];for(const ae of G)te.push(`(${ne(ae.w)}, ${ne(ae.x)}, ${ne(ae.y)}, ${ne(ae.z)})`);K=K.concat(te.join(", ")),K=K.concat("],"),L.push(K)}return L},d=function(E){let L,V=!0;const G=new Map;for(const[te,ae]of E){L===void 0&&(L=ae.length),L!==ae.length&&(V=!1);let Pe=0;for(const ft of ae)Pe++,ft||(G.has(te)||G.set(te,[]),G.get(te).push(Pe))}Rn&&console.log("Bone count: ",E.size,"TransformData entries per bone: ",L,"Undefined bone entries: ",G),console.assert(V,"All bones should have the same number of TransformData entries",E),console.assert(G.size===0,"All TransformData entries should be set",G);const K=[];for(const[te,ae]of E)for(let Pe=0;Pe<ae.length;Pe++){const ft=ae[Pe],Xt=i.getStartTimeByClip(ft.clip);K.length<=Pe&&K.push({pos:[],rot:[],scale:[],timeOffset:Xt});const Lt=K[Pe];Lt.pos.push(...ft.getSortedTimesArray(!0,!1,!1)),Lt.rot.push(...ft.getSortedTimesArray(!1,!0,!1)),Lt.scale.push(...ft.getSortedTimesArray(!1,!1,!0))}for(const te of K)te.pos.sort((ae,Pe)=>ae-Pe),te.rot.sort((ae,Pe)=>ae-Pe),te.scale.sort((ae,Pe)=>ae-Pe),te.pos=[...new Set(te.pos)],te.rot=[...new Set(te.rot)],te.scale=[...new Set(te.scale)];return K},u=function(E,L,V){const G=new Map,K=new Map,te=new Map,ae=L.length;for(const Pe of V){const ft=E.get(Pe);let Xt;ft?console.assert(ft.length===ae,"We should have the same number of TransformData entries for each bone",ft,L):Xt=new Ee(null,Pe,null);for(let Lt=0;Lt<ae;Lt++){const Vr=ft?ft[Lt]:Xt,As=L[Lt];for(const{time:fl,translation:pl}of Vr.getValues(As.pos,!0,!1,!1)){const Yi=(fl+As.timeOffset)*60;G.has(Yi)||G.set(Yi,new Array),G.get(Yi).push(pl.clone())}for(const{time:fl,rotation:pl}of Vr.getValues(As.rot,!1,!0,!1)){const Yi=(fl+As.timeOffset)*60;K.has(Yi)||K.set(Yi,new Array),K.get(Yi).push(pl.clone())}for(const{time:fl,scale:pl}of Vr.getValues(As.scale,!1,!1,!0)){const Yi=(fl+As.timeOffset)*60;te.has(Yi)||te.set(Yi,new Array),te.get(Yi).push(pl.clone())}}}return{position:G.size==0?void 0:G,quaternion:K.size==0?void 0:K,scale:te.size==0?void 0:te}},f=function(E){const L=[];for(const V of E)L.push(`(${ne(V.x)}, ${ne(V.y)}, ${ne(V.z)})`);return L.join(", ")},m=function(E){const L=[];for(const V of E)L.push(`(${ne(V.w)}, ${ne(V.x)}, ${ne(V.y)}, ${ne(V.z)})`);return L.join(", ")},g=function(E){const L=new Map;if(Rn){const V=new Array;for(const[G,K]of o)V.push(G.uuid+": "+K.length+" "+K.map(te=>{var ae;return(ae=te.clip)==null?void 0:ae.uuid.substring(0,6)}).join(" "));console.log(`getPerBoneTransformData
`+V.join(`
`))}for(const V of E){const G=o.get(V);G&&L.set(V,G)}return L},_=function(E){const L=g(E),V=d(L);return u(L,V,E)};const y=n.skinnedMesh.skeleton,b=new Array,v=[],w=[];for(const E of y.bones){v.push(E),w.push(E.uuid);const L=y.boneInverses[y.bones.indexOf(E)];b.push({bone:E,inverse:L})}let P=1e4;for(;w.length<y.bones.length&&P-- >0;)for(const E of v){const L=E.children;for(const V of L)if(w.indexOf(V.uuid)===-1&&y.bones.indexOf(V)!==-1){v.push(V),w.push(V.uuid);const G=y.boneInverses[y.bones.indexOf(V)];b.push({bone:V,inverse:G})}}P<=0&&console.error("Failed to sort bones in skinned mesh",n.skinnedMesh,y.bones,w);for(const E of nw(y.bones))b.push({bone:E,inverse:E.matrixWorld.clone().invert()});const k=b[0].bone.parent;k||console.error("No bone parent found for skinned mesh during USDZ export",n.skinnedMesh),b.sort((E,L)=>Oa(E.bone,k)>Oa(L.bone,k)?1:-1);const O=e.quickLookCompatible,M=[],A=[],I=[],T=[];for(const{bone:E}of b){if(O){const L=E.scale;L.x==0&&(L.x=1e-5),L.y==0&&(L.y=1e-5),L.z==0&&(L.z=1e-5),M.push(new h.Matrix4().compose(E.position,E.quaternion,E.scale))}else M.push(E.matrix.clone());A.push(E.position),I.push(E.quaternion),T.push(E.scale)}const j=b.map(E=>'"'+Oa(E.bone,k)+'"').join(", "),F=b.map(E=>Xy(E.inverse.clone().invert())).join(", ");t.beginBlock('def Skeleton "Rig"'),t.appendLine(`uniform matrix4d[] bindTransforms = [${F}]`),t.appendLine(`uniform token[] joints = [${j}]`),t.appendLine('uniform token purpose = "guide"'),t.appendLine(`uniform matrix4d[] restTransforms = [${M.map(E=>Xy(E)).join(", ")}]`);const X=_(b.map(E=>E.bone));if(Rn){let E=1e7,L=0;for(const V of((a=X.position)==null?void 0:a.keys())??[])E=Math.min(E,V),L=Math.max(L,V);console.log("Time samples",E,L,X)}if(t.beginBlock('def SkelAnimation "_anim"'),t.appendLine(`uniform token[] joints = [${j}]`),t.appendLine(`quatf[] rotations = [${m(I)}]`),X&&X.quaternion){t.beginBlock("quatf[] rotations.timeSamples = {","");const E=c(X.quaternion);for(const L of E)t.appendLine(L);t.closeBlock()}if(t.appendLine(`half3[] scales = [${f(T)}]`),X&&X.scale){t.beginBlock("half3[] scales.timeSamples = {","");const E=l(X.scale);for(const L of E)t.appendLine(L);t.closeBlock()}if(t.appendLine(`float3[] translations = [${f(A)}]`),X&&X.position){t.beginBlock("float3[] translations.timeSamples = {","");const E=l(X.position);for(const L of E)t.appendLine(L);t.closeBlock()}t.closeBlock(),t.closeBlock()}}onSerialize(t,e){if(!this.model)return;const i=this.animationData.get(this.object);if(i)for(let u=0;u<i.length;u++)i[u]===void 0&&(i[u]=new Ee(null,this.object,null));const n=this.ext;this.skinnedMeshExport(t,e,n);const o=this.object,a=this.model,l=this.animationData.get(o);if(!l||o.isSkinnedMesh)return;cm&&console.log("SERIALIZE",this.model.name,this.object.type,l);const c=Intl.NumberFormat("en-US",{maximumFractionDigits:3,minimumFractionDigits:0,useGrouping:!1});function d(u,f){var g;if(u.some(_=>_&&{position:_.pos,rotation:_.rot,scale:_.scale}[f])){switch(f){case"position":a.needsTranslate=!0,t.beginBlock("double3 xformOp:translate.timeSamples = {","");break;case"rotation":a.needsOrient=!0,t.beginBlock("quatf xformOp:orient.timeSamples = {","");break;case"scale":a.needsScale=!0,t.beginBlock("double3 xformOp:scale.timeSamples = {","");break}for(let _=0;_<u.length;_++){const y=u[_];if(!y)continue;const b=n.getStartTimeByClip(y.clip),v=y.getSortedTimesArray(f==="position",f==="rotation",f==="scale");if(!v||v.length===0){console.error("got an animated object but no time values?",o,y);continue}const w=!y.clip,P=f==="position"&&(y.pos||w),k=f==="rotation"&&(y.rot||w),O=f==="scale"&&(y.scale||w);if(P||k||O){const M=((g=y.clip)==null?void 0:g.name)??"rest",A=y.getDuration();Rn&&console.log("Write .timeSamples:",M,b,A,u),t.appendLine("# "+M+": start="+c.format(b*Ee.frameRate)+", length="+c.format(A*Ee.frameRate)+", frames="+y.getFrames())}if(P)for(const{time:M,translation:A}of y.getValues(v,!0,!1,!1)){const T=`${c.format((b+M)*Ee.frameRate)}: (${ne(A.x)}, ${ne(A.y)}, ${ne(A.z)}),`;t.appendLine(T)}if(k)for(const{time:M,rotation:A}of y.getValues(v,!1,!0,!1)){const T=`${c.format((b+M)*Ee.frameRate)}: (${ne(A.w)}, ${ne(A.x)}, ${ne(A.y)}, ${ne(A.z)}),`;t.appendLine(T)}if(O)for(const{time:M,scale:A}of y.getValues(v,!1,!1,!0)){const T=`${c.format((b+M)*Ee.frameRate)}: (${ne(A.x)}, ${ne(A.y)}, ${ne(A.z)}),`;t.appendLine(T)}}t.closeBlock()}}d(l,"position"),d(l,"rotation"),d(l,"scale")}}const pM=x("debugusdz");class Cr{constructor(){r(this,"files",new Array)}static getName(t){var o;const e=t.split(".").pop();let n=(o=t.split(".").slice(0,-1).join(".").split("/").pop())==null?void 0:o.replace(".","_");return n||(n="Audio_"+Math.random().toString(36).substring(2,15)),fn(n)+"."+e}get extensionName(){return"Audio"}onExportObject(t,e,i){const n=S.getComponents(t,Ie);if(n.length)for(const o of n){if(!o.clip||typeof o.clip!="string"||!o.playOnAwake)continue;const a=o.clip.split("/").pop()||"Audio",l=Cr.getName(o.clip),c=fn(l);if(!this.files.some(d=>d.path===o.clip)){this.files.push({path:o.clip,name:l});const d=l.toLowerCase();i.quickLookCompatible&&!d.endsWith(".mp3")&&!d.endsWith(".wav")&&!d.endsWith(".m4a")&&console.error("Audio file "+o.clip+" from "+o.name+" is not an MP3 or WAV file. QuickLook may not support playing it.")}i.quickLookCompatible||e.addEventListener("serialize",(d,u)=>{d.appendLine(),d.beginBlock(`def SpatialAudio "${c}"`,"(",!1),d.appendLine(`displayName = "${a}"`),d.closeBlock(")"),d.beginBlock(),d.appendLine(`uniform asset filePath = @audio/${l}@`),d.appendLine(`uniform token auralMode = "${o.spatialBlend>0?"spatial":"nonSpatial"}"`),d.appendLine(`uniform token playbackMode = "${o.loop?"loopFromStage":"onceFromStart"}"`),d.appendLine(`uniform float gain = ${o.volume}`),d.closeBlock()})}}async onAfterSerialize(t){for(const e of this.files){const i="audio/"+e.name;if(t.files[i]){pM&&console.warn("Audio file with name "+i+" already exists in the context. Skipping.");continue}const a=await(await(await fetch(e.path)).blob()).arrayBuffer(),l=new Uint8Array(a);t.files[i]=l}}}var mM=Object.defineProperty,gM=Object.getOwnPropertyDescriptor,je=(s,t,e,i)=>{for(var n=i>1?void 0:i?gM(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&mM(t,e,n),n};const Jy=x("debugusdzbehaviours");function ah(s){s&&(s.getComponentInParent(Ia)||(B()&&console.debug('Raycaster on "'+s.name+'" was automatically added, because no raycaster was found in the parent hierarchy.'),s.addComponent(Ci)))}class Pr extends D{constructor(){super(...arguments);r(this,"object");r(this,"target");r(this,"duration",1);r(this,"relativeMotion",!1);r(this,"coroutine",null);r(this,"targetPos",new h.Vector3);r(this,"targetRot",new h.Quaternion);r(this,"targetScale",new h.Vector3)}start(){ah(this.gameObject)}onPointerClick(e){e.use(),this.coroutine&&this.stopCoroutine(this.coroutine),this.relativeMotion?this.coroutine=this.startCoroutine(this.moveRelative()):this.coroutine=this.startCoroutine(this.moveToTarget())}*moveToTarget(){if(!this.target||!this.object)return;const e=Z(this.object).clone(),i=Z(this.target).clone(),n=_e(this.object).clone(),o=_e(this.target).clone(),a=Ue(this.object).clone(),l=Ue(this.target).clone(),c=e.distanceTo(i),d=n.angleTo(o),u=a.distanceTo(l);if(c<.01&&d<.01&&u<.01){it(this.object,i),Wi(this.object,o),Ea(this.object,l),this.coroutine=null;return}let f=0,m=0;for(;f<1;)f+=this.context.time.deltaTime/this.duration,f>1&&(f=1),m=f<.5?4*f*f*f:1-Math.pow(-2*f+2,3)/2,this.targetPos.lerpVectors(e,i,m),this.targetRot.slerpQuaternions(n,o,m),this.targetScale.lerpVectors(a,l,m),it(this.object,this.targetPos),Wi(this.object,this.targetRot),Ea(this.object,this.targetScale),yield;this.coroutine=null}*moveRelative(){if(!this.target||!this.object)return;const e=this.object.position.clone(),i=this.object.quaternion.clone(),n=this.object.scale.clone(),o=this.target.position.clone(),a=this.target.quaternion.clone(),l=this.target.scale.clone();o.applyQuaternion(this.object.quaternion),this.targetPos.copy(this.object.position).add(o),this.targetRot.copy(this.object.quaternion).multiply(a),this.targetScale.copy(this.object.scale).multiply(l);let c=0,d=0;for(;c<1;)c+=this.context.time.deltaTime/this.duration,c>1&&(c=1),d=c<.5?4*c*c*c:1-Math.pow(-2*c+2,3)/2,this.object.position.lerpVectors(e,this.targetPos,d),this.object.quaternion.slerpQuaternions(i,this.targetRot,d),this.object.scale.lerpVectors(n,this.targetScale,d),yield;this.coroutine=null}beforeCreateDocument(e){var i;if(this.target&&this.object&&this.gameObject){const n=new ct("Move to "+((i=this.target)==null?void 0:i.name),wt.tapTrigger(this.gameObject),de.transformAction(this.object,this.target,this.duration,this.relativeMotion?"relative":"absolute"));e.addBehavior(n)}}}je([p(h.Object3D)],Pr.prototype,"object",2);je([p(h.Object3D)],Pr.prototype,"target",2);je([p()],Pr.prototype,"duration",2);je([p()],Pr.prototype,"relativeMotion",2);var Kr;const Ut=(Kr=class extends D{constructor(){super(...arguments);r(this,"materialToSwitch");r(this,"variantMaterial");r(this,"fadeDuration",0);r(this,"_objectsWithThisMaterial",null);r(this,"selfModel");r(this,"targetModels")}start(){var t;this._objectsWithThisMaterial=this.objectsWithThisMaterial,ah(this.gameObject),B()&&this._objectsWithThisMaterial.length<=0&&console.warn('ChangeMaterialOnClick: No objects found with material "'+((t=this.materialToSwitch)==null?void 0:t.name)+'"')}onPointerEnter(t){this.context.input.setCursor("pointer")}onPointerExit(t){this.context.input.unsetCursor("pointer")}onPointerClick(t){if(t.use(),!!this.variantMaterial)for(let e=0;e<this.objectsWithThisMaterial.length;e++){const i=this.objectsWithThisMaterial[e];i.material=this.variantMaterial}}get objectsWithThisMaterial(){return this._objectsWithThisMaterial!=null?this._objectsWithThisMaterial:(this._objectsWithThisMaterial=[],this.variantMaterial&&this.materialToSwitch&&this.context.scene.traverse(t=>{if(t instanceof h.Mesh)if(Array.isArray(t.material)){for(const e of t.material)if(e===this.materialToSwitch){this.objectsWithThisMaterial.push(t);break}}else t.material===this.materialToSwitch?this.objectsWithThisMaterial.push(t):N0(t.material,this.materialToSwitch)&&this.objectsWithThisMaterial.push(t)}),this._objectsWithThisMaterial)}async beforeCreateDocument(t,e){this.targetModels=[],Ut._materialTriggersPerId={},Ut.variantSwitchIndex=0,this.materialToSwitch&&await re.NEEDLE_progressive.assignTextureLOD(this.materialToSwitch,0),this.variantMaterial&&await re.NEEDLE_progressive.assignTextureLOD(this.variantMaterial,0)}createBehaviours(t,e,i){this.objectsWithThisMaterial.find(o=>o.uuid===e.uuid)&&this.targetModels.push(e),this.gameObject.uuid===e.uuid&&(this.selfModel=e,this.materialToSwitch&&(Ut._materialTriggersPerId[this.materialToSwitch.uuid]||(Ut._materialTriggersPerId[this.materialToSwitch.uuid]=[]),Ut._materialTriggersPerId[this.materialToSwitch.uuid].push(this)))}afterCreateDocument(t,e){if(!this.materialToSwitch)return;const i=Ut._materialTriggersPerId[this.materialToSwitch.uuid];if(i){const n={};for(const o of i){const a=o.createVariants();a&&a.length>0&&(n[o.selfModel.uuid]=a)}for(const o of i){const a=[];for(const l in n)l!==o.selfModel.uuid&&a.push(...n[l]);o.createAndAttachBehaviors(t,n[o.selfModel.uuid],a)}}delete Ut._materialTriggersPerId[this.materialToSwitch.uuid]}createAndAttachBehaviors(t,e,i){const n=[],o=Math.max(0,this.fadeDuration);n.push(de.fadeAction([...this.targetModels,...i],o,!1)),n.push(de.fadeAction(e,o,!0)),t.addBehavior(new ct("Select_"+this.selfModel.name,wt.tapTrigger(this.selfModel),de.parallel(...n))),Ut._parallelStartHiddenActions.push(...e),Ut._startHiddenBehaviour||(Ut._startHiddenBehaviour=new ct("StartHidden_"+this.selfModel.name,wt.sceneStartTrigger(),de.fadeAction(Ut._parallelStartHiddenActions,o,!1)),t.addBehavior(Ut._startHiddenBehaviour))}static getMaterialName(t){return fn(t.name||"Material")+"_"+t.id}createVariants(){if(!this.variantMaterial)return null;const t=[];for(const e of this.targetModels){const i=e.clone();i.name+="_Variant_"+Ut.variantSwitchIndex+++"_"+Ut.getMaterialName(this.variantMaterial),i.displayName=i.displayName+": Variant with material "+this.variantMaterial.name,i.material=this.variantMaterial,i.geometry=e.geometry,i.transform=e.transform,(!e.parent||!e.parent.isEmpty())&&bt.createEmptyParent(e),e.parent&&e.parent.add(i),t.push(i)}return t}},r(Kr,"_materialTriggersPerId",{}),r(Kr,"_startHiddenBehaviour",null),r(Kr,"_parallelStartHiddenActions",[]),r(Kr,"variantSwitchIndex",0),Kr);let Xa=Ut;je([p(h.Material)],Xa.prototype,"materialToSwitch",2);je([p(h.Material)],Xa.prototype,"variantMaterial",2);je([p()],Xa.prototype,"fadeDuration",2);var Zr;const De=(Zr=class extends D{constructor(){super(...arguments);r(this,"target");r(this,"toggleOnClick",!1);r(this,"targetState",!0);r(this,"hideSelf",!0);r(this,"selfModel");r(this,"selfModelClone");r(this,"targetModel");r(this,"toggleModel");r(this,"stateBeforeCreatingDocument",!1);r(this,"targetStateBeforeCreatingDocument",!1)}start(){ah(this.gameObject)}onPointerClick(t){t.use(),!this.toggleOnClick&&this.hideSelf&&(this.gameObject.visible=!1),this.target&&(this.target.visible=this.toggleOnClick?!this.target.visible:this.targetState)}createBehaviours(t,e,i){e.uuid===this.gameObject.uuid&&(this.selfModel=e,this.selfModelClone=e.clone())}beforeCreateDocument(){this.target&&(this.gameObject[De.wasVisible]===void 0&&(this.gameObject[De.wasVisible]=this.gameObject.activeSelf),this.target[De.wasVisible]===void 0&&(this.target[De.wasVisible]=this.target.activeSelf),this.stateBeforeCreatingDocument=this.gameObject[De.wasVisible],this.targetStateBeforeCreatingDocument=this.target[De.wasVisible],this.gameObject.visible=!0,this.target.visible=!0)}afterCreateDocument(t,e){if(!this.target)return;this.targetModel=e.document.findById(this.target.uuid);const i=this.selfModel;if(this.selfModel&&this.targetModel){let n=this.selfModel,o=this.targetState;if(this.toggleOnClick)if(o=!this.targetStateBeforeCreatingDocument,!this.selfModelClone.geometry)(!this.selfModel.parent||this.selfModel.parent.isEmpty())&&Tg.createEmptyParent(this.selfModel),this.toggleModel=this.selfModel.deepClone(),this.toggleModel.name+="_toggle",this.selfModel.parent.add(this.toggleModel);else{if(!this.gameObject[De.toggleClone]){const c=this.selfModelClone.clone();c.setMatrix(new h.Matrix4),c.name+="_toggle"+De.clonedToggleIndex++,i.add(c),this.gameObject[De.toggleClone]=c,console.warn("USDZExport: Toggle "+this.gameObject.name+" doesn't have geometry. It will be deep cloned and nested behaviours will likely not work.")}const l=this.gameObject[De.toggleClone];if(!this.gameObject[De.reverseToggleClone]){const c=this.selfModelClone.clone();c.setMatrix(new h.Matrix4),c.name+="_toggleReverse"+De.clonedToggleIndex++,i.add(c),this.gameObject[De.reverseToggleClone]=c}this.toggleModel=this.gameObject[De.reverseToggleClone],(!this.toggleModel.geometry||!l.geometry)&&console.error("triggers without childs and without geometry won't work!",this,i.geometry),n=l,i.geometry=null,i.material=null}if(this.toggleModel){if(this.toggleOnClick){const l=[];l.push(de.fadeAction(n,0,!1)),l.push(de.fadeAction(this.toggleModel,0,!0)),l.push(de.fadeAction(this.targetModel,0,o)),t.addBehavior(new ct("Toggle_"+n.name+"_ToggleTo"+(o?"On":"Off"),wt.tapTrigger(n),de.parallel(...l)));const c=[];c.push(de.fadeAction(this.toggleModel,0,!1)),c.push(de.fadeAction(n,0,!0)),c.push(de.fadeAction(this.targetModel,0,!o)),t.addBehavior(new ct("Toggle_"+n.name+"_ToggleTo"+(o?"Off":"On"),wt.tapTrigger(this.toggleModel),de.parallel(...c)))}}else{const l=[];this.hideSelf&&l.push(de.fadeAction(n,0,!1)),l.push(de.fadeAction(this.targetModel,0,o)),t.addBehavior(new ct("Toggle_"+n.name+"_ToggleTo"+(o?"On":"Off"),wt.tapTrigger(n),l.length>1?de.parallel(...l):l[0]))}const a=new Array;this.targetStateBeforeCreatingDocument||a.push(this.targetModel),this.stateBeforeCreatingDocument||a.push(i),this.toggleModel&&a.push(this.toggleModel),eo.add(a,t)}}afterSerialize(t,e){this.gameObject[De.wasVisible]!==void 0&&(this.gameObject.visible=this.gameObject[De.wasVisible],delete this.gameObject[De.wasVisible]),this.target&&this.target[De.wasVisible]!==void 0&&(this.target.visible=this.target[De.wasVisible],delete this.target[De.wasVisible]),delete this.gameObject[De.toggleClone],delete this.gameObject[De.reverseToggleClone]}},r(Zr,"clonedToggleIndex",0),r(Zr,"wasVisible",Symbol("usdz_SetActiveOnClick_wasVisible")),r(Zr,"toggleClone",Symbol("clone for toggling")),r(Zr,"reverseToggleClone",Symbol("clone for reverse toggling")),Zr);let Or=De;je([p(h.Object3D)],Or.prototype,"target",2);je([p()],Or.prototype,"toggleOnClick",2);je([p()],Or.prototype,"targetState",2);je([p()],Or.prototype,"hideSelf",2);const os=class extends D{constructor(){super(...arguments);r(this,"wasVisible",!1)}static add(e,i){const n=Array.isArray(e)?e:[e];for(const o of n)os._fadeObjects.includes(o)||(console.log("adding hide on start",o),os._fadeObjects.push(o));os._fadeBehaviour===void 0&&(os._fadeBehaviour=new ct("HideOnStart",wt.sceneStartTrigger(),de.fadeAction(os._fadeObjects,0,!1)),i.addBehavior(os._fadeBehaviour))}start(){S.setActive(this.gameObject,!1)}createBehaviours(e,i,n){i.uuid===this.gameObject.uuid&&(this.wasVisible||os.add(i,e))}beforeCreateDocument(){this.wasVisible=S.isActiveSelf(this.gameObject)}};let eo=os;r(eo,"_fadeBehaviour"),r(eo,"_fadeObjects",[]);class Qa extends D{constructor(){super(...arguments);r(this,"target");r(this,"duration",.5);r(this,"motionType","bounce")}beforeCreateDocument(){}createBehaviours(e,i,n){if(this.target&&i.uuid===this.gameObject.uuid){const o=new ct("emphasize "+this.name,wt.tapTrigger(this.gameObject),de.emphasize(this.target,this.duration,this.motionType,void 0,"basic"));e.addBehavior(o)}}afterCreateDocument(e,i){}}je([p()],Qa.prototype,"target",2);je([p()],Qa.prototype,"duration",2);je([p()],Qa.prototype,"motionType",2);class co extends D{constructor(){super(...arguments);r(this,"target");r(this,"clip","");r(this,"toggleOnClick",!1);r(this,"trigger","tap")}start(){ah(this.gameObject)}ensureAudioSource(){if(!this.target){const e=this.gameObject.addComponent(Ie);e&&(this.target=e,e.spatialBlend=1,e.volume=1,e.loop=!1,e.preload=!0)}}onPointerClick(e){var i;e.use(),!(!((i=this.target)!=null&&i.clip)&&!this.clip)&&(this.ensureAudioSource(),this.target&&(this.target.isPlaying&&this.toggleOnClick?this.target.stop():(!this.toggleOnClick&&this.target.isPlaying&&this.target.stop(),this.clip?this.target.play(this.clip):this.target.play())))}createBehaviours(e,i,n){if(!(!this.target&&!this.clip)&&i.uuid===this.gameObject.uuid){const o=this.clip?this.clip:this.target?this.target.clip:void 0;if(!o||typeof o!="string")return;const a=this.target?this.target.gameObject:this.gameObject;Cr.getName(o);const l=this.target?this.target.volume:1,c=this.target&&this.target.spatialBlend==0?"nonSpatial":"spatial";let d=!1;this.gameObject.traverse(g=>{g instanceof h.Mesh&&g.visible&&(d=!0)}),d=!0;const u=e.addAudioClip(o);let f=de.playAudioAction(a,u,"play",l,c);this.target&&this.target.loop&&(f=de.sequence(f).makeLooping());const m=this.name?"_"+this.name:"";if(d&&this.trigger==="tap"){this.toggleOnClick&&(f.multiplePerformOperation="stop");const g=new ct("playAudio"+m,wt.tapTrigger(i),f);e.addBehavior(g)}if(this.target&&this.target.playOnAwake&&this.target.enabled)if(d&&this.trigger==="tap")console.warn("USDZExport: Audio sources that are played on tap can't also auto-play at scene start due to a QuickLook bug.");else{const g=new ct("playAudioOnStart"+m,wt.sceneStartTrigger(),f);e.addBehavior(g)}}}}je([p(Ie)],co.prototype,"target",2);je([p(URL)],co.prototype,"clip",2);je([p()],co.prototype,"toggleOnClick",2);var rd;const Cn=(rd=class extends D{constructor(){super(...arguments);r(this,"animator");r(this,"stateName");r(this,"trigger","tap");r(this,"animation");r(this,"selfModel");r(this,"stateAnimationModel");r(this,"animationSequence",new Array);r(this,"animationLoopAfterSequence",new Array);r(this,"randomOffsetNormalized",0)}get target(){var t,e;return((t=this.animator)==null?void 0:t.gameObject)||((e=this.animation)==null?void 0:e.gameObject)}start(){ah(this.gameObject)}onPointerClick(t){var e;t.use(),this.target&&this.stateName&&((e=this.animator)==null||e.play(this.stateName,0,0,.1))}createBehaviours(t,e,i){e.uuid===this.gameObject.uuid&&(this.selfModel=e)}afterSerialize(){if(Cn.rootsWithExclusivePlayback.size>1){const t='Multiple root objects targeted by more than one animation. To work around QuickLook bug FB13410767, animations will be set as "exclusive" and activating them will stop other animations being marked as exclusive.';B()&&pe(t),console.warn(t,...Cn.rootsWithExclusivePlayback)}Cn.animationActions=[],Cn.rootsWithExclusivePlayback=new Set}afterCreateDocument(t,e){if(this.animationSequence===void 0&&this.animationLoopAfterSequence===void 0||!this.stateAnimationModel||!this.target)return;const i=e.document,n=e.extensions.find(l=>l instanceof Nu);if(!n)return;const o=n.getClipCount(this.target)>1;o&&(B()&&console.warn("Setting exclusive playback for "+this.target.name+"@"+this.stateName+" because it has "+n.getClipCount(this.target)+" animations. This works around QuickLook bug FB13410767."),Cn.rootsWithExclusivePlayback.add(this.target));const a=this.name?this.name:"";i.traverse(l=>{var c,d;if(l.uuid===((c=this.target)==null?void 0:c.uuid)){const u=Cn.getActionForSequences(i,l,this.animationSequence,this.animationLoopAfterSequence,this.randomOffsetNormalized),f=new ct(this.trigger+"_"+a+"_toPlayAnimation_"+this.stateName+"_on_"+((d=this.target)==null?void 0:d.name),this.trigger=="tap"?wt.tapTrigger(this.selfModel):wt.sceneStartTrigger(),u);o&&f.makeExclusive(!0),t.addBehavior(f)}})}static getActionForSequences(t,e,i,n,o){const a=(c,d)=>{let u=Cn.animationActions.find(f=>f.affectedObjects==c&&f.start==d.start&&f.duration==d.duration&&f.animationSpeed==d.speed);return u||(u=de.startAnimationAction(c,d),Cn.animationActions.push(u)),u},l=de.sequence();if(i&&i.length>0)for(const c of i)l.addAction(a(e,c));if(n&&n.length>0){const c=l.actions.length==0?l:de.sequence();for(const d of n)c.addAction(a(e,d));c.makeLooping(),l!==c&&l.addAction(c)}return o&&o>0&&l.actions.unshift(de.waitAction(o)),l}static getAndRegisterAnimationSequences(t,e,i){var _,y,b,v,w,P,k,O;if(!e)return;const n=e.getComponent(xt),o=e.getComponent(kt);if(!n&&!o)return;if(n&&!i)throw new Error("PlayAnimationOnClick: No stateName specified for animator "+n.name+" on "+e.name);let a=[],l=[];if(o){const M=t.registerAnimation(e,o.clip);M&&(o.loop?l.push(M):a.push(M));let A=0;if(o.minMaxOffsetNormalized){const I=o.minMaxOffsetNormalized.x,T=o.minMaxOffsetNormalized.y;A=(((_=o.clip)==null?void 0:_.duration)||1)*(I+Math.random()*(T-I))}return{animationSequence:a,animationLoopAfterSequence:l,randomTimeOffset:A}}const c=n==null?void 0:n.runtimeAnimatorController;let d=c==null?void 0:c.findState(i),u=[],f=[];if(c&&d){const M=new Array;M.push(d);let A=!1;for(;M.length<100;){if(!d||d===null||!d.transitions||d.transitions.length===0){(y=d.motion)!=null&&y.isLooping&&(A=!0);break}const I=d.transitions.find(j=>j.conditions.length===0),T=I?c.getState(I.destinationState,0):null;if(T&&M.includes(T)){d=T,A=!0;break}else if(I){if(d=T,!d)break;M.push(d)}else{A=((b=d.motion)==null?void 0:b.isLooping)??!1;break}}if(A&&d){const I=M.indexOf(d);u=M.slice(0,I),f=M.slice(I),Jy&&console.log("found loop from "+i,"states until loop",u,"states looping",f)}else u=M,f=[],Jy&&console.log("found no loop from "+i,"states",u);if(!f.length){const I=u[u.length-1],T=(v=I.motion)==null?void 0:v.clip;if(T){let j;if(t.holdClipMap.has(T))j=t.holdClipMap.get(T);else{const F=I.name+"_hold";j=T.clone(),j.duration=1,j.name=F;const X=T.duration;j.tracks=T.tracks.map(E=>{const L=E.clone();L.times=new Float32Array([0,X]);const V=E.values.length,G=E.getValueSize(),K=E.values.slice(V-G,V);return L.values=new Float32Array(2*G),L.values.set(K,0),L.values.set(K,G),L}),j.name=F,t.holdClipMap.set(T,j)}if(j){const F={name:j.name,motion:{clip:j,isLooping:!1,name:j.name},speed:1,transitions:[],behaviours:[],hash:I.hash+1};f.push(F)}}}}if(u.length===1&&(!((w=u[0].motion)!=null&&w.clip)||((k=(P=u[0].motion)==null?void 0:P.clip.tracks)==null?void 0:k.length)===0)){a=new Array;const M=t.registerAnimation(e,null);M&&a.push(M);return}if(u=u.filter(M=>{var A,I,T;return((A=M.motion)==null?void 0:A.clip)&&((T=(I=M.motion)==null?void 0:I.clip.tracks)==null?void 0:T.length)>0}),f=f.filter(M=>{var A,I,T;return((A=M.motion)==null?void 0:A.clip)&&((T=(I=M.motion)==null?void 0:I.clip.tracks)==null?void 0:T.length)>0}),u.length===0&&f.length===0){console.warn("No clips found for state "+i+" on "+(n==null?void 0:n.name)+", can't export animation data");return}const m=(M,A)=>{if(!e)return;const I=t.registerAnimation(e,M.motion.clip??null);I?(I.speed=M.speed,A.push(I)):console.warn("Couldn't register animation for state "+M.name+" on "+(n==null?void 0:n.name))};if(u.length>0){a=new Array;for(const M of u)m(M,a)}if(f.length>0){l=new Array;for(const M of f)m(M,l)}let g=0;if(n&&c&&n.minMaxOffsetNormalized){const M=n.minMaxOffsetNormalized.x,A=n.minMaxOffsetNormalized.y,I=u.length?u[0]:f.length?f[0]:null;g=(((O=I==null?void 0:I.motion.clip)==null?void 0:O.duration)||1)*(M+Math.random()*(A-M))}return{animationSequence:a,animationLoopAfterSequence:l,randomTimeOffset:g}}createAnimation(t,e,i){if(!this.target||!this.animator&&!this.animation)return;const n=Cn.getAndRegisterAnimationSequences(t,this.target,this.stateName);n&&(this.animationSequence=n.animationSequence,this.animationLoopAfterSequence=n.animationLoopAfterSequence,this.randomOffsetNormalized=n.randomTimeOffset,this.stateAnimationModel=e)}},r(rd,"animationActions",[]),r(rd,"rootsWithExclusivePlayback",new Set),rd);let fr=Cn;je([p(xt)],fr.prototype,"animator",2);je([p()],fr.prototype,"stateName",2);class Ya extends D{constructor(){super(...arguments);r(this,"target")}getType(){}getDuration(){}}je([p(h.Object3D)],Ya.prototype,"target",2);class lh extends D{constructor(){super(...arguments);r(this,"target")}}je([p(Ya)],lh.prototype,"target",2);class ch extends Ya{constructor(){super(...arguments);r(this,"type",1);r(this,"duration",1)}getType(){switch(this.type){case 1:return"hide";case 0:return"show"}}getDuration(){return this.duration}}je([p()],ch.prototype,"type",2);je([p()],ch.prototype,"duration",2);class Lg extends lh{}const C_=class{constructor(){r(this,"_quicklookButton");r(this,"_arButton");r(this,"_vrButton");r(this,"_sendToQuestButton")}static create(){return new C_}static getOrCreate(){return this._instance||(this._instance=this.create()),this._instance}get isSecureConnection(){return window.location.protocol==="https:"}get quicklookButton(){return this._quicklookButton}get arButton(){return this._arButton}get vrButton(){return this._vrButton}get sendToQuestButton(){return this._sendToQuestButton}get qrButton(){return an.getOrCreate().createQRCode()}createQuicklookButton(){if(this._quicklookButton)return this._quicklookButton;const t=document.createElement("button");this._quicklookButton=t,t.dataset.needle="quicklook-button";const e=exports.DeviceUtilities.supportsQuickLookAR();t.innerText="View in AR",t.prepend(yt("view_in_ar"));let i=!1,n=null;return t.addEventListener("click",()=>{n=Yc(Le),n||(i=!0,n=new Le),i&&(n.objectToExport=Q.Current.scene),n?(t.classList.add("this-mode-is-requested"),n.exportAndOpen().then(()=>{t.classList.remove("this-mode-is-requested")}).catch(o=>{t.classList.remove("this-mode-is-requested"),console.error(o)})):console.warn("No USDZExporter component found in the scene")}),this.hideElementDuringXRSession(t),t}createARButton(t){var n;if(this._arButton)return this._arButton;const e="immersive-ar",i=document.createElement("button");return this._arButton=i,i.classList.add("webxr-button"),i.dataset.needle="webxr-ar-button",i.innerText="Enter AR",i.prepend(yt("view_in_ar")),i.title="Click to start an AR session",i.addEventListener("click",()=>q.start(e,t)),this.updateSessionSupported(i,e),this.listenToXRSessionState(i,e),this.hideElementDuringXRSession(i),this.isSecureConnection||(i.disabled=!0,i.title="WebXR requires a secure connection (HTTPS)"),exports.DeviceUtilities.isMozillaXR()||(n=navigator.xr)==null||n.addEventListener("devicechange",()=>this.updateSessionSupported(i,e)),i}createVRButton(t){var n;if(this._vrButton)return this._vrButton;const e="immersive-vr",i=document.createElement("button");return this._vrButton=i,i.classList.add("webxr-button"),i.dataset.needle="webxr-vr-button",i.innerText="Enter VR",i.prepend(yt("panorama_photosphere")),i.title="Click to start a VR session",i.addEventListener("click",()=>q.start(e,t)),this.updateSessionSupported(i,e),this.listenToXRSessionState(i,e),this.hideElementDuringXRSession(i),this.isSecureConnection||(i.disabled=!0,i.title="WebXR requires a secure connection (HTTPS)"),exports.DeviceUtilities.isMozillaXR()||(n=navigator.xr)==null||n.addEventListener("devicechange",()=>this.updateSessionSupported(i,e)),i}createSendToQuestButton(){var i;if(this._sendToQuestButton)return this._sendToQuestButton;const t="https://oculus.com/open_url/?url=",e=document.createElement("button");return this._sendToQuestButton=e,e.dataset.needle="webxr-sendtoquest-button",e.innerText="Open on Quest",e.prepend(yt("share_windows")),e.title="Click to send this page to the Oculus Browser on your Quest",e.addEventListener("click",()=>{const n=encodeURIComponent(window.location.href),o=t+n;window.open(o)==null&&Te("This page doesn't allow popups. Please paste "+o+" into your browser.")}),this.listenToXRSessionState(e),this.hideElementDuringXRSession(e),exports.DeviceUtilities.isMozillaXR()||(i=navigator.xr)==null||i.addEventListener("devicechange",()=>{var n;(n=navigator.xr)!=null&&n.isSessionSupported("immersive-vr")?e.style.display="none":e.style.display=""}),e}createQRCode(){return an.getOrCreate().createQRCode()}updateSessionSupported(t,e){if(!("xr"in navigator)){t.style.display="none";return}q.isSessionSupported(e).then(i=>{t.style.display=i?"":"none",B()&&!i&&console.log('[WebXR] "'+e+'" is not supported on this device – make sure your server runs using HTTPS and you have a device connected that supports '+e)})}hideElementDuringXRSession(t){Su(e=>{t["previous-display"]=t.style.display,t.style.display="none"}),Nm(e=>{t["previous-display"]!=null&&(t.style.display=t["previous-display"])})}listenToXRSessionState(t,e){e&&(q.onSessionRequestStart(i=>{i.mode===e?t.classList.add("this-mode-is-requested"):(t["was-disabled"]=t.disabled,t.disabled=!0,t.classList.add("other-mode-is-requested"))}),q.onSessionRequestEnd(i=>{t.classList.remove("this-mode-is-requested"),t.classList.remove("other-mode-is-requested"),t.disabled=t["was-disabled"]}))}};let _s=C_;r(_s,"_instance");var _M=Object.defineProperty,yM=Object.getOwnPropertyDescriptor,ht=(s,t,e,i)=>{for(var n=i>1?void 0:i?yM(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&_M(t,e,n),n};const iu=x("debugspriterenderer"),bM=x("wireframe"),mu=class{static getOrCreateGeometry(t){if(t.__cached_geometry)return t.__cached_geometry;if(t.guid&&mu.cache[t.guid])return iu&&console.log("Take cached geometry for sprite",t.guid),mu.cache[t.guid];const e=new h.BufferGeometry;t.__cached_geometry=e;const i=new Float32Array(t.triangles.length*3),n=new Float32Array(t.triangles.length*2);for(let o=0;o<t.triangles.length;o+=1){const a=t.triangles[o];i[o*3]=-t.vertices[a].x,i[o*3+1]=t.vertices[a].y,i[o*3+2]=0;const l=t.uv[a];n[o*2]=l.x,n[o*2+1]=1-l.y}return e.setAttribute("position",new h.BufferAttribute(i,3)),e.setAttribute("uv",new h.BufferAttribute(n,2)),t.guid&&(this.cache[t.guid]=e),iu&&console.log("Built sprite geometry",t,e),e}};let sr=mu;r(sr,"cache",{});class vM{constructor(){r(this,"x");r(this,"y")}}function mw(s){s&&(s.colorSpace!=h.SRGBColorSpace&&(s.colorSpace=h.SRGBColorSpace,s.needsUpdate=!0),s.minFilter==h.NearestFilter&&s.magFilter==h.NearestFilter&&(s.anisotropy=1,s.needsUpdate=!0))}let Cs=class{constructor(t){r(this,"guid");r(this,"texture");r(this,"triangles");r(this,"uv");r(this,"vertices");r(this,"__cached_geometry");r(this,"_mesh");r(this,"_material");t&&(this.texture=t,this.triangles=[0,1,2,0,2,3],this.uv=[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:0,y:1}],this.vertices=[{x:-.5,y:-.5},{x:.5,y:-.5},{x:.5,y:.5},{x:-.5,y:.5}])}get mesh(){return this._mesh||(this._mesh=new h.Mesh(sr.getOrCreateGeometry(this),this.material)),this._mesh}get material(){return this._material||(this.texture&&mw(this.texture),this._material=new h.MeshBasicMaterial({map:this.texture,color:16777215,side:h.DoubleSide,transparent:!0})),this._material}getGeometry(){return sr.getOrCreateGeometry(this)}};ht([p()],Cs.prototype,"guid",2);ht([p(h.Texture)],Cs.prototype,"texture",2);ht([yr()],Cs.prototype,"triangles",2);ht([yr()],Cs.prototype,"uv",2);ht([yr()],Cs.prototype,"vertices",2);const Qf=Symbol("spriteOwner");class ja{constructor(){r(this,"sprites");this.sprites=[]}}ht([p(Cs)],ja.prototype,"sprites",2);const hm=class{constructor(){r(this,"spriteSheet");r(this,"index",0)}static create(){const s=new hm;return s.spriteSheet=new ja,s}clone(){const s=new hm;return s.index=this.index,s.spriteSheet=this.spriteSheet,s}set sprite(s){s&&(this.spriteSheet?((this.index===null||this.index===void 0)&&(this.index=0),this.spriteSheet.sprites[this.index]=s):(this.spriteSheet=new ja,this.spriteSheet.sprites=[s],this.index=0))}get sprite(){if(this.spriteSheet)return this.spriteSheet.sprites[this.index]}update(s){if(!this.spriteSheet)return;const t=this.index;if(t<0||t>=this.spriteSheet.sprites.length)return;const e=this.spriteSheet.sprites[t],i=e==null?void 0:e.texture;if(i&&(mw(i),!e.__hasLoadedProgressive)){e.__hasLoadedProgressive=!0;const n=i;re.NEEDLE_progressive.assignTextureLOD(i,0).then(o=>{o instanceof h.Texture&&(e.texture=o,(s==null?void 0:s.map)===n&&(s.map=o,s.needsUpdate=!0))})}}};let ao=hm;ht([p(ja)],ao.prototype,"spriteSheet",2);ht([p()],ao.prototype,"index",2);class ai extends D{constructor(){super(...arguments);r(this,"drawMode",0);r(this,"size",{x:1,y:1});r(this,"color");r(this,"sharedMaterial");r(this,"transparent",!0);r(this,"cutoutThreshold",0);r(this,"castShadows",!1);r(this,"renderOrder",0);r(this,"toneMapped",!0);r(this,"_spriteSheet");r(this,"_currentSprite")}set texture(e){var n;if(!this._spriteSheet)return;const i=(n=this._spriteSheet.spriteSheet)==null?void 0:n.sprites[this.spriteIndex];i&&(i.texture=e,this.updateSprite())}addSprite(e,i=!1){var o,a;if(this._spriteSheet||(this._spriteSheet=ao.create()),!this._spriteSheet.spriteSheet)return-1;(o=this._spriteSheet.spriteSheet)==null||o.sprites.push(e);const n=((a=this._spriteSheet.spriteSheet)==null?void 0:a.sprites.length)-1;return i&&(this.spriteIndex=n),n}get sprite(){return this._spriteSheet}set sprite(e){if(e!==this._spriteSheet)if(typeof e=="number"){const i=Math.floor(e);this.spriteIndex=i}else e instanceof Cs?(this._spriteSheet||(this._spriteSheet=ao.create()),this._spriteSheet.sprite!=e&&(this._spriteSheet.sprite=e),this.updateSprite()):e!=this._spriteSheet&&(this._spriteSheet=e,this.updateSprite())}set spriteIndex(e){this._spriteSheet&&(this._spriteSheet.index=e,this.updateSprite())}get spriteIndex(){var e;return((e=this._spriteSheet)==null?void 0:e.index)??0}get spriteFrames(){var e,i;return((i=(e=this._spriteSheet)==null?void 0:e.spriteSheet)==null?void 0:i.sprites.length)??0}awake(){this._currentSprite=void 0,this._spriteSheet?this._spriteSheet=this._spriteSheet.clone():this._spriteSheet=ao.create(),iu&&console.log("Awake",this.name,this,this.sprite)}start(){this._currentSprite?this.gameObject&&this.gameObject.add(this._currentSprite):this.updateSprite()}updateSprite(e=!1){var o;if(!this.__didAwake&&!e)return!1;const i=this._spriteSheet;if(!((o=i==null?void 0:i.spriteSheet)!=null&&o.sprites))return console.warn("SpriteRenderer has no data or spritesheet assigned..."),!1;const n=i.spriteSheet.sprites[this.spriteIndex];if(!n)return iu&&console.warn("Sprite not found",this.spriteIndex,i.spriteSheet.sprites),!1;if(this._currentSprite)this._currentSprite.geometry=sr.getOrCreateGeometry(n),this._currentSprite.material.map=n.texture;else{const a=new h.MeshBasicMaterial({color:16777215,side:h.DoubleSide});if(bM&&(a.wireframe=!0),this.color&&(a.color||(a.color=new h.Color),a.color.copy(this.color),a.opacity=this.color.alpha),a.transparent=!0,a.toneMapped=this.toneMapped,a.depthWrite=!1,n.texture&&!a.wireframe){let l=n.texture;l[Qf]!==void 0&&l[Qf]!==this&&this.spriteFrames>1&&(l=n.texture=l.clone()),l[Qf]=this,a.map=l}this.sharedMaterial=a,this._currentSprite=new h.Mesh(sr.getOrCreateGeometry(n),a),this._currentSprite.renderOrder=Math.round(this.renderOrder),re.NEEDLE_progressive.assignTextureLOD(a,0)}return this._currentSprite.parent!==this.gameObject&&(this.drawMode===2&&this._currentSprite.scale.set(this.size.x,this.size.y,1),this.gameObject&&this.gameObject.add(this._currentSprite)),this._currentSprite&&this._currentSprite.layers.set(this.layer),this.sharedMaterial&&(this.sharedMaterial.alphaTest=this.cutoutThreshold,this.sharedMaterial.transparent=this.transparent),this._currentSprite.castShadow=this.castShadows,i==null||i.update(this.sharedMaterial),!0}}ht([p()],ai.prototype,"drawMode",2);ht([p(vM)],ai.prototype,"size",2);ht([p(me)],ai.prototype,"color",2);ht([p(h.Material)],ai.prototype,"sharedMaterial",2);ht([p()],ai.prototype,"transparent",2);ht([p()],ai.prototype,"cutoutThreshold",2);ht([p()],ai.prototype,"castShadows",2);ht([p()],ai.prototype,"renderOrder",2);ht([p()],ai.prototype,"toneMapped",2);ht([p(ao)],ai.prototype,"sprite",1);const eb=x("debugwebxr"),wM=new h.Matrix4().makeRotationY(Math.PI),ma=class extends D{constructor(){super(...arguments);r(this,"_arScale",1);r(this,"invertForward",!1);r(this,"customReticle");r(this,"arTouchTransform",!0);r(this,"autoPlace",!1);r(this,"autoCenter",!1);r(this,"useXRAnchor",!1);r(this,"_isPlacing",!0);r(this,"_startOffset",new h.Matrix4);r(this,"_createdPlacementObject",null);r(this,"_reparentedComponents",[]);r(this,"_placementScene",new h.Scene);r(this,"_reticle",[]);r(this,"_hits",[]);r(this,"_placementStartTime",-1);r(this,"_rigPlacementMatrix");r(this,"_anchor",null);r(this,"userInput");r(this,"onPlaceScene",e=>{var o;if(this._isPlacing==!1||e!=null&&e.used)return;let i=this._reticle[0];if(!i){console.warn("No reticle to place...");return}if(!i.visible&&!this.autoPlace){console.warn("Reticle is not visible (can not place)");return}if((o=q.active)!=null&&o.isTrackingImages){console.warn("Scene Placement is disabled while images are being tracked");return}let n=this._hits[0];if(e&&e.origin instanceof Vm){const a=this._reticle[e.origin.index];a&&(i=a,n=this._hits[e.origin.index])}if(e&&(e.stopImmediatePropagation(),e.stopPropagation(),e.use()),this._isPlacing=!1,this.context.input.removeEventListener("pointerup",this.onPlaceScene),this.onRevertSceneChanges(),i.position.copy(i.lastPos),i.quaternion.copy(i.lastQuat),this.onApplyPose(i),ma._hasPlaced=!0,this.useXRAnchor&&this.onCreateAnchor(q.active,n),this.context.xr)for(const a of this.context.xr.controllers)a.cancelHitTestSource()});r(this,"upVec",new h.Vector3(0,1,0));r(this,"lookPoint",new h.Vector3);r(this,"worldUpVec",new h.Vector3(0,1,0))}static onPlaced(e){const i="placed";return this._eventListeners[i]||(this._eventListeners[i]=[]),this._eventListeners[i].push(e),()=>{const n=this._eventListeners[i].indexOf(e);n>=0&&this._eventListeners[i].splice(n,1)}}static get hasPlaced(){return this._hasPlaced}get arScale(){return this._arScale}set arScale(e){this._arScale=Math.max(1e-6,e),this.onSetScale()}onEnable(){var e;(e=this.customReticle)==null||e.preload()}supportsXR(e){return e==="immersive-ar"}onEnterXR(e){eb&&console.log("ENTER WEBXR: SessionRoot start..."),this._anchor=null,ma._hasPlaced=!1,this.gameObject.updateMatrixWorld(),this._startOffset.copy(this.gameObject.matrixWorld);const i=new h.Object3D;this._createdPlacementObject=i,i.name="AR Session Root",this._placementScene.name="AR Placement Scene",this._placementScene.children.length=0;for(let n=this.context.scene.children.length-1;n>=0;n--){const o=this.context.scene.children[n];this._placementScene.add(o)}if(this.context.scene.add(i),this.autoCenter){const n=si(this._placementScene.children),o=n.getCenter(new h.Vector3),a=n.getSize(new h.Vector3),l=new h.Matrix4;l.makeTranslation(o.x,o.y-a.y*.5,o.z),this._startOffset.multiply(l)}this._reparentedComponents.length=0,this._reparentedComponents.push({comp:this,originalObject:this.gameObject}),S.addComponent(i,this);for(const n of this._reticle)Si(n);this._reticle.length=0,this._isPlacing=!0,this.context.input.addEventListener("pointerup",this.onPlaceScene,{queue:ei.Early})}onLeaveXR(){this.context.input.removeEventListener("pointerup",this.onPlaceScene,{queue:ei.Early}),this.onRevertSceneChanges(),this._anchor=null,ma._hasPlaced=!1,this._rigPlacementMatrix=void 0}onUpdateXR(e){var i,n,o,a;if(e.xr.isTrackingImages){for(const l of this._reticle)l.visible=!1;return}if(this._isPlacing){const l=(i=e.xr.rig)==null?void 0:i.gameObject;l&&l.parent!==this.context.scene&&this.context.scene.add(l);let c=!1;if(e.xr.isPassThrough&&e.xr.controllers.length>0&&!this.autoPlace)for(const d of e.xr.controllers){const u=d.getHitTest();u&&(c=!0,this.updateReticleAndHits(e.xr,d.index,u,e.xr.rigScale))}if(!c){const d=e.xr.getHitTest();d&&this.updateReticleAndHits(e.xr,0,d,e.xr.rigScale)}}else{if(this._anchor&&e.xr.referenceSpace){const l=e.xr.frame.getPose(this._anchor.anchorSpace,e.xr.referenceSpace);if(l&&this.context.time.frame%20===0){const c=e.xr.convertSpace(l.transform),d=this._reticle[0];d&&(d.position.copy(c.position),d.quaternion.copy(c.quaternion),this.onApplyPose(d))}}if(this.arTouchTransform?(this.userInput||(this.userInput=new aa(this.context)),(n=this.userInput)==null||n.enable()):(o=this.userInput)==null||o.disable(),this.arTouchTransform&&((a=this.userInput)!=null&&a.hasChanged)){if(e.xr.rig){const l=e.xr.rig.gameObject;this.userInput.applyMatrixTo(l.matrix,!0),l.matrix.decompose(l.position,l.quaternion,l.scale),this.userInput.factor=l.scale.x}this.userInput.reset()}}}updateReticleAndHits(e,i,n,o){this._hits[i]=n.hit;let a=this._reticle[i];if(!a){if(this.customReticle)if(this.customReticle.asset)a=dr(this.customReticle.asset);else{this.customReticle.loadAssetAsync();return}else a=new h.Mesh(new h.RingGeometry(.07,.09,32).rotateX(-Math.PI/2),new h.MeshBasicMaterial({side:h.DoubleSide,depthTest:!1,depthWrite:!1,transparent:!0,opacity:1,color:15658734})),a.name="AR Placement Reticle";if(eb){const l=new h.AxesHelper(1);l.position.y+=.01,a.add(l)}this._reticle[i]=a,a.matrixAutoUpdate=!1,a.visible=!1}if(a.lastPos=a.lastPos||n.position.clone(),a.lastQuat=a.lastQuat||n.quaternion.clone(),a.position.copy(a.lastPos.lerp(n.position,this.context.time.deltaTime/.1)),a.lastPos.copy(a.position),a.quaternion.copy(a.lastQuat.slerp(n.quaternion,this.context.time.deltaTime/.05)),a.lastQuat.copy(a.quaternion),a.scale.set(o,o,o),this.customReticle&&this.applyViewBasedTransform(a),a.updateMatrix(),a.visible=!0,a.parent!==this.context.scene&&this.context.scene.add(a),this._placementStartTime<0&&(this._placementStartTime=this.context.time.realtimeSinceStartup),this.autoPlace)if(this.upVec.set(0,1,0).applyQuaternion(a.quaternion),this.upVec.dot($(0,1,0))>.9){let c=a["autoplace:timer"]||0;c>=1?(a.visible=!1,this.onPlaceScene(null)):(c+=this.context.time.deltaTime,a["autoplace:timer"]=c)}else a["autoplace:timer"]=0}onSetScale(){var i,n,o;if(!ma._hasPlaced)return;const e=(n=(i=q.active)==null?void 0:i.rig)==null?void 0:n.gameObject;if(e){const a=((o=q.active)==null?void 0:o.rigScale)||1,l=1/this._arScale*a,c=new h.Matrix4().makeScale(l,l,l).invert();e.matrix.premultiply(c),e.matrix.decompose(e.position,e.quaternion,e.scale)}}onRevertSceneChanges(){var e;for(const i of this._reticle)i&&(i.visible=!1,i==null||i.removeFromParent());this._reticle.length=0;for(let i=this._placementScene.children.length-1;i>=0;i--){const n=this._placementScene.children[i];this.context.scene.add(n)}(e=this._createdPlacementObject)==null||e.removeFromParent();for(const i of this._reparentedComponents)S.addComponent(i.originalObject,i.comp)}async onCreateAnchor(e,i){if(i.createAnchor===void 0){console.warn("Hit does not support creating an anchor",i),B()&&pe("Hit does not support creating an anchor");return}else{const n=await i.createAnchor(e.viewerPose.transform);e.running&&n&&(this._anchor=n)}}applyViewBasedTransform(e){const i=this.context.mainCamera,n=e,o=i.worldPosition,a=n.worldPosition;this.upVec.set(0,1,0).applyQuaternion(e.quaternion);const l=i.worldPosition;l&&e.position.clone().sub(l).angleTo(this.upVec)<Math.PI/2&&this.upVec.negate();const c=this.upVec.angleTo(this.worldUpVec)*180/Math.PI,d=30;c>d&&c<180-d||c<-d&&c>-180+d?(this.lookPoint.copy(e.position).add(this.upVec),this.lookPoint.y=e.position.y,e.lookAt(this.lookPoint)):(o.y=a.y,e.lookAt(o))}onApplyPose(e){var o,a,l;const i=(a=(o=q.active)==null?void 0:o.rig)==null?void 0:a.gameObject;if(!i){console.warn("No rig object to place");return}const n=i.parent||this.context.scene;this._rigPlacementMatrix?(l=this._rigPlacementMatrix)==null||l.decompose(i.position,i.quaternion,i.scale):this._rigPlacementMatrix=i.matrix.clone(),this.applyViewBasedTransform(e),e.updateMatrix(),this.context.scene.add(e),e.attach(i),e.removeFromParent(),i.scale.set(this.arScale,this.arScale,this.arScale),i.position.multiplyScalar(this.arScale),i.updateMatrix(),this.invertForward&&i.matrix.premultiply(wM),i.matrix.premultiply(this._startOffset),i.matrix.decompose(i.position,i.quaternion,i.scale),n.add(i)}};let Ni=ma;r(Ni,"_eventListeners",{}),r(Ni,"_hasPlaced",!1);const gu=class{constructor(t){r(this,"oneFingerDrag",!0);r(this,"twoFingerRotate",!0);r(this,"twoFingerScale",!0);r(this,"factor",1);r(this,"context");r(this,"offset");r(this,"plane");r(this,"_scale",1);r(this,"_hasChanged",!1);r(this,"_enabled",!1);r(this,"currentlyUsedPointerIds",new Set);r(this,"currentlyUnusedPointerIds",new Set);r(this,"onPointerDownEarly",t=>{this.isActive&&t.stopPropagation()});r(this,"onPointerDownLate",t=>{t.used?this.currentlyUsedPointerIds.add(t.pointerId):this.currentlyUsedPointerIds.size<=0&&this.currentlyUnusedPointerIds.add(t.pointerId)});r(this,"onPointerUpEarly",t=>{this.currentlyUsedPointerIds.delete(t.pointerId),this.currentlyUnusedPointerIds.delete(t.pointerId)});r(this,"prev",new Map);r(this,"_didMultitouch",!1);r(this,"touchStart",t=>{if(!t.defaultPrevented)for(let e=0;e<t.changedTouches.length;e++){const i=t.changedTouches[e],n=exports.DeviceUtilities.isAndroidDevice()&&i.clientY<window.innerHeight*.1;this.prev.has(i.identifier)||this.prev.set(i.identifier,{ignore:n,x:0,z:0,screenx:0,screeny:0});const o=this.prev.get(i.identifier);if(o){const a=this.getPositionOnPlane(i.clientX,i.clientY);o.x=a.x,o.z=a.z,o.screenx=i.clientX,o.screeny=i.clientY}}});r(this,"touchEnd",t=>{t.touches.length<=0&&(this._didMultitouch=!1);for(let e=0;e<t.changedTouches.length;e++){const i=t.changedTouches[e];this.prev.delete(i.identifier)}});r(this,"touchMove",t=>{if(!t.defaultPrevented&&this.isActive){if(t.touches.length===1){if(this._didMultitouch)return;const e=t.touches[0],i=this.prev.get(e.identifier);if(!i||i.ignore)return;const n=this.getPositionOnPlane(e.clientX,e.clientY),o=n.x-i.x,a=n.z-i.z;if(o===0&&a===0)return;this.oneFingerDrag&&this.addMovement(o,a),i.x=n.x,i.z=n.z,i.screenx=e.clientX,i.screeny=e.clientY;return}else if(t.touches.length===2){this._didMultitouch=!0;const e=t.touches[0],i=t.touches[1],n=this.prev.get(e.identifier),o=this.prev.get(i.identifier);if(!n||!o)return;if(this.twoFingerRotate){const a=Math.atan2(e.clientY-i.clientY,e.clientX-i.clientX),l=Math.atan2(n.screeny-o.screeny,n.screenx-o.screenx),c=a-l;Math.abs(c)>.001&&this.addRotation(c)}if(this.twoFingerScale){const a=e.clientX-i.clientX,l=e.clientY-i.clientY,c=Math.sqrt(a*a+l*l),d=n.screenx-o.screenx,u=n.screeny-o.screeny,f=Math.sqrt(d*d+u*u),m=c-f;Math.abs(m)>2&&this.addScale(m)}n.screenx=e.clientX,n.screeny=e.clientY,o.screenx=i.clientX,o.screeny=i.clientY}}});r(this,"_raycaster",new h.Raycaster);r(this,"_intersection",new h.Vector3);r(this,"_screenPos",new h.Vector3);r(this,"_tempMatrix",new h.Matrix4);this.context=t,this.offset=new h.Matrix4,this.plane=new h.Plane,this.plane.setFromNormalAndCoplanarPoint(gu.up,gu.zero)}get scale(){return this._scale}reset(){this._scale=1,this.offset.identity(),this._hasChanged=!0}get hasChanged(){return this._hasChanged}applyMatrixTo(t,e){this._hasChanged=!1,e?(this.offset.invert(),t.premultiply(this.offset)):t.multiply(this.offset)}get isActive(){return this.currentlyUsedPointerIds.size<=0&&this.currentlyUnusedPointerIds.size>0}enable(){this._enabled||(this._enabled=!0,this.context.input.addEventListener("pointerdown",this.onPointerDownEarly,{queue:ei.Early}),this.context.input.addEventListener("pointerdown",this.onPointerDownLate,{queue:ei.Late}),this.context.input.addEventListener("pointerup",this.onPointerUpEarly,{queue:ei.Early}),window.addEventListener("touchstart",this.touchStart,{passive:!1}),window.addEventListener("touchmove",this.touchMove,{passive:!1}),window.addEventListener("touchend",this.touchEnd,{passive:!1}))}disable(){this._enabled&&(this._enabled=!1,this.context.input.removeEventListener("pointerdown",this.onPointerDownEarly,{queue:ei.Early}),this.context.input.removeEventListener("pointerdown",this.onPointerDownLate,{queue:ei.Late}),this.context.input.removeEventListener("pointerup",this.onPointerUpEarly,{queue:ei.Early}),window.removeEventListener("touchstart",this.touchStart),window.removeEventListener("touchmove",this.touchMove),window.removeEventListener("touchend",this.touchEnd))}getPositionOnPlane(t,e){const i=this.context.mainCamera;return this._screenPos.x=t/window.innerWidth*2-1,this._screenPos.y=-(e/window.innerHeight)*2+1,this._screenPos.z=1,this._screenPos.unproject(i),this._raycaster.set(i.position,this._screenPos.sub(i.position)),this._raycaster.ray.intersectPlane(this.plane,this._intersection),this._intersection}addMovement(t,e){t/=this._scale,e/=this._scale,t*=this.factor,e*=this.factor,this.offset.elements[12]+=t,this.offset.elements[14]+=e,(t!==0||e!==0)&&(this._hasChanged=!0)}addScale(t){t/=window.innerWidth,t*=-1,this._scale*=1+t,this._tempMatrix.makeScale(1-t,1-t,1-t),this.offset.premultiply(this._tempMatrix),t!==0&&(this._hasChanged=!0)}addRotation(t){t*=-1,this._tempMatrix.makeRotationY(t),this.offset.premultiply(this._tempMatrix),t!==0&&(this._hasChanged=!0)}};let aa=gu;r(aa,"up",new h.Vector3(0,1,0)),r(aa,"zero",new h.Vector3(0,0,0)),r(aa,"one",new h.Vector3(1,1,1));const qs=x("debugautosync"),Yf=Symbol("syncerId");class xM{constructor(){r(this,"_syncers",{})}getOrCreateSyncer(t){if(!t.guid)return null;if(this._syncers[t.guid])return this._syncers[t.guid];const e=new SM(t);return e[Yf]=t.guid,this._syncers[e[Yf]]=e,e}removeSyncer(t){delete this._syncers[t[Yf]]}}const Ig=new xM;class SM{constructor(t){r(this,"comp");r(this,"hasChanges",!1);r(this,"changedProperties",{});r(this,"_isReceiving",!1);r(this,"_isInit",!1);r(this,"onHandleSending",()=>{if(!this.hasChanges)return;this.hasChanges=!1;const t=this.comp.context.connection;if(!t||!t.isConnected||!t.isInRoom){for(const e in this.changedProperties)delete this.changedProperties[e];return}for(const e in this.changedProperties){const i=this.changedProperties[e];qs&&console.log("SEND",this.comp.guid,this.networkingKey),t.send(this.networkingKey,{guid:this.comp.guid,property:e,data:i},rn.Queued),delete this.changedProperties[e]}});r(this,"onHandleReceiving",t=>{if(qs&&console.log("SYNCFIELD RECEIVE",this.comp.name,this.comp.guid,t),!!this._isInit&&this.comp&&t.guid===this.comp.guid)try{this._isReceiving=!0,this.comp[t.property]=t.data}catch(e){console.error(e)}finally{this._isReceiving=!1}});this.comp=t}get networkingKey(){return this.comp.guid}init(t){if(this._isInit)return;this._isInit=!0,this.comp=t,this.comp.context.post_render_callbacks.push(this.onHandleSending),this.comp.context.connection.beginListen(this.networkingKey,this.onHandleReceiving);const e=this.comp.context.connection.tryGetState(this.comp.guid);e&&this.onHandleReceiving(e)}destroy(){this._isInit&&(this.comp.context.post_render_callbacks.splice(this.comp.context.post_render_callbacks.indexOf(this.onHandleSending),1),this.comp.context.connection.stopListen(this.networkingKey,this.onHandleReceiving),this.comp=null,this._isInit=!1)}notifyChanged(t,e){this._isReceiving||(qs&&console.log("Property changed: "+t,e),this.hasChanges=!0,this.changedProperties[t]=e)}}function CM(s,t){let e=t!==s;return!e&&s&&t&&(Array.isArray(s)&&Array.isArray(t)||typeof s=="object"&&typeof t=="object")&&(e=!0),e}const cc=Symbol("AutoSyncHandler");function PM(s){if(s[cc])return s[cc];const t=Ig.getOrCreateSyncer(s);return t==null||t.init(s),s[cc]=t,t}function OM(s){const t=s[cc];t&&(Ig.removeSyncer(t),t.destroy(),delete s[cc])}const jg=function(s=null){return function(t,e){var u;let i="";typeof e=="string"?i=e:i=e.name;let n=null,o;typeof s=="string"?o=t[s]:typeof s=="function"&&(o=s),o==null&&(B()||qs)&&s!=null&&console.warn('syncField: no callback function found for property "'+i+'"','"'+s+'"');const a=t,l=a.__internalAwake;if(typeof l!="function"){(qs||B())&&console.error('@syncField can currently only used on Needle Engine Components, custom object of type "'+((u=t==null?void 0:t.constructor)==null?void 0:u.name)+'" is not supported',t);return}qs&&console.log(i);const c=Symbol(i);a.__internalAwake=function(){if(this[c]!==void 0)return;this[c]=this[i],n=Ig.getOrCreateSyncer(this);const f=Object.getOwnPropertyDescriptor(this,i);if((f==null?void 0:f.set)===void 0){let m=!1;Object.defineProperty(this,i,{set:function(g){var y;const _=this[c];if(this[c]=g,m){(B()||qs)&&console.warn("Recursive call detected",i);return}m=!0;try{const b=CM(g,_);qs&&console.log("SyncField assignment",i,"changed?",b,g,o),b&&(o==null?void 0:o.call(this,g,_))!==!1&&((y=PM(this))==null||y.notifyChanged(i,g))}finally{m=!1}},get:function(){return this[c]},configurable:!0,enumerable:!0})}n==null||n.init(this),l.call(this)};const d=a.__internalDestroy;a.__internalDestroy=function(){OM(this),d.call(this)}}};var MM=Object.defineProperty,RM=Object.getOwnPropertyDescriptor,Vu=(s,t,e,i)=>{for(var n=i>1?void 0:i?RM(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&MM(t,e,n),n};const Nt=x("debugplayersync"),gw=class extends D{constructor(){super(...arguments);r(this,"autoSync",!0);r(this,"asset");r(this,"onPlayerSpawned");r(this,"_localInstance");r(this,"onJoinedRoom",()=>{Nt&&console.log("PlayerSync.joinedRoom. autoSync is set to "+this.autoSync),this.autoSync&&this.getInstance()});r(this,"destroyInstance",()=>{var t;(t=this._localInstance)==null||t.then(e=>{Nt&&console.log("PlayerSync.destroyInstance",e),Gc(e,this.context.connection,!0,{saveInRoom:!1})}),this._localInstance=void 0})}static async setupFrom(t,e){const i=ee.getOrCreateFromUrl(t);if(!i.asset){const a=await i.loadAssetAsync();a&&S.getOrAddComponent(a,vi)}const n=new gw;n._internalInit(e),n.asset=i;const o=new h.Object3D;return o.guid=t,S.addComponent(o,n),n}awake(){this.watchTabVisible(),this.onPlayerSpawned||(this.onPlayerSpawned=new ge)}onEnable(){this.context.connection.beginListen(J.RoomStateSent,this.onJoinedRoom),this.context.connection.beginListen(J.JoinedRoom,this.onJoinedRoom),this.context.connection.beginListen(J.LeftRoom,this.destroyInstance),this.context.connection.isInRoom&&this.onJoinedRoom()}onDisable(){this.context.connection.stopListen(J.RoomStateSent,this.onJoinedRoom),this.context.connection.stopListen(J.JoinedRoom,this.onJoinedRoom),this.context.connection.stopListen(J.LeftRoom,this.destroyInstance)}async getInstance(){var e,i,n,o,a,l;if(this._localInstance)return this._localInstance;if(Nt&&console.log("PlayerSync.createInstance",(e=this.asset)==null?void 0:e.url),!((i=this.asset)!=null&&i.asset)&&!((n=this.asset)!=null&&n.url))return console.error('PlayerSync: can not create an instance because "asset" is not set and or has no URL!'),null;this.gameObject.guid||console.warn("PlayerSync: gameObject has no guid! This might cause issues with syncing the player state."),this._localInstance=(o=this.asset)==null?void 0:o.instantiateSynced({parent:this.gameObject,deleteOnDisconnect:!0},!0);const t=await this._localInstance;if(t){const c=S.getComponentsInChildren(t,vi);if(Nt&&console.log(`PlayerSync.createInstance: found ${c==null?void 0:c.length} PlayerState components. Owner: ${this.context.connection.connectionId}`),c!=null&&c.length){for(const d of c)d.owner=this.context.connection.connectionId;(a=this.onPlayerSpawned)==null||a.invoke(t)}else this._localInstance=void 0,console.error("<strong>Failed finding PlayerState on "+((l=this.asset)==null?void 0:l.url)+"</strong>: please make sure the asset has a PlayerState component!"),S.destroySynced(t)}else this._localInstance=void 0,console.warn("PlayerSync: failed instantiating asset!");return this._localInstance}watchTabVisible(){window.addEventListener("visibilitychange",t=>{if(document.visibilityState==="visible")for(let e=vi.all.length-1;e>=0;e--){const i=vi.all[e];(!i.owner||!this.context.connection.userIsInRoom(i.owner))&&i.doDestroy()}})}};let Ka=gw;Vu([p()],Ka.prototype,"autoSync",2);Vu([p(ee)],Ka.prototype,"asset",2);Vu([p(ge)],Ka.prototype,"onPlayerSpawned",2);var _w=(s=>(s.OwnerChanged="ownerChanged",s))(_w||{}),Dl;const mt=(Dl=class extends D{constructor(){super(...arguments);r(this,"onOwnerChangeEvent",new ge);r(this,"onFirstOwnerChangeEvent",new ge);r(this,"hasOwner",!1);r(this,"owner");r(this,"dontDestroy",!1);r(this,"onUserLeftRoom",t=>{if(t.userId===this.owner){Nt&&console.log("PLAYERSYNC LEFT",this.owner),this.doDestroy();return}})}static get all(){return mt._all}static get local(){return mt._local}static getFor(t){if(t instanceof h.Object3D)return S.getComponentInParent(t,mt);if(t instanceof D)return S.getComponentInParent(t.gameObject,mt)}static isLocalPlayer(t){const e=mt.getFor(t);return(e==null?void 0:e.isLocalPlayer)??!1}static addEventListener(t,e){return this._callbacks[t]||(this._callbacks[t]=[]),this._callbacks[t].push(e),e}static removeEventListener(t,e){if(!this._callbacks[t])return;const i=this._callbacks[t].indexOf(e);i>=0&&this._callbacks[t].splice(i,1)}static dispatchEvent(t,e){if(this._callbacks[t])for(const i of this._callbacks[t])i(e)}get isLocalPlayer(){return this.owner===this.context.connection.connectionId}onOwnerChange(t,e){var a,l;Nt&&console.log(`PlayerSync.onOwnerChange: ${e} → ${t} (me: ${this.context.connection.connectionId})`);const i=mt._local.indexOf(this);i>=0&&mt._local.splice(i,1);const n={playerState:this,oldValue:e,newValue:t};if(this.hasOwner||(this.hasOwner=!0,(a=this.onFirstOwnerChangeEvent)==null||a.invoke(n)),(l=this.onOwnerChangeEvent)==null||l.invoke(n),this.owner===this.context.connection.connectionId){mt._local.push(this);const c=new CustomEvent("local-owner-changed",{detail:n});this.dispatchEvent(c)}const o=new CustomEvent("owner-changed",{detail:n});this.dispatchEvent(o),mt.dispatchEvent("ownerChanged",o)}awake(){mt.all.push(this),Nt&&console.log("Registered new PlayerState",this.guid,mt.all.length-1,mt.all),this.context.connection.beginListen(J.UserLeftRoom,this.onUserLeftRoom)}async start(){Nt&&console.log("PLAYERSTATE.START, owner: "+this.owner,this.context.connection.usersInRoom([])),this.owner?(this.context.connection.isInRoom||await un(300),this.context.connection.userIsInRoom(this.owner)==!1&&(Nt&&console.log(`PlayerSync.start → doDestroy "${this.name}" because user "${this.owner}" is not in room anymore...`,"Currently in room:",...this.context.connection.usersInRoom()),this.doDestroy())):this.owner||(Nt&&console.warn("PlayerState.start → owner is undefined!",this.name),setTimeout(()=>{!this.destroyed&&!this.owner?this.dontDestroy?Nt&&console.warn("PlayerState.start → owner is still undefined but dontDestroy is set to true",this.name):(Nt&&console.warn(`PlayerState.start → owner is still undefined: destroying "${this.name}" instance now`),this.doDestroy()):Nt&&console.log("PlayerState.start → owner is assigned",this.owner)},2e3))}doDestroy(){Nt&&console.log("PlayerSync.doDestroy → syncDestroy",this.name),Gc(this.gameObject,this.context.connection,!0,{saveInRoom:!1})}onDestroy(){if(Nt&&console.warn("PlayerState.onDestroy",this.owner),this.context.connection.stopListen(J.UserLeftRoom,this.onUserLeftRoom),mt.all.splice(mt.all.indexOf(this),1),this.isLocalPlayer){const t=mt._local.indexOf(this);t>=0&&mt._local.splice(t,1)}}},r(Dl,"_all",[]),r(Dl,"_local",[]),r(Dl,"_callbacks",{}),Dl);let vi=mt;Vu([jg(vi.prototype.onOwnerChange)],vi.prototype,"owner",2);var kM=Object.defineProperty,EM=Object.getOwnPropertyDescriptor,Za=(s,t,e,i)=>{for(var n=i>1?void 0:i?EM(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&kM(t,e,n),n};class $n extends D{constructor(){super(...arguments);r(this,"position","bottom");r(this,"showNeedleLogo",!0);r(this,"showSpatialMenu");r(this,"createFullscreenButton");r(this,"createMuteButton");r(this,"createQRCodeButton")}onEnable(){this.applyOptions()}applyOptions(){this.context.menu.setPosition(this.position),this.context.menu.showNeedleLogo(this.showNeedleLogo),this.createFullscreenButton===!0&&this.context.menu.showFullscreenOption(!0),this.createMuteButton===!0&&this.context.menu.showAudioPlaybackOption(!0),this.showSpatialMenu===!0&&this.context.menu.showSpatialMenu(this.showSpatialMenu),this.createQRCodeButton===!0&&(exports.DeviceUtilities.isMobileDevice()||this.context.menu.showQRCodeButton(!0))}}Za([p()],$n.prototype,"position",2);Za([p()],$n.prototype,"showNeedleLogo",2);Za([p()],$n.prototype,"showSpatialMenu",2);Za([p()],$n.prototype,"createFullscreenButton",2);Za([p()],$n.prototype,"createMuteButton",2);Za([p()],$n.prototype,"createQRCodeButton",2);var TM=Object.defineProperty,AM=Object.getOwnPropertyDescriptor,Bg=(s,t,e,i)=>{for(var n=i>1?void 0:i?AM(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&TM(t,e,n),n};const Sl=x("debugwebxr"),tb=new h.Quaternion().setFromAxisAngle(new h.Vector3(0,1,0),Math.PI);class ho extends D{constructor(){super(...arguments);r(this,"head");r(this,"leftHand");r(this,"rightHand");r(this,"_leftHandMeshes");r(this,"_rightHandMeshes");r(this,"_syncTransforms")}async onEnterXR(e){if(!this.activeAndEnabled)return;Sl&&console.warn("AVATAR ENTER XR",this.guid,this.sourceId,this,this.activeAndEnabled),this._syncTransforms&&(this._syncTransforms.length=0),await this.prepareAvatar();const i=vi.getFor(this);if(i!=null&&i.owner){const n=this.gameObject.addComponent(tt);n.avatar=this.gameObject,n.connectionId=i.owner}else this.context.connection.isConnected?console.error("No player state found for avatar",this):i&&!this.context.connection.isConnected&&(i.dontDestroy=!0)}onLeaveXR(e){const i=this.gameObject.getComponent(tt);i&&i.destroy()}onUpdateXR(e){var d,u;if(!this.activeAndEnabled)return;const i=vi.isLocalPlayer(this);if(!i)return;const n=e.xr;if(n.rig&&n.rig.gameObject!==this.gameObject.parent&&(this.gameObject.position.set(0,0,0),this.gameObject.rotation.set(0,0,0),this.gameObject.scale.set(1,1,1),n.rig.gameObject.add(this.gameObject)),this._syncTransforms&&i)for(const f of this._syncTransforms)f.fastMode=!0,f.isOwned()||f.requestOwnership();if(this.head&&this.context.mainCamera){const f=this.head.asset;if(f.position.copy(this.context.mainCamera.position),f.position.x*=-1,f.position.z*=-1,f.quaternion.copy(this.context.mainCamera.quaternion),f.quaternion.x*=-1,this.context.time.frameCount%10===0&&this.head.asset){const m=S.getComponentsInChildren(this.head.asset,_i);for(const g of m)g.enabled=!1,g.gameObject.visible=!1}}const o=e.xr.leftController,a=(d=this.leftHand)==null?void 0:d.asset;o&&a?(a.position.copy(o.gripPosition),a.quaternion.copy(o.gripQuaternion),a.quaternion.multiply(tb),a.visible=o.isTracking,this.updateHandVisibility(o,a,this._leftHandMeshes)):a&&a.visible&&(a.visible=!1);const l=e.xr.rightController,c=(u=this.rightHand)==null?void 0:u.asset;l&&c?(c.position.copy(l.gripPosition),c.quaternion.copy(l.gripQuaternion),c.quaternion.multiply(tb),c.visible=l.isTracking,this.updateHandVisibility(l,c,this._rightHandMeshes)):c&&c.visible&&(c.visible=!1)}onBeforeRender(){this.context.xr&&this.context.time.frame%10===0&&this.updateRemoteAvatarVisibility()}updateHandVisibility(e,i,n){if(n){const o=e.model&&e.model.visible&&e.model!==i;n.forEach(a=>{cs(a,!o)})}}updateRemoteAvatarVisibility(){var e,i,n;if(this.context.connection.isConnected){const o=vi.getFor(this);if(o&&o.isLocalPlayer==!1){const a=q.getXRSync(this.context);if(a&&a.hasState(o.owner)){this.tryFindAvatarObjectsIfMissing();const l=(e=this.leftHand)==null?void 0:e.asset;l&&(l.visible=(a==null?void 0:a.isTracking(o.owner,"left"))??!1);const c=(i=this.rightHand)==null?void 0:i.asset;c&&(c.visible=(a==null?void 0:a.isTracking(o.owner,"right"))??!1)}if((n=this.head)!=null&&n.asset){const l=S.getComponentsInChildren(this.head.asset,_i);for(const c of l)c.enabled=!1,c.gameObject.visible=!0}}}}tryFindAvatarObjectsIfMissing(){if(!this.head||!this.leftHand||!this.rightHand){const e={head:this.head,leftHand:this.leftHand,rightHand:this.rightHand};w0.tryFindAvatarObjects(this.gameObject,this.sourceId||"",e),e.head&&(this.head=e.head),e.leftHand&&(this.leftHand=e.leftHand),e.rightHand&&(this.rightHand=e.rightHand)}}async prepareAvatar(){var e,i;if(this.tryFindAvatarObjectsIfMissing(),this.head)this.head instanceof h.Object3D&&(this.head=new ee("",this.sourceId,this.head));else{const n=new h.Object3D;n.name="Head";const o=yo.createPrimitive(lr.Cube);n.add(o),this.gameObject.add(n),this.head=new ee("",this.sourceId,n),Sl&&console.log("Create head",n)}if(this.rightHand)this.rightHand instanceof h.Object3D&&(this.rightHand=new ee("",this.sourceId,this.rightHand));else{const n=new h.Object3D;n.name="Right Hand",this.gameObject.add(n),this.rightHand=new ee("",this.sourceId,n),Sl&&console.log("Create right hand",n)}if(this.leftHand)this.leftHand instanceof h.Object3D&&(this.leftHand=new ee("",this.sourceId,this.leftHand));else{const n=new h.Object3D;n.name="Left Hand",this.gameObject.add(n),this.leftHand=new ee("",this.sourceId,n),Sl&&console.log("Create left hand",n)}await this.loadAvatarObjects(this.head,this.leftHand,this.rightHand),this._leftHandMeshes=[],(e=this.leftHand.asset)==null||e.traverse(n=>{n!=null&&n.isMesh&&this._leftHandMeshes.push(n)}),this._rightHandMeshes=[],(i=this.rightHand.asset)==null||i.traverse(n=>{n!=null&&n.isMesh&&this._rightHandMeshes.push(n)}),vi.isLocalPlayer(this.gameObject)&&(this._syncTransforms=S.getComponentsInChildren(this.gameObject,Un))}async loadAvatarObjects(e,i,n){const o=e.loadAssetAsync(),a=i.loadAssetAsync(),l=n.loadAssetAsync(),c=new Array;o&&c.push(o),a&&c.push(a),l&&c.push(l);const d=await Rm(c);Sl&&console.log("Avatar loaded results:",d)}}Bg([p(ee)],ho.prototype,"head",2);Bg([p(ee)],ho.prototype,"leftHand",2);Bg([p(ee)],ho.prototype,"rightHand",2);var DM=Object.defineProperty,LM=Object.getOwnPropertyDescriptor,$u=(s,t,e,i)=>{for(var n=i>1?void 0:i?LM(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&DM(t,e,n),n};const Yn=x("debugwebxr"),js=new Array;class zn extends D{constructor(){super(...arguments);r(this,"createControllerModel",!0);r(this,"createHandModel",!0);r(this,"customLeftHand");r(this,"customRightHand");r(this,"_models",new Array)}supportsXR(e){return e==="immersive-vr"||e==="immersive-ar"}async onXRControllerAdded(e){var o;if(!(e.xr.isVR||e.xr.isPassThrough))return;const{controller:n}=e;if(Yn&&console.warn("Add Controller Model for",n.side,n.index),this.createControllerModel||this.createHandModel){if(n.hand){if(this.createHandModel){const a=await this.loadHandModel(this,n);if(!a||!n.connected||!n.isHand){a!=null&&a.handObject&&ia(a.handObject,!1),(o=a==null?void 0:a.handObject)==null||o.destroy();return}this._models.push({controller:n,model:a.handObject,handmesh:a.handmesh}),this._models.sort((l,c)=>l.controller.index-c.controller.index),this.scene.add(a.handObject),n.model=a.handObject}}else if(this.createControllerModel){const a=await n.getModelUrl();if(a){const l=await this.loadModel(n,a);if(!l||!n.connected||n.isHand)return;this._models.push({controller:n,model:l}),this._models.sort((c,d)=>c.controller.index-d.controller.index),this.scene.add(l),l.traverse(c=>{c.layers.set(2),c.matrixAutoUpdate=!1,c.updateMatrix()}),n.model=l}else n.targetRayMode!=="transient-pointer"&&console.warn("XRControllerModel: no model found for "+n.side)}}}onXRControllerRemoved(e){console.debug("XR Controller Removed",e.controller.side,e.controller.index);const i=this._models.findIndex(o=>o.controller===e.controller),n=this._models[i];n&&(this._models.splice(i,1),n.model&&(ia(n.model,!1),n.model.destroy(),n.model=void 0))}onBeforeXR(e,i){this.createHandModel&&(this.customLeftHand||this.customRightHand)&&(i.optionalFeatures=i.optionalFeatures||[],i.optionalFeatures.includes("hand-tracking")||i.optionalFeatures.push("hand-tracking"))}onLeaveXR(e){for(const i of this._models)i&&(i.model&&(ia(i.model,!1),i.model.destroy(),i.model=void 0),i.controller.model===i.model&&(i.controller.model=null));this._models.length=0}onBeforeRender(){if(q.active&&(Yn&&(js[0]=Date.now()),this.updateRendering(q.active),Yn)){const e=Date.now()-js[0];js.push(e),js.length>=30&&(js[0]=0,js.reduce((i,n)=>i+n,0)/js.length,js.length=0)}}updateRendering(e){var i,n,o,a,l;for(let c=0;c<this._models.length;c++){const d=this._models[c];if(!d)continue;const u=d.controller;if(!u.connected){Yn&&console.warn("XRControllerModel.onUpdateXR: controller is not connected anymore",u.side,u.hand);continue}if(d.model&&!d.handmesh)d.model.matrixAutoUpdate=!1,d.model.matrix.copy(u.gripMatrix),d.model.visible=u.isTracking,(i=e.rig)==null||i.gameObject.add(d.model);else if(u.inputSource.hand&&d.handmesh){const f=e.referenceSpace,m=this.context.renderer.xr.getHand(u.index);if(f&&e.frame.getJointPose){for(const g of u.inputSource.hand.values()){const _=m.joints[g.jointName];if(_){const y=u.getHandJointPose(g);if(y){const b=y.transform.position,v=y.transform.orientation;_.position.copy(b),_.quaternion.copy(v),_.matrixAutoUpdate=!1}_.visible=y!=null}}d.model&&(d.model.visible=u.isTracking,d.model.visible&&d.model.parent!==((n=e.rig)==null?void 0:n.gameObject)&&((o=e.rig)==null||o.gameObject.add(d.model))),(a=d.model)!=null&&a.visible&&((l=d.handmesh)==null||l.updateMesh(),d.model.matrixAutoUpdate=!1,d.model.matrix.identity(),d.model.applyMatrix4(ya))}}}}async loadModel(e,i){var a;if(!e.connected)return console.warn("XRControllerModel.onXRControllerAdded: controller is not connected anymore",e.side),null;const o=await ee.getOrCreate("",i).instantiate();return ia(o),(a=q.active)!=null&&a.isPassThrough&&o.traverseVisible(l=>{this.makeOccluder(l)}),o}async loadHandModel(e,i){const n=this.context,o=n.renderer.xr.getHand(i.index);o||(Yn?N.DrawLabel(i.rayWorldPosition,"No hand found for index "+i.index,.05,5):console.warn("No hand found for index "+i.index));const a=new Y.GLTFLoader;Tu(a,n),await eu(a,n,this.sourceId??"");const l=zu(a);let c="";const d=i.side==="left"?this.customLeftHand:this.customRightHand;d?(c=d.url.split(".").slice(0,-1).join("."),a.setPath("")):(c=i.inputSource.handedness==="left"?"left":"right",a.setPath("https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles/generic-hand/"));const u=new h.Object3D;ia(u);const f=new Y.XRHandMeshModel(u,o,a.path,c,a,m=>{var _;const g=l.gltf;((_=g==null?void 0:g.scene.children)==null?void 0:_.length)===0&&(g.scene.children[0]=m),dn().createBuiltinComponents(e.context,e.sourceId||c,l.gltf,null,l),m.traverse(y=>{var b;y.layers.set(2),(b=q.active)!=null&&b.isPassThrough&&!d&&this.makeOccluder(y),y instanceof h.Mesh&&re.NEEDLE_progressive.assignMeshLOD(y,0)}),i.connected||(Yn&&N.DrawLabel(i.rayWorldPosition,"Hand is loaded but not connected anymore",.05,5),m.removeFromParent())});if(Yn&&u.add(new h.AxesHelper(.5)),i.inputSource.hand){Yn&&console.log(i.inputSource.hand);for(const m of i.inputSource.hand.values())if(o.joints[m.jointName]===void 0){const g=new h.Group;g.matrixAutoUpdate=!1,g.visible=!0,o.joints[m.jointName]=g,o.add(g)}}else Yn&&N.DrawLabel(i.rayWorldPosition,"No inputSource.hand found for index "+i.index,.05,5);return{handObject:u,handmesh:f}}makeOccluder(e){if(e instanceof h.Mesh){let i=e.material;i instanceof h.Material&&(i=e.material=i.clone(),i.depthWrite=!0,i.depthTest=!0,i.colorWrite=!1,e.receiveShadow=!1,e.renderOrder=-100)}}}r(zn,"factory",new Y.XRControllerModelFactory);$u([p()],zn.prototype,"createControllerModel",2);$u([p()],zn.prototype,"createHandModel",2);$u([p(ee)],zn.prototype,"customLeftHand",2);$u([p(ee)],zn.prototype,"customRightHand",2);class Wu extends D{}var IM=Object.defineProperty,jM=Object.getOwnPropertyDescriptor,wo=(s,t,e,i)=>{for(var n=i>1?void 0:i?jM(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&IM(t,e,n),n};const Kf=x("debugwebxr");class Pi extends D{constructor(){super(...arguments);r(this,"movementSpeed",1.5);r(this,"rotationStep",30);r(this,"useTeleport",!0);r(this,"usePinchToTeleport",!0);r(this,"useTeleportTarget",!1);r(this,"useTeleportFade",!1);r(this,"showRays",!0);r(this,"showHits",!0);r(this,"isXRMovementHandler",!0);r(this,"xrSessionMode","immersive-vr");r(this,"_didApplyRotation",!1);r(this,"_didTeleport",!1);r(this,"_teleportBuffer",new Array);r(this,"_plane",null);r(this,"_lines",[]);r(this,"_hitDiscs",[]);r(this,"_hitDistances",[]);r(this,"_lastHitDistances",[]);r(this,"hitPointRaycastFilter",e=>e.type==="SkinnedMesh"?"continue in children":!0)}onUpdateXR(e){const i=e.xr.rig;if(!(i!=null&&i.gameObject)||e.xr.isPassThrough)return;const n=e.xr.leftController,o=e.xr.rightController;n&&this.onHandleMovement(n,i.gameObject),o&&(this.onHandleRotation(o,i.gameObject),this.useTeleport&&this.onHandleTeleport(o,i.gameObject))}onLeaveXR(e){for(const i of this._lines)i.removeFromParent();for(const i of this._hitDiscs)i==null||i.removeFromParent()}onBeforeRender(){var e;(e=this.context.xr)!=null&&e.running&&(this.showRays&&this.renderRays(this.context.xr),this.showHits&&this.renderHits(this.context.xr))}onHandleMovement(e,i){const n=e.getStick("xr-standard-thumbstick");if(n.x!=0||n.y!=0){const o=$(n.x,0,n.y);o.multiplyScalar(this.context.time.deltaTimeUnscaled*this.movementSpeed);const a=Ue(i);o.multiplyScalar(a.x),o.applyQuaternion(e.xr.poseOrientation),o.y=0,o.applyQuaternion(i.worldQuaternion),i.position.add(o),i.updateWorldMatrix(!1,!1);for(const l of i.children)l.updateWorldMatrix(!1,!1)}}onHandleRotation(e,i){if(e._isMxInk)return;const o=e.getStick("xr-standard-thumbstick").x;if(this._didApplyRotation)Math.abs(o)<.3&&(this._didApplyRotation=!1);else if(Math.abs(o)>.5){this._didApplyRotation=!0;const a=o>0?1:-1,l=Z(this.context.mainCamera).clone();i.rotateY(a*z.toRadians(this.rotationStep));const d=Z(this.context.mainCamera).clone().sub(l);d.y=0,i.position.sub(d)}}onHandleTeleport(e,i){var o,a,l,c,d;let n=0;if(e.hand&&this.usePinchToTeleport&&e.isTeleportGesture){const u=e.getPointerId("primary");if(u!=null&&this.context.input.getIsPointerIdInUse(u))return;const f=e.getGesture("pinch");f&&(n=f.value)}else n=(o=e.getStick("xr-standard-thumbstick"))==null?void 0:o.y;if(this._didTeleport)n>=0&&n<.4?this._didTeleport=!1:n<0&&n>-.4&&(this._didTeleport=!1);else if(n>.8){this._didTeleport=!0;const u=this.context.physics.raycastFromRay(e.ray)[0];if(u&&u.object instanceof Y.GroundedSkybox){const m=(a=u.normal)==null?void 0:a.dot($(0,1,0));if(m!==void 0&&m<.4)return}let f=u==null?void 0:u.point;if(!f&&!this.useTeleportTarget){this._plane||(this._plane=new h.Plane(new h.Vector3(0,1,0),0));const m=i.worldPosition;this._plane.setFromNormalAndCoplanarPoint(new h.Vector3(0,1,0),m);const g=e.ray;f=m.clone(),this._plane.intersectLine(new h.Line3(g.origin,$(g.direction).multiplyScalar(1e4).add(g.origin)),f),f.distanceTo(m)>i.scale.x*10&&(f=null)}if(f){if(this.useTeleportTarget&&!S.getComponentInParent(u.object,Wu))return;const m=f.clone();if(Kf&&N.DrawSphere(f,.025,16711680,5),(l=this.context.mainCamera)==null?void 0:l.position){const _=(c=this.context.xr)==null?void 0:c.getUserOffsetInRig();_&&(_.y=0,m.sub(_),Kf&&N.DrawWireSphere(_.add(m),.025,65280,5))}this._teleportBuffer.push(i.matrix.clone()),this._teleportBuffer.length>10&&this._teleportBuffer.shift(),this.useTeleportFade?(d=e.xr.fadeTransition())==null||d.then(()=>{i.worldPosition=m}):i.worldPosition=m}}else if(n<-.8&&(this._didTeleport=!0,this._teleportBuffer.length>0)){const u=this._teleportBuffer.pop();u&&u.decompose(i.position,i.quaternion,i.scale)}}renderRays(e){var i;for(let n=0;n<this._lines.length;n++){const o=this._lines[n];o&&(o.visible=!1)}for(let n=0;n<e.controllers.length;n++){const o=e.controllers[n];let a=this._lines[n];if(!o.connected||!o.isTracking||!o.ray||o.targetRayMode==="transient-pointer"||!o.hasSelectEvent){a&&(a.visible=!1);continue}a||(a=this.createRayLineObject(),a.scale.z=.5,this._lines[n]=a),o.updateRayWorldPosition(),o.updateRayWorldQuaternion();const l=o.rayWorldPosition,c=o.rayWorldQuaternion;a.position.copy(l),a.quaternion.copy(c);const d=e.rigScale,u=this.usePinchToTeleport&&o.isTeleportGesture,f=this._lastHitDistances[n],m=this._hitDistances[n]!=null,g=f??d;a.scale.set(d,d,g),a.visible=!0,a.layers.disableAll(),a.layers.enable(2);let _=a.material.opacity;u?_=1:this.showHits&&g<e.rigScale*.5?_=0:(i=o.getButton("primary"))!=null&&i.pressed?_=.5:_=m?.2:.1,a.material.opacity=z.lerp(a.material.opacity,_,this.context.time.deltaTimeUnscaled/.1),a.parent!==this.context.scene&&this.context.scene.add(a)}}renderHits(e){var i;for(const n of this._hitDiscs){if(!n)continue;const o=n.controller;if(!o||!o.connected||!o.isTracking){n.visible=!1;continue}}for(let n=0;n<e.controllers.length;n++){const o=e.controllers[n];if(!o.connected||!o.isTracking||!o.ray||!o.hasSelectEvent)continue;let a=this._hitDiscs[n],l=!0;const c=o.getPointerId("primary");c!=null&&this.context.input.getIsPointerIdInUse(c)&&(a&&(a.visible=!1),this._hitDistances[n]=null,this._lastHitDistances[n]=0,l=!1);const d=this.context.time.smoothedFps>=59?1:10;if((this.context.time.frame+o.index)%d!==0&&(l=!1),!l){const m=this._hitDiscs[n];m&&m.visible&&m.hit&&this.updateHitPointerPosition(o,m,m.hit.distance);continue}const u=this.context.physics.raycastFromRay(o.ray,{testObject:this.hitPointRaycastFilter,precise:!1});let f=u.find(m=>this.usePinchToTeleport&&o.isTeleportGesture?!0:this.isObjectWithInteractiveComponent(m.object));if(f||(f=u[0]),a&&(a.controller=o,a.hit=f),this._hitDistances[n]=(f==null?void 0:f.distance)||null,f){this._lastHitDistances[n]=f.distance;const m=e.rigScale??1;Kf&&(N.DrawWireSphere(f.point,.025*m,16711680),N.DrawLabel($(0,.2,0).add(f.point),f.object.name,.02,0)),a||(a=this.createHitPointObject(),this._hitDiscs[n]=a),a.hit=f,a.visible=f.distance>m*.05;let g=.01*(m+f.distance);const _=(i=o.getButton("primary"))==null?void 0:i.pressed;_&&(g*=1.1),a.scale.set(g,g,g),a.layers.set(2);let y=a.material.opacity;if(_?y=1:y=f.distance<.15*m?.2:.6,a.material.opacity=z.lerp(a.material.opacity,y,this.context.time.deltaTimeUnscaled/.1),a.visible){if(f.normal){this.updateHitPointerPosition(o,a,f.distance);const b=f.normal.applyQuaternion(_e(f.object));a.quaternion.setFromUnitVectors(BM,b)}else this.updateHitPointerPosition(o,a,f.distance);a.parent!==this.context.scene&&this.context.scene.add(a)}}else this._hitDiscs[n]&&(this._hitDiscs[n].visible=!1)}}isObjectWithInteractiveComponent(e,i=0){return Xd(e)||e.isUI===!0?!0:e.isScene?!1:e.parent?this.isObjectWithInteractiveComponent(e.parent,i+1):!1}updateHitPointerPosition(e,i,n){const o=$(e.rayWorldPosition);o.add($(0,0,n-.01).applyQuaternion(e.rayWorldQuaternion)),i.position.lerp(o,this.context.time.deltaTimeUnscaled/.05)}createHitPointObject(){const e=new h.Mesh(new h.SphereGeometry(.3,6,6),new h.MeshBasicMaterial({color:15658734,opacity:.7,transparent:!0,depthTest:!1,depthWrite:!1,side:h.DoubleSide}));return e.layers.disableAll(),e.layers.enable(2),e}createRayLineObject(){const e=new Y.Line2;e.layers.disableAll(),e.layers.enable(2);const i=new Y.LineGeometry;e.geometry=i;const n=new Float32Array(9);n.set([0,0,.02,0,0,.4,0,0,1]),i.setPositions(n);const o=new Float32Array(9);o.set([1,1,1,.1,.1,.1,0,0,0]),i.setColors(o);const a=new Y.LineMaterial({color:16777215,vertexColors:!0,worldUnits:!0,linewidth:.004,transparent:!0,depthWrite:!1,blending:h.AdditiveBlending,dashed:!1});return e.material=a,e}}wo([p()],Pi.prototype,"movementSpeed",2);wo([p()],Pi.prototype,"rotationStep",2);wo([p()],Pi.prototype,"useTeleport",2);wo([p()],Pi.prototype,"usePinchToTeleport",2);wo([p()],Pi.prototype,"useTeleportTarget",2);wo([p()],Pi.prototype,"useTeleportFade",2);wo([p()],Pi.prototype,"showRays",2);wo([p()],Pi.prototype,"showHits",2);const BM=new h.Vector3(0,1,0);var FM=Object.defineProperty,UM=Object.getOwnPropertyDescriptor,dt=(s,t,e,i)=>{for(var n=i>1?void 0:i?UM(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&FM(t,e,n),n};const Cl=x("debugwebxr"),zM=x("debugusdz");var xp;const la=(xp=class extends D{constructor(){super(...arguments);r(this,"createVRButton",!0);r(this,"createARButton",!0);r(this,"createSendToQuestButton",!0);r(this,"createQRCode",!0);r(this,"useDefaultControls",!0);r(this,"showControllerModels",!0);r(this,"showHandModels",!0);r(this,"usePlacementReticle",!0);r(this,"customARPlacementReticle");r(this,"usePlacementAdjustment",!0);r(this,"arScale",1);r(this,"useXRAnchor",!1);r(this,"autoPlace",!1);r(this,"autoCenter",!1);r(this,"useQuicklookExport",!1);r(this,"useDepthSensing",!1);r(this,"useSpatialGrab",!0);r(this,"defaultAvatar");r(this,"_playerSync");r(this,"_createdComponentsInSession",[]);r(this,"_usdzExporter");r(this,"_exitXRMenuButton");r(this,"_previousXRState",0);r(this,"_spatialGrabRaycaster");r(this,"_activeWebARSessionRoot",null);r(this,"onAvatarSpawned",t=>{Cl&&console.log("WebXR.onAvatarSpawned",t),S.getComponentInChildren(t,ho)??(e=S.addComponent(t,ho))});r(this,"_buttonFactory");r(this,"_buttons",[])}awake(){q.getXRSync(this.context)}onEnable(){var t,e;window.location.protocol!=="https:"&&pe('<a href="https://developer.mozilla.org/en-US/docs/Web/API/WebXR_Device_API" target="_blank">WebXR</a> only works on secure connections (https).'),this.useQuicklookExport&&(S.findObjectOfType(Le)||(Cl&&console.log("WebXR: Adding USDZExporter"),this._usdzExporter=S.addComponent(this.gameObject,Le),this._usdzExporter.objectToExport=this.context.scene,this._usdzExporter.autoExportAnimations=!0,this._usdzExporter.autoExportAudioSources=!0)),this.handleCreatingHTML(),this.handleOfferSession(),this.defaultAvatar===!0&&(Cl&&console.warn("WebXR: No default avatar set, using static default avatar"),this.defaultAvatar=new ee("https://cdn.needle.tools/static/avatars/DefaultAvatar.glb")),this.defaultAvatar&&(this._playerSync=this.gameObject.getOrAddComponent(Ka),this._playerSync.autoSync=!1),this._playerSync&&typeof this.defaultAvatar!="boolean"&&(this._playerSync.asset=this.defaultAvatar,(t=this._playerSync.onPlayerSpawned)==null||t.removeEventListener(this.onAvatarSpawned),(e=this._playerSync.onPlayerSpawned)==null||e.addEventListener(this.onAvatarSpawned))}onDisable(){var t;(t=this._usdzExporter)==null||t.destroy(),this.removeButtons()}async handleOfferSession(){return this.createVRButton&&await q.isVRSupported()&&this.createVRButton?q.offerSession("immersive-vr","default",this.context):this.createARButton&&await q.isARSupported()&&this.createARButton?q.offerSession("immersive-ar","default",this.context):!1}get session(){return q.active??null}get sessionMode(){return q.activeMode??null}get arSessionRoot(){return this._activeWebARSessionRoot}async enterVR(t){return q.start("immersive-vr",t,this.context)}async enterAR(t){return q.start("immersive-ar",t,this.context)}exitXR(){q.stop()}get isActiveWebXR(){return!la.activeWebXRComponent||la.activeWebXRComponent===this}onBeforeXR(t,e){var i;if(!this.isActiveWebXR){console.warn(`WebXR: another WebXR component is already active (${(i=la.activeWebXRComponent)==null?void 0:i.name}). This is ignored: ${this.name}`);return}la.activeWebXRComponent=this,t=="immersive-ar"&&this.useDepthSensing&&(e.optionalFeatures=e.optionalFeatures||[],e.optionalFeatures.push("depth-sensing"))}async onEnterXR(t){if(!this.isActiveWebXR)return;Cl&&console.log("WebXR onEnterXR"),this._previousXRState=Rt.Global.Mask;const e=t.xr.isVR;if(Rt.Global.Set(e?En.VR:En.AR),t.xr.isAR){let i=S.findObjectOfType(Ni);if(!i)if(this.usePlacementReticle){const n=new h.Object3D;for(const o of this.context.scene.children)n.add(o);this.context.scene.add(n),i=S.addComponent(n,Ni),this._createdComponentsInSession.push(i)}else(Cl||B())&&console.warn("WebXR: No WebARSessionRoot found in scene and usePlacementReticle is disabled in WebXR component.");this._activeWebARSessionRoot=i,i&&(i.customReticle=this.customARPlacementReticle,i.arScale=this.arScale,i.arTouchTransform=this.usePlacementAdjustment,i.autoPlace=this.autoPlace,i.autoCenter=this.autoCenter,i.useXRAnchor=this.useXRAnchor)}this.useDefaultControls&&this.setDefaultMovementEnabled(!0),(this.showControllerModels||this.showHandModels)&&this.setDefaultControllerRenderingEnabled(!0),this.useSpatialGrab&&(this._spatialGrabRaycaster=S.findObjectOfType(oo)??void 0,this._spatialGrabRaycaster||(this._spatialGrabRaycaster=this.gameObject.addComponent(oo))),this.createLocalAvatar(t.xr),t.xr.isScreenBasedAR||(this._exitXRMenuButton=this.context.menu.appendChild({label:"Quit XR",onClick:()=>this.exitXR(),icon:"exit_to_app",priority:2e4}))}onUpdateXR(t){this.isActiveWebXR&&this._spatialGrabRaycaster&&(this._spatialGrabRaycaster.enabled=this.useSpatialGrab)}onLeaveXR(t){var e,i;if((e=this._exitXRMenuButton)==null||e.remove(),!!this.isActiveWebXR){Rt.Global.Set(this._previousXRState),(i=this._playerSync)==null||i.destroyInstance();for(const n of this._createdComponentsInSession)n.destroy();this._createdComponentsInSession.length=0,this._activeWebARSessionRoot=null,this.handleOfferSession(),Uc(1).then(()=>la.activeWebXRComponent=null)}}setDefaultMovementEnabled(t){let e=this.gameObject.getComponent(Pi);return!e&&t&&(e=this.gameObject.addComponent(Pi),this._createdComponentsInSession.push(e)),e&&(e.enabled=t),e}setDefaultControllerRenderingEnabled(t){let e=this.gameObject.getComponent(zn);return!e&&t&&(e=this.gameObject.addComponent(zn),this._createdComponentsInSession.push(e),e.createControllerModel=this.showControllerModels,e.createHandModel==this.showHandModels),e&&(e.enabled=t),e}async createLocalAvatar(t){this._playerSync&&t.running&&typeof this.defaultAvatar!="boolean"&&(this._playerSync.asset=this.defaultAvatar,await this._playerSync.getInstance())}getButtonsContainer(){return this.getButtonsFactory()}getButtonsFactory(){return this._buttonFactory||(this._buttonFactory=_s.getOrCreate()),this._buttonFactory}handleCreatingHTML(){if(this.createARButton||this.createVRButton||this.useQuicklookExport){if((exports.DeviceUtilities.isiOS()&&exports.DeviceUtilities.isSafari()||zM)&&this.useQuicklookExport){const e=S.findObjectOfType(Le);if(!e||e&&e.allowCreateQuicklookButton){const i=this.getButtonsFactory().createQuicklookButton();this.addButton(i,50)}}if(this.createARButton){const e=this.getButtonsFactory().createARButton();this.addButton(e,50)}if(this.createVRButton){const e=this.getButtonsFactory().createVRButton();this.addButton(e,50)}}if(this.createSendToQuestButton&&!exports.DeviceUtilities.isQuest()&&q.isVRSupported().then(e=>{if(!e){const i=this.getButtonsFactory().createSendToQuestButton();this.addButton(i,50)}}),this.createQRCode){const e=Yc($n);if(e&&e.createQRCodeButton===!1)B()&&console.warn("WebXR: QRCode button is disabled in the Needle Menu component");else if(!exports.DeviceUtilities.isMobileDevice()){const i=an.getOrCreate().createQRCode();this.addButton(i,50)}}}addButton(t,e){this._buttons.push(t),t.setAttribute("priority",e.toString()),this.context.menu.appendChild(t)}removeButtons(){for(const t of this._buttons)t.remove();this._buttons.length=0}},r(xp,"activeWebXRComponent",null),xp);let Ne=la;dt([p()],Ne.prototype,"createVRButton",2);dt([p()],Ne.prototype,"createARButton",2);dt([p()],Ne.prototype,"createSendToQuestButton",2);dt([p()],Ne.prototype,"createQRCode",2);dt([p()],Ne.prototype,"useDefaultControls",2);dt([p()],Ne.prototype,"showControllerModels",2);dt([p()],Ne.prototype,"showHandModels",2);dt([p()],Ne.prototype,"usePlacementReticle",2);dt([p(ee)],Ne.prototype,"customARPlacementReticle",2);dt([p()],Ne.prototype,"usePlacementAdjustment",2);dt([p()],Ne.prototype,"arScale",2);dt([p()],Ne.prototype,"useXRAnchor",2);dt([p()],Ne.prototype,"autoPlace",2);dt([p()],Ne.prototype,"autoCenter",2);dt([p()],Ne.prototype,"useQuicklookExport",2);dt([p()],Ne.prototype,"useDepthSensing",2);dt([p()],Ne.prototype,"useSpatialGrab",2);dt([p(ee)],Ne.prototype,"defaultAvatar",2);const Qh=x("debugusdzbehaviours");class Fg{constructor(){r(this,"behaviours",[]);r(this,"behaviourComponents",[]);r(this,"behaviourComponentsCopy",[]);r(this,"audioClips",[]);r(this,"audioClipsCopy",[]);r(this,"targetUuids",new Set)}get extensionName(){return"Behaviour"}addBehavior(t){this.behaviours.push(t)}addAudioClip(t){if(!t||typeof t!="string")return"";const i="audio/"+Cr.getName(t);return this.audioClips.push({clipUrl:t,filesKey:i}),i}getAllTargetUuids(){return this.targetUuids}onBeforeBuildDocument(t){if(!t.root)return Promise.resolve();const e=[];return t.root.traverse(i=>{S.foreachComponent(i,n=>{var a;const o=n;if(typeof o.createBehaviours=="function"||typeof o.beforeCreateDocument=="function"||typeof o.afterCreateDocument=="function"||typeof o.afterSerialize=="function"){this.behaviourComponents.push(o);const l=(a=o.beforeCreateDocument)==null?void 0:a.call(o,this,t);l instanceof Promise&&e.push(l)}},!1)}),Qh&&console.log("onBeforeBuildDocument: all components",this.behaviourComponents),Promise.all(e)}onExportObject(t,e,i){var n;for(const o of this.behaviourComponents)(n=o.createBehaviours)==null||n.call(o,this,e,i)}onAfterBuildDocument(t){for(const f of this.behaviourComponents)typeof f.afterCreateDocument=="function"&&f.afterCreateDocument(this,t);this.behaviourComponentsCopy=this.behaviourComponents.slice(),this.behaviourComponents.length=0,this.audioClipsCopy=this.audioClips.slice(),this.audioClips.length=0;const e=new Set,i=new Set,n=new Set,o=new Set,a=Qh;let l=`graph LR
`,c="";function d(f){if(f instanceof Zs){a&&(l+=`subgraph Group_${f.id}
`);for(const m of f.actions)a&&(l+=`${f.id}[${f.id}] -- ${f.type},loops:${f.loops} --> ${m.id}[${m.id}]
`),d(m);a&&(l+=`end
`)}else if(f instanceof Jt){f.tokenId==="StartAnimation"&&o.add(f);let m=f.tokenId;f.type!==void 0&&(m+=":"+f.type);const g=f.affectedObjects;if(g)if(Array.isArray(g))for(const y of g)i.add(y),a&&(c+=`${f.id}[${f.id}
${m}] -- ${m} --> ${y.uuid}(("${y.displayName||y.name||y.uuid}"))
`);else typeof g=="object"?(i.add(g),a&&(c+=`${f.id}[${f.id}
${m}] -- ${m} --> ${g.uuid}(("${g.displayName||g.name||g.uuid}"))
`)):typeof g=="string"&&i.add({uuid:g});const _=f.xFormTarget;_&&(typeof _=="object"?(i.add(_),a&&(c+=`${f.id}[${f.id}
${m}] -- ${m} --> ${_.uuid}(("${_.displayName||_.name||_.uuid}"))
`)):typeof _=="string"&&i.add({uuid:_}))}}function u(f,m){if(Array.isArray(f))for(const g of f)u(g,m);else if(f instanceof gs){let g=f.tokenId;f.type!==void 0&&(g+=":"+f.type),typeof f.targetId=="object"&&(e.add(f.targetId),a&&(c+=`${f.targetId.uuid}(("${f.targetId.displayName}")) --> ${f.id}[${f.id}
${g}]
`)),a&&(l+=`${f.id}((${f.id})) -- ${g} --> ${m.id}[${m.tokenId||m.id}]
`)}}for(const f of this.behaviours)a&&(l+=`subgraph ${f.id}
`),d(f.action),u(f.trigger,f.action),a&&(l+=`end
`);a&&(l+=`
`+c),a&&(console.log("All USDZ behaviours",this.behaviours),this.behaviours.length&&(console.warn("The Mermaid graph can be pasted into https://massive-mermaid.glitch.me/ or https://mermaid.live/edit. It should be in your clipboard already!"),console.log(l),navigator.clipboard.writeText(l)));{let f=`gantt
title Animations
dateFormat X
axisFormat %s
`;const m=Array.from(o),g=new Set;for(const v of m)if(v.affectedObjects&&typeof v.affectedObjects!="string"){if(Array.isArray(v.affectedObjects))for(const w of v.affectedObjects)g.add(w);else g.add(v.affectedObjects);a&&(f+=`section ${v.animationName} (${v.id})
`,f+=`${v.id} : ${v.start}, ${v.duration}s
`)}a&&o.size&&console.log(f);const _=new Set;for(const v of g){v.getPath||console.error("USDZExporter: Animation target object has no getPath method. This is likely a bug",v);let w=v.getPath();w.startsWith("<")&&(w=w.substring(1)),w.endsWith(">")&&(w=w.substring(0,w.length-1)),_.add({path:w,obj:v})}const y=Array.from(_).sort((v,w)=>v.path.length-w.path.length),b=new Array;for(let v=0;v<y.length;v++)for(let w=v+1;w<y.length;w++)if(y[w].path.startsWith(y[v].path)){const P=y[w],k=y[v];b.push({child:P.obj.displayName+" ("+P.path+")",parent:k.obj.displayName+" ("+k.path+")"})}b.length&&console.warn("USDZExporter: There are overlapping PlayAnimation actions. This can lead to undefined runtime behaviour when playing multiple animations. Please restructure the hierarchy so that animations don't overlap.",{overlappingTargets:b,playAnimationActions:o})}for(const f of new Set([...e,...i]))if(Array.isArray(f))for(const m of f)n.add(m.uuid);else n.add(f.uuid);Qh&&console.log("All Behavior trigger sources and action targets",e,i,n),this.targetUuids=new Set(n)}onAfterHierarchy(t,e){var i;if((i=this.behaviours)!=null&&i.length){e.beginBlock('def Scope "Behaviors"');for(const n of this.behaviours)n.writeTo(this,t.document,e);e.closeBlock()}}async onAfterSerialize(t){Qh&&console.log("onAfterSerialize behaviours",this.behaviourComponentsCopy);for(const e of this.behaviourComponentsCopy)typeof e.afterSerialize=="function"&&(e.afterSerialize.constructor.name==="AsyncFunction"?await e.afterSerialize(this,t):e.afterSerialize(this,t));for(const{clipUrl:e,filesKey:i}of this.audioClipsCopy){if(t.files[i])return;const a=await(await(await fetch(e)).blob()).arrayBuffer(),l=new Uint8Array(a);t.files[i]=l}this.behaviourComponentsCopy.length=0,this.audioClipsCopy.length=0}}class Ug{get extensionName(){return"Physics"}onExportObject(t,e,i){const n=S.getComponents(t,ue).filter(c=>c.enabled),o=S.getComponents(t,ri).filter(c=>c.enabled&&!c.isTrigger);let a=n.length>0?n[0]:null;const l=o.length>0?o[0]:null;l&&!a&&(a=new ue,a.isKinematic=!0),a&&e.addEventListener("serialize",(c,d)=>{var u,f,m;if(a){if(c.appendLine(),c.beginBlock('def RealityKitComponent "RigidBody"',"{",!0),a.useGravity||c.appendLine("bool gravityEnabled = 0"),c.appendLine('uniform token info:id = "RealityKit.RigidBody"'),a.isKinematic&&c.appendLine('token motionType = "Kinematic"'),c.beginBlock('def RealityKitStruct "massFrame"',"{",!0),c.appendLine(`float m_mass = ${a.mass}`),c.beginBlock('def RealityKitStruct "m_pose"',"{",!0),c.appendLine(`float3 position = (${a.centerOfMass.x}, ${a.centerOfMass.y}, ${a.centerOfMass.z})`),c.closeBlock("}"),c.closeBlock("}"),o.length>0){const g=o[0];c.beginBlock('def RealityKitStruct "material"',"{",!0);const _=g.sharedMaterial;_&&_.dynamicFriction!==void 0&&c.appendLine(`double dynamicFriction = ${(u=g.sharedMaterial)==null?void 0:u.dynamicFriction}`),_&&_.bounciness!==void 0&&c.appendLine(`double restitution = ${(f=g.sharedMaterial)==null?void 0:f.bounciness}`),_&&_.staticFriction!==void 0&&c.appendLine(`double staticFriction = ${(m=g.sharedMaterial)==null?void 0:m.staticFriction}`),c.closeBlock("}")}c.closeBlock("}")}}),l&&(e.addEventListener("serialize",(c,d)=>{var m;c.beginBlock('def RealityKitComponent "Collider"',"{",!0),c.appendLine("uint group = 1"),c.appendLine('uniform token info:id = "RealityKit.Collider"'),c.appendLine("uint mask = 4294967295");const f=l.isTrigger?"Trigger":"Default";if(c.appendLine(`token type = "${f}"`),c.beginBlock('def RealityKitStruct "Shape"',"{",!0),l instanceof Va){const g=l;c.appendLine('token shapeType = "Sphere"'),c.appendLine(`float radius = ${g.radius}`)}else if(l instanceof $a){const g=l;c.appendLine('token shapeType = "Box"'),c.appendLine(`float3 extent = (${g.size.x}, ${g.size.y}, ${g.size.z})`)}else if(l instanceof ys){const g=l;c.appendLine('token shapeType = "Capsule"'),c.appendLine(`float radius = ${g.radius}`),c.appendLine(`float height = ${g.height}`)}else if(l instanceof vo&&((m=l.sharedMesh)!=null&&m.geometry)){const g=l.sharedMesh.geometry;g.boundingBox||g.computeBoundingBox();const _=l.sharedMesh.geometry.boundingBox;_&&(c.appendLine('token shapeType = "Box"'),c.appendLine(`float3 extent = (${_.max.x-_.min.x}, ${_.max.y-_.min.y}, ${_.max.z-_.min.z})`),console.log("[USDZ] Only Box, Sphere, and Capsule colliders are supported in visionOS/iOS. MeshCollider will be exported as Box",l))}else console.warn("[USDZ] Only Box, Sphere, and Capsule colliders are supported in visionOS/iOS. Ignoring collider:",l);c.beginBlock('def RealityKitStruct "pose"',"{",!0),c.closeBlock("}"),c.closeBlock("}"),c.closeBlock("}")}),o.length>1&&console.log("WARNING: Multiple colliders detected. visionOS / iOS can only support objects with a single collider, only exporting the first collider: ",l))}}var NM=Object.defineProperty,VM=Object.getOwnPropertyDescriptor,hh=(s,t,e,i)=>{for(var n=i>1?void 0:i?VM(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&NM(t,e,n),n};const Zf=x("debugui"),Jf=x("debuguilayout");class yw{constructor(){r(this,"width");r(this,"height")}}class bw{constructor(){r(this,"x");r(this,"y");r(this,"width");r(this,"height")}}const en=new h.Vector3,Pl=new h.Matrix4,Yh=new h.Quaternion,vw=class extends Gi{constructor(){super(...arguments);r(this,"_anchoredPosition");r(this,"sizeDelta",new h.Vector2(100,100));r(this,"pivot",new h.Vector2(.5,.5));r(this,"anchorMin",new h.Vector2(0,0));r(this,"anchorMax",new h.Vector2(1,1));r(this,"minWidth");r(this,"minHeight");r(this,"lastMatrix");r(this,"rectBlock");r(this,"_transformNeedsUpdate",!1);r(this,"_initialPosition");r(this,"_parentRectTransform");r(this,"_lastUpdateFrame",-1);r(this,"_lastAnchoring");r(this,"_createdBlocks",[]);r(this,"_createdTextBlocks",[])}get parent(){return this._parentRectTransform}get translation(){return this.gameObject.position}get rotation(){return this.gameObject.quaternion}get scale(){return this.gameObject.scale}get anchoredPosition(){return this._anchoredPosition||(this._anchoredPosition=new h.Vector2),this._anchoredPosition}set anchoredPosition(t){this._anchoredPosition=t}get width(){let t=this.sizeDelta.x;if(this.anchorMin.x!==this.anchorMax.x&&this._parentRectTransform){const e=this._parentRectTransform.width,i=this.anchorMax.x-this.anchorMin.x;t=e*i,t+=this.sizeDelta.x}return this.minWidth!==void 0&&t<this.minWidth?this.minWidth:t}get height(){let t=this.sizeDelta.y;if(this.anchorMin.y!==this.anchorMax.y&&this._parentRectTransform){const e=this._parentRectTransform.height,i=this.anchorMax.y-this.anchorMin.y;t=e*i,t+=this.sizeDelta.y}return this.minHeight!==void 0&&t<this.minHeight?this.minHeight:t}awake(){super.awake(),this._anchoredPosition||(this._anchoredPosition=new h.Vector2),this.lastMatrix=new h.Matrix4,this.rectBlock=new h.Object3D,this.rectBlock.name=this.name,this._initialPosition=this.gameObject.position.clone(),this._initialPosition.z=0,na(this,"_anchoredPosition",()=>{this.markDirty()}),na(this,"sizeDelta",()=>{this.markDirty()}),na(this,"pivot",()=>{this.markDirty()}),na(this,"anchorMin",()=>{this.markDirty()}),na(this,"anchorMax",()=>{this.markDirty()})}onEnable(){var t;super.onEnable(),this.rectBlock||(this.rectBlock=new h.Object3D),this.lastMatrix||(this.lastMatrix=new h.Matrix4),this._lastAnchoring||(this._lastAnchoring=new h.Vector2),this._initialPosition||(this._initialPosition=new h.Vector3),this._anchoredPosition||(this._anchoredPosition=new h.Vector2),this.addShadowComponent(this.rectBlock),this._transformNeedsUpdate=!0,(t=this.canvas)==null||t.registerTransform(this)}onDisable(){var t;super.onDisable(),this.removeShadowComponent(),(t=this.canvas)==null||t.unregisterTransform(this)}onParentRectTransformChanged(t){this._transformNeedsUpdate||this.onApplyTransform(Jf?`${t.name} changed`:void 0)}get isDirty(){return this._transformNeedsUpdate||(this._transformNeedsUpdate=!this.lastMatrix.equals(this.gameObject.matrix)),this._transformNeedsUpdate}markDirty(){this._transformNeedsUpdate||(Jf&&console.warn("RectTransform markDirty()",this.name),this._transformNeedsUpdate=!0,this._lastUpdateFrame=-1)}updateTransform(){(this._transformNeedsUpdate||!this.lastMatrix.equals(this.gameObject.matrix))&&this.canUpdate()&&this.onApplyTransform(this._transformNeedsUpdate?"Marked dirty":"Matrix changed")}canUpdate(){return this._transformNeedsUpdate&&this.activeAndEnabled&&this._lastUpdateFrame!==this.context.time.frame}onApplyTransform(t){var n;if(this.context.time.frameCount===this._lastUpdateFrame)return;this._lastUpdateFrame=this.context.time.frameCount;const e=this.shadowComponent;if(!e)return;this.gameObject.parent?this._parentRectTransform=S.getComponentInParent(this.gameObject.parent,vw):this._parentRectTransform=void 0,this._transformNeedsUpdate=!1,Jf&&console.warn("RectTransform → ApplyTransform",this.name+" because "+t),this.isRoot()?this.Root.screenspace||(e.rotation.y=Math.PI):(e.matrix.identity(),e.matrixAutoUpdate=!1,en.set(0,0,0),this.applyPivot(en),e.matrix.setPosition(en.x,en.y,0),(this.gameObject.quaternion.x||this.gameObject.quaternion.y||this.gameObject.quaternion.z)&&(Yh.copy(this.gameObject.quaternion),Yh.x*=-1,Yh.z*=-1,Pl.makeRotationFromQuaternion(Yh),e.matrix.premultiply(Pl)),en.set(0,0,0),this.applyAnchoring(en),(n=this.canvas)!=null&&n.screenspace?en.z+=.1:en.z+=.01,Pl.identity(),Pl.setPosition(en.x,en.y,en.z),e.matrix.premultiply(Pl),e.matrix.scale(this.gameObject.scale)),this.lastMatrix.copy(this.gameObject.matrix);const i=!0;for(const o of ku(this.gameObject,Gi,i,1)){if(o===this||!o.activeAndEnabled)continue;const a=o;a.onParentRectTransformChanged&&a.onParentRectTransformChanged(this)}}applyAnchoring(t){this._lastAnchoring||(this._lastAnchoring=new h.Vector2);const e=this._lastAnchoring.sub(this._anchoredPosition);this.gameObject.position.x+=e.x,this.gameObject.position.y+=e.y,this._lastAnchoring.copy(this._anchoredPosition),t.x+=this._initialPosition.x-this.gameObject.position.x,t.y+=this._initialPosition.y-this.gameObject.position.y,t.z+=this._initialPosition.z-this.gameObject.position.z;const i=this._parentRectTransform;if(i){let n=0;const o=1-this.anchorMax.y-this.anchorMin.y;n-=i.height*.5*o,t.y+=n;let a=0;const l=1-this.anchorMax.x-this.anchorMin.x;a-=i.width*.5*l,t.x+=a}}applyPivot(t){if(this.pivot&&!this.isRoot()){const e=this.pivot.x-.5;t.x-=e*this.sizeDelta.x*this.gameObject.scale.x;const i=this.pivot.y-.5;t.y-=i*this.sizeDelta.y*this.gameObject.scale.y}}getBasicOptions(){const t={width:this.sizeDelta.x,height:this.sizeDelta.y,offset:0,backgroundOpacity:0,borderWidth:0,borderRadius:0,borderOpacity:0,letterSpacing:-.03};return this.ensureValidSize(t),t}ensureValidSize(t,e=1e-4){return t.width<=0&&(t.width=e),t.height<=0&&(t.height=1e-4),t}createNewBlock(t){t={...this.getBasicOptions(),...t},Zf&&console.log(this.name,t);const e=new ie.__webpack_exports__Block(t);return this._createdBlocks.push(e),e}createNewText(t){Zf&&console.log(t),t={...this.getBasicOptions(),...t},Zf&&console.log(this.name,t);const e=new ie.__webpack_exports__Text(t);return this._createdTextBlocks.push(e),e}};let Et=vw;hh([p(h.Vector2)],Et.prototype,"anchoredPosition",1);hh([p(h.Vector2)],Et.prototype,"sizeDelta",2);hh([p(h.Vector2)],Et.prototype,"pivot",2);hh([p(h.Vector2)],Et.prototype,"anchorMin",2);hh([p(h.Vector2)],Et.prototype,"anchorMax",2);var $M=Object.defineProperty,WM=Object.getOwnPropertyDescriptor,ww=(s,t,e,i)=>{for(var n=i>1?void 0:i?WM(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&$M(t,e,n),n};class Ja extends D{constructor(){super(...arguments);r(this,"effectColor");r(this,"effectDistance")}}ww([p(me)],Ja.prototype,"effectColor",2);ww([p(h.Vector2)],Ja.prototype,"effectDistance",2);var GM=Object.defineProperty,HM=Object.getOwnPropertyDescriptor,xw=(s,t,e,i)=>{for(var n=i>1?void 0:i?HM(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&GM(t,e,n),n};const Kh={backgroundColor:new h.Color(1,1,1),backgroundOpacity:1,borderColor:new h.Color(1,1,1),borderOpacity:1};var Sp;const Gl=(Sp=class extends Gi{constructor(){super(...arguments);r(this,"_alphaFactor",1);r(this,"sRGBColor",new h.Color(1,0,1));r(this,"raycastTarget",!0);r(this,"uiObject",null);r(this,"_color",null);r(this,"_rect",null);r(this,"_stateManager",null);r(this,"_currentlyCreatingPanel",!1)}get isGraphic(){return!0}get color(){return this._color||(this._color=new me(1,1,1,1)),this._color}set color(t){(!this._color||this._color.r!==t.r||this._color.g!==t.g||this._color.b!==t.b||this._color.alpha!==t.alpha)&&(this._color||(this._color=new me(1,1,1,1)),this._color.copy(t),this.onColorChanged())}setAlphaFactor(t){this._alphaFactor=t,this.onColorChanged()}get alphaFactor(){return this._alphaFactor}onColorChanged(){this.uiObject&&(this.sRGBColor.copy(this._color),this.sRGBColor.convertLinearToSRGB(),Kh.backgroundColor=this.sRGBColor,Kh.backgroundOpacity=this._color.alpha*this._alphaFactor,this.applyEffects(Kh,this._alphaFactor),this.uiObject.set(Kh),this.markDirty())}get m_Color(){return this._color}get rectTransform(){if(this._rect||(this._rect=S.getComponent(this.gameObject,Et)),!this._rect)throw new Error("Not Supported: Make sure to add a RectTransform component before adding a UI Graphic component.");return this._rect}onParentRectTransformChanged(){var t;(t=this.uiObject)==null||t.set({width:this.rectTransform.width,height:this.rectTransform.height}),this.markDirty()}__internalNewInstanceCreated(t){return super.__internalNewInstanceCreated(t),this._rect=null,this.uiObject=null,this._color&&(this._color=this._color.clone()),this}setState(t){this.makePanel(),this.uiObject&&(this.uiObject.setState(t),this==null||this.markDirty())}setupState(t){this.makePanel(),this.uiObject&&(this._stateManager||(this._stateManager=new ie.SimpleStateBehavior(this.uiObject)),this.uiObject.setupState(t.state,t.attributes))}setOptions(t){this.makePanel(),this.uiObject&&this.uiObject.set(t)}awake(){super.awake(),this.makePanel(),na(this,"_color",()=>vP(this,this.onColorChanged))}onEnable(){var t;super.onEnable(),this.uiObject&&((t=this.rectTransform.shadowComponent)==null||t.add(this.uiObject),this.addShadowComponent(this.uiObject,this.rectTransform))}onDisable(){super.onDisable(),this.uiObject&&this.removeShadowComponent()}makePanel(){if(this.uiObject||this._currentlyCreatingPanel)return;this._currentlyCreatingPanel=!0;const t=.015,e={backgroundColor:this.color,backgroundOpacity:this.color.alpha,offset:t};this.onBeforeCreate(e),this.applyEffects(e),this.onCreate(e),this.controlsChildLayout=!1,this._currentlyCreatingPanel=!1,this.onAfterCreated(),this.onColorChanged()}onBeforeCreate(t){}onCreate(t){this.uiObject=this.rectTransform.createNewBlock(t),this.uiObject.name=this.name}onAfterCreated(){}applyEffects(t,e=1){var n;const i=(n=this.gameObject)==null?void 0:n.getComponent(Ja);i&&(i.effectDistance&&(t.borderWidth=Math.max(Math.abs(i.effectDistance.x),Math.abs(i.effectDistance.y))),i.effectColor&&(t.borderColor=i.effectColor,t.borderOpacity=i.effectColor.alpha*e))}async setTexture(t){if(this.setOptions({backgroundOpacity:0}),t){if(Gl.textureCache.has(t))t=Gl.textureCache.get(t);else if(!t.isRenderTargetTexture){const e=t.clone();e.colorSpace=h.LinearSRGBColorSpace,Gl.textureCache.set(t,e),t=e}this.setOptions({backgroundImage:t,borderRadius:0,backgroundOpacity:this.color.alpha,backgroundSize:"stretch"}),re.NEEDLE_progressive.assignTextureLOD(t,0).then(e=>{e instanceof h.Texture&&(t&&Gl.textureCache.set(t,e),this.setOptions({backgroundImage:e}),this.markDirty())})}else this.setOptions({backgroundImage:void 0,borderRadius:0,backgroundOpacity:this.color.alpha});this.markDirty()}onAfterAddedToScene(){super.onAfterAddedToScene(),this.shadowComponent&&(this.shadowComponent.offset=this.shadowComponent.position.z)}},r(Sp,"textureCache",new Map),Sp);let Mr=Gl;xw([p(me)],Mr.prototype,"color",1);xw([p()],Mr.prototype,"raycastTarget",2);class dh extends Mr{constructor(){super(...arguments);r(this,"_flippedObject",!1)}onAfterCreated(){this.uiObject&&!this._flippedObject&&(this._flippedObject=!0,this.uiObject.scale.y*=-1)}}var qM=Object.defineProperty,XM=Object.getOwnPropertyDescriptor,Ps=(s,t,e,i)=>{for(var n=i>1?void 0:i?XM(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&qM(t,e,n),n};const Ao=x("debugtext");var Je=(s=>(s[s.UpperLeft=0]="UpperLeft",s[s.UpperCenter=1]="UpperCenter",s[s.UpperRight=2]="UpperRight",s[s.MiddleLeft=3]="MiddleLeft",s[s.MiddleCenter=4]="MiddleCenter",s[s.MiddleRight=5]="MiddleRight",s[s.LowerLeft=6]="LowerLeft",s[s.LowerCenter=7]="LowerCenter",s[s.LowerRight=8]="LowerRight",s))(Je||{}),Sw=(s=>(s[s.Normal=0]="Normal",s[s.Bold=1]="Bold",s[s.Italic=2]="Italic",s[s.BoldAndItalic=3]="BoldAndItalic",s))(Sw||{});class Tt extends Mr{constructor(){super(...arguments);r(this,"alignment",0);r(this,"verticalOverflow",0);r(this,"horizontalOverflow",0);r(this,"lineSpacing",1);r(this,"supportRichText",!1);r(this,"font");r(this,"fontStyle",0);r(this,"sRGBTextColor",new h.Color(1,0,1));r(this,"_text","");r(this,"_fontSize",12);r(this,"_textMeshUi",null);r(this,"_didHandleTextRenderOnTop",!1)}setAlphaFactor(e){var i;super.setAlphaFactor(e),(i=this.uiObject)==null||i.set({fontOpacity:this.color.alpha*this.alphaFactor}),this.markDirty()}get text(){return this._text}set text(e){e!==this._text&&(this._text=e,this.feedText(this.text,this.supportRichText),this.markDirty())}set_text(e){this.text=e}get fontSize(){return this._fontSize}set fontSize(e){var i;this._fontSize=e,(i=this.uiObject)==null||i.set({fontSize:e})}onColorChanged(){var e;this.sRGBTextColor.copy(this.color),this.sRGBTextColor.convertLinearToSRGB(),(e=this.uiObject)==null||e.set({color:this.sRGBTextColor,fontOpacity:this.color.alpha})}onParentRectTransformChanged(){super.onParentRectTransformChanged(),this.uiObject&&this.updateOverflow()}onBeforeCanvasRender(e){this.updateOverflow()}updateOverflow(){var i;const e=(i=this.uiObject)==null?void 0:i._overflow;e&&(e._needsUpdate=!0)}onCreate(e){Ao&&console.log(this),this.horizontalOverflow==1&&(e.whiteSpace="pre"),this.verticalOverflow==0&&(this.context.renderer.localClippingEnabled=!0,e.overflow="hidden"),this.horizontalOverflow==1&&this.verticalOverflow==0,e.lineHeight=this.lineSpacing,delete e.backgroundOpacity,delete e.backgroundColor,Ao&&(e.backgroundColor=16750848,e.backgroundOpacity=.5);const i=this.rectTransform;e={...e,...this.getTextOpts()},this.getAlignment(e),Ao&&(e.backgroundColor=Math.random()*16777215,e.backgroundOpacity=.1),this.uiObject=i.createNewText(e),this.feedText(this.text,this.supportRichText)}onAfterAddedToScene(){super.onAfterAddedToScene(),this.handleTextRenderOnTop()}getTextOpts(){const e=this.fontSize,i={color:this.color,fontOpacity:this.color.alpha,fontSize:e,fontKerning:"normal"};return this.setFont(i,this.fontStyle),i}onEnable(){var e;super.onEnable(),this._didHandleTextRenderOnTop=!1,this.uiObject&&this.uiObject.addAfterUpdate(()=>{this.setShadowComponentOwner(this.uiObject),this.markDirty()}),setTimeout(()=>this.markDirty(),10),(e=this.canvas)==null||e.registerEventReceiver(this)}onDisable(){var e;super.onDisable(),(e=this.canvas)==null||e.unregisterEventReceiver(this)}getAlignment(e){switch(e.flexDirection="column",this.alignment){case 0:case 3:case 6:e.textAlign="left";break;case 1:case 4:case 7:e.textAlign="center";break;case 2:case 5:case 8:e.textAlign="right";break}switch(this.alignment){default:case 0:case 1:case 2:e.alignItems="start";break;case 3:case 4:case 5:e.alignItems="center";break;case 6:case 7:case 8:e.alignItems="end";break}return e}feedText(e,i){var n,o,a;if(Ao&&console.log("feedText",this.uiObject,e,i),!!this.uiObject)if(this._textMeshUi||(this._textMeshUi=[]),this.uiObject.children.length=0,!i||e.length===0)this.uiObject.textContent=e;else{let l=this.getNextTag(e);if(l){if(l.startIndex>0){for(let u=this.uiObject.children.length-1;u>=0;u--){const f=this.uiObject.children[u];f.isUI&&(this.uiObject.remove(f),f.clear())}const d=new ie.__webpack_exports__Inline({textContent:e.substring(0,l.startIndex),color:"inherit"});this.uiObject.add(d)}}else{this.uiObject.textContent="",this.setOptions({textContent:e});return}const c=[];for(;l;){const d=this.getNextTag(e,l.endIndex),u={fontFamily:(n=this.uiObject)==null?void 0:n.get("fontFamily"),color:"inherit",textContent:""};if(d){u.textContent=this.getText(e,l,d),this.handleTag(l,u,c);const f=new ie.__webpack_exports__Inline(u);(o=this.uiObject)==null||o.add(f)}else{u.textContent=e.substring(l.endIndex),this.handleTag(l,u,c);const f=new ie.__webpack_exports__Inline(u);(a=this.uiObject)==null||a.add(f)}l=d}}}handleTextRenderOnTop(){this._didHandleTextRenderOnTop||(this._didHandleTextRenderOnTop=!0,this.startCoroutine(this.renderOnTopCoroutine()))}*renderOnTopCoroutine(){if(!this.canvas)return;const e=[],i=this.canvas,n={renderOnTop:i.renderOnTop,depthWrite:i.depthWrite,doubleSided:i.doubleSided};for(;;){let o=!1;if(this._textMeshUi)for(let a=0;a<this._textMeshUi.length;a++){if(e[a]===!0)continue;o=!0;const l=this._textMeshUi[a];l.textContent&&(Yd(l,n),e[a]=!0)}if(!o)break;yield}}handleTag(e,i,n){if(!e.isEndTag){if(e.type.includes("color")){const o=new ep(e,{color:i.color});if(n.push(o),e.type.length>6){const a=parseInt("0x"+e.type.substring(7));i.color=a}else i.color=new h.Color(1,1,1)}else if(e.type=="b"){this.setFont(i,1);const o=new ep(e,{fontWeight:700});n.push(o)}else if(e.type=="i"){this.setFont(i,2);const o=new ep(e,{fontStyle:"italic"});n.push(o)}}}getText(e,i,n){return e.substring(i.endIndex,n.startIndex)}getNextTag(e,i=0){const n=e.indexOf("<",i),o=e.indexOf(">",n);if(n>=0&&o>=0){const a=e.substring(n+1,o);return{type:a,startIndex:n,endIndex:o+1,isEndTag:a.startsWith("/")}}return null}setFont(e,i){if(!this.font)return;const n=this.font,o=this.getFamilyNameWithCorrectSuffix(n,i);Ao&&console.log("Selected font family:"+o);let a=ie.__webpack_exports__FontLibrary.getFontFamily(o);switch(a||(a=ie.__webpack_exports__FontLibrary.addFontFamily(o)),e.fontFamily=a,i){default:case 0:e.fontWeight=400,e.fontStyle="normal";break;case 1:e.fontWeight=700,e.fontStyle="normal";break;case 2:e.fontWeight=400,e.fontStyle="italic";break;case 3:e.fontStyle="italic",e.fontWeight=400}let l=a.getVariant(e.fontWeight,e.fontStyle);if(!l){let c=o;c!=null&&c.endsWith("-msdf.json")||(c+="-msdf.json");let d=o;d!=null&&d.endsWith(".png")||(d+=".png"),l=a.addVariant(e.fontWeight,e.fontStyle,c,d),l==null||l.addEventListener("ready",()=>{this.markDirty()})}}getFamilyNameWithCorrectSuffix(e,i){var u;const n=e.lastIndexOf("-");if(n<0)return e;const o=(u=e.substring(n+1))==null?void 0:u.toLowerCase();if(QM.includes(o))return Ao&&console.warn("Unsupported font style: "+o),e;const a=e.lastIndexOf("/");let l=e;a>=0&&(l=l.substring(a+1));const c=l[0]===l[0].toUpperCase(),d=e.substring(0,n);switch(Ao&&console.log("Select font: ",e,Sw[i],l,c,d),i){case 0:return c?d+"-Regular":d+"-regular";case 1:return c?d+"-Bold":d+"-bold";case 2:return c?d+"-Italic":d+"-italic";case 3:return c?d+"-BoldItalic":d+"-bolditalic";default:return e}}}Ps([p()],Tt.prototype,"alignment",2);Ps([p()],Tt.prototype,"verticalOverflow",2);Ps([p()],Tt.prototype,"horizontalOverflow",2);Ps([p()],Tt.prototype,"lineSpacing",2);Ps([p()],Tt.prototype,"supportRichText",2);Ps([p(URL)],Tt.prototype,"font",2);Ps([p()],Tt.prototype,"fontStyle",2);Ps([p()],Tt.prototype,"text",1);Ps([p()],Tt.prototype,"fontSize",1);class ep{constructor(t,e){r(this,"tag");r(this,"previousValues");this.tag=t,this.previousValues=e}}const QM=["medium","mediumitalic","black","blackitalic","thin","thinitalic","extrabold","light","lightitalic","semibold"];class Go{constructor(t){r(this,"id");r(this,"content","");r(this,"font",[]);r(this,"pointSize",144);r(this,"width");r(this,"height");r(this,"depth");r(this,"wrapMode");r(this,"horizontalAlignment");r(this,"verticalAlignment");r(this,"material");this.id=t}static getId(){return this.global_id++}setDepth(t){return this.depth=t,this}setPointSize(t){return this.pointSize=t,this}setHorizontalAlignment(t){return this.horizontalAlignment=t,this}setVerticalAlignment(t){return this.verticalAlignment=t,this}writeTo(t,e){var n;e.beginBlock(`def Preliminary_Text "${this.id}"`,"(",!1),e.appendLine('prepend apiSchemas = ["MaterialBindingAPI"]'),e.closeBlock(")"),e.beginBlock(),this.content&&e.appendLine(`string content = "${this.content}"`),(!this.font||this.font.length<=0)&&(this.font||(this.font=[]),(n=this.font)==null||n.push("sans-serif"));const i=this.font.map(o=>`"${o}"`).join(", ");e.appendLine(`string[] font = [ ${i} ]`),e.appendLine(`double pointSize = ${this.pointSize}`),typeof this.width=="number"&&e.appendLine(`double width = ${this.width}`),typeof this.height=="number"&&e.appendLine(`double height = ${this.height}`),typeof this.depth=="number"&&e.appendLine(`double depth = ${this.depth}`),this.wrapMode&&e.appendLine(`token wrapMode = "${this.wrapMode}"`),this.horizontalAlignment&&e.appendLine(`token horizontalAlignment = "${this.horizontalAlignment}"`),this.verticalAlignment&&e.appendLine(`token verticalAlignment = "${this.verticalAlignment}"`),this.material!==void 0&&e.appendLine(`rel material:binding = </StageRoot/Materials/${Ag(this.material)}>`),e.closeBlock()}}r(Go,"global_id",0);class zg{static singleLine(t,e,i){const n=new Go("text_"+Go.getId());return n.content=t,e&&(n.pointSize=e),i&&(n.depth=i),n}static multiLine(t,e,i,n,o,a){const l=new Go("text_"+Go.getId());return l.content=t,l.width=e,l.height=i,l.horizontalAlignment=n,l.verticalAlignment=o,a!==void 0&&(l.wrapMode=a),l}}const YM=new h.Matrix4().makeRotationY(Math.PI),KM=new h.Matrix4().makeScale(-1,1,-1);class Gu{get extensionName(){return"text"}exportText(t,e,i){const n=S.getComponent(t,Tt);if(!n)return;const o=S.getComponent(t,Et);let a=100,l=100;o&&(a=o.width,l=o.height);const c=YM.clone();o&&c.premultiply(KM),e.setMatrix(c);const d=n.color.clone();e.material=new h.MeshStandardMaterial({color:d,emissive:d}),e.addEventListener("serialize",(u,f)=>{let m=n.text;m=m.replace(/\r/g,""),m=m.replace(/\n/g,"\\n");const g=zg.multiLine(m,a,l,"center","bottom","flowing");this.setTextAlignment(g,n.alignment),this.setOverflow(g,n),e.material&&(g.material=e.material),g.pointSize=this.convertToTextSize(n.fontSize),g.depth=.001,g.writeTo(void 0,u)})}convertToTextSize(t){return 1/.0502*144*t}setOverflow(t,e){e.horizontalOverflow?t.wrapMode="singleLine":t.wrapMode="flowing"}setTextAlignment(t,e){switch(e){case Je.LowerLeft:case Je.MiddleLeft:case Je.UpperLeft:t.horizontalAlignment="left";break;case Je.LowerCenter:case Je.MiddleCenter:case Je.UpperCenter:t.horizontalAlignment="center";break;case Je.LowerRight:case Je.MiddleRight:case Je.UpperRight:t.horizontalAlignment="right";break}switch(e){case Je.LowerLeft:case Je.LowerCenter:case Je.LowerRight:t.verticalAlignment="bottom";break;case Je.MiddleLeft:case Je.MiddleCenter:case Je.MiddleRight:t.verticalAlignment="middle";break;case Je.UpperLeft:case Je.UpperCenter:case Je.UpperRight:t.verticalAlignment="top";break}}}var ZM=Object.defineProperty,JM=Object.getOwnPropertyDescriptor,Ye=(s,t,e,i)=>{for(var n=i>1?void 0:i?JM(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&ZM(t,e,n),n};const ib=x("debuguilayout");class Rr{constructor(){r(this,"left",0);r(this,"right",0);r(this,"top",0);r(this,"bottom",0)}get vertical(){return this.top+this.bottom}get horizontal(){return this.left+this.right}}Ye([p()],Rr.prototype,"left",2);Ye([p()],Rr.prototype,"right",2);Ye([p()],Rr.prototype,"top",2);Ye([p()],Rr.prototype,"bottom",2);class Mi extends D{constructor(){super(...arguments);r(this,"_rectTransform",null);r(this,"_needsUpdate",!1);r(this,"childAlignment",0);r(this,"reverseArrangement",!1);r(this,"spacing",0);r(this,"padding");r(this,"minWidth",0);r(this,"minHeight",0);r(this,"flexibleHeight",0);r(this,"flexibleWidth",0);r(this,"preferredHeight",0);r(this,"preferredWidth",0)}get rectTransform(){return this._rectTransform}onParentRectTransformChanged(e){this._needsUpdate=!0}get isDirty(){return this._needsUpdate}get isLayoutGroup(){return!0}updateLayout(){this._rectTransform&&(ib&&console.warn("Layout Update",this.context.time.frame,this.name),this._needsUpdate=!1,this.onCalculateLayout(this._rectTransform))}start(){this._needsUpdate=!0}onEnable(){ib&&console.log(this.name,this),this._rectTransform=this.gameObject.getComponent(Et);const e=this.gameObject.getComponentInParent(St);e&&e.registerLayoutGroup(this),this._needsUpdate=!0}onDisable(){const e=this.gameObject.getComponentInParent(St);e&&e.unregisterLayoutGroup(this)}set m_Spacing(e){e!==this.spacing&&(this._needsUpdate=!0,this.spacing=e)}get m_Spacing(){return this.spacing}}Ye([p()],Mi.prototype,"childAlignment",2);Ye([p()],Mi.prototype,"reverseArrangement",2);Ye([p()],Mi.prototype,"spacing",2);Ye([p(Rr)],Mi.prototype,"padding",2);Ye([p()],Mi.prototype,"minWidth",2);Ye([p()],Mi.prototype,"minHeight",2);Ye([p()],Mi.prototype,"flexibleHeight",2);Ye([p()],Mi.prototype,"flexibleWidth",2);Ye([p()],Mi.prototype,"preferredHeight",2);Ye([p()],Mi.prototype,"preferredWidth",2);class xo extends Mi{constructor(){super(...arguments);r(this,"childControlHeight",!0);r(this,"childControlWidth",!0);r(this,"childForceExpandHeight",!1);r(this,"childForceExpandWidth",!1);r(this,"childScaleHeight",!1);r(this,"childScaleWidth",!1)}onCalculateLayout(e){var I;const i=this.primaryAxis,n=e.width;let o=n;const a=e.height;let l=a;o-=this.padding.horizontal,l-=this.padding.vertical,i==="x"?this.padding.horizontal:this.padding.vertical;const c=i==="x",d=c?"y":"x",u=c?this.childControlWidth:this.childControlHeight,f=c?this.childControlHeight:this.childControlWidth,m=c?this.childForceExpandWidth:this.childForceExpandHeight,g=c?this.childForceExpandHeight:this.childForceExpandWidth,_=c?l:o,y=c?n:a,b=.5*(c?this.childAlignment%3:Math.floor(this.childAlignment/3));let v=0;c?v+=this.padding.left:v+=this.padding.top;let w=0,P=0;for(let T=0;T<this.gameObject.children.length;T++){const j=this.gameObject.children[T],F=S.getComponent(j,Et);F!=null&&F.activeAndEnabled&&(P+=1,c?w+=F.width:w+=F.height)}let k=0;const O=this.spacing*(P-1);if(m||u){let T=0;c?T=o-=O:T=l-=O,P>0&&(k=T/P)}let M=0;M+=this.padding.left,M-=this.padding.right,b!==0&&(v=y-w,v*=b,v-=O*b,c?(v-=this.padding.right*b,v+=this.padding.left*(1-b),v<this.padding.left&&(v=this.padding.left)):(v-=this.padding.bottom*b,v+=this.padding.top*(1-b),v<this.padding.top&&(v=this.padding.top)));let A=1;for(let T=0;T<this.gameObject.children.length;T++){const j=this.gameObject.children[T],F=S.getComponent(j,Et);if(F!=null&&F.activeAndEnabled){(I=F.pivot)==null||I.set(.5,.5),F.anchorMin.set(0,1),F.anchorMax.set(0,1);const X=n*.5+M*.5;F.anchoredPosition.x!==X&&(F.anchoredPosition.x=X);const E=a*-.5;F.anchoredPosition.y!==E&&(F.anchoredPosition.y=E),g&&f&&F.sizeDelta[d]!==_&&(F.sizeDelta[d]=_),m&&u&&F.sizeDelta[i]!==k&&(F.sizeDelta[i]=k);const L=c?F.width:F.height,V=L*.5;if(v+=V,m){const K=k*A-k*.5;K>v&&(v=K-k*.5+L+this.padding.left,v-=V)}let G=v;i==="y"&&(G=-G),F.anchoredPosition[i]!==G&&(F.anchoredPosition[i]=G),v+=V,v+=this.spacing,A+=1}}}}Ye([p()],xo.prototype,"childControlHeight",2);Ye([p()],xo.prototype,"childControlWidth",2);Ye([p()],xo.prototype,"childForceExpandHeight",2);Ye([p()],xo.prototype,"childForceExpandWidth",2);Ye([p()],xo.prototype,"childScaleHeight",2);Ye([p()],xo.prototype,"childScaleWidth",2);class Ng extends xo{get primaryAxis(){return"y"}}class Vg extends xo{get primaryAxis(){return"x"}}class $g extends Mi{onCalculateLayout(){}}var eR=Object.defineProperty,tR=Object.getOwnPropertyDescriptor,Wn=(s,t,e,i)=>{for(var n=i>1?void 0:i?tR(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&eR(t,e,n),n},Cw=(s=>(s[s.ScreenSpaceOverlay=0]="ScreenSpaceOverlay",s[s.ScreenSpaceCamera=1]="ScreenSpaceCamera",s[s.WorldSpace=2]="WorldSpace",s[s.Undefined=-1]="Undefined",s))(Cw||{});const tp=x("debuguilayout"),Pw=class extends eh{constructor(){super(...arguments);r(this,"_renderOnTop");r(this,"_depthWrite",!1);r(this,"_doubleSided",!0);r(this,"_castShadows",!1);r(this,"_receiveShadows",!1);r(this,"_renderMode",-1);r(this,"_rootCanvas");r(this,"_scaleFactor",1);r(this,"worldCamera");r(this,"planeDistance",-1);r(this,"_boundRenderSettingsChanged",this.onRenderSettingsChanged.bind(this));r(this,"previousParent",null);r(this,"_lastMatrixWorld",null);r(this,"_rectTransforms",[]);r(this,"_layoutGroups",new Map);r(this,"_receivers",[]);r(this,"onBeforeRenderRoutine",()=>{var t,e,i,n;if(this.previousParent=this.gameObject.parent,((t=this.context.xr)!=null&&t.isVR||(e=this.context.xr)!=null&&e.isPassThrough)&&this.screenspace){this.gameObject.visible=!1,this.gameObject.removeFromParent();return}this.renderOnTop||this.screenspace?this.gameObject.removeFromParent():(this.onUpdateRenderMode(),this.handleLayoutUpdates(),(i=this.shadowComponent)==null||i.updateMatrixWorld(!0),(n=this.shadowComponent)==null||n.updateWorldMatrix(!0,!0),this.invokeBeforeRenderEvents(),Gt.ensureUpdateMeshUI(ie.ThreeMeshUI,this.context))});r(this,"onAfterRenderRoutine",()=>{var t,e,i,n,o;if(((t=this.context.xr)!=null&&t.isVR||(e=this.context.xr)!=null&&e.isPassThrough)&&this.screenspace){(i=this.previousParent)==null||i.add(this.gameObject);return}if((this.screenspace||this.renderOnTop)&&this.previousParent&&this.context.mainCamera){if(this.screenspace){const c=this.context.mainCamera;c==null||c.add(this.gameObject)}else this.previousParent.add(this.gameObject);const a=this.context.renderer.autoClear,l=this.context.renderer.autoClearColor;this.context.renderer.autoClear=!1,this.context.renderer.autoClearColor=!1,this.context.renderer.clearDepth(),this.onUpdateRenderMode(!0),this.handleLayoutUpdates(),(n=this.shadowComponent)==null||n.updateMatrixWorld(!0),this.invokeBeforeRenderEvents(),Gt.ensureUpdateMeshUI(ie.ThreeMeshUI,this.context,!0),this.context.renderer.render(this.gameObject,this.context.mainCamera),this.context.renderer.autoClear=a,this.context.renderer.autoClearColor=l,this.previousParent.add(this.gameObject)}(o=this._lastMatrixWorld)==null||o.copy(this.gameObject.matrixWorld)});r(this,"_updateRenderSettingsRoutine");r(this,"_activeRenderMode",-1);r(this,"_lastWidth",-1);r(this,"_lastHeight",-1)}get isCanvas(){return!0}get screenspace(){return this.renderMode!==2}set renderOnTop(t){t!==this._renderOnTop&&(this._renderOnTop=t,this.onRenderSettingsChanged())}get renderOnTop(){return this._renderOnTop!==void 0?this._renderOnTop:!!(this.screenspace&&this._renderMode===0)}set depthWrite(t){this._depthWrite!==t&&(this._depthWrite=t,this.onRenderSettingsChanged())}get depthWrite(){return this._depthWrite}set doubleSided(t){this._doubleSided!==t&&(this._doubleSided=t,this.onRenderSettingsChanged())}get doubleSided(){return this._doubleSided}set castShadows(t){this._castShadows!==t&&(this._castShadows=t,this.onRenderSettingsChanged())}get castShadows(){return this._castShadows}set receiveShadows(t){this._receiveShadows!==t&&(this._receiveShadows=t,this.onRenderSettingsChanged())}get receiveShadows(){return this._receiveShadows}get renderMode(){return this._renderMode}set renderMode(t){this._renderMode!==t&&(this._renderMode=t,this.onRenderSettingsChanged())}set rootCanvas(t){this._rootCanvas instanceof Pw||(this._rootCanvas=t)}get rootCanvas(){return this._rootCanvas}get scaleFactor(){return this._scaleFactor}set scaleFactor(t){this._scaleFactor=t}awake(){var t;this.shadowComponent=this.gameObject,this.previousParent=this.gameObject.parent,tp&&console.log("Canvas.Awake()",((t=this.previousParent)==null?void 0:t.name)+"/"+this.gameObject.name),super.awake()}start(){this.applyRenderSettings()}onEnable(){super.onEnable(),this._updateRenderSettingsRoutine=void 0,this._lastMatrixWorld=new h.Matrix4,this.applyRenderSettings(),document.addEventListener("resize",this._boundRenderSettingsChanged),this.context.pre_render_callbacks.push(this.onBeforeRenderRoutine),this.context.post_render_callbacks.push(this.onAfterRenderRoutine)}onDisable(){super.onDisable(),document.removeEventListener("resize",this._boundRenderSettingsChanged);const t=this.context.pre_render_callbacks.indexOf(this.onBeforeRenderRoutine);t!==-1&&this.context.pre_render_callbacks.splice(t,1);const e=this.context.post_render_callbacks.indexOf(this.onAfterRenderRoutine);e!==-1&&this.context.post_render_callbacks.splice(e,1)}registerTransform(t){this._rectTransforms.push(t)}unregisterTransform(t){const e=this._rectTransforms.indexOf(t);e!==-1&&this._rectTransforms.splice(e,1)}registerLayoutGroup(t){const e=t.gameObject;this._layoutGroups.set(e,t)}unregisterLayoutGroup(t){const e=t.gameObject;this._layoutGroups.delete(e)}registerEventReceiver(t){this._receivers.push(t)}unregisterEventReceiver(t){const e=this._receivers.indexOf(t);e!==-1&&this._receivers.splice(e,1)}async onEnterXR(t){this.screenspace?(t.xr.isVR||t.xr.isPassThrough)&&(this.gameObject.visible=!1):(this.gameObject.visible=!1,await Uc(1).then(()=>{this.gameObject.visible=!0}))}onLeaveXR(t){this.screenspace&&(t.xr.isVR||t.xr.isPassThrough)&&(this.gameObject.visible=!0)}invokeBeforeRenderEvents(){var t;for(const e of this._receivers)(t=e.onBeforeCanvasRender)==null||t.call(e,this)}handleLayoutUpdates(){this._lastMatrixWorld===null&&(this._lastMatrixWorld=new h.Matrix4);const t=!this._lastMatrixWorld.equals(this.gameObject.matrixWorld);tp&&t&&console.log("Canvas Layout changed",this.context.time.frameCount,this.name);const e=!1;for(const i of this._rectTransforms){t&&i.markDirty();let n=this._layoutGroups.get(i.gameObject);i.isDirty&&!n&&(n=i.gameObject.getComponentInParent(Mi)),(i.isDirty||n!=null&&n.isDirty)&&(tp&&!e&&console.log("CANVAS UPDATE ### "+i.name+" ##################################### "+this.context.time.frame),n==null||n.updateLayout(),i.updateTransform())}}applyRenderSettings(){this.onRenderSettingsChanged()}onRenderSettingsChanged(){this._updateRenderSettingsRoutine||(this._updateRenderSettingsRoutine=this.startCoroutine(this._updateRenderSettingsDelayed(),ve.OnBeforeRender))}*_updateRenderSettingsDelayed(){if(yield,this._updateRenderSettingsRoutine=void 0,this.shadowComponent){this.onUpdateRenderMode(),Yd(this.shadowComponent,this);for(const t of S.getComponentsInChildren(this.gameObject,Gi))Yd(t.shadowComponent,this)}}onUpdateRenderMode(t=!1){if(!t&&this._renderMode===this._activeRenderMode&&this._lastWidth===this.context.domWidth&&this._lastHeight===this.context.domHeight)return;this._activeRenderMode=this._renderMode;let e=this.context.mainCameraComponent,i=10;switch(e&&e.nearClipPlane>0&&e.farClipPlane>0&&(i=z.lerp(e.nearClipPlane,e.farClipPlane,.01)),this._renderMode===1&&(this.worldCamera&&(e=this.worldCamera),this.planeDistance>0&&(i=this.planeDistance)),this._renderMode){case 0:case 1:if(this._lastWidth=this.context.domWidth,this._lastHeight=this.context.domHeight,!e)return;const n=i+.01;this.gameObject.position.x=0,this.gameObject.position.y=0,this.gameObject.position.z=-n,this.gameObject.quaternion.identity();const o=this.gameObject.getComponent(Et);let a=!1;o.sizeDelta.x!==this.context.domWidth&&(a=!0),o.sizeDelta.y!==this.context.domHeight&&(a=!0);const l=e.fieldOfView*Math.PI/180,c=2*Math.tan(l/2)*Math.abs(n);this.gameObject.scale.x=c/this.context.domHeight,this.gameObject.scale.y=c/this.context.domHeight,this.gameObject.scale.z=.01,a&&(o.sizeDelta.x=this.context.domWidth,o.sizeDelta.y=this.context.domHeight,o==null||o.markDirty());break;case 2:this._lastWidth=-1,this._lastHeight=-1;break}}};let St=Pw;Wn([p()],St.prototype,"renderOnTop",1);Wn([p()],St.prototype,"depthWrite",1);Wn([p()],St.prototype,"doubleSided",1);Wn([p()],St.prototype,"castShadows",1);Wn([p()],St.prototype,"receiveShadows",1);Wn([p()],St.prototype,"renderMode",1);Wn([p(St)],St.prototype,"rootCanvas",1);Wn([p()],St.prototype,"scaleFactor",1);Wn([p(ye)],St.prototype,"worldCamera",2);Wn([p()],St.prototype,"planeDistance",2);var iR=Object.defineProperty,nR=Object.getOwnPropertyDescriptor,Wg=(s,t,e,i)=>{for(var n=i>1?void 0:i?nR(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&iR(t,e,n),n};class uo extends D{constructor(){super(...arguments);r(this,"_alpha",1);r(this,"interactable",!0);r(this,"blocksRaycasts",!0);r(this,"_isDirty",!1);r(this,"_buffer",[])}get alpha(){return this._alpha}set alpha(e){e!==this._alpha&&(this._alpha=e,this.markDirty())}get isCanvasGroup(){return!0}markDirty(){this._isDirty||(this._isDirty=!0,this.startCoroutine(this.applyChangesDelayed(),ve.OnBeforeRender))}*applyChangesDelayed(){this._isDirty=!1,this.applyChangesNow()}applyChangesNow(){this._buffer.length=0;for(const e of S.getComponentsInChildren(this.gameObject,Gi,this._buffer)){const i=e;i.setAlphaFactor&&i.setAlphaFactor(this._alpha)}}}Wg([p()],uo.prototype,"alpha",1);Wg([p()],uo.prototype,"interactable",2);Wg([p()],uo.prototype,"blocksRaycasts",2);class Gg{get extensionName(){return"tmui"}onExportObject(t,e,i){const n=S.getComponent(t,St);if(n&&n.enabled&&n.renderMode===Cw.WorldSpace){const o=new Gu,a=S.getComponent(t,Et),l=S.getComponent(t,uo),c=new Array;if(a){if(!S.isActiveSelf(t)){const f=S.isActiveSelf(t);S.setActive(t,!0),a.onEnable(),a.updateTransform(),c.push(()=>{a.onDisable(),S.setActive(t,f)})}t.traverse(f=>{if(!S.isActiveInHierarchy(f)){const m=S.isActiveSelf(f);S.setActive(f,!0);const g=S.getComponent(f,Gi);g&&(g.onEnable(),c.push(()=>{g.onDisable()}));const _=S.getComponent(f,Et);_&&(_.onEnable(),_.updateTransform(),_.onApplyTransform(),c.push(()=>{_.onDisable()}));const y=S.getComponent(f,Tt);y&&(y.onEnable(),c.push(()=>{y.onDisable()})),c.push(()=>{S.setActive(f,m)})}}),a.width,a.height;const d=bt.createEmpty(),u=a.shadowComponent;if(e.add(d),u){const f=u.matrix;d.setMatrix(f);const m=new Map,g=new Map;m.set(u,d),g.set(u,l?l.alpha:1),u.traverse(_=>{if(_===u)return;const y=bt.createEmpty();y.setMatrix(_.matrix);const b=_.parent,v=!!b&&typeof b.textContent=="string"&&b.textContent.length>0;let w=g.get(b)||1;const P=S.getComponent(_,uo);if(P&&(w*=P.alpha),_ instanceof h.Mesh&&v){const O=_[Ui];O?o.exportText(O.gameObject,y,i):console.error("Error when exporting UI: shadow component owner not found. This is likely a bug.",_)}if(_ instanceof h.Mesh&&!v){const O=_.geometry.clone();O.scale(1,1,-1),this.flipWindingOrder(O),y.geometry=O;const M=new h.Color,A=_.material.opacity;M.copy(_.material.color),y.material=new h.MeshBasicMaterial({color:M,opacity:A*w,map:_.material.map,transparent:!0})}m.set(_,y),g.set(_,w);const k=m.get(b);if(!k){console.error("Error when exporting UI: shadow component parent not found!",_,_.parent);return}k.add(y)})}}for(const d of c)d()}}flipWindingOrder(t){const e=t.index.array;for(let i=0,n=e.length/3;i<n;i++){const o=e[i*3];e[i*3]=e[i*3+2],e[i*3+2]=o}t.index.needsUpdate=!0}}const Hl=x("debugusdz");function sR(s,t){var l;const e=[],i=S.getComponentsInChildren(s,xt),n=S.getComponentsInChildren(s,kt),o=new Array,a=new Array;if(t.injectImplicitBehaviours)for(const c of i){if(!c||!c.runtimeAnimatorController||!c.enabled)continue;const d=c.runtimeAnimatorController.activeState;if(!d||!d.motion||!d.motion.clip||((l=d.motion.clip.tracks)==null?void 0:l.length)<1||o.includes(c))continue;const u=new fr;u.animator=c,u.stateName=d.name,u.trigger="start",u.name="PlayAnimationOnClick_implicitAtStart_"+u.stateName;const f=new h.Object3D;S.addComponent(f,u),a.push(f),o.push(c),s.add(f)}else for(const c of i){if(!c||!c.runtimeAnimatorController||!c.enabled)continue;Hl&&console.log(c);const d=[];for(const u of c.runtimeAnimatorController.enumerateActions()){Hl&&console.log(u);const f=u.getClip();d.includes(f)||d.push(f)}e.push({root:c.gameObject,clips:d})}if(t.injectImplicitBehaviours)for(const c of n){if(!c||!c.clip||!c.enabled||!c.playAutomatically||o.includes(c))continue;const d=new fr;d.animation=c,d.stateName=c.clip.name,d.trigger="start",d.name="PlayAnimationOnClick_implicitAtStart_"+d.stateName;const u=new h.Object3D;S.addComponent(u,d),a.push(u),o.push(c),s.add(u)}else for(const c of n){Hl&&console.log(c);const d=[];for(const u of c.animations)d.includes(u)||d.push(u);e.push({root:c.gameObject,clips:d})}Hl&&(e==null?void 0:e.length)>0&&console.log("USDZ Animation Clips without behaviours",e);for(const c of e)for(const d of c.clips)t.registerAnimation(c.root,d);return a}function oR(s,t){const e=S.getComponentsInChildren(s,Ie),i=S.getComponentsInChildren(s,co),n=new Array,o=new Array;Hl&&console.log({audioSources:e,playAudioOnClicks:i});for(const a of i){if(!a.target)continue;const l=e.indexOf(a.target);l>-1&&e.splice(l,1)}for(const a of e){if(!a||!a.clip||a.volume<=0||n.includes(a))continue;const l=new co;l.target=a,l.name="PlayAudioOnClick_implicitAtStart_",l.trigger="start";const c=new h.Object3D;S.addComponent(c,l),console.log("implicit PlayAudioOnStart",c,l),o.push(c),n.push(a),s.add(c)}return o}function rR(s){return new ct("DisableAtStart",wt.sceneStartTrigger(),de.fadeAction(s,0,!1))}function nb(s,t){const e=s.domElement.shadowRoot.querySelector("link[rel='ar']");if(e)return e;const i=document.createElement("div");i.classList.add("menu"),i.classList.add("quicklook-menu"),i.style.display="none",i.style.visibility="hidden";const n=document.createElement("button");n.id="open-in-ar",t?(n.innerText="View in AR",n.title="View this scene in AR. The scene will be exported to USDZ and opened with Apple's QuickLook."):(n.innerText="View in AR",n.title="Download this scene for AR. Open the downloaded USDZ file to view it in AR using Apple's QuickLook."),i.appendChild(n);const o=document.createElement("a");o.id="needle-usdz-link",o.style.display="none",o.rel="ar",o.href="",o.target="_blank",i.appendChild(o);const a=document.createElement("img");return a.id="button",o.appendChild(a),s.domElement.shadowRoot.appendChild(i),o}var aR=Object.defineProperty,lR=Object.getOwnPropertyDescriptor,Pt=(s,t,e,i)=>{for(var n=i>1?void 0:i?lR(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&aR(t,e,n),n};const di=x("debugusdz"),cR=x("debugusdzpruning");class kr{constructor(){r(this,"callToAction");r(this,"checkoutTitle");r(this,"checkoutSubtitle");r(this,"callToActionURL")}}Pt([p()],kr.prototype,"callToAction",2);Pt([p()],kr.prototype,"checkoutTitle",2);Pt([p()],kr.prototype,"checkoutSubtitle",2);Pt([p()],kr.prototype,"callToActionURL",2);var ad;const dm=(ad=class extends D{constructor(){super(...arguments);r(this,"objectToExport");r(this,"autoExportAnimations",!0);r(this,"autoExportAudioSources",!0);r(this,"exportFileName");r(this,"customUsdzFile");r(this,"customBranding");r(this,"anchoringType","plane");r(this,"maxTextureSize",2048);r(this,"planeAnchoringAlignment","horizontal");r(this,"interactive",!0);r(this,"physics",!0);r(this,"allowCreateQuicklookButton",!0);r(this,"quickLookCompatible",!0);r(this,"extensions",[]);r(this,"link");r(this,"button");r(this,"onClickedOpenInARElement",t=>{t.preventDefault(),this.exportAndOpen()});r(this,"_currentExportTasks",new Map);r(this,"_previousTimeScale",1);r(this,"lastCallback");r(this,"_rootSessionRootWasAppliedTo",null);r(this,"_rootPositionBeforeExport",new h.Vector3);r(this,"_rootRotationBeforeExport",new h.Quaternion);r(this,"_rootScaleBeforeExport",new h.Vector3)}start(){var t,e,i;di&&(console.log("USDZExporter",this),console.log("Debug USDZ Mode. Press 'T' to export"),window.addEventListener("keydown",n=>{switch(n.key){case"t":this.exportAndOpen();break}})),this.objectToExport||(this.objectToExport=this.gameObject),!((e=(t=this.objectToExport)==null?void 0:t.children)!=null&&e.length)&&!((i=this.objectToExport)!=null&&i.isMesh)&&(this.objectToExport=this.context.scene)}onEnable(){var i;const t=exports.DeviceUtilities.supportsQuickLookAR(),e=exports.DeviceUtilities.isiOS()||exports.DeviceUtilities.isiPad();!this.button&&(di||t||e)&&(this.allowCreateQuicklookButton&&(this.button=this.createQuicklookButton()),this.lastCallback=this.quicklookCallback.bind(this),this.link=nb(this.context,t),this.link.addEventListener("message",this.lastCallback)),di&&Te("USDZ Exporter enabled: "+this.name),(i=document.getElementById("open-in-ar"))==null||i.addEventListener("click",this.onClickedOpenInARElement),Sc.registerExporter(this)}onDisable(){var t,e,i;(t=this.button)==null||t.remove(),(e=this.link)==null||e.removeEventListener("message",this.lastCallback),di&&Te("USDZ Exporter disabled: "+this.name),(i=document.getElementById("open-in-ar"))==null||i.removeEventListener("click",this.onClickedOpenInARElement),Sc.unregisterExporter(this)}async exportAsync(){return this.exportAndOpen()}async exportAndOpen(){var i;let t=this.exportFileName??((i=this.objectToExport)==null?void 0:i.name)??this.name;if(t+="-"+ew(),io()||(t!==""&&(t+="-"),t+="MadeWithNeedle"),this.link||(this.link=nb(this.context,exports.DeviceUtilities.supportsQuickLookAR())),this.customUsdzFile)return di&&console.log("Exporting custom usdz",this.customUsdzFile),this.openInQuickLook(this.customUsdzFile,t),null;if(!this.objectToExport)return console.warn("No object to export",this),null;const e=await this.export(this.objectToExport);return e?(di&&console.log("USDZ generation done. Downloading as "+t),this.openInQuickLook(e,t),e):(console.error("USDZ generation failed. Please report a bug",this),null)}async export(t){if(!t)return console.warn("No object to export"),null;const e=this._currentExportTasks.get(t);if(e)return e;const i=this.internalExport(t);return i instanceof Promise?(this._currentExportTasks.set(t,i),i.then(n=>(this._currentExportTasks.delete(t),n)).catch(n=>(this._currentExportTasks.delete(t),console.error("Error during USDZ export – please report a bug!",n),null))):i}async internalExport(t){se.start("export-usdz",{onProgress:O=>{this.dispatchEvent(new CustomEvent("export-progress",{detail:{progress:O}}))}}),se.report("export-usdz",{message:"Starting export",totalSteps:40,currentStep:0}),se.report("export-usdz",{message:"Load progressive textures",autoStep:5}),se.start("export-usdz-textures","export-usdz");const e=S.getComponentsInChildren(t,ai);for(const O of e)O&&O.enabled&&O.updateSprite(!0);const i=S.getComponentsInChildren(t,ze),n=new Array;let o=0;for(const O of i){for(const M of O.sharedMeshes)if(M){const A=re.NEEDLE_progressive.assignMeshLOD(M,0);A instanceof Promise&&n.push(new Promise((I,T)=>{A.then(()=>{o++,se.report("export-usdz-textures",{message:"Loaded progressive mesh",currentStep:o,totalSteps:n.length}),I()}).catch(j=>T(j))}))}for(const M of O.sharedMaterials)if(M){const A=re.NEEDLE_progressive.assignTextureLOD(M,0);A instanceof Promise&&n.push(new Promise((I,T)=>{A.then(()=>{o++,se.report("export-usdz-textures",{message:"Loaded progressive texture",currentStep:o,totalSteps:n.length}),I()}).catch(j=>T(j))}))}}di&&Te("Progressive Loading: "+n.length),await Promise.all(n),di&&Te("Progressive Loading: done"),se.end("export-usdz-textures");const a=Rt.Global.Mask;Rt.Global.Set(En.AR);const l=new ow,c=new Nu(this.quickLookCompatible);let d;const u=[];this.interactive&&(u.push(new Fg),u.push(new Cr),globalThis.false&&S.getComponentsInChildren(t,ue).length>0&&(this.physics?(d=new Ug,u.push(d)):B()&&console.warn("USDZExporter: Physics export is disabled, but there are active Rigidbody components in the scene. They will not be exported.")),u.push(new Gu),u.push(new Gg));const f=[c,...u,...this.extensions],m={self:this,exporter:l,extensions:f,object:t};se.report("export-usdz","Invoking before-export"),this.dispatchEvent(new CustomEvent("before-export",{detail:m})),this.applyWebARSessionRoot(),this._previousTimeScale=this.context.time.timeScale,this.context.time.timeScale=0,se.report("export-usdz","auto export animations and audio sources");const g=new Array;this.autoExportAnimations&&g.push(...sR(t,c)),f.find(O=>O.extensionName==="Audio")&&this.autoExportAudioSources&&g.push(...oR(t)),l.debug=di,l.pruneUnusedNodes=!cR;const y=Ks.instance.objs.map(O=>O.batchedMesh);l.keepObject=O=>{let M=!0;const A=S.getComponent(O,ze);return A&&!A.enabled&&(M=!1),M&&y.includes(O)&&(M=!1),M&&S.getComponentInParent(O,gn)&&(M=!1),M&&S.getComponentInParent(O,Vn)&&(M=!1),di&&!M&&console.log("USDZExporter: Discarding object",O),M},l.beforeWritingDocument=()=>{if(B()&&c&&d){const O=c.animatedRoots;for(const M of O){const A=S.getComponentsInChildren(M,ue).filter(T=>T.enabled),I=S.getComponents(M,ri).filter(T=>T.enabled&&!T.isTrigger);(A.length>0||I.length>0)&&console.error("An animated object has physics components in its child hierarchy. This can lead to undefined behaviour due to a bug in Apple's QuickLook (FB15925487). Remove the physics components from child objects or verify that you get the expected results.",M)}}};const b=new Array;this.objectToExport&&this.quickLookCompatible&&this.interactive&&this.objectToExport.traverse(O=>{O.visible||b.push(O)});const v=f.find(O=>O.extensionName==="Behaviour");this.interactive&&v&&b.length>0&&v.addBehavior(rR(b));let w=!0;this.quickLookCompatible&&!this.interactive&&(w=!1),this.anchoringType!=="plane"&&this.anchoringType!=="none"&&this.anchoringType!=="image"&&this.anchoringType!=="face"&&(this.anchoringType="plane"),this.planeAnchoringAlignment!=="horizontal"&&this.planeAnchoringAlignment!=="vertical"&&this.planeAnchoringAlignment!=="any"&&(this.planeAnchoringAlignment="horizontal"),se.report("export-usdz","Invoking exporter.parse");const P=await l.parse(this.objectToExport,{ar:{anchoring:{type:this.anchoringType},planeAnchoring:{alignment:this.planeAnchoringAlignment}},extensions:f,quickLookCompatible:this.quickLookCompatible,maxTextureSize:this.maxTextureSize,exportInvisible:w}),k=new Blob([P],{type:"model/vnd.usdz+zip"});this.revertWebARSessionRoot(),this.context.time.timeScale=this._previousTimeScale,se.report("export-usdz","Invoking after-export"),this.dispatchEvent(new CustomEvent("after-export",{detail:m}));for(const O of g)S.destroy(O);return Rt.Global.Set(a),se.end("export-usdz"),k}openInQuickLook(t,e){const i=t instanceof Blob?URL.createObjectURL(t):t,n=this.buildQuicklookOverlay();di&&console.log("QuickLook Overlay",n);const o=n.callToAction?encodeURIComponent(n.callToAction):"",a=n.checkoutTitle?encodeURIComponent(n.checkoutTitle):"",l=n.checkoutSubtitle?encodeURIComponent(n.checkoutSubtitle):"";this.link.href=i+`#callToAction=${o}&checkoutTitle=${a}&checkoutSubtitle=${l}&callToActionURL=${n.callToActionURL}`,this.lastCallback||(this.lastCallback=this.quicklookCallback.bind(this),this.link.addEventListener("message",this.lastCallback)),this.link.download=e+".usdz",this.link.click()}download(t,e){dm.save(t,e)}static save(t,e){const i=document.createElement("a");i.style.display="none",document.body.appendChild(i),typeof t=="string"?i.href=t:i.href=URL.createObjectURL(t),i.download=e,i.click(),i.remove()}quicklookCallback(t){if((t==null?void 0:t.data)=="_apple_ar_quicklook_button_tapped"){di&&pe("Quicklook closed via call to action button");var e=new CustomEvent("quicklook-button-tapped",{detail:this});if(this.dispatchEvent(e),!e.defaultPrevented){const i=new URLSearchParams(this.link.href);if(i){const n=i.get("callToActionURL");di&&Te("Quicklook url: "+n),n&&(io()?globalThis.open(n,"_blank"):console.warn("Quicklook closed: custom redirects require a Needle Engine Pro license: https://needle.tools/pricing",n))}}}}buildQuicklookOverlay(){var i,n,o,a,l,c;const t={};return this.customBranding&&Object.assign(t,this.customBranding),io()||(console.log("Custom Quicklook banner text requires pro license: https://needle.tools/pricing"),t.callToAction="Close",t.checkoutTitle="🌵 Made with Needle",t.checkoutSubtitle="_"),(((i=t.callToAction)==null?void 0:i.length)||((n=t.checkoutTitle)==null?void 0:n.length)||((o=t.checkoutSubtitle)==null?void 0:o.length))&&((a=t.callToAction)!=null&&a.length||(t.callToAction="\0"),(l=t.checkoutTitle)!=null&&l.length||(t.checkoutTitle="\0"),(c=t.checkoutSubtitle)!=null&&c.length||(t.checkoutSubtitle="\0")),this.dispatchEvent(new CustomEvent("quicklook-overlay",{detail:t})),t}getARScaleAndTarget(){if(!this.objectToExport)return{scale:1,_invertForward:!1,target:this.gameObject,sessionRoot:null};const t=S.findObjectOfType(Ne);let e=S.getComponentInParent(this.objectToExport,Ni);e||(e=S.getComponentInChildren(this.objectToExport,Ni));let i=1,n=!1;const o=this.objectToExport;return t?i=t.arScale:e&&(i=e.arScale,n=e.invertForward),{scale:1/i,_invertForward:n,target:o,sessionRoot:(e==null?void 0:e.gameObject)??null}}applyWebARSessionRoot(){if(!this.objectToExport)return;const{scale:t,_invertForward:e,target:i,sessionRoot:n}=this.getARScaleAndTarget(),o=n==null?void 0:n.matrixWorld.clone().invert();this._rootSessionRootWasAppliedTo=i,this._rootPositionBeforeExport.copy(i.position),this._rootRotationBeforeExport.copy(i.quaternion),this._rootScaleBeforeExport.copy(i.scale),i.scale.multiplyScalar(t),e&&i.quaternion.multiply(dm.invertForwardQuaternion),i.updateMatrix(),i.updateMatrixWorld(!0),n&&o&&i.matrix.premultiply(o)}revertWebARSessionRoot(){if(!this.objectToExport||!this._rootSessionRootWasAppliedTo)return;const t=this._rootSessionRootWasAppliedTo;t.position.copy(this._rootPositionBeforeExport),t.quaternion.copy(this._rootRotationBeforeExport),t.scale.copy(this._rootScaleBeforeExport),t.updateMatrix(),t.updateMatrixWorld(!0),this._rootSessionRootWasAppliedTo=null}createQuicklookButton(){const e=_s.getOrCreate().createQuicklookButton();return e.parentNode||this.context.menu.appendChild(e),e}},r(ad,"invertForwardMatrix",new h.Matrix4().makeRotationY(Math.PI)),r(ad,"invertForwardQuaternion",new h.Quaternion().setFromEuler(new h.Euler(0,Math.PI,0))),ad);let Le=dm;Pt([p(h.Object3D)],Le.prototype,"objectToExport",2);Pt([p()],Le.prototype,"autoExportAnimations",2);Pt([p()],Le.prototype,"autoExportAudioSources",2);Pt([p()],Le.prototype,"exportFileName",2);Pt([p(URL)],Le.prototype,"customUsdzFile",2);Pt([p(kr)],Le.prototype,"customBranding",2);Pt([p()],Le.prototype,"anchoringType",2);Pt([p()],Le.prototype,"maxTextureSize",2);Pt([p()],Le.prototype,"planeAnchoringAlignment",2);Pt([p()],Le.prototype,"interactive",2);Pt([p()],Le.prototype,"physics",2);Pt([p()],Le.prototype,"allowCreateQuicklookButton",2);Pt([p()],Le.prototype,"quickLookCompatible",2);var hR=Object.defineProperty,dR=Object.getOwnPropertyDescriptor,Hg=(s,t,e,i)=>{for(var n=i>1?void 0:i?dR(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&hR(t,e,n),n};class el extends D{constructor(){super(...arguments);r(this,"_fog")}get fog(){return this._fog||(this._fog=new h.Fog(0,0,50)),this._fog}get mode(){return 1}set near(e){this.fog.near=e}get near(){return this.fog.near}set far(e){this.fog.far=e}get far(){return this.fog.far}set color(e){this.fog.color.copy(e)}get color(){return this.fog.color}onEnable(){this.scene.fog=this.fog}onDisable(){this.scene.fog===this._fog&&(this.scene.fog=null)}}Hg([p()],el.prototype,"near",1);Hg([p()],el.prototype,"far",1);Hg([p(h.Color)],el.prototype,"color",1);var uR=Object.defineProperty,fR=Object.getOwnPropertyDescriptor,qg=(s,t,e,i)=>{for(var n=i>1?void 0:i?fR(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&uR(t,e,n),n};class Er extends D{constructor(){super(...arguments);r(this,"objectBounds",!1);r(this,"color");r(this,"isGizmo",!0);r(this,"_gizmoObject",null);r(this,"_boxHelper",null)}onEnable(){this.isGizmo&&!Hc||(this._gizmoObject||(this.objectBounds?this._gizmoObject=new h.BoxHelper(this.gameObject,this.color??16776960):(this.objectBounds=!1,this._gizmoObject=Xm(this.color??16776960))),this.objectBounds?(this.scene.add(this._gizmoObject),this._boxHelper=this._gizmoObject,this.startCoroutine(this.syncObjectBounds(),ve.OnBeforeRender)):this.gameObject.add(this._gizmoObject))}onDisable(){this._gizmoObject&&this.gameObject.remove(this._gizmoObject)}*syncObjectBounds(){var e;for(;this._boxHelper;)(e=this._boxHelper)==null||e.update(),yield}}qg([p()],Er.prototype,"objectBounds",2);qg([p(h.Color)],Er.prototype,"color",2);qg([p()],Er.prototype,"isGizmo",2);var pR=Object.defineProperty,mR=Object.getOwnPropertyDescriptor,Xg=(s,t,e,i)=>{for(var n=i>1?void 0:i?mR(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&pR(t,e,n),n};class tl extends D{constructor(){super(...arguments);r(this,"isGizmo",!1);r(this,"color0");r(this,"color1");r(this,"gridHelper");r(this,"size");r(this,"divisions");r(this,"offset")}onEnable(){if(this.isGizmo&&!Hc)return;const e=this.size,i=this.divisions;this.gridHelper||(this.gridHelper=new h.GridHelper(e,i,this.color0??new h.Color(.4,.4,.4),this.color1??new h.Color(.6,.6,.6)),this.offset!==void 0&&(this.gridHelper.position.y+=this.offset)),this.gridHelper&&this.gameObject.add(this.gridHelper)}onDisable(){this.gridHelper&&(this.gameObject.remove(this.gridHelper),this.gridHelper=null)}}Xg([p()],tl.prototype,"isGizmo",2);Xg([p(h.Color)],tl.prototype,"color0",2);Xg([p(h.Color)],tl.prototype,"color1",2);var gR=Object.defineProperty,_R=Object.getOwnPropertyDescriptor,Qg=(s,t,e,i)=>{for(var n=i>1?void 0:i?_R(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&gR(t,e,n),n};class Yg extends D{constructor(){super(...arguments);r(this,"connectedBody");r(this,"_rigidBody",null)}get rigidBody(){return this._rigidBody}onEnable(){this._rigidBody||(this._rigidBody=this.gameObject.getComponent(ue)),this.rigidBody&&this.connectedBody&&this.startCoroutine(this.create())}*create(){yield,this.rigidBody&&this.connectedBody&&this.activeAndEnabled&&this.createJoint(this.rigidBody,this.connectedBody)}}Qg([p(ue)],Yg.prototype,"connectedBody",2);class Kg extends Yg{createJoint(t,e){var i;(i=this.context.physics.engine)==null||i.addFixedJoint(t,e)}}class uh extends Yg{constructor(){super(...arguments);r(this,"anchor");r(this,"axis")}createJoint(e,i){var n;this.axis&&this.anchor&&((n=this.context.physics.engine)==null||n.addHingeJoint(e,i,this.anchor,this.axis))}}Qg([p(h.Vector3)],uh.prototype,"anchor",2);Qg([p(h.Vector3)],uh.prototype,"axis",2);var yR=Object.defineProperty,bR=Object.getOwnPropertyDescriptor,Gn=(s,t,e,i)=>{for(var n=i>1?void 0:i?bR(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&yR(t,e,n),n};function ip(s){return s*Math.PI/180}const sb=300,Bs=x("debuglights");class li extends D{constructor(){super(...arguments);r(this,"type",0);r(this,"range",1);r(this,"spotAngle",1);r(this,"innerSpotAngle",1);r(this,"_color",new h.Color(16777215));r(this,"_shadowNearPlane",.1);r(this,"_shadowBias",0);r(this,"_shadowNormalBias",0);r(this,"_overrideShadowBiasSettings",!1);r(this,"_shadows",1);r(this,"lightmapBakeType",4);r(this,"_intensity",-1);r(this,"_shadowDistance");r(this,"shadowWidth");r(this,"shadowHeight");r(this,"_shadowResolution");r(this,"light");r(this,"_webXRStartedListener");r(this,"_webXREndedListener");r(this,"_webARRoot")}set color(e){this._color=e,this.light!==void 0&&(this.light.color=e)}get color(){return this.light?this.light.color:this._color}set shadowNearPlane(e){var i,n;if(e!==this._shadowNearPlane&&(this._shadowNearPlane=e,((n=(i=this.light)==null?void 0:i.shadow)==null?void 0:n.camera)!==void 0)){const o=this.light.shadow.camera;o.near=e}}get shadowNearPlane(){return this._shadowNearPlane}set shadowBias(e){var i,n;e!==this._shadowBias&&(this._shadowBias=e,((n=(i=this.light)==null?void 0:i.shadow)==null?void 0:n.bias)!==void 0&&(this.light.shadow.bias=e,this.light.shadow.needsUpdate=!0))}get shadowBias(){return this._shadowBias}set shadowNormalBias(e){var i,n;e!==this._shadowNormalBias&&(this._shadowNormalBias=e,((n=(i=this.light)==null?void 0:i.shadow)==null?void 0:n.normalBias)!==void 0&&(this.light.shadow.normalBias=e,this.light.shadow.needsUpdate=!0))}get shadowNormalBias(){return this._shadowNormalBias}set shadows(e){this._shadows=e,this.light&&(this.light.castShadow=e!==0,this.updateShadowSoftHard())}get shadows(){return this._shadows}set intensity(e){var i;if(this._intensity=e,this.light){let n=1;if(this.context.isInXR&&this._webARRoot){const o=(i=this._webARRoot)==null?void 0:i.arScale;typeof o=="number"&&o>0&&(n/=o)}this.light.intensity=e*n}Bs&&console.log("Set light intensity to "+this._intensity,e,this)}get intensity(){return this._intensity}get shadowDistance(){const e=this.light;return e!=null&&e.shadow?e.shadow.camera.far:-1}set shadowDistance(e){this._shadowDistance=e;const i=this.light;if(i!=null&&i.shadow){const n=i.shadow.camera;n.far=e,n.updateProjectionMatrix()}}get shadowResolution(){const e=this.light;return e!=null&&e.shadow?e.shadow.mapSize.x:-1}set shadowResolution(e){if(e===this._shadowResolution)return;this._shadowResolution=e;const i=this.light;i!=null&&i.shadow&&(i.shadow.mapSize.set(e,e),i.shadow.needsUpdate=!0)}get isBaked(){return this.lightmapBakeType===2}get selfIsLight(){if(this.gameObject.isLight===!0)return!0;switch(this.gameObject.type){case"SpotLight":case"PointLight":case"DirectionalLight":return!0}return!1}getWorldPosition(e){return this.light?this.type===1?this.light.getWorldPosition(e).multiplyScalar(1):this.light.getWorldPosition(e):e}awake(){this.color=new h.Color(this.color??16777215),Bs&&console.log(this.name,this)}onEnable(){Bs&&console.log("ENABLE LIGHT",this.name),this.createLight(),!this.isBaked&&(this.light&&(this.light.visible=!0,this.light.intensity=this._intensity,Bs&&console.log("Set light intensity to "+this.light.intensity,this.name),this.selfIsLight||this.light.parent!==this.gameObject&&this.gameObject.add(this.light)),this.type===1&&this.startCoroutine(this.updateMainLightRoutine(),ve.LateUpdate))}onDisable(){Bs&&console.log("DISABLE LIGHT",this.name),this.light&&(this.selfIsLight?this.light.intensity=0:this.light.visible=!1)}onEnterXR(e){this._webARRoot=S.getComponentInParent(this.gameObject,Ni)??void 0}onLeaveXR(e){}createLight(){const e=this.selfIsLight;if(e&&!this.light)switch(this.light=this.gameObject,this.light.name=this.name,this._intensity=this.light.intensity,this.type){case 1:this.setDirectionalLight(this.light);break}else if(!this.light)switch(this.type){case 1:const i=new h.DirectionalLight(this.color,this.intensity*Math.PI);if(i.position.set(0,0,-sb*.5).applyQuaternion(this.gameObject.quaternion),this.gameObject.add(i.target),ar(i.target,0,0,0),this.light=i,this.gameObject.position.set(0,0,0),this.gameObject.rotation.set(0,0,0),Bs){const l=new h.DirectionalLightHelper(this.light,.2,this.color);this.context.scene.add(l)}break;case 0:const n=new h.SpotLight(this.color,this.intensity*Math.PI,this.range,ip(this.spotAngle/2),1-ip(this.innerSpotAngle/2)/ip(this.spotAngle/2),2);n.position.set(0,0,0),n.rotation.set(0,0,0),this.light=n;const o=n.target;n.add(o),o.position.set(0,0,this.range),o.rotation.set(0,0,0);break;case 2:const a=new h.PointLight(this.color,this.intensity*Math.PI,this.range);this.light=a;break}if(this.light){if(this._intensity>=0?this.light.intensity=this._intensity:this._intensity=this.light.intensity,this.shadows!==0?this.light.castShadow=!0:this.light.castShadow=!1,this.light.shadow){this._shadowResolution!==void 0&&this._shadowResolution>4?(this.light.shadow.mapSize.width=this._shadowResolution,this.light.shadow.mapSize.height=this._shadowResolution):(this.light.shadow.mapSize.width=2048,this.light.shadow.mapSize.height=2048),Bs&&console.log("Override shadow bias?",this._overrideShadowBiasSettings,this.shadowBias,this.shadowNormalBias),this.light.shadow.bias=this.shadowBias,this.light.shadow.normalBias=this.shadowNormalBias,this.updateShadowSoftHard();const i=this.light.shadow.camera;if(i.near=this.shadowNearPlane,this._shadowDistance!==void 0&&typeof this._shadowDistance=="number"?i.far=this._shadowDistance:i.far=sb*Math.abs(this.gameObject.scale.z),this.gameObject.scale.set(1,1,1),this.shadowWidth!==void 0)i.left=-this.shadowWidth/2,i.right=this.shadowWidth/2;else{const n=this.gameObject.scale.x;i.left*=n,i.right*=n}if(this.shadowHeight!==void 0)i.top=this.shadowHeight/2,i.bottom=-this.shadowHeight/2;else{const n=this.gameObject.scale.y;i.top*=n,i.bottom*=n}this.light.shadow.needsUpdate=!0,Bs&&this.context.scene.add(new h.CameraHelper(i))}this.isBaked?this.light.removeFromParent():e||this.gameObject.add(this.light)}}*updateMainLightRoutine(){for(;;){this.type===1&&((!this.context.mainLight||this.intensity>this.context.mainLight.intensity)&&(this.context.mainLight=this),yield);break}}updateShadowSoftHard(){this.light&&this.light.shadow&&(this.shadows===2||(this.light.shadow.radius=1,this.light.shadow.blurSamples=1))}setDirectionalLight(e){e.add(e.target),e.target.position.set(0,0,-1)}}r(li,"allowChangingRendererShadowMapType",!0);Gn([p()],li.prototype,"type",2);Gn([p(h.Color)],li.prototype,"color",1);Gn([p()],li.prototype,"shadowNearPlane",1);Gn([p()],li.prototype,"shadowBias",1);Gn([p()],li.prototype,"shadowNormalBias",1);Gn([p()],li.prototype,"shadows",1);Gn([p()],li.prototype,"lightmapBakeType",2);Gn([p()],li.prototype,"intensity",1);Gn([p()],li.prototype,"shadowDistance",1);Gn([p()],li.prototype,"shadowResolution",1);new h.Vector3(0,0,0);var vR=Object.defineProperty,wR=Object.getOwnPropertyDescriptor,fh=(s,t,e,i)=>{for(var n=i>1?void 0:i?wR(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&vR(t,e,n),n};const np=x("debuglods"),xR=x("nolods");class il{constructor(){r(this,"screenRelativeTransitionHeight");r(this,"distance");r(this,"renderers")}}fh([p()],il.prototype,"screenRelativeTransitionHeight",2);fh([p()],il.prototype,"distance",2);fh([p(ze)],il.prototype,"renderers",2);class SR{constructor(t){r(this,"model");this.model=t}get renderers(){return this.model.renderers}}class ph extends D{constructor(){super(...arguments);r(this,"fadeMode",0);r(this,"localReferencePoint");r(this,"lodCount",0);r(this,"size",0);r(this,"animateCrossFading",!1);r(this,"lodModels");r(this,"_lods",[]);r(this,"_settings",[]);r(this,"_lodsHandler");r(this,"_distanceFactor",1)}start(){if(np&&console.log("LODGROUP",this.name,this.lodModels,this),!xR&&!this._lodsHandler&&this.gameObject&&this.lodModels&&Array.isArray(this.lodModels)){const e=[];for(const n of this.lodModels){const o=new SR(n);this._lods.push(o);for(const a of o.renderers)e.includes(a)||e.push(a)}this._lodsHandler=new Array;for(let n=0;n<e.length;n++){const o=new h.LOD;this._lodsHandler.push(o),this.gameObject.add(o)}const i=new h.Object3D;i.name="Cull "+this.name;for(let n=0;n<e.length;n++){const o=e[n],a=this._lodsHandler[n],l=o.gameObject;np&&console.log(n,l.name);for(const c of this._lods){const d=c.model.distance;let u=null;if(c.renderers.includes(o)?u=l:u=i,u.type==="Group"){console.warn(`LODGroup ${this.name}: Group or MultiMaterial object's are not supported as LOD object: ${u.name}`);continue}np&&console.log("LEVEL",u.name,d),a.autoUpdate=!1,this.onAddLodLevel(a,u,c.model.distance)}}}}onAfterRender(){if(!this.gameObject||!this._lodsHandler)return;const e=this.context.mainCamera;if(e)for(const i of this._lodsHandler){i.update(e);const n=i.getCurrentLevel(),o=i.levels[n];i.layers.mask=o.object.layers.mask}}onAddLodLevel(e,i,n){if(i===this.gameObject){console.warn("LODGroup component must be on parent object and not mesh directly at the moment",i.name,i);return}e.addLevel(i,n*this._distanceFactor,.01);const o={lod:e,levelIndex:e.levels.length-1,distance:n};this._settings.push(o)}distanceFactor(e){if(e!==this._distanceFactor){this._distanceFactor=e;for(const i of this._settings){const n=i.lod.levels[i.levelIndex];n.distance=i.distance*e}}}}fh([p(h.Vector3)],ph.prototype,"localReferencePoint",2);fh([p(il)],ph.prototype,"lodModels",2);var CR=Object.defineProperty,PR=Object.getOwnPropertyDescriptor,OR=(s,t,e,i)=>{for(var n=i>1?void 0:i?PR(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&CR(t,e,n),n};const Zh=x("debugnestedgltf");class Hu extends D{constructor(){super(...arguments);r(this,"filePath");r(this,"loadAssetInParent",!0);r(this,"_isLoadingOrDoneLoading",!1)}listenToProgress(e){var i;(i=this.filePath)==null||i.beginListenDownload(e)}preload(){var e;(e=this.filePath)==null||e.preload()}async start(){var i,n,o,a,l;if(this._isLoadingOrDoneLoading)return;Zh&&console.log(this,this.guid);const e=this.gameObject.parent;if(e){this._isLoadingOrDoneLoading=!0;const c=new pn;c.idProvider=new vt(this.hash(this.guid)),c.parent=this.loadAssetInParent!==!1?e:this.gameObject,this.gameObject.updateMatrix();const d=this.gameObject.matrix;Zh&&console.log("Load nested:",((i=this.filePath)==null?void 0:i.url)??this.filePath,this.gameObject.position);const u=await((o=(n=this.filePath)==null?void 0:n.instantiate)==null?void 0:o.call(this.filePath,c));Zh&&console.log("Nested loaded:",((a=this.filePath)==null?void 0:a.url)??this.filePath,u),u&&this.loadAssetInParent!==!1&&(u.matrixAutoUpdate=!1,u.matrix.identity(),u.applyMatrix4(d),u.matrixAutoUpdate=!0,u.layers.disableAll(),u.layers.set(this.layer),this.dispatchEvent(new CustomEvent("loaded",{detail:{instance:u,assetReference:this.filePath}}))),Zh&&console.log("Nested loading done:",((l=this.filePath)==null?void 0:l.url)??this.filePath,u)}}onDestroy(){var e;(e=this.filePath)==null||e.unload()}hash(e){let i=0;for(let n=0;n<e.length;n++)i=e.charCodeAt(n)+((i<<5)-i);return i}}OR([p(ee)],Hu.prototype,"filePath",2);var MR=Object.defineProperty,RR=Object.getOwnPropertyDescriptor,Zg=(s,t,e,i)=>{for(var n=i>1?void 0:i?RR(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&MR(t,e,n),n};const kR=x("debugnet"),um=class extends D{constructor(){super(...arguments);r(this,"url",null);r(this,"urlParameterName",null);r(this,"localhost",null)}awake(){kR&&console.log(this),this.context.connection.registerProvider(this)}getWebsocketUrl(){let t=this.url?um.GetUrl(this.url,this.localhost):null;if(this.urlParameterName){const o=x(this.urlParameterName);o&&typeof o=="string"&&(t=o)}if(!t)return null;const i=new RegExp("(((https?)|(?<socket_prefix>wss?))://)?(www.)?(?<url>.+)","gm").exec(t);return i!=null&&i.groups?(i==null?void 0:i.groups.socket_prefix)?t:"wss://"+(i==null?void 0:i.groups.url):null}static GetUrl(t,e){let i=t;const n=um.IsLocalNetwork()&&e;if(n&&(i=e),t!=null&&t.startsWith("/")){const o=n?i:window.location.origin;o!=null&&o.endsWith("/")&&t.startsWith("/")&&(t=t.substring(1)),i=o+t}return i}static IsLocalNetwork(t=window.location.hostname){return Ht(t)}};let nl=um;Zg([p()],nl.prototype,"url",2);Zg([p()],nl.prototype,"urlParameterName",2);Zg([p()],nl.prototype,"localhost",2);var ER=Object.defineProperty,TR=Object.getOwnPropertyDescriptor,qu=(s,t,e,i)=>{for(var n=i>1?void 0:i?TR(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&ER(t,e,n),n};class Tr extends D{constructor(){super(...arguments);r(this,"referenceSpace");r(this,"from");r(this,"affectPosition",!1);r(this,"affectRotation",!1);r(this,"alignLookDirection",!1);r(this,"levelLookDirection",!1);r(this,"levelPosition",!1);r(this,"positionOffset",new h.Vector3(0,0,0));r(this,"rotationOffset",new h.Vector3(0,0,0));r(this,"offset",new h.Vector3(0,0,0))}update(){if(!this.from)return;var e=Z(this.from),i=_e(this.from);this.offset.copy(this.positionOffset);const n=this.offset.length();if(this.referenceSpace&&this.offset.transformDirection(this.referenceSpace.matrixWorld).multiplyScalar(n),e.add(this.offset),this.levelPosition&&this.referenceSpace){const c=new h.Plane(this.gameObject.up,0),d=Z(this.referenceSpace);c.setFromNormalAndCoplanarPoint(this.gameObject.up,d);const u=new h.Vector3(0,0,0);c.projectPoint(e,u),e.copy(u)}this.affectPosition&&it(this.gameObject,e);const o=new h.Euler(this.rotationOffset.x,this.rotationOffset.y,this.rotationOffset.z),a=new h.Quaternion().setFromEuler(o);this.affectRotation&&Wi(this.gameObject,i.multiply(a));const l=new h.Vector3;this.from.getWorldDirection(l).multiplyScalar(50),this.levelLookDirection&&(l.y=0),this.alignLookDirection&&this.gameObject.lookAt(l)}}qu([p(S)],Tr.prototype,"referenceSpace",2);qu([p(S)],Tr.prototype,"from",2);qu([p(h.Vector3)],Tr.prototype,"positionOffset",2);qu([p(h.Vector3)],Tr.prototype,"rotationOffset",2);var AR=Object.defineProperty,DR=Object.getOwnPropertyDescriptor,So=(s,t,e,i)=>{for(var n=i>1?void 0:i?DR(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&AR(t,e,n),n};class ni{constructor(t=0,e=0){r(this,"time",0);r(this,"value",0);r(this,"inTangent",1/0);r(this,"inWeight");r(this,"outTangent",1/0);r(this,"outWeight");r(this,"weightedMode");this.time=t,this.value=e}}So([p()],ni.prototype,"time",2);So([p()],ni.prototype,"value",2);So([p()],ni.prototype,"inTangent",2);So([p()],ni.prototype,"inWeight",2);So([p()],ni.prototype,"outTangent",2);So([p()],ni.prototype,"outWeight",2);So([p()],ni.prototype,"weightedMode",2);const ql=class{constructor(){r(this,"keys",[])}static linearFromTo(s,t,e){const i=new ql,n=new ni;n.time=0,n.value=s;const o=new ni;return o.time=e,o.value=t,i.keys.push(n,o),i}static constant(s){const t=new ql,e=new ni;return e.time=0,e.value=s,t.keys.push(e),t}clone(){var t;const s=new ql;return s.keys=((t=this.keys)==null?void 0:t.map(e=>{const i=new ni;return i.time=e.time,i.value=e.value,i.inTangent=e.inTangent,i.inWeight=e.inWeight,i.outTangent=e.outTangent,i.outWeight=e.outWeight,i.weightedMode=e.weightedMode,i}))||[],s}get duration(){return!this.keys||this.keys.length==0?0:this.keys[this.keys.length-1].time}evaluate(s){if(!this.keys||this.keys.length==0)return 0;if(this.keys.length===1)return this.keys[0].value;if(this.keys[0].time>=s)return this.keys[0].value;for(let t=0;t<this.keys.length;t++){const e=this.keys[t];if(e.time<=s)if(t+1<this.keys.length){const n=this.keys[t+1];if(n.time<s)continue;return!isFinite(e.outTangent)||!isFinite(n.inTangent)?e.value:ql.interpolateValue(s,e,n)}else return e.value}return this.keys[this.keys.length-1].value}static interpolateValue(s,t,e){const i=t.time,n=t.value,o=t.outTangent,a=e.time,l=e.value,c=e.inTangent,d=a-i,u=d*d,f=u*d,m=((o+c)*d-2*(l-n))/f,g=(3*(l-n)-(c+2*o)*d)/u,_=o,y=n,b=s-i,v=b*b,w=v*b;return m*w+g*v+_*b+y}};let sl=ql;So([p(ni)],sl.prototype,"keys",2);var LR=Object.defineProperty,IR=Object.getOwnPropertyDescriptor,C=(s,t,e,i)=>{for(var n=i>1?void 0:i?IR(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&LR(t,e,n),n};const Jh=x("debugparticles");var rs=(s=>(s[s.Billboard=0]="Billboard",s[s.Stretch=1]="Stretch",s[s.HorizontalBillboard=2]="HorizontalBillboard",s[s.VerticalBillboard=3]="VerticalBillboard",s[s.Mesh=4]="Mesh",s))(rs||{});class Ar{constructor(){r(this,"alphaKeys",[]);r(this,"colorKeys",[])}get duration(){return 1}evaluate(t,e){let i,n=0,o=null,a=0;for(let l=0;l<this.alphaKeys.length;l++){const c=this.alphaKeys[l];(c.time<t||!i)&&(i=c,n=l)}for(let l=0;l<this.colorKeys.length;l++){const c=this.colorKeys[l];(c.time<t||!o)&&(o=c,a=l)}if(o)if(a+1<this.colorKeys.length){const c=this.colorKeys[a+1],d=z.remap(t,o.time,c.time,0,1);e.r=z.lerp(o.color.r,c.color.r,d),e.g=z.lerp(o.color.g,c.color.g,d),e.b=z.lerp(o.color.b,c.color.b,d)}else e.r=o.color.r,e.g=o.color.g,e.b=o.color.b;if(i)if(n+1<this.alphaKeys.length){const c=this.alphaKeys[n+1],d=z.remap(t,i.time,c.time,0,1);e.alpha=z.lerp(i.alpha,c.alpha,d)}else e.alpha=i.alpha;return e}}C([p()],Ar.prototype,"alphaKeys",2);C([p()],Ar.prototype,"colorKeys",2);var Ec=(s=>(s[s.Local=0]="Local",s[s.World=1]="World",s[s.Custom=2]="Custom",s))(Ec||{}),nu=(s=>(s[s.Sphere=0]="Sphere",s[s.SphereShell=1]="SphereShell",s[s.Hemisphere=2]="Hemisphere",s[s.HemisphereShell=3]="HemisphereShell",s[s.Cone=4]="Cone",s[s.Box=5]="Box",s[s.Mesh=6]="Mesh",s[s.ConeShell=7]="ConeShell",s[s.ConeVolume=8]="ConeVolume",s[s.ConeVolumeShell=9]="ConeVolumeShell",s[s.Circle=10]="Circle",s[s.CircleEdge=11]="CircleEdge",s[s.SingleSidedEdge=12]="SingleSidedEdge",s[s.MeshRenderer=13]="MeshRenderer",s[s.SkinnedMeshRenderer=14]="SkinnedMeshRenderer",s[s.BoxShell=15]="BoxShell",s[s.BoxEdge=16]="BoxEdge",s[s.Donut=17]="Donut",s[s.Rectangle=18]="Rectangle",s[s.Sprite=19]="Sprite",s[s.SpriteRenderer=20]="SpriteRenderer",s))(nu||{});const Xl=class{constructor(){r(this,"mode","Constant");r(this,"constant");r(this,"constantMin");r(this,"constantMax");r(this,"curve");r(this,"curveMin");r(this,"curveMax");r(this,"curveMultiplier")}static constant(s){const t=new Xl;return t.setConstant(s),t}static betweenTwoConstants(s,t){const e=new Xl;return e.setMinMaxConstant(s,t),e}static curve(s,t=1){const e=new Xl;return e.setCurve(s,t),e}setConstant(s){this.mode=0,this.constant=s}setMinMaxConstant(s,t){this.mode=3,this.constantMin=s,this.constantMax=t}setCurve(s,t=1){this.mode=1,this.curve=s,this.curveMultiplier=t}clone(){var t,e,i;const s=new Xl;return s.mode=this.mode,s.constant=this.constant,s.constantMin=this.constantMin,s.constantMax=this.constantMax,s.curve=(t=this.curve)==null?void 0:t.clone(),s.curveMin=(e=this.curveMin)==null?void 0:e.clone(),s.curveMax=(i=this.curveMax)==null?void 0:i.clone(),s.curveMultiplier=this.curveMultiplier,s}evaluate(s,t){const e=t===void 0?Math.random():t;switch(this.mode){case 0:case"Constant":return this.constant;case 1:case"Curve":return s=z.clamp01(s),this.curve.evaluate(s)*this.curveMultiplier;case 2:case"TwoCurves":const i=s*this.curveMin.duration,n=s*this.curveMax.duration;return z.lerp(this.curveMin.evaluate(i),this.curveMax.evaluate(n),e%1)*this.curveMultiplier;case 3:case"TwoConstants":return z.lerp(this.constantMin,this.constantMax,e%1);default:this.curveMax.evaluate(s)*this.curveMultiplier;break}return 0}getMax(){switch(this.mode){case 0:case"Constant":return this.constant;case 1:case"Curve":return this.getMaxFromCurve(this.curve)*this.curveMultiplier;case 2:case"TwoCurves":return Math.max(this.getMaxFromCurve(this.curveMin),this.getMaxFromCurve(this.curveMax))*this.curveMultiplier;case 3:case"TwoConstants":return Math.max(this.constantMin,this.constantMax);default:return 0}}getMaxFromCurve(s){if(!s)return 0;let t=Number.MIN_VALUE;for(let e=0;e<s.keys.length;e++){const i=s.keys[e];i.value>t&&(t=i.value)}return t}};let W=Xl;C([p()],W.prototype,"mode",2);C([p()],W.prototype,"constant",2);C([p()],W.prototype,"constantMin",2);C([p()],W.prototype,"constantMax",2);C([p(sl)],W.prototype,"curve",2);C([p(sl)],W.prototype,"curveMin",2);C([p(sl)],W.prototype,"curveMax",2);C([p()],W.prototype,"curveMultiplier",2);var ld;const gt=(ld=class{constructor(){r(this,"mode",0);r(this,"color");r(this,"colorMin");r(this,"colorMax");r(this,"gradient");r(this,"gradientMin");r(this,"gradientMax")}static constant(s){const t=new gt;return t.constant(s),t}static betweenTwoColors(s,t){const e=new gt;return e.betweenTwoColors(s,t),e}constant(s){return this.mode=0,this.color=s,this}betweenTwoColors(s,t){return this.mode=2,this.colorMin=s,this.colorMax=t,this}evaluate(s,t){const e=t===void 0?Math.random():t;switch(this.mode){case 0:case"Color":return this.color;case 1:case"Gradient":return this.gradient.evaluate(s,gt._temp),gt._temp;case 2:case"TwoColors":return gt._temp.lerpColors(this.colorMin,this.colorMax,e);case 3:case"TwoGradients":return this.gradientMin.evaluate(s,gt._temp),this.gradientMax.evaluate(s,gt._temp2),gt._temp.lerp(gt._temp2,e);case 4:case"RandomColor":const n=Math.random();return this.gradientMin.evaluate(s,gt._temp),this.gradientMax.evaluate(s,gt._temp2),gt._temp.lerp(gt._temp2,n)}return gt._temp.set(16777215),gt._temp.alpha=1,gt._temp}},r(ld,"_temp",new me(0,0,0,1)),r(ld,"_temp2",new me(0,0,0,1)),ld);let ci=gt;C([p()],ci.prototype,"mode",2);C([p(me)],ci.prototype,"color",2);C([p(me)],ci.prototype,"colorMin",2);C([p(me)],ci.prototype,"colorMax",2);C([p(Ar)],ci.prototype,"gradient",2);C([p(Ar)],ci.prototype,"gradientMin",2);C([p(Ar)],ci.prototype,"gradientMax",2);var fm=(s=>(s[s.Hierarchy=0]="Hierarchy",s[s.Local=1]="Local",s[s.Shape=2]="Shape",s))(fm||{});class At{constructor(){r(this,"cullingMode");r(this,"duration");r(this,"emitterVelocityMode");r(this,"flipRotation");r(this,"gravityModifier");r(this,"gravityModifierMultiplier");r(this,"loop");r(this,"maxParticles");r(this,"playOnAwake");r(this,"prewarm");r(this,"ringBufferLoopRange");r(this,"ringBufferMode");r(this,"scalingMode");r(this,"simulationSpace");r(this,"simulationSpeed");r(this,"startColor");r(this,"startDelay");r(this,"startDelayMultiplier");r(this,"startLifetime");r(this,"startLifetimeMultiplier");r(this,"startRotation");r(this,"startRotationMultiplier");r(this,"startRotation3D");r(this,"startRotationX");r(this,"startRotationXMultiplier");r(this,"startRotationY");r(this,"startRotationYMultiplier");r(this,"startRotationZ");r(this,"startRotationZMultiplier");r(this,"startSize");r(this,"startSize3D");r(this,"startSizeMultiplier");r(this,"startSizeX");r(this,"startSizeXMultiplier");r(this,"startSizeY");r(this,"startSizeYMultiplier");r(this,"startSizeZ");r(this,"startSizeZMultiplier");r(this,"startSpeed");r(this,"startSpeedMultiplier");r(this,"stopAction");r(this,"useUnscaledTime")}}C([p(W)],At.prototype,"gravityModifier",2);C([p(ci)],At.prototype,"startColor",2);C([p(W)],At.prototype,"startDelay",2);C([p(W)],At.prototype,"startLifetime",2);C([p(W)],At.prototype,"startRotation",2);C([p(W)],At.prototype,"startRotationX",2);C([p(W)],At.prototype,"startRotationY",2);C([p(W)],At.prototype,"startRotationZ",2);C([p(W)],At.prototype,"startSize",2);C([p(W)],At.prototype,"startSizeX",2);C([p(W)],At.prototype,"startSizeY",2);C([p(W)],At.prototype,"startSizeZ",2);C([p(W)],At.prototype,"startSpeed",2);class su{constructor(){r(this,"cycleCount");r(this,"maxCount");r(this,"minCount");r(this,"probability");r(this,"repeatInterval");r(this,"time");r(this,"count");r(this,"_performed",0)}reset(){this._performed=0}run(t){if(t<=this.time)return 0;let e=0;if(this.cycleCount===0||this._performed<this.cycleCount){const i=this.time+this.repeatInterval*this._performed;if(t>=i&&(this._performed+=1,Math.random()<this.probability))switch(this.count.mode){case 0:e=this.count.constant;break;case 3:e=z.lerp(this.count.constantMin,this.count.constantMax,Math.random());break;case 1:e=this.count.curve.evaluate(Math.random());break;case 2:const n=Math.random();e=z.lerp(this.count.curveMin.evaluate(n),this.count.curveMax.evaluate(n),Math.random());break}}return e}}class Os{constructor(){r(this,"enabled");r(this,"bursts");r(this,"rateOverTime");r(this,"rateOverTimeMultiplier");r(this,"rateOverDistance");r(this,"rateOverDistanceMultiplier");r(this,"system")}get burstCount(){var t;return((t=this.bursts)==null?void 0:t.length)??0}reset(){var t;(t=this.bursts)==null||t.forEach(e=>e.reset())}getBurst(){let t=0;if(this.burstCount>0)for(let e=0;e<this.burstCount;e++){const i=this.bursts[e];this.system.main.loop&&i.time>=this.system.time&&i.reset(),t+=Math.round(i.run(this.system.time))}return t}}C([p()],Os.prototype,"enabled",2);C([p()],Os.prototype,"bursts",2);C([p(W)],Os.prototype,"rateOverTime",2);C([p()],Os.prototype,"rateOverTimeMultiplier",2);C([p(W)],Os.prototype,"rateOverDistance",2);C([p()],Os.prototype,"rateOverDistanceMultiplier",2);class Xu{constructor(){r(this,"enabled");r(this,"color")}}C([p(ci)],Xu.prototype,"color",2);class Dr{constructor(){r(this,"enabled");r(this,"separateAxes");r(this,"size");r(this,"sizeMultiplier");r(this,"x");r(this,"xMultiplier");r(this,"y");r(this,"yMultiplier");r(this,"z");r(this,"zMultiplier");r(this,"_time",0);r(this,"_temp",new h.Vector3)}evaluate(t,e,i){if(e||(e=this._temp),!this.enabled)return e.x=e.y=e.z=1,e;if(this.separateAxes)e.x=this.x.evaluate(t,i)*this.xMultiplier,e.y=this.y.evaluate(t,i)*this.yMultiplier,e.z=this.z.evaluate(t,i)*this.zMultiplier;else{const n=this.size.evaluate(t,i)*this.sizeMultiplier;e.x=n}return e}}C([p(W)],Dr.prototype,"size",2);C([p(W)],Dr.prototype,"x",2);C([p(W)],Dr.prototype,"y",2);C([p(W)],Dr.prototype,"z",2);var cd;const Ql=(cd=class{constructor(){r(this,"shapeType",5);r(this,"enabled",!0);r(this,"alignToDirection",!1);r(this,"angle",0);r(this,"arc",360);r(this,"arcSpread");r(this,"arcSpeedMultiplier");r(this,"arcMode");r(this,"boxThickness");r(this,"position");r(this,"rotation");r(this,"_rotation",new h.Euler);r(this,"scale");r(this,"radius");r(this,"radiusThickness");r(this,"sphericalDirectionAmount");r(this,"randomDirectionAmount");r(this,"randomPositionAmount");r(this,"meshShapeType");r(this,"meshRenderer");r(this,"_meshObj");r(this,"_meshGeometry");r(this,"system");r(this,"_space");r(this,"_worldSpaceMatrix",new h.Matrix4);r(this,"_worldSpaceMatrixInverse",new h.Matrix4);r(this,"_vector",new h.Vector3(0,0,0));r(this,"_temp",new h.Vector3(0,0,0));r(this,"_triangle",new h.Triangle);r(this,"_dir",new h.Vector3);r(this,"_loopTime",0);r(this,"_loopDirection",1);Jh&&console.log(this)}get type(){return nu[this.shapeType]}initialize(s){this.onInitialize(s),s.position.x=this._vector.x,s.position.y=this._vector.y,s.position.z=this._vector.z}toJSON(){return this}clone(){return new Ql}setMesh(s){this.meshRenderer=s,s?(this._meshObj=s.sharedMeshes[Math.floor(Math.random()*s.sharedMeshes.length)],this._meshGeometry=this._meshObj.geometry):(this._meshObj=void 0,this._meshGeometry=void 0)}update(s,t){}onUpdate(s,t,e,i){this.system=s,this._space=e,e===1&&(this._worldSpaceMatrix.copy(i.matrixWorld),this._worldSpaceMatrix.elements[0]=1,this._worldSpaceMatrix.elements[5]=1,this._worldSpaceMatrix.elements[10]=1,this._worldSpaceMatrixInverse.copy(this._worldSpaceMatrix).invert())}applyRotation(s){const t=this.rotation.x!==0||this.rotation.y!==0||this.rotation.z!==0;return t&&(this._rotation.x=z.toRadians(this.rotation.x),this._rotation.y=z.toRadians(this.rotation.y),this._rotation.z=z.toRadians(this.rotation.z),this._rotation.order="ZYX",s.applyEuler(this._rotation)),t}onInitialize(s){this._vector.set(0,0,0),s.mesh=void 0,s.mesh_geometry=void 0;const t=this._temp.copy(this.position),e=this._space===1;e&&t.applyQuaternion(this.system.worldQuaternion);let i=this.radius;if(e&&(i*=this.system.worldScale.x),this.enabled){switch(this.shapeType){case 5:Jh&&N.DrawWireBox(this.position,this.scale,14540253,1),this._vector.x=Math.random()*this.scale.x-this.scale.x/2,this._vector.y=Math.random()*this.scale.y-this.scale.y/2,this._vector.z=Math.random()*this.scale.z-this.scale.z/2,this._vector.add(t);break;case 4:this.randomConePoint(this.position,this.angle,i,this.radiusThickness,this.arc,this.arcMode,this._vector);break;case 0:this.randomSpherePoint(this.position,i,this.radiusThickness,this.arc,this._vector);break;case 10:this.randomCirclePoint(this.position,i,this.radiusThickness,this.arc,this._vector);break;case 13:const n=this.meshRenderer;(n==null?void 0:n.destroyed)==!1&&this.setMesh(n);const o=s.mesh=this._meshObj,a=s.mesh_geometry=this._meshGeometry;if(o&&a)switch(this.meshShapeType){case 0:{const l=a.getAttribute("position"),c=Math.floor(Math.random()*l.count);this._vector.fromBufferAttribute(l,c),this._vector.applyMatrix4(o.matrixWorld),s.mesh_normal=c}break;case 1:break;case 2:{const l=a.index;if(l){let c=Math.random(),d=Math.random();c+d>1&&(c=1-c,d=1-d);const u=Math.floor(Math.random()*(l.count/3));let f=u*3,m=u*3+1,g=u*3+2;f=l.getX(f),m=l.getX(m),g=l.getX(g);const _=a.getAttribute("position");this._triangle.a.fromBufferAttribute(_,f),this._triangle.b.fromBufferAttribute(_,m),this._triangle.c.fromBufferAttribute(_,g),this._vector.set(0,0,0).addScaledVector(this._triangle.a,c).addScaledVector(this._triangle.b,d).addScaledVector(this._triangle.c,1-(c+d)),this._vector.applyMatrix4(o.matrixWorld),s.mesh_normal=u}}break}break;default:this._vector.set(0,0,0),B()&&!globalThis.__particlesystem_shapetype_unsupported&&(console.warn("ParticleSystem ShapeType is not supported:",nu[this.shapeType]),globalThis.__particlesystem_shapetype_unsupported=!0);break}this.randomizePosition(this._vector,this.randomPositionAmount)}this.applyRotation(this._vector),e&&(this._vector.applyQuaternion(this.system.worldQuaternion),this._vector.add(this.system.worldPos)),Jh&&N.DrawSphere(this._vector,.03,16711680,.5,!0)}getDirection(s,t){var e;if(!this.enabled)return this._dir.set(0,0,1),this._dir;switch(this.shapeType){case 5:this._dir.set(0,0,1);break;case 4:this._dir.set(0,0,1);break;case 10:case 0:const i=t.x,n=t.y,o=t.z;this._dir.set(i,n,o),(e=this.system)!=null&&e.worldspace?this._dir.sub(this.system.worldPos):this._dir.sub(this.position);break;case 13:const a=s.mesh,l=s.mesh_geometry;if(a&&l)switch(this.meshShapeType){case 0:{const c=l.getAttribute("normal"),d=s.mesh_normal;this._dir.fromBufferAttribute(c,d)}break;case 1:break;case 2:{const c=l.index;if(c){const d=s.mesh_normal,u=c.getX(d*3),f=c.getX(d*3+1),m=c.getX(d*3+2),g=l.getAttribute("position"),_=$(),y=$(),b=$();_.fromBufferAttribute(g,u),y.fromBufferAttribute(g,f),b.fromBufferAttribute(g,m),_.sub(y),b.sub(y),_.cross(b),this._dir.copy(_).multiplyScalar(-1);const v=_e(a);this._dir.applyQuaternion(v)}}break}break;default:this._dir.set(0,0,1);break}return this._space===1&&this._dir.applyQuaternion(this.system.worldQuaternion),this.applyRotation(this._dir),this._dir.normalize(),this.spherizeDirection(this._dir,this.sphericalDirectionAmount),this.randomizeDirection(this._dir,this.randomDirectionAmount),Jh&&(N.DrawSphere(t,.01,8925952,.5,!0),N.DrawDirection(t,this._dir,8925952,.5,!0)),this._dir}randomizePosition(s,t){if(t<=0)return;const e=Ql._tempVec;e.set(Math.random()*2-1,Math.random()*2-1,Math.random()*2-1),e.x*=t*this.scale.x,e.y*=t*this.scale.y,e.z*=t*this.scale.z,s.add(e)}randomizeDirection(s,t){if(t===0)return;const e=Ql._randomQuat,i=Ql._tempVec;i.set(Math.random()-.5,Math.random()-.5,Math.random()-.5).normalize(),e.setFromAxisAngle(i,t*Math.random()*Math.PI),s.applyQuaternion(e)}spherizeDirection(s,t){if(t===0)return;const e=Math.random()*Math.PI*2,i=Math.acos(1-Math.random()*2),n=Math.sin(i)*Math.cos(e),o=Math.sin(i)*Math.sin(e),a=Math.cos(i),l=new h.Vector3(n,o,a);s.lerp(l,t)}randomSpherePoint(s,t,e,i,n){const o=Math.random(),a=Math.random(),l=2*Math.PI*o*(i/360),c=Math.acos(2*a-1),d=z.lerp(1,1-Math.pow(1-Math.random(),Math.PI),e)*t,u=s.x+this.scale.x*(-d*Math.sin(c)*Math.cos(l)),f=s.y+this.scale.y*(d*Math.sin(c)*Math.sin(l)),m=s.z+this.scale.z*(d*Math.cos(c));n.x=u,n.y=f,n.z=m}randomCirclePoint(s,t,e,i,n){const o=Math.random(),a=2*Math.PI*o*(i/360),l=z.lerp(1,1-Math.pow(1-Math.random(),Math.PI),e)*t,c=s.x+this.scale.x*l*Math.cos(a),d=s.y+this.scale.y*l*Math.sin(a),u=s.z;n.x=c,n.y=d,n.z=u}randomConePoint(s,t,e,i,n,o,a){let l=0,c=0;switch(o){case 0:l=Math.random(),c=Math.random();break;case 2:this._loopTime>1&&(this._loopDirection=-1),this._loopTime<0&&(this._loopDirection=1);case 1:l=.5,c=Math.random(),this._loopTime+=this.system.deltaTime*this._loopDirection;break}let d=2*Math.PI*l*(n/360);switch(o){case 2:case 1:d+=Math.PI+.5,d+=this._loopTime*Math.PI*2,d%=z.toRadians(n);break}const u=Math.acos(2*c-1),f=z.lerp(1,1-Math.pow(1-Math.random(),Math.PI),i)*e,m=s.x+-f*Math.sin(u)*Math.cos(d),g=s.y+f*Math.sin(u)*Math.sin(d),_=s.z;a.x=m*this.scale.x,a.y=g*this.scale.y,a.z=_*this.scale.z}},r(cd,"_randomQuat",new h.Quaternion),r(cd,"_tempVec",new h.Vector3),cd);let Ve=Ql;C([p()],Ve.prototype,"shapeType",2);C([p()],Ve.prototype,"enabled",2);C([p()],Ve.prototype,"alignToDirection",2);C([p()],Ve.prototype,"angle",2);C([p()],Ve.prototype,"arc",2);C([p()],Ve.prototype,"arcSpread",2);C([p()],Ve.prototype,"arcSpeedMultiplier",2);C([p()],Ve.prototype,"arcMode",2);C([p(h.Vector3)],Ve.prototype,"boxThickness",2);C([p(h.Vector3)],Ve.prototype,"position",2);C([p(h.Vector3)],Ve.prototype,"rotation",2);C([p(h.Vector3)],Ve.prototype,"scale",2);C([p()],Ve.prototype,"radius",2);C([p()],Ve.prototype,"radiusThickness",2);C([p()],Ve.prototype,"sphericalDirectionAmount",2);C([p()],Ve.prototype,"randomDirectionAmount",2);C([p()],Ve.prototype,"randomPositionAmount",2);C([p()],Ve.prototype,"meshShapeType",2);C([p(oh)],Ve.prototype,"meshRenderer",2);class be{constructor(){r(this,"damping");r(this,"enabled");r(this,"frequency");r(this,"octaveCount");r(this,"octaveMultiplier");r(this,"octaveScale");r(this,"positionAmount");r(this,"quality");r(this,"remap");r(this,"remapEnabled");r(this,"remapMultiplier");r(this,"remapX");r(this,"remapXMultiplier");r(this,"remapY");r(this,"remapYMultiplier");r(this,"remapZ");r(this,"remapZMultiplier");r(this,"scrollSpeedMultiplier");r(this,"separateAxes");r(this,"strengthMultiplier");r(this,"strengthX");r(this,"strengthXMultiplier");r(this,"strengthY");r(this,"strengthYMultiplier");r(this,"strengthZ");r(this,"strengthZMultiplier");r(this,"_noise");r(this,"_time",0);r(this,"_temp",new h.Vector3)}update(t){this._time+=t.time.deltaTime*this.scrollSpeedMultiplier}apply(t,e,i,n,o,a){if(!this.enabled)return;this._noise||(this._noise=oe.createNoise4D(()=>0));const l=this._temp.set(e.x,e.y,e.z).multiplyScalar(this.frequency),c=this._noise(l.x,l.y,l.z,this._time),d=this._noise(l.x,l.y,l.z,this._time+1e3*this.frequency),u=this._noise(l.x,l.y,l.z,this._time+2e3*this.frequency);this._temp.set(c,d,u).normalize();const f=o/a;let m=this.positionAmount.evaluate(f);this.separateAxes?(this._temp.x*=m*this.strengthXMultiplier,this._temp.y*=m*this.strengthYMultiplier,this._temp.z*=m*this.strengthZMultiplier):(this.strengthX&&(m*=this.strengthX.evaluate(f)*1.5),this._temp.multiplyScalar(m)),i.x+=this._temp.x,i.y+=this._temp.y,i.z+=this._temp.z}}C([p()],be.prototype,"damping",2);C([p()],be.prototype,"enabled",2);C([p()],be.prototype,"frequency",2);C([p()],be.prototype,"octaveCount",2);C([p()],be.prototype,"octaveMultiplier",2);C([p()],be.prototype,"octaveScale",2);C([p(W)],be.prototype,"positionAmount",2);C([p()],be.prototype,"quality",2);C([p(W)],be.prototype,"remap",2);C([p()],be.prototype,"remapEnabled",2);C([p()],be.prototype,"remapMultiplier",2);C([p(W)],be.prototype,"remapX",2);C([p()],be.prototype,"remapXMultiplier",2);C([p(W)],be.prototype,"remapY",2);C([p()],be.prototype,"remapYMultiplier",2);C([p(W)],be.prototype,"remapZ",2);C([p()],be.prototype,"remapZMultiplier",2);C([p()],be.prototype,"scrollSpeedMultiplier",2);C([p()],be.prototype,"separateAxes",2);C([p()],be.prototype,"strengthMultiplier",2);C([p(W)],be.prototype,"strengthX",2);C([p()],be.prototype,"strengthXMultiplier",2);C([p(W)],be.prototype,"strengthY",2);C([p()],be.prototype,"strengthYMultiplier",2);C([p(W)],be.prototype,"strengthZ",2);C([p()],be.prototype,"strengthZMultiplier",2);class Be{constructor(){r(this,"enabled");r(this,"attachRibbonToTransform",!1);r(this,"colorOverLifetime");r(this,"colorOverTrail");r(this,"dieWithParticles",!0);r(this,"inheritParticleColor",!0);r(this,"lifetime");r(this,"lifetimeMultiplier");r(this,"minVertexDistance",.2);r(this,"mode",0);r(this,"ratio",1);r(this,"ribbonCount",1);r(this,"shadowBias",0);r(this,"sizeAffectsLifetime",!1);r(this,"sizeAffectsWidth",!1);r(this,"splitSubEmitterRibbons",!1);r(this,"textureMode",0);r(this,"widthOverTrail");r(this,"widthOverTrailMultiplier");r(this,"worldSpace",!1)}getWidth(t,e,i,n){const o=this.widthOverTrail.evaluate(i,n);return t*=o,t}getColor(t,e,i){const n=this.colorOverTrail.evaluate(i),o=this.colorOverLifetime.evaluate(e);t.x*=n.r*o.r,t.y*=n.g*o.g,t.z*=n.b*o.b,"alpha"in n&&"alpha"in o&&(t.w*=n.alpha*o.alpha)}}C([p()],Be.prototype,"enabled",2);C([p()],Be.prototype,"attachRibbonToTransform",2);C([p(ci)],Be.prototype,"colorOverLifetime",2);C([p(ci)],Be.prototype,"colorOverTrail",2);C([p()],Be.prototype,"dieWithParticles",2);C([p()],Be.prototype,"inheritParticleColor",2);C([p(W)],Be.prototype,"lifetime",2);C([p()],Be.prototype,"lifetimeMultiplier",2);C([p()],Be.prototype,"minVertexDistance",2);C([p()],Be.prototype,"mode",2);C([p()],Be.prototype,"ratio",2);C([p()],Be.prototype,"ribbonCount",2);C([p()],Be.prototype,"shadowBias",2);C([p()],Be.prototype,"sizeAffectsLifetime",2);C([p()],Be.prototype,"sizeAffectsWidth",2);C([p()],Be.prototype,"splitSubEmitterRibbons",2);C([p()],Be.prototype,"textureMode",2);C([p(W)],Be.prototype,"widthOverTrail",2);C([p()],Be.prototype,"widthOverTrailMultiplier",2);C([p()],Be.prototype,"worldSpace",2);class $e{constructor(){r(this,"enabled");r(this,"space",0);r(this,"orbitalX");r(this,"orbitalY");r(this,"orbitalZ");r(this,"orbitalXMultiplier");r(this,"orbitalYMultiplier");r(this,"orbitalZMultiplier");r(this,"orbitalOffsetX");r(this,"orbitalOffsetY");r(this,"orbitalOffsetZ");r(this,"speedModifier");r(this,"speedModifierMultiplier");r(this,"x");r(this,"xMultiplier");r(this,"y");r(this,"yMultiplier");r(this,"z");r(this,"zMultiplier");r(this,"_system");r(this,"_temp",new h.Vector3);r(this,"_temp2",new h.Vector3);r(this,"_temp3",new h.Vector3);r(this,"_hasOrbital",!1);r(this,"_index",0);r(this,"_orbitalMatrix",new h.Matrix4)}update(t){this._system=t}init(t){this._index==0&&(t.debug=!0),this._index+=1,t.orbitx=this.orbitalX.evaluate(Math.random()),t.orbity=this.orbitalY.evaluate(Math.random()),t.orbitz=this.orbitalZ.evaluate(Math.random()),this._hasOrbital=t.orbitx!=0||t.orbity!=0||t.orbitz!=0}apply(t,e,i,n,o,a,l){var g;if(!this.enabled)return;const c=a/l,d=this.speedModifier.evaluate(c)*this.speedModifierMultiplier,u=this.x.evaluate(c),f=this.y.evaluate(c),m=this.z.evaluate(c);if(this._temp.set(-u,f,m),this._system&&this._system.main.simulationSpace===1&&this._temp.applyQuaternion(this._system.worldQuaternion),this._hasOrbital&&((g=this._system)==null?void 0:g.worldPos)){const y=this._temp2.set(i.x,i.y,i.z),b=this.orbitalXMultiplier,v=this.orbitalYMultiplier,w=this.orbitalZMultiplier,P=d*Math.PI*2*10,k=Math.cos(P*b),O=Math.sin(P*b),M=Math.cos(P*v),A=Math.sin(P*v),I=Math.cos(P*w),T=Math.sin(P*w),j=y.x*(M*I)+y.y*(M*T)+y.z*-A,F=y.x*(O*A*I-k*T)+y.y*(O*A*T+k*I)+y.z*(O*M),X=y.x*(k*A*I+O*T)+y.y*(k*A*T-O*I)+y.z*(k*M),E=this._temp3.set(y.x-j,y.y-F,y.z-X);E.normalize(),E.multiplyScalar(.2/o*Math.max(this.orbitalXMultiplier,this.orbitalYMultiplier,this.orbitalZMultiplier)),n.x+=E.x,n.y+=E.y,n.z+=E.z}n.x+=this._temp.x,n.y+=this._temp.y,n.z+=this._temp.z,n.x*=d,n.y*=d,n.z*=d}}C([p()],$e.prototype,"enabled",2);C([p()],$e.prototype,"space",2);C([p(W)],$e.prototype,"orbitalX",2);C([p(W)],$e.prototype,"orbitalY",2);C([p(W)],$e.prototype,"orbitalZ",2);C([p()],$e.prototype,"orbitalXMultiplier",2);C([p()],$e.prototype,"orbitalYMultiplier",2);C([p()],$e.prototype,"orbitalZMultiplier",2);C([p()],$e.prototype,"orbitalOffsetX",2);C([p()],$e.prototype,"orbitalOffsetY",2);C([p()],$e.prototype,"orbitalOffsetZ",2);C([p(W)],$e.prototype,"speedModifier",2);C([p()],$e.prototype,"speedModifierMultiplier",2);C([p(W)],$e.prototype,"x",2);C([p()],$e.prototype,"xMultiplier",2);C([p(W)],$e.prototype,"y",2);C([p()],$e.prototype,"yMultiplier",2);C([p(W)],$e.prototype,"z",2);C([p()],$e.prototype,"zMultiplier",2);class Dt{constructor(){r(this,"animation");r(this,"enabled");r(this,"cycleCount");r(this,"frameOverTime");r(this,"frameOverTimeMultiplier");r(this,"numTilesX");r(this,"numTilesY");r(this,"startFrame");r(this,"startFrameMultiplier");r(this,"rowMode");r(this,"rowIndex");r(this,"spriteCount");r(this,"timeMode")}sampleOnceAtStart(){if(this.timeMode===0)switch(this.frameOverTime.mode){case 0:case 3:case 2:case 1:return!0}return!1}getStartIndex(){return this.sampleOnceAtStart()?Math.random()*(this.numTilesX*this.numTilesY):0}evaluate(t){if(!this.sampleOnceAtStart())return this.getIndex(t)}getIndex(t){const e=this.numTilesX*this.numTilesY;t=t*this.cycleCount;let i=this.frameOverTime.evaluate(t%1);return i*=this.frameOverTimeMultiplier,i*=e,i=i%e,i=Math.floor(i),i}}C([p()],Dt.prototype,"animation",2);C([p()],Dt.prototype,"enabled",2);C([p()],Dt.prototype,"cycleCount",2);C([p(W)],Dt.prototype,"frameOverTime",2);C([p()],Dt.prototype,"frameOverTimeMultiplier",2);C([p()],Dt.prototype,"numTilesX",2);C([p()],Dt.prototype,"numTilesY",2);C([p(W)],Dt.prototype,"startFrame",2);C([p()],Dt.prototype,"startFrameMultiplier",2);C([p()],Dt.prototype,"rowMode",2);C([p()],Dt.prototype,"rowIndex",2);C([p()],Dt.prototype,"spriteCount",2);C([p()],Dt.prototype,"timeMode",2);class _n{constructor(){r(this,"enabled");r(this,"separateAxes");r(this,"x");r(this,"xMultiplier");r(this,"y");r(this,"yMultiplier");r(this,"z");r(this,"zMultiplier")}evaluate(t,e){return this.enabled?this.separateAxes?0:this.z.evaluate(t,e)*-1:0}}C([p()],_n.prototype,"enabled",2);C([p()],_n.prototype,"separateAxes",2);C([p(W)],_n.prototype,"x",2);C([p()],_n.prototype,"xMultiplier",2);C([p(W)],_n.prototype,"y",2);C([p()],_n.prototype,"yMultiplier",2);C([p(W)],_n.prototype,"z",2);C([p()],_n.prototype,"zMultiplier",2);class qi{constructor(){r(this,"enabled");r(this,"range");r(this,"separateAxes");r(this,"x");r(this,"xMultiplier");r(this,"y");r(this,"yMultiplier");r(this,"z");r(this,"zMultiplier")}evaluate(t,e){if(!this.enabled)return 0;if(!this.separateAxes){const i=z.lerp(this.range.x,this.range.y,e);return this.z.evaluate(i)*-1}return 0}}C([p()],qi.prototype,"enabled",2);C([p()],qi.prototype,"range",2);C([p()],qi.prototype,"separateAxes",2);C([p(W)],qi.prototype,"x",2);C([p()],qi.prototype,"xMultiplier",2);C([p(W)],qi.prototype,"y",2);C([p()],qi.prototype,"yMultiplier",2);C([p(W)],qi.prototype,"z",2);C([p()],qi.prototype,"zMultiplier",2);class st{constructor(){r(this,"enabled");r(this,"dampen");r(this,"drag");r(this,"dragMultiplier");r(this,"limit");r(this,"limitMultiplier");r(this,"separateAxes");r(this,"limitX");r(this,"limitXMultiplier");r(this,"limitY");r(this,"limitYMultiplier");r(this,"limitZ");r(this,"limitZMultiplier");r(this,"multiplyDragByParticleSize",!1);r(this,"multiplyDragByParticleVelocity",!1);r(this,"space");r(this,"_temp",new h.Vector3);r(this,"_temp2",new h.Vector3)}apply(t,e,i,n,o,a,l){if(this.enabled){const c=this.limit.evaluate(o)*this.limitMultiplier;if(e.length()>c){this._temp.copy(e).normalize().multiplyScalar(c);const u=this.dampen*.5;e.x=z.lerp(e.x,this._temp.x,u),e.y=z.lerp(e.y,this._temp.y,u),e.z=z.lerp(e.z,this._temp.z,u),i.x=z.lerp(i.x,this._temp.x,u),i.y=z.lerp(i.y,this._temp.y,u),i.z=z.lerp(i.z,this._temp.z,u)}}}}C([p()],st.prototype,"enabled",2);C([p()],st.prototype,"dampen",2);C([p(W)],st.prototype,"drag",2);C([p()],st.prototype,"dragMultiplier",2);C([p(W)],st.prototype,"limit",2);C([p()],st.prototype,"limitMultiplier",2);C([p()],st.prototype,"separateAxes",2);C([p(W)],st.prototype,"limitX",2);C([p()],st.prototype,"limitXMultiplier",2);C([p(W)],st.prototype,"limitY",2);C([p()],st.prototype,"limitYMultiplier",2);C([p(W)],st.prototype,"limitZ",2);C([p()],st.prototype,"limitZMultiplier",2);C([p()],st.prototype,"multiplyDragByParticleSize",2);C([p()],st.prototype,"multiplyDragByParticleVelocity",2);C([p()],st.prototype,"space",2);const Ow=class{constructor(){r(this,"enabled");r(this,"curve");r(this,"curveMultiplier");r(this,"mode");r(this,"system");r(this,"_temp",new h.Vector3);r(this,"_firstUpdate",!0);r(this,"_frames",0)}clone(){var t;const s=new Ow;return s.enabled=this.enabled,s.curve=(t=this.curve)==null?void 0:t.clone(),s.curveMultiplier=this.curveMultiplier,s.mode=this.mode,s}get _lastWorldPosition(){return this.system._iv_lastWorldPosition||(this.system._iv_lastWorldPosition=new h.Vector3),this.system._iv_lastWorldPosition}get _velocity(){return this.system._iv_velocity||(this.system._iv_velocity=new h.Vector3),this.system._iv_velocity}awake(s){this.system=s,this.reset()}reset(){this._firstUpdate=!0}update(s){this.enabled&&this.system.worldspace!==!1&&(this._firstUpdate?(this._firstUpdate=!1,this._velocity.set(0,0,0),this._lastWorldPosition.copy(this.system.worldPos)):this._lastWorldPosition&&(this._velocity.copy(this.system.worldPos).sub(this._lastWorldPosition).multiplyScalar(1/this.system.deltaTime),this._lastWorldPosition.copy(this.system.worldPos)))}applyInitial(s){if(this.enabled&&this.system.worldspace!==!1&&this.mode===0){const t=this.curve.evaluate(Math.random(),Math.random());this._temp.copy(this._velocity).multiplyScalar(t),s.x+=this._temp.x,s.y+=this._temp.y,s.z+=this._temp.z}}applyCurrent(s,t,e){if(this.enabled&&this.system&&this.system.worldspace!==!1&&this.mode===1){const i=this.curve.evaluate(t,e);this._temp.copy(this._velocity).multiplyScalar(i),s.x+=this._temp.x,s.y+=this._temp.y,s.z+=this._temp.z}}};let Lr=Ow;C([p()],Lr.prototype,"enabled",2);C([p(W)],Lr.prototype,"curve",2);C([p()],Lr.prototype,"curveMultiplier",2);C([p()],Lr.prototype,"mode",2);class hi{constructor(){r(this,"enabled");r(this,"range");r(this,"separateAxes");r(this,"size");r(this,"sizeMultiplier");r(this,"x");r(this,"xMultiplier");r(this,"y");r(this,"yMultiplier");r(this,"z");r(this,"zMultiplier")}evaluate(t,e,i,n){const o=t.length(),a=z.remap(o,this.range.x,this.range.y,0,1),l=this.size.evaluate(a,i);return n.x*=l,n.y*=l,n.z*=l,n}}C([p()],hi.prototype,"enabled",2);C([p(h.Vector2)],hi.prototype,"range",2);C([p()],hi.prototype,"separateAxes",2);C([p(W)],hi.prototype,"size",2);C([p()],hi.prototype,"sizeMultiplier",2);C([p(W)],hi.prototype,"x",2);C([p()],hi.prototype,"xMultiplier",2);C([p(W)],hi.prototype,"y",2);C([p()],hi.prototype,"yMultiplier",2);C([p(W)],hi.prototype,"z",2);C([p()],hi.prototype,"zMultiplier",2);class ol{constructor(){r(this,"enabled");r(this,"range");r(this,"color")}evaluate(t,e,i){const n=t.length(),o=z.remap(n,this.range.x,this.range.y,0,1),a=this.color.evaluate(o,e);i.x*=a.r,i.y*=a.g,i.z*=a.b,"alpha"in a&&(i.w*=a.alpha)}}C([p()],ol.prototype,"enabled",2);C([p(h.Vector2)],ol.prototype,"range",2);C([p(ci)],ol.prototype,"color",2);new h.Vector3(1,1,1);new h.Vector3(0,0,1);class Jg{constructor(t,e,i,n){r(this,"type","NeedleParticleSubEmitter");r(this,"emitterType");r(this,"emitterProbability");r(this,"q_",new h.Quaternion);r(this,"v_",new h.Vector3);r(this,"v2_",new h.Vector3);r(this,"_emitterMatrix",new oe.Matrix4);r(this,"_circularBuffer");this.system=t,this.particleSystem=e,this.subSystem=i,this.subParticleSystem=n,this.subParticleSystem&&this.subParticleSystem&&(this.subParticleSystem.onlyUsedByOther=!0);const o=1e3;this._circularBuffer=new xi(()=>new oe.Matrix4,o)}clone(){throw new Error("Method not implemented.")}initialize(t){t.emissionState={burstIndex:0,burstWaveIndex:0,time:0,waitEmiting:0},this._emitterMatrix.copy(this.subSystem.matrixWorld).invert().premultiply(this.system.matrixWorld),this._emitterMatrix.setPosition(0,0,0),this.emitterType===pm.Birth&&this.run(t)}update(t,e){this.run(t)}frameUpdate(t){}toJSON(){}reset(){}run(t){if(this.subSystem.currentParticles>=this.subSystem.main.maxParticles||!this.subParticleSystem||!t.emissionState||this.emitterProbability&&Math.random()>this.emitterProbability)return;const e=this.system.deltaTime;if(this.emitterType===pm.Death){let n=t.life;if(t[ua]!==void 0&&(n=t[ua]),!(t.age+e*1.2>=n))return;const a=this.subSystem.main.maxParticles-this.subSystem.currentParticles;t.emissionState.waitEmiting=a}const i=new oe.Matrix4;i.set(1,0,0,t.position.x,0,1,0,t.position.y,0,0,1,t.position.z,0,0,0,1),this.particleSystem.worldSpace||i.multiplyMatrices(this._emitterMatrix,i),this.subParticleSystem.emit(e,t.emissionState,i)}}var jR=Object.defineProperty,BR=Object.getOwnPropertyDescriptor,Fe=(s,t,e,i)=>{for(var n=i>1?void 0:i?BR(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&jR(t,e,n),n};const Gs=x("debugparticles"),FR=x("noprogressive"),UR=x("debugprogressive");var pm=(s=>(s[s.Birth=0]="Birth",s[s.Collision=1]="Collision",s[s.Death=2]="Death",s[s.Trigger=3]="Trigger",s[s.Manual=4]="Manual",s))(pm||{});class Xi extends D{constructor(){super(...arguments);r(this,"renderMode");r(this,"particleMaterial");r(this,"trailMaterial");r(this,"particleMesh");r(this,"maxParticleSize");r(this,"minParticleSize");r(this,"velocityScale");r(this,"cameraVelocityScale");r(this,"lengthScale")}start(){if(this.maxParticleSize!==.5&&this.minParticleSize!==0&&B()){const e=`ParticleSystem "${this.name}" has non-default min/max particle size. This may not render correctly. Please set min size to 0 and the max size to 0.5 and use the "StartSize" setting instead`;console.warn(e)}}get transparent(){var i;return((i=this.particleMaterial)==null?void 0:i.transparent)??!1}getMaterial(e=!1){let i=e===!0&&this.trailMaterial?this.trailMaterial:this.particleMaterial;if(i){if(i.type==="MeshStandardMaterial"){Gs&&console.debug("ParticleSystemRenderer.getMaterial: MeshStandardMaterial detected, converting to MeshBasicMaterial. See https://github.com/Alchemist0823/three.quarks/issues/101"),"map"in i&&i.map&&(i.map.colorSpace=h.LinearSRGBColorSpace,i.map.premultiplyAlpha=!1);const n=new h.MeshBasicMaterial;n.copy(i),e?this.trailMaterial=n:this.particleMaterial=n}i.map&&(i.map.colorSpace=h.LinearSRGBColorSpace,i.map.premultiplyAlpha=!1),e&&i.side===h.FrontSide&&(i=i.clone(),i.side=h.BackSide,e?this.trailMaterial=i:this.particleMaterial=i)}return i&&!FR&&i._didRequestTextureLOD===void 0&&(i._didRequestTextureLOD=0,UR&&console.log("Load material LOD",i.name),re.NEEDLE_progressive.assignTextureLOD(i,0)),i}getMesh(e){let i=null;if(!i&&(this.particleMesh instanceof h.Mesh&&(i=this.particleMesh.geometry),i===null)){i=new h.PlaneGeometry(1,1);const o=i.attributes.uv;for(let a=0;a<o.count;a++)o.setX(a,1-o.getX(a))}return new h.Mesh(i,this.getMaterial())}}Fe([p()],Xi.prototype,"renderMode",2);Fe([p(h.Material)],Xi.prototype,"particleMaterial",2);Fe([p(h.Material)],Xi.prototype,"trailMaterial",2);Fe([p()],Xi.prototype,"maxParticleSize",2);Fe([p()],Xi.prototype,"minParticleSize",2);Fe([p()],Xi.prototype,"velocityScale",2);Fe([p()],Xi.prototype,"cameraVelocityScale",2);Fe([p()],Xi.prototype,"lengthScale",2);class ed{constructor(t,e=1){r(this,"_curve");r(this,"_factor");r(this,"type","function");this._curve=t,this._factor=e}startGen(t){}genValue(t,e){return this._curve.evaluate(e,Math.random())*this._factor}toJSON(){throw new Error("Method not implemented.")}clone(){throw new Error("Method not implemented.")}}class e_{constructor(t){r(this,"type","value");r(this,"system");this.system=t}toJSON(){throw new Error("Method not implemented.")}clone(){throw new Error("Method not implemented.")}startGen(t){}}class zR extends e_{genValue(){return this.system.textureSheetAnimation.getStartIndex()}}class NR extends e_{constructor(){super(...arguments);r(this,"_lastPosition",new h.Vector3);r(this,"_lastDistance",0)}update(){const e=Z(this.system.gameObject);this._lastDistance=this._lastPosition.distanceTo(e),this._lastPosition.copy(e)}genValue(){if(!this.system.isPlaying||!this.system.emission.enabled||this.system.currentParticles>=this.system.maxParticles)return 0;let e=this.system.emission.rateOverTime.evaluate(this.system.time/this.system.duration,Math.random());if(this.system.deltaTime>0){const o=this.system.emission.rateOverDistance.evaluate(this.system.time/this.system.duration,Math.random());let l=this._lastDistance/this.system.deltaTime*o;Number.isFinite(l)||(l=0),e+=l}const i=this.system.emission.getBurst();i>0&&(e+=i/this.system.deltaTime);const n=this.system.maxParticles-this.system.currentParticles;return z.clamp(e,0,n/this.system.deltaTime)}}class VR extends e_{genValue(){return this.system.isPlaying,0}}class Co{constructor(t){r(this,"system");r(this,"type");this.type=Object.getPrototypeOf(this).constructor.name||"ParticleSystemBaseBehaviour",t&&(this.system=t)}get context(){return this.system.context}initialize(t){}update(t,e){}frameUpdate(t){}toJSON(){throw new Error("Method not implemented.")}clone(){throw new Error("Method not implemented.")}reset(){}}class $R extends Co{constructor(){super(...arguments);r(this,"type","NeedleTextureSheet")}update(e,i){const n=this.system.textureSheetAnimation;if(n.enabled){const o=e.age/e.life,a=n.evaluate(o);a!==void 0&&(e.uvTile=a)}}}const ob=Symbol("particleRotation");class WR extends Co{constructor(){super(...arguments);r(this,"type","NeedleRotation")}initialize(e){e[ob]=Math.random()}update(e,i){if(e.rotation===void 0)return;const n=e.age/e.life;if(typeof e.rotation=="number"&&(this.system.rotationOverLifetime.enabled?e.rotation+=this.system.rotationOverLifetime.evaluate(n,e[ob])*i:this.system.renderer.renderMode===rs.Billboard&&(e.rotation=Math.PI),this.system.rotationBySpeed.enabled)){const o=e.velocity.length();e.rotation+=this.system.rotationBySpeed.evaluate(n,o)*i}}}const rb=Symbol("sizeLerpFactor"),GR=new h.Vector3;class HR extends Co{constructor(){super(...arguments);r(this,"type","NeedleSize");r(this,"_minSize",0);r(this,"_maxSize",1)}initialize(e){e[rb]=Math.random(),this._minSize=this.system.renderer.minParticleSize,this._maxSize=this.system.renderer.maxParticleSize}update(e,i){const n=e.age/e.life;let o=1;this.system.sizeOverLifetime.enabled&&(o*=this.system.sizeOverLifetime.evaluate(n,void 0,e[rb]).x);let a=1;this.system.renderer.renderMode!==rs.Mesh&&(a=this.system.worldScale.x/this.system.cameraScale);const l=$(e.startSize).multiplyScalar(o*a);if(e.size.set(l.x,l.y,l.z),this.system.localspace){const c=Mw(this.system,GR);e.size.x*=c.x,e.size.y*=c.y,e.size.z*=c.z}}}const ua=Symbol("particleLife"),sp=Symbol("trailLifetime"),ab=Symbol("trailStartLength"),op=Symbol("trailWidthRandom");class qR extends Co{constructor(){super(...arguments);r(this,"type","NeedleTrail")}initialize(e){e instanceof oe.TrailParticle&&(e[ua]=e.life,this.system.trails.enabled&&this.system.trails.dieWithParticles===!1&&(e[sp]=this.system.trails.lifetime.evaluate(Math.random(),Math.random()),e.life+=e[sp]),e[ab]=e.length,e[op]=Math.random())}update(e){var i;if((i=this.system.trails)!=null&&i.enabled&&e instanceof oe.TrailParticle){const n=e,o=e.age/e[ua],a=e.previous.values(),l=e.previous.length;for(let c=0;c<l;c++){const u=a.next().value,f=1-c/(l-1),m=e.size;if(m.x<=0&&!this.system.trails.sizeAffectsWidth){const g=20*this.system.trails.widthOverTrail.evaluate(.5,n[op]);m.x=g,m.y=g,m.z=g}u.size=this.system.trails.getWidth(m.x,o,f,n[op]),u.color.copy(e.color),this.system.trails.getColor(u.color,o,f)}if(e.age>e[ua]){e.velocity.set(0,0,0);const c=(e.age-e[ua])/e[sp];n.length=z.lerp(e[ab],0,c)}}}}const td=Symbol("startVelocity"),lb=Symbol("gravityModifier"),rp=Symbol("gravitySpeed"),id=Symbol("velocity lerp factor"),mm=new h.Vector3;class XR extends Co{constructor(){super(...arguments);r(this,"type","NeedleVelocity");r(this,"_gravityDirection",new h.Vector3)}initialize(e){var a,l;const i=this.system.main.simulationSpeed;e.startSpeed=this.system.main.startSpeed.evaluate(Math.random(),Math.random());const n=this.system.shape.getDirection(e,e.position);e.velocity.x=n.x*e.startSpeed,e.velocity.y=n.y*e.startSpeed,e.velocity.z=n.z*e.startSpeed,(a=this.system.inheritVelocity)!=null&&a.enabled&&this.system.inheritVelocity.applyInitial(e.velocity),e[td]?e[td].copy(e.velocity):e[td]=e.velocity.clone();const o=this.system.main.gravityModifier.evaluate(Math.random(),Math.random());e[lb]=o*i,e[rp]=o*i*.5,e[id]=Math.random(),(l=this.system.velocityOverLifetime)==null||l.init(e),this._gravityDirection.set(0,-1,0),this.system.main.simulationSpace===Ec.Local&&this._gravityDirection.applyQuaternion(this.system.worldQuaternionInverted).normalize()}update(e,i){var m;const n=e[td],o=e[lb];if(o!==0){const g=o*e[rp];mm.copy(this._gravityDirection).multiplyScalar(g),e[rp]+=i*.05,n.add(mm)}e.velocity.copy(n);const a=e.age/e.life;(m=this.system.inheritVelocity)!=null&&m.enabled&&this.system.inheritVelocity.applyCurrent(e.velocity,a,e[id]);const l=this.system.noise;l.enabled&&l.apply(0,e.position,e.velocity,i,e.age,e.life);const c=this.system.sizeBySpeed;c!=null&&c.enabled&&(e.size=c.evaluate(e.velocity,a,e[id],e.size));const d=this.system.colorBySpeed;d!=null&&d.enabled&&d.evaluate(e.velocity,e[id],e.color);const u=this.system.velocityOverLifetime;u.enabled&&u.apply(e,0,e.position,e.velocity,i,e.age,e.life);const f=this.system.limitVelocityOverLifetime;if(f.enabled&&f.apply(e.position,n,e.velocity,e.size,a,i,1),this.system.worldspace){const g=this.system.worldScale;e.velocity.x*=g.x,e.velocity.y*=g.y,e.velocity.z*=g.z}}}const cb=Symbol("colorLerpFactor"),hb=new me(1,1,1,1),Do=new me(1,1,1,1);class QR extends Co{constructor(){super(...arguments);r(this,"type","NeedleColor")}initialize(e){}_init(e){const i=this.system.renderer.particleMaterial;Do.copy(this.system.main.startColor.evaluate(Math.random())),i!=null&&i.color&&(hb.copy(i.color),Do.multiply(hb)),Do.convertLinearToSRGB(),e.startColor.set(Do.r,Do.g,Do.b,Do.alpha),e.color.copy(e.startColor),e[cb]=Math.random()}update(e,i){if(e.age===0&&this._init(e),this.system.colorOverLifetime.enabled){const n=e.age/e.life,o=this.system.colorOverLifetime.color.evaluate(n,e[cb]);e.color.set(o.r,o.g,o.b,"alpha"in o?o.alpha:1).multiply(e.startColor)}else e.color.copy(e.startColor)}}class YR{constructor(t){r(this,"system");r(this,"emission");r(this,"autoDestroy");r(this,"startLength");r(this,"emissionBursts");r(this,"onlyUsedByOther");r(this,"behaviors",[]);r(this,"rendererEmitterSettings",{startLength:new oe.ConstantValue(220),followLocalOrigin:!1});r(this,"flatWhiteTexture");r(this,"clonedTexture",{original:void 0,clone:void 0});this.system=t,this.emission=new NR(this.system)}get anim(){return this.system.textureSheetAnimation}get prewarm(){return!1}get material(){return this.system.renderer.getMaterial(this.system.trails.enabled)}get layers(){return this.system.gameObject.layers}update(){this.emission.update()}get looping(){return this.system.main.loop}get duration(){return this.system.duration}get shape(){return this.system.shape}get startLife(){return new ed(this.system.main.startLifetime)}get startSpeed(){return new ed(this.system.main.startSpeed)}get startRotation(){return new ed(this.system.main.startRotation)}get startSize(){return new ed(this.system.main.startSize)}get startColor(){return new oe.ConstantColor(new oe.Vector4(1,1,1,1))}get emissionOverTime(){return this.emission}get emissionOverDistance(){return new VR(this.system)}get instancingGeometry(){return this.system.renderer.getMesh(this.system.renderer.renderMode).geometry}get renderMode(){if(this.system.trails.enabled===!0)return oe.RenderMode.Trail;switch(this.system.renderer.renderMode){case rs.Billboard:return oe.RenderMode.BillBoard;case rs.Stretch:return oe.RenderMode.StretchedBillBoard;case rs.HorizontalBillboard:return oe.RenderMode.HorizontalBillBoard;case rs.VerticalBillboard:return oe.RenderMode.VerticalBillBoard;case rs.Mesh:return oe.RenderMode.Mesh}return oe.RenderMode.BillBoard}get speedFactor(){var e;let t=this.system.main.simulationSpeed;return((e=this.system.renderer)==null?void 0:e.renderMode)===rs.Stretch&&(t*=this.system.renderer.velocityScale??1),t}get texture(){const t=this.material;if(t&&t.map){const e=t.map;if(this.clonedTexture.original!==e||!this.clonedTexture.clone){const i=e.clone();i.premultiplyAlpha=!1,i.colorSpace=h.LinearSRGBColorSpace,this.clonedTexture.original=e,this.clonedTexture.clone=i}return this.clonedTexture.clone}return this.flatWhiteTexture||(this.flatWhiteTexture=ag(new me(1,1,1,1),1)),this.flatWhiteTexture}get startTileIndex(){return new zR(this.system)}get uTileCount(){var t;return this.anim.enabled?(t=this.anim)==null?void 0:t.numTilesX:void 0}get vTileCount(){var t;return this.anim.enabled?(t=this.anim)==null?void 0:t.numTilesY:void 0}get renderOrder(){return 1}get blending(){var t;return((t=this.system.renderer.particleMaterial)==null?void 0:t.blending)??h.NormalBlending}get transparent(){return this.system.renderer.transparent}get worldSpace(){return this.system.main.simulationSpace===Ec.World}}class KR{constructor(){r(this,"burstParticleIndex",0);r(this,"burstParticleCount",0);r(this,"isBursting",!1);r(this,"travelDistance",0);r(this,"previousWorldPos");r(this,"burstIndex",0);r(this,"burstWaveIndex",0);r(this,"time",0);r(this,"waitEmiting",0)}}const Od=class extends D{constructor(){super(...arguments);r(this,"_state");r(this,"colorOverLifetime");r(this,"main");r(this,"emission");r(this,"sizeOverLifetime");r(this,"shape");r(this,"noise");r(this,"trails");r(this,"velocityOverLifetime");r(this,"limitVelocityOverLifetime");r(this,"inheritVelocity");r(this,"colorBySpeed");r(this,"textureSheetAnimation");r(this,"rotationOverLifetime");r(this,"rotationBySpeed");r(this,"sizeBySpeed");r(this,"_cameraScale",1);r(this,"__worldQuaternion",new h.Quaternion);r(this,"_worldQuaternionInverted",new h.Quaternion);r(this,"_worldScale",new h.Vector3);r(this,"_worldPositionFrame",-1);r(this,"_worldPos",new h.Vector3);r(this,"_renderer");r(this,"_batchSystem");r(this,"_particleSystem");r(this,"_interface");r(this,"_container");r(this,"_time",0);r(this,"_isPlaying",!0);r(this,"_isUsedAsSubsystem",!1);r(this,"_didPreWarm",!1);r(this,"_bursts");r(this,"_subEmitterSystems");r(this,"_lastBatchesCount",-1)}play(t=!1){var e;t&&S.foreachComponent(this.gameObject,i=>{i instanceof Od&&i!==this&&i.play(!1)},!0),this._isPlaying=!0,this._particleSystem&&(this._particleSystem.emissionState.time=0,this._particleSystem.emitEnded=!1),(e=this.emission)==null||e.reset()}pause(t=!0){t&&S.foreachComponent(this.gameObject,e=>{e instanceof Od&&e!==this&&e.pause(!1)},!0),this._isPlaying=!1}stop(t=!0,e=!1){t&&S.foreachComponent(this.gameObject,i=>{i instanceof Od&&i!==this&&i.stop(!1,e)},!0),this._isPlaying=!1,this._time=0,e&&this.reset()}reset(){var t;this._time=0,this._particleSystem&&(this._particleSystem.particleNum=0,this._particleSystem.emissionState.time=0,this._particleSystem.emitEnded=!1,(t=this.emission)==null||t.reset())}emit(t){if(this._particleSystem){this.onUpdate(),t=Math.min(t,this.maxParticles-this.currentParticles),this._state||(this._state=new KR),this._state.waitEmiting=t,this._state.time=0;const e=this._particleSystem.emitEnded;this._particleSystem.emitEnded=!1,this._particleSystem.emit(this.deltaTime,this._state,this._particleSystem.emitter.matrixWorld),this._particleSystem.emitEnded=e}}get playOnAwake(){return this.main.playOnAwake}set playOnAwake(t){this.main.playOnAwake=t}get renderer(){return this._renderer}get isPlaying(){return this._isPlaying}get currentParticles(){var t;return((t=this._particleSystem)==null?void 0:t.particleNum)??0}get maxParticles(){return this.main.maxParticles}get time(){return this._time}get duration(){return this.main.duration}get deltaTime(){return this.context.time.deltaTime*this.main.simulationSpeed}get scale(){return this.gameObject.scale.x}get cameraScale(){return this._cameraScale}get container(){return this._container}get worldspace(){return this.main.simulationSpace===Ec.World}get localspace(){return this.main.simulationSpace===Ec.Local}get worldQuaternion(){return this.__worldQuaternion}get worldQuaternionInverted(){return this._worldQuaternionInverted}get worldScale(){return this._worldScale}get worldPos(){return this._worldPositionFrame!==this.context.time.frame&&(this._worldPositionFrame=this.context.time.frame,Z(this.gameObject,this._worldPos)),this._worldPos}get matrixWorld(){return this._container.matrixWorld}get isSubsystem(){return this._isUsedAsSubsystem}addBehaviour(t){return this._particleSystem?(t instanceof Co&&(t.system=this),Gs&&console.debug("Add custom ParticleSystem Behaviour",t),this._particleSystem.addBehavior(t),!0):!1}removeBehaviour(t){if(!this._particleSystem)return!1;const e=this._particleSystem.behaviors,i=e.indexOf(t);return i!==-1&&((B()||Gs)&&console.debug("Remove custom ParticleSystem Behaviour",i,t),e.splice(i,1)),!0}removeAllBehaviours(){return this._particleSystem?(this._particleSystem.behaviors.length=0,!0):!1}get behaviours(){return this._particleSystem?this._particleSystem.behaviors:null}get particleSystem(){return this._particleSystem??null}set bursts(t){for(let e=0;e<t.length;e++){const i=t[e];if(!(i instanceof su)){const n=new su;Da(n,i),t[e]=n}}this._bursts=t}set subEmitterSystems(t){for(let e=0;e<t.length;e++){const i=t[e];if(!(i instanceof ou)){const n=new ou;Da(n,i),t[e]=n}}Gs&&t.length>0&&console.log("SubEmitters: ",t,this),this._subEmitterSystems=t}onAfterDeserialize(t){if(this._subEmitterSystems&&Array.isArray(this._subEmitterSystems))for(const e of this._subEmitterSystems)e._deserialize(this.context,this.gameObject)}awake(){if(this._worldPositionFrame=-1,this._renderer=this.gameObject.getComponent(Xi),!this.main)throw new Error("Not Supported: ParticleSystem needs a serialized MainModule. Creating new particle systems at runtime is currently not supported.");this._container=new h.Object3D,this._container.matrixAutoUpdate=!1,this.context.scene.add(this._container),this._batchSystem=new oe.BatchedParticleRenderer,this._batchSystem.name=this.gameObject.name,this._container.add(this._batchSystem),this._interface=new YR(this),this._particleSystem=new oe.ParticleSystem(this._interface),this._particleSystem.addBehavior(new HR(this)),this._particleSystem.addBehavior(new QR(this)),this._particleSystem.addBehavior(new $R(this)),this._particleSystem.addBehavior(new WR(this)),this._particleSystem.addBehavior(new XR(this)),this._particleSystem.addBehavior(new qR(this)),this._batchSystem.addSystem(this._particleSystem);const t=this._particleSystem.emitter;this.context.scene.add(t),this.inheritVelocity.system&&this.inheritVelocity.system!==this&&(this.inheritVelocity=this.inheritVelocity.clone()),this.inheritVelocity.awake(this),Gs&&(console.log(this),this.gameObject.add(new h.AxesHelper(1)))}start(){this.addSubParticleSystems(),this.updateLayers(),this.renderer.particleMesh instanceof h.Mesh&&this._interface.renderMode==oe.RenderMode.Mesh&&re.NEEDLE_progressive.assignMeshLOD(this.renderer.particleMesh,0).then(t=>{t&&this.particleSystem&&this._interface.renderMode==oe.RenderMode.Mesh&&(this.particleSystem.instancingGeometry=t)})}onDestroy(){var t,e,i,n;(t=this._container)==null||t.removeFromParent(),(e=this._batchSystem)==null||e.removeFromParent(),(i=this._particleSystem)==null||i.emitter.removeFromParent(),(n=this._particleSystem)==null||n.dispose()}onEnable(){this.main&&(this.inheritVelocity&&(this.inheritVelocity.system=this),this._batchSystem&&(this._batchSystem.visible=!0),this.playOnAwake&&this.play(),this._isPlaying=this.playOnAwake)}onDisable(){this._batchSystem&&(this._batchSystem.visible=!1)}onBeforeRender(){var t;this.main&&(this._didPreWarm===!1&&((t=this.main)==null?void 0:t.prewarm)===!0&&(this._didPreWarm=!0,this.preWarm()),this.onUpdate(),this.onSimulate(this.deltaTime))}preWarm(){var d;if(!((d=this.emission)!=null&&d.enabled)||this.emission.rateOverTime.getMax()<=0)return;const e=1/60,i=this.main.duration,n=this.main.startLifetime.getMax(),o=1e3,a=Math.min(Math.max(i,n)/Math.max(.01,this.main.simulationSpeed),o),l=Math.ceil(a/e),c=Date.now();Gs&&console.log(`Particles ${this.name} - Prewarm for ${l} frames (${a} sec). Duration: ${i}, Lifetime: ${n}`);for(let u=0;u<l&&!(this.currentParticles>=this.maxParticles);u++){const f=Date.now()-c;if(f>2e3){console.warn(`Particles ${this.name} - Prewarm took too long. Aborting: ${f}`);break}this.onUpdate(),this.onSimulate(e)}}onSimulate(t){if(this._batchSystem){let e=this.context.time.frameCount%60===0;this._lastBatchesCount!==this._batchSystem.batches.length&&(this._lastBatchesCount=this._batchSystem.batches.length,e=!0),e&&this.updateLayers(),this._batchSystem.update(t)}this._time+=t,this._time>this.duration&&(this._time=0)}updateLayers(){if(this._batchSystem)for(let t=0;t<this._batchSystem.batches.length;t++){const e=this._batchSystem.batches[t];e.layers.disableAll();const i=this.layer;e.layers.mask=1<<i}}onUpdate(){var n,o;if(this._bursts&&(this.emission.bursts=this._bursts,delete this._bursts),!this._isPlaying)return;const t=this.context.mainCamera;if(t){const a=Ue(t);this._cameraScale=a.x}const e=!this.worldspace,i=this.gameObject;if(_e(i,this.__worldQuaternion),this._worldQuaternionInverted.copy(this.__worldQuaternion).invert(),Ue(this.gameObject,this._worldScale),e&&this._container&&((n=this.gameObject)!=null&&n.parent)){const a=Mw(this,mm);this._container.matrix.makeScale(a.x,a.y,a.z),this._container.matrix.makeRotationFromQuaternion(this.__worldQuaternion),this._container.matrix.setPosition(this.worldPos),this._container.matrix.scale(this.gameObject.scale)}this.emission.system=this,this._interface.update(),this.shape.onUpdate(this,this.context,this.main.simulationSpace,this.gameObject),this.noise.update(this.context),(o=this.inheritVelocity)==null||o.update(this.context),this.velocityOverLifetime.update(this)}addSubParticleSystems(){var t;if(this._subEmitterSystems&&this._particleSystem)for(const e of this._subEmitterSystems){e.particleSystem&&(e.particleSystem.__internalAwake?e.particleSystem.__internalAwake():B()&&console.warn("SubParticleSystem serialization issue(?)",e.particleSystem,e));const i=(t=e.particleSystem)==null?void 0:t._particleSystem;if(i){e.particleSystem._isUsedAsSubsystem=!0;const n=new Jg(this,this._particleSystem,e.particleSystem,i);n.emitterType=e.type,n.emitterProbability=e.emitProbability,this._particleSystem.addBehavior(n)}else Gs&&console.warn("Could not add SubParticleSystem",e,this)}}};let Qe=Od;Fe([p(Xu)],Qe.prototype,"colorOverLifetime",2);Fe([p(At)],Qe.prototype,"main",2);Fe([p(Os)],Qe.prototype,"emission",2);Fe([p(Dr)],Qe.prototype,"sizeOverLifetime",2);Fe([p(Ve)],Qe.prototype,"shape",2);Fe([p(be)],Qe.prototype,"noise",2);Fe([p(Be)],Qe.prototype,"trails",2);Fe([p($e)],Qe.prototype,"velocityOverLifetime",2);Fe([p(st)],Qe.prototype,"limitVelocityOverLifetime",2);Fe([p(Lr)],Qe.prototype,"inheritVelocity",2);Fe([p(ol)],Qe.prototype,"colorBySpeed",2);Fe([p(Dt)],Qe.prototype,"textureSheetAnimation",2);Fe([p(_n)],Qe.prototype,"rotationOverLifetime",2);Fe([p(qi)],Qe.prototype,"rotationBySpeed",2);Fe([p(hi)],Qe.prototype,"sizeBySpeed",2);class ou{constructor(){r(this,"particleSystem");r(this,"emitProbability",1);r(this,"properties");r(this,"type")}_deserialize(t,e){const i=this.particleSystem;if(i instanceof Qe)return;let n="";i&&typeof i.guid=="string"&&(n=i.guid,this.particleSystem=S.findByGuid(n,e)),Gs&&!(this.particleSystem instanceof Qe)&&console.warn("Could not find particle system for sub emitter",n,e,this)}}function Mw(s,t){if(t.set(1,1,1),s.gameObject.parent&&s.localspace)switch(s.main.scalingMode){case fm.Local:t=Ue(s.gameObject.parent,t),t.x=1/t.x,t.y=1/t.y,t.z=1/t.z;break;default:if(!s.unsupported_scaling_mode){s.unsupported_scaling_mode=!0;const e="ParticleSystem scale mode "+fm[s.main.scalingMode]+" is not supported";B()&&pe(e),console.warn(e,s.name,s)}t=Ue(s.gameObject,t);break}return t}class Ba extends D{constructor(){super(...arguments);r(this,"_didAssignPlayerColor",!1);r(this,"tryAssignColor",()=>{const e=S.getComponentInParent(this.gameObject,vi);if(e&&e.owner)return this._didAssignPlayerColor=!0,this.assignUserColor(e.owner),!0;const i=S.getComponentInParent(this.gameObject,tt);return i!=null&&i.connectionId?(this._didAssignPlayerColor=!0,this.assignUserColor(i.connectionId),!0):!1})}onEnable(){this.context.connection.beginListen(J.JoinedRoom,this.tryAssignColor),this._didAssignPlayerColor||this.startCoroutine(this.waitForConnection())}onDisable(){this.context.connection.stopListen(J.JoinedRoom,this.tryAssignColor)}*waitForConnection(){for(;!this.destroyed&&this.activeAndEnabled&&(yield rg(.2),!this.tryAssignColor()););}assignUserColor(e){const i=Ba.hashCode(e),n=Ba.colorFromHashCode(i);if(this.gameObject.type==="Mesh"){const o=this.gameObject;this.assignColor(n,e,o)}else if(this.gameObject.children)for(const o of this.gameObject.children){const a=o;a.material&&a.material.color&&this.assignColor(n,e,a)}}assignColor(e,i,n){let o=n.material;o&&(o._playerMaterial!==i&&(o=o.clone(),o._playerMaterial=i,n.material=o),o.color=e)}static hashCode(e){var i=0,n,o;if(e.length===0)return i;for(n=0;n<e.length;n++)o=e.charCodeAt(n),i=(i<<5)-i+o,i|=0;return i}static colorFromHashCode(e){const i=(e&16711680)>>16,n=(e&65280)>>8,o=e&255;return new h.Color(i/255,n/255,o/255)}}const ZR=x("debugpost");let gm=null;function JR(s){gm=s}function Rw(s){let t=s.gameObject;for(;t;){for(const e of ku(t))if(e.isPostProcessingManager===!0)return e;t=t.parent}return null}function ek(s){let t=Rw(s);if(!t)if(gm){ZR&&console.warn("Adding postprocessing manager to the scene.");const e=s.scene;t=wi(e,gm)}else B()&&console.warn("No post processing manager found");return t}var tk=Object.defineProperty,ik=Object.getOwnPropertyDescriptor,kw=(s,t,e,i)=>{for(var n=i>1?void 0:i?ik(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&tk(t,e,n),n};const nk=x("debugpost");class U{constructor(t){r(this,"isVolumeParameter",!0);r(this,"_isInitialized",!1);r(this,"_active",!0);r(this,"_value");r(this,"_valueRaw");r(this,"_defaultValue");r(this,"valueProcessor");r(this,"onValueChanged");t!==void 0&&this.initialize(t)}get isInitialized(){return this._isInitialized}initialize(t){t!==void 0&&(this._value=t,this._defaultValue=t,this._valueRaw=t,this._isInitialized=!0)}get overrideState(){return this._active}set overrideState(t){if(this._active===t)return;this._active=t;const e=t?this._valueRaw:this._defaultValue;this.processValue(e,!0)}get value(){return this._valueRaw}set value(t){this.isInitialized||this.initialize(t),this.processValue(t,!1)}set defaultValue(t){this._defaultValue=t}__init(){this.processValue(this._valueRaw,!0)}processValue(t,e){if(t==null||!e&&this.testIfValueChanged(t)===!1)return;const i=this._value;nk&&typeof i=="number"&&typeof t=="number"&&(i==null||i.toFixed(4),t==null||t.toFixed(4)),!this._active&&this._defaultValue!==void 0?(this._value=this._defaultValue,t=this._defaultValue,this._valueRaw=t):(this._valueRaw=t,this._active&&this.valueProcessor&&(t=this.valueProcessor(t)),this._value=t),this.onValueChanged&&this.onValueChanged(t,i,this)}testIfValueChanged(t){return this._valueRaw!==t}}kw([p()],U.prototype,"overrideState",1);kw([p()],U.prototype,"value",1);class sk extends Hi{constructor(){super([U])}onSerialize(t,e){}onDeserialize(t,e){const i=e.target,n=e.path;let o;if(i&&n&&(o=i[n]),(typeof o!="object"||typeof o=="object"&&o.isVolumeParameter!==!0)&&(o=new U),typeof t=="object"&&"value"in t){const a=t.value;o.initialize(a),o.overrideState=t.overrideState}else o.value=t;return o}}new sk;var ok=Object.defineProperty,rk=Object.getOwnPropertyDescriptor,ak=(s,t,e,i)=>{for(var n=i>1?void 0:i?rk(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&ok(t,e,n),n};const ap=x("debugpost");class Xe extends D{constructor(e=void 0){super();r(this,"active",!0);r(this,"_manager",null);r(this,"_result");r(this,"_postprocessingContext",null);if(e)for(const i of Object.keys(e)){const n=e[i],o=this[i];o instanceof U?o.initialize(n):o!==void 0&&(this[i]=n)}}get isPostProcessingEffect(){return!0}onEnable(){super.onEnable(),ap&&console.warn("onEnable effect",this,this.__internalDidAwakeAndStart),this.__internalDidAwakeAndStart&&(this.active=!0),this.onEffectEnabled()}onDisable(){var e;super.onDisable(),ap&&console.warn("onDisable effect",this),(e=this._manager)==null||e.removeEffect(this),this.active=!1}onEffectEnabled(e){var i;e&&e.isPostProcessingManager===!0?this._manager=e:this._manager||(this._manager=ek(this)),(i=this._manager)==null||i.addEffect(this)}init(){}get postprocessingContext(){return this._postprocessingContext}apply(e){var i;return this._postprocessingContext=e,this._result||(this.initParameters(),this._result=(i=this.onCreateEffect)==null?void 0:i.call(this)),this._result&&this.initParameters(),this._result}unapply(){}dispose(){ap&&console.warn("DISPOSE",this),this._result&&(Array.isArray(this._result)?this._result.forEach(e=>e.dispose()):this._result.dispose()),this._result=void 0}initParameters(){const e=Object.keys(this);for(const i of e){const n=this[i];n instanceof U&&n.__init()}}onEditorModification(e){const i=e.propertyName;if(this[i]instanceof U){const n=e.value;return this[i].value=n,!0}}}ak([p()],Xe.prototype,"active",2);var lk=Object.defineProperty,ck=Object.getOwnPropertyDescriptor,hk=(s,t,e,i)=>{for(var n=i>1?void 0:i?ck(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&lk(t,e,n),n};const dk=x("debugpost"),_m={};function Qi(s,t){_m[s]=t}function uk(s){return s.__type in _m?_m[s.__type]:(dk&&s.__type&&console.warn("Unknown postprocessing type",s.__type,s),Xe)}class Qu{constructor(){r(this,"components",[])}__init(t){var e;(e=this.components)==null||e.forEach(i=>{i.gameObject===void 0&&t.gameObject.addComponent(i),i.init()})}addEffect(t){this.components.push(t)}removeEffect(t){const e=this.components.indexOf(t);e>=0&&this.components.splice(e,1)}}hk([yr([s=>uk(s),Xe])],Qu.prototype,"components",2);var fk=Object.defineProperty,pk=Object.getOwnPropertyDescriptor,mk=(s,t,e,i)=>{for(var n=i>1?void 0:i?pk(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&fk(t,e,n),n};class mh extends Xe{constructor(){super(...arguments);r(this,"preset",new U(2))}get typeName(){return"Antialiasing"}onCreateEffect(){const e=new exports.MODULES.POSTPROCESSING.MODULE.SMAAEffect({preset:exports.MODULES.POSTPROCESSING.MODULE.SMAAPreset.HIGH,edgeDetectionMode:exports.MODULES.POSTPROCESSING.MODULE.EdgeDetectionMode.DEPTH});return this.preset.onValueChanged=i=>{e.applyPreset(i)},e}}mk([p(U)],mh.prototype,"preset",2);Qi("Antialiasing",mh);var gk=Object.defineProperty,_k=Object.getOwnPropertyDescriptor,t_=(s,t,e,i)=>{for(var n=i>1?void 0:i?_k(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&gk(t,e,n),n},Cp;const Ew=(Cp=class extends Xe{constructor(){super(...arguments);r(this,"threshold",new U(.9));r(this,"intensity",new U(1));r(this,"scatter",new U(.3));r(this,"selectiveBloom")}get typeName(){return"Bloom"}init(){this.threshold.valueProcessor=t=>t,this.intensity.valueProcessor=t=>t,this.scatter.valueProcessor=t=>t}onCreateEffect(){let t;if(this.selectiveBloom==null&&(this.selectiveBloom=Ew.useSelectiveBloom),this.selectiveBloom){const e=t=new exports.MODULES.POSTPROCESSING.MODULE.SelectiveBloomEffect(this.context.scene,this.context.mainCamera,{blendFunction:exports.MODULES.POSTPROCESSING.MODULE.BlendFunction.ADD,mipmapBlur:!0,luminanceThreshold:this.threshold.value,luminanceSmoothing:this.scatter.value,radius:.85,intensity:this.intensity.value});e.inverted=!0}else t=new exports.MODULES.POSTPROCESSING.MODULE.BloomEffect({blendFunction:exports.MODULES.POSTPROCESSING.MODULE.BlendFunction.ADD,mipmapBlur:!0,luminanceThreshold:this.threshold.value,luminanceSmoothing:this.scatter.value,radius:.85,intensity:this.intensity.value});return this.intensity.onValueChanged=e=>{t.intensity=e},this.threshold.onValueChanged=e=>{t.luminanceMaterial.threshold=Math.pow(e,2.2)},this.scatter.onValueChanged=e=>{t.luminancePass.enabled=!0,t.luminanceMaterial.smoothing=e,t.mipmapBlurPass&&(t.mipmapBlurPass.radius=h.MathUtils.lerp(.1,.9,e))},t}},r(Cp,"useSelectiveBloom",!1),Cp);let Ir=Ew;t_([p(U)],Ir.prototype,"threshold",2);t_([p(U)],Ir.prototype,"intensity",2);t_([p(U)],Ir.prototype,"scatter",2);Qi("Bloom",Ir);var yk=Object.defineProperty,bk=Object.getOwnPropertyDescriptor,vk=(s,t,e,i)=>{for(var n=i>1?void 0:i?bk(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&yk(t,e,n),n};class gh extends Xe{constructor(){super(...arguments);r(this,"intensity",new U(0))}get typeName(){return"ChromaticAberration"}onCreateEffect(){const e=new exports.MODULES.POSTPROCESSING.MODULE.ChromaticAberrationEffect;return e.offset=new h.Vector2(0,0),e.radialModulation=!0,e.modulationOffset=.15,this.intensity.valueProcessor=i=>i*.02,this.intensity.onValueChanged=i=>{e.offset.x=-i,e.offset.y=i},e}}vk([p(U)],gh.prototype,"intensity",2);Qi("ChromaticAberration",gh);var wk=Object.defineProperty,xk=Object.getOwnPropertyDescriptor,Tw=(s,t,e,i)=>{for(var n=i>1?void 0:i?xk(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&wk(t,e,n),n};const db=x("debugpost");var Md=(s=>(s[s.None=0]="None",s[s.Neutral=1]="Neutral",s[s.ACES=2]="ACES",s[s.AgX=3]="AgX",s[s.KhronosNeutral=4]="KhronosNeutral",s))(Md||{});function lp(s){switch(s){case 0:return h.LinearToneMapping;case 1:return h.ReinhardToneMapping;case 2:return h.ACESFilmicToneMapping;case 3:return h.AgXToneMapping;case 4:return h.NeutralToneMapping;default:return h.NeutralToneMapping}}function Sk(s){switch(s){case h.LinearToneMapping:return 0;case h.ACESFilmicToneMapping:return 2;case h.AgXToneMapping:return 3;case h.NeutralToneMapping:return 1;case h.ReinhardToneMapping:return 1;default:return 0}}function ub(s){switch(s){case h.LinearToneMapping:return exports.MODULES.POSTPROCESSING.MODULE.ToneMappingMode.LINEAR;case h.ACESFilmicToneMapping:return exports.MODULES.POSTPROCESSING.MODULE.ToneMappingMode.ACES_FILMIC;case h.AgXToneMapping:return exports.MODULES.POSTPROCESSING.MODULE.ToneMappingMode.AGX;case h.NeutralToneMapping:return exports.MODULES.POSTPROCESSING.MODULE.ToneMappingMode.NEUTRAL;case h.ReinhardToneMapping:return exports.MODULES.POSTPROCESSING.MODULE.ToneMappingMode.REINHARD;default:return exports.MODULES.POSTPROCESSING.MODULE.ToneMappingMode.LINEAR}}const Aw=class extends Xe{constructor(){super(...arguments);r(this,"mode",new U(void 0));r(this,"exposure",new U(1))}get typeName(){return"ToneMapping"}setMode(t){const e=Md[t];return e===void 0?(console.error("Invalid ToneMapping mode",t),this):(this.mode.value=e,this)}get isToneMapping(){return!0}onEffectEnabled(){const t=Rw(this);t&&super.onEffectEnabled(t)}onCreateEffect(){if(this.postprocessingContext)for(const i of this.postprocessingContext.components){if(i===this)break;if(i!=this&&i instanceof Aw){console.warn("Multiple tonemapping effects found in the same postprocessing stack: Please check your scene setup.",{activeEffect:i,ignoredEffect:this});return}}if(this.mode.isInitialized==!1){const i=Sk(this.context.renderer.toneMapping);this.mode.initialize(i)}const t=lp(this.mode.value),e=new exports.MODULES.POSTPROCESSING.MODULE.ToneMappingEffect({mode:ub(t)});return this.mode.onValueChanged=i=>{const n=lp(i);e.mode=ub(n),db&&console.log("ToneMapping mode changed to",Md[i],n,e.mode)},db&&console.log("Use ToneMapping",Md[this.mode.value],t,e.mode,"renderer.tonemapping: "+this.context.renderer.toneMapping),this.exposure.onValueChanged=i=>{this.context.renderer.toneMappingExposure=i},e}onBeforeRender(){this.mode.overrideState&&(this.context.renderer.toneMapping=lp(this.mode.value)),this.exposure.overrideState&&this.exposure.value!==void 0&&(this.context.renderer.toneMappingExposure=this.exposure.value)}};let fo=Aw;Tw([p(U)],fo.prototype,"mode",2);Tw([p(U)],fo.prototype,"exposure",2);Qi("Tonemapping",fo);var Ck=Object.defineProperty,Pk=Object.getOwnPropertyDescriptor,Yu=(s,t,e,i)=>{for(var n=i>1?void 0:i?Pk(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&Ck(t,e,n),n};class Po extends Xe{constructor(){super(...arguments);r(this,"postExposure",new U(0));r(this,"contrast",new U(0));r(this,"hueShift",new U(0));r(this,"saturation",new U(0))}get typeName(){return"ColorAdjustments"}init(){this.postExposure.valueProcessor=e=>(e=Math.pow(2,e),e),this.contrast.valueProcessor=e=>{let i=1;return e>0?i=200:e<0&&(i=100),e/i},this.contrast.defaultValue=0,this.hueShift.valueProcessor=e=>Math.PI*e/180,this.hueShift.defaultValue=0,this.saturation.valueProcessor=e=>e<0?e/100:e/(100*Math.PI),this.saturation.defaultValue=0}onCreateEffect(){var a,l;const e=[];this.context.renderer.toneMapping!==h.NoToneMapping&&this.postExposure.overrideState&&(this.context.renderer.toneMapping=h.NoToneMapping);let i=(a=this.postprocessingContext)==null?void 0:a.components.find(c=>c instanceof fo);i||(i=new fo,(l=this.postprocessingContext)==null||l.components.push(i)),this.postExposure.onValueChanged=c=>{this.postExposure.overrideState&&(i.exposure.value=c)};const n=new exports.MODULES.POSTPROCESSING.MODULE.BrightnessContrastEffect;this.contrast.onValueChanged=c=>n.contrast=c;const o=new exports.MODULES.POSTPROCESSING.MODULE.HueSaturationEffect;return e.push(n),e.push(o),this.hueShift.onValueChanged=c=>o.hue=c,this.saturation.onValueChanged=c=>o.saturation=c,e}}Yu([p(U)],Po.prototype,"postExposure",2);Yu([p(U)],Po.prototype,"contrast",2);Yu([p(U)],Po.prototype,"hueShift",2);Yu([p(U)],Po.prototype,"saturation",2);Qi("ColorAdjustments",Po);var Ok=Object.defineProperty,Mk=Object.getOwnPropertyDescriptor,jr=(s,t,e,i)=>{for(var n=i>1?void 0:i?Mk(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&Ok(t,e,n),n};const Rk=x("debugpost");class yn extends Xe{constructor(){super(...arguments);r(this,"mode");r(this,"focusDistance",new U(1));r(this,"focalLength",new U(.2));r(this,"aperture",new U(20));r(this,"gaussianMaxRadius",new U);r(this,"resolutionScale",new U(1*1/window.devicePixelRatio));r(this,"bokehScale",new U)}get typeName(){return"DepthOfField"}init(){this.focalLength.valueProcessor=i=>{const n=i/300,o=2;return z.lerp(o,.01,n)};const e=20;this.aperture.valueProcessor=i=>{const n=1-i/32;return z.lerp(1,e,n)}}onCreateEffect(){if(this.mode===0){Rk&&console.warn("DepthOfField: Mode is set to Off");return}const e=new exports.MODULES.POSTPROCESSING.MODULE.DepthOfFieldEffect(this.context.mainCamera,{worldFocusRange:.2,focalLength:1,bokehScale:20,resolutionScale:this.resolutionScale.value});return this.focusDistance.onValueChanged=i=>{e.cocMaterial.worldFocusDistance=i},this.focalLength.onValueChanged=i=>e.cocMaterial.worldFocusRange=i,this.aperture.onValueChanged=i=>e.bokehScale=i,this.resolutionScale&&(this.resolutionScale.onValueChanged=i=>e.resolution.scale=i),[e]}unapply(){}}jr([p()],yn.prototype,"mode",2);jr([p(U)],yn.prototype,"focusDistance",2);jr([p(U)],yn.prototype,"focalLength",2);jr([p(U)],yn.prototype,"aperture",2);jr([p(U)],yn.prototype,"gaussianMaxRadius",2);jr([p(U)],yn.prototype,"resolutionScale",2);jr([p(U)],yn.prototype,"bokehScale",2);Qi("DepthOfField",yn);class Tc extends Xe{constructor(e){super();r(this,"effect");this.effect=e}get typeName(){return this.effect.constructor.name}onCreateEffect(){return this.effect}}var kk=Object.defineProperty,Ek=Object.getOwnPropertyDescriptor,Tk=(s,t,e,i)=>{for(var n=i>1?void 0:i?Ek(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&kk(t,e,n),n};class _h extends Xe{constructor(){super(...arguments);r(this,"granularity",new U(10))}get typeName(){return"PixelationEffect"}onCreateEffect(){const e=new exports.MODULES.POSTPROCESSING.MODULE.PixelationEffect;return this.granularity.onValueChanged=i=>{e.granularity=i},e}}Tk([p(U)],_h.prototype,"granularity",2);Qi("PixelationEffect",_h);var Ak=Object.defineProperty,Dk=Object.getOwnPropertyDescriptor,yh=(s,t,e,i)=>{for(var n=i>1?void 0:i?Dk(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&Ak(t,e,n),n};class Ms extends Xe{constructor(){super(...arguments);r(this,"intensity",new U(2));r(this,"falloff",new U(1));r(this,"samples",new U(9));r(this,"color",new U(new h.Color(0,0,0)));r(this,"luminanceInfluence",new U(.7));r(this,"_ssao")}get typeName(){return"ScreenSpaceAmbientOcclusion"}onBeforeRender(){if(this._ssao&&this.context.mainCamera instanceof h.PerspectiveCamera){const e=this.context.mainCamera.far-this.context.mainCamera.near;this._ssao.ssaoMaterial.worldDistanceFalloff=e*.01,this._ssao.ssaoMaterial.worldDistanceThreshold=this.context.mainCamera.far}}onCreateEffect(){const e=this.context.mainCamera,i=new exports.MODULES.POSTPROCESSING.MODULE.NormalPass(this.context.scene,e),n=new exports.MODULES.POSTPROCESSING.MODULE.DepthDownsamplingPass({normalBuffer:i.texture,resolutionScale:.5}),o=this._ssao=new exports.MODULES.POSTPROCESSING.MODULE.SSAOEffect(e,i.texture,{normalDepthBuffer:n.texture,worldDistanceThreshold:1,worldDistanceFalloff:1,worldProximityThreshold:.1,worldProximityFalloff:2,intensity:1,blendFunction:exports.MODULES.POSTPROCESSING.MODULE.BlendFunction.MULTIPLY,luminanceInfluence:.5});this.intensity.onValueChanged=l=>{o.intensity=l},this.falloff.onValueChanged=l=>{o.ssaoMaterial.radius=l*.1},this.samples.onValueChanged=l=>{o.ssaoMaterial.samples=l},this.color.onValueChanged=l=>{o.color||(o.color=new h.Color),o.color.copy(l)},this.luminanceInfluence.onValueChanged=l=>{o.luminanceInfluence=l};const a=new Array;return a.push(i),a.push(n),a.push(o),a}}yh([p(U)],Ms.prototype,"intensity",2);yh([p(U)],Ms.prototype,"falloff",2);yh([p(U)],Ms.prototype,"samples",2);yh([p(U)],Ms.prototype,"color",2);yh([p(U)],Ms.prototype,"luminanceInfluence",2);Qi("ScreenSpaceAmbientOcclusion",Ms);var Lk=Object.defineProperty,Ik=Object.getOwnPropertyDescriptor,Br=(s,t,e,i)=>{for(var n=i>1?void 0:i?Ik(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&Lk(t,e,n),n};const jk=x("debugN8AO");var ym=(s=>(s[s.Performance=0]="Performance",s[s.Low=1]="Low",s[s.Medium=2]="Medium",s[s.High=3]="High",s[s.Ultra=4]="Ultra",s))(ym||{});class bn extends Xe{constructor(){super(...arguments);r(this,"gammaCorrection",!0);r(this,"aoRadius",new U(1));r(this,"falloff",new U(1));r(this,"intensity",new U(1));r(this,"color",new U(new h.Color(0,0,0)));r(this,"screenspaceRadius",!1);r(this,"quality",2);r(this,"_ssao")}get typeName(){return"ScreenSpaceAmbientOcclusionN8"}get pass(){return this._ssao}onValidate(){this._ssao&&(this._ssao.setQualityMode(ym[this.quality]),this._ssao.configuration.gammaCorrection=this.gammaCorrection,this._ssao.configuration.screenSpaceRadius=this.screenspaceRadius)}onCreateEffect(){const e=this.context.mainCamera,i=this.context.domWidth,n=this.context.domHeight,o=this._ssao=new exports.MODULES.POSTPROCESSING_AO.MODULE.N8AOPostPass(this.context.scene,e,i,n),a=ym[this.quality];o.setQualityMode(a),o.configuration.transparencyAware=!1;const l=new h.WebGLRenderTarget(i,n);return o.configuration.beautyRenderTarget=l,o.configuration.autoRenderBeauty=!1,o.configuration.gammaCorrection=this.gammaCorrection,o.configuration.screenSpaceRadius=this.screenspaceRadius,jk&&(o.enableDebugMode(),console.log(o),setInterval(()=>{console.log("SSAO",o.lastTime)},1e3),setInterval(()=>{console.log("SSAO",o.enabled,{ssao:o,autoRenderBeauty:o.configuration.autoRenderBeauty})},4e3)),this.intensity.onValueChanged=c=>{o.configuration.intensity=c},this.falloff.onValueChanged=c=>{o.configuration.distanceFalloff=c},this.aoRadius.onValueChanged=c=>{o.configuration.aoRadius=c},this.color.onValueChanged=c=>{o.color||(o.color=new h.Color),o.configuration.color.copy(c)},o}}Br([Ct(),p()],bn.prototype,"gammaCorrection",2);Br([p(U)],bn.prototype,"aoRadius",2);Br([p(U)],bn.prototype,"falloff",2);Br([p(U)],bn.prototype,"intensity",2);Br([p(U)],bn.prototype,"color",2);Br([Ct(),p()],bn.prototype,"screenspaceRadius",2);Br([Ct(),p()],bn.prototype,"quality",2);Qi("ScreenSpaceAmbientOcclusionN8",bn);var Bk=Object.defineProperty,Fk=Object.getOwnPropertyDescriptor,Dw=(s,t,e,i)=>{for(var n=i>1?void 0:i?Fk(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&Bk(t,e,n),n};class bh extends Xe{constructor(){super(...arguments);r(this,"_effect");r(this,"_amount",1);r(this,"_radius",1)}get typeName(){return"Sharpening"}onCreateEffect(){return this._effect??(this._effect=new(Uk())),this.effect}get effect(){return this._effect}set amount(e){this._amount=e,this._effect&&(this._effect.uniforms.get("amount").value=e)}get amount(){return this._effect?this._effect.uniforms.get("amount").value:this._amount}set radius(e){this._radius=e,this._effect&&(this._effect.uniforms.get("radius").value=e)}get radius(){return this._effect?this._effect.uniforms.get("radius").value:this._radius}}Dw([p()],bh.prototype,"amount",1);Dw([p()],bh.prototype,"radius",1);function Uk(){const s=`
      void mainSupport() {
        vUv = uv;
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
      }
    `,t=`
    uniform sampler2D tDiffuse;
    uniform float amount;
    uniform float radius;
    
    void mainImage(const in vec4 inputColor, const in vec2 uv, out vec4 outputColor) {
        float tx = 1.0 / resolution.x;
        float ty = 1.0 / resolution.y;
        vec2 texelSize = vec2(tx, ty);
    
        vec4 blurred = vec4(0.0);
        float total = 0.0;
    
        for (float x = -radius; x <= radius; x++) {
            for (float y = -radius; y <= radius; y++) {
                vec2 offset = vec2(x, y) * texelSize;
                vec4 diffuse = texture2D(tDiffuse, uv + offset);
                float weight = exp(-length(offset) * amount);
                blurred += diffuse * weight;
                total += weight;
            }
        }
    
        if (total > 0.0) {
            blurred /= total;
        }
    
        // Calculate the sharpened color using inputColor
        vec4 sharp = inputColor + clamp(inputColor - blurred, 0.0, 1.0) * amount;
        // Keep original alpha
        sharp.a = inputColor.a;
    
        // Ensure the sharp color does not go below 0 or above 1
        // This means: sharpening must happen AFTER tonemapping.
        sharp = clamp(sharp, 0.0, 1.0);
    
        outputColor = sharp;
    }
    
    `;class e extends exports.MODULES.POSTPROCESSING.MODULE.Effect{constructor(){super("Sharpening",t,{vertexShader:s,blendFunction:exports.MODULES.POSTPROCESSING.MODULE.BlendFunction.NORMAL,uniforms:new Map([["amount",new h.Uniform$1(1)],["radius",new h.Uniform$1(1)]])})}}return e}var zk=Object.defineProperty,Nk=Object.getOwnPropertyDescriptor,rl=(s,t,e,i)=>{for(var n=i>1?void 0:i?Nk(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&zk(t,e,n),n};class Hn extends Xe{constructor(){super(...arguments);r(this,"offset",new U(0));r(this,"rotation",new U(0));r(this,"focusArea",new U(.4));r(this,"feather",new U(.3));r(this,"kernelSize",new U(2));r(this,"resolutionScale",new U(1/window.devicePixelRatio))}get typeName(){return"TiltShiftEffect"}init(){this.offset.defaultValue=0,this.rotation.defaultValue=0,this.focusArea.defaultValue=.4,this.feather.defaultValue=.3,this.kernelSize.defaultValue=exports.MODULES.POSTPROCESSING.MODULE.KernelSize.MEDIUM,this.resolutionScale.defaultValue=1/window.devicePixelRatio}onCreateEffect(){const e=new exports.MODULES.POSTPROCESSING.MODULE.TiltShiftEffect({kernelSize:exports.MODULES.POSTPROCESSING.MODULE.KernelSize.VERY_LARGE,offset:this.offset.value,rotation:this.rotation.value,focusArea:this.focusArea.value,feather:this.feather.value});return this.offset.onValueChanged=i=>e.offset=i,this.rotation.onValueChanged=i=>e.rotation=i,this.focusArea.onValueChanged=i=>e.focusArea=i,this.feather.onValueChanged=i=>e.feather=i,this.kernelSize.onValueChanged=i=>e.blurPass.kernelSize=i,this.resolutionScale.onValueChanged=i=>e.resolution.scale=i/window.devicePixelRatio,e}}rl([p(U)],Hn.prototype,"offset",2);rl([p(U)],Hn.prototype,"rotation",2);rl([p(U)],Hn.prototype,"focusArea",2);rl([p(U)],Hn.prototype,"feather",2);rl([p(U)],Hn.prototype,"kernelSize",2);rl([p(U)],Hn.prototype,"resolutionScale",2);Qi("TiltShiftEffect",Hn);var Vk=Object.defineProperty,$k=Object.getOwnPropertyDescriptor,i_=(s,t,e,i)=>{for(var n=i>1?void 0:i?$k(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&Vk(t,e,n),n};class Fr extends Xe{constructor(){super(...arguments);r(this,"color",new U({r:0,g:0,b:0,a:1}));r(this,"intensity",new U(0));r(this,"center",new U({x:.5,y:.5}))}get typeName(){return"Vignette"}init(){this.color.defaultValue={r:0,g:0,b:0,a:1},this.intensity.defaultValue=0,this.center.defaultValue={x:.5,y:.5}}onCreateEffect(){const e=new exports.MODULES.POSTPROCESSING.MODULE.VignetteEffect;return this.intensity.onValueChanged=i=>{e.offset=i,this.updateDarkness(e)},this.color.onValueChanged=i=>{this.updateDarkness(e)},e}updateDarkness(e){const i=this.intensity.value;e.darkness=i}}i_([p(U)],Fr.prototype,"color",2);i_([p(U)],Fr.prototype,"intensity",2);i_([p(U)],Fr.prototype,"center",2);Qi("Vignette",Fr);globalThis.false=globalThis.false!==void 0?globalThis.false:!0;const Kn=x("debugpost"),Wk=x("debugpostpasses"),cp=Symbol("needle:postprocessing-handler"),hp=Symbol("needle:previous-autoclear-state");class n_{constructor(t){r(this,"_composer",null);r(this,"_lastVolumeComponents");r(this,"_effects",[]);r(this,"_isActive",!1);r(this,"context");r(this,"_menuEntry",null);r(this,"_passIndices",null);this.context=t}get isActive(){return this._isActive}get composer(){return this._composer}apply(t){return"env"in{url:typeof document>"u"?require("url").pathToFileURL(__filename).href:_a&&_a.tagName.toUpperCase()==="SCRIPT"&&_a.src||new URL("needle-engine.bundle.light.umd.cjs",document.baseURI).href}&&{}.VITE_NEEDLE_USE_POSTPROCESSING==="false"?(Kn?console.warn("Postprocessing is disabled via vite env setting"):console.debug("Postprocessing is disabled via vite env setting"),Promise.resolve()):(Kn?console.warn("Postprocessing is disabled via global vite define setting"):console.debug("Postprocessing is disabled via vite define"),Promise.resolve())}unapply(){var i;if(Kn&&console.log("Unapplying postprocessing effects"),this._isActive=!1,this._lastVolumeComponents){for(const n of this._lastVolumeComponents)n.unapply();this._lastVolumeComponents.length=0}const t=this.context;t[cp]===this&&delete t[cp],t.composer===this._composer&&((i=t.composer)==null||i.dispose(),t.composer=null),typeof t.renderer[hp]=="boolean"&&(t.renderer.autoClear=t.renderer[hp])}dispose(){this.unapply();for(const t of this._effects)t.dispose();this._effects.length=0,this._composer=null}async onApply(t,e){if(!e)return;await Promise.all([exports.MODULES.POSTPROCESSING.load(),exports.MODULES.POSTPROCESSING_AO.load()]),t[cp]=this,Kn&&console.log("Apply Postprocessing Effects",e),this._lastVolumeComponents=[...e],this._effects.length=0;const i={handler:this,components:this._lastVolumeComponents};for(let n=0;n<this._lastVolumeComponents.length;n++){const o=this._lastVolumeComponents[n];if(o.context=t,o.apply){if(o.active){if(!t.mainCameraComponent){console.error("No camera in scene found or available yet - can not create postprocessing effects");return}const a=o.apply(i);if(!a)continue;Array.isArray(a)?this._effects.push(...a):this._effects.push(a)}}else o.active&&pe("Volume component is not a VolumeComponent: "+o.__type)}if(this.context.renderer.toneMapping!=h.NoToneMapping&&!this._effects.find(n=>n instanceof exports.MODULES.POSTPROCESSING.MODULE.ToneMappingEffect)){const n=new exports.MODULES.POSTPROCESSING.MODULE.ToneMappingEffect;this._effects.push(n)}this.applyEffects(t)}applyEffects(t){const e=this._effects;if(e.length<=0)return;const i=t.mainCameraComponent,n=t.renderer,o=t.scene,a=i.threeCamera;n[hp]=n.autoClear,this._composer||(this._composer=new exports.MODULES.POSTPROCESSING.MODULE.EffectComposer(n,{frameBufferType:h.HalfFloatType,stencilBuffer:!0})),t.composer&&t.composer!==this._composer&&console.warn("There's already an active EffectComposer in your scene: replacing it with a new one. This might cause unexpected behaviour. Make sure to only use one PostprocessingManager/Volume in your scene."),t.composer=this._composer;const l=t.composer;l.setMainCamera(a),l.setRenderer(n),l.setMainScene(o);for(const d of l.passes)d.dispose();l.removeAllPasses();const c=new exports.MODULES.POSTPROCESSING.MODULE.RenderPass(o,a);if(c.name="Render To Screen",c.mainScene=o,l.addPass(c),Wk){this.orderEffects();for(const d of e)if(d instanceof exports.MODULES.POSTPROCESSING.MODULE.Effect){const u=new exports.MODULES.POSTPROCESSING.MODULE.EffectPass(a,d);u.name=d.name,l.addPass(u)}else d instanceof exports.MODULES.POSTPROCESSING.MODULE.Pass,l.addPass(d)}else try{this.orderEffects();const d=[];for(const u of e)u instanceof exports.MODULES.POSTPROCESSING.MODULE.Effect?d.push(u):(u instanceof exports.MODULES.POSTPROCESSING.MODULE.Pass,l.addPass(u));if(d.length>0){const u=new exports.MODULES.POSTPROCESSING.MODULE.EffectPass(a,...d);u.name=d.map(f=>f.name).join(" "),u.mainScene=o,u.enabled=!0,l.addPass(u)}}catch(d){console.error("Error while applying postprocessing effects",d),l.removeAllPasses()}if(Kn){console.log("[PostProcessing] Passes →",l.passes);const d=new exports.MODULES.POSTPROCESSING.MODULE.DepthEffect({blendFunction:exports.MODULES.POSTPROCESSING.MODULE.BlendFunction.NORMAL,inverted:!0});d.name="Depth Effect";const u=new exports.MODULES.POSTPROCESSING.MODULE.EffectPass(a,d);if(u.name="Depth Effect Pass",u.enabled=!1,l.passes.push(u),this._passIndices!==null){const m=[l.passes[0]];this._passIndices.length>0&&m.push(...this._passIndices.filter(g=>g!==0).map(g=>l.passes[g]).filter(g=>g)),m.length>0&&console.log("[PostProcessing] Passes (selected) →",m),l.passes.length=0;for(const g of m)g.enabled=!0,g.renderToScreen=!1,l.addPass(g)}const f=this.context.menu;if(f&&this._passIndices===null){this._menuEntry&&this._menuEntry.remove();const m=document.createElement("select");m.multiple=!0;const g=document.createElement("option");g.innerText="Final Output",g.value="-1",m.appendChild(g);for(const _ of l.passes){const y=document.createElement("option");y.innerText=_.name,y.value=`${l.passes.indexOf(_)}`,y.title=_.name,m.appendChild(y)}f.appendChild(m),this._menuEntry=m,m.addEventListener("change",()=>{const _=Array.from(m.selectedOptions).map(y=>parseInt(y.value));_.length===1&&_[0]===-1?this._passIndices=null:this._passIndices=_,this.applyEffects(t)})}}}orderEffects(){var e;Kn&&console.log("Before ordering effects",[...this._effects]),dp??(dp=[exports.MODULES.POSTPROCESSING.MODULE.NormalPass,exports.MODULES.POSTPROCESSING.MODULE.DepthDownsamplingPass,exports.MODULES.POSTPROCESSING.MODULE.SMAAEffect,exports.MODULES.POSTPROCESSING.MODULE.SSAOEffect,exports.MODULES.POSTPROCESSING_AO.MODULE.N8AOPostPass,exports.MODULES.POSTPROCESSING.MODULE.TiltShiftEffect,exports.MODULES.POSTPROCESSING.MODULE.DepthOfFieldEffect,exports.MODULES.POSTPROCESSING.MODULE.ChromaticAberrationEffect,exports.MODULES.POSTPROCESSING.MODULE.BloomEffect,exports.MODULES.POSTPROCESSING.MODULE.SelectiveBloomEffect,exports.MODULES.POSTPROCESSING.MODULE.VignetteEffect,exports.MODULES.POSTPROCESSING.MODULE.PixelationEffect,exports.MODULES.POSTPROCESSING.MODULE.ToneMappingEffect,exports.MODULES.POSTPROCESSING.MODULE.HueSaturationEffect,exports.MODULES.POSTPROCESSING.MODULE.BrightnessContrastEffect]);const t=this._effects;t.sort((i,n)=>{const o=dp.findIndex(l=>i.constructor.name.endsWith(l.name)),a=dp.findIndex(l=>n.constructor.name.endsWith(l.name));return o<0?(Kn&&console.warn("Unknown effect found: ",i.constructor.name),-1):a<0?(Kn&&console.warn("Unknown effect found: ",n.constructor.name),1):o<0?1:a<0?-1:o-a}),Kn&&console.log("After ordering effects",[...this._effects]);for(let i=0;i<t.length;i++){const n=t[i];if(((e=n==null?void 0:n.configuration)==null?void 0:e.gammaCorrection)!==void 0){const o=i===t.length-1;n.configuration.gammaCorrection=o}}}}let dp=null;var Gk=Object.defineProperty,Hk=Object.getOwnPropertyDescriptor,Lw=(s,t,e,i)=>{for(var n=i>1?void 0:i?Hk(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&Gk(t,e,n),n};const Qr=x("debugpost");class al extends D{constructor(){super(...arguments);r(this,"sharedProfile");r(this,"multisampling","auto");r(this,"_postprocessing");r(this,"_activeEffects",[]);r(this,"_effects",[]);r(this,"_componentEnabledTime",-1);r(this,"_multisampleAutoChangeTime",0);r(this,"_multisampleAutoDecreaseTime",0);r(this,"_lastApplyTime");r(this,"_rapidApplyCount",0);r(this,"_isDirty",!1);r(this,"_modificationQueue");r(this,"_recreateId",-1)}get isPostProcessingManager(){return!0}get effects(){return this._activeEffects}addEffect(e){let i=e;return i instanceof Xe||(i=new Tc(i)),i.gameObject===void 0&&this.gameObject.addComponent(i),this._effects.includes(i)||(this._effects.push(i),this._isDirty=!0),e}removeEffect(e){var n,o,a,l;let i=-1;if(e instanceof Xe?i=this._effects.indexOf(e):i=this._effects.findIndex(c=>c instanceof Tc&&c.effect===e),i!==-1)return this._effects.splice(i,1),this._isDirty=!0,e;if(e instanceof Xe){const c=(o=(n=this.sharedProfile)==null?void 0:n.components)==null?void 0:o.indexOf(e);c!==void 0&&c!==-1&&(this._isDirty=!0,(l=(a=this.sharedProfile)==null?void 0:a.components)==null||l.splice(c,1))}return e}markDirty(){this._isDirty=!0}awake(){var e;Qr&&(console.log("PostprocessingManager Awake",this),console.log("Press P to toggle post processing"),window.addEventListener("keydown",i=>{i.key==="p"&&(this.enabled=!this.enabled,Te("Toggle PostProcessing "+this.name+": Enabled="+this.enabled),this.markDirty())})),(e=this.sharedProfile)==null||e.__init(this)}onEnable(){this._componentEnabledTime=this.context.time.realtimeSinceStartup,this._isDirty=!0}onDisable(){var e;(e=this._postprocessing)==null||e.unapply(),this._isDirty=!1}onBeforeRender(){if(!this.context.isInXR&&(this.context.mainCamera&&this._isDirty&&this.apply(),this.context.composer&&this._postprocessing&&this._postprocessing.composer===this.context.composer)){this.context.renderer.getContext().isContextLost()&&this.context.renderer.forceContextRestore(),this.context.composer.getRenderer()!==this.context.renderer&&this.context.composer.setRenderer(this.context.renderer),this.context.composer.setMainScene(this.context.scene);const e=this.context.composer;if(this.multisampling==="auto"){const i=this.context.time.realtimeSinceStartup-this._multisampleAutoChangeTime;if(this.context.time.realtimeSinceStartup-this._componentEnabledTime>2&&i>.5){const n=e.multisampling;e.multisampling>0&&this.context.time.smoothedFps<=50?(this._multisampleAutoChangeTime=this.context.time.realtimeSinceStartup,this._multisampleAutoDecreaseTime=this.context.time.realtimeSinceStartup,e.multisampling*=.5,e.multisampling=Math.floor(e.multisampling),Qr&&console.debug(`[PostProcessing] Reduced multisampling from ${n} to ${e.multisampling}`)):i>1&&this.context.time.smoothedFps>=59&&e.multisampling<this.context.renderer.capabilities.maxSamples&&this.context.time.realtimeSinceStartup-this._multisampleAutoDecreaseTime>10&&(this._multisampleAutoChangeTime=this.context.time.realtimeSinceStartup,e.multisampling=e.multisampling<=0?1:e.multisampling*2,e.multisampling=Math.floor(e.multisampling),Qr&&console.debug(`[PostProcessing] Increased multisampling from ${n} to ${e.multisampling}`))}}else e.multisampling=Math.max(0,Math.min(this.multisampling,this.context.renderer.capabilities.maxSamples));if(this.context.mainCamera){const i=this.context.composer.passes;for(const n of i)if(n.mainCamera&&n.mainCamera!==this.context.mainCamera){this.context.composer.setMainCamera(this.context.mainCamera);break}}}}onDestroy(){var e;(e=this._postprocessing)==null||e.dispose()}apply(){var e,i;if(Qr&&console.log(`Apply PostProcessing "${this.name}"`),B()&&(this._lastApplyTime!==void 0&&Date.now()-this._lastApplyTime<100&&(this._rapidApplyCount++,this._rapidApplyCount===5&&console.warn("Detected rapid post processing modifications - this might be a bug",this)),this._lastApplyTime=Date.now()),this._isDirty=!1,this.unapply(),this._activeEffects.length=0,(e=this.sharedProfile)!=null&&e.components){const n=this.sharedProfile.components;for(const o of n)o.active&&o.enabled&&!this._activeEffects.includes(o)&&this._activeEffects.push(o)}for(const n of this._effects)n.active&&n.enabled&&!this._activeEffects.includes(n)&&this._activeEffects.push(n);this._activeEffects.length>0&&(this._postprocessing||(this._postprocessing=new n_(this.context)),(i=this._postprocessing.apply(this._activeEffects))==null||i.then(()=>{var o;if(!this.activeAndEnabled)return;this._applyPostQueue();const n=(o=this._postprocessing)==null?void 0:o.composer;n?(this.multisampling==="auto"?n.multisampling=exports.DeviceUtilities.isMobileDevice()?2:4:n.multisampling=Math.max(0,Math.min(this.multisampling,this.context.renderer.capabilities.maxSamples)),Qr&&console.debug(`[PostProcessing] Set multisampling to ${n.multisampling} (Is Mobile: ${exports.DeviceUtilities.isMobileDevice()})`)):Qr&&console.warn("[PostProcessing] No composer found")}))}unapply(){var e;(e=this._postprocessing)==null||e.unapply()}_applyPostQueue(){if(this._modificationQueue){for(const e of this._modificationQueue.values())this.onEditorModification(e);this._modificationQueue.clear()}}onEditorModification(e){var i,n;if(e.propertyName.startsWith("postprocessing.")){if(!this._postprocessing)return this._modificationQueue||(this._modificationQueue=new Map),this._modificationQueue.set(e.propertyName,e),!0;if(!((i=this._activeEffects)!=null&&i.length))return;const o=e.propertyName.split(".");if(o.length===3||o.length===4){const a=o[1],l=o[2];for(const c of this._activeEffects)if(((n=c.typeName)==null?void 0:n.toLowerCase())===a.toLowerCase()){if(l==="active"){c.active=e.value,this.scheduleRecreate();return}if(!nd.has(a)){const d=new Array;nd.set(a,d);const u=Object.keys(c);for(const f of u)c[f]instanceof U&&d.push(f)}if(nd.has(a)){const d=l.toLowerCase(),u=nd.get(a);for(const f of u)if(f.toLowerCase()===d){const m=c[f];m instanceof U&&(o.length===4&&o[3]==="active"?(m.overrideState=e.value,this.scheduleRecreate()):m&&m.value!==void 0&&(m.value=e.value));return}}console.warn("Unknown modification",l);return}}return!0}return!1}scheduleRecreate(){const e=++this._recreateId;setTimeout(()=>{e===this._recreateId&&(this.onDisable(),this.onEnable())},200)}}Lw([yr(Qu)],al.prototype,"sharedProfile",2);Lw([yr()],al.prototype,"multisampling",2);const nd=new Map;JR(al);async function s_(s){const{NeedleEngineHTMLElement:t}=await Promise.resolve().then(()=>LT);t.observedAttributes.includes(s)||t.observedAttributes.push(s)}var qk=Object.defineProperty,Xk=Object.getOwnPropertyDescriptor,ut=(s,t,e,i)=>{for(var n=i>1?void 0:i?Xk(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&qk(t,e,n),n};const Vt=x("debugsceneswitcher"),Qk=x("sceneswitcher:clearscene"),Rd="scene";s_(Rd);const Fs=Promise.resolve(!1);class He extends D{constructor(){super(...arguments);r(this,"autoLoadFirstScene",!0);r(this,"scenes",[]);r(this,"loadingScene");r(this,"queryParameterName","scene");r(this,"useSceneName",!0);r(this,"clamp",!0);r(this,"useHistory",!0);r(this,"useKeyboard",!0);r(this,"useSwipe",!0);r(this,"useSceneLighting",!0);r(this,"useSceneBackground",!0);r(this,"preloadNext",1);r(this,"preloadPrevious",1);r(this,"preloadConcurrent",2);r(this,"createMenuButtons",!1);r(this,"sceneLoadingStart",new ge);r(this,"sceneLoadingProgress",new ge);r(this,"sceneLoaded",new ge);r(this,"_currentIndex",-1);r(this,"_currentScene");r(this,"_engineElementOverserver");r(this,"_preloadScheduler");r(this,"_menuButtons");r(this,"onPopState",async e=>{if(!this.useHistory)return;const i=this.useHistory;try{this.useHistory=!1;let n=!1;if(this.queryParameterName&&(n=await this.tryLoadFromQueryParam()),!n){const o=e==null?void 0:e.state;if(o&&o.startsWith(this.guid)){const a=o.substr(this.guid.length+2);Vt&&console.log("PopState",a),await this.trySelectSceneFromValue(a)}}}finally{this.useHistory=i}});r(this,"normalizedSwipeThresholdX",.1);r(this,"_didSwipe",!1);r(this,"onInputPointerMove",e=>{if(this.useSwipe&&!this._didSwipe&&e.button===0&&e.pointerType==="touch"&&this.context.input.getPointerPressedCount()===1){const i=this.context.input.getPointerPositionDelta(e.button);if(i){const n=i.x/this.context.domWidth;n>=this.normalizedSwipeThresholdX?(this._didSwipe=!0,this.selectPrev()):n<=-this.normalizedSwipeThresholdX&&(this._didSwipe=!0,this.selectNext())}}});r(this,"onInputPointerUp",e=>{e.button===0&&(this._didSwipe=!1)});r(this,"onInputKeyDown",e=>{if(!this.useKeyboard||!this.scenes)return;const i=e.key.toLowerCase();if(!i)return;const n=parseInt(i)-1;if(n>=0){this.trySelectSceneFromValue(n);return}switch(i){case"arrowright":case"d":this.selectNext();break;case"arrowleft":case"a":this.selectPrev();break}});r(this,"__lastSwitchScene");r(this,"__lastSwitchScenePromise");r(this,"_currentlyLoadingScene");r(this,"_lastLoadingScene");r(this,"_loadingScenePromise");r(this,"_isCurrentlyLoading",!1);r(this,"_currentLoadingProgress")}get currentIndex(){return this._currentIndex}get currentLoadingProgress(){return this._currentLoadingProgress}get currentlyLoadingScene(){return this._currentlyLoadingScene}get currentlyLoadedScene(){return this._currentScene}awake(){this.scenes===void 0&&(this.scenes=[]);for(const e of this.scenes)e&&!e.hasUrl&&e.asset instanceof h.Object3D&&e.asset.removeFromParent();Vt&&console.log("SceneSwitcher",this)}async onEnable(){if(globalThis.addEventListener("popstate",this.onPopState),this.context.input.addEventListener(ke.KeyDown,this.onInputKeyDown),this.context.input.addEventListener(ke.PointerMove,this.onInputPointerMove),this.context.input.addEventListener(ke.PointerUp,this.onInputPointerUp),this._engineElementOverserver||(this._engineElementOverserver=new MutationObserver(e=>{for(const i of e)if(i.type==="attributes"&&i.attributeName===Rd){const n=this.context.domElement.getAttribute(Rd);n!==null&&this.trySelectSceneFromValue(n)}})),this._engineElementOverserver.observe(this.context.domElement,{attributes:!0}),this._preloadScheduler||(this._preloadScheduler=new Yk(this)),this._preloadScheduler.maxLoadAhead=this.preloadNext,this._preloadScheduler.maxLoadBehind=this.preloadPrevious,this._preloadScheduler.maxConcurrent=this.preloadConcurrent,this._preloadScheduler.begin(2e3),this.autoLoadFirstScene&&this._currentIndex===-1&&!await this.tryLoadFromQueryParam()){const e=this.context.domElement.getAttribute(Rd);try{(e===null||!await this.trySelectSceneFromValue(e))&&this._currentIndex===-1&&this.select(0)}finally{}}this.createMenuButtons&&(this._menuButtons??(this._menuButtons=[]),this._menuButtons.push(this.context.menu.appendChild({label:"Previous",icon:"arrow_back_ios",onClick:()=>this.selectPrev(),priority:-1005,class:"row2"})),this._menuButtons.push(this.context.menu.appendChild({label:"Next",icon:"arrow_forward_ios",iconSide:"right",onClick:()=>this.selectNext(),priority:-1e3,class:"row2"})))}onDisable(){var e;if(globalThis.removeEventListener("popstate",this.onPopState),this.context.input.removeEventListener(ke.KeyDown,this.onInputKeyDown),this.context.input.removeEventListener(ke.PointerMove,this.onInputPointerMove),this.context.input.removeEventListener(ke.PointerUp,this.onInputPointerUp),(e=this._preloadScheduler)==null||e.stop(),this._menuButtons){for(const i of this._menuButtons)i.remove();this._menuButtons=void 0}}addScene(e){if(typeof e=="string"){let i=this.context.addressables.findAssetReference(e);return i||(i=new ee(e),this.context.addressables.registerAssetReference(i)),this.scenes.push(i),i}return this.scenes.push(e),e}selectNext(){return this.select(this._currentIndex+1)}selectPrev(){return this.select(this._currentIndex-1)}select(e){var n,o,a;if(Vt&&console.log("select",e),typeof e=="object"&&console.warn('Switching to "'+e+'" might not work. Please either use an index or a AssetReference (not a scene reference)'),typeof e=="string"){const l=(n=this.scenes)==null?void 0:n.find(c=>c.url===e);if(!l){const c=ee.getOrCreate(this.sourceId??"",e,this.context);return this.switchScene(c)}if(l)e=(o=this.scenes)==null?void 0:o.indexOf(l);else return Fs}if(!((a=this.scenes)!=null&&a.length))return Fs;if(e<0){if(this.clamp)return Fs;e=this.scenes.length-1}else if(e>=this.scenes.length){if(this.clamp)return Fs;e=0}const i=this.scenes[e];return this.switchScene(i)}unload(){return this.__lastSwitchScene=void 0,this.__lastSwitchScenePromise=void 0,this.__unloadCurrentScene()}async reload(){if(this.__lastSwitchScene){const e=this.__lastSwitchScene;return this.__lastSwitchScene=void 0,this.switchScene(e)}return!1}async switchScene(e){if(!(e instanceof ee)){const n=typeof e;return n==="string"?this.select(e):n==="number"?this.select(e):(console.warn("SceneSwitcher: Can't switch to scene",e,"of type",n),!1)}return e.url===this.sourceId?(console.warn("SceneSwitcher: can't load own scene - prevent recursive loading",this.sourceId),!1):this.__lastSwitchScene===e&&this.__lastSwitchScenePromise?this.__lastSwitchScenePromise:(this.__lastSwitchScene=e,this.__lastSwitchScenePromise=this.__internalSwitchScene(e),await this.__lastSwitchScenePromise)}async __unloadCurrentScene(){const e=this._currentScene;if(this._currentScene=void 0,e){Vt&&console.log("UNLOAD",e.url,"HasURL?: "+e.hasUrl);const i=this.tryGetSceneEventListener(e.asset);if(i!=null&&i.sceneClosing){const n=i.sceneClosing();n instanceof Promise&&await n}e.hasUrl?e.unload():e.asset instanceof h.Object3D&&e.asset.removeFromParent()}}async __internalSwitchScene(e){var n,o,a,l,c;await this.__unloadCurrentScene();const i=this._currentIndex=((n=this.scenes)==null?void 0:n.indexOf(e))??-1;try{this._currentlyLoadingScene=e,this._currentLoadingProgress=new ProgressEvent("progress",{loaded:0,total:1});const d=new CustomEvent("loadscene-start",{detail:{scene:e,switcher:this,index:i}});this.dispatchEvent(d),(o=this.sceneLoadingStart)==null||o.invoke(d.detail),await this.onStartLoading(),await e.loadAssetAsync((f,m)=>{var g;this._currentLoadingProgress=m,this.dispatchEvent(m),(g=this.sceneLoadingProgress)==null||g.invoke(m)}).catch(console.error),await this.onEndLoading();const u=new CustomEvent("loadscene-finished",{detail:{scene:e,switcher:this,index:i}});if(this.dispatchEvent(u),this._currentLoadingProgress=void 0,this._currentlyLoadingScene=void 0,u.defaultPrevented)return Vt&&console.warn("Adding loaded scene prevented:",e,u),!1;if(!e.asset)return Vt&&console.warn("Failed loading scene:",e),!1;if(this._currentIndex===i){if(Vt&&console.log("ADD",e.url),this._currentScene=e,Qk){const g=((a=this.context.mainCameraComponent)==null?void 0:a.gameObject)||this.context.mainCamera;g==null||g.removeFromParent();const _=this.gameObject.removeFromParent();Si(this.context.scene,!0,!0),this.context.scene=new h.Scene,this.context.scene.add(_),g&&this.context.scene.add(g)}if(S.add(e.asset,this.gameObject),this.useSceneLighting&&this.context.sceneLighting.enable(e),this.useSceneBackground){const g=this.context.lightmaps.tryGetSkybox(e.url);g?(g.mapping=h.EquirectangularReflectionMapping,this.context.scene.background=g):Vt&&console.warn("SceneSwitcher: Can't find skybox for scene "+e.url)}if(this.useHistory&&i>=0){let g=i.toString();if(this.useSceneName&&(g=fb(e.url)),(l=this.queryParameterName)!=null&&l.length)wc(this.queryParameterName,g,this.useHistory);else{const _=history.state,y=this.guid+"::"+i;_!==y&&history.pushState(y,"unused",location.href)}}const f=this.tryGetSceneEventListener(e.asset);if(f!=null&&f.sceneOpened){const g=f.sceneOpened(this);g instanceof Promise&&await g}const m=new CustomEvent("scene-opened",{detail:{scene:e,switcher:this,index:i}});return this.dispatchEvent(m),(c=this.sceneLoaded)==null||c.invoke(this),!0}}catch(d){console.error(d)}return!1}preload(e){if(e>=0&&e<this.scenes.length){const i=this.scenes[e];if(i instanceof ee)return i.preload()}return Fs}tryLoadFromQueryParam(){var i;if(!((i=this.queryParameterName)!=null&&i.length))return Fs;const e=x(this.queryParameterName);return typeof e=="boolean"?Fs:this.trySelectSceneFromValue(e)}trySelectSceneFromValue(e){if(typeof e=="string"){const i=parseInt(e);if(i>=0&&i<this.scenes.length)return this.select(i);{const n=e.toLowerCase();for(let o=0;o<this.scenes.length;o++){const a=this.scenes[o];if(a&&fb(a.url).toLowerCase().includes(n))return this.select(o)}}}else if(typeof e=="number"&&e>=0&&e<this.scenes.length)return this.select(e);return Ht()&&console.warn('Can not find scene: "'+e+'"',this),Fs}async onStartLoading(){var e,i;if(this._isCurrentlyLoading=!0,this.loadingScene&&(this._lastLoadingScene!==this.loadingScene&&(this._loadingScenePromise=void 0),this._lastLoadingScene=this.loadingScene,this._loadingScenePromise||(this._loadingScenePromise=(e=this.loadingScene)==null?void 0:e.loadAssetAsync().then(n=>n!=null)),await this._loadingScenePromise,this._isCurrentlyLoading&&((i=this.loadingScene)!=null&&i.asset))){Vt&&console.log("Add loading scene",this.loadingScene.url,this.loadingScene.asset);const n=this.loadingScene.asset;S.add(n,this.gameObject);const o=this.tryGetSceneEventListener(n);if(o!=null&&o.sceneOpened){const a=o.sceneOpened(this);a instanceof Promise&&await a}}if(this._isCurrentlyLoading){const n=this.tryGetSceneEventListener(this.gameObject);if(n&&n.sceneOpened){const o=n.sceneOpened(this);o instanceof Promise&&await o}}}async onEndLoading(){var e;if(this._isCurrentlyLoading=!1,(e=this.loadingScene)!=null&&e.asset){Vt&&console.log("Remove loading scene",this.loadingScene.url);const i=this.loadingScene.asset,n=this.tryGetSceneEventListener(i);if(typeof(n==null?void 0:n.sceneClosing)=="function"){const o=n.sceneClosing();o instanceof Promise&&await o}S.remove(i)}if(!this._isCurrentlyLoading){const i=this.tryGetSceneEventListener(this.gameObject);if(i&&i.sceneClosing){const n=i.sceneClosing();n instanceof Promise&&await n}}}tryGetSceneEventListener(e,i=0){if(!e)return null;const n=S.foreachComponent(e,o=>{const a=o;if(a.sceneClosing||a.sceneOpened)return a});if(i===0&&!n&&e.children.length)for(const o of e.children){const a=this.tryGetSceneEventListener(o,i+1);if(a)return a}return n||null}}ut([p()],He.prototype,"autoLoadFirstScene",2);ut([p(ee)],He.prototype,"scenes",2);ut([p(ee)],He.prototype,"loadingScene",2);ut([p()],He.prototype,"queryParameterName",2);ut([p()],He.prototype,"useSceneName",2);ut([p()],He.prototype,"clamp",2);ut([p()],He.prototype,"useHistory",2);ut([p()],He.prototype,"useKeyboard",2);ut([p()],He.prototype,"useSwipe",2);ut([p()],He.prototype,"useSceneLighting",2);ut([p()],He.prototype,"useSceneBackground",2);ut([p()],He.prototype,"preloadNext",2);ut([p()],He.prototype,"preloadPrevious",2);ut([p()],He.prototype,"preloadConcurrent",2);ut([p()],He.prototype,"createMenuButtons",2);ut([p(ge)],He.prototype,"sceneLoadingStart",2);ut([p(ge)],He.prototype,"sceneLoadingProgress",2);ut([p(ge)],He.prototype,"sceneLoaded",2);function fb(s){const t=s.split("/").pop(),e=t==null?void 0:t.split(".").shift();return e!=null&&e.length?e:s}class Yk{constructor(t,e=1,i=1,n=2){r(this,"maxLoadAhead");r(this,"maxLoadBehind");r(this,"maxConcurrent");r(this,"_isRunning",!1);r(this,"_switcher");r(this,"_loadTasks",[]);r(this,"_maxConcurrentLoads",1);this._switcher=t,this.maxLoadAhead=e,this.maxLoadBehind=i,this.maxConcurrent=n}begin(t){if(this._isRunning)return;Vt&&console.log("Preload begin",{delay:t}),this._isRunning=!0;let e=-10,i,n;const o=this._switcher.scenes,a=Date.now()+t,l=setInterval(()=>{if(this.allLoaded()&&(Vt&&console.log("All scenes (pre-)loaded"),this.stop()),!this._isRunning){clearInterval(l);return}if(Date.now()<a||this.canLoadNewScene()===!1)return;(e===-10||e!==this._switcher.currentIndex)&&(e=this._switcher.currentIndex,n=0,i=0);const c=n%2===0;c&&(i+=1),n+=1;const d=c?this.maxLoadAhead:this.maxLoadBehind;if(i>d)return;const u=c?e+i:e-i;if(!(u<0)&&!(u<0||u>=o.length)&&!this._loadTasks.some(f=>f.index===u)){const f=o[u];Vt&&console.log("Preload scene",{roomIndex:u,searchForward:c,lastRoom:e,currentIndex:this._switcher.currentIndex,tasks:this._loadTasks.length},f==null?void 0:f.url),new Kk(u,f,this._loadTasks)}},200)}stop(){this._isRunning=!1}canLoadNewScene(){return this._loadTasks.length<this._maxConcurrentLoads}allLoaded(){if(this._switcher.scenes){for(const t of this._switcher.scenes)if((t==null?void 0:t.isLoaded())===!1)return!1}return!0}}class Kk{constructor(t,e,i){r(this,"index");r(this,"asset");r(this,"tasks");this.index=t,this.asset=e,this.tasks=i,i.push(this),this.awaitLoading()}async awaitLoading(){this.asset&&!this.asset.isLoaded()&&(Vt&&console.log("Preload start: "+this.asset.url,this.index),await this.asset.preload(),Vt&&console.log("Preload finished: "+this.asset.url,this.index));const t=this.tasks.indexOf(this);t>=0&&this.tasks.splice(t,1)}}function Zk(){return new Promise((s,t)=>{const i=()=>{i!=null&&(document.removeEventListener("pointerdown",i),document.removeEventListener("click",i),document.removeEventListener("dragstart",i),document.removeEventListener("touchstart",i),s())};document.addEventListener("pointerdown",i),document.addEventListener("click",i),document.addEventListener("dragstart",i),document.addEventListener("touchstart",i)})}async function Jk(s){await Zk(),s()}var eE=Object.defineProperty,tE=Object.getOwnPropertyDescriptor,Ri=(s,t,e,i)=>{for(var n=i>1?void 0:i?tE(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&eE(t,e,n),n};const rt=x("debugvideo");var Iw=(s=>(s[s.None=0]="None",s[s.AdjustHeight=1]="AdjustHeight",s[s.AdjustWidth=2]="AdjustWidth",s))(Iw||{}),jw=(s=>(s[s.VideoClip=0]="VideoClip",s[s.Url=1]="Url",s))(jw||{}),Bw=(s=>(s[s.CameraFarPlane=0]="CameraFarPlane",s[s.CameraNearPlane=1]="CameraNearPlane",s[s.RenderTexture=2]="RenderTexture",s[s.MaterialOverride=3]="MaterialOverride",s))(Bw||{});class nt extends D{constructor(){super();r(this,"playOnAwake",!0);r(this,"aspectMode",0);r(this,"clip",null);r(this,"source",1);r(this,"_url",null);r(this,"renderMode");r(this,"targetMaterialProperty");r(this,"targetMaterialRenderer");r(this,"targetTexture");r(this,"time",0);r(this,"_playbackSpeed",1);r(this,"_isLooping",!1);r(this,"_muted",!1);r(this,"_audioOutputMode",2);r(this,"playInBackground",!0);r(this,"_crossOrigin","anonymous");r(this,"_videoElement",null);r(this,"_videoTexture",null);r(this,"_videoMaterial",null);r(this,"_isPlaying",!1);r(this,"wasPlaying",!1);r(this,"visibilityChanged",e=>{switch(document.visibilityState){case"hidden":this.playInBackground||(this.wasPlaying=this._isPlaying,this.pause());break;case"visible":this.wasPlaying&&!this._isPlaying&&this.play();break}});r(this,"_receivedInput",!1);r(this,"_overlay",null);r(this,"_targetObjects");r(this,"_updateAspectRoutineId",-1);r(this,"_hls");r(this,"onHlsAvailable",()=>{var e;rt&&console.log("HLS: available",this.clip),!(!this.shouldUseM3U||!this.url)&&(this._hls||(this._hls=new Hls),this.videoElement.autoplay=!0,this._hls.loadSource(this.url),this._hls.attachMedia(this.videoElement),(e=this._videoElement)==null||e.play(),rt&&console.log("HLS: loaded",this.clip))});Jk(()=>{this._receivedInput=!0,this.updateVideoElementSettings()}),this._targetObjects=[],x("videoscreenspace")&&window.addEventListener("keydown",e=>{e.key==="f"&&(this.screenspace=!this.screenspace)})}get url(){return this._url}set url(e){const n=this._url!==e;this.__didAwake?n&&this.setClipURL(e??""):this._url=e}get playbackSpeed(){var e;return((e=this._videoElement)==null?void 0:e.playbackRate)??this._playbackSpeed}set playbackSpeed(e){this._playbackSpeed=e,this._videoElement&&(this._videoElement.playbackRate=e)}get isLooping(){var e;return((e=this._videoElement)==null?void 0:e.loop)??this._isLooping}set isLooping(e){this._isLooping=e,this._videoElement&&(this._videoElement.loop=e)}get currentTime(){var e;return((e=this._videoElement)==null?void 0:e.currentTime)??this.time}set currentTime(e){this._videoElement?this._videoElement.currentTime=e:this.time=e}get isPlaying(){const e=this._videoElement;if(e){if(e.currentTime>0&&!e.paused&&!e.ended&&e.readyState>e.HAVE_CURRENT_DATA)return!0;if(e.srcObject&&e.srcObject.active)return!0}return!1}get crossOrigin(){var e;return((e=this._videoElement)==null?void 0:e.crossOrigin)??this._crossOrigin}set crossOrigin(e){this._crossOrigin=e,this._videoElement&&(e!==null?this._videoElement.setAttribute("crossorigin",e):this._videoElement.removeAttribute("crossorigin"))}get videoMaterial(){return!this._videoMaterial&&!this.create(!1)?null:this._videoMaterial}get videoTexture(){return!this._videoTexture&&!this.create(!1)?null:this._videoTexture}get videoElement(){return!this._videoElement&&!this.create(!1)?null:this._videoElement}requestPictureInPicture(){return this._videoElement?this._videoElement.requestPictureInPicture():null}get muted(){var e;return((e=this._videoElement)==null?void 0:e.muted)??this._muted}set muted(e){this._muted=e,this._videoElement&&(this._videoElement.muted=e)}get currentVideo(){return this.clip}set audioOutputMode(e){e!==this._audioOutputMode&&(e===1&&B()&&console.warn("VideoAudioOutputMode.AudioSource is not yet implemented"),this._audioOutputMode=e,this.updateVideoElementSettings())}get audioOutputMode(){return this._audioOutputMode}preloadVideo(){rt&&console.log("Video Preload: "+this.name,this.clip),this.create(!1)}preload(){this.preloadVideo()}setVideo(e){this.clip=e,this.source=0,this._videoElement?(this._videoElement.srcObject=e,this._isPlaying&&this.play(),this.updateAspect()):this.create(this.playOnAwake)}setClipURL(e){this._url!==e&&(this._url=e,this.source=1,rt&&console.log("set url",e),this._videoElement?e.endsWith(".m3u8")||e.includes(".m3u")?this.ensureM3UCanBePlayed():(this._videoElement.src=e,this._isPlaying&&(this.stop(),this.play())):this.create(this.playOnAwake))}onEnable(){var e,i;rt&&console.log("VideoPlayer.onEnable",jw[this.source],this.clip,this.url,this),window.addEventListener("visibilitychange",this.visibilityChanged),this.playOnAwake===!0?this.create(!0):this.preloadVideo(),this.screenspace?(e=this._overlay)==null||e.start():(i=this._overlay)==null||i.stop()}onDisable(){var e;window.removeEventListener("visibilitychange",this.visibilityChanged),(e=this._overlay)==null||e.stop(),this.pause()}onDestroy(){var e;this._videoElement&&((e=this.videoElement)==null||e.remove(),this._videoElement=null),this._videoTexture&&(this._videoTexture.dispose(),this._videoTexture=null)}play(){var e,i;if(this._videoElement||this.create(!1),!this._videoElement){rt&&console.warn("Can not play: no video element found",this);return}if(!(this._isPlaying&&!((e=this._videoElement)!=null&&e.ended)&&!((i=this._videoElement)!=null&&i.paused))){if(this._isPlaying=!0,this._receivedInput||(this._videoElement.muted=!0),this.handleBeginPlaying(!1),this.shouldUseM3U){this.ensureM3UCanBePlayed();return}rt&&console.log("Video Play()",this.clip,this._videoElement,this.time),this._videoElement.currentTime=this.time,this._videoElement.play().catch(n=>{var o;console.log(n),rt&&console.error("Error playing video",n,"CODE="+n.code,(o=this.videoElement)==null?void 0:o.src,this),setTimeout(()=>{this._isPlaying&&!this.destroyed&&this.activeAndEnabled&&this.play()},1e3)}),rt&&console.log("play",this._videoElement,this.time)}}stop(){this._isPlaying=!1,this.time=0,this._videoElement&&(this._videoElement.currentTime=0,this._videoElement.pause(),rt&&console.log("STOP",this))}pause(){var e,i;this.time=((e=this._videoElement)==null?void 0:e.currentTime)??0,this._isPlaying=!1,(i=this._videoElement)==null||i.pause(),rt&&console.log("PAUSE",this,this.currentTime)}create(e){let i;switch(this.source){case 0:i=this.clip;break;case 1:i=this.url,!(i!=null&&i.length)&&typeof this.clip=="string"&&(i=this.clip);break}return i?(this._videoElement||(rt&&console.warn("Create VideoElement",this),this._videoElement=this.createVideoElement(),this.context.domElement.shadowRoot.prepend(this._videoElement),this.updateVideoElementStyles()),typeof i=="string"?(rt&&console.log("Set Video src",i),this._videoElement.src=i):(rt&&console.log("Set Video srcObject",i),this._videoElement.srcObject=i),this._videoTexture||(this._videoTexture=new h.VideoTexture(this._videoElement)),this._videoTexture.flipY=!1,this._videoTexture.colorSpace=h.SRGBColorSpace,e&&this.handleBeginPlaying(e),rt&&console.log("Video: handle playing done...",i,e),!0):(rt&&console.warn("No video source set",this),!1)}updateAspect(){this.aspectMode!==0&&this.startCoroutine(this.updateAspectImpl())}get screenspace(){var e;return((e=this._overlay)==null?void 0:e.enabled)??!1}set screenspace(e){var i;if(e){if(!this._videoTexture)return;this._overlay||(this._overlay=new iE(this.context)),this._overlay.add(this._videoTexture)}else(i=this._overlay)==null||i.remove(this._videoTexture);this._overlay&&(this._overlay.enabled=e)}createVideoElement(){const e=document.createElement("video");return this._crossOrigin&&e.setAttribute("crossorigin",this._crossOrigin),rt&&console.log("created video element",e),e}handleBeginPlaying(e){var o,a;if(!this.activeAndEnabled||!this._videoElement)return;this._targetObjects.length=0;let i=this.gameObject;switch(this.renderMode){case 3:i=(o=this.targetMaterialRenderer)==null?void 0:o.gameObject,i||(i=(a=S.getComponent(this.gameObject,ze))==null?void 0:a.gameObject);break;case 2:console.error("VideoPlayer renderTexture not implemented yet. Please use material override instead");return}if(!i){console.error("Missing target for video material renderer",this.name,Bw[this.renderMode],this);return}const n=i.material;if(n){this._targetObjects.push(i),n!==this._videoMaterial&&(this._videoMaterial=n.clone(),i.material=this._videoMaterial);const l="map",c=this._videoMaterial;if(!this.targetMaterialProperty)c[l]=this._videoTexture;else switch(this.targetMaterialProperty){default:c[l]=this._videoTexture;break}}else{console.warn("Can not play video, no material found, this might be a multimaterial case which is not supported yet");return}this.updateVideoElementSettings(),this.updateVideoElementStyles(),e&&(this.shouldUseM3U&&this.ensureM3UCanBePlayed(),this.play())}updateVideoElementSettings(){if(!this._videoElement)return;this._videoElement.loop=this._isLooping,this._videoElement.currentTime=this.currentTime,this._videoElement.playbackRate=this._playbackSpeed,this._videoElement.playsInline=!0;let e=!this._receivedInput||this.audioOutputMode===0;!e&&this._muted&&(e=!0),this._videoElement.muted=e,this.playOnAwake&&(this._videoElement.autoplay=!0)}updateVideoElementStyles(){this._videoElement&&(this._videoElement.style.userSelect="none",this._videoElement.style.visibility="hidden",this._videoElement.style.display="none",this.updateAspect())}*updateAspectImpl(){const e=++this._updateAspectRoutineId,i=void 0,n=this.clip;for(;e===this._updateAspectRoutineId&&this.aspectMode!==0&&this.clip&&n===this.clip&&this._isPlaying;){if(!n||typeof n=="string")return;let o;for(const a of n.getVideoTracks()){const l=a.getSettings();if(l&&l.width&&l.height){o=l.width/l.height;break}else o=this.context.renderer.domElement.clientWidth/this.context.renderer.domElement.clientHeight}if(o===void 0){for(let a=0;a<10;a++)yield;if(!this.isPlaying)break;continue}if(i===o){yield;continue}for(const a of this._targetObjects){let l=1;if(a.parent){const c=Ue(a.parent);l=c.x/c.y}switch(this.aspectMode){case 1:a.scale.y=1/o*a.scale.x*l;break;case 2:a.scale.x=o*a.scale.y*l;break}}for(let a=0;a<3;a++)yield}}get shouldUseM3U(){return this.url!=null&&(this.url.endsWith(".m3u8")||this.url.endsWith(".m3u"))&&this.source===1}ensureM3UCanBePlayed(){if(!this.shouldUseM3U)return;let e=document.head.querySelector("script[data-hls_library]");e?globalThis.Hls?this.onHlsAvailable():e.addEventListener("load",this.onHlsAvailable):(rt&&console.log("HLS: load script"),e=document.createElement("script"),e.dataset.hls_library="hls.js",e.src="https://cdn.jsdelivr.net/npm/hls.js@1",e.addEventListener("load",this.onHlsAvailable),document.head.append(e))}}Ri([p()],nt.prototype,"playOnAwake",2);Ri([p()],nt.prototype,"aspectMode",2);Ri([p(URL)],nt.prototype,"clip",2);Ri([p()],nt.prototype,"source",2);Ri([p(URL)],nt.prototype,"url",1);Ri([p()],nt.prototype,"renderMode",2);Ri([p()],nt.prototype,"targetMaterialProperty",2);Ri([p(ze)],nt.prototype,"targetMaterialRenderer",2);Ri([p(h.Texture)],nt.prototype,"targetTexture",2);Ri([p()],nt.prototype,"time",2);Ri([p()],nt.prototype,"playbackSpeed",1);Ri([p()],nt.prototype,"isLooping",1);Ri([p()],nt.prototype,"audioOutputMode",1);class iE{constructor(t){r(this,"context");r(this,"_videos",[]);r(this,"_screenspaceModeQuad");r(this,"_isInScreenspaceMode",!1);r(this,"_input");this.context=t,this._input=new nE(this)}get enabled(){return this._isInScreenspaceMode}set enabled(t){t?this.start():this.stop()}add(t){this._videos.indexOf(t)===-1&&this._videos.push(t)}remove(t){if(!t)return;const e=this._videos.indexOf(t);e>=0&&this._videos.splice(e,1)}start(){var n;if(this._isInScreenspaceMode||this._videos.length<0)return;const t=this._videos[this._videos.length-1];if(!t)return;if(this._isInScreenspaceMode=!0,!this._screenspaceModeQuad){if(this._screenspaceModeQuad=yo.createPrimitive(lr.Quad,{material:new sE(t)}),!this._screenspaceModeQuad)return;this._screenspaceModeQuad.geometry.scale(2,2,2)}const e=this._screenspaceModeQuad;this.context.scene.add(e),this.updateScreenspaceMaterialUniforms();const i=e.material;i==null||i.reset(),(n=this._input)==null||n.enable(i)}stop(){var t;this._isInScreenspaceMode=!1,this._screenspaceModeQuad&&((t=this._input)==null||t.disable(),this._screenspaceModeQuad.removeFromParent())}updateScreenspaceMaterialUniforms(){var e;const t=(e=this._screenspaceModeQuad)==null?void 0:e.material;t&&(t.screenAspect=this.context.domElement.clientWidth/this.context.domElement.clientHeight)}}class nE{constructor(t){r(this,"_onResizeScreenFn");r(this,"_onKeyUpFn");r(this,"_onMouseWheelFn");r(this,"context");r(this,"overlay");r(this,"_material");r(this,"_isPinching",!1);r(this,"_lastPinch",0);this.overlay=t,this.context=t.context}enable(t){this._material=t,window.addEventListener("resize",this._onResizeScreenFn=()=>{this.overlay.updateScreenspaceMaterialUniforms()}),window.addEventListener("keyup",this._onKeyUpFn=n=>{n.key==="Escape"&&this.overlay.stop()}),window.addEventListener("wheel",this._onMouseWheelFn=n=>{this.overlay.enabled&&(t.zoom+=n.deltaY*5e-4,n.preventDefault())},{passive:!1});const e=new h.Vector2;window.addEventListener("mousemove",n=>{if(this.overlay.enabled&&this.context.input.getPointerPressed(0)){const o=new h.Vector2(n.movementX,n.movementY);o.x/=this.context.domElement.clientWidth,o.y/=this.context.domElement.clientHeight,e.set(o.x,o.y),e.multiplyScalar(t.zoom/-this.context.time.deltaTime*.01),t.offset=t.offset.add(e)}}),window.addEventListener("pointermove",n=>{this.overlay.enabled&&this.context.input.getPointerPressed(0)&&this.context.input.getTouchesPressedCount()===1&&(e.set(n.movementX,n.movementY),e.multiplyScalar(t.zoom*-this.context.time.deltaTime*.05),t.offset=t.offset.add(e))});let i=0;window.addEventListener("touchstart",n=>{if(n.touches.length<2){this.context.time.time-i<.3&&this.overlay.stop(),i=this.context.time.time;return}this._isPinching=!0,this._lastPinch=0}),window.addEventListener("touchmove",n=>{if(!this._isPinching||!this._material)return;const o=n.touches[0],a=n.touches[1],l=o.clientX-a.clientX,c=o.clientY-a.clientY,d=Math.sqrt(l*l+c*c);if(this._lastPinch!==0){const u=d-this._lastPinch;this._material.zoom-=u*.004}this._lastPinch=d}),window.addEventListener("touchend",()=>{this._isPinching=!1})}disable(){this._onResizeScreenFn&&(window.removeEventListener("resize",this._onResizeScreenFn),this._onResizeScreenFn=void 0),this._onKeyUpFn&&(window.removeEventListener("keyup",this._onKeyUpFn),this._onKeyUpFn=void 0),this._onMouseWheelFn&&(window.removeEventListener("wheel",this._onMouseWheelFn),this._onMouseWheelFn=void 0)}}class sE extends h.ShaderMaterial{constructor(e){super();r(this,"_offset",new h.Vector2);this.uniforms={map:{value:e},screenAspect:{value:1},offsetScale:{value:new h.Vector4(0,0,1,1)}},this.vertexShader=`
        uniform sampler2D map;
        uniform float screenAspect;
        uniform vec4 offsetScale;
        varying vec2 vUv;

        void main() {

            gl_Position = vec4( position , 1.0 );
            vUv = uv;
            vUv.y = 1. - vUv.y;

            // fit into screen
            ivec2 res = textureSize(map, 0);
            float videoAspect = float(res.x) / float(res.y);
            float aspect = videoAspect / screenAspect;
            if(aspect >= 1.0) 
            {
                vUv.y = vUv.y * aspect;
                float offset = (1. - aspect) * .5;
                vUv.y = vUv.y + offset;
            }
            else
            {
                vUv.x = vUv.x / aspect;
                float offset = (1. - 1. / aspect) * .5;
                vUv.x = vUv.x + offset;
            }

            vUv.x -= .5;
            vUv.y -= .5;

            vUv.x *= offsetScale.z;
            vUv.y *= offsetScale.z;
            vUv.x += offsetScale.x;
            vUv.y += offsetScale.y;

            vUv.x += .5;
            vUv.y += .5;
        }

        `,this.fragmentShader=`
        uniform sampler2D map;
        varying vec2 vUv;
        void main() {
            if(vUv.x < 0. || vUv.x > 1. || vUv.y < 0. || vUv.y > 1.)
                gl_FragColor = vec4(0., 0., 0., 1.);
            else
            {
                vec4 texcolor = texture2D(map, vUv);
                gl_FragColor = texcolor;
            }
        }
        `}set screenAspect(e){this.uniforms.screenAspect.value=e,this.needsUpdate=!0}set offset(e){const i=this.uniforms.offsetScale.value;i.x=e.x,i.y=e.y,this.uniforms.offsetScale.value=i,this.needsUpdate=!0}get offset(){const e=this.uniforms.offsetScale.value;return this._offset.set(e.x,e.y),this._offset}set zoom(e){const i=this.uniforms.offsetScale.value;e<.001&&(e=.001),i.z=e,this.needsUpdate=!0}get zoom(){return this.uniforms.offsetScale.value.z}reset(){this.offset=this.offset.set(0,0),this.zoom=1,this.needsUpdate=!0}}var oE=Object.defineProperty,rE=Object.getOwnPropertyDescriptor,vh=(s,t,e,i)=>{for(var n=i>1?void 0:i?rE(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&oE(t,e,n),n};const pt=x("debugscreensharing");var Fw=(s=>(s[s.Screen=0]="Screen",s[s.Camera=1]="Camera",s[s.Canvas=2]="Canvas",s[s.Microphone=3]="Microphone",s))(Fw||{});class Oo extends D{constructor(){super(...arguments);r(this,"allowStartOnClick",!0);r(this,"autoConnect",!1);r(this,"_videoPlayer");r(this,"_audioSource");r(this,"device","Screen");r(this,"deviceName");r(this,"deviceFilter");r(this,"_net");r(this,"_requestOpen",!1);r(this,"_currentStream",null);r(this,"_currentMode",0);r(this,"onJoinedRoom",async()=>{await un(1e3),this.autoConnect&&!this.isSending&&!this.isReceiving&&this.context.connection.isInRoom&&this.share()});r(this,"_activeShareRequest",null);r(this,"onReceiveStream",e=>{var i;((i=e.stream)==null?void 0:i.active)===!0&&this.setStream(e.stream,2)});r(this,"onCallEnded",e=>{pt&&console.log("CALL ENDED",this.isReceiving,this==null?void 0:this.screenspace),this.isReceiving&&(this.screenspace=!1)})}onPointerEnter(){this.context.connection.allowEditing!=!1&&this.allowStartOnClick&&this.context.input.setCursor("pointer")}onPointerExit(){this.context.connection.allowEditing!=!1&&this.allowStartOnClick&&this.context.input.unsetCursor("pointer")}onPointerClick(e){var i;if(this.context.connection.allowEditing!=!1&&this.allowStartOnClick&&!(e&&e.pointerId!==0)){if(this.isReceiving&&((i=this.videoPlayer)!=null&&i.isPlaying)){this.videoPlayer&&(this.videoPlayer.screenspace=!this.videoPlayer.screenspace);return}if(this.isSending){this.close();return}this.share()}}set videoPlayer(e){this._videoPlayer&&(this.isSending||this.isReceiving)&&this._videoPlayer.stop(),this._videoPlayer=e,this._videoPlayer&&this._currentStream&&(this.isSending||this.isReceiving)&&this._videoPlayer.setVideo(this._currentStream)}get videoPlayer(){return this._videoPlayer}get screenspace(){var e;return((e=this.videoPlayer)==null?void 0:e.screenspace)??!1}set screenspace(e){this.videoPlayer&&(this.videoPlayer.screenspace=e)}get currentScream(){return this._currentStream}get currentMode(){return this._currentMode}get isSending(){var e;return((e=this._currentStream)==null?void 0:e.active)&&this._currentMode===1}get isReceiving(){if(this._currentMode===2){if(!this._currentStream||this._currentStream.active===!1)return!1;const e=this._currentStream.getTracks();for(const i of e)if(i.readyState==="live")return!0}return!1}get requiresVideoPlayer(){return this.device!=="Microphone"}awake(){typeof this.device=="number"&&(this.device=Fw[this.device]),pt&&console.log("Screensharing",this.name,this),Ie.registerWaitForAllowAudio(()=>{this._videoPlayer&&this._currentStream&&this._currentMode===2&&(this._videoPlayer.playInBackground=!0,this._videoPlayer.setVideo(this._currentStream))}),this._net=new ih(this)}onEnable(){var e,i,n;(e=this._net)==null||e.enable(),(i=this._net)==null||i.addEventListener(Dn.StreamReceived,this.onReceiveStream),(n=this._net)==null||n.addEventListener(Dn.StreamEnded,this.onCallEnded),this.context.connection.beginListen(J.JoinedRoom,this.onJoinedRoom),this.autoConnect&&un(1e3).then(()=>(this.enabled&&this.autoConnect&&!this.isReceiving&&!this.isSending&&this.context.connection.isInRoom&&this.share(),0))}onDisable(){var e,i,n;(e=this._net)==null||e.removeEventListener(Dn.StreamReceived,this.onReceiveStream),(i=this._net)==null||i.removeEventListener(Dn.StreamEnded,this.onCallEnded),this.context.connection.stopListen(J.JoinedRoom,this.onJoinedRoom),(n=this._net)==null||n.disable(),this.close()}_ensureVideoPlayer(){const e=new nt;e.aspectMode=Iw.AdjustWidth,S.addComponent(this.gameObject,e),this._videoPlayer=e}async share(e){return this._activeShareRequest?this._activeShareRequest:(this._activeShareRequest=this.internalShare(e),this._activeShareRequest.then(()=>this._activeShareRequest=null))}async internalShare(e){if(this.context.connection.isInRoom===!1){console.warn("Can not start screensharing: requires network connection"),B()&&pe("Can not start screensharing: requires network connection. Add a SyncedRoom component or join a room first.");return}if(e!=null&&e.device&&(this.device=e.device),!this.videoPlayer&&this.requiresVideoPlayer&&(this._videoPlayer||(this._videoPlayer=S.getComponent(this.gameObject,nt)??void 0),this.videoPlayer||this._ensureVideoPlayer(),!this.videoPlayer)){console.warn("Can not share video without a videoPlayer assigned");return}this._requestOpen=!0;try{const i=(e==null?void 0:e.constraints)??{echoCancellation:!0,autoGainControl:!1},n={video:i,audio:i},o=n.video;switch(o!==void 0&&typeof o!="boolean"&&(o.width||(o.width={max:1920}),o.height||(o.height={max:1920}),o.aspectRatio||(o.aspectRatio={ideal:1.7777777778}),o.frameRate||(o.frameRate={ideal:24}),o.facingMode||(o.facingMode={ideal:"user"})),this.device){case"Camera":this.tryShareUserCamera(n,e);break;case"Screen":{if(!navigator.mediaDevices.getDisplayMedia){console.error("No getDisplayMedia support");return}const c=await navigator.mediaDevices.getDisplayMedia(n);this._requestOpen?this.setStream(c,1):Ln(c)}break;case"Canvas":const a=0,l=this.context.renderer.domElement.captureStream(a);this.setStream(l,1);break;case"Microphone":{if(!navigator.mediaDevices.getUserMedia){console.error("No getDisplayMedia support");return}n.video=!1;const c=await navigator.mediaDevices.getUserMedia(n);this._requestOpen?this.setStream(c,1):Ln(c)}break;default:console.error("Can not start screen sharing: Unknown device type",this.device)}}catch(i){if(i.name==="NotAllowedError"){console.log("Selection cancelled"),this._requestOpen=!1;return}console.error("Error opening video",i)}}close(){var e;this._requestOpen=!1,this._currentStream&&(pt&&console.warn("Close current stream / disposing resources, stream was active?",this._currentStream.active),(e=this._net)==null||e.stopSendingStream(this._currentStream),Ln(this._currentStream),this._currentMode=0,this._currentStream=null)}setStream(e,i){var a,l,c;if(e===this._currentStream||(this.close(),!e))return;this._currentStream=e,this._requestOpen=!0,this._currentMode=i;const n=this.device!=="Microphone",o=i===1;n?(this._videoPlayer||this._ensureVideoPlayer(),this._videoPlayer?this._videoPlayer.setVideo(e):console.error("No video player assigned for video stream")):(this._audioSource||(this._audioSource=new Ie,this._audioSource.spatialBlend=0,this._audioSource.volume=1,this.gameObject.addComponent(this._audioSource)),o||(pt&&console.log("PLAY",e.getAudioTracks()),this._audioSource.volume=1,(a=this._audioSource)==null||a.play(e))),o&&((l=this._net)==null||l.startSendingStream(e)),o&&(this._videoPlayer&&(this._videoPlayer.muted=!0),(c=this._audioSource)==null||c.stop());for(const d of e.getTracks())d.addEventListener("ended",()=>{pt&&console.log("Track ended",d),this.close()}),pt&&d.kind==="video"&&console.log(o?"Video →":"Video ←",d.getSettings())}async tryShareUserCamera(e,i){const n=(await navigator.mediaDevices.enumerateDevices()).filter(a=>a.kind==="videoinput");pt&&console.log(`Request camera. These are your kind:videoinput devices:
`,n);let o=!1;for(const a of n)try{if(!this._requestOpen){pt&&console.log("Camera selection cancelled");break}if(a.kind!=="videoinput"){pt&&console.log("Skipping non-video device",a);continue}const l=a.deviceId;if((i==null?void 0:i.deviceId)!=null||(i==null?void 0:i.deviceFilter)!=null){if((i==null?void 0:i.deviceId)!==void 0&&l!==i.deviceId){pt&&console.log("Skipping device due to options.deviceId: "+a.label+"; "+a.deviceId);continue}if(i!=null&&i.deviceFilter&&i.deviceFilter(a)===!1){pt&&console.log("Skipping device due to options.deviceFilter: "+a.label+"; "+a.deviceId);continue}}else if(this.deviceFilter)if(this.deviceFilter(a)===!1){pt&&console.log("Skipping device due to ScreenShare.deviceFilter: "+a.label+"; "+a.deviceId);continue}else pt&&console.log("Selected device by filter",a);else if(this.deviceName){const u=a.label.toLowerCase(),f=this.deviceName.toLowerCase(),m=u.includes(f),g=a.deviceId===this.deviceName;if(!m&&!g){pt&&console.log("Skipping device due to ScreenShare.deviceName: "+a.label+"; "+a.deviceId);continue}else pt&&console.log("Selected device by name",a)}e.video!==!1&&((typeof e.video>"u"||typeof e.video=="boolean")&&(e.video={}),e.video.deviceId=l),o=!0;const d=await navigator.mediaDevices.getUserMedia(e).catch(u=>(console.error("Failed to get user media",u),null));if(d===null)continue;this._requestOpen?(this.setStream(d,1),pt&&console.log("Selected camera",a)):(Ln(d),pt&&console.log("Camera selection cancelled"));break}catch(l){if(l.message==="Failed to allocate videosource"||l.message==="Could not start video source"){pe("Failed to start video: Try another camera (Code "+l.code+")"),console.warn(l);continue}else console.error("Failed to get user media",l.message,l.code,l)}!o&&B()&&(pe("No camera found for sharing. Please connect a camera (see console for more information)"),console.warn("No camera found for sharing. Please connect a camera",n,this.deviceName,"Using deviceFilter? "+this.deviceFilter!=null,"Using options? "+i!=null,"Using deviceName? "+this.deviceName!=null,"Using options.deviceId? "+(i==null?void 0:i.deviceId)!=null,"Using options.deviceFilter? "+(i==null?void 0:i.deviceFilter)!=null))}}vh([p()],Oo.prototype,"allowStartOnClick",2);vh([p()],Oo.prototype,"autoConnect",2);vh([p(nt)],Oo.prototype,"videoPlayer",1);vh([p()],Oo.prototype,"device",2);vh([p()],Oo.prototype,"deviceName",2);var aE=Object.defineProperty,lE=Object.getOwnPropertyDescriptor,Uw=(s,t,e,i)=>{for(var n=i>1?void 0:i?lE(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&aE(t,e,n),n};class wh extends D{constructor(){super(...arguments);r(this,"mode",0);r(this,"shadowColor",new me(0,0,0,1));r(this,"targetMesh")}start(){if(this.gameObject instanceof h.Mesh)this.gameObject instanceof h.Mesh&&this.gameObject.material&&(this.gameObject.material=this.gameObject.material.clone(),this.targetMesh=this.gameObject,this.targetMesh.receiveShadow=!0);else{const e=yo.createPrimitive(lr.Quad,{name:"ShadowCatcher",material:new h.MeshStandardMaterial({color:10066329,roughness:1,metalness:0,transparent:!0})});e.receiveShadow=!0,e.geometry.rotateX(-Math.PI/2),this.gameObject.add(e),this.targetMesh=e}if(!this.targetMesh){console.warn("ShadowCatcher: no mesh to apply shadow catching to. Groups are currently not supported.");return}switch(this.targetMesh.layers.set(2),this.mode){case 0:this.applyShadowMaterial();break;case 1:this.applyLightBlendMaterial();break;case 2:this.applyOccluderMaterial();break}}applyLightBlendMaterial(){if(!this.targetMesh)return;const e=this.targetMesh.material;e.blending=h.AdditiveBlending,this.applyMaterialOptions(e),e.onBeforeCompile=i=>{i.fragmentShader=i.fragmentShader.replace("vec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;",`vec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;
            // diffuse-only lighting with overdrive to somewhat compensate
            // for the loss of indirect lighting and to make it more visible.
            vec3 direct = (reflectedLight.directDiffuse + reflectedLight.directSpecular) * 6.6;
            float max = max(direct.r, max(direct.g, direct.b));
            
            // early out - we're simply returning direct lighting and some alpha based on it so it can 
            // be blended onto the scene.
            gl_FragColor = vec4(direct, max);
            return;
            `)},e.userData.isLightBlendMaterial=!0}applyShadowMaterial(){if(this.targetMesh)if(this.targetMesh.material.type!=="ShadowMaterial"){const e=new h.ShadowMaterial;e.color=this.shadowColor,e.opacity=this.shadowColor.alpha,this.applyMaterialOptions(e),this.targetMesh.material=e,e.userData.isShadowCatcherMaterial=!0}else{const e=this.targetMesh.material;e.color=this.shadowColor,e.opacity=this.shadowColor.alpha,this.applyMaterialOptions(e),e.userData.isShadowCatcherMaterial=!0}}applyOccluderMaterial(){if(this.targetMesh){let e=this.targetMesh.material;if(!e){const i=new h.MeshBasicMaterial;this.targetMesh.material=i,e=i}e.depthWrite=!0,e.stencilWrite=!0,e.colorWrite=!1,this.gameObject.renderOrder=-100}}applyMaterialOptions(e){e&&(e.depthWrite=!1,e.stencilWrite=!1)}}Uw([p()],wh.prototype,"mode",2);Uw([p(me)],wh.prototype,"shadowColor",2);var cE=Object.defineProperty,hE=Object.getOwnPropertyDescriptor,xh=(s,t,e,i)=>{for(var n=i>1?void 0:i?hE(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&cE(t,e,n),n};const Bi=x("debugskybox");s_("skybox-image");s_("environment-image");function pb(s,t,e,i,n){const o=new Nn;o.allowDrop=!1,o.allowNetworking=!1,o.background=e,o.environment=i,S.addComponent(s.scene,o);const a=l=>{typeof l=="string"&&(Bi&&console.log(n,"CHANGED TO",l),o.setSkybox(l))};return Ib(s.domElement,n,a),o.addEventListener("destroy",()=>{Bi&&console.log("Destroyed attribute remote skybox",n),jb(s.domElement,n,a)}),o.setSkybox(t)}const ru=new Array;ce.registerCallback(he.ContextCreationStart,s=>{var n;const t=s.context,e=t.domElement.getAttribute("skybox-image")||t.domElement.getAttribute("background-image"),i=t.domElement.getAttribute("environment-image");if(e){Bi&&console.log("Creating remote skybox to load "+e),((n=t.mainCameraComponent)==null?void 0:n.clearFlags)!==ro.Skybox&&console.warn('"skybox-image"/"background-image" attribute has no effect: camera clearflags are not set to "Skybox"');const o=pb(t,e,!0,!1,"skybox-image");ru.push(o)}if(i){Bi&&console.log("Creating remote environment to load "+i);const o=pb(t,i,!1,!0,"environment-image");ru.push(o)}});ce.registerCallback(he.ContextCreationStart,()=>Promise.all(ru).finally(()=>{ru.length=0}));function zw(){return globalThis.NEEDLE_ENGINE_SKYBOX_TEXTURES||(globalThis.NEEDLE_ENGINE_SKYBOX_TEXTURES=new Array),globalThis.NEEDLE_ENGINE_SKYBOX_TEXTURES}function mb(s){const e=zw().find(i=>i.src===s);return e?(Bi&&console.log("Skybox: Found previously loaded texture for "+s),e.texture):null}async function dE(s){const t=await s;Ym(t,!0),xe(t)}function uE(s,t){const e=zw();for(;e.length>5;){const i=e.shift();i&&dE(i.texture)}t.then(i=>Ym(i,!1)),e.push({src:s,texture:t})}class Nn extends D{constructor(){super(...arguments);r(this,"url");r(this,"allowDrop",!0);r(this,"background",!0);r(this,"environment",!0);r(this,"allowNetworking",!0);r(this,"_loader");r(this,"_prevUrl");r(this,"_prevLoadedEnvironment");r(this,"_prevEnvironment",null);r(this,"_prevBackground",null);r(this,"validTextureTypes",[".ktx2",".hdr",".exr",".jpg",".jpeg",".png"]);r(this,"onDragOverEvent",e=>{if(this.allowDrop&&e.dataTransfer)for(const i of e.dataTransfer.types)(i==="text/uri-list"||i==="Files")&&e.preventDefault()});r(this,"onDrop",e=>{var i,n,o,a;if(this.allowDrop&&e.dataTransfer){for(const l of e.dataTransfer.types)if(Bi&&console.log(l),l==="text/uri-list"){const c=e.dataTransfer.getData(l);Bi&&console.log(l,c);let d=(n=(i=new RegExp(/polyhaven.com\/asset_img\/.+?\/(?<name>.+)\.png/).exec(c))==null?void 0:i.groups)==null?void 0:n.name;if(d||(d=(a=(o=new RegExp(/polyhaven\.com\/a\/(?<name>.+)/).exec(c))==null?void 0:o.groups)==null?void 0:a.name),Bi&&console.log(d),d){const u="https://dl.polyhaven.org/file/ph-assets/HDRIs/exr/1k/"+d+"_1k.exr";console.log(`[Remote Skybox] Setting skybox from url: ${u}`),e.preventDefault(),this.setSkybox(u);break}else if(this.isValidTextureType(c)){console.log("[Remote Skybox] Setting skybox from url: "+c),e.preventDefault(),this.setSkybox(c);break}else{console.warn(`[RemoteSkybox] Unknown url ${c}. If you want to load a skybox from a url, make sure it is a valid image url. Url must end with${this.validTextureTypes.join(", ")}.`);const u=new CustomEvent("dropped-unknown-url",{detail:{sender:this,event:e,url:c,apply:f=>{e.preventDefault(),this.setSkybox(f)}}});this.dispatchEvent(u)}}else if(l=="Files"){const c=e.dataTransfer.files.item(0);if(Bi&&console.log(l,c),!c)continue;if(!this.isValidTextureType(c.name)){console.warn(`[RemoteSkybox]: File "${c.name}" is not supported. Supported files are ${this.validTextureTypes.join(", ")}`);return}if(mb(c.name)===null){const d=new Blob([c]),u=URL.createObjectURL(d);e.preventDefault(),this.setSkybox(u,c.name)}else e.preventDefault(),this.setSkybox(c.name);break}}})}onEnable(){this.setSkybox(this.url),this.registerDropEvents()}onDisable(){var e;this.context.scene.environment===this._prevLoadedEnvironment&&(this.context.scene.environment=this._prevEnvironment,ye.backgroundShouldBeTransparent(this.context)||(this.context.scene.background=this._prevBackground),this._prevLoadedEnvironment=void 0),this.unregisterDropEvents(),(e=this.context.mainCameraComponent)==null||e.applyClearFlags()}urlChangedSyncField(){this.allowNetworking&&this.url&&this.isRemoteTexture(this.url)&&this.setSkybox(this.url)}async setSkybox(e,i){var a;if(!this.activeAndEnabled||(e=fE(e,this.environment,this.background),!e))return!1;if(i??(i=e),this.isValidTextureType(i)||console.warn("Potentially invalid skybox url",i,"on",this.name),Bi&&console.log("Set remote skybox url: "+e),this._prevUrl===e&&this._prevLoadedEnvironment)return this.applySkybox(),!0;(a=this._prevLoadedEnvironment)==null||a.dispose(),this._prevLoadedEnvironment=void 0,this._prevUrl=e;const n=await this.loadTexture(e,i);if(!n||!this.enabled)return!1;this.url=e;const o=e.lastIndexOf("/");return n.name=e.substring(o>=0?o+1:0),this._loader instanceof h.TextureLoader&&(n.colorSpace=h.SRGBColorSpace),this._prevLoadedEnvironment=n,this.applySkybox(),!0}async loadTexture(e,i){var u,f,m,g,_;if(!e)return Promise.resolve(null);i??(i=e);const n=mb(i);if(n){const y=await n;if(((f=(u=y.source)==null?void 0:u.data)==null?void 0:f.length)>0||(_=(g=(m=y.source)==null?void 0:m.data)==null?void 0:g.data)!=null&&_.length)return y}const o=i.endsWith(".exr"),a=i.endsWith(".hdr"),l=i.endsWith(".ktx2");if(o)this._loader instanceof Y.EXRLoader||(this._loader=new Y.EXRLoader);else if(a)this._loader instanceof Y.RGBELoader||(this._loader=new Y.RGBELoader);else if(l){if(!(this._loader instanceof Y.KTX2Loader)){const{ktx2Loader:y}=re.createLoaders(this.context.renderer);this._loader=y}}else this._loader instanceof h.TextureLoader||(this._loader=new h.TextureLoader);Bi&&console.log("Loading skybox: "+e);const c=this._loader.loadAsync(e);return uE(i,c),await c}applySkybox(){var i;const e=this._prevLoadedEnvironment;e&&(e instanceof h.CubeTexture||e instanceof h.CompressedCubeTexture||(e.mapping=h.EquirectangularRefractionMapping,e.needsUpdate=!0),this.context.scene.background!==e&&(this._prevBackground=this.context.scene.background),this.context.scene.environment!==e&&(this._prevEnvironment=this.context.scene.environment),Bi&&console.log("Set remote skybox",this.url,!ye.backgroundShouldBeTransparent(this.context)),this.environment&&(this.context.scene.environment=e),this.background&&!ye.backgroundShouldBeTransparent(this.context)&&(this.context.scene.background=e),((i=this.context.mainCameraComponent)==null?void 0:i.backgroundBlurriness)!==void 0&&(this.context.scene.backgroundBlurriness=this.context.mainCameraComponent.backgroundBlurriness))}isRemoteTexture(e){return e.startsWith("http://")||e.startsWith("https://")}isValidTextureType(e){for(const i of this.validTextureTypes)if(e.endsWith(i))return!0;return!1}registerDropEvents(){this.unregisterDropEvents(),this.context.domElement.addEventListener("dragover",this.onDragOverEvent),this.context.domElement.addEventListener("drop",this.onDrop)}unregisterDropEvents(){this.context.domElement.removeEventListener("dragover",this.onDragOverEvent),this.context.domElement.removeEventListener("drop",this.onDrop)}}xh([jg(Nn.prototype.urlChangedSyncField),p(URL)],Nn.prototype,"url",2);xh([p()],Nn.prototype,"allowDrop",2);xh([p()],Nn.prototype,"background",2);xh([p()],Nn.prototype,"environment",2);xh([p()],Nn.prototype,"allowNetworking",2);function fE(s,t,e){const i=t&&!e;switch(s==null?void 0:s.toLowerCase()){case"studio":return i?"https://cdn.needle.tools/static/skybox/modelviewer-Neutral-small.hdr":"https://cdn.needle.tools/static/skybox/modelviewer-Neutral.hdr";case"blurred-skybox":return i?"https://cdn.needle.tools/static/skybox/blurred-skybox-small.exr":"https://cdn.needle.tools/static/skybox/blurred-skybox.exr";case"quicklook-ar":return i?"https://cdn.needle.tools/static/skybox/QuickLook-ARMode-small.exr":"https://cdn.needle.tools/static/skybox/QuickLook-ARMode.exr";case"quicklook":return i?"https://cdn.needle.tools/static/skybox/QuickLook-ObjectMode-small.exr":"https://cdn.needle.tools/static/skybox/QuickLook-ObjectMode.exr"}return s===void 0?null:s}var pE=Object.defineProperty,mE=Object.getOwnPropertyDescriptor,Ku=(s,t,e,i)=>{for(var n=i>1?void 0:i?mE(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&pE(t,e,n),n},Pp;const Nw=(Pp=class extends D{constructor(){super(...arguments);r(this,"target",null);r(this,"followFactor",.1);r(this,"rotateFactor",.1);r(this,"positionAxes",da.All);r(this,"flipForward",!1);r(this,"_firstUpdate",!0)}onBeforeRender(){this.updateNow(!1)}updateNow(t){if(!(!this.target||this.target===this.gameObject)){if(this.followFactor>0){const e=Z(this.target),i=this._firstUpdate||t?1:z.clamp01(this.context.time.deltaTime*this.followFactor),n=this.worldPosition;this.positionAxes&da.X&&(n.x=z.lerp(n.x,e.x,i)),this.positionAxes&da.Y&&(n.y=z.lerp(n.y,e.y,i)),this.positionAxes&da.Z&&(n.z=z.lerp(n.z,e.z,i)),this.worldPosition=n}if(this.rotateFactor>0){const e=_e(this.target);this.flipForward&&e.premultiply(Nw._invertForward);const i=this._firstUpdate||t?1:z.clamp01(this.context.time.deltaTime*this.rotateFactor);this.worldQuaternion=this.worldQuaternion.slerp(e,i)}this._firstUpdate=!1}}},r(Pp,"_invertForward",new h.Quaternion().setFromAxisAngle(new h.Vector3(0,1,0),Math.PI)),Pp);let Mo=Nw;Ku([p(h.Object3D)],Mo.prototype,"target",2);Ku([p()],Mo.prototype,"followFactor",2);Ku([p()],Mo.prototype,"rotateFactor",2);Ku([p()],Mo.prototype,"positionAxes",2);var gE=Object.defineProperty,_E=Object.getOwnPropertyDescriptor,Sh=(s,t,e,i)=>{for(var n=i>1?void 0:i?_E(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&gE(t,e,n),n};const hc=x("debugspatialtrigger"),gb=new h.Layers,_b=new h.Layers;function yE(s,t){return gb.mask=s,_b.mask=t,gb.test(_b)}class Bn extends D{constructor(){super(...arguments);r(this,"triggerMask",0);r(this,"onEnter");r(this,"onStay");r(this,"onExit");r(this,"currentIntersected",[]);r(this,"lastIntersected",[])}start(){hc&&console.log(this.name,this.triggerMask,this)}update(){this.currentIntersected.length=0;for(const e of Ch.triggers)yE(e.triggerMask,this.triggerMask)&&e.test(this.gameObject)&&this.currentIntersected.push(e);for(let e=this.lastIntersected.length-1;e>=0;e--){const i=this.lastIntersected[e];this.currentIntersected.indexOf(i)<0&&(this.onExitTrigger(i),this.lastIntersected.splice(e,1))}for(const e of this.currentIntersected)this.lastIntersected.indexOf(e)<0&&this.onEnterTrigger(e),this.onStayTrigger(e);this.lastIntersected.length=0,this.lastIntersected.push(...this.currentIntersected)}onEnterTrigger(e){var i;hc&&console.log("ENTER TRIGGER",this.name,e.name,this,e),e.raiseOnEnterEvent(this),(i=this.onEnter)==null||i.invoke()}onExitTrigger(e){var i;hc&&console.log("EXIT TRIGGER",this.name,e.name),e.raiseOnExitEvent(this),(i=this.onExit)==null||i.invoke()}onStayTrigger(e){var i;e.raiseOnStayEvent(this),(i=this.onStay)==null||i.invoke()}}Sh([p()],Bn.prototype,"triggerMask",2);Sh([p(ge)],Bn.prototype,"onEnter",2);Sh([p(ge)],Bn.prototype,"onStay",2);Sh([p(ge)],Bn.prototype,"onExit",2);var Op;const kd=(Op=class extends D{constructor(){super(...arguments);r(this,"triggerMask");r(this,"boxHelper")}start(){hc&&console.log(this.name,this.triggerMask,this)}onEnable(){var t;kd.triggers.push(this),this.boxHelper||(this.boxHelper=S.addComponent(this.gameObject,ti),(t=this.boxHelper)==null||t.showHelper(null,hc))}onDisable(){kd.triggers.splice(kd.triggers.indexOf(this),1)}test(t){return this.boxHelper?this.boxHelper.isInBox(t)??!1:!1}raiseOnEnterEvent(t){S.foreachComponent(this.gameObject,e=>{e!==t&&e instanceof Bn&&e.onEnterTrigger(this)},!1)}raiseOnStayEvent(t){S.foreachComponent(this.gameObject,e=>{e!==t&&e instanceof Bn&&e.onStayTrigger(this)},!1)}raiseOnExitEvent(t){S.foreachComponent(this.gameObject,e=>{e!==t&&e instanceof Bn&&e.onExitTrigger(this)},!1)}},r(Op,"triggers",[]),Op);let Ch=kd;Sh([p()],Ch.prototype,"triggerMask",2);var bE=Object.defineProperty,vE=Object.getOwnPropertyDescriptor,wE=(s,t,e,i)=>{for(var n=i>1?void 0:i?vE(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&bE(t,e,n),n};const yi=x("debugspectator");class Zu extends D{constructor(){super(...arguments);r(this,"cam",null);r(this,"useKeys",!0);r(this,"_mode",0);r(this,"orbit",null);r(this,"_handler");r(this,"eventSub_WebXRRequestStartEvent",null);r(this,"eventSub_WebXRStartEvent",null);r(this,"eventSub_WebXREndEvent",null);r(this,"_debug");r(this,"_networking")}get mode(){return this._mode}set mode(e){this._mode=e}get isSpectating(){var e;return((e=this._handler)==null?void 0:e.currentTarget)!==void 0}isSpectatingUser(e){var i;return((i=this.target)==null?void 0:i.userId)===e}isFollowedBy(e){var i;return(i=this.followers)==null?void 0:i.includes(e)}get followers(){return this._networking.followers}stopSpectating(){if(this.context.isInXR){this.followSelf();return}this.target=void 0}get localId(){return this.context.connection.connectionId??"local"}set target(e){var i;if(this._handler){const n=(i=this._handler.currentTarget)==null?void 0:i.userId,o=this.context.players.getPlayerView(this.localId);e===void 0||this.context.isInXR===!1&&(o==null?void 0:o.currentObject)===e.currentObject?this._handler.currentTarget!==void 0&&(this._handler.disable(),S.setActive(this.gameObject,!1),this.orbit&&(this.orbit.enabled=!0),this._networking.onSpectatedObjectChanged(e,n)):this._handler.currentTarget!==e&&(this._handler.set(e),S.setActive(this.gameObject,!0),this.orbit&&(this.orbit.enabled=!1),this._networking.onSpectatedObjectChanged(e,n))}}get target(){var e;return(e=this._handler)==null?void 0:e.currentTarget}requestAllFollowMe(){this._networking.onRequestFollowMe()}get isSpectatingSelf(){var e,i;return this.isSpectating&&((e=this.target)==null?void 0:e.currentObject)===((i=this.context.players.getPlayerView(this.localId))==null?void 0:i.currentObject)}awake(){if(this._debug=new CE(this.context,this),this._networking=new ME(this.context,this),this._networking.awake(),S.setActive(this.gameObject,!1),this.cam=S.getComponent(this.gameObject,ye),!this.cam){console.warn("SpectatorCamera: Spectator camera needs camera component on the same object.",this);return}!this._handler&&this.cam&&(this._handler=new xE(this.context,this.cam,this)),this.orbit=S.getComponent(this.context.mainCamera,fe)}onDestroy(){var e,i;this.stopSpectating(),(e=this._handler)==null||e.destroy(),(i=this._networking)==null||i.destroy()}isSupportedPlatform(){const e=window.navigator.userAgent,i=/Windows|MacOS/.test(e),n=/Windows NT/.test(e)&&/Edg/.test(e)&&!/Win64/.test(e);return i&&!n}onBeforeXR(e){this.isSupportedPlatform()&&S.setActive(this.gameObject,!0)}onEnterXR(e){this.isSupportedPlatform()&&(yi&&console.log(this.context.mainCamera),this.context.mainCamera&&this.followSelf())}onLeaveXR(e){var i,n;this.context.removeCamera(this.cam),S.setActive(this.gameObject,!1),this.orbit&&(this.orbit.enabled=!0),(i=this._handler)==null||i.set(void 0),(n=this._handler)==null||n.disable(),this.isSpectatingSelf&&this.stopSpectating()}followSelf(){this.target=this.context.players.getPlayerView(this.context.connection.connectionId),this.target||(this.context.players.setPlayerView(this.localId,this.context.mainCamera,to.Headset),this.target=this.context.players.getPlayerView(this.localId)),yi&&console.log("Follow self",this.target)}onAfterRender(){var u,f,m;if(!this.cam)return;const e=this.context.renderer,i=e.xr.enabled;if(!e.xr.isPresenting&&!((u=this._handler)!=null&&u.currentTarget))return;(f=this._handler)==null||f.update(this._mode);const n=e.getRenderTarget();let o=null;const a=e.state;if(!n){if(!e.state.bindFramebuffer||!a.bindXRFramebuffer)return;o=e._framebuffer,a.bindXRFramebuffer(null)}this.setAvatarFlagsBeforeRender();const l=this.context.mainCameraComponent;if(l){const g=l.backgroundColor;g&&e.setClearColor(g,g.alpha),this.cam.backgroundColor=g,this.cam.clearFlags=l.clearFlags,this.cam.nearClipPlane=l.nearClipPlane,this.cam.farClipPlane=l.farClipPlane}else e.setClearColor(new h.Color(1,1,1));e.setRenderTarget(null),e.xr.enabled=!1;const c=(m=this.cam)==null?void 0:m.threeCamera;this.context.updateAspect(c);const d=e.xr.isPresenting;e.xr.isPresenting=!1,e.setSize(this.context.domWidth,this.context.domHeight),e.render(this.context.scene,c),e.xr.isPresenting=d,e.xr.enabled=i,n?e.setRenderTarget(n):a.bindXRFramebuffer&&a.bindXRFramebuffer(o),this.resetAvatarFlags()}setAvatarFlagsBeforeRender(){const e=this._mode===0;for(const i of tt.instances)if(i.avatar&&"isLocalAvatar"in i.avatar&&"flags"in i.avatar){let n=En.All;this.isSpectatingSelf&&(n=e&&i.avatar.isLocalAvatar?En.FirstPerson:En.ThirdPerson);const o=i.avatar.flags;if(!o)continue;for(const a of o)a.UpdateVisible(n)}}resetAvatarFlags(){var e;for(const i of tt.instances)if(i.avatar&&"flags"in i.avatar){const n=i.avatar.flags;if(!n)continue;for(const o of n)"isLocalAvatar"in i.avatar&&((e=i.avatar)!=null&&e.isLocalAvatar)?o.UpdateVisible(En.FirstPerson):o.UpdateVisible(En.ThirdPerson)}}}wE([p()],Zu.prototype,"useKeys",2);class xE{constructor(t,e,i){r(this,"context");r(this,"cam");r(this,"spectator");r(this,"follow");r(this,"target");r(this,"view");r(this,"currentObject");this.context=t,this.cam=e,this.spectator=i}get currentTarget(){return this.view}set(t){const e=t==null?void 0:t.currentObject;if(!e){this.spectator.stopSpectating();return}e!==this.currentObject&&(this.currentObject=e,this.view=t,this.follow||(this.follow=S.addComponent(this.cam.gameObject,Mo)),this.target||(this.target=new h.Object3D),e.add(this.target),this.follow.enabled=!0,this.follow.target=this.target,yi&&console.log("FOLLOW",e),this.context.isInXR?this.context.removeCamera(this.cam):this.context.setCurrentCamera(this.cam))}disable(){yi&&console.log("STOP FOLLOW",this.currentObject),this.view=void 0,this.currentObject=void 0,this.context.removeCamera(this.cam),this.follow&&(this.follow.enabled=!1)}destroy(){var t;(t=this.target)==null||t.removeFromParent(),this.follow&&S.destroy(this.follow)}update(t){var n,o,a,l,c,d;if(((n=this.currentTarget)==null?void 0:n.isConnected)===!1||((o=this.currentTarget)==null?void 0:o.removed)===!0){yi&&console.log("Target disconnected or timeout",this.currentTarget),this.spectator.stopSpectating();return}this.currentTarget&&((a=this.currentTarget)==null?void 0:a.currentObject)!==this.currentObject&&(yi&&console.log("Target changed",this.currentObject,"to",this.currentTarget.currentObject),this.set(this.currentTarget));const e=this.context.mainCamera;if(e){const u=this.cam.threeCamera;(u.near!==e.near||u.far!==e.far)&&(u.near=e.near,u.far=e.far,u.updateProjectionMatrix())}const i=(l=this.follow)==null?void 0:l.target;if(!(!i||!this.follow)){switch(t){case 0:((c=this.view)==null?void 0:c.viewDevice)!==to.Browser?(this.follow.followFactor=5,this.follow.rotateFactor=5):(this.follow.followFactor=50,this.follow.rotateFactor=50),i.position.set(0,0,0);break;case 1:this.follow.followFactor=3,this.follow.rotateFactor=2,i.position.set(0,.5,1.5);break}this.follow.flipForward=!1,((d=this.view)==null?void 0:d.viewDevice)!==to.Browser?i.quaternion.copy(SE):i.quaternion.identity()}}}const SE=new h.Quaternion().setFromAxisAngle(new h.Vector3(0,1,0),Math.PI);class CE{constructor(t,e){r(this,"context");r(this,"spectator");this.context=t,this.spectator=e,console.log("[Spectator Camera] Click other avatars or cameras to follow them. Press ESC to exit spectator mode."),this.context.domElement.addEventListener("keydown",n=>{if(!this.spectator.useKeys)return;n.key==="Escape"&&this.spectator.stopSpectating()});let i=0;this.context.input.addEventListener(ke.PointerDown,n=>{i=this.context.time.time}),this.context.input.addEventListener(ke.PointerUp,n=>{const o=this.context.time.time-i;o>1?this.spectator.stopSpectating():this.context.input.getPointerClicked(0)&&o<.3&&this.trySelectObject()})}trySelectObject(){const t=new Fn;t.setMask(16777215);const e=this.context.physics.raycast(t);if(yi&&console.log(...e),e!=null&&e.length)for(const i of e){if(i.distance<.2)continue;const n=i.object,o=S.getComponentInParent(n,tt),a=o==null?void 0:o.connectionId;if(a){const l=this.context.players.getPlayerView(a);this.spectator.target=l,yi&&console.log("spectate",a,o);break}}}}class PE{constructor(t,e,i){r(this,"guid");r(this,"dontSave",!0);r(this,"targetUserId");r(this,"stoppedFollowing");this.guid=t,this.targetUserId=e,this.stoppedFollowing=i}}class OE{constructor(t,e){r(this,"guid");r(this,"userId");this.guid=t.guid,this.userId=e}}class ME{constructor(t,e){r(this,"followers",[]);r(this,"context");r(this,"spectator");r(this,"_followerEventMethod");r(this,"_requestFollowMethod");r(this,"_joinedRoomMethod");r(this,"_lastRequestFollowUser");r(this,"_enforceFollowInterval");this.context=t,this.spectator=e,this._followerEventMethod=this.onFollowerEvent.bind(this),this._requestFollowMethod=this.onRequestFollowEvent.bind(this),this._joinedRoomMethod=this.onUserJoinedRoom.bind(this)}awake(){this.context.connection.beginListen("spectator-follower-changed",this._followerEventMethod),this.context.connection.beginListen("spectator-request-follow",this._requestFollowMethod),this.context.connection.beginListen(J.JoinedRoom,this._joinedRoomMethod),this.context.domElement.addEventListener("keydown",t=>{this.spectator.useKeys&&(t.key==="f"?this.onRequestFollowMe():t.key==="Escape"&&this.onRequestFollowMe(!0))})}destroy(){this.context.connection.stopListen("spectator-follower-changed",this._followerEventMethod),this.context.connection.stopListen("spectator-request-follow",this._requestFollowMethod),this.context.connection.stopListen(J.JoinedRoom,this._joinedRoomMethod)}onSpectatedObjectChanged(t,e){if(yi&&console.log(this.context.connection.connectionId,"onSpectatedObjectChanged",t,e),this.context.connection.connectionId){const i=(t==null?void 0:t.userId)===void 0,n=i?e:t==null?void 0:t.userId,o=new PE(this.context.connection.connectionId,n,i);this.context.connection.send("spectator-follower-changed",o)}}onRequestFollowMe(t=!1){if(yi&&console.log("Request follow",this.context.connection.connectionId),this.context.connection.connectionId){this.spectator.stopSpectating();const e=t?void 0:this.context.connection.connectionId,i=new OE(this.spectator,e);this.context.connection.send("spectator-request-follow",i)}}onUserJoinedRoom(){x("followme")&&this.onRequestFollowMe()}onFollowerEvent(t){const e=t.targetUserId,i=t.guid;if(yi&&console.log(t),e===this.context.connection.connectionId)if(t.stoppedFollowing){const n=this.followers.indexOf(i);n!==-1&&(this.followers.splice(n,1),this.removeDisconnectedFollowers(),console.log(i,"unfollows you",this.followers.length))}else this.followers.includes(i)||(this.followers.push(i),this.removeDisconnectedFollowers(),console.log(i,"follows you",this.followers.length))}removeDisconnectedFollowers(){for(let t=this.followers.length-1;t>=0;t--){const e=this.followers[t];this.context.connection.userIsInRoom(e)===!1&&this.followers.splice(t,1)}}onRequestFollowEvent(t){if(this._lastRequestFollowUser=t,t.userId===this.context.connection.connectionId)this.spectator.stopSpectating();else if(t.userId===void 0)this.spectator.stopSpectating();else{const e=this.context.players.getPlayerView(t.userId);if(e)this.spectator.target=e;else return yi&&console.warn("Could not find view",t.userId),this.enforceFollow(),!1}return!0}enforceFollow(){this._enforceFollowInterval||(this._enforceFollowInterval=setInterval(()=>{this._lastRequestFollowUser===void 0||this._lastRequestFollowUser.userId&&this.spectator.isFollowedBy(this._lastRequestFollowUser.userId)?(clearInterval(this._enforceFollowInterval),this._enforceFollowInterval=void 0):(yi&&console.log("REQUEST FOLLOW AGAIN",this._lastRequestFollowUser.userId),this.onRequestFollowEvent(this._lastRequestFollowUser))},1e3))}}class kn{constructor(){r(this,"bb",null);r(this,"bb_pos",0)}__init(t,e){return this.bb_pos=t,this.bb=e,this}static getRootAsSyncedCameraModel(t,e){return(e||new kn).__init(t.readInt32(t.position())+t.position(),t)}static getSizePrefixedRootAsSyncedCameraModel(t,e){return t.setPosition(t.position()+oe.SIZE_PREFIX_LENGTH),(e||new kn).__init(t.readInt32(t.position())+t.position(),t)}userId(t){const e=this.bb.__offset(this.bb_pos,4);return e?this.bb.__string(this.bb_pos+e,t):null}guid(t){const e=this.bb.__offset(this.bb_pos,6);return e?this.bb.__string(this.bb_pos+e,t):null}dontSave(){const t=this.bb.__offset(this.bb_pos,8);return t?!!this.bb.readInt8(this.bb_pos+t):!1}pos(t){const e=this.bb.__offset(this.bb_pos,10);return e?(t||new tr).__init(this.bb_pos+e,this.bb):null}rot(t){const e=this.bb.__offset(this.bb_pos,12);return e?(t||new tr).__init(this.bb_pos+e,this.bb):null}static startSyncedCameraModel(t){t.startObject(5)}static addUserId(t,e){t.addFieldOffset(0,e,0)}static addGuid(t,e){t.addFieldOffset(1,e,0)}static addDontSave(t,e){t.addFieldInt8(2,+e,0)}static addPos(t,e){t.addFieldStruct(3,e,0)}static addRot(t,e){t.addFieldStruct(4,e,0)}static endSyncedCameraModel(t){return t.endObject()}static finishSyncedCameraModelBuffer(t,e){t.finish(e)}static finishSizePrefixedSyncedCameraModelBuffer(t,e){t.finish(e,void 0,!0)}}var RE=Object.defineProperty,kE=Object.getOwnPropertyDescriptor,EE=(s,t,e,i)=>{for(var n=i>1?void 0:i?kE(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&RE(t,e,n),n};const au="SCAM";Wm(au,kn.getRootAsSyncedCameraModel);const ui=new oe.Builder;class TE{constructor(t,e){r(this,"userId");r(this,"guid");this.guid=e,this.userId=t}send(t,e){if(t){ui.clear();const i=ui.createString(this.guid),n=ui.createString(this.userId);kn.startSyncedCameraModel(ui),kn.addGuid(ui,i),kn.addUserId(ui,n);const o=Z(t),a=Nc(t);kn.addPos(ui,tr.createVec3(ui,o.x,o.y,o.z)),kn.addRot(ui,tr.createVec3(ui,a.x,a.y,a.z));const l=kn.endSyncedCameraModel(ui);ui.finish(l,au),e.sendBinary(ui.asUint8Array())}}}var Mp;const bm=(Mp=class extends D{constructor(){super(...arguments);r(this,"cameraPrefab",null);r(this,"_lastWorldPosition");r(this,"_lastWorldQuaternion");r(this,"_model",null);r(this,"_needsUpdate",!0);r(this,"_lastUpdateTime",0);r(this,"remoteCams",{});r(this,"userToCamMap",{});r(this,"_camTimeoutInSeconds",10);r(this,"_receiveCallback",null)}getCameraObject(t){const e=this.userToCamMap[t];return e?this.remoteCams[e].obj:null}async awake(){this._lastWorldPosition=this.worldPosition.clone(),this._lastWorldQuaternion=this.worldQuaternion.clone(),this.cameraPrefab&&("uri"in this.cameraPrefab&&(this.cameraPrefab=await this.cameraPrefab.instantiate(this.gameObject)),this.cameraPrefab&&"isObject3D"in this.cameraPrefab&&(this.cameraPrefab.visible=!1))}onEnable(){this._receiveCallback=this.context.connection.beginListenBinary(au,this.onReceivedRemoteCameraInfoBin.bind(this))}onDisable(){this.context.connection.stopListenBinary(au,this._receiveCallback)}update(){for(const n in this.remoteCams){const o=this.remoteCams[n],a=this.context.time.realtimeSinceStartup-o.lastUpdate;if(!o||a>this._camTimeoutInSeconds){B()&&console.log("Remote cam timeout",n),o!=null&&o.obj&&S.destroy(o.obj),delete this.remoteCams[n],o&&delete this.userToCamMap[o.userId],bm.instances.push(o),this.context.players.removePlayerView(o.userId,to.Browser);continue}}if(this.context.isInXR)return;const t=this.context.mainCamera;if(t===null){this.enabled=!1;return}if(!this.context.connection.isConnected||this.context.connection.connectionId===null)return;this._model===null&&(this._model=new TE(this.context.connection.connectionId,this.context.connection.connectionId+"_camera"));const e=Z(t),i=_e(t);(e.distanceTo(this._lastWorldPosition)>.001||i.angleTo(this._lastWorldQuaternion)>.01)&&(this._needsUpdate=!0),this._lastWorldPosition.copy(e),this._lastWorldQuaternion.copy(i),!((!this._needsUpdate||this.context.time.frameCount%2!==0)&&!(this.context.time.realtimeSinceStartup-this._lastUpdateTime>this._camTimeoutInSeconds*.5))&&(this._lastUpdateTime=this.context.time.realtimeSinceStartup,this._needsUpdate=!1,this._model.send(t,this.context.connection),this.context.isInXR||this.context.players.setPlayerView(this.context.connection.connectionId,t,to.Browser))}onReceivedRemoteCameraInfoBin(t){const e=t.guid();if(!e)return;const i=t.userId();if(!i||!this.context.connection.userIsInRoom(i)||!this.cameraPrefab)return;let n=this.remoteCams[e];if(!n)if("isObject3D"in this.cameraPrefab){const c=new pn;c.context=this.context;const d=S.instantiate(this.cameraPrefab,c);n=this.remoteCams[e]={obj:d,lastUpdate:this.context.time.realtimeSinceStartup,userId:i},n.obj.visible=!0,this.gameObject.add(d),this.userToCamMap[i]=e,bm.instances.push(n);const u=S.getOrAddComponent(d,tt);u.connectionId=i,u.avatar=d}else return;const o=n.obj;this.context.players.setPlayerView(i,o,to.Browser),n.lastUpdate=this.context.time.realtimeSinceStartup,Vi.markDirty(o);const a=t.pos();a&&ar(o,a.x(),a.y(),a.z());const l=t.rot();l&&Vc(o,l.x(),l.y(),l.z())}},r(Mp,"instances",[]),Mp);let Ju=bm;EE([p([h.Object3D,ee])],Ju.prototype,"cameraPrefab",2);var AE=Object.defineProperty,DE=Object.getOwnPropertyDescriptor,Ro=(s,t,e,i)=>{for(var n=i>1?void 0:i?DE(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&AE(t,e,n),n};const up="view",fp=x("debugsyncedroom");class vn extends D{constructor(){super(...arguments);r(this,"roomName","");r(this,"urlParameterName","room");r(this,"joinRandomRoom");r(this,"requireRoomParameter",!1);r(this,"autoRejoin",!0);r(this,"createJoinButton",!0);r(this,"createViewOnlyButton",!1);r(this,"_lastJoinedRoom");r(this,"_roomPrefix","");r(this,"_lastPingTime",0);r(this,"_lastRoomTime",-1);r(this,"_userWantsToBeInARoom",!1);r(this,"_roomButton");r(this,"_roomButtonIconJoin");r(this,"_roomButtonIconLeave");r(this,"updateRoomButtonState",()=>{var e,i;this._roomButton&&(this.context.connection.isInRoom?(this._roomButton.title="Leave the networked room",this._roomButton.textContent="Leave Room",(e=this._roomButtonIconJoin)==null||e.remove(),this._roomButton.prepend(this._roomButtonIconLeave)):(this._roomButton.title="Create or join a networked room",this._roomButton.textContent="Join Room",(i=this._roomButtonIconLeave)==null||i.remove(),this._roomButton.prepend(this._roomButtonIconJoin)))});r(this,"_viewOnlyButton");r(this,"onCreateViewOnlyButton",()=>{if(!this._viewOnlyButton){const e=document.createElement("button");this._viewOnlyButton=e,e.classList.add("view-only-button"),e.setAttribute("priority","90"),e.onclick=()=>{var n;const i=this.getViewOnlyUrl();i!=null&&i.length?navigator.canShare({url:i})?(n=navigator.share({url:i}))==null||n.catch(o=>{console.warn(o)}):(navigator.clipboard.writeText(i),Te("View only URL copied to clipboard")):pe("Could not create view only URL")},e.title="Copy the view only URL: A page accessed by the view only URL can not be modified by visiting users.",e.textContent="Share View URL",e.prepend(yt("visibility"))}this.context.menu.appendChild(this._viewOnlyButton)})}get currentRoomName(){const e=x(up);return e||x(this.urlParameterName)}set roomPrefix(e){this._roomPrefix=e}get roomPrefix(){return this._roomPrefix}awake(){var e;this.joinRandomRoom===void 0&&((e=this.roomName)==null?void 0:e.length)<=0&&(this.joinRandomRoom=!0),fp&&console.log(`SyncedRoom roomName:${this.roomName}, urlParamName:${this.urlParameterName}, joinRandomRoom:${this.joinRandomRoom}`)}onEnable(){const e=x(up);if(e&&typeof e=="string"&&e.length>0){console.log("Join as viewer"),this.context.connection.joinRoom(e,!0);return}if(this.tryJoinRoom(),this.createJoinButton){const i=this.createRoomButton();this.context.menu.appendChild(i)}this.createViewOnlyButton&&this.onEnableViewOnlyButton()}onDisable(){var e;(e=this._roomButton)==null||e.remove(),this.onDisableViewOnlyButton(),this.roomName&&this.roomName.length>0&&this.context.connection.leaveRoom(this.roomName)}onDestroy(){this.destroyRoomButton()}tryJoinRandomRoom(){this.setRandomRoomUrlParameter(),this.tryJoinRoom()}tryJoinRoom(e=0){var n;e===void 0&&(e=0);let i=!1;if(((n=this.urlParameterName)==null?void 0:n.length)>0){const o=x(this.urlParameterName);if(o&&(typeof o=="string"||typeof o=="number")){i=!0;const a=Db(o.toString());this.roomName=a}else if(this.joinRandomRoom&&(console.log("No room name found in url, generating random one"),this.setRandomRoomUrlParameter(),e<1))return this.tryJoinRoom(e+1)}else this.joinRandomRoom&&(this.roomName===null||this.roomName===void 0||this.roomName.length<=0)&&(this.roomName=this.generateRoomName());return this.requireRoomParameter&&!i?((fp||B())&&console.warn('[SyncedRoom] Missing required room parameter "'+this.urlParameterName+`" in url - will not connect.
To allow joining a room without a query parameter you can set "requireRoomParameter" to false.`),!1):(this.context.connection.isConnected||this.context.connection.connect(),this._lastJoinedRoom=this.roomName,this._roomPrefix&&(this.roomName=this._roomPrefix+this.roomName),this.roomName.length<=0?(console.warn(`[SyncedRoom] Room name is not set so we can not join a networked room.
Please choose one of the following options to fix this:
A) Set a room name in the SyncedRoom component
B) Set a room name in the URL parameter "?`+this.urlParameterName+`=my_room"
C) Set "joinRandomRoom" to true`),!1):(fp&&console.log("Join "+this.roomName),this._userWantsToBeInARoom=!0,this.context.connection.joinRoom(this.roomName),!0))}update(){this.context.connection.isConnected&&(this.context.time.time-this._lastPingTime>3&&(this._lastPingTime=this.context.time.time,this.context.connection.sendPing()),this.context.connection.isInRoom&&(this._lastRoomTime=this.context.time.time)),this._lastRoomTime>0&&this.context.time.time-this._lastRoomTime>.3&&(this._lastRoomTime=-1,this.autoRejoin?this._userWantsToBeInARoom&&(console.log("Disconnected from networking backend - attempt reconnecting now"),this.tryJoinRoom()):B()&&console.warn("You are not connected to a room anymore (possibly because the tab was inactive for too long and the server kicked you?)"))}getViewOnlyUrl(){if(this.context.connection.isConnected&&this.context.connection.currentRoomViewId){const e=window.location.search,i=new URLSearchParams(e);return i.has(this.urlParameterName)&&i.delete(this.urlParameterName),i.set(up,this.context.connection.currentRoomViewId),window.location.origin+window.location.pathname+"?"+i.toString()}return null}setRandomRoomUrlParameter(){const e=Bc(),i=this.generateRoomName();x(this.urlParameterName)?e.set(this.urlParameterName,i):e.append(this.urlParameterName,i),Om(i,e)}generateRoomName(){let e="";for(let i=0;i<6;i++)e+=Math.floor(Math.random()*10).toFixed(0);return e}createRoomButton(){if(this._roomButton)return this._roomButton;const e=document.createElement("button");return this._roomButton=e,e.classList.add("create-room-button"),e.setAttribute("priority","90"),e.onclick=()=>{if(this.context.connection.isInRoom)this.urlParameterName&&wc(this.urlParameterName,null),this.context.connection.leaveRoom(),this._userWantsToBeInARoom=!1;else{if(this.urlParameterName){const i=x(this.urlParameterName);(!i||i===!0)&&(this._lastJoinedRoom?wc(this.urlParameterName,this._lastJoinedRoom):this.setRandomRoomUrlParameter())}this.tryJoinRoom()}},this._roomButtonIconJoin=yt("group"),this._roomButtonIconLeave=yt("group_off"),this.updateRoomButtonState(),this.context.connection.beginListen(J.JoinedRoom,this.updateRoomButtonState),this.context.connection.beginListen(J.LeftRoom,this.updateRoomButtonState),e}destroyRoomButton(){this.context.connection.stopListen(J.JoinedRoom,this.updateRoomButtonState),this.context.connection.stopListen(J.LeftRoom,this.updateRoomButtonState)}onEnableViewOnlyButton(){this.context.connection.isConnected?this.onCreateViewOnlyButton():(this.context.connection.stopListen(J.JoinedRoom,this.onCreateViewOnlyButton),this.context.connection.beginListen(J.JoinedRoom,this.onCreateViewOnlyButton))}onDisableViewOnlyButton(){var e;this.context.connection.stopListen(J.JoinedRoom,this.onCreateViewOnlyButton),(e=this._viewOnlyButton)==null||e.remove()}}Ro([p()],vn.prototype,"roomName",2);Ro([p()],vn.prototype,"urlParameterName",2);Ro([p()],vn.prototype,"joinRandomRoom",2);Ro([p()],vn.prototype,"requireRoomParameter",2);Ro([p()],vn.prototype,"autoRejoin",2);Ro([p()],vn.prototype,"createJoinButton",2);Ro([p()],vn.prototype,"createViewOnlyButton",2);Ro([p()],vn.prototype,"roomPrefix",1);function LE(){const s=x("testwindowcount")||0;s&&s>0&&IE(s)}function IE(s){if(x("testwindow"))return null;const t=new URL(window.location.href);Dp(t.searchParams,BP,1),Dp(t.searchParams,"testwindow",1);const e=t.toString(),i=[];window.onbeforeunload=()=>{for(const c of i)c.close()};const n=.05,o=128;let a=0,l=0;for(let c=0;c<s;c++){a*o+o*.01>=window.innerWidth&&(l+=1,a=0);const d=a*(o*(1+n))+window.screenLeft,u=l*(o*(1+n))+window.screenTop+90+60*l;a+=1;const f=window.open(e,"test window "+c,`popup=yes width=${o} height=${o} top=${u} left=${d}`);if(!f){console.warn("Failed to open window");continue}i.push(f),f.onload=()=>{f.onbeforeunload=()=>{for(let m=0;m<i.length;m++){const g=i[m];g!==f&&g.close()}i.length=0}}}return i}class o_ extends D{awake(){LE()}}class r_ extends D{constructor(){super(...arguments);r(this,"transformsPerFrame",10);r(this,"interval",0);r(this,"useFlatbuffers",!0);r(this,"builder",null);r(this,"models",null)}awake(){if(this.useFlatbuffers)this.context.connection.beginListenBinary(Mc,e=>{});else{this.models=[];for(let e=0;e<this.transformsPerFrame;e++)this.models.push(new Vw(this.context.connection.connectionId+"_simulatedTransform_"+e,this))}}update(){if(this.context.connection.isConnected){if(this.useFlatbuffers){if(!this.context.connection.connectionId||this.context.time.frameCount%this.interval!==0)return;this.builder===null&&(this.builder=new oe.Builder(1024));const e=this.builder;for(let i=0;i<this.transformsPerFrame;i++){e.clear();const n=Rv(this.context.connection.connectionId,this);this.context.connection.sendBinary(n)}}else if(this.models)for(let e=0;e<this.models.length;e++){const i=this.models[e];i.dontSave=!0,i.update(this,null),this.context.connection.send("TestSimulateUserData-"+e,i)}}}}class Vw{constructor(t,e){r(this,"guid");r(this,"fast",!1);r(this,"position");r(this,"rotation");r(this,"velocity");r(this,"dontSave");this.guid=t,this.position={x:0,y:0,z:0},this.rotation={x:0,y:0,z:0,w:0},this.update(e,null)}isValid(){return this.fast!==void 0||this.position!==void 0||this.rotation!==void 0||this.velocity!==void 0}update(t,e){const i=t.worldPosition;this.position.x=i.x,this.position.y=i.y,this.position.z=i.z;const n=t.worldQuaternion;if(this.rotation.x=n.x,this.rotation.y=n.y,this.rotation.z=n.z,this.rotation.w=n.w,this.fast=!1,e){const o=e.getVelocity();this.velocity===void 0&&(this.velocity={x:0,y:0,z:0}),this.velocity.x=o.x,this.velocity.y=o.y,this.velocity.z=o.z}}}r(Vw,"temp",new h.Vector3);var jE=Object.defineProperty,BE=Object.getOwnPropertyDescriptor,ef=(s,t,e,i)=>{for(var n=i>1?void 0:i?BE(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&jE(t,e,n),n};const FE=x("debugsignals");class tf{constructor(){r(this,"guid")}}ef([p()],tf.prototype,"guid",2);class Ph{constructor(){r(this,"signal");r(this,"reaction")}}ef([p(tf)],Ph.prototype,"signal",2);ef([p(ge)],Ph.prototype,"reaction",2);var Rp;const is=(Rp=class extends D{constructor(){super(...arguments);r(this,"events")}static invoke(t){if(is.receivers[t]){const e=is.receivers[t];if(!e)return;for(const i of e)i.invoke(t)}}awake(){FE&&console.log("SignalReceiver awake",this)}onEnable(){if(this.events)for(const t of this.events)is.receivers[t.signal.guid]||(is.receivers[t.signal.guid]=[]),is.receivers[t.signal.guid].push(this)}onDisable(){if(this.events){for(const t of this.events)if(is.receivers[t.signal.guid]){const e=is.receivers[t.signal.guid].indexOf(this);e>=0&&is.receivers[t.signal.guid].splice(e,1)}}}invoke(t){if(!this.events||!Array.isArray(this.events))return;const e=typeof t=="object"?t.guid:t;for(const i of this.events)if(i.signal.guid===e)try{if(i.reaction){if(!i.reaction.invoke){console.warn("Missing invoke - possibly a serialization error",i,this);continue}}else{console.warn("Missing reaction for signal",i,this);continue}i.reaction.invoke()}catch(n){console.error(n)}}},r(Rp,"receivers",{}),Rp);let ll=is;ef([p(Ph)],ll.prototype,"events",2);var pi=(s=>(s.Activation="ActivationTrack",s.Animation="AnimationTrack",s.Audio="AudioTrack",s.Control="ControlTrack",s.Marker="MarkerTrack",s.Signal="SignalTrack",s))(pi||{}),On=(s=>(s[s.None=0]="None",s[s.Hold=1]="Hold",s[s.Loop=2]="Loop",s[s.PingPong=3]="PingPong",s[s.Continue=4]="Continue",s))(On||{}),a_=(s=>(s.Signal="SignalEmitter",s))(a_||{});const jn=x("debugtimeline");class Oh{constructor(){r(this,"director");r(this,"track")}get muted(){return this.track.muted}set muted(t){var e;t!==this.track.muted&&(this.track.muted=t,(e=this.onMuteChanged)==null||e.call(this))}*forEachClip(t=!1){var e;if((e=this.track)!=null&&e.clips)if(t)for(let i=this.track.clips.length-1;i>=0;i--)yield this.track.clips[i];else for(const i of this.track.clips)yield i}getClipTime(t,e){return e.clipIn+(t-e.start)*e.timeScale}getClipTimeNormalized(t,e){return(t-e.start)/e.duration}evaluateWeight(t,e,i,n=!0){if(e<0||e>=i.length)return 0;const o=i[e];if(n||t>=o.start&&t<=o.end){let a=1;const l=!1;if(o.easeInDuration>0){const c=Math.min((t-o.start)/o.easeInDuration,1);a*=c}if(o.easeOutDuration>0&&!l){const c=Math.min((o.end-t)/o.easeOutDuration,1);a*=c}return a}return 0}}class UE{constructor(t){r(this,"clip");r(this,"rootPositionOffset");r(this,"rootQuaternionOffset");r(this,"rootStartPosition");r(this,"rootEndPosition");r(this,"rootStartQuaternion");r(this,"rootEndQuaternion");const e=t.getClip();this.clip=e;const i=t.getRoot(),n=i.name+".position",o=i.name+".quaternion";jn&&console.log(e.name,e.tracks,n);for(const a of e.tracks)if(!(a.times.length<=0)){if(a.name.endsWith(n))this.rootStartPosition=new h.Vector3().fromArray(a.values,0),this.rootEndPosition=new h.Vector3().fromArray(a.values,a.values.length-3),this.rootPositionOffset=this.rootEndPosition.clone().sub(this.rootStartPosition),jn&&console.log(this.rootPositionOffset);else if(a.name.endsWith(o)&&(this.rootStartQuaternion=new h.Quaternion().fromArray(a.values,0),this.rootEndQuaternion=new h.Quaternion().fromArray(a.values,a.values.length-4),this.rootQuaternionOffset=this.rootEndQuaternion.clone().multiply(this.rootStartQuaternion),jn)){const l=new h.Euler().setFromQuaternion(this.rootQuaternionOffset);console.log("ROT",l)}}}get hasOffsets(){return this.rootPositionOffset!==void 0||this.rootQuaternionOffset!==void 0}}class nf extends Oh{constructor(){super(...arguments);r(this,"models",[]);r(this,"trackOffset");r(this,"target");r(this,"mixer");r(this,"clips",[]);r(this,"actions",[]);r(this,"weight",1);r(this,"_actionOffsets",[]);r(this,"_didBind",!1);r(this,"_animator",null);r(this,"_useclipOffsets",!0);r(this,"_totalOffsetPosition",new h.Vector3);r(this,"_totalOffsetRotation",new h.Quaternion);r(this,"_totalOffsetPosition2",new h.Vector3);r(this,"_totalOffsetRotation2",new h.Quaternion);r(this,"_summedPos",new h.Vector3);r(this,"_tempPos",new h.Vector3);r(this,"_summedRot",new h.Quaternion);r(this,"_tempRot",new h.Quaternion);r(this,"_clipRotQuat",new h.Quaternion)}onDisable(){var e;(e=this.mixer)==null||e.stopAllAction()}onDestroy(){this.director.context.animations.unregisterAnimationMixer(this.mixer)}onStateChanged(){this._animator&&Ty(this._animator.gameObject,this,this.director.isPlaying)}createHooks(e,i){var u,f;if(((u=i.tracks)==null?void 0:u.length)<=0){console.warn("No tracks in AnimationClip",i);return}const n=i.tracks[0].name.split("."),o=n[n.length-2],a=o+".position",l=o+".quaternion";let c=!1,d=!1;for(const m of i.tracks)m.name.endsWith(a)?(c=!0,this.createPositionInterpolant(i,e,m)):m.name.endsWith(l)&&(d=!0,this.createRotationInterpolant(i,e,m));if(!c||!d){const m=(f=this.mixer)==null?void 0:f.getRoot(),g=i.tracks[0],_=g.name.lastIndexOf("."),y=g.name.substring(0,_),b=y.substring(y.lastIndexOf(".")+1),v=m.getObjectByName(b);if(v)if(c){if(!d){const w=i.tracks[0].name.substring(0,_)+".quaternion";jn&&console.warn("Create quaternion track",b,v);const P=v.quaternion,k=new h.QuaternionKeyframeTrack(w,[0,i.duration],[P.x,P.y,P.z,P.w,P.x,P.y,P.z,P.w]);i.tracks.push(k),this.createRotationInterpolant(i,e,k)}}else{const w=y+".position";jn&&console.warn("Create position track",b,v);const P=v.position,k=new h.VectorKeyframeTrack(w,[0,i.duration],[P.x,P.y,P.z,P.x,P.y,P.z]);i.tracks.push(k),this.createPositionInterpolant(i,e,k)}}}bind(){if(!this._didBind){this._didBind=!0,jn&&console.log(this.models),this.mixer?this.target=this.mixer.getRoot():console.warn("No mixer was assigned to animation track");for(const e of this.actions){const i=new UE(e);this._actionOffsets.push(i)}this.target&&(this._animator=S.getComponent(this.target,xt)??null,this._animator&&Ty(this._animator.gameObject,this,!0));for(const e of this.models){const i=e.asset,n=i.position,o=i.rotation;n&&n.x!==void 0&&(n.isVector3||(i.position=new h.Vector3(n.x,n.y,n.z)),o.isQuaternion||(i.rotation=new h.Quaternion(o.x,o.y,o.z,o.w)))}this.ensureTrackOffsets()}}ensureTrackOffsets(){if(this.trackOffset){const e=this.trackOffset.position;e&&(e.isVector3||(this.trackOffset.position=new h.Vector3(e.x,e.y,e.z)));const i=this.trackOffset.rotation;i&&(i.isQuaternion||(this.trackOffset.rotation=new h.Quaternion(i.x,i.y,i.z,i.w)))}}evaluate(e){var c,d,u,f,m,g,_;if(this.track.muted||!this.mixer)return;this.bind(),this._totalOffsetPosition.set(0,0,0),this._totalOffsetRotation.set(0,0,0,1),this._totalOffsetPosition2.set(0,0,0),this._totalOffsetRotation2.set(0,0,0,1);let i=0,n=0,o=!1,a=!1,l=0;for(let y=0;y<this.clips.length;y++){const b=this.models[y],v=this.actions[y],w=b.asset;v.weight=0;const P=e>=b.start&&e<=b.end,k=b.preExtrapolationMode,O=b.postExtrapolationMode,M=y<this.clips.length-1?this.models[y+1]:null;let A=P,I=!1;if(!A&&!o&&b.end<e&&O!==On.None?(!M||M.start>e)&&(A=!0,o=!0):y==0&&!A&&!a&&b.start>e&&k!==On.None&&(!M||M.start<e)&&(A=!0,I=!0,a=!0),A){let T=this.weight;T*=this.evaluateWeight(e,y,this.models,A),T*=this.director.weight;let j=P;if(I)switch(k){case On.Hold:break;case On.Loop:e+=b.start,j=!0;break;default:e+=b.start,j=!0;break}let F=this.getClipTime(e,b),X=0;const E=w.duration;if(I&&k===On.Hold&&(F=0),j){if(w.loop)for(X+=Math.floor(F/(E+1e-6));F>E;)F-=E}else if(!P&&o)switch(O){case On.Hold:F=this.getClipTime(b.end,b);break;case On.Loop:F%=E;break;case On.PingPong:const G=Math.floor(F/E)%2!==0;F%=E,G&&(F=E-F);break}b.reversed===!0?v.time=v.getClip().duration-F:v.time=F,v.timeScale=0;const L=Math.max(0,T);if(v.weight=L,l+=L,v.clampWhenFinished=!1,v.isRunning()||v.play(),this._useclipOffsets){const V=i==0?this._totalOffsetPosition:this._totalOffsetPosition2,G=i==0?this._totalOffsetRotation:this._totalOffsetRotation2;i<1&&(n=1-T),i+=1;const K=this._summedPos.set(0,0,0),te=this._tempPos.set(0,0,0),ae=this._summedRot.identity(),Pe=this._tempRot.identity(),ft=w.rotation;ft&&(this._clipRotQuat.identity(),this._clipRotQuat.slerp(ft,T));const Xt=this._actionOffsets[y];if(Xt.hasOffsets)for(let Lt=0;Lt<X;Lt++)Xt.rootPositionOffset?te.copy(Xt.rootPositionOffset):te.set(0,0,0),te.applyQuaternion(ae),this._clipRotQuat&&te.applyQuaternion(this._clipRotQuat),Xt.rootQuaternionOffset&&(Pe.copy(Xt.rootQuaternionOffset),ae.multiply(Pe)),K.add(te);this._clipRotQuat&&G.multiply(this._clipRotQuat),G.multiply(ae),w.position&&K.add(w.position),V.add(K)}}}if(this._useclipOffsets&&(this._totalOffsetPosition.lerp(this._totalOffsetPosition2,n),this._totalOffsetRotation.slerp(this._totalOffsetRotation2,n)),this.__mixerError===void 0&&(jn||B())&&((d=(c=this._animator)==null?void 0:c.runtimeAnimatorController)!=null&&d.mixer)&&this.mixer!==((f=(u=this._animator)==null?void 0:u.runtimeAnimatorController)==null?void 0:f.mixer)&&(this.__mixerError=!0,console.error("AnimationTrack mixer is not shared with the animator controller - this might result in the timeline to not animate properly. Please report a bug to the Needle Engine team!",this)),(m=this._animator)!=null&&m.runtimeAnimatorController){const y=Math.max(0,1-l);(_=(g=this._animator)==null?void 0:g.runtimeAnimatorController)==null||_.update(y)}else this.mixer.update(e)}createRotationInterpolant(e,i,n){var c;const o=n.createInterpolant.bind(n),a=new h.Quaternion;this.ensureTrackOffsets();const l=(c=this.trackOffset)==null?void 0:c.rotation;n.createInterpolant=()=>{const d=o(),u=d.evaluate.bind(d);return d.evaluate=f=>{var g;const m=u(f);if(a.set(m[0],m[1],m[2],m[3]),a.premultiply(this._totalOffsetRotation),l&&a.premultiply(l),this.director.animationCallbackReceivers)for(const _ of this.director.animationCallbackReceivers)(g=_==null?void 0:_.onTimelineRotation)==null||g.call(_,this.director,this.target,f,a);return m[0]=a.x,m[1]=a.y,m[2]=a.z,m[3]=a.w,m},d}}createPositionInterpolant(e,i,n){var u,f;const o=n.createInterpolant.bind(n),a=new h.Vector3;this.ensureTrackOffsets();const l=(u=this.trackOffset)==null?void 0:u.rotation,c=(f=this.trackOffset)==null?void 0:f.position;let d;n.createInterpolant=()=>{const m=o(),g=m.evaluate.bind(m);return m.evaluate=_=>{var b,v,w;const y=g(_);if(a.set(y[0],y[1],y[2]),i.removeStartOffset&&(d===void 0?(d=null,d=(v=(b=this._actionOffsets.find(P=>P.clip===e))==null?void 0:b.rootStartPosition)==null?void 0:v.clone()):d!=null&&d.isVector3&&a.sub(d)),a.applyQuaternion(this._totalOffsetRotation),a.add(this._totalOffsetPosition),l&&a.applyQuaternion(l),c&&(a.x-=c.x,a.y+=c.y,a.z+=c.z),this.director.animationCallbackReceivers)for(const P of this.director.animationCallbackReceivers)(w=P==null?void 0:P.onTimelinePosition)==null||w.call(P,this.director,this.target,_,a);return y[0]=a.x,y[1]=a.y,y[2]=a.z,y},m}}}const zE=x("mutetimeline"),ga=class extends Oh{constructor(){super(...arguments);r(this,"models",[]);r(this,"listener");r(this,"audio",[]);r(this,"audioContextTimeOffset",[]);r(this,"lastTime",0);r(this,"audioSource");r(this,"_audioLoader",null);r(this,"_playableDirectorResumed",!1)}getAudioFilePath(e){const i=this.director.sourceId;return mo(i,e)}onAllowAudioChanged(e){for(let i=0;i<this.models.length;i++){const n=this.models[i];this.audio[i].setVolume(e?n.asset.volume:0)}}addModel(e){const i=new h.Audio(this.listener);this.audio.push(i);const n=e;n._didTriggerPlay=!1,this.models.push(n)}onDisable(){for(const e of this.audio)e.isPlaying&&e.stop();for(const e of this.models)e._didTriggerPlay=!1}onDestroy(){for(const e of this.audio)e.source&&(e==null||e.disconnect());this.audio.length=0}onMuteChanged(){if(this.muted)for(let e=0;e<this.audio.length;e++){const i=this.audio[e];i!=null&&i.isPlaying&&i.stop()}}stop(){for(let e=0;e<this.audio.length;e++){const i=this.audio[e];i!=null&&i.isPlaying&&i.stop()}for(const e of this.models)e._didTriggerPlay=!1}onPauseChanged(){for(let e=0;e<this.audio.length;e++){const i=this.audio[e];i!=null&&i.isPlaying&&i.stop()}this._playableDirectorResumed=this.director.isPlaying}evaluate(e){if(zE||this.track.muted||this.director.speed<0)return;const i=this.director.context.application.muted,n=this._playableDirectorResumed;this._playableDirectorResumed=!1;const o=i?.1:0;for(let a=0;a<this.models.length;a++){const l=this.models[a],c=this.audio[a],d=l.asset;if((!c||!c.buffer)&&this.isInTimeRange(l,e-1,e+1)&&this.handleAudioLoading(l,c),Ie.userInteractionRegistered!==!1&&!(c===null||!c.buffer))if(c.playbackRate=this.director.context.time.timeScale*this.director.speed,c.loop=d.loop,e>=l.start&&e<=l.end&&e<this.director.duration){if(!c.isPlaying||!this.director.isPlaying)(n||!l._didTriggerPlay&&this.lastTime<e)&&(l.duration*l.timeScale>.3?c.offset=l.clipIn+(e-l.start)*l.timeScale:c.offset=0,jn&&console.log("Timeline Audio ("+this.track.name+") play with offset "+c.offset+" - "+l.asset.clip),c.play(o),l._didTriggerPlay=!0);else{const f=l.clipIn+(e-l.start)*l.timeScale,m=c.context.currentTime-c._startedAt+c.offset;Math.abs(f-m)>.3&&(c.offset=f,c.stop(),c.play(o))}let u=d.volume;if(this.track.volume!==void 0&&(u*=this.track.volume),i&&(u=0),l.easeInDuration>0){const f=Math.min((e-l.start)/l.easeInDuration,1);u*=f}if(l.easeOutDuration>0){const f=Math.min((l.end-e)/l.easeOutDuration,1);u*=f}c.setVolume(u*this.director.weight)}else l._didTriggerPlay=!1,this.director.isPlaying&&c.isPlaying&&c.stop()}this.lastTime=e}loadAudio(e,i=0,n=0){let o=null;const a=e-n,l=e+i;for(const c of this.models)if(this.isInTimeRange(c,a,l)){const d=this.audio[this.models.indexOf(c)],u=this.handleAudioLoading(c,d);u!==null&&(o===null&&(o=[]),o.push(u))}return o!==null?Promise.all(o):null}isInTimeRange(e,i,n){return i<=e.start&&n>=e.end||i>=e.start&&i<=e.end||n>=e.start&&n<=e.end}static dispose(){ga._audioBuffers.clear()}handleAudioLoading(e,i){this._audioLoader||(this._audioLoader=new h.AudioLoader);const n=this.getAudioFilePath(e.asset.clip);if(ga._audioBuffers.get(n)){const a=ga._audioBuffers.get(n);return a.then(l=>{l&&i.setBuffer(l)}),a}jn&&console.warn("LOAD audio track",n,this.director.sourceId);const o=new Promise((a,l)=>{this._audioLoader.load(n,c=>{i.setBuffer(c),a(c)},void 0,c=>{console.error("Error loading audio",c),a(null)})});return ga._audioBuffers.set(n,o),o}};let or=ga;r(or,"_audioBuffers",new Map);class Ac extends Oh{constructor(){super(...arguments);r(this,"models",[]);r(this,"didTrigger",[]);r(this,"receivers",[])}evaluate(e){var n;if(this.track.muted)return;const i=this.director.context.time.deltaTime*1.5;for(let o=0;o<this.models.length;o++){const a=this.models[o],l=this.didTrigger[o],c=a.time-e;let d=!1;if(a.retroActive)d=c<=1e-6;else{const u=Math.abs(c);(u===0||u>=1e-5&&u<i)&&(d=!0)}if(d){if(!l)if(jn&&console.log("Trigger signal",e,a.time,a),this.didTrigger[o]=!0,((n=this.receivers)==null?void 0:n.length)<=0)ll.invoke(a.asset);else for(const u of this.receivers)u&&u.invoke(a.asset)}else a.emitOnce||(this.didTrigger[o]=!1)}}}class sf extends Oh{constructor(){super(...arguments);r(this,"models",[]);r(this,"timelines",[]);r(this,"_previousActiveModel",null)}resolveSourceObjects(e){for(let i=this.models.length-1;i>=0;i--){const o=this.models[i].asset;if(!o.sourceObject||typeof o.sourceObject!="object"){console.log("no source object, removing model",i,o),this.models.splice(i,1);continue}else{const a=S.getComponent(o.sourceObject,po);this.timelines.push(a),a&&o.updateDirector&&(a.playOnAwake=!1)}}}evaluate(e){var i;this._previousActiveModel=null;for(let n=0;n<this.models.length;n++){const o=this.models[n],a=o.asset;if(e>=o.start&&e<=o.end){this._previousActiveModel=o;const l=this.getClipTime(e,o);if(a.controlActivation){const c=a.sourceObject;c.visible=!0}if(a.updateDirector){const c=this.timelines[n];c&&(c.isPlaying&&c.pause(),c.time=l,c.evaluate())}}else{const l=(i=this._previousActiveModel)==null?void 0:i.asset;if(a.controlActivation){const c=a.sourceObject;(l==null?void 0:l.sourceObject)!==c&&(c.visible=!1)}}}}}var NE=Object.defineProperty,VE=Object.getOwnPropertyDescriptor,$w=(s,t,e,i)=>{for(var n=i>1?void 0:i?VE(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&NE(t,e,n),n};const Zn=x("debugtimeline");var kp;const vm=(kp=class extends D{constructor(){super(...arguments);r(this,"playableAsset");r(this,"playOnAwake");r(this,"extrapolationMode",1);r(this,"waitForAudio",!0);r(this,"_visibilityChangeEvt");r(this,"_clonedPlayableAsset",!1);r(this,"_speed",1);r(this,"_guidsMap");r(this,"_isPlaying",!1);r(this,"_internalUpdateRoutine");r(this,"_isPaused",!1);r(this,"_isStopping",!1);r(this,"_time",0);r(this,"_duration",0);r(this,"_weight",1);r(this,"_animationTracks",[]);r(this,"_audioTracks",[]);r(this,"_signalTracks",[]);r(this,"_controlTracks",[]);r(this,"_customTracks",[]);r(this,"_allTracks",[this._animationTracks,this._audioTracks,this._signalTracks,this._controlTracks,this._customTracks]);r(this,"animationCallbackReceivers",[])}static registerCreateTrack(t,e){this.createTrackFunctions[t]=e}get isPlaying(){return this._isPlaying}get isPaused(){return this._isPaused}get time(){return this._time}set time(t){typeof t=="number"&&!Number.isNaN(t)?this._time=t:(Zn||Ht())&&console.error("INVALID TIMELINE.TIME VALUE",t,this.name)}get duration(){return this._duration}set duration(t){this._duration=t}get weight(){return this._weight}set weight(t){this._weight=t}get speed(){return this._speed}set speed(t){this._speed=t}awake(){var t,e,i,n,o;Zn&&console.log(this,(t=this.playableAsset)==null?void 0:t.tracks),this.rebuildGraph(),!this.isValid()&&(Zn||B())&&(Zn?console.warn("PlayableDirector is not valid","Asset?",this.playableAsset,"Tracks:",(e=this.playableAsset)==null?void 0:e.tracks,"IsArray?",Array.isArray((i=this.playableAsset)==null?void 0:i.tracks),this):(o=(n=this.playableAsset)==null?void 0:n.tracks)!=null&&o.length?console.warn("PlayableDirector is not valid"):console.warn("PlayableDirector has no tracks"))}onEnable(){var t,e,i;for(const n of this._audioTracks)(t=n.onEnable)==null||t.call(n);for(const n of this._customTracks)(e=n.onEnable)==null||e.call(n);for(const n of this._animationTracks)(i=n.onEnable)==null||i.call(n);this.playOnAwake&&this.play(),this._visibilityChangeEvt||(this._visibilityChangeEvt=()=>{switch(document.visibilityState){case"hidden":this.setAudioTracksAllowPlaying(!1);break;case"visible":this.setAudioTracksAllowPlaying(!0);break}}),window.addEventListener("visibilitychange",this._visibilityChangeEvt)}onDisable(){var t,e,i;this.stop();for(const n of this._audioTracks)(t=n.onDisable)==null||t.call(n);for(const n of this._customTracks)(e=n.onDisable)==null||e.call(n);for(const n of this._animationTracks)(i=n.onDisable)==null||i.call(n);this._visibilityChangeEvt&&window.removeEventListener("visibilitychange",this._visibilityChangeEvt)}onDestroy(){var t;for(const e of this._allTracks)for(const i of e)(t=i.onDestroy)==null||t.call(i)}rebuildGraph(){this.isValid()&&(this.resolveBindings(),this.updateTimelineDuration(),this.setupAndCreateTrackHandlers())}async play(){if(!this.isValid())return;const t=this._isPaused==!0;if(this._isPaused=!1,!this._isPlaying){if(this._isPlaying=!0,t&&this.invokePauseChangedMethodsOnTracks(),this.waitForAudio){const e=[];for(const i of this._audioTracks){const n=i.loadAudio(this._time,1,0);n&&e.push(n)}if(e.length>0&&(await Promise.all(e),!this._isPlaying))return;for(;this._audioTracks.length>0&&this._isPlaying&&!Ie.userInteractionRegistered&&this.waitForAudio;)await un(200)}this.invokeStateChangedMethodsOnTracks(),this._internalUpdateRoutine=this.startCoroutine(this.internalUpdate(),ve.LateUpdate)}}pause(){this.isValid()&&(this._isPlaying=!1,!this._isPaused&&(this._isPaused=!0,this.internalEvaluate(),this.invokePauseChangedMethodsOnTracks(),this.invokeStateChangedMethodsOnTracks()))}stop(){this._isStopping=!0;for(const i of this._audioTracks)i.stop();const t=this._isPaused==!0,e=this._isPlaying;this._isPlaying&&(this._time=0,this._isPlaying=!1,this._isPaused=!1,this.internalEvaluate(),t&&this.invokePauseChangedMethodsOnTracks()),this._isPlaying=!1,this._isPaused=!1,t&&!e&&this.invokePauseChangedMethodsOnTracks(),e&&this.invokeStateChangedMethodsOnTracks(),this._internalUpdateRoutine&&this.stopCoroutine(this._internalUpdateRoutine),this._internalUpdateRoutine=null,this._isStopping=!1}evaluate(){this.internalEvaluate(!0)}isValid(){return this.playableAsset&&this.playableAsset.tracks&&Array.isArray(this.playableAsset.tracks)}*forEachTrack(){for(const t of this._allTracks)for(const e of t)yield e}get animationTracks(){return this._animationTracks}get audioTracks(){return this._audioTracks}resolveGuids(t){this._guidsMap=t}invokePauseChangedMethodsOnTracks(){var t;for(const e of this.forEachTrack())(t=e.onPauseChanged)==null||t.call(e)}invokeStateChangedMethodsOnTracks(){var t;for(const e of this.forEachTrack())(t=e.onStateChanged)==null||t.call(e,this._isPlaying)}*internalUpdate(){for(;this._isPlaying&&this.activeAndEnabled;)!this._isPaused&&this._isPlaying&&(this._time+=this.context.time.deltaTime*this.speed,this.internalEvaluate()),yield}internalEvaluate(t=!1){if(!this.isValid())return;let e=this._time;switch(this.extrapolationMode){case 0:this._speed>0?e=Math.min(e,this._duration):this._speed<0&&(e=Math.max(e,0)),this._time=e;break;case 1:e%=this._duration,this._time=e;break;case 2:if(e>this._duration){this.stop();return}break}const i=this._time;for(const n of this.playableAsset.tracks)if(!n.muted)switch(n.type){case pi.Activation:if(!t&&!this._isPlaying)continue;for(let o=0;o<n.outputs.length;o++){const a=n.outputs[o];if(typeof a=="object"){let l=!1;if(n.clips)for(const d of n.clips)d.start<=i&&i<=d.end&&(l=!0);const c=a;c.visible!==void 0&&c.visible!==l&&(c.visible=l,Zn&&console.warn(this.name,"set ActivationTrack-"+o,c.name,l,i))}}break}if(!this._isStopping)for(const n of this._animationTracks)n.evaluate(i);for(const n of this._audioTracks)n.evaluate(i);for(const n of this._signalTracks)n.evaluate(i);for(const n of this._controlTracks)n.evaluate(i);for(const n of this._customTracks)n.evaluate(i)}resolveBindings(){if(this._clonedPlayableAsset||(this._clonedPlayableAsset=!0,this.playableAsset=Fc(this.playableAsset)),!this.playableAsset||!this.playableAsset.tracks)return;const t=this.findRoot(this.gameObject);for(const e of this.playableAsset.tracks){for(let i=e.outputs.length-1;i>=0;i--){let n=e.outputs[i];if(typeof n=="string"){this._guidsMap&&this._guidsMap[n]&&(n=this._guidsMap[n]);const o=S.findByGuid(n,t);o===null||typeof o!="object"?(e.outputs.splice(i,1),console.warn("Failed to resolve binding",n,e.name,e.type)):(Zn&&console.log("Resolved binding",n,"to",o),e.outputs[i]=o)}else if(n===null){if(e.outputs.splice(i,1),vm.createTrackFunctions[e.type])continue;e.type!==pi.Audio&&e.type!==pi.Control&&e.type!==pi.Marker&&e.type!==pi.Signal&&console.warn("Missing binding",n,e.name,e.type,this.name,this.playableAsset.name)}}if(e.type===pi.Control&&e.clips)for(let i=0;i<e.clips.length;i++){const n=e.clips[i];let o=n.asset.sourceObject;if(typeof o=="string"){this._guidsMap&&this._guidsMap[o]&&(o=this._guidsMap[o]);const a=S.findByGuid(o,t);a===null||typeof a!="object"?console.warn("Failed to resolve sourceObject binding",o,e.name,n):(Zn&&console.log("Resolved binding",o,"to",a),n.asset.sourceObject=a)}}}}findRoot(t){return t.parent?this.findRoot(t.parent):t}updateTimelineDuration(){if(this._duration=0,!(!this.playableAsset||!this.playableAsset.tracks)){for(const t of this.playableAsset.tracks)if(t.muted!==!0){if(t.clips)for(const e of t.clips)e.end>this._duration&&(this._duration=e.end);if(t.markers)for(const e of t.markers)e.time>this._duration&&(this._duration=e.time+.001)}}}setupAndCreateTrackHandlers(){var e,i,n;if(this._animationTracks.length=0,this._audioTracks.length=0,this._signalTracks.length=0,!this.playableAsset)return;let t=S.findObjectOfType(us,this.context);for(const o of this.playableAsset.tracks){const a=o.type,l=vm.createTrackFunctions[a];if(l!=null){const c=l(this,o);if(typeof c.evaluate=="function"){c.director=this,c.track=o,this._customTracks.push(c);continue}}if(o.type===pi.Animation){if(!o.clips||o.clips.length<=0){Zn&&console.warn("Animation track has no clips",o);continue}for(let c=o.outputs.length-1;c>=0;c--){let d=o.outputs[c];if(d instanceof h.Object3D){const f=S.getOrAddComponent(d,xt);f&&(d=f)}const u=(e=d==null?void 0:d.gameObject)==null?void 0:e.animations;if(u){const f=new nf;f.trackOffset=o.trackOffset,f.director=this,f.track=o;for(let m=0;m<o.clips.length;m++){const g=o.clips[m],_=g.asset;if(!_){console.error(`Timeline ${this.name}: clip #${m} on track "${o.name}" has no animation data`);continue}const y=_.clip;let b=y;if((typeof b=="string"||typeof b=="number")&&(b=u.find(w=>w.name===y)),Zn&&console.log(_,y,"→",b),!b){console.warn("Could not find animationClip for model",g,o.name,this.name,(i=this.playableAsset)==null?void 0:i.name,u,d);continue}d instanceof xt&&d.runtimeAnimatorController&&(d.__internalDidAwakeAndStart||d.initializeRuntimeAnimatorController(),d.runtimeAnimatorController.mixer||d.runtimeAnimatorController.bind(d),f.mixer=d.runtimeAnimatorController.mixer),f.mixer||(f.mixer=new h.AnimationMixer(d.gameObject),this.context.animations.registerAnimationMixer(f.mixer)),f.clips.push(b),f.mixer.uncacheAction(b),f.createHooks(g.asset,b);const v=f.mixer.clipAction(b);f.actions.push(v),f.models.push(g)}this._animationTracks.push(f)}}}else if(o.type===pi.Audio){if(!o.clips||o.clips.length<=0)continue;const c=new or;c.director=this,c.track=o,c.audioSource=o.outputs.find(d=>d instanceof Ie),this._audioTracks.push(c),t||(t=(n=this.context.mainCameraComponent)==null?void 0:n.gameObject.addComponent(us)),c.listener=t.listener;for(let d=0;d<o.clips.length;d++){const u=o.clips[d];c.addModel(u)}}else if(o.type===pi.Marker){const c=new Ac;if(c.director=this,c.track=o,o.markers)for(const d of o.markers)switch(d.type){case a_.Signal:c.models.push(d),c.didTrigger.push(!1);break}if(c!==null&&c.models.length>0){const d=S.getComponent(this.gameObject,ll);d&&(c.receivers.push(d),this._signalTracks.push(c))}}else if(o.type===pi.Signal){const c=new Ac;if(c.director=this,c.track=o,o.markers)for(const d of o.markers)c.models.push(d),c.didTrigger.push(!1);for(const d of o.outputs)c.receivers.push(d);this._signalTracks.push(c)}else if(o.type===pi.Control){const c=new sf;if(c.director=this,c.track=o,o.clips)for(const d of o.clips)c.models.push(d);c.resolveSourceObjects(this.context),this._controlTracks.push(c)}}}setAudioTracksAllowPlaying(t){for(const e of this._audioTracks)e.onAllowAudioChanged(t)}registerAnimationCallback(t){this.animationCallbackReceivers.push(t)}unregisterAnimationCallback(t){const e=this.animationCallbackReceivers.indexOf(t);e!==-1&&this.animationCallbackReceivers.splice(e,1)}},r(kp,"createTrackFunctions",{}),kp);let po=vm;$w([p()],po.prototype,"playOnAwake",2);$w([p()],po.prototype,"extrapolationMode",2);var $E=Object.defineProperty,WE=Object.getOwnPropertyDescriptor,of=(s,t,e,i)=>{for(var n=i>1?void 0:i?WE(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&$E(t,e,n),n};class Ur extends D{constructor(){super(...arguments);r(this,"isGizmo",!1);r(this,"translationSnap",1);r(this,"rotationSnapAngle",15);r(this,"scaleSnap",.25);r(this,"_control");r(this,"orbit");r(this,"onControlChangedEvent",e=>{const i=this.orbit;if(i&&(i.enabled=!e.value),e.value){const n=S.getComponentInParent(this.gameObject,Un);n&&n.requestOwnership()}});r(this,"windowKeyDownListener",e=>{if(this.enabled&&this._control)switch(e.keyCode){case 81:this._control.setSpace(this._control.space==="local"?"world":"local");break;case 16:this.enableSnapping();break;case 87:this._control.setMode("translate");break;case 69:this._control.setMode("rotate");break;case 82:this._control.setMode("scale");break;case 187:case 107:this._control.setSize(this._control.size+.1);break;case 189:case 109:this._control.setSize(Math.max(this._control.size-.1,.1));break;case 88:this._control.showX=!this._control.showX;break;case 89:this._control.showY=!this._control.showY;break;case 90:this._control.showZ=!this._control.showZ;break;case 32:this._control.enabled=!this._control.enabled;break}});r(this,"windowKeyUpListener",e=>{if(this.enabled)switch(e.keyCode){case 16:this.disableSnapping();break}})}get control(){return this._control}onEnable(){var e;if(!(this.isGizmo&&!Hc)&&this.context.mainCamera&&(this._control||(this._control=new Y.TransformControls(this.context.mainCamera,this.context.renderer.domElement),this._control.enabled=!0,this._control.getRaycaster().layers.set(2),this._control.size=1,("_root"in this._control?this._control._root:this._control).traverse(n=>{const o=n;if(o.layers.set(2),o){const a=o.material;a&&(a.opacity=.3)}}),this.orbit=S.getComponentInParent(this.context.mainCamera,fe)??void 0),this._control)){const i=this._control.getHelper();this.context.scene.add(i),this._control.attach(this.gameObject),(e=this._control)==null||e.addEventListener("dragging-changed",this.onControlChangedEvent),window.addEventListener("keydown",this.windowKeyDownListener),window.addEventListener("keyup",this.windowKeyUpListener)}}onDisable(){var e,i,n;(i=(e=this._control)==null?void 0:e.getHelper())==null||i.removeFromParent(),(n=this._control)==null||n.removeEventListener("dragging-changed",this.onControlChangedEvent),window.removeEventListener("keydown",this.windowKeyDownListener),window.removeEventListener("keyup",this.windowKeyUpListener)}enableSnapping(){this._control&&(this._control.setTranslationSnap(this.translationSnap),this._control.setRotationSnap(h.MathUtils.degToRad(this.rotationSnapAngle)),this._control.setScaleSnap(this.scaleSnap))}disableSnapping(){this._control&&(this._control.setTranslationSnap(null),this._control.setRotationSnap(null),this._control.setScaleSnap(null))}}of([p()],Ur.prototype,"isGizmo",2);of([p()],Ur.prototype,"translationSnap",2);of([p()],Ur.prototype,"rotationSnapAngle",2);of([p()],Ur.prototype,"scaleSnap",2);var GE=Object.defineProperty,HE=Object.getOwnPropertyDescriptor,rf=(s,t,e,i)=>{for(var n=i>1?void 0:i?HE(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&GE(t,e,n),n};class l_{constructor(){r(this,"texture",null);r(this,"rect")}}rf([p(h.Texture)],l_.prototype,"texture",2);let cl=class extends dh{constructor(){super(...arguments);r(this,"_sprite");r(this,"pixelsPerUnitMultiplier",1)}set image(e){this.sprite||(this.sprite=new l_),this.sprite.texture=e,this.onAfterCreated()}get image(){return this.sprite?this.sprite.texture:null}get sprite(){return this._sprite}set sprite(e){this._sprite!==e&&(this._sprite=e,this.onAfterCreated())}isBuiltinSprite(){var i,n,o,a,l,c,d;const e=this.sprite;switch((i=e==null?void 0:e.texture)==null?void 0:i.name){case"InputFieldBackground":case"UISprite":case"Background":case"Knob":return!0}return!((o=(n=e==null?void 0:e.texture)==null?void 0:n.name)!=null&&o.length)&&((l=(a=e==null?void 0:e.texture)==null?void 0:a.image)==null?void 0:l.width)===32&&((d=(c=e==null?void 0:e.texture)==null?void 0:c.image)==null?void 0:d.height)===32}onBeforeCreate(e){var i,n;super.onBeforeCreate(e),this.isBuiltinSprite()&&(e.borderRadius=5/this.pixelsPerUnitMultiplier,((n=(i=this.sprite)==null?void 0:i.texture)==null?void 0:n.name)==="Knob"&&(e.borderRadius=999))}onAfterCreated(){var e;this.__didAwake&&(super.onAfterCreated(),!this.isBuiltinSprite()&&this.setTexture((e=this.sprite)==null?void 0:e.texture))}};rf([p(l_)],cl.prototype,"sprite",1);rf([p()],cl.prototype,"pixelsPerUnitMultiplier",2);class af extends dh{constructor(){super(...arguments);r(this,"_mainTexture")}get mainTexture(){return this._mainTexture}set mainTexture(e){this._mainTexture!==e&&(this._mainTexture=e,this.onAfterCreated())}onAfterCreated(){this.__didAwake&&(super.onAfterCreated(),this.setTexture(this.mainTexture))}}rf([p(h.Texture)],af.prototype,"mainTexture",1);var qE=Object.defineProperty,XE=Object.getOwnPropertyDescriptor,ki=(s,t,e,i)=>{for(var n=i>1?void 0:i?XE(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&qE(t,e,n),n};const Lo=x("debugbutton");class ko{constructor(){r(this,"colorMultiplier");r(this,"disabledColor");r(this,"fadeDuration");r(this,"highlightedColor");r(this,"normalColor");r(this,"pressedColor");r(this,"selectedColor")}}ki([p()],ko.prototype,"colorMultiplier",2);ki([p(me)],ko.prototype,"disabledColor",2);ki([p()],ko.prototype,"fadeDuration",2);ki([p(me)],ko.prototype,"highlightedColor",2);ki([p(me)],ko.prototype,"normalColor",2);ki([p(me)],ko.prototype,"pressedColor",2);ki([p(me)],ko.prototype,"selectedColor",2);class QE{constructor(){r(this,"disabledTrigger");r(this,"highlightedTrigger");r(this,"normalTrigger");r(this,"pressedTrigger");r(this,"selectedTrigger")}}class Rs extends D{constructor(){super(...arguments);r(this,"onClick",new ge);r(this,"_isHovered",0);r(this,"colors");r(this,"transition");r(this,"animationTriggers");r(this,"animator");r(this,"_interactable",!0);r(this,"_requestedAnimatorTrigger");r(this,"_isInit",!1);r(this,"_image")}click(){var e;(e=this.onClick)==null||e.invoke()}onPointerEnter(e){var n,o;const i=e.event.pointerType==="mouse"&&e.button===0;i&&(this._isHovered+=1),Lo&&console.warn("Button Enter",i,this._isHovered,(n=this.animationTriggers)==null?void 0:n.highlightedTrigger,this.animator),this.interactable&&(this.transition==3&&this.animationTriggers&&this.animator?this.animator.setTrigger(this.animationTriggers.highlightedTrigger):this.transition===1&&this.colors&&((o=this._image)==null||o.setState("hovered")),i&&this.context.input.setCursor("pointer"))}onPointerExit(){var e,i;this._isHovered-=1,this._isHovered<0&&(this._isHovered=0),Lo&&console.log("Button Exit",this._isHovered,(e=this.animationTriggers)==null?void 0:e.highlightedTrigger,this.animator),this.interactable&&(this._isHovered>0||(this._isHovered=0,this.transition==3&&this.animationTriggers&&this.animator?this.animator.setTrigger(this.animationTriggers.normalTrigger):this.transition===1&&this.colors&&((i=this._image)==null||i.setState("normal")),this.context.input.unsetCursor("pointer")))}onPointerDown(e){var i,n;Lo&&console.log("Button Down",(i=this.animationTriggers)==null?void 0:i.highlightedTrigger,this.animator),this.interactable&&(this.transition==3&&this.animationTriggers&&this.animator?this.animator.setTrigger(this.animationTriggers.pressedTrigger):this.transition===1&&this.colors&&((n=this._image)==null||n.setState("pressed")))}onPointerUp(e){var i,n;Lo&&console.warn("Button Up",(i=this.animationTriggers)==null?void 0:i.highlightedTrigger,this.animator,this._isHovered),this.interactable&&(this.transition==3&&this.animationTriggers&&this.animator?this.animator.setTrigger(this._isHovered?this.animationTriggers.highlightedTrigger:this.animationTriggers.normalTrigger):this.transition===1&&this.colors&&((n=this._image)==null||n.setState(this._isHovered?"hovered":"normal")))}onPointerClick(e){if(this.interactable&&!(e.button!==0&&e.event.pointerType===Cu.Mouse)&&(Lo&&(console.warn("Button Click",this.onClick),Te("CLICKED button "+this.name+" at "+this.context.time.frameCount)),this.onClick&&this.onClick.listenerCount>0&&(this.onClick.invoke(),e.use(),Lo))){const i=this.gameObject.worldPosition;i.add(this.gameObject.worldUp.multiplyScalar(1+Math.random()*.5)),N.DrawLabel(i,"CLICK:"+Date.now(),.1,1+Math.random()*.5)}}set interactable(e){this._interactable=e,this._image&&(this._image.setInteractable(e),e?this._image.setState("normal"):this._image.setState("disabled"))}get interactable(){return this._interactable}set_interactable(e){this.interactable=e}awake(){super.awake(),Lo&&console.log(this),this._isInit=!1,this.init()}start(){var e;(e=this._image)==null||e.setInteractable(this.interactable),this.gameObject.getComponentInParent(Ia)||this.gameObject.addComponent(Iu)}onEnable(){super.onEnable()}onDestroy(){this._isHovered&&this.context.input.unsetCursor("pointer")}*setAnimatorTriggerAtEndOfFrame(e){var i;this._requestedAnimatorTrigger=e,yield,yield,this._requestedAnimatorTrigger==e&&((i=this.animator)==null||i.setTrigger(e))}init(){this._isInit||(this._isInit=!0,this._image=S.getComponent(this.gameObject,cl),this._image&&(this.stateSetup(this._image),this.interactable?this._image.setState("normal"):this._image.setState("disabled")))}stateSetup(e){var g,_,y,b,v;e.setInteractable(this.interactable);const i=this.getFinalColor(e.color,(g=this.colors)==null?void 0:g.normalColor),n={state:"normal",attributes:{backgroundColor:i,backgroundOpacity:i.alpha}};e.setupState(n);const o=this.getFinalColor(e.color,(_=this.colors)==null?void 0:_.highlightedColor),a={state:"hovered",attributes:{backgroundColor:o,backgroundOpacity:o.alpha}};e.setupState(a);const l=this.getFinalColor(e.color,(y=this.colors)==null?void 0:y.pressedColor),c={state:"pressed",attributes:{backgroundColor:l,backgroundOpacity:l.alpha}};e.setupState(c);const d=this.getFinalColor(e.color,(b=this.colors)==null?void 0:b.selectedColor),u={state:"selected",attributes:{backgroundColor:d,backgroundOpacity:d.alpha}};e.setupState(u);const f=this.getFinalColor(e.color,(v=this.colors)==null?void 0:v.disabledColor),m={state:"disabled",attributes:{backgroundColor:f,backgroundOpacity:f.alpha}};e.setupState(m)}getFinalColor(e,i){return i?e.clone().multiply(i).convertLinearToSRGB():e.clone().convertLinearToSRGB()}}ki([p(ge)],Rs.prototype,"onClick",2);ki([p(ko)],Rs.prototype,"colors",2);ki([p()],Rs.prototype,"transition",2);ki([p(QE)],Rs.prototype,"animationTriggers",2);ki([p(xt)],Rs.prototype,"animator",2);ki([p()],Rs.prototype,"interactable",1);var YE=Object.defineProperty,KE=Object.getOwnPropertyDescriptor,lf=(s,t,e,i)=>{for(var n=i>1?void 0:i?KE(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&YE(t,e,n),n};const Us=x("debuginputfield");var Jr;const H=(Jr=class extends D{constructor(){super(...arguments);r(this,"textComponent");r(this,"placeholder");r(this,"onValueChanged");r(this,"onEndEdit");r(this,"inputEventFn");r(this,"_iosEventFn")}get text(){var t;return((t=this.textComponent)==null?void 0:t.text)??""}set text(t){this.textComponent&&(this.textComponent.text=t,this.placeholder&&(t.length>0?this.placeholder.gameObject.visible=!1:this.placeholder.gameObject.visible=!0))}get isFocused(){return H.active===this}start(){Us&&console.log(this.name,this)}onEnable(){var t;H.htmlField||(H.htmlField=document.createElement("input"),H.htmlField.style.width="0px",H.htmlField.style.height="0px",H.htmlField.style.padding="0px",H.htmlField.style.border="none",H.htmlField.style.overflow="hidden",H.htmlField.style.caretColor="transparent",H.htmlField.style.outline="none",H.htmlField.classList.add("ar"),H.htmlField.onfocus=()=>H.htmlFieldFocused=!0,H.htmlField.onblur=()=>H.htmlFieldFocused=!1,document.body.append(H.htmlField)),this.inputEventFn||(this.inputEventFn=this.onInput.bind(this)),H.htmlField.addEventListener("keyup",this.inputEventFn),this.placeholder&&((t=this.textComponent)!=null&&t.text.length)&&S.setActive(this.placeholder.gameObject,!1),exports.DeviceUtilities.isiOS()&&(this._iosEventFn=this.processInputOniOS.bind(this),window.addEventListener("click",this._iosEventFn))}onDisable(){var t;(t=H.htmlField)==null||t.removeEventListener("keyup",this.inputEventFn),this.onDeselected(),this._iosEventFn&&window.removeEventListener("click",this._iosEventFn)}clear(){H.active===this&&H.htmlField?(H.htmlField.value="",this.setTextFromInputField()):(this.textComponent&&(this.textComponent.text=""),this.placeholder&&S.setActive(this.placeholder.gameObject,!0))}select(){this.onSelected()}deselect(){this.onDeselected()}onPointerEnter(t){t.event.pointerType==="mouse"&&t.button===0&&this.context.input.setCursor("text")}onPointerExit(t){this.context.input.unsetCursor("text")}onPointerClick(t){Us&&console.log("CLICK",t,H.active),H.activeTime=this.context.time.time,H.active!==this&&this.startCoroutine(this.activeLoop(),ve.LateUpdate),this.selectInputField()}*activeLoop(){for(this.onSelected();H.active===this&&!(this.context.input.getPointerClicked(0)&&this.context.time.time-H.activeTime>.2);)this.setTextFromInputField(),yield;this.onDeselected()}onSelected(){var t,e,i,n;if(H.active!==this&&(Us&&console.log("Select",this.name,this,H.htmlField,this.context.isInXR,this.context.arOverlayElement,(t=this.textComponent)==null?void 0:t.text,(e=H.htmlField)==null?void 0:e.value),(i=H.active)==null||i.onDeselected(),H.active=this,this.placeholder&&S.setActive(this.placeholder.gameObject,!1),H.htmlField)){if(H.htmlField.value=((n=this.textComponent)==null?void 0:n.text)||"",Us&&console.log("set input field value",H.htmlField.value),this.context.isInXR){const o=this.context.arOverlayElement;o&&o.append(H.htmlField)}this.selectInputField()}}onDeselected(){var t;H.active===this&&(H.active=null,Us&&console.log("Deselect",this.name,this),H.htmlField&&(H.htmlField.blur(),document.body.append(H.htmlField)),this.placeholder&&(!this.textComponent||this.textComponent.text.length<=0)&&S.setActive(this.placeholder.gameObject,!0),H.htmlField&&((t=this.onEndEdit)==null||t.invoke(H.htmlField.value)))}update(){var t;H.active===this&&((t=this.textComponent)==null||t.markDirty())}onInput(t){var e,i;if(H.active===this){if(Us&&console.log(t.code,t,(e=H.htmlField)==null?void 0:e.value,(i=this.textComponent)==null?void 0:i.text),t.code==="Escape"||t.code==="Enter"){this.onDeselected();return}H.htmlField&&(this.textComponent&&(this.setTextFromInputField(),this.placeholder&&S.setActive(this.placeholder.gameObject,this.textComponent.text.length<=0)),this.selectInputField())}}setTextFromInputField(){var t;if(this.textComponent&&H.htmlField){const e=this.textComponent.text,i=H.htmlField.value,n=this.textComponent.text!==H.htmlField.value;this.textComponent.text=H.htmlField.value,n&&(Us&&console.log("[InputField] value changed:",i,e),(t=this.onValueChanged)==null||t.invoke(i,e))}}selectInputField(){H.htmlField&&(Us&&console.log("Focus Inputfield",H.htmlFieldFocused),H.htmlField.setSelectionRange(H.htmlField.value.length,H.htmlField.value.length),exports.DeviceUtilities.isiOS()?H.htmlField.focus({preventScroll:!0}):setTimeout(()=>{var t;return(t=H.htmlField)==null?void 0:t.focus()},1))}processInputOniOS(){const t=this.context.physics.raycast();if(!t.length)return;const i=t[0].object,n=fg(i);((n==null?void 0:n.gameObject)===this.gameObject||(n==null?void 0:n.gameObject.parent)===this.gameObject)&&this.selectInputField()}},r(Jr,"active",null),r(Jr,"activeTime",-1),r(Jr,"htmlField",null),r(Jr,"htmlFieldFocused",!1),Jr);let zr=H;lf([p(Tt)],zr.prototype,"textComponent",2);lf([p(Tt)],zr.prototype,"placeholder",2);lf([p(ge)],zr.prototype,"onValueChanged",2);lf([p(ge)],zr.prototype,"onEndEdit",2);var ZE=Object.defineProperty,JE=Object.getOwnPropertyDescriptor,Ww=(s,t,e,i)=>{for(var n=i>1?void 0:i?JE(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&ZE(t,e,n),n};class Mh extends D{constructor(){super(...arguments);r(this,"id",null);r(this,"keepAspect",!1);r(this,"_object",null)}onEnable(){if(this._object){this.gameObject.add(this._object);return}if(!this.id||!this.context.mainCamera)return;const e=document.getElementById(this.id);if(!e){console.warn('Could not find element with id "'+this.id+'"');return}e.style.display="block",e.style.visibility="hidden";const i=new Y.InteractiveGroup;i.listenToPointerEvents(this.context.renderer,this.context.mainCamera),this.gameObject.add(i);const n=new Y.HTMLMesh(e);i.add(n),n.visible=!1;const o=n.material;o.transparent=!0,setTimeout(()=>{n.visible=!0;const a=Nc(this.gameObject).clone();Vc(this.gameObject,0,0,0),this.gameObject.updateMatrixWorld();const l=new h.Box3;l.setFromObject(i),this.setWorldRotation(a.x,a.y,a.z);const c=l.max.x-l.min.x,d=l.max.y-l.min.y;if(this.keepAspect){const f=c/d;c>d?n.scale.set(1/c,1/d/f,1):n.scale.set(1/c*f,1/d,1)}else n.scale.set(1/c,1/d,1);const u=this.gameObject.scale;n.scale.multiply(u)},1)}onDisable(){var e;(e=this._object)==null||e.removeFromParent()}}Ww([p()],Mh.prototype,"id",2);Ww([p()],Mh.prototype,"keepAspect",2);var eT=Object.defineProperty,tT=Object.getOwnPropertyDescriptor,cf=(s,t,e,i)=>{for(var n=i>1?void 0:i?tT(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&eT(t,e,n),n},Ep;const Gw=(Ep=class extends D{constructor(){super(...arguments);r(this,"target");r(this,"invertForward",!1);r(this,"keepUpDirection",!0);r(this,"copyTargetRotation",!1)}onBeforeRender(){let t=this.target;if(t||(t=this.context.mainCamera),!t)return;let e=this.copyTargetRotation;(this.context.isInVR||this.context.isInPassThrough)&&(e=!1),zc(this.gameObject,t,this.keepUpDirection,e),this.invertForward&&this.gameObject.quaternion.multiply(Gw.flipYQuat)}createBehaviours(t,e,i){if(e.uuid===this.gameObject.uuid){let n=e;if(this.keepUpDirection){const a=bt.createEmptyParent(e);n=a;const l=this.invertForward?-1:1;a.setMatrix(a.getMatrix().multiply(new h.Matrix4().makeRotationZ(Math.PI/2*l))),e.setMatrix(e.getMatrix().multiply(new h.Matrix4().makeRotationZ(-Math.PI/2*l)))}const o=new ct("lookat "+this.name,wt.sceneStartTrigger(),de.lookAtCameraAction(n,void 0,this.invertForward?zi.back:zi.forward,this.keepUpDirection?zi.up:zi.zero));t.addBehavior(o)}}},r(Ep,"flipYQuat",new h.Quaternion().setFromAxisAngle(new h.Vector3(0,1,0),Math.PI)),Ep);let Nr=Gw;cf([p(h.Object3D)],Nr.prototype,"target",2);cf([p()],Nr.prototype,"invertForward",2);cf([p()],Nr.prototype,"keepUpDirection",2);cf([p()],Nr.prototype,"copyTargetRotation",2);var iT=Object.defineProperty,nT=Object.getOwnPropertyDescriptor,c_=(s,t,e,i)=>{for(var n=i>1?void 0:i?nT(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&iT(t,e,n),n};class hl extends D{constructor(){super(...arguments);r(this,"url");r(this,"mode",0);r(this,"clickable",!0)}async open(){if(!this.url){console.warn("OpenURL: URL is not set, can't open.",this);return}this._validateUrl();let e=this.url;switch(!e.startsWith("mailto:")&&e.includes("@")&&(e="mailto:"+e),B()&&Te("Open URL: "+e),this.mode){case 0:exports.DeviceUtilities.isSafari(),globalThis.open(e,"_blank");break;case 1:exports.DeviceUtilities.isSafari()&&exports.DeviceUtilities.isiOS()?globalThis.open(e,"_top"):globalThis.open(e,"_self");break;case 2:exports.DeviceUtilities.isSafari()?globalThis.open(e,"_top"):globalThis.open(e,"_new");break}}start(){this.gameObject.getComponentInParent(Ci)||this.gameObject.addComponent(Ci)}onPointerEnter(e){!e.used&&this.clickable&&this.context.input.setCursor("pointer")}onPointerExit(){this.clickable&&this.context.input.unsetCursor("pointer")}onPointerClick(e){var i;this.clickable&&!e.used&&((i=this.url)!=null&&i.length)&&this.open()}_validateUrl(){this.url&&this.url.startsWith("www.")&&(B()&&console.warn("URL is not valid, adding https:// to the start of the URL",this.url),this.url="https://"+this.url)}}c_([p()],hl.prototype,"url",2);c_([p()],hl.prototype,"mode",2);c_([p()],hl.prototype,"clickable",2);var sT=Object.defineProperty,oT=Object.getOwnPropertyDescriptor,dl=(s,t,e,i)=>{for(var n=i>1?void 0:i?oT(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&sT(t,e,n),n};class ks extends D{constructor(){super(...arguments);r(this,"side","none");r(this,"controller",!0);r(this,"hands",!1);r(this,"controlVisibility",!0);r(this,"useGripSpace",!1);r(this,"resetTransformAfterXRSession",!0);r(this,"_startPosition",new h.Vector3);r(this,"_startRotation",new h.Quaternion);r(this,"_startScale",new h.Vector3)}get activeAndEnabled(){return!0}onEnterXR(e){this._startPosition.copy(this.gameObject.position),this._startRotation.copy(this.gameObject.quaternion),this._startScale.copy(this.gameObject.scale)}onUpdateXR(e){if(!this.enabled)return;const i=e.xr.getController(this.side);if(i){if(i.hand&&!this.hands){this.controlVisibility&&(this.gameObject.visible=!1);return}else if(!this.controller){this.controlVisibility&&(this.gameObject.visible=!1);return}this.controlVisibility&&(this.gameObject.visible=!0),this.useGripSpace||i.targetRayMode==="transient-pointer"?(this.gameObject.worldPosition=i.gripWorldPosition,this.gameObject.worldQuaternion=i.gripWorldQuaternion,this.gameObject.worldScale=$(i.xr.rigScale,i.xr.rigScale,i.xr.rigScale).multiply(this._startScale)):(this.gameObject.worldPosition=i.rayWorldPosition,this.gameObject.worldQuaternion=i.rayWorldQuaternion,this.gameObject.worldScale=$(i.xr.rigScale,i.xr.rigScale,i.xr.rigScale).multiply(this._startScale))}}onLeaveXR(e){this.resetTransformAfterXRSession&&(this.gameObject.position.copy(this._startPosition),this.gameObject.quaternion.copy(this._startRotation),this.gameObject.scale.copy(this._startScale))}}dl([p()],ks.prototype,"side",2);dl([p()],ks.prototype,"controller",2);dl([p()],ks.prototype,"hands",2);dl([p()],ks.prototype,"controlVisibility",2);dl([p()],ks.prototype,"useGripSpace",2);dl([p()],ks.prototype,"resetTransformAfterXRSession",2);function Hw(s,t){const e=s.xr.getFrame();if(!e)return console.warn("No XRFrame available"),!1;const i=e.session.enabledFeatures;if(i&&!i.some(o=>o==="camera-access"))return console.error(`No camera feed available - please request the 'camera-access' feature before starting WebXR or add the ARCameraBackground component to your scene.

Example to request camera-access in global scope:
NeedleXRSession.onSessionRequestStart(evt => {
    evt.init.optionalFeatures = evt.init.optionalFeatures || [];
    evt.init.optionalFeatures.push('camera-access');
});
`),B()&&$c("No camera feed available - please request the 'camera-access' feature before starting WebXR or add the ARCameraBackground component to your scene"),!1;const n=e.getViewerPose(s.xr.getReferenceSpace());if(n)for(const o of n.views)if("camera"in o&&o.camera){let a=s.xr.getBinding();if(a||(a=new XRWebGLBinding(e.session,s.getContext())),a){let l=null;if("getCameraImage"in a){rT(s,t);const c=s.properties.get(t);if(c)return l=a.getCameraImage(o.camera),c.__webglTexture=l,!0;console.warn("No texture properties found for target texture")}}else console.error(o.camera,s.xr)}else console.error("NO CAMERA IN VIEW");else console.error(s.xr.getReferenceSpace(),e);return!1}const yb=new WeakMap;function rT(s,t){const e=yb.get(t)||new WeakSet;if(e.has(s))return;e.add(s),yb.set(t,e),console.debug("Initialize texture for camera feed");const i=new h.MeshBasicMaterial,n=new h.PlaneGeometry,o=new h.Scene;o.add(new h.Mesh(n,i));const a=new h.PerspectiveCamera;i.map=t,s.render(o,a)}function aT(s,t,e,i="image/webp",n){return h_({context:s,width:t,height:e,mimeType:i,camera:n})}function h_(s){var O,M;s||(s={});const{transparent:t=!1}=s;let{mimeType:e,context:i,width:n,height:o,camera:a}=s;if(!i&&(i=ce.Current,!i))return console.error("Can not save screenshot: No needle-engine context found or provided."),null;if(!a&&(a=i.mainCamera,!a))return console.error("No camera found"),null;const l=i.renderer,c=l.xr.enabled;if(c&&i.currentFrameEvent!=ve.EarlyUpdate)return console.warn("Screenshot: defer to access XR frame"),new Promise(I=>{bs(T=>{const j=h_(s);I(j)},ve.EarlyUpdate,{once:!0})});const d=l.domElement,u=d.width,f=d.height;n||(n=u),o||(o=f);const m=n,g=o,_=window.devicePixelRatio||1;n/=_,o/=_,l.xr.isPresenting&&l.xr.getFrame();const y=l.xr.enabled;l.xr.enabled=!1,l.xr.isPresenting=!1,d.style.width=`${n}px`,d.style.height=`${o}px`;const b=l.getRenderTarget(),v=l.getClearColor(new h.Color),w=l.getClearAlpha(),P=i.scene.background,k="aspect"in a?a.aspect:null;try{const A=s.render_events!==!1,I=new Array;A&&(Fa(i.scene,ze,I),I.forEach(E=>{var L;if(E==null||E.onBeforeRender(),E.isInstancingActive&&E.instances)for(let V=0;V<((L=E.instances)==null?void 0:L.length);V++){const G=E.instances[V];cs(G.object,!0)}})),t&&(i.scene.background=null,l.setClearColor(0,0)),s.background&&(i.scene.background=null,l.setClearColor(s.background),s.background instanceof me&&l.setClearAlpha(s.background.a)),t&&l.setClearAlpha(0),l.setSize(n,o,!1),"cam"in a&&(a=a.threeCamera),a instanceof h.PerspectiveCamera&&(a.aspect=n/o,a.updateProjectionMatrix());const T="type"in s&&s.type==="texture";let j=null;T&&(j=new h.WebGLRenderTarget(n,o,{wrapS:h.MirroredRepeatWrapping,wrapT:h.MirroredRepeatWrapping,format:1023}),l.setRenderTarget(j));let F=d;if(c?(j&&console.error('Taking XR screenshots with { type: "texture" } is currently not supported.'),F=exports.InternalScreenshotUtils.compositeWithCameraImage({width:m,height:g,scene:i.scene,camera:a,renderer:l})):i.renderNow(a||null),a instanceof h.PerspectiveCamera&&k!=null&&(a.aspect=k,a.updateProjectionMatrix()),A&&I.forEach(E=>E.onAfterRender()),!e&&"download_filename"in s&&s.download_filename)switch((O=s.download_filename.split(".").pop())==null?void 0:O.toLowerCase()){case"png":e="image/png";break;case"jpg":case"jpeg":e="image/jpeg";break;case"webp":e="image/webp";break}if(t&&s.trim===!0){const E=lT(F);E&&(F=E)}if("type"in s){if(s.type==="texture")return j?(s.target&&(s.target.image=j==null?void 0:j.texture.image,s.target.needsUpdate=!0),j.texture.offset.set(0,-1),j.texture.needsUpdate=!0,j.texture):(console.error("No target texture found"),null);if(s.type==="blob")return new Promise((L,V)=>{F.toBlob(G=>{L(G)},e)});if(s.type==="share")return new Promise((L,V)=>{F.toBlob(G=>{if(G&&"share"in navigator){let K="file_type"in s&&s.file_type||e;e||(K="image/png");const te=(K==null?void 0:K.split("/")[1])||"png",ae=new File([G],"filename"in s?s.filename||`screenshot.${te}`:`screenshot.${te}`,{type:K});return navigator.share({title:"title"in s?s.title:void 0,text:"text"in s?s.text:void 0,url:"url"in s?s.url:void 0,files:[ae]}).catch(Pe=>{console.warn("User cancelled share",Pe.message)}).finally(()=>{L({blob:G,shared:!0})})}return{blob:G,shared:!1}},e)})}const X=F.toDataURL(e);if("download_filename"in s&&s.download_filename){let E=s.download_filename;if(exports.DeviceUtilities.isMobileDevice()&&typeof window<"u"){const L=E+"_screenshots",V=E.split("."),G=(M=V.pop())==null?void 0:M.toLowerCase();let K=0;localStorage.getItem(L)&&(K=parseInt(sessionStorage.getItem(L)||"0")),K>0&&(E=`${V.join()}-${K}.${G}`),K+=1,sessionStorage.setItem(L,K.toString())}qw(X,E)}return X}finally{l.setRenderTarget(b),i.scene.background=P,l.setSize(u,f,!1),l.setClearColor(v,w),k!=null&&a instanceof h.PerspectiveCamera&&(a.aspect=k,a.updateProjectionMatrix()),l.xr.enabled=y,l.xr.isPresenting=c,c||i.updateSize(!0)}return null}function lT(s){if(!("document"in globalThis))return null;const t=document.createElement("canvas");t.width=s.width,t.height=s.height;const e=t.getContext("2d");if(!e)return null;e.drawImage(s,0,0);const i=t.width,n=t.height,a=e.getImageData(0,0,i,n).data;let l=n,c=i,d=0,u=0;for(let y=0;y<n;y++)for(let b=0;b<i;b++){const v=(y*i+b)*4;a[v+3]!==0&&(b<c&&(c=b),b>u&&(u=b),y<l&&(l=y),y>d&&(d=y))}const f=u-c+1,m=d-l+1,g=document.createElement("canvas"),_=g.getContext("2d");return _?(g.width=f,g.height=m,_.drawImage(t,c,l,f,m,0,0,f,m),g):null}let Ol=null;function qw(s,t){if(s){if(!s.startsWith("data:image")){console.error("Can not save image: Data url is not an image",s);return}Ol||(Ol=document.createElement("a")),Ol.href=s,Ol.download=t,Ol.click()}}exports.InternalScreenshotUtils=void 0;(s=>{let t=null,e=null,i=null,n=null,o=null;function a(d){const{renderer:u,width:f,height:m}=d,g=u.xr.enabled,_=u.getRenderTarget(),y=u.autoClear,b=f,v=m,w=f/m;(!i||i.width!==b||i.height!==v)&&(i??(i=new h.WebGLRenderTarget(b,v,{colorSpace:h.SRGBColorSpace})),i.width=b,i.height=v,i.samples=4,i.texture.repeat.y=-1,i.texture.offset.y=1),(!o||o.width!==b||o.height!==v)&&(o=document.createElement("canvas"),o.width=b,o.height=v,o.style.position="fixed",o.style.top="0px",o.style.right="0px",o.style.width="300px",o.style.height=`${300/w}px`,o.style.zIndex="1000",o.style.pointerEvents="none",o.style.opacity="1.0",o.style.willChange="contents"),t||(t=c({defines:{DECODE_VIDEO_TEXTURE:!0}})),e||(e=c()),n||(n=new h.Texture),u.xr.updateCamera(d.camera),u.xr.enabled=!1,u.autoClear=!1,u.clear(),u.setSize(b,v),u.setRenderTarget(i),Hw(d.renderer,n)||console.error("Could not update texture from XR frame");const k=S.findObjectOfType(Rh);return k?k.setTexture(n):(t.setTexture(n),u.render(t,d.camera)),u.clearDepth(),u.setSize(b,v),u.render(d.scene,d.camera),u.setRenderTarget(null),e.setTexture(i.texture),u.render(e,d.camera),o.getContext("2d",{alpha:!1}).drawImage(u.domElement,0,0,o.width,o.height),u.setRenderTarget(_),u.xr.enabled=g,u.autoClear=y,o}s.compositeWithCameraImage=a;const l=`
uniform sampler2D t2D;
varying vec2 vUv;

void main() {

    vec4 texColor = texture2D( t2D, vUv );

    #ifdef DECODE_VIDEO_TEXTURE

        // inline sRGB decode (TODO: Remove this code when https://crbug.com/1256340 is solved)
        texColor = vec4( mix( pow( texColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), texColor.rgb * 0.0773993808, vec3( lessThanEqual( texColor.rgb, vec3( 0.04045 ) ) ) ), texColor.w );

    #endif

    gl_FragColor = texColor;
    #include <tonemapping_fragment>
    #include <colorspace_fragment>
}
`;function c(d){const u=(d==null?void 0:d.material)||new h.ShaderMaterial({name:"BackgroundMaterial",uniforms:h.UniformsUtils.clone(h.ShaderLib.background.uniforms),vertexShader:h.ShaderLib.background.vertexShader,fragmentShader:l,defines:d==null?void 0:d.defines,side:h.FrontSide,depthTest:!1,depthWrite:!1,fog:!1});Object.defineProperty(u,"map",{get:function(){return this.threeTexture}});const f=new h.Mesh(new h.PlaneGeometry(2,2),u);return Ad(f,!1),f.geometry.deleteAttribute("normal"),f.renderOrder=-1e6,f.setTexture=function(m){u.uniforms.t2D.value=m},f}s.makeFullscreenPlane=c})(exports.InternalScreenshotUtils||(exports.InternalScreenshotUtils={}));var cT=Object.defineProperty,hT=Object.getOwnPropertyDescriptor,dT=(s,t,e,i)=>{for(var n=i>1?void 0:i?hT(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&cT(t,e,n),n};const bb=x("debugarcamera");class Rh extends D{constructor(){super(...arguments);r(this,"backgroundTint",new me(1,1,1,1));r(this,"backgroundPlane");r(this,"threeTexture");r(this,"forceTextureInitialization",function(){const e=new h.MeshBasicMaterial,i=new h.PlaneGeometry,n=new h.Scene;n.add(new h.Mesh(i,e));const o=new h.PerspectiveCamera;return function(l,c){e.map=c,l.render(n,o),bb&&console.warn("Force texture initialization")}}());r(this,"preRender",()=>{if(!this||!this.gameObject)return;if(this.context.renderer.xr.getFrame()){if(!this.threeTexture&&this.context.renderer&&(this.threeTexture=new h.Texture,this.forceTextureInitialization(this.context.renderer,this.threeTexture)),this.backgroundPlane===void 0){const n=this.backgroundTint;this.backgroundPlane=exports.InternalScreenshotUtils.makeFullscreenPlane({material:new h.ShaderMaterial({name:"BackgroundMaterial",uniforms:{...h.UniformsUtils.clone(h.ShaderLib.background.uniforms),tint:{value:new h.Vector4(n.r,n.g,n.b,n.a)}},vertexShader:h.ShaderLib.background.vertexShader,fragmentShader:uT,side:h.DoubleSide,depthTest:!1,depthWrite:!1,fog:!1})})}this.backgroundPlane.parent!==this.scene&&this.scene.add(this.backgroundPlane),this.backgroundPlane.material instanceof h.ShaderMaterial&&this.backgroundPlane.material.uniforms.tint.value.set(this.backgroundTint.r,this.backgroundTint.g,this.backgroundTint.b,this.backgroundTint.a),this.updateFromFrame()}})}onBeforeXR(e,i){e==="immersive-ar"&&(i.optionalFeatures=i.optionalFeatures||[],i.optionalFeatures.push("camera-access"),bb&&console.warn("Requesting camera-access"))}onEnterXR(e){e.xr.mode==="immersive-ar"&&(this.backgroundPlane&&(this.context.scene.add(this.backgroundPlane),this.backgroundPlane.visible=!1),this.backgroundPlane&&this.context.scene.add(this.backgroundPlane),this.context.pre_render_callbacks.push(this.preRender))}onLeaveXR(e){this.backgroundPlane&&this.backgroundPlane.removeFromParent();const i=this.context.pre_render_callbacks.indexOf(this.preRender);i>=0&&this.context.pre_render_callbacks.splice(i,1)}get background(){return this.backgroundPlane}onBeforeRender(e){this.updateFromFrame()}updateFromFrame(){var e;this.threeTexture&&((e=this.context.xr)==null?void 0:e.mode)==="immersive-ar"&&(Hw(this.context.renderer,this.threeTexture),this.setTexture(this.threeTexture))}setTexture(e){this.backgroundPlane&&(this.threeTexture=e,this.backgroundPlane.setTexture(this.threeTexture),this.backgroundPlane.visible=!0)}}dT([p(me)],Rh.prototype,"backgroundTint",2);const uT=`
uniform sampler2D t2D;
uniform vec4 tint;

varying vec2 vUv;

void main() {

    vec4 texColor = texture2D( t2D, vUv );
    texColor.w = 1.0;

    // inline sRGB decode
    texColor = vec4( mix( pow( texColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), texColor.rgb * 0.0773993808, vec3( lessThanEqual( texColor.rgb, vec3( 0.04045 ) ) ) ), texColor.w );

    gl_FragColor = texColor * tint;

    #include <tonemapping_fragment>
    #include <colorspace_fragment>
}
`;var fT=Object.defineProperty,pT=Object.getOwnPropertyDescriptor,Eo=(s,t,e,i)=>{for(var n=i>1?void 0:i?pT(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&fT(t,e,n),n};const vb=x("debugimagetracking"),_u=class{constructor(t,e,i,n,o,a){r(this,"measuredSize");r(this,"state");r(this,"_position");r(this,"_rotation");r(this,"_trackingComponent");r(this,"_trackedImage");r(this,"_bitmap");r(this,"_pose");this._trackingComponent=t,this._trackedImage=e,this._bitmap=i,this.measuredSize=n,this.state=o,this._pose=a}get url(){return this._trackedImage.image??""}get widthInMeters(){return this._trackedImage.widthInMeters??void 0}get bitmap(){return this._bitmap}get model(){return this._trackedImage}getPosition(t){return this.ensureTransformData(),t.copy(this._position),t}getQuaternion(t){return this.ensureTransformData(),t.copy(this._rotation),t}applyToObject(t,e=void 0){this.ensureTransformData();const i=t.position.distanceToSquared(this._position)/.05+t.quaternion.angleTo(this._rotation)/.05;e&&(e*=Math.max(1,i)),e===void 0||e>=1?(t.position.copy(this._position),t.quaternion.copy(this._rotation)):(e=Math.max(0,Math.min(1,e)),t.position.lerp(this._position,e),t.quaternion.slerp(this._rotation,e))}ensureTransformData(){if(!this._position){this._position=_u._positionBuffer.get(),this._rotation=_u._rotationBuffer.get();const t=this._pose.transform,e=q.active.convertSpace(t);this._position.copy(e==null?void 0:e.position),this._rotation.copy(e==null?void 0:e.quaternion)}}};let Ho=_u;r(Ho,"_positionBuffer",new xi(()=>new h.Vector3,20)),r(Ho,"_rotationBuffer",new xi(()=>new h.Quaternion,20));class Es{constructor(){r(this,"image");r(this,"widthInMeters",.25);r(this,"object");r(this,"createObjectInstance",!1);r(this,"imageDoesNotMove",!1);r(this,"hideWhenTrackingIsLost",!0)}}Eo([p(URL)],Es.prototype,"image",2);Eo([p()],Es.prototype,"widthInMeters",2);Eo([p(ee)],Es.prototype,"object",2);Eo([p()],Es.prototype,"createObjectInstance",2);Eo([p()],Es.prototype,"imageDoesNotMove",2);Eo([p()],Es.prototype,"hideWhenTrackingIsLost",2);class mT{constructor(t,e,i){r(this,"filename");r(this,"widthInMeters");r(this,"imageData");this.filename=t,this.imageData=e,this.widthInMeters=i}get extensionName(){return"image-tracking"}onAfterHierarchy(t,e){const i=exports.DeviceUtilities.getiOSVersion(),a=(i?parseInt(i.split(".")[0]):18)>=18?1:100;e.beginBlock('def Preliminary_ReferenceImage "AnchoringReferenceImage"'),e.appendLine("uniform asset image = @image_tracking/"+this.filename+"@"),e.appendLine("uniform double physicalWidth = "+(this.widthInMeters*a).toFixed(8)),e.closeBlock()}onBeforeBuildDocument(t){const e=S.findObjectOfType(pr);!e||!e.trackedImages||e.trackedImages.length>1&&(B()&&pe("USDZ: Only one tracked image is supported."),console.warn("USDZ: Only one tracked image is supported."))}onAfterSerialize(t){t.files["image_tracking/"+this.filename]=this.imageData}onExportObject(t,e,i){var o;const n=S.findObjectOfType(pr);if(!(!n||!n.trackedImages)){for(const a of n.trackedImages)if(((o=a.object)==null?void 0:o.asset)===t){const l=S.findObjectOfType(Le);if(!l)continue;const{scale:c,target:d}=l.getARScaleAndTarget();let u=t;const f=new h.Matrix4;if(t!==d)for(;u.parent&&u.parent!==d;)u=u.parent,f.premultiply(u.matrix);const m=f.clone().invert();e.setMatrix(m.scale(new h.Vector3(c,c,c)));break}}}}var Tp;const Yl=(Tp=class extends D{constructor(){super(...arguments);r(this,"trackedImages");r(this,"smooth",!0);r(this,"trackedImageIndexMap",new Map);r(this,"_supported",!0);r(this,"imageToObjectMap",new Map);r(this,"currentImages",[]);r(this,"webXRIncubationsWarning",`Image tracking is currently not supported on this device. On Chrome for Android, you can enable the <a target="_blank" href="#" onclick="() => console.log('I')">chrome://flags/#webxr-incubations</a> flag.`);r(this,"onImageTrackingUpdate",t=>{const e=q.active;if(e)for(const i of t){const n=i.model,o=i.state==="tracked";if(!n.object)continue;let a=this.imageToObjectMap.get(n);if(a===void 0)a={object:null,frames:0,lastTrackingTime:Date.now()},this.imageToObjectMap.set(n,a),n.object.loadAssetAsync().then(l=>{if(n.createObjectInstance&&l&&(l=S.instantiate(l)),l){a.object=l;for(const c of l.getComponentsInChildren(ze))c.setInstancingEnabled(!1);e.rig?(e.rig.gameObject.add(l),i.applyToObject(l),l.activeSelf||S.setActive(l,!0)):console.warn("XRImageTracking: missing XRRig")}});else{if(a.frames++,o&&(a.lastTrackingTime=Date.now()),n.imageDoesNotMove&&a.frames>10||!a.object)continue;e.rig&&(e.rig.gameObject.add(a.object),i.applyToObject(a.object,this.smooth?this.context.time.deltaTimeUnscaled*3:void 0),a.object.activeSelf||S.setActive(a.object,!0))}}})}get supported(){return this._supported}awake(){if(vb&&console.log(this),!!this.trackedImages){for(const t of this.trackedImages)if(t.image&&!Yl._imageElements.has(t.image)){const e=t.image;Yl._imageElements.set(e,null);const i=document.createElement("img");i.src=e,i.addEventListener("load",async()=>{const n=await createImageBitmap(i);Yl._imageElements.set(e,n);const o=await hw(n);if(o){const l=await(await o.convertToBlob({type:"image/png"})).arrayBuffer(),c=S.findObjectOfType(Le);c&&this.trackedImages&&(c.extensions.push(new mT("marker.png",new Uint8Array(l),this.trackedImages[0].widthInMeters)),c.anchoringType="image")}})}}}onBeforeXR(t,e){var i;if(this.trackedImages){e.optionalFeatures=e.optionalFeatures||[],e.optionalFeatures.includes("image-tracking")||e.optionalFeatures.push("image-tracking"),e.trackedImages=[];for(const n of this.trackedImages)if((i=n.image)!=null&&i.length&&n.widthInMeters>0){const o=Yl._imageElements.get(n.image);o&&(this.trackedImageIndexMap.set(e.trackedImages.length,n),e.trackedImages.push({image:o,widthInMeters:n.widthInMeters}))}}}onEnterXR(t){var e;if(this.trackedImages){for(const i of this.trackedImages)if((e=i.object)!=null&&e.asset){const n=i.object.asset;n.userData||(n.userData={});const o={visible:n.visible,parent:n.parent,matrix:n.matrix.clone()};n.userData["image-tracking"]=o}}for(const i of this.imageToObjectMap.values())i.frames=0}onLeaveXR(t){var e,i;if(!this.supported&&exports.DeviceUtilities.isAndroidDevice()&&pe(this.webXRIncubationsWarning),this.trackedImages){for(const n of this.trackedImages)if((e=n.object)!=null&&e.asset){const o=n.object.asset;if(o.userData){const a=o.userData["image-tracking"];a&&(o.visible=a.visible,(i=a.parent)==null||i.add(o),o.matrix.copy(a.matrix),o.matrix.decompose(o.position,o.quaternion,o.scale)),delete o.userData["image-tracking"]}}}}onUpdateXR(t){var n;this.currentImages.length=0;const e=t.xr.frame;if(!e)return;if("getImageTrackingResults"in e){if(((n=t.xr.session.enabledFeatures)==null?void 0:n.includes("image-tracking"))===!1)return;if(e.session&&typeof e.getImageTrackingResults=="function"){const o=e.getImageTrackingResults();if(o.length>0){const a=this.context.renderer.xr.getReferenceSpace();if(a){for(const l of o){const c=l.trackingState,d=l.index,u=this.trackedImageIndexMap.get(d);if(u){const f=e.getPose(l.imageSpace,a),m=new Ho(this,u,l.image,l.measuredSize,c,f);this.currentImages.push(m)}else vb&&console.warn("No tracked image for index",d)}if(this.currentImages.length>0)try{this.dispatchEvent(new CustomEvent("image-tracking",{detail:this.currentImages})),this.onImageTrackingUpdate(this.currentImages)}catch(l){console.error(l)}}}}}else{this.didPrintWarning||(this.didPrintWarning=!0,console.log(this.webXRIncubationsWarning)),this._supported=!1,pe(this.webXRIncubationsWarning);return}const i=1e3;for(const[o,a]of this.imageToObjectMap){if(!a.object||!o||o.hideWhenTrackingIsLost===!1)continue;let l=!1;for(const c of this.currentImages)if(c.model===o){const d=Date.now()-a.lastTrackingTime;if(o.imageDoesNotMove||c.state==="tracked"||d<=i){l=!0;break}}l||S.setActive(a.object,!1)}}},r(Tp,"_imageElements",new Map),Tp);let pr=Yl;Eo([p(Es)],pr.prototype,"trackedImages",2);Eo([p()],pr.prototype,"smooth",2);var gT=Object.defineProperty,_T=Object.getOwnPropertyDescriptor,ul=(s,t,e,i)=>{for(var n=i>1?void 0:i?_T(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&gT(t,e,n),n};const Io=x("debugplanetracking");class Ts extends D{constructor(){super(...arguments);r(this,"dataTemplate");r(this,"occluder",!0);r(this,"initiateRoomCaptureIfNoData",!0);r(this,"usePlaneData",!0);r(this,"useMeshData",!0);r(this,"runInVR",!0);r(this,"bounds",new h.Box3);r(this,"center",new h.Vector3);r(this,"labelOffset",new h.Vector3);r(this,"_dataId",1);r(this,"_allPlanes",new Map);r(this,"_allMeshes",new Map);r(this,"firstTimeNoPlanesDetected",-100);r(this,"makeOccluder",(e,i,n=!1)=>{if(i){if(i instanceof Array){for(const o of i)this.makeOccluder(e,o,n);return}!n&&!i.name.toLowerCase().includes("occlu")||(i.colorWrite=!1,i.depthTest=!0,i.depthWrite=!0,i.transparent=!1,i.polygonOffset=!0,i.polygonOffsetFactor=1,i.polygonOffsetUnits=.1,e.renderOrder=-1e3)}});r(this,"_flipForwardMatrix",new h.Matrix4().makeRotationY(Math.PI));r(this,"_verticesCache",new Map)}get trackedPlanes(){return this._allPlanes.values()}get trackedMeshes(){return this._allMeshes.values()}onBeforeXR(e,i){e==="immersive-vr"&&!this.runInVR||(i.optionalFeatures=i.optionalFeatures||[],this.usePlaneData&&!i.optionalFeatures.includes("plane-detection")&&i.optionalFeatures.push("plane-detection"),this.useMeshData&&!i.optionalFeatures.includes("mesh-detection")&&i.optionalFeatures.push("mesh-detection"))}onEnterXR(e){for(const i of this._allPlanes.keys())this.removeData(i,this._allPlanes);for(const i of this._allMeshes.keys())this.removeData(i,this._allMeshes)}onLeaveXR(e){for(const i of this._allPlanes.keys())this.removeData(i,this._allPlanes);for(const i of this._allMeshes.keys())this.removeData(i,this._allMeshes)}onUpdateXR(e){if(!this.runInVR&&e.xr.isVR)return;const i=e.xr.rig;if(!i){console.warn("No XR rig found, cannot parent tracked planes to it");return}const n=e.xr.frame;if(!this.context.renderer.xr.getReferenceSpace())return;const l=n.detectedPlanes,c=n.detectedMeshes,d=l!==void 0&&l.size>0,u=c!==void 0&&c.size>0;if(this.initiateRoomCaptureIfNoData&&(!d&&!u&&this.firstTimeNoPlanesDetected<-10&&(this.firstTimeNoPlanesDetected=Date.now()),(d||u)&&(this.firstTimeNoPlanesDetected=-1),this.firstTimeNoPlanesDetected>0&&Date.now()-this.firstTimeNoPlanesDetected>2500&&"initiateRoomCapture"in n.session&&(n.session.initiateRoomCapture(),this.firstTimeNoPlanesDetected=-1)),l!==void 0&&this.processFrameData(e.xr,i.gameObject,n,l,this._allPlanes),c!==void 0&&this.processFrameData(e.xr,i.gameObject,n,c,this._allMeshes),Io){const f=this.context.mainCameraComponent.gameObject.worldPosition;for(const m of this._allPlanes.values())!m.mesh||!m.mesh.visible||(this.bounds.makeEmpty(),m.mesh.traverse(g=>{g instanceof h.Mesh&&this.bounds.expandByObject(g)}),this.bounds.getCenter(this.center),this.labelOffset.copy(f).sub(this.center).normalize().multiplyScalar(.1),N.DrawLabel(this.center.add(this.labelOffset),(m.xrData.semanticLabel||"plane").toUpperCase()+`
`+m.xrData.lastChangedTime.toFixed(2),.02))}}removeData(e,i){const n=i.get(e);if(!n)return;i.delete(e),Io&&console.log("Plane no longer tracked, id="+n.id),n.mesh&&(n.mesh.removeFromParent(),n.mesh.traverse(a=>{const l=a.userData.normalsHelper;l?(l.dispose(),l.removeFromParent()):Io&&console.warn("No normals helper found for mesh",n.mesh)}),Si(n.mesh,!0,!0));const o=new CustomEvent("plane-tracking",{detail:{type:"plane-removed",context:n}});this.dispatchEvent(o)}processFrameData(e,i,n,o,a){const c=this.context.renderer.xr.getReferenceSpace();if(c){for(const d of a.keys())o.has(d)||this.removeData(d,a);for(const d of o){const u="planeSpace"in d?d.planeSpace:"meshSpace"in d?d.meshSpace:void 0;if(!u)continue;const f=n.getPose(u,c);let m;if(a.has(d)){const g=a.get(d);if(m=g.mesh,g.timestamp<d.lastChangedTime){if(g.timestamp=d.lastChangedTime,g.mesh){const y=this.createGeometry(d);if(g.mesh instanceof h.Mesh)g.mesh.geometry.dispose(),g.mesh.geometry=y,this.makeOccluder(g.mesh,g.mesh.material);else if(g.mesh instanceof h.Group)for(const b of g.mesh.children)b instanceof h.Mesh&&(b.geometry.dispose(),b.geometry=y,this.makeOccluder(b,b.material));if(g.collider){const b=g.mesh;g.collider.sharedMesh=b,g.collider.convex=this.checkIfContextShouldBeConvex(b,g.xrData),g.collider.onDisable(),g.collider.onEnable()}Io&&(console.log("Plane updated, id="+g.id,g),g.mesh.traverse(b=>{if(!(b instanceof h.Mesh))return;const v=b.userData.normalsHelper;v&&v.update()}))}const _=new CustomEvent("plane-tracking",{detail:{type:"plane-updated",context:g}});this.dispatchEvent(_)}}else{if(!this.dataTemplate){const g=new h.Mesh;Io?g.material=new h.MeshNormalMaterial:this.occluder?(g.material=new h.MeshBasicMaterial,this.makeOccluder(g,g.material,!0)):g.material=new h.MeshBasicMaterial({wireframe:!0,opacity:.5,transparent:!0,color:3355443}),this.dataTemplate=new ee("","",g)}if(!this.dataTemplate.asset)this.dataTemplate.loadAssetAsync();else{const g=S.instantiate(this.dataTemplate.asset);if(g.name="xr-tracked-plane",m=g,jm(g,!1),g instanceof h.Mesh)xe(g.geometry),g.geometry=this.createGeometry(d),this.makeOccluder(g,g.material,this.occluder&&!this.dataTemplate);else if(g instanceof h.Group)for(const b of g.children)b instanceof h.Mesh&&(xe(b.geometry),b.geometry=this.createGeometry(d),this.makeOccluder(b,b.material,this.occluder&&!this.dataTemplate));const _=g.getComponent(vo);if(_){const b=g;_.sharedMesh=b,_.convex=this.checkIfContextShouldBeConvex(b,d),_.onDisable(),_.onEnable()}g.matrixAutoUpdate=!1,g.matrixWorldNeedsUpdate=!0,i.add(g);const y={id:this._dataId++,xrData:d,timestamp:d.lastChangedTime,mesh:g,collider:_};a.set(d,y),Io&&console.log("New plane detected, id="+y.id,y,{hasCollider:!!_,isGroup:g instanceof h.Group});try{const b=new CustomEvent("plane-tracking",{detail:{type:"plane-added",context:y}});this.dispatchEvent(b)}catch(b){console.error(b)}}}m&&(f?(m.visible=!0,m.matrix.fromArray(f.transform.matrix),m.matrix.premultiply(this._flipForwardMatrix)):m.visible=!1,Io&&m.traverse(g=>{if(g instanceof h.Mesh)if(g.userData.normalsHelper)g.userData.normalsHelper.update();else{const _=new Y.VertexNormalsHelper(g,.05,255);_.layers.disableAll(),_.layers.set(2),this.context.scene.add(_),g.userData.normalsHelper=_}}))}}}checkIfContextShouldBeConvex(e,i){if(!e)return!0;if(e){const n=new h.Box3;n.expandByObject(e);const o=new h.Vector3;n.getSize(o);let a=!0;return o.x>2&&o.y>2&&o.z>1.5&&(a=!1),a&&"semanticLabel"in i&&i.semanticLabel==="wall"&&(a=!0),a}return!0}createGeometry(e){return"polygon"in e?this.createPlaneGeometry(e.polygon):"vertices"in e&&"indices"in e?this.createMeshGeometry(e.vertices,e.indices):new h.BufferGeometry}createMeshGeometry(e,i){const n=e.toString()+"_"+i.toString();if(this._verticesCache.has(n))return this._verticesCache.get(n);const o=new h.BufferGeometry;o.setIndex(new h.BufferAttribute(i,1)),o.setAttribute("position",new h.BufferAttribute(e,3));const a=Array();for(let l=0;l<e.length;l+=3)a.push(e[l],e[l+2]);return o.setAttribute("uv",new h.BufferAttribute(e,3)),o.computeVertexNormals(),this._verticesCache.set(n,o),o}createPlaneGeometry(e){const i=new h.BufferGeometry,n=[],o=[];e.forEach(g=>{n.push(g.x,g.y,g.z),o.push(g.x,g.z)});const a=new h.Vector3(n[0],n[1],n[2]),l=new h.Vector3(n[3],n[4],n[5]),c=new h.Vector3(n[6],n[7],n[8]),d=new h.Vector3,u=new h.Vector3;d.subVectors(l,a),u.subVectors(c,a),d.cross(u),d.normalize();const f=[];for(let g=0;g<n.length/3;g++)f.push(d.x,d.y,d.z);const m=[];for(let g=2;g<e.length;++g)m.push(0,g-1,g);return i.setAttribute("position",new h.BufferAttribute(new Float32Array(n),3)),i.setAttribute("uv",new h.BufferAttribute(new Float32Array(o),2)),i.setAttribute("normal",new h.BufferAttribute(new Float32Array(f),3)),i.setIndex(m),i.computeBoundingBox(),i.computeBoundingSphere(),i}}ul([p(ee)],Ts.prototype,"dataTemplate",2);ul([p()],Ts.prototype,"occluder",2);ul([p()],Ts.prototype,"initiateRoomCaptureIfNoData",2);ul([p()],Ts.prototype,"usePlaneData",2);ul([p()],Ts.prototype,"useMeshData",2);ul([p()],Ts.prototype,"runInVR",2);var yT=Object.defineProperty,bT=Object.getOwnPropertyDescriptor,vT=(s,t,e,i)=>{for(var n=i>1?void 0:i?bT(t,e):t,o=s.length-1,a;o>=0;o--)(a=s[o])&&(n=(i?a(t,e,n):a(n))||n);return i&&n&&yT(t,e,n),n};const wb=x("debugwebxr");class hf extends D{constructor(){super(...arguments);r(this,"priority",0);r(this,"_startScale")}get isActive(){return this.activeAndEnabled&&this.gameObject.visible}setAsActiveXRRig(){var e;(e=q.active)==null||e.setRigActive(this)}setPriority(e){this.priority=e}awake(){if(wb){const e=new h.Object3D;e.position.y+=.5,this.gameObject.add(e);const i=e.addNewComponent(Er);i&&(i.isGizmo=!1);const n=new h.AxesHelper(.5);this.gameObject.add(n)}}isXRRig(){return!0}supportsXR(e){return!0}onEnterXR(e){this._startScale=this.gameObject.scale.clone(),e.xr.addRig(this),wb&&console.log("WebXR: add Rig",this.name,this.priority)}onLeaveXR(e){e.xr.removeRig(this),this._startScale&&this.gameObject&&this.gameObject.scale.copy(this._startScale)}}vT([p()],hf.prototype,"priority",2);class wT extends D{constructor(){super(...arguments);r(this,"toggleKey","KeyP")}update(){this.context.input.isKeyDown(this.toggleKey)&&this.context.domElement.classList.toggle("presentation-mode")}}R.add("AlignmentConstraint",Zc);R.add("Animation",kt);R.add("Animator",xt);R.add("AudioListener",us);R.add("AudioSource",Ie);R.add("Avatar_Brain_LookAt",kc);R.add("Avatar_MouthShapes",nh);R.add("Avatar_MustacheShake",gg);R.add("AvatarBlink_Simple",wr);R.add("AvatarEyeLook_Rotation",za);R.add("AxesHelper",Na);R.add("BasicIKConstraint",bg);R.add("BoxHelperComponent",ti);R.add("Camera",ye);R.add("CharacterController",xr);R.add("CharacterControllerInput",ws);R.add("Collider",ri);R.add("SphereCollider",Va);R.add("BoxCollider",$a);R.add("MeshCollider",vo);R.add("CapsuleCollider",ys);R.add("ContactShadows",gn);R.add("LogStats",vg);R.add("DeleteBox",nr);R.add("Deletable",xg);R.add("DeviceFlag",Fu);R.add("DragControls",ii);R.add("DropListener",xs);R.add("Duplicatable",Ha);R.add("EventListEvent",Lu);R.add("EventTrigger",Uu);R.add("GltfExportBox",Eg);R.add("GltfExport",rh);R.add("VariantAction",Dg);R.add("ChangeTransformOnClick",Pr);R.add("ChangeMaterialOnClick",Xa);R.add("SetActiveOnClick",Or);R.add("HideOnStart",eo);R.add("EmphasizeOnClick",Qa);R.add("PlayAudioOnClick",co);R.add("PlayAnimationOnClick",fr);R.add("PreliminaryAction",Ya);R.add("PreliminaryTrigger",lh);R.add("VisibilityAction",ch);R.add("TapGestureTrigger",Lg);R.add("USDZExporter",Le);R.add("Fog",el);R.add("BoxGizmo",Er);R.add("GridHelper",tl);R.add("GroundProjectedEnv",Vn);R.add("UsageMarker",sh);R.add("Interactable",wg);R.add("FixedJoint",Kg);R.add("HingeJoint",uh);R.add("Light",li);R.add("LODGroup",ph);R.add("LookAtConstraint",vr);R.add("NeedleMenu",$n);R.add("NestedGltf",Hu);R.add("Networking",nl);R.add("OffsetConstraint",Tr);R.add("CameraTargetReachedEvent",Rc);R.add("OrbitControls",fe);R.add("ParticleSystemRenderer",Xi);R.add("ParticleSystem",Qe);R.add("PlayerColor",Ba);R.add("Antialiasing",mh);R.add("BloomEffect",Ir);R.add("ChromaticAberration",gh);R.add("ColorAdjustments",Po);R.add("DepthOfField",yn);R.add("EffectWrapper",Tc);R.add("PixelationEffect",_h);R.add("ScreenSpaceAmbientOcclusion",Ms);R.add("ScreenSpaceAmbientOcclusionN8",bn);R.add("SharpeningEffect",bh);R.add("TiltShiftEffect",Hn);R.add("ToneMappingEffect",fo);R.add("Vignette",Fr);R.add("Volume",al);R.add("ReflectionProbe",qa);R.add("Renderer",ze);R.add("MeshRenderer",oh);R.add("SkinnedMeshRenderer",kg);R.add("Rigidbody",ue);R.add("SceneSwitcher",He);R.add("ScreenCapture",Oo);R.add("ShadowCatcher",wh);R.add("RemoteSkybox",Nn);R.add("SmoothFollow",Mo);R.add("SpatialTriggerReceiver",Bn);R.add("SpatialTrigger",Ch);R.add("SpectatorCamera",Zu);R.add("SpriteRenderer",ai);R.add("SyncedCamera",Ju);R.add("SyncedRoom",vn);R.add("SyncedTransform",Un);R.add("TestRunner",o_);R.add("TestSimulateUserData",r_);R.add("PlayableDirector",po);R.add("SignalReceiver",ll);R.add("AnimationTrackHandler",nf);R.add("AudioTrackHandler",or);R.add("SignalTrackHandler",Ac);R.add("ControlTrackHandler",sf);R.add("TransformGizmo",Ur);R.add("BaseUIComponent",Gi);R.add("UIRootComponent",eh);R.add("Button",Rs);R.add("Canvas",St);R.add("CanvasGroup",uo);R.add("EventSystem",Gt);R.add("Graphic",Mr);R.add("MaskableGraphic",dh);R.add("Image",cl);R.add("RawImage",af);R.add("InputField",zr);R.add("VerticalLayoutGroup",Ng);R.add("HorizontalLayoutGroup",Vg);R.add("GridLayoutGroup",$g);R.add("Outline",Ja);R.add("ObjectRaycaster",Ci);R.add("GraphicRaycaster",Iu);R.add("SpatialGrabRaycaster",oo);R.add("RectTransform",Et);R.add("SpatialHtml",Mh);R.add("Text",Tt);R.add("LookAt",Nr);R.add("OpenURL",hl);R.add("VideoPlayer",nt);R.add("Voip",bo);R.add("Avatar",ho);R.add("XRControllerFollow",ks);R.add("XRControllerModel",zn);R.add("XRControllerMovement",Pi);R.add("TeleportTarget",Wu);R.add("WebARCameraBackground",Rh);R.add("WebARSessionRoot",Ni);R.add("WebXR",Ne);R.add("AvatarMarker",tt);R.add("WebXRImageTracking",pr);R.add("WebXRPlaneTracking",Ts);R.add("XRRig",hf);R.add("XRFlag",_i);R.add("PlayerSync",Ka);R.add("PlayerState",vi);R.add("PresentationMode",wT);const dc=lt,xT=x("debugtypestore");xT&&console.log(R);function ST(s,t){const i=$0(s,t);return i!==void 0?i:null}const CT=new jC,pp=Symbol("deserialize-queue");async function PT(s,t,e,i=null,n){if(!e){console.debug("Can not create component instances: gltf is null");return}let o=i;typeof o=="number"&&(o=new vt(i));const a=t.indexOf("?");t=a===-1?t:t.substring(0,a);const l=new ng(e.scene);l.gltfId=t,l.context=s,l.gltf=e,l.nodeToObject=n==null?void 0:n.nodeToObjectMap,l.implementationInformation=CT;let c=s[pp];if(c||(c=s[pp]=[]),e.scenes)for(const d of e.scenes)await Sm(l,d,c);if(e.children)for(const d of e.children)await Sm(l,d,c);s.new_scripts_pre_setup_callbacks.push(()=>{const d=s[pp];if(d){for(const u of d)OT(u,l);d.length=0}if(o){const u={},f=[];xm(e,o,u,f);for(const m of e.scenes)xm(m,o,u,f);for(const m of f)m.resolveGuids(u)}})}const wm=Symbol("original-component-name"),Yr=new Map;function xm(s,t,e,i){if(t===null||!s)return;const n=s.guid,o=s.guid;o!=null&&o.length&&(Yr.has(o)||(dc&&console.log('Creating InstanceIdProvider with key "'+o+'" for object '+s.name),Yr.set(o,new vt(o))));const a=o&&Yr.get(o)||t;if(s.guid=a.generateUUID(),n&&n!=="invalid"&&(e[n]=s.guid),s&&s.userData&&s.userData.components)for(const l of s.userData.components){if(l===null)continue;const c=l.guid;c?Yr.has(c)||(dc&&console.log('Creating InstanceIdProvider with key "'+c+'" for component '+l[wm]),Yr.set(c,new vt(c))):dc&&console.warn("Can not create IdProvider: component "+l[wm]+" has no guid",l.guid);const d=Yr.get(c)||t,u=l.guid;l.guid=d.generateUUID(),u&&u!=="invalid"&&(e[u]=l.guid),l.resolveGuids&&i.push(l)}if(s.children)for(const l of s.children)xm(l,t,e,i)}const Ml=[];async function Sm(s,t,e,i){var o,a,l,c,d;if(!t)return;const n=t.userData;if(n){const u=n.builtin_components;if(u&&u.length>0)for(const f of u)try{if(f===null)continue;const m=R.get(f.name);if(m!=null){const g=new m;g.sourceId=s.gltfId,Da(g,f,s.implementationInformation),g.context=s.context,"guid"in f&&(g[ec]=f.guid),g[wm]=f.name,Jo(t,g,!1),e.push({instance:g,compData:f,obj:t}),g.isCamera&&s.context&&s.context.mainCamera===null&&g.tag==="MainCamera"&&s.context.setCurrentCamera(g),((l=(a=(o=s.context)==null?void 0:o.physics)==null?void 0:a.engine)==null?void 0:l.isInitialized)===!1&&(g.isCollider||g.isRigidbody)&&((d=(c=s.context)==null?void 0:c.physics.engine)==null||d.initialize())}else dc&&console.debug("unknown component: "+f.name),Ml.includes(f.name)||Ml.push(f.name)}catch(m){console.error(f.name+" - "+m.message,m)}if(Ml.length>0){const f=Ml.join(", ");console.warn("unknown components: "+f),Ml.length=0,Ht()&&Te(`<strong>Unknown components in scene</strong>:

${f}

This could mean you forgot to add a npmdef to your ExportInfo
<a href="https://engine.needle.tools/docs/project_structure.html#creating-and-installing-a-npmdef" target="_blank">documentation</a>`,bi.Warn)}}if(t.children)for(const u of t.children)await Sm(s,u,e)}function OT(s,t){const{instance:e,compData:i,obj:n}=s;t.object=n,t.target=e,zd(e,i,t),dc&&console.debug("add "+i.name,i,e)}const lu=x("debugfileformat");async function Xw(s,t=!0){var i;if(t){const n=s,o=new URL(n,globalThis.location.origin);let a=null;const l=o.searchParams.get("filetype");switch(l&&(a=l.toUpperCase()),a!=null&&a.length||(a=(i=o.pathname.split(".").pop())==null?void 0:i.toUpperCase()),lu&&console.debug("Use file extension to determine type: "+a),a){case"GLTF":return"gltf";case"VRM":return"vrm";case"GLB":return"glb";case"FBX":return"fbx";case"USD":return"usd";case"USDA":return"usda";case"USDZ":return"usdz";case"OBJ":return"obj"}}if(!s.startsWith("blob:")){const n=new URL(s);n.searchParams.append("range","true"),s=n.toString()}const e=await fetch(s,{method:"GET",headers:{range:"bytes=0-32"}}).catch(n=>null);if(e!=null&&e.ok){const n=await e.arrayBuffer(),o=Qw(n,e);return lu&&console.log("Determined file type from header: "+o),o}return"unknown"}function Qw(s,t){if(s.byteLength<4)return"unknown";const e=new Uint8Array(s);if(lu&&console.warn(`Trying to determine file type from binary data
`,'"'+new TextDecoder().decode(s)+`"
`,e),e[0]==103&&e[1]==108&&e[2]==84&&e[3]==70)return console.debug("GLTF detected"),"glb";if(e[0]==80&&e[1]==75&&e[2]==3&&e[3]==4)return console.debug("USDZ detected"),"usdz";if(e[0]==80&&e[1]==88&&e[2]==82&&e[3]==45&&e[4]==85&&e[5]==83&&e[6]==68&&e[7]==67)return console.debug("Binary USD detected"),"usd";if(e[0]==35&&e[1]==117&&e[2]==115&&e[3]==100&&e[4]==97)return console.debug("ASCII USD detected"),"usda";if(e[0]==75&&e[1]==97&&e[2]==121&&e[3]==100&&e[4]==97&&e[5]==114&&e[6]==97&&e[7]==32)return console.debug("Binary FBX detected"),"fbx";if(e[0]==59&&e[1]==32&&e[2]==70&&e[3]==66&&e[4]==88&&e[5]==32)return console.debug("ASCII FBX detected"),"fbx";if(e[0]==35&&e[1]==32&&e[2]==66&&e[3]==108&&e[4]==101&&e[5]==110&&e[6]==100&&e[7]==101&&e[8]==114&&e[9]==32)return console.debug("OBJ detected"),"obj";if(e[0]==35&&e[1]==32&&e[2]==65&&e[3]==108&&e[4]==105&&e[5]==97&&e[6]==115&&e[7]==32&&e[8]==79&&e[9]==66&&e[10]==74)return console.debug("OBJ detected"),"obj";if(t.headers.has("content-type")){const i=t.headers.get("content-type");switch(console.debug("Content-Type: "+i),i){case"model/gltf+json":return"gltf";case"model/gltf-binary":return"glb";case"model/vrm":return"vrm";case"model/vnd.usdz+zip":return"usdz";case"model/vnd.usd+zip":return"usd";case"model/vnd.usda+zip":return"usda";case"model/fbx":case"model/vnd.autodesk.fbx":return"fbx";case"model/obj":return"obj"}}if(e[0]==118&&e[1]==32||e[0]==102&&e[1]==32)return console.debug("OBJ detected (the file has no header and starts with vertex or face)"),"obj";if(e[0]==35&&e[1]==32&&e[2]==70&&e[3]==105&&e[4]==108&&e[5]==101&&e[6]==32&&e[7]==101&&e[8]==120&&e[9]==112&&e[10]==111&&e[11]==114&&e[12]==116&&e[13]==101&&e[14]==100&&e[15]==32&&e[16]==98&&e[17]==121&&e[18]==32&&e[19]==90&&e[20]==66&&e[21]==114&&e[22]==117&&e[23]==115&&e[24]==104)return console.debug("OBJ detected (exported by ZBrush)"),"obj";if(e[0]==109&&e[1]==116&&e[2]==108&&e[3]==108&&e[4]==105&&e[5]==98)return console.debug("OBJ detected (mtllib)"),"obj";if(B()||lu){const i=new TextDecoder().decode(s.slice(0,16));console.debug('Could not determine file type from binary data: "'+i+'..."',e)}else console.debug("Could not determine file type from binary data",e);return"unknown"}class d_{createBuiltinComponents(t,e,i,n,o){return PT(t,e,i,n,o)}writeBuiltinComponentData(t,e){return ST(t,e)}parseSync(t,e,i,n){return ex(t,e,i,n)}loadSync(t,e,i,n,o){return tx(t,e,i,n,o)}}Pm(d_);const Yw=x("printGltf")||x("printgltf"),Kw=x("downloadgltf"),MT=x("debugfileformat");var Zw=(s=>(s[s.BeforeLoad=0]="BeforeLoad",s[s.AfterLoaded=1]="AfterLoaded",s[s.FinishedSetup=10]="FinishedSetup",s))(Zw||{});class rr{constructor(t,e,i,n){r(this,"context");r(this,"loader");r(this,"path");r(this,"gltf");this.context=t,this.path=e,this.loader=i,this.gltf=n}}const lo={};function RT(s,t){lo[s]=lo[s]||[],lo[s].push(t)}function kT(s,t){if(lo[s]){const e=lo[s].indexOf(t);e>=0&&lo[s].splice(e,1)}}function Ma(s,t){if(lo[s])for(const e of lo[s])e(t)}async function Jw(s,t,e,i,n){Yw&&console.warn("glTF",t,e),t.includes("?")&&(t=t.split("?")[0]),await dn().createBuiltinComponents(s,t,e,i,n)}async function u_(s,t){const e=await Xw(s)||"unknown";switch(MT&&console.debug("Determined file type: "+e+" for url",s),e){case"unknown":{console.warn("Unknown file type. Assuming glTF:",s);const i=new Y.GLTFLoader;return await eu(i,t,s),i}case"fbx":return new Y.FBXLoader;case"obj":return new Y.OBJLoader;case"usd":case"usda":case"usdz":return console.warn(e.toUpperCase()+" files are not supported."),null;default:console.warn("Unknown file type:",e);case"gltf":case"glb":case"vrm":{const i=new Y.GLTFLoader;return await eu(i,t,s),i}}}async function ex(s,t,e,i){typeof e!="string"&&(console.warn("Parse gltf binary without path, this might lead to errors in resolving extensions. Please provide the source path of the gltf/glb file",e,typeof e),e=""),Yw&&console.log("Parse glTF",e);const n=await u_(e,s);if(!n)return;if(n instanceof Y.OBJLoader){typeof t!="string"&&(t=new TextDecoder().decode(t));const l=n.parse(t);return{animations:l.animations,scene:l,scenes:[l]}}if(!(n instanceof Y.GLTFLoader)){const l=n.parse(t,e);return sx(n,l),{animations:l.animations,scene:l,scenes:[l]}}const a=zu(n);return new Promise((l,c)=>{try{let d=e.split("?")[0].trimEnd();{const f=d.split("/");f.length>0&&f[f.length-1]!==""&&f.pop(),d=f.join("/"),d.endsWith("/")||(d+="/")}n.resourcePath=d,Tu(n,s),Ma(0,new rr(s,e,n));const u=s.mainCamera;n.parse(t,"",async f=>{Rg(e,f,s),Ma(1,new rr(s,e,n,f)),await Jw(s,e,f,i,a),await ix(f.scene,s,u),Ma(10,new rr(s,e,n,f)),l(f),Kw&&nx(t)},f=>{console.error('Loading asset at "'+e+`" failed
`,f),l(void 0)})}catch(d){console.error(d),c(d)}})}async function tx(s,t,e,i,n){ET(t);const o=await u_(t,s);if(!o)return;if(!(o instanceof Y.GLTFLoader)){const l=await o.loadAsync(t,n);return sx(o,l),{animations:l.animations,scene:l,scenes:[l]}}const a=zu(o);return new Promise((l,c)=>{try{Tu(o,s),Ma(0,new rr(s,t,o));const d=s.mainCamera;o.load(t,async u=>{Rg(t,u,s),Ma(1,new rr(s,t,o,u)),await Jw(s,e,u,i,a),await ix(u.scene,s,d),Ma(10,new rr(s,t,o,u)),l(u),Kw&&nx(t)},u=>{n==null||n.call(o,u)},u=>{console.error('Loading asset at "'+t+`" failed
`,u),l(void 0)})}catch(d){console.error(d),c(d)}})}async function ix(s,t,e){e||(e=t.mainCamera);try{e?await t.renderer.compileAsync(s,e,t.scene).catch(i=>{console.warn(i.message)}):wC(s,t)}catch(i){console.warn((i==null?void 0:i.message)||i)}}function ET(s){if(new URL(s,window.location.href).href.startsWith("file://")){const e=`Hi - it looks like you are trying to load a local file which will not work. You need to use a webserver to serve your files.
Please refer to the documentation on <a href="https://fwd.needle.tools/needle-engine/docs/local-server">https://docs.needle.tools</a> or ask for help in our <a href="https://discord.needle.tools">discord community</a>`;Te(e),console.warn(e)}}function nx(s){if(typeof s=="string"){const t=document.createElement("a");t.href=s,t.download=s.split("/").pop(),t.click()}else{const t=new Blob([s],{type:"application/octet-stream"}),e=window.URL.createObjectURL(t),i=document.createElement("a");i.href=e,i.download="download.glb",i.click()}}function sx(s,t){if(t!=null&&t.isObject3D){const e=t;(s instanceof Y.FBXLoader||s instanceof Y.OBJLoader)&&e.traverse(i=>{const n=i;n!=null&&n.isMesh&&Bm(n,n.material)})}}Pm(d_);const Oe=x("debugwebcomponent"),xb="needle-engine",ox="vr",rx="desktop",TT=[bv,ox,rx],Rl="ar-session-active",kl="desktop-session-active",AT=["public-key","version","hash","src","camera-controls","loadstart","progress","loadfinished","dracoDecoderPath","dracoDecoderType","ktx2DecoderPath","tone-mapping","tone-mapping-exposure","background-blurriness","background-color"];class f_ extends HTMLElement{constructor(){super();r(this,"_context");r(this,"_overlay_ar");r(this,"_loadingProgress01",0);r(this,"_loadingView");r(this,"_previousSrc",null);r(this,"_didFullyLoad",!1);r(this,"_loadId",0);r(this,"_abortController",null);r(this,"_lastSourceFiles",null);r(this,"_createContextPromise",null);r(this,"onXRSessionStarted",()=>{var i;const e=this.context.xrSessionMode;e==="immersive-ar"?this.onEnterAR(this.context.xrSession):e==="immersive-vr"&&this.onEnterVR(this.context.xrSession),(i=this.context.xrSession)==null||i.addEventListener("end",()=>{this.dispatchEvent(new CustomEvent("xr-session-ended",{detail:{session:this.context.xrSession,context:this._context,sessionMode:e}})),e==="immersive-ar"?this.onExitAR(this.context.xrSession):e==="immersive-vr"&&this.onExitVR(this.context.xrSession)})});r(this,"onReady",()=>{var e;return(e=this._loadingView)==null?void 0:e.onLoadingFinished()});r(this,"onError",()=>{var e;return(e=this._loadingView)==null?void 0:e.setMessage("Loading failed!")});r(this,"_previouslyRegisteredMap",new Map);this._overlay_ar=new E1,this.addEventListener("ready",this.onReady),gv(),this.attachShadow({mode:"open"});const e=document.createElement("template");e.innerHTML=`<style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Flex:opsz,wght@8..144,100..1000&display=swap');

    :host {
        position: absolute;
        display: block;
        width: max(600px, 100%);
        height: max(300px, 100%);
        touch-action: none;

        -webkit-tap-highlight-color: transparent;
    }

    @media (max-width: 600px) {
        :host {
            width: 100%;
        }
    }
    @media (max-height: 300px) {
        :host {
            height: 100%;
        }
    }

    :host > div.canvas-wrapper {
        width: 100%;
        height: 100%;
    }

    :host canvas {   
        position: absolute;
        user-select: none;
        -webkit-user-select: none;

        /** allow touch panning but no pinch zoom **/
        /** but this doesnt work yet: 
         * touch-action: pan-x, pan-y;
         **/
        
        -webkit-touch-callout: none;
        -webkit-user-drag: none;
        -webkit-user-modify: none;
    }
    :host .content {
        position: absolute;
        top: 0;
        width: 100%;
        height: 100%;
        visibility: visible;
        z-index: 500; /* < must be less than the webxr buttons element */
        pointer-events: none;
    }
    :host .overlay-content {
        position: absolute;
        user-select: auto;
        pointer-events: all;
    }
    :host slot[name="quit-ar"]:hover {
        cursor: pointer;
    }
    :host .quit-ar-button {
        position: absolute;
        // top: env(titlebar-area-y); /** this doesnt work **/
        top: 60px; /** camera access needs a bit more space **/
        right: 20px;
        z-index: 9999;
    }
</style>
<div class="canvas-wrapper"> <!-- this wrapper is necessary for WebXR https://github.com/meta-quest/immersive-web-emulator/issues/55 -->
    <canvas></canvas>
</div>
<div class="content">
    <slot class="overlay-content"></slot>
</div>
`,this.shadowRoot&&this.shadowRoot.appendChild(e.content.cloneNode(!0)),this._context=new Q({domElement:this}),this.addEventListener("error",this.onError)}static get observedAttributes(){return AT}get loadingProgress01(){return this._loadingProgress01}get loadingFinished(){return this.loadingProgress01>.999}get cameraControls(){const e=this.getAttribute("camera-controls");return e==null?null:!(e===null||e==="False"||e==="false"||e==="0"||e==="none")}getContext(){return new Promise((e,i)=>{if(this._context&&this.loadingFinished)e(this._context);else{const n=()=>{this.removeEventListener("loadfinished",n),this._context&&this.loadingFinished&&e(this._context)};this.addEventListener("loadfinished",n)}})}get context(){return this._context}async connectedCallback(){if(Oe&&console.log("<needle-engine> connected"),this.setPublicKey(),this.setVersion(),this.addEventListener("xr-session-started",this.onXRSessionStarted),this.onSetupDesktop(),!this.getAttribute("src")){const i=globalThis["needle:codegen_files"];Oe&&console.log('src is null, trying to load from globalThis["needle:codegen_files"]',i),i&&(Oe&&console.log('globalThis["needle:codegen_files"]',i),this.setAttribute("src",i))}Oe&&console.log("src",this.getAttribute("src"));const e=this._loadId;setTimeout(()=>{this.isConnected!==!1&&e===this._loadId&&this.onLoad()},1)}disconnectedCallback(){var n;this.removeEventListener("xr-session-started",this.onXRSessionStarted),this._didFullyLoad=!1;const e=this.getAttribute("keep-alive"),i=e==null||(e==null?void 0:e.length)>0&&e!=="true"&&e!=="1";Oe&&console.warn('<needle-engine> disconnected, keep-alive: "'+e+'"',typeof e,"Dispose=",i),i?(Oe&&console.warn("<needle-engine> dispose"),(n=this._context)==null||n.dispose(),this._context=null,this._lastSourceFiles=null,this._loadId+=1):Oe&&console.warn("<needle-engine> is not disposed because keep-alive is set")}attributeChangedCallback(e,i,n){switch(Oe&&console.log("attributeChangedCallback",e,i,n),e){case"src":Oe&&console.warn(`<needle-engine src>
changed from "`,i,'" to "',n,'"'),this.onLoad();break;case"hash":this._context&&(this._context.hash=n);break;case"loadstart":case"progress":case"loadfinished":typeof n=="string"&&n.length>0&&(Oe&&console.log(e+" attribute changed",n),this.registerEventFromAttribute(e,n));break;case"dracoDecoderPath":Oe&&console.log("dracoDecoderPath",n),My(n);break;case"dracoDecoderType":n==="wasm"||n==="js"?(Oe&&console.log("dracoDecoderType",n),Ry(n)):console.error("Invalid dracoDecoderType",n,"expected js or wasm");break;case"ktx2DecoderPath":Oe&&console.log("ktx2DecoderPath",n),ky(n);break;case"tone-mapping":{this.applyAttributes();break}case"tone-mapping-exposure":{this.applyAttributes();break}case"background-blurriness":{const o=parseFloat(n);o!=null&&this._context&&(this._context.scene.backgroundBlurriness=o);break}case"background-color":{this.applyAttributes();break}case"public-key":{n!=Jl&&this.setPublicKey();break}case"version":{n!=ln&&this.setVersion();break}}}async onLoad(){var y,b;if(!this.isConnected)return;if(this._context||(Oe&&console.warn("Create new context"),this._context=new Q({domElement:this})),!this._context){console.error("Needle Engine: Context not initialized");return}const e=this.getSourceFiles();if(!this.checkIfSourceHasChanged(e,this._lastSourceFiles))return;this._abortController&&(Oe&&console.warn("Abort previous loading process"),this._abortController.abort(),this._abortController=null),this._lastSourceFiles=e;const i=++this._loadId;if((e==null||e.length<=0)&&(Oe&&console.warn("Clear scene",e),this._context.clear(),i!==this._loadId))return;const n=this.getAttribute("alias");this.classList.add("loading");const o=hn();this.ensureLoadStartIsRegistered();let a=this.dispatchEvent(new CustomEvent("loadstart",{detail:{context:this._context,alias:n},cancelable:!0}));if(o){const v=this.getAttribute("hide-loading-overlay");v!=null&&v!=="0"&&(a=!1)}a===!1&&!o&&(B()||(a=!0),console.warn("Needle Engine: You need a commercial license to override the default loading view. Visit https://needle.tools/pricing"),B()&&pe('You need a <a target="_blank" href="https://needle.tools/pricing">commercial license</a> to override the default loading view. This will not work in production.')),!this._loadingView&&a&&(this._loadingView=new rc(this)),a&&(this._didFullyLoad!==!0?(y=this._loadingView)==null||y.onLoadingBegin("begin load"):setTimeout(()=>{this._loadingView&&this._loadingProgress01<.3&&this._loadId===i&&this._loadingView.onLoadingBegin("begin load")},300)),Oe&&console.warn(`--------------
Needle Engine: Begin loading `+i+`
`,e),this.onBeforeBeginLoading();const l=[],c={context:this._context,name:"",progress:{},index:0,count:e.length,totalProgress01:this._loadingProgress01},d=new CustomEvent("progress",{detail:c}),u=new Array,f=new AbortController;this._abortController=f;const m={files:e,abortSignal:f.signal,onLoadingProgress:v=>{var P;if(Oe&&console.debug("Loading progress: ",v),f.signal.aborted)return;const w=v.index;!u[w]&&v.name&&(u[w]=DT(v.name)),v.name=u[w],a&&((P=this._loadingView)==null||P.onLoadingUpdate(v)),c.name=v.name,c.progress=v.progress,this._loadingProgress01=cg(v),c.totalProgress01=this._loadingProgress01,this.dispatchEvent(d)},onLoadingFinished:(v,w,P)=>{Oe&&console.debug(`Finished loading "${w}" (aborted? ${f.signal.aborted})`),!f.signal.aborted&&P&&l.push({src:w,file:P})}},g=this.getAttribute("hash");g!=null&&(this._context.hash=g),this._context.alias=n,this._createContextPromise=this._context.create(m);const _=await this._createContextPromise;if(this.applyAttributes(),Oe&&console.warn(`--------------
Needle Engine: finished loading `+i+`
`,e,`Aborted? ${f.signal.aborted}`),f.signal.aborted){console.log("Loading finished but aborted...");return}if(this._loadId!==i){console.log("Load id changed during loading process");return}this._loadingProgress01=1,a&&_&&((b=this._loadingView)==null||b.onLoadingUpdate(1,"creating scene")),this._didFullyLoad=!0,this.classList.remove("loading"),this.classList.add("loading-finished"),this.dispatchEvent(new CustomEvent("loadfinished",{detail:{context:this._context,src:n,loadedFiles:l}}))}applyAttributes(){if(this._context.renderer){const n=this.getAttribute("tonemapping")||this.getAttribute("tone-mapping");switch(n==null?void 0:n.toLowerCase()){case"none":this._context.renderer.toneMapping=h.NoToneMapping;break;case"linear":this._context.renderer.toneMapping=h.LinearToneMapping;break;case"neutral":this._context.renderer.toneMapping=h.NeutralToneMapping;break;case"agx":this._context.renderer.toneMapping=h.AgXToneMapping;break;default:n!=null&&console.warn("Invalid tone-mapping attribute: "+n)}const o=this.getAttribute("tone-mapping-exposure");if(o!=null){const a=parseFloat(o);isNaN(a)||(this._context.renderer.toneMappingExposure=a)}}const e=this.getAttribute("background-blurriness");if(e!=null){const n=parseFloat(e);n!==void 0&&this._context&&(this._context.scene.backgroundBlurriness=n)}const i=this.getAttribute("background-color");if(this._context&&typeof i=="string"&&i.length>0){const n=this._context.scene.background;n instanceof h.Color?n.set(i):this._context.scene.background=new h.Color(i)}}internalSetLoadingMessage(e){var i;(i=this._loadingView)==null||i.setMessage(e)}getSourceFiles(){const e=this.getAttribute("src");if(!e)return[];let i;Array.isArray(e)?i=e:e.startsWith("[")&&e.endsWith("]")?i=JSON.parse(e):e.includes(",")?i=e.split(","):i=[e];for(let n=i.length-1;n>=0;n--){const o=i[n];(o==="null"||o==="undefined"||(o==null?void 0:o.length)<=0)&&i.splice(n,1)}return i}checkIfSourceHasChanged(e,i){if((e==null?void 0:e.length)!==(i==null?void 0:i.length)||e==null&&i!==null||e!==null&&i==null)return!0;if(e!==null&&i!==null){for(let n=0;n<(e==null?void 0:e.length);n++)if(e[n]!==i[n])return!0}return!1}ensureLoadStartIsRegistered(){const e=this.getAttribute("loadstart");e&&this.registerEventFromAttribute("loadstart",e)}registerEventFromAttribute(e,i){const n=this._previouslyRegisteredMap.get(e);if(n&&(this._previouslyRegisteredMap.delete(e),this.removeEventListener(e,n)),typeof i=="string"&&i.length>0)try{const o=(0,eval)(i);typeof o=="function"&&(this._previouslyRegisteredMap.set(e,o),this.addEventListener(e,a=>o==null?void 0:o.call(globalThis,this._context,a)))}catch(o){console.error("Error registering event "+e+'="'+i+`" failed with the following error:
`,o)}}setPublicKey(){Jl.length>0&&this.setAttribute("public-key",Jl)}setVersion(){ln.length>0&&this.setAttribute("version",ln)}getAROverlayContainer(){return this._overlay_ar.createOverlayContainer(this)}getVROverlayContainer(){for(let e=0;e<this.children.length;e++){const i=this.children[e];if(i.classList.contains("vr"))return i}return null}onEnterAR(e){var n;this.onSetupAR();const i=this.getAROverlayContainer();this._overlay_ar.onBegin(this._context,i,e),this.dispatchEvent(new CustomEvent("enter-ar",{detail:{session:e,context:this._context,htmlContainer:(n=this._overlay_ar)==null?void 0:n.ARContainer}}))}onExitAR(e){var i;this._overlay_ar.onEnd(this._context),this.onSetupDesktop(),this.dispatchEvent(new CustomEvent("exit-ar",{detail:{session:e,context:this._context,htmlContainer:(i=this._overlay_ar)==null?void 0:i.ARContainer}}))}onEnterVR(e){this.onSetupVR(),this.dispatchEvent(new CustomEvent("enter-vr",{detail:{session:e,context:this._context}}))}onExitVR(e){this.onSetupDesktop(),this.dispatchEvent(new CustomEvent("exit-vr",{detail:{session:e,context:this._context}}))}onSetupAR(){this.classList.add(Rl),this.classList.remove(kl);const e=this.getAROverlayContainer();Oe&&console.warn("onSetupAR:",e),e&&(e.classList.add(Rl),e.classList.remove(kl)),this.foreachHtmlElement(i=>this.setupElementsForMode(i,bv))}onSetupVR(){this.classList.remove(Rl),this.classList.remove(kl),this.foreachHtmlElement(e=>this.setupElementsForMode(e,ox))}onSetupDesktop(){this.classList.remove(Rl),this.classList.add(kl);const e=this.getAROverlayContainer();e&&(e.classList.remove(Rl),e.classList.add(kl)),this.foreachHtmlElement(i=>this.setupElementsForMode(i,rx))}setupElementsForMode(e,i,n=null){var a,l;if(e===((l=(a=this._context)==null?void 0:a.renderer)==null?void 0:l.domElement)||e.id==="VRButton"||e.id==="ARButton")return;if(e.classList.contains(i))e.style.visibility="visible",e.style.display==="none"&&(e.style.display="block");else for(const c of TT)e.classList.contains(c)&&(e.style.visibility="hidden",e.style.display="none")}foreachHtmlElement(e){for(let i=0;i<this.children.length;i++){const n=this.children[i];n.style&&e(n)}}onBeforeBeginLoading(){const e=this.getAttribute("dracoDecoderPath");e&&(Oe&&console.log("using custom draco decoder path",e),My(e));const i=this.getAttribute("dracoDecoderType");i&&(Oe&&console.log("using custom draco decoder type",i),Ry(i));const n=this.getAttribute("ktx2DecoderPath");n&&(Oe&&console.log("using custom ktx2 decoder path",n),ky(n))}}typeof window<"u"&&!window.customElements.get(xb)&&window.customElements.define(xb,f_);function DT(s){if(s.startsWith("blob:"))return"blob";const t=s.split("/");let e=t[t.length-1];const i=e.indexOf("?");i>0&&(e=e.substring(0,i));const n=e.indexOf("=");n>0&&(e=e.substring(n));const o=e.split(".").pop(),l=o?["glb","gltf","usdz","usd","fbx","obj","mtl"].indexOf(o.toLowerCase()):-1;if(o&&l>=0&&(e=e.substring(0,e.length-o.length-1)),e=decodeURIComponent(e),e.length>3){let c="",d=!1;const u=["(",")","[","]","{","}",":",";",",",".","!","?"];for(let f=0;f<e.length;f++){let m=e[f];(m==="_"||m==="-")&&(m=" "),!(m===" "&&c.length<=0||u.includes(m)||(c.length===0&&(m=m.toUpperCase()),d&&m===" "))&&(d&&(m=m.toUpperCase()),d=!1,c+=m,m===" "&&(d=!0))}return B()&&e!==c&&console.debug('Generated display name: "'+e+'" → "'+c+'"'),c.trim()}return B()&&console.debug("Loading: use default name",e),e}const LT=Object.freeze(Object.defineProperty({__proto__:null,NeedleEngineHTMLElement:f_},Symbol.toStringTag,{value:"Module"}));function IT(){cn.registerWaitForInteraction(()=>{const s=h.AudioContext.getContext();s.addEventListener("statechange",()=>{setTimeout(()=>{const t=s.state;(t==="suspended"||t==="interrupted")&&s.resume().then(()=>{console.log("AudioContext resumed successfully")}).catch(e=>{console.log("Failed to resume AudioContext: "+e)})},500)})})}setTimeout(IT,1e3);const Ed=x("debughotreload");let Dc=!1;const uc=new Map;function jT(){return Dc}function BT(s){var i;if(Dc)return;const e=s.constructor.name;uc.has(e)?(i=uc.get(e))==null||i.push(s):uc.set(e,[s])}function FT(s){if(Dc)return;const e=s.constructor.name,i=uc.get(e);if(!i)return;const n=i.indexOf(s);n!==-1&&i.splice(n,1)}let Sb=!1;function UT(){if(Ed||Sb)return;Sb=!0;const s=console.error;console.error=(...t)=>{if(t.length){const e=t[0];if(typeof e=="string"&&e.includes("[hmr] Failed to reload ")){console.log("[Needle Engine] Hot reloading failed"),window.location.reload();return}}s.apply(console,t)}}function zT(s){Ed&&console.log("[HMR] Apply changes",s,Object.keys(s)),UT();for(const t of Object.keys(s))try{Dc=!0;const e=R.get(t);if(!e){Ed&&console.log("[HMR] Type not found: "+t);continue}const i=s[t],n=uc.get(i.name);let o="[Needle Engine] Updating type: "+t;const a=(n==null?void 0:n.length)??-1;a>0?o+=" x"+a:o+=" - no instances",console.log(o);const l=Object.getOwnPropertyNames(e.prototype),c=Object.getOwnPropertyDescriptors(i.prototype);for(const d in c)c[d].writable&&(e.prototype[d]=s[t].prototype[d]);for(const d of l)c[d]||delete e.prototype[d];if(n){const d=new i,u=Object.getOwnPropertyDescriptors(d);for(const f of n){const m=f,g=m.isComponent===!0,_=g?m.activeAndEnabled:!0,y=g?m.context:void 0;try{if(g&&y&&ls(m,y),g&&_&&(m.enabled=!1),f.onBeforeHotReloadFields&&f.onBeforeHotReloadFields()===!1)continue;for(const b in u)if(u[b].writable){if(f[b]===void 0)f[b]=d[b];else if(typeof f[b]=="function"&&!f[b].prototype){const w=f[b],P=w.name,k="bound ";if(P===k)continue;const O=w.name.substring(k.length),M=i.prototype[O];M&&(f[b]=M.bind(f))}}f.onAfterHotReloadFields&&f.onAfterHotReloadFields()}finally{g&&y&&Zm(m,y),g&&_&&(m.enabled=!0)}}}}catch(e){if(Ed)console.error(e);else return!1}finally{Dc=!1,Tn(bi.Log,"Script changes applied (HMR)")}return!0}const _t=x("debugphysics"),mp=x("debugcolliderplacement"),gp=x("debugcollisions"),NT=x("showcolliders"),_p=x("debugraycasts"),Zt=Symbol("needle component"),Ft=Symbol("physics body"),Cb=Symbol("rigidbody");globalThis.false=globalThis.false!==void 0?globalThis.false:!0;_t&&console.log("Use Rapier",!1,globalThis.false);const vc=class{constructor(t){r(this,"debugRenderColliders",!1);r(this,"debugRenderRaycasts",!1);r(this,"context");r(this,"_initializePromise");r(this,"_isInitialized",!1);r(this,"rapierRay");r(this,"raycastVectorsBuffer",new xi(()=>new h.Vector3,10));r(this,"rapierSphere",null);r(this,"rapierColliderArray",[]);r(this,"rapierIdentityRotation",{x:0,y:0,z:0,w:1});r(this,"rapierForwardVector",{x:0,y:0,z:1});r(this,"enabled",!1);r(this,"_tempPosition",new h.Vector3);r(this,"_tempQuaternion",new h.Quaternion);r(this,"_tempScale",new h.Vector3);r(this,"_tempMatrix",new h.Matrix4);r(this,"_isUpdatingPhysicsWorld",!1);r(this,"_world");r(this,"_hasCreatedWorld",!1);r(this,"eventQueue");r(this,"collisionHandler");r(this,"objects",[]);r(this,"bodies",[]);r(this,"_meshCache",new Map);r(this,"_gravity",{x:0,y:-9.81,z:0});r(this,"lines");r(this,"_tempCenterPos",new h.Vector3);r(this,"_tempCenterVec",new h.Vector3);r(this,"_tempCenterQuaternion",new h.Quaternion);this.context=t}removeBody(t){var i,n,o;if(!t)return;this.validate();const e=t[Ft];if(t[Ft]=null,e&&this.world){const a=this.objects.findIndex(l=>l===t);if(a>=0){const l=this.bodies[a];if(this.bodies.splice(a,1),this.objects.splice(a,1),l instanceof exports.MODULES.RAPIER_PHYSICS.MODULE.Collider){const c=l;(i=this.world)==null||i.removeCollider(c,!0);const d=c.parent();d&&d.numColliders()<=0&&(d[Zt]||(n=this.world)==null||n.removeRigidBody(d))}else l instanceof exports.MODULES.RAPIER_PHYSICS.MODULE.RigidBody&&(l.numColliders()<=0?(o=this.world)==null||o.removeRigidBody(l):B()&&(l.did_log_removing||setTimeout(()=>{l.numColliders()>0&&(l.did_log_removing=!0,console.warn("RapierPhysics: removing rigidbody with colliders from the physics world is not possible right now, please remove the colliders first"))},1)))}}}updateBody(t,e,i){if(this.validate(),!!this.enabled&&!(t.destroyed||!t.gameObject)&&!(!e&&!i))if(t.isCollider===!0)console.warn("TODO: implement updating collider position");else{const n=t,o=n[Ft];o&&this.syncPhysicsBody(n.gameObject,o,e,i)}}updateProperties(t){if(this.validate(),t.isCollider){const e=t,i=e[Ft];i&&(this.internalUpdateColliderProperties(e,i),e.sharedMaterial&&this.updatePhysicsMaterial(e))}else{const e=t,i=this.internal_getRigidbody(e);i&&this.internalUpdateRigidbodyProperties(e,i)}}addForce(t,e,i){this.validate();const n=this.internal_getRigidbody(t);n?n.addForce(e,i):console.warn("Rigidbody doesn't exist: can not apply force (does your object with the Rigidbody have a collider?)")}addImpulse(t,e,i){this.validate();const n=this.internal_getRigidbody(t);n?n.applyImpulse(e,i):console.warn("Rigidbody doesn't exist: can not apply impulse (does your object with the Rigidbody have a collider?)")}getLinearVelocity(t){this.validate();const e=this.internal_getRigidbody(t);return e?e.linvel():null}getAngularVelocity(t){this.validate();const e=this.internal_getRigidbody(t);return e?e.angvel():null}resetForces(t,e){this.validate();const i=this.internal_getRigidbody(t);i==null||i.resetForces(e)}resetTorques(t,e){this.validate();const i=this.internal_getRigidbody(t);i==null||i.resetTorques(e)}applyImpulse(t,e,i){this.validate();const n=this.internal_getRigidbody(t);n?n.applyImpulse(e,i):console.warn("Rigidbody doesn't exist: can not apply impulse (does your object with the Rigidbody have a collider?)")}wakeup(t){this.validate();const e=this.internal_getRigidbody(t);e?e.wakeUp():console.warn("Rigidbody doesn't exist: can not wake up (does your object with the Rigidbody have a collider?)")}isSleeping(t){this.validate();const e=this.internal_getRigidbody(t);return e==null?void 0:e.isSleeping()}setAngularVelocity(t,e,i){this.validate();const n=this.internal_getRigidbody(t);n?n.setAngvel(e,i):console.warn("Rigidbody doesn't exist: can not set angular velocity (does your object with the Rigidbody have a collider?)")}setLinearVelocity(t,e,i){this.validate();const n=this.internal_getRigidbody(t);n?n.setLinvel(e,i):console.warn("Rigidbody doesn't exist: can not set linear velocity (does your object with the Rigidbody have a collider?)")}get isInitialized(){return this._isInitialized}async initialize(){return this._initializePromise||(this._initializePromise=this.internalInitialization()),this._initializePromise}async internalInitialization(){return x("__nophysics")?(console.warn("Physics are disabled"),!1):(_t&&console.log("Initialize rapier physics engine"),"env"in{url:typeof document>"u"?require("url").pathToFileURL(__filename).href:_a&&_a.tagName.toUpperCase()==="SCRIPT"&&_a.src||new URL("needle-engine.bundle.light.umd.cjs",document.baseURI).href}&&{}.VITE_NEEDLE_USE_RAPIER==="false"&&_t&&console.log("Rapier disabled"),!1)}validate(){this._isInitialized||_t&&(this._lastWarnTime=this._lastWarnTime??0,Date.now()-this._lastWarnTime>1e3&&(this._lastWarnTime=Date.now(),console.warn("Physics engine is not initialized")))}raycast(t,e,i){var c;if(!this._isInitialized)return console.log("Physics engine is not initialized"),null;let n=i==null?void 0:i.maxDistance,o=i==null?void 0:i.solid;n===void 0&&(n=1/0),o===void 0&&(o=!0);const a=this.getPhysicsRay(this.rapierRay,t,e);if(!a)return null;(this.debugRenderRaycasts||_p)&&N.DrawRay(a.origin,a.dir,255,1);const l=(c=this.world)==null?void 0:c.castRay(a,n,o,i==null?void 0:i.queryFilterFlags,i==null?void 0:i.filterGroups,void 0,void 0,d=>{const u=d[Zt];return i!=null&&i.filterPredicate?i.filterPredicate(u):(i==null?void 0:i.useIgnoreRaycastLayer)!==!1?!(u!=null&&u.gameObject.layers.isEnabled(2)):!0});if(l){const d=a.pointAt(l.timeOfImpact),u=this.raycastVectorsBuffer.get();return u.set(d.x,d.y,d.z),{point:u,collider:l.collider[Zt]}}return null}raycastAndGetNormal(t,e,i){var c;if(!this._isInitialized)return null;let n=i==null?void 0:i.maxDistance,o=i==null?void 0:i.solid;n===void 0&&(n=1/0),o===void 0&&(o=!0);const a=this.getPhysicsRay(this.rapierRay,t,e);if(!a)return null;(this.debugRenderRaycasts||_p)&&N.DrawRay(a.origin,a.dir,255,1);const l=(c=this.world)==null?void 0:c.castRayAndGetNormal(a,n,o,i==null?void 0:i.queryFilterFlags,i==null?void 0:i.filterGroups,void 0,void 0,d=>{const u=d[Zt];return i!=null&&i.filterPredicate?i.filterPredicate(u):(i==null?void 0:i.useIgnoreRaycastLayer)!==!1?!(u!=null&&u.gameObject.layers.isEnabled(2)):!0});if(l){const d=a.pointAt(l.timeOfImpact),u=l.normal,f=this.raycastVectorsBuffer.get(),m=this.raycastVectorsBuffer.get();return f.set(d.x,d.y,d.z),m.set(u.x,u.y,u.z),{point:f,normal:m,collider:l.collider[Zt]}}return null}getPhysicsRay(t,e,i){var l,c,d;const n=(l=this.context)==null?void 0:l.mainCamera;if(e===void 0){const u=(c=this.context)==null?void 0:c.input.getPointerPosition(0);if(u)e=u;else return null}if(e.z===void 0){if(!n)return console.error("Can not perform raycast from 2d point - no main camera found"),null;const u=this.raycastVectorsBuffer.get();u.x=e.x,u.y=e.y,u.z=0,(u.x>1||u.y>1||u.y<-1||u.x<-1)&&(_t&&console.warn("Converting screenspace to raycast space",u),(d=this.context)==null||d.input.convertScreenspaceToRaycastSpace(u)),u.unproject(n),e=u}const o=e;t.origin.x=o.x,t.origin.y=o.y,t.origin.z=o.z;const a=this.raycastVectorsBuffer.get();if(i)a.set(i.x,i.y,i.z);else{if(!n)return console.error("Can not perform raycast - no camera found"),null;a.set(t.origin.x,t.origin.y,t.origin.z);const u=Z(n);a.sub(u)}return a.normalize(),t.dir.x=a.x,t.dir.y=a.y,t.dir.z=a.z,t}sphereOverlap(t,e){return this.rapierColliderArray.length=0,this._isInitialized?this.world?(this.rapierSphere??(this.rapierSphere=new exports.MODULES.RAPIER_PHYSICS.MODULE.Ball(e)),this.rapierSphere.radius=e,(this.debugRenderRaycasts||_p)&&N.DrawWireSphere(t,e,3359999,1),this.world.intersectionsWithShape(t,this.rapierIdentityRotation,this.rapierSphere,i=>{const n=i[Zt],o=new Iv(n.gameObject,n);return this.rapierColliderArray.push(o),!0},void 0,void 0,void 0,void 0,i=>i.isSensor()?!1:i[Zt].gameObject.layers.isEnabled(2)==!1),this.rapierColliderArray):this.rapierColliderArray:this.rapierColliderArray}get world(){return this._world}get isUpdating(){return this._isUpdatingPhysicsWorld}get gravity(){var t;return((t=this.world)==null?void 0:t.gravity)??this._gravity}set gravity(t){this.world?this.world.gravity=t:this._gravity=t}clearCaches(){var t,e,i,n;this._meshCache.clear(),(t=this.eventQueue)!=null&&t.raw&&((e=this.eventQueue)==null||e.free()),(i=this.world)!=null&&i.bodies&&((n=this.world)==null||n.free())}async addBoxCollider(t,e){if(this._isInitialized||await this.initialize(),!t.activeAndEnabled)return;if(!this.enabled){_t&&console.warn("Physics are disabled");return}const i=t.gameObject,n=Ue(i,this._tempPosition).multiply(e);n.multiplyScalar(.5),n.x<0&&(n.x=Math.abs(n.x)),n.y<0&&(n.y=Math.abs(n.y)),n.z<0&&(n.z=Math.abs(n.z)),n.x==0&&(n.x=1e-7),n.y==0&&(n.y=1e-7),n.z==0&&(n.z=1e-7);const o=exports.MODULES.RAPIER_PHYSICS.MODULE.ColliderDesc.cuboid(n.x,n.y,n.z);this.createCollider(t,o)}async addSphereCollider(t){if(this._isInitialized||await this.initialize(),!t.activeAndEnabled)return;if(!this.enabled){_t&&console.warn("Physics are disabled");return}const e=exports.MODULES.RAPIER_PHYSICS.MODULE.ColliderDesc.ball(.5);this.createCollider(t,e),this.updateProperties(t)}async addCapsuleCollider(t,e,i){if(this._isInitialized||await this.initialize(),!t.activeAndEnabled)return;if(!this.enabled){_t&&console.warn("Physics are disabled");return}const n=t.gameObject,o=Ue(n,this._tempPosition);o.x=Math.abs(o.x),o.y=Math.abs(o.y);const a=i*o.x;e=Math.max(e,a*2);const l=z.clamp(e*.5*o.y-i*o.x,0,Number.MAX_SAFE_INTEGER),c=exports.MODULES.RAPIER_PHYSICS.MODULE.ColliderDesc.capsule(l,a);this.createCollider(t,c)}async addMeshCollider(t,e,i,n){var f,m,g;let o=e.geometry;if(!o){_t&&console.warn("Missing mesh geometry",e.name);return}(m=(f=o.index)==null?void 0:f.array)!=null&&m.length||(console.warn(`Your MeshCollider is missing vertices or indices in the assined mesh "${e.name}". Consider providing an indexed geometry.`),o=Y.mergeVertices(o));let a=null;const l=o.getAttribute("position");if(l instanceof h.InterleavedBufferAttribute){const _=l.count;a=new Float32Array(_*3);for(let y=0;y<_;y++){const b=l.getX(y),v=l.getY(y),w=l.getZ(y);a[y*3]=b,a[y*3+1]=v,a[y*3+2]=w}}else a=l.array;if(await this.initialize(),!this.enabled){_t&&console.warn("Physics are disabled");return}if(!t.activeAndEnabled)return;const c=(g=o.index)==null?void 0:g.array,d=t.gameObject.worldScale.clone();if(n&&d.multiply(n),Math.abs(d.x-1)>1e-4||Math.abs(d.y-1)>1e-4||Math.abs(d.z-1)>1e-4){const _=`${o.uuid}_${d.x}_${d.y}_${d.z}_${i}`;if(this._meshCache.has(_))_t&&console.warn("Use cached mesh collider"),a=this._meshCache.get(_);else{(_t||B())&&console.debug(`[Performance] Your MeshCollider "${t.name}" is scaled: consider applying the scale to the collider mesh instead (${d.x}, ${d.y}, ${d.z})`);const y=new Float32Array(a.length);for(let b=0;b<a.length;b+=3)y[b]=a[b]*d.x,y[b+1]=a[b+1]*d.y,y[b+2]=a[b+2]*d.z;a=y,this._meshCache.set(_,y)}}const u=i?exports.MODULES.RAPIER_PHYSICS.MODULE.ColliderDesc.convexHull(a):exports.MODULES.RAPIER_PHYSICS.MODULE.ColliderDesc.trimesh(a,c);u&&this.createCollider(t,u)}updatePhysicsMaterial(t){if(!t)return;const e=t.sharedMaterial,i=t[Ft];if(i&&e){if(e.bounciness!==void 0&&i.setRestitution(e.bounciness),e.bounceCombine!==void 0)switch(e.bounceCombine){case at.Average:i.setRestitutionCombineRule(exports.MODULES.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Average);break;case at.Maximum:i.setRestitutionCombineRule(exports.MODULES.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Max);break;case at.Minimum:i.setRestitutionCombineRule(exports.MODULES.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Min);break;case at.Multiply:i.setRestitutionCombineRule(exports.MODULES.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Multiply);break}if(e.dynamicFriction!==void 0&&i.setFriction(e.dynamicFriction),e.frictionCombine!==void 0)switch(e.frictionCombine){case at.Average:i.setFrictionCombineRule(exports.MODULES.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Average);break;case at.Maximum:i.setFrictionCombineRule(exports.MODULES.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Max);break;case at.Minimum:i.setFrictionCombineRule(exports.MODULES.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Min);break;case at.Multiply:i.setFrictionCombineRule(exports.MODULES.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Multiply);break}}}getBody(t){return t?t[Ft]:null}getComponent(t){return t?t[Zt]:null}createCollider(t,e){var a;if(!this.world)throw new Error("Physics world not initialized");const i=this._tempMatrix;let n;t.attachedRigidbody?n=this.getRigidbody(t,this._tempMatrix):(_t&&console.log("Create collider without rigidbody",t.name),i.makeRotationFromQuaternion(_e(t.gameObject)),i.setPosition(Z(t.gameObject))),i.decompose(this._tempPosition,this._tempQuaternion,this._tempScale),this.tryApplyCenter(t,this._tempPosition),e.setTranslation(this._tempPosition.x,this._tempPosition.y,this._tempPosition.z),e.setRotation(this._tempQuaternion),e.setSensor(t.isTrigger);const o=t.sharedMaterial;if(o){if(o.bounciness!==void 0&&e.setRestitution(o.bounciness),o.bounceCombine!==void 0)switch(o.bounceCombine){case at.Average:e.setRestitutionCombineRule(exports.MODULES.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Average);break;case at.Maximum:e.setRestitutionCombineRule(exports.MODULES.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Max);break;case at.Minimum:e.setRestitutionCombineRule(exports.MODULES.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Min);break;case at.Multiply:e.setRestitutionCombineRule(exports.MODULES.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Multiply);break}if(o.dynamicFriction!==void 0&&e.setFriction(o.dynamicFriction),o.frictionCombine!==void 0)switch(o.frictionCombine){case at.Average:e.setFrictionCombineRule(exports.MODULES.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Average);break;case at.Maximum:e.setFrictionCombineRule(exports.MODULES.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Max);break;case at.Minimum:e.setFrictionCombineRule(exports.MODULES.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Min);break;case at.Multiply:e.setFrictionCombineRule(exports.MODULES.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Multiply);break}}((a=t.attachedRigidbody)==null?void 0:a.autoMass)===!1&&(e.setDensity(1e-6),e.setMass(1e-6));try{const l=this.world.createCollider(e,n);return l[Zt]=t,t[Ft]=l,l.setActiveEvents(exports.MODULES.RAPIER_PHYSICS.MODULE.ActiveEvents.COLLISION_EVENTS),l.setActiveCollisionTypes(exports.MODULES.RAPIER_PHYSICS.MODULE.ActiveCollisionTypes.ALL),this.objects.push(t),this.bodies.push(l),this.updateColliderCollisionGroups(t),l}catch(l){return console.error('Error creating collider "'+t.name+`"
Error:`,l),null}}updateColliderCollisionGroups(t){const e=t[Ft],i=t.membership;let n=0;if(i==null)n=65535;else for(let l=0;l<i.length;l++){const c=i[l];c>31?console.error(`Rapier only supports 32 layers, layer ${c} is not supported`):n|=1<<Math.floor(c)}const o=t.filter;let a=0;if(o==null)a=65535;else for(let l=0;l<o.length;l++){const c=o[l];c>31?console.error(`Rapier only supports 32 layers, layer ${c} is not supported`):a|=1<<Math.floor(c)}e.setCollisionGroups(n<<16|a)}getRigidbody(t,e){if(!this.world)throw new Error("Physics world not initialized");let i=null;if(t.attachedRigidbody){const n=t.attachedRigidbody;if(i=n[Ft],!i){const o=n.isKinematic&&!mp;_t&&console.log("Create rigidbody",o);const a=o?exports.MODULES.RAPIER_PHYSICS.MODULE.RigidBodyDesc.kinematicPositionBased():exports.MODULES.RAPIER_PHYSICS.MODULE.RigidBodyDesc.dynamic(),l=Z(t.attachedRigidbody.gameObject);a.setTranslation(l.x,l.y,l.z),a.setRotation(_e(t.attachedRigidbody.gameObject)),a.centerOfMass=new exports.MODULES.RAPIER_PHYSICS.MODULE.Vector3(n.centerOfMass.x,n.centerOfMass.y,n.centerOfMass.z),i=this.world.createRigidBody(a),this.bodies.push(i),this.objects.push(n)}i[Zt]=n,n[Ft]=i,this.internalUpdateRigidbodyProperties(n,i),this.getRigidbodyRelativeMatrix(t.gameObject,n.gameObject,e),t[Cb]=i}else{const n=exports.MODULES.RAPIER_PHYSICS.MODULE.RigidBodyDesc.kinematicPositionBased(),o=Z(t.gameObject);n.setTranslation(o.x,o.y,o.z),n.setRotation(_e(t.gameObject)),i=this.world.createRigidBody(n),e.identity(),i[Zt]=null}return i}internal_getRigidbody(t){return t.isCollider===!0?t[Cb]:t[Ft]}internalUpdateColliderProperties(t,e){const i=e.shape;let n=!1;switch(i.type){case exports.MODULES.RAPIER_PHYSICS.MODULE.ShapeType.Ball:{const m=i,g=t,_=t.gameObject,y=Ue(_,this._tempPosition),b=Math.abs(g.radius*y.x);n=m.radius!==b,m.radius=b,n&&e.setShape(m);break}case exports.MODULES.RAPIER_PHYSICS.MODULE.ShapeType.Cuboid:const o=i,a=t,l=t.gameObject,c=Ue(l,this._tempPosition),d=a.size.x*.5*c.x,u=a.size.y*.5*c.y,f=a.size.z*.5*c.z;n=o.halfExtents.x!==d||o.halfExtents.y!==u||o.halfExtents.z!==f,o.halfExtents.x=d,o.halfExtents.y=u,o.halfExtents.z=f,n&&e.setShape(o);break}if(n){const o=t.attachedRigidbody;if(o!=null&&o.autoMass){const a=this.getBody(o);a==null||a.recomputeMassPropertiesFromColliders()}}this.updateColliderCollisionGroups(t),t.isTrigger!==e.isSensor()&&e.setSensor(t.isTrigger)}internalUpdateRigidbodyProperties(t,e){if(e.enableCcd(t.collisionDetectionMode!==Du.Discrete),e.setLinearDamping(t.drag),e.setAngularDamping(t.angularDrag),e.setGravityScale(t.useGravity?t.gravityScale:0,!0),t.dominanceGroup<=127&&t.dominanceGroup>=-127?e.setDominanceGroup(Math.floor(t.dominanceGroup)):e.setDominanceGroup(0),t.autoMass){e.setAdditionalMass(0,!1);for(let i=0;i<e.numColliders();i++)e.collider(i).setDensity(1);e.recomputeMassPropertiesFromColliders()}else{e.setAdditionalMass(t.mass,!1);for(let i=0;i<e.numColliders();i++)e.collider(i).setDensity(1e-7);e.recomputeMassPropertiesFromColliders()}e.setEnabledRotations(!t.lockRotationX,!t.lockRotationY,!t.lockRotationZ,!1),e.setEnabledTranslations(!t.lockPositionX,!t.lockPositionY,!t.lockPositionZ,!1),t.isKinematic?e.setBodyType(exports.MODULES.RAPIER_PHYSICS.MODULE.RigidBodyType.KinematicPositionBased,!1):e.setBodyType(exports.MODULES.RAPIER_PHYSICS.MODULE.RigidBodyType.Dynamic,!1)}step(t){if(this.world&&this.enabled){if(this._isUpdatingPhysicsWorld=!0,this.eventQueue||(this.eventQueue=new exports.MODULES.RAPIER_PHYSICS.MODULE.EventQueue(!1)),t===void 0||t<=0){this._isUpdatingPhysicsWorld=!1;return}else t!==void 0&&(this.world.timestep=z.lerp(this.world.timestep,t,.8));try{this.world.step(this.eventQueue)}catch(e){console.warn("Error running physics step",e)}this._isUpdatingPhysicsWorld=!1}}postStep(){this.world&&this.enabled&&(this._isUpdatingPhysicsWorld=!0,this.syncObjects(),this._isUpdatingPhysicsWorld=!1,this.eventQueue&&!this.collisionHandler&&(this.collisionHandler=new VT(this.world,this.eventQueue)),this.collisionHandler&&(this.collisionHandler.handleCollisionEvents(),this.collisionHandler.update()),this.updateDebugRendering(this.world))}updateDebugRendering(t){var e,i,n,o;if(_t||mp||NT||this.debugRenderColliders===!0){if(!this.lines){const l=new h.LineBasicMaterial({color:7855479,fog:!1}),c=new h.BufferGeometry;this.lines=new h.LineSegments(c,l),this.lines.layers.disableAll(),this.lines.layers.enable(2)}this.lines.parent!==((e=this.context)==null?void 0:e.scene)&&((i=this.context)==null||i.scene.add(this.lines));const a=t.debugRender();this.lines.geometry.setAttribute("position",new h.BufferAttribute(a.vertices,3)),this.lines.geometry.setAttribute("color",new h.BufferAttribute(a.colors,4)),(this.context.time.frame%30===0||((n=this.lines.geometry.boundingSphere)==null?void 0:n.radius)===0)&&this.lines.geometry.computeBoundingSphere()}else this.lines&&((o=this.context)==null||o.scene.remove(this.lines))}syncObjects(){if(!mp)for(let t=0;t<this.bodies.length;t++){const e=this.objects[t],i=this.bodies[t],n=e;if((n==null?void 0:n.isCollider)===!0&&!n.attachedRigidbody){const c=i.parent();c?this.syncPhysicsBody(e.gameObject,c,!0,!0):this.syncPhysicsBody(e.gameObject,i,!0,!0);continue}const o=i.translation(),a=i.rotation();if(Number.isNaN(o.x)||Number.isNaN(a.x)){!n.__COLLIDER_NAN&&B()&&(console.warn("Collider has NaN values",n.name,n.gameObject,i),n.__COLLIDER_NAN=!0);continue}const l=e.center;if(l&&l.isVector3){this._tempQuaternion.set(a.x,a.y,a.z,a.w);const c=this._tempPosition.copy(l).applyQuaternion(this._tempQuaternion),d=Ue(e.gameObject);c.multiply(d),o.x-=c.x,o.y-=c.y,o.z-=c.z}ar(e.gameObject,o.x,o.y,o.z),Am(e.gameObject,a.x,a.y,a.z,a.w)}}syncPhysicsBody(t,e,i,n){if(e instanceof exports.MODULES.RAPIER_PHYSICS.MODULE.RigidBody){const o=Z(t,this._tempPosition),a=_e(t,this._tempQuaternion);switch(e.bodyType()){case exports.MODULES.RAPIER_PHYSICS.MODULE.RigidBodyType.Fixed:case exports.MODULES.RAPIER_PHYSICS.MODULE.RigidBodyType.KinematicPositionBased:case exports.MODULES.RAPIER_PHYSICS.MODULE.RigidBodyType.KinematicVelocityBased:i&&e.setNextKinematicTranslation(o),n&&e.setNextKinematicRotation(a);break;default:i&&e.setTranslation(o,!1),n&&e.setRotation(a,!1);break}}else if(e instanceof exports.MODULES.RAPIER_PHYSICS.MODULE.Collider){t.matrixWorldNeedsUpdate&&t.updateWorldMatrix(!0,!1),t.matrixWorld.decompose(this._tempPosition,this._tempQuaternion,this._tempScale);const o=this._tempPosition,a=this._tempQuaternion,l=e[Zt];if(this.tryApplyCenter(l,o),i){const c=e.translation();(c.x!==o.x||c.y!==o.y||c.z!==o.z)&&e.setTranslation(o)}if(n){const c=e.rotation();(c.x!==a.x||c.y!==a.y||c.z!==a.z||c.w!==a.w)&&e.setRotation(a)}}}tryApplyCenter(t,e){const i=t.center;i&&t.gameObject&&(i.x!==0||i.y!==0||i.z!==0)&&(this._tempCenterPos.x=i.x,this._tempCenterPos.y=i.y,this._tempCenterPos.z=i.z,Ue(t.gameObject,this._tempCenterVec),this._tempCenterPos.multiply(this._tempCenterVec),t.attachedRigidbody?this._tempCenterPos.applyQuaternion(t.gameObject.quaternion):(_e(t.gameObject,this._tempCenterQuaternion),this._tempCenterPos.applyQuaternion(this._tempCenterQuaternion)),e.x+=this._tempCenterPos.x,e.y+=this._tempCenterPos.y,e.z+=this._tempCenterPos.z)}getRigidbodyRelativeMatrix(t,e,i,n){if(n===void 0&&(n=vc._matricesBuffer,n.length=0),t===e){const o=Ue(t,this._tempPosition);i.makeScale(o.x,o.y,o.z);for(let a=n.length-1;a>=0;a--)i.multiply(n[a]);return i}return n.push(t.matrix),t.parent&&this.getRigidbodyRelativeMatrix(t.parent,e,i,n),i}addFixedJoint(t,e){if(!this.world){console.error("Physics world not initialized");return}const i=t[Ft],n=e[Ft];this.calculateJointRelativeMatrices(t.gameObject,e.gameObject,this._tempMatrix),this._tempMatrix.decompose(this._tempPosition,this._tempQuaternion,this._tempScale);const o=exports.MODULES.RAPIER_PHYSICS.MODULE.JointData.fixed(vc.centerConnectionPos,vc.centerConnectionRot,this._tempPosition,this._tempQuaternion),a=this.world.createImpulseJoint(o,i,n,!0);_t&&console.log("ADD FIXED JOINT",a)}addHingeJoint(t,e,i,n){if(!this.world){console.error("Physics world not initialized");return}const o=t[Ft],a=e[Ft];this.calculateJointRelativeMatrices(t.gameObject,e.gameObject,this._tempMatrix),this._tempMatrix.decompose(this._tempPosition,this._tempQuaternion,this._tempScale);const l=exports.MODULES.RAPIER_PHYSICS.MODULE.JointData.revolute(i,this._tempPosition,n),c=this.world.createImpulseJoint(l,o,a,!0);_t&&console.log("ADD HINGE JOINT",c)}calculateJointRelativeMatrices(t,e,i){t.updateWorldMatrix(!0,!1),e.updateWorldMatrix(!0,!1);const n=t.matrixWorld,o=e.matrixWorld;n.elements[0]=1,n.elements[5]=1,n.elements[10]=1,o.elements[0]=1,o.elements[5]=1,o.elements[10]=1,i.copy(o).premultiply(n.invert()).invert()}};let jo=vc;r(jo,"_didLoadPhysicsEngine",!1),r(jo,"_matricesBuffer",[]),r(jo,"centerConnectionPos",{x:0,y:0,z:0}),r(jo,"centerConnectionRot",{x:0,y:0,z:0,w:1});class VT{constructor(t,e){r(this,"world");r(this,"eventQueue");r(this,"activeCollisions",[]);r(this,"activeCollisionsStay",[]);r(this,"activeTriggers",[]);this.world=t,this.eventQueue=e}handleCollisionEvents(){this.eventQueue&&this.world&&this.eventQueue.drainCollisionEvents((t,e,i)=>{const n=this.world.getCollider(t),o=this.world.getCollider(e);if(!n||!o)return;const a=n[Zt],l=o[Zt];gp&&console.log("EVT",a.name,l.name,i,n,o),a&&l&&(i?(this.onCollisionStarted(a,n,l,o),this.onCollisionStarted(l,o,a,n)):(this.onCollisionEnded(a,l),this.onCollisionEnded(l,a)))})}update(){this.onHandleCollisionStay()}onCollisionStarted(t,e,i,n){let o=null;if(t.isTrigger||i.isTrigger)hr(t.gameObject,a=>{a.onTriggerEnter&&!a.destroyed&&a.onTriggerEnter(i),this.activeTriggers.push({collider:t,component:a,otherCollider:i})});else{const a=t.gameObject;this.world.contactPair(e,n,(l,c)=>{hr(a,d=>{var f;if(d.destroyed)return;const u=d.onCollisionEnter||d.onCollisionStay||d.onCollisionExit;if(u||gp){if(!o){const m=[],g=l.normal();i instanceof vo&&i.convex&&(g.x=-g.x,g.y=-g.y,g.z=-g.z);for(let _=0;_<l.numSolverContacts();_++){const y=l.solverContactPoint(_),b=l.contactImpulse(_);if(y){const v=l.contactDist(_),w=l.solverContactFriction(_),P=l.solverContactTangentVelocity(_),k=new Dv(y,v,g,b,w,P);m.push(k),gp&&N.DrawDirection(y,g,16711680,3,!0)}}o=new Lv(a,i,m)}if(u){const m={collider:t,component:d,collision:o};this.activeCollisions.push(m),d.onCollisionStay&&this.activeCollisionsStay.push(m),(f=d.onCollisionEnter)==null||f.call(d,o)}}})})}}onHandleCollisionStay(){for(const t of this.activeCollisionsStay){const e=t.component;if(!e.destroyed&&e.activeAndEnabled&&e.onCollisionStay){if(t.collision.collider.destroyed)continue;const i=t.collision;e.onCollisionStay(i)}}for(const t of this.activeTriggers){const e=t.component;if(!e.destroyed&&e.activeAndEnabled&&e.onTriggerStay){const i=t.otherCollider;if(i.destroyed)continue;e.onTriggerStay(i)}}}onCollisionEnded(t,e){if(!(t.destroyed||e.destroyed)){for(let i=0;i<this.activeCollisions.length;i++){const n=this.activeCollisions[i],o=n.collider;if(o.destroyed||n.collision.collider.destroyed){this.activeCollisions.splice(i,1),i--;continue}if(o===t&&n.collision.collider===e){const a=n.component;if(this.activeCollisions.splice(i,1),i--,a.activeAndEnabled&&a.onCollisionExit){const l=n.collision;a.onCollisionExit(l)}}}for(let i=0;i<this.activeCollisionsStay.length;i++){const n=this.activeCollisionsStay[i],o=n.collider;if(o.destroyed||n.collision.collider.destroyed){this.activeCollisionsStay.splice(i,1),i--;continue}if(o===t&&n.collision.collider===e){const a=n.component;if(this.activeCollisionsStay.splice(i,1),i--,a.activeAndEnabled&&a.onCollisionExit){const l=n.collision;a.onCollisionExit(l)}}}for(let i=0;i<this.activeTriggers.length;i++){const n=this.activeTriggers[i],o=n.collider;if(o.destroyed||n.otherCollider.destroyed){this.activeTriggers.splice(i,1),i--;continue}if(o===t&&n.otherCollider===e){const a=n.component;if(this.activeTriggers.splice(i,1),i--,a.activeAndEnabled&&a.onTriggerExit){const l=n.otherCollider;a.onTriggerExit(l)}}}}}}class $T{static async createComparisonScene(t){const{files:e}=t,n=await Promise.all(e.map(b=>new ee(b).loadAssetAsync())),o=new h.Scene;let a=0;for(const b of n)if(b instanceof h.Object3D){b.position.y=a,o.add(b);const v=si([b]);a+=v.getSize(new h.Vector3).y,a+=.1}const l=new h.PerspectiveCamera(20);o.add(l);const c=t.environment||"https://dl.polyhaven.org/file/ph-assets/HDRIs/exr/1k/studio_small_09_1k.exr";if(c){let b=null;if(c.endsWith(".hdr")){const v=(await Promise.resolve().then(()=>require("./three-examples.light.umd.cjs")).then(w=>w.RGBELoader$1)).RGBELoader;b=new v}else if(c.endsWith(".exr")){const v=(await Promise.resolve().then(()=>require("./three-examples.light.umd.cjs")).then(w=>w.EXRLoader$1)).EXRLoader;b=new v}if(b){const v=await b.loadAsync(c).catch(w=>(console.error(w),null));v&&(v.mapping=h.EquirectangularReflectionMapping,v.needsUpdate=!0,o.background=v,o.environment=v,o.backgroundBlurriness=.75)}else console.warn("Unsupported environment map format",c)}const d=si(o.children),u=d.getCenter(new h.Vector3),f=d.getSize(new h.Vector3),g=Math.max(f.x,f.y,f.z)/(2*Math.tan(Math.PI*l.fov/360));l.position.set(u.x,u.y,g),l.lookAt(u);const _=new Y.OrbitControls(l,t.domElement||document.body);_.target=u,_.update();const y=(t.domElement||document.body).getBoundingClientRect();return l.aspect=y.width/y.height,l.updateProjectionMatrix(),{scene:o,camera:l}}}let Cm=0;function Pb(s){s?Cm++:Cm--}function WT(){return Cm>0}const GT={binary:!0,animations:!0};async function HT(s){if(!s.context)throw new Error("No context provided to exportAsGLTF");s.scene||(s.scene=s.context.scene);const t={...GT,...s},{context:e}=t,i=new Y.GLTFExporter;i.register(l=>new Qv(l)),i.register(l=>new xO(l)),i.register(l=>new Gv(l)),Mg(i,t.context);const n={binary:t.binary,animations:XT(e,t.scene,[])},o=new qT;console.debug("Exporting GLTF",n),o.onBeforeExport(t),Pb(!0);const a=await i.parseAsync(t.scene,n).catch(l=>(console.error(l),null));if(Pb(!1),o.onAfterExport(t),!a)throw new Error("Failed to export GLTF");if(t.downloadAs!=null){let l=null;if(a instanceof ArrayBuffer?l=new Blob([a],{type:"application/octet-stream"}):console.error("Can not download GLTF as a blob",a),l){const c=URL.createObjectURL(l),d=document.createElement("a");d.href=c;let u=t.downloadAs;!u.endsWith(".glb")&&!u.endsWith(".gltf")&&(u+=t.binary?".glb":".gltf"),d.download=u,d.click()}}return a}const Ob=Symbol("needle:weight");class qT{constructor(){r(this,"_undo",[])}onBeforeExport(t){t.context.animations.mixers.forEach(e=>{const i=La.tryGetActionsFromMixer(e);if(i)for(let n=0;n<i.length;n++){const o=i[n];o[Ob]=o.weight,o.weight=0,this._undo.push(()=>{o.weight=o[Ob]})}e.update(0)}),t.context.scene.traverse(e=>{if(!rm(e)){const i=e.parent;i&&(e.removeFromParent(),this._undo.push(()=>i.add(e)))}})}onAfterExport(t){this._undo.forEach(e=>e()),this._undo.length=0}}function XT(s,t,e){s.animations.mixers.forEach(n=>{const o=La.tryGetActionsFromMixer(n);if(o)for(let a=0;a<o.length;a++){const c=o[a].getClip();e.push(c)}}),Array.isArray(t)||(t=[t]);for(const n of t)La.tryGetAnimationClipsFromObjectHierarchy(n,e);const i=new Set(e);return Array.from(i)}const Mb="needle-button",yp=B();var qo,Xo,Qo,zt,as,Ra,yu,ax,bu,lx,jc;class p_ extends HTMLElement{constructor(){super();Ei(this,yu);Ei(this,bu);Ei(this,qo,void 0);Ei(this,Xo,void 0);Ei(this,Qo,void 0);Ei(this,zt,void 0);Ei(this,as,void 0);Ei(this,Ra,void 0);Ei(this,jc,e=>{yp&&console.log("Needle Button clicked"),!e.defaultPrevented&&le(this,zt)&&le(this,zt).click()});this.removeEventListener("click",le(this,jc)),this.addEventListener("click",le(this,jc))}attributeChangedCallback(e,i,n){ml(this,yu,ax).call(this)}}qo=new WeakMap,Xo=new WeakMap,Qo=new WeakMap,zt=new WeakMap,as=new WeakMap,Ra=new WeakMap,yu=new WeakSet,ax=function(){var i,n;if((i=le(this,zt))==null||i.remove(),this.getAttribute("ar")!=null)le(this,as)??Ki(this,as,new _s),Ki(this,zt,le(this,as).createARButton());else if(this.getAttribute("vr")!=null)le(this,as)??Ki(this,as,new _s),Ki(this,zt,le(this,as).createVRButton());else if(this.getAttribute("quicklook")!=null)le(this,as)??Ki(this,as,new _s),Ki(this,zt,le(this,as).createQuicklookButton());else{yp?console.warn("No button type specified for <needle-button>. Use either ar, vr or quicklook attribute."):console.debug("No button type specified for <needle-button>. Use either ar, vr or quicklook attribute.");return}le(this,qo)??Ki(this,qo,this.attachShadow({mode:"open"})),le(this,Xo)??Ki(this,Xo,document.createElement("slot")),le(this,Qo)??Ki(this,Qo,document.createElement("style")),le(this,Qo).innerHTML=`
            button {
                all: initial;
                cursor: inherit;
                color: inherit;
                font-family: inherit;
                gap: inherit;
                white-space: nowrap;
            }
        `,this.getAttribute("unstyled")!=null||(le(this,Qo).innerHTML+=`
            :host {
                display: inline-block;
                background: rgba(255, 255, 255, .8);
                backdrop-filter: blur(10px);
                width: fit-content;
                transition: background .2s;

                cursor: pointer;
                padding: 0.4rem .5rem;
                border-radius: 0.8rem;
                color: black;
                background: rgba(245, 245, 245, .8);
                outline: rgba(0,0,0,.05) 1px solid;
            }
            :host(:hover) {
                background: rgba(255, 255, 255, 1);
                transition: background .2s;
            }
            slot {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: .5rem;
            }
`),le(this,Xo).innerHTML=le(this,zt).innerHTML,le(this,Xo).style.cssText="display: flex; align-items: center; justify-content: center;",le(this,zt).innerHTML=le(this,Xo).outerHTML,le(this,qo).innerHTML=le(this,zt).outerHTML,le(this,qo).prepend(le(this,Qo)),Gd(im,{element:le(this,qo)}),(n=le(this,Ra))==null||n.disconnect(),le(this,Ra)??Ki(this,Ra,new MutationObserver(()=>ml(this,bu,lx).call(this))),le(this,Ra).observe(le(this,zt),{attributes:!0}),yp&&console.log("Needle Button updated")},bu=new WeakSet,lx=function(){le(this,zt)&&(le(this,zt).style.display==="none"?this.style.display="none":this.style.display==="none"&&(this.style.display=""))},jc=new WeakMap,r(p_,"observedAttributes",["ar","vr","quicklook"]);typeof window<"u"&&!window.customElements.get(Mb)&&window.customElements.define(Mb,p_);const El=x("debugavatar");class m_{constructor(t,e,i,n){r(this,"root");r(this,"head");r(this,"leftHand");r(this,"rigthHand");var o;this.root=t,this.head=e,this.leftHand=i,this.rigthHand=n,(o=this.root)==null||o.traverse(a=>a.layers.set(2))}get isValid(){return this.head!==null&&this.head!==void 0}}class cx{constructor(){r(this,"avatarRegistryUrl",null)}async getOrCreateNewAvatarInstance(t,e){if(!e)return console.error("Can not create avatar: failed to provide id or root object"),null;let i=null;if(typeof e=="string"){if(i=await this.loadAvatar(t,e),!i){const o=new pn;i=S.instantiate(ka(e,t.scene),o)}}else i=e;if(!i)return null;const n=this.findAvatar(i);return n.isValid?(El&&console.log("[Custom Avatar] valid config",e,El?n:""),n):(console.warn("[Custom Avatar] config isn't valid",e,El?n:""),null)}async loadAvatar(t,e){if(console.assert(e!=null&&typeof e=="string","Avatar id must not be null"),e.length<=0||!e)return null;if(El&&console.log("[Custom Avatar] "+e+", loading..."),e.endsWith(".glb")||(e+=".glb"),this.avatarRegistryUrl===null){const n=await fetch("./"+e);let o=null;if(n.ok){const l=await n.blob();l&&(o=await l.arrayBuffer())}if(!o)return null;const a=await dn().parseSync(t,o,null,0);return(a==null?void 0:a.scene)??null}const i=new Y.GLTFLoader;return Tu(i,t),new Promise((n,o)=>{const a=this.avatarRegistryUrl+"/"+e;i.load(a,async l=>{await dn().createBuiltinComponents(t,a,l,null,void 0),n(l.scene)},l=>{El&&console.log("[Custom Avatar] "+l.loaded/l.total*100+"% loaded of "+l.total/1024+"kB")},l=>{console.error("[Custom Avatar] Error when loading: "+l),n(null)})})}cacheModel(t,e){}findAvatar(t){const e=t;let i=e;i.children.length==1&&(i=t.children[0]);let n=this.findAvatarPart(i,["head"]);const o=this.findAvatarPart(i,["left","hand"]),a=this.findAvatarPart(i,["right","hand"]);if(!n){n=e;const c=new h.Vector3;new h.Box3().setFromObject(n).getSize(c);const d=Math.max(c.x,c.y,c.z);console.warn("[Custom Avatar] Normalizing head scale, it's too big: "+d+" meters! Should be < 0.3m"),d>.3&&n.scale.multiplyScalar(1/d*.3)}return new m_(e,n,o,a)}findAvatarPart(t,e){const i=t.name.toLowerCase();let n=!0;for(const o of e){if(!n)break;i.indexOf(o)===-1&&(n=!1)}if(n)return t;if(t.children)for(const o of t.children){const a=this.findAvatarPart(o,e);if(a)return a}return null}handleCustomAvatarErrors(t){if(!t.ok)throw Error(t.statusText);return t}}class hx{get extensionName(){return"DocumentExtension"}onAfterBuildDocument(t){}}class dx{}const QT=Object.freeze(Object.defineProperty({__proto__:null,ActionBuilder:de,ActionCollection:pw,ActionModel:Jt,AlignmentConstraint:Zc,Animation:kt,AnimationCurve:sl,AnimationExtension:Nu,AnimationTrackHandler:nf,Animator:xt,AnimatorController:$i,Antialiasing:mh,AudioExtension:Cr,AudioListener:us,AudioSource:Ie,AudioTrackHandler:or,Avatar:ho,AvatarBlink_Simple:wr,AvatarEyeLook_Rotation:za,AvatarLoader:cx,AvatarMarker:tt,AvatarModel:m_,Avatar_Brain_LookAt:kc,Avatar_MouthShapes:nh,Avatar_MustacheShake:gg,Avatar_POI:ms,AxesHelper:Na,BaseUIComponent:Gi,BasicIKConstraint:bg,BehaviorExtension:Fg,BehaviorModel:ct,BloomEffect:Ir,BoxCollider:$a,BoxGizmo:Er,BoxHelperComponent:ti,Button:Rs,CallInfo:ds,Camera:ye,CameraTargetReachedEvent:Rc,Canvas:St,CanvasGroup:uo,CapsuleCollider:ys,ChangeMaterialOnClick:Xa,ChangeTransformOnClick:Pr,CharacterController:xr,CharacterControllerInput:ws,ChromaticAberration:gh,Collider:ri,ColorAdjustments:Po,ColorBySpeedModule:ol,ColorOverLifetimeModule:Xu,ContactShadows:gn,ControlTrackHandler:sf,CustomBranding:kr,Deletable:xg,DeleteBox:nr,DepthOfField:yn,DeviceFlag:Fu,DocumentExtension:hx,DragControls:ii,DropListener:xs,Duplicatable:Ha,EffectWrapper:Tc,EmissionModule:Os,EmphasizeOnClick:Qa,EventList:ge,EventListEvent:Lu,EventSystem:Gt,EventTrigger:Uu,FieldWithDefault:Zv,FixedJoint:Kg,Fog:el,GltfExport:rh,GltfExportBox:Eg,Gradient:Ar,Graphic:Mr,GraphicRaycaster:Iu,GridHelper:tl,GridLayoutGroup:$g,GroundProjectedEnv:Vn,GroupActionModel:Zs,HideOnStart:eo,HingeJoint:uh,HorizontalLayoutGroup:Vg,Image:cl,InheritVelocityModule:Lr,InputField:zr,InstanceHandle:Pa,InstancingHandler:Ks,Interactable:wg,Keyframe:ni,LODGroup:ph,LODModel:il,Light:li,LimitVelocityOverLifetimeModule:st,LogStats:vg,LookAt:Nr,LookAtConstraint:vr,MainModule:At,MaskableGraphic:dh,MeshCollider:vo,MeshRenderer:oh,MinMaxCurve:W,MinMaxGradient:ci,NeedleMenu:$n,NestedGltf:Hu,Networking:nl,NoiseModule:be,ObjectRaycaster:Ci,OffsetConstraint:Tr,OpenURL:hl,OrbitControls:fe,Outline:Ja,Padding:Rr,ParticleBurst:su,ParticleSubEmitter:Jg,ParticleSystem:Qe,ParticleSystemRenderer:Xi,PhysicsExtension:Ug,PixelationEffect:_h,PlayAnimationOnClick:fr,PlayAudioOnClick:co,PlayableDirector:po,PlayerColor:Ba,PointerEventData:th,PostProcessingHandler:n_,PreliminaryAction:Ya,PreliminaryTrigger:lh,RawImage:af,Rect:bw,RectTransform:Et,ReflectionProbe:qa,RegisteredAnimationInfo:Js,RemoteSkybox:Nn,Renderer:ze,RendererLightmap:tu,Rigidbody:ue,RotationBySpeedModule:qi,RotationOverLifetimeModule:_n,SceneSwitcher:He,ScreenCapture:Oo,ScreenSpaceAmbientOcclusion:Ms,ScreenSpaceAmbientOcclusionN8:bn,SetActiveOnClick:Or,ShadowCatcher:wh,ShapeModule:Ve,SharpeningEffect:bh,SignalAsset:tf,SignalReceiver:ll,SignalReceiverEvent:Ph,SignalTrackHandler:Ac,Size:yw,SizeBySpeedModule:hi,SizeOverLifetimeModule:Dr,SkinnedMeshRenderer:kg,SmoothFollow:Mo,SpatialGrabRaycaster:oo,SpatialHtml:Mh,SpatialTrigger:Ch,SpatialTriggerReceiver:Bn,SpectatorCamera:Zu,SphereCollider:Va,Sprite:Cs,SpriteData:ao,SpriteRenderer:ai,SpriteSheet:ja,SubEmitterSystem:ou,SyncedCamera:Ju,SyncedRoom:vn,SyncedTransform:Un,TapGestureTrigger:Lg,TeleportTarget:Wu,TestRunner:o_,TestSimulateUserData:r_,Text:Tt,TextBuilder:zg,TextExtension:Gu,TextureSheetAnimationModule:Dt,TiltShiftEffect:Hn,ToneMappingEffect:fo,TrailModule:Be,TransformData:Ee,TransformGizmo:Ur,TriggerBuilder:wt,TriggerModel:gs,UIRaycastUtils:ug,UIRootComponent:eh,USDZExporter:Le,USDZText:Go,USDZUIExtension:Gg,UsageMarker:sh,VariantAction:Dg,VelocityOverLifetimeModule:$e,VerticalLayoutGroup:Ng,VideoPlayer:nt,Vignette:Fr,VisibilityAction:ch,Voip:bo,Volume:al,VolumeParameter:U,VolumeProfile:Qu,WebARCameraBackground:Rh,WebARSessionRoot:Ni,WebXR:Ne,WebXRImageTracking:pr,WebXRImageTrackingModel:Es,WebXRPlaneTracking:Ts,WebXRTrackedImage:Ho,XRControllerFollow:ks,XRControllerModel:zn,XRControllerMovement:Pi,XRFlag:_i,XRRig:hf,XRState:Rt,__Ignore:dx},Symbol.toStringTag,{value:"Module"}));/* @license
 * Copyright 2021 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the 'License');
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an 'AS IS' BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const YT={topLight:{intensity:500,position:[.418,16.199,.3]},room:{position:[-.757,13.219,.717],scale:[31.713,28.305,28.591]},boxes:[{position:[-10.906,2.009,1.846],rotation:-.195,scale:[2.328,7.905,4.651]},{position:[-5.607,-.754,-.758],rotation:.994,scale:[1.97,1.534,3.955]},{position:[6.167,.857,7.803],rotation:.561,scale:[3.927,6.285,3.687]},{position:[-2.017,.018,6.124],rotation:.333,scale:[2.002,4.566,2.064]},{position:[2.291,-.756,-2.621],rotation:-.286,scale:[1.546,1.552,1.496]},{position:[-2.193,-.369,-5.547],rotation:.516,scale:[3.875,3.487,2.986]}],lights:[{intensity:50,position:[-16.116,14.37,8.208],scale:[.1,2.428,2.739]},{intensity:50,position:[-16.109,18.021,-8.207],scale:[.1,2.425,2.751]},{intensity:17,position:[14.904,12.198,-1.832],scale:[.15,4.265,6.331]},{intensity:43,position:[-.462,8.89,14.52],scale:[4.38,5.441,.088]},{intensity:20,position:[3.235,11.486,-12.541],scale:[2.5,2,.1]},{intensity:100,position:[0,20,0],scale:[1,.1,1]}]},KT={topLight:{intensity:400,position:[.5,14,.5]},room:{position:[0,13.2,0],scale:[31.5,28.5,31.5]},boxes:[{position:[-10.906,-1,1.846],rotation:-.195,scale:[2.328,7.905,4.651]},{position:[-5.607,-.754,-.758],rotation:.994,scale:[1.97,1.534,3.955]},{position:[6.167,-.16,7.803],rotation:.561,scale:[3.927,6.285,3.687]},{position:[-2.017,.018,6.124],rotation:.333,scale:[2.002,4.566,2.064]},{position:[2.291,-.756,-2.621],rotation:-.286,scale:[1.546,1.552,1.496]},{position:[-2.193,-.369,-5.547],rotation:.516,scale:[3.875,3.487,2.986]}],lights:[{intensity:80,position:[-14,10,8],scale:[.1,2.5,2.5]},{intensity:80,position:[-14,14,-4],scale:[.1,2.5,2.5]},{intensity:23,position:[14,12,0],scale:[.1,5,5]},{intensity:16,position:[0,9,14],scale:[5,5,.1]},{intensity:80,position:[7,8,-14],scale:[2.5,2.5,.1]},{intensity:80,position:[-7,16,-14],scale:[2.5,2.5,.1]},{intensity:1,position:[0,20,0],scale:[.1,.1,.1]}]};class ZT extends h.Scene{constructor(t){super(),this.position.y=-3.5;const e=new h.BoxGeometry;e.deleteAttribute("uv");const i=new h.MeshStandardMaterial({metalness:0,side:h.BackSide}),n=new h.MeshStandardMaterial({metalness:0}),o=t=="legacy"?YT:KT,a=new h.PointLight(16777215,o.topLight.intensity,28,2);a.position.set(...o.topLight.position),this.add(a);const l=new h.Mesh(e,i);l.position.set(...o.room.position),l.scale.set(...o.room.scale),this.add(l);for(const c of o.boxes){const d=new h.Mesh(e,n);d.position.set(...c.position),d.rotation.set(0,c.rotation,0),d.scale.set(...c.scale),this.add(d)}for(const c of o.lights){const d=new h.Mesh(e,this.createAreaLightMaterial(c.intensity));d.position.set(...c.position),d.scale.set(...c.scale),this.add(d)}}createAreaLightMaterial(t){const e=new h.MeshBasicMaterial;return e.color.setScalar(t),e}}const cu=x("debugmissingcamera");ce.registerCallback(he.MissingCamera,s=>{var l,c,d,u;cu&&console.warn("Creating missing camera");const t=s.context.scene,e=new h.PerspectiveCamera;e.name="Default Fallback Camera",t.add(e);const i=new ye;if(i.sourceId=((c=(l=s.files)==null?void 0:l[0])==null?void 0:c.src)??"unknown",i.fieldOfView=35,s.context.domElement.getAttribute("transparent")!=null)i.clearFlags=ro.Uninitialized;else if((d=s.context.domElement.getAttribute("skybox-image"))!=null&&d.length||(u=s.context.domElement.getAttribute("background-image"))!=null&&u.length||s.context.lightmaps.tryGetSkybox(i.sourceId))i.clearFlags=ro.Skybox,i.backgroundBlurriness=.2;else{i.clearFlags=ro.SolidColor;let f="#efefef";if(typeof window!==void 0&&window.matchMedia("(prefers-color-scheme: dark)").matches&&(f="#1f1f1f"),t.background=new h.Color(f),!t.environment){const m=new h.PMREMGenerator$1(s.context.renderer),g=new ZT("neutral");t.environment=m.fromScene(g,.025).texture}}const o=Jo(e,i,!0);e.position.x=0,e.position.y=1,e.position.z=2;const a=s.context.domElement;return(a==null?void 0:a.cameraControls)!=!1&&ux(s.context,o),o});ce.registerCallback(he.ContextCreated,s=>{if(!s.context.mainCamera){cu&&console.log("Will not auto-fit because a default camera exists");return}const t=s.context.domElement;if((t==null?void 0:t.cameraControls)==!0){const e=Wb(s.context.mainCamera);if((e==null?void 0:e.isCameraController)==!0){cu&&console.log("Will not auto-fit because a camera controller exists");return}ux(s.context)}});function ux(s,t){t=t??s.mainCameraComponent;const e=t==null?void 0:t.gameObject;if(cu&&console.log("Creating default camera controls",t==null?void 0:t.name),e){const i=qc(e,fe);i.sourceId=(t==null?void 0:t.sourceId)??"unknown";const n=s.domElement.getAttribute("auto-rotate");if(i.autoRotate=n!=null&&n!="0"&&(n==null?void 0:n.toLowerCase())!="false",i.autoRotateSpeed=.5,i.autoFit=!0,i.autoRotate&&n){const o=parseFloat(n);isNaN(o)||(i.autoRotateSpeed=o)}}else console.warn("Missing camera object, can not add orbit controls")}ce.registerCallback(he.ContextCreated,s=>{const t=s.context.domElement.getAttribute("autoplay");if(t!==void 0&&(t===""||t==="true"||t==="1")&&s.files)for(const e of s.files)S.foreachComponent(e.file.scene,n=>{if(n.enabled!==!1){if(n instanceof kt&&n.playAutomatically||n instanceof xt||n instanceof po&&n.playOnAwake===!0)return!0;if(n instanceof kt)return n.playAutomatically=!0,!0;if(n instanceof po)return n.playOnAwake=!0,!0}},!0)!==!0&&La.assignAnimationsFromFile(e.file,{createAnimationComponent:(n,o)=>wi(n,kt)})});class JT extends oe.WorkerBase{constructor(){super(new oe.WorkerWrapper),this.name="GenerateMeshBVHWorker"}runTask(t,e,i={}){return new Promise((n,o)=>{if(e.getAttribute("position").isInterleavedBufferAttribute||e.index&&e.index.isInterleavedBufferAttribute)throw new Error("GenerateMeshBVHWorker: InterleavedBufferAttribute are not supported for the geometry attributes.");t.onerror=d=>{o(new Error(`GenerateMeshBVHWorker: ${d.message}`))},t.onmessage=d=>{const{data:u}=d;if(u.error)o(new Error(u.error)),t.onmessage=null;else if(u.serialized){const{serialized:f,position:m}=u,g=oe.MeshBVH.deserialize(f,e,{setIndex:!1}),_=Object.assign({setBoundingBox:!0},i);if(e.attributes.position.array=m,f.index)if(e.index)e.index.array=f.index;else{const y=new h.BufferAttribute(f.index,1,!1);e.setIndex(y)}_.setBoundingBox&&(e.boundingBox=g.getBoundingBox(new h.Box3)),i.onProgress&&i.onProgress(u.progress),n(g),t.onmessage=null}else i.onProgress&&i.onProgress(u.progress)};const a=e.index?e.index.array:null,l=e.attributes.position.array,c=[l];a&&c.push(a),t.postMessage({index:a,position:l,options:{...i,onProgress:null,includedProgressCallback:!!i.onProgress,groups:[...e.groups]}},c.map(d=>d.buffer).filter(d=>typeof SharedArrayBuffer>"u"||!(d instanceof SharedArrayBuffer)))})}}const e2=Object.freeze(Object.defineProperty({__proto__:null,GenerateMeshBVHWorker:JT},Symbol.toStringTag,{value:"Module"}));exports.$physicsKey=AP;exports.ActionBuilder=de;exports.ActionCollection=pw;exports.ActionModel=Jt;exports.Addressables=ov;exports.AlignmentConstraint=Zc;exports.AmbientMode=Ca;exports.Animation=kt;exports.AnimationCurve=sl;exports.AnimationExtension=Nu;exports.AnimationTrackHandler=nf;exports.AnimationUtils=La;exports.Animator=xt;exports.AnimatorConditionMode=Ws;exports.AnimatorController=$i;exports.AnimatorControllerParameterType=hg;exports.AnimatorStateInfo=zl;exports.Antialiasing=mh;exports.Application=cn;exports.ApplicationEvents=Nd;exports.AssetDatabase=x0;exports.AssetReference=ee;exports.AudioExtension=Cr;exports.AudioListener=us;exports.AudioSource=Ie;exports.AudioTrackHandler=or;exports.Avatar=ho;exports.AvatarBlink_Simple=wr;exports.AvatarEyeLook_Rotation=za;exports.AvatarLoader=cx;exports.AvatarMarker=tt;exports.AvatarModel=m_;exports.Avatar_Brain_LookAt=kc;exports.Avatar_MouthShapes=nh;exports.Avatar_MustacheShake=gg;exports.Avatar_POI=ms;exports.Axes=da;exports.AxesHelper=Na;exports.BUILD_TIME=Um;exports.BaseUIComponent=Gi;exports.BasicIKConstraint=bg;exports.BehaviorExtension=Fg;exports.BehaviorModel=ct;exports.BloomEffect=Ir;exports.BoxCollider=$a;exports.BoxGizmo=Er;exports.BoxHelperComponent=ti;exports.Button=Rs;exports.ButtonsFactory=an;exports.CallDirection=Bv;exports.CallInfo=ds;exports.Camera=ye;exports.CameraTargetReachedEvent=Rc;exports.Canvas=St;exports.CanvasGroup=uo;exports.CapsuleCollider=ys;exports.ChangeMaterialOnClick=Xa;exports.ChangeTransformOnClick=Pr;exports.CharacterController=xr;exports.CharacterControllerInput=ws;exports.ChromaticAberration=gh;exports.CircularBuffer=xi;exports.ClearFlags=ro;exports.ClipExtrapolation=On;exports.Collider=ri;exports.Collision=Lv;exports.CollisionDetectionMode=Du;exports.ColorAdjustments=Po;exports.ColorBySpeedModule=ol;exports.ColorOverLifetimeModule=Xu;exports.Component=A1;exports.Component$1=D;exports.ComponentLifecycleEvents=Wc;exports.Components=QT;exports.ConnectionEvents=g0;exports.ContactPoint=Dv;exports.ContactShadows=gn;exports.Context=Q;exports.ContextArgs=v1;exports.ContextEvent=he;exports.ContextRegistry=ce;exports.ControlTrackHandler=sf;exports.CustomBranding=kr;exports.CustomShader=fi;exports.DefaultReflectionMode=Wd;exports.Deletable=xg;exports.DeleteBox=nr;exports.DepthOfField=yn;exports.DeviceFlag=Fu;exports.DocumentExtension=hx;exports.DragControls=ii;exports.DragMode=Sg;exports.DropListener=xs;exports.Duplicatable=Ha;exports.EffectWrapper=Tc;exports.EmissionModule=Os;exports.EmphasizeOnClick=Qa;exports.EngineLoadingView=rc;exports.EventList=ge;exports.EventListEvent=Lu;exports.EventSystem=Gt;exports.EventTrigger=Uu;exports.FieldWithDefault=Zv;exports.FileReference=Sa;exports.FileReferenceSerializer=av;exports.FileSpawnModel=uO;exports.File_Event=Vv;exports.FixedJoint=Kg;exports.Fog=el;exports.FrameEvent=ve;exports.GENERATOR=wu;exports.GameObject=S;exports.Gizmos=N;exports.GltfExport=rh;exports.GltfExportBox=Eg;exports.GltfLoadEvent=rr;exports.GltfLoadEventType=Zw;exports.Gradient=Ar;exports.Graphic=Mr;exports.GraphicRaycaster=Iu;exports.Graphics=ji;exports.GridHelper=tl;exports.GridLayoutGroup=$g;exports.GroundProjectedEnv=Vn;exports.GroupActionModel=Zs;exports.HideFlags=ju;exports.HideOnStart=eo;exports.HingeJoint=uh;exports.HorizontalLayoutGroup=Vg;exports.HostData=CC;exports.Image=cl;exports.ImageReference=xa;exports.ImageReferenceSerializer=rv;exports.InheritVelocityModule=Lr;exports.Input=h0;exports.InputEventQueue=ei;exports.InputEvents=ke;exports.InputField=zr;exports.InstanceHandle=Pa;exports.InstancingHandler=Ks;exports.InstancingUtil=Vi;exports.InstantiateEvent=D0;exports.InstantiateIdProvider=vt;exports.InstantiateOptions=pn;exports.Interactable=wg;exports.JoinedRoomResponse=YS;exports.KeyEventArgs=US;exports.Keyframe=ni;exports.LODGroup=ph;exports.LODModel=il;exports.LeftRoomResponse=KS;exports.Light=li;exports.LightData=uv;exports.LimitVelocityOverLifetimeModule=st;exports.LoadingElementOptions=R1;exports.LogStats=vg;exports.LogType=bi;exports.LookAt=Nr;exports.LookAtConstraint=vr;exports.MainModule=At;exports.MarkerType=a_;exports.MaskableGraphic=dh;exports.Mathf=z;exports.MeshCollider=vo;exports.MeshRenderer=oh;exports.MinMaxCurve=W;exports.MinMaxGradient=ci;exports.NEKeyboardEvent=Il;exports.NEPointerEvent=ns;exports.NeedleButtonElement=p_;exports.NeedleEngineHTMLElement=f_;exports.NeedleLoader=d_;exports.NeedleMenu=$n;exports.NeedlePatchesKey=ud;exports.NeedleXRController=Vm;exports.NeedleXRSession=q;exports.NeedleXRSync=b0;exports.NeedleXRUtils=w0;exports.NestedGltf=Hu;exports.NetworkConnection=y0;exports.NetworkedStreamEvents=Dn;exports.NetworkedStreams=ih;exports.Networking=nl;exports.NewInstanceModel=I0;exports.NoiseModule=be;exports.ObjectRaycaster=Ci;exports.ObjectUtils=yo;exports.OffsetConstraint=Tr;exports.OneEuroFilter=hd;exports.OneEuroFilterXYZ=Em;exports.OpenURL=hl;exports.OrbitControls=fe;exports.Outline=Ja;exports.OwnershipEvent=_0;exports.OwnershipModel=Hm;exports.PUBLIC_KEY=Jl;exports.Padding=Rr;exports.ParticleBurst=su;exports.ParticleSubEmitter=Jg;exports.ParticleSystem=Qe;exports.ParticleSystemBaseBehaviour=Co;exports.ParticleSystemRenderer=Xi;exports.ParticleSystemShapeType=nu;exports.PeerHandle=ir;exports.PeerNetworking=m0;exports.Physics=va;exports.PhysicsExtension=Ug;exports.PhysicsMaterialCombine=at;exports.PixelationEffect=_h;exports.PlayAnimationOnClick=fr;exports.PlayAudioOnClick=co;exports.PlayableDirector=po;exports.PlayerColor=Ba;exports.PlayerState=vi;exports.PlayerStateEvent=_w;exports.PlayerSync=Ka;exports.PlayerView=cv;exports.PlayerViewManager=hv;exports.PointerEventData=th;exports.PointerType=Cu;exports.PostProcessingEffect=Xe;exports.PostProcessingHandler=n_;exports.PreliminaryAction=Ya;exports.PreliminaryTrigger=lh;exports.PrimitiveType=lr;exports.Progress=se;exports.PromiseAllWithErrors=Rm;exports.PromiseErrorResult=Lp;exports.RGBAColor=me;exports.RapierPhysics=jo;exports.RawImage=af;exports.RaycastOptions=Fn;exports.Rect=bw;exports.RectTransform=Et;exports.ReflectionProbe=qa;exports.RegisteredAnimationInfo=Js;exports.RemoteSkybox=Nn;exports.RenderTexture=so;exports.RenderTextureSerializer=Ev;exports.Renderer=ze;exports.RendererData=dv;exports.RendererLightmap=tu;exports.Rigidbody=ue;exports.RigidbodyConstraints=We;exports.RoomEvents=J;exports.RotationBySpeedModule=qi;exports.RotationOverLifetimeModule=_n;exports.SceneLightSettings=Zd;exports.SceneSwitcher=He;exports.ScreenCapture=Oo;exports.ScreenSpaceAmbientOcclusion=Ms;exports.ScreenSpaceAmbientOcclusionN8=bn;exports.SendQueue=rn;exports.SerializationContext=ng;exports.SetActiveOnClick=Or;exports.ShadowCatcher=wh;exports.ShapeModule=Ve;exports.SharpeningEffect=bh;exports.SignalAsset=tf;exports.SignalReceiver=ll;exports.SignalReceiverEvent=Ph;exports.SignalTrackHandler=Ac;exports.Size=yw;exports.SizeBySpeedModule=hi;exports.SizeOverLifetimeModule=Dr;exports.SkinnedMeshRenderer=kg;exports.SmoothFollow=Mo;exports.SpatialGrabRaycaster=oo;exports.SpatialHtml=Mh;exports.SpatialTrigger=Ch;exports.SpatialTriggerReceiver=Bn;exports.SpectatorCamera=Zu;exports.SphereCollider=Va;exports.SphereIntersection=Qm;exports.SphereOverlapResult=Iv;exports.Sprite=Cs;exports.SpriteData=ao;exports.SpriteRenderer=ai;exports.SpriteSheet=ja;exports.StateMachineBehaviour=U1;exports.StreamEndedEvent=pg;exports.StreamReceivedEvent=jv;exports.SubEmitterSystem=ou;exports.SyncedCamera=Ju;exports.SyncedRoom=vn;exports.SyncedTransform=Un;exports.TapGestureTrigger=Lg;exports.TeleportTarget=Wu;exports.TestRunner=o_;exports.TestSceneUtils=$T;exports.TestSimulateUserData=r_;exports.Text=Tt;exports.TextBuilder=zg;exports.TextExtension=Gu;exports.TextureSheetAnimationModule=Dt;exports.TiltShiftEffect=Hn;exports.Time=fv;exports.ToneMappingEffect=fo;exports.TrackHandler=Oh;exports.TrackType=pi;exports.TrailModule=Be;exports.TransformData=Ee;exports.TransformGizmo=Ur;exports.TriggerBuilder=wt;exports.TriggerModel=gs;exports.TypeStore=R;exports.UIRaycastUtils=ug;exports.UIRootComponent=eh;exports.USDDocument=Tg;exports.USDObject=bt;exports.USDWriter=sw;exports.USDZExporter=Le;exports.USDZExporter$1=ow;exports.USDZText=Go;exports.USDZUIExtension=Gg;exports.UriSerializer=Tv;exports.UsageMarker=sh;exports.UserJoinedOrLeftRoomModel=ZS;exports.VERSION=ln;exports.VariantAction=Dg;exports.VelocityOverLifetimeModule=$e;exports.VerticalLayoutGroup=Ng;exports.VideoPlayer=nt;exports.ViewDevice=to;exports.Vignette=Fr;exports.VisibilityAction=ch;exports.Voip=bo;exports.Volume=al;exports.VolumeParameter=U;exports.VolumeProfile=Qu;exports.WaitForFrames=JC;exports.WaitForPromise=lv;exports.WaitForSeconds=rg;exports.Watch=fs;exports.WebARCameraBackground=Rh;exports.WebARSessionRoot=Ni;exports.WebXR=Ne;exports.WebXRButtonFactory=_s;exports.WebXRImageTracking=pr;exports.WebXRImageTrackingModel=Es;exports.WebXRPlaneTracking=Ts;exports.WebXRTrackedImage=Ho;exports.XRControllerFollow=ks;exports.XRControllerModel=zn;exports.XRControllerMovement=Pi;exports.XRFlag=_i;exports.XRRig=hf;exports.XRState=Rt;exports.XRStateFlag=En;exports.__Ignore=dx;exports.__internalNotifyObjectDestroyed=M0;exports.activeInHierarchyFieldName=ps;exports.addAttributeChangeCallback=Ib;exports.addComponent=wi;exports.addCustomExtensionPlugin=BO;exports.addGltfLoadEventListener=RT;exports.addNewComponent=Jo;exports.addPatch=xu;exports.apply=Mu;exports.applyHMRChanges=zT;exports.applyPrototypeExtensions=q0;exports.beginListenDestroy=L0;exports.beginListenInstantiate=B0;exports.binaryIdentifierCasts=$m;exports.build_scene_functions=b1;exports.builtinComponentKeyName=Fo;exports.calculateProgress01=cg;exports.clearMessages=Wx;exports.colorSerializer=lP;exports.compareAssociation=N0;exports.componentSerializer=xd;exports.copyTexture=Yb;exports.createLoader=u_;exports.createMotion=Sv;exports.debugNet=Yt;exports.debugOwner=jl;exports.decompressGpuTexture=cw;exports.deepClone=Fc;exports.delay=un;exports.delayForFrames=Uc;exports.deserializeObject=zd;exports.destroy=Si;exports.destroyComponentInstance=Y0;exports.disposeObjectResources=xe;exports.disposeStream=Ln;exports.editorGuidKeyName=ec;exports.enableSpatialConsole=Ko;exports.euler=hP;exports.eventListSerializer=pP;exports.exportAsGLTF=HT;exports.findByGuid=og;exports.findObjectOfType=Yc;exports.findObjectsOfType=Z0;exports.findResourceUsers=Km;exports.fitObjectIntoVolume=Zb;exports.foreachComponent=hr;exports.foreachComponentEnumerator=ku;exports.forward=oS;exports.generateQRCode=Bb;exports.generateSeed=j0;exports.getBoundingBox=si;exports.getCameraController=Wb;exports.getComponent=gr;exports.getComponentInChildren=Qc;exports.getComponentInParent=Oc;exports.getComponents=Xc;exports.getComponentsInChildren=Fa;exports.getComponentsInParent=Ou;exports.getFormattedDate=ew;exports.getIconElement=yt;exports.getIconTexture=tm;exports.getIp=Ix;exports.getIpAndLocation=jx;exports.getIpCloudflare=Lx;exports.getLoader=dn;exports.getOrAddComponent=qc;exports.getParam=x;exports.getParentHierarchyPath=lS;exports.getPath=vx;exports.getPeerOptions=HS;exports.getPeerjsInstance=p0;exports.getResourceUserCount=mC;exports.getTempColor=qb;exports.getTempQuaternion=on;exports.getTempVector=$;exports.getUrlParams=Bc;exports.getVisibleInCustomShadowRendering=Kb;exports.getWorldDirection=Xb;exports.getWorldEuler=Dm;exports.getWorldPosition=Z;exports.getWorldQuaternion=_e;exports.getWorldRotation=Nc;exports.getWorldScale=Ue;exports.hasCommercialLicense=hn;exports.hasIndieLicense=lg;exports.hasPointerEventComponent=Xd;exports.hasProLicense=io;exports.hideDebugConsole=i0;exports.imageToCanvas=hw;exports.instantiate=dr;exports.invokeAfterImportPluginHooks=Rg;exports.invokeXRSessionEnd=c0;exports.invokeXRSessionStart=l0;exports.isActiveInHierarchy=J0;exports.isActiveSelf=Ua;exports.isAndroidDevice=Ox;exports.isAnimationAction=Qb;exports.isComponent=Av;exports.isDebugMode=gx;exports.isDesktop=xx;exports.isDestroyed=cr;exports.isDevEnvironment=B;exports.isDisposed=fC;exports.isExporting=WT;exports.isHostedOnGlitch=kb;exports.isHotReloading=jT;exports.isIPad=Cx;exports.isIconElement=mv;exports.isLocalNetwork=Ht;exports.isMacOS=Rx;exports.isMobileDevice=Sx;exports.isMozillaXR=Mx;exports.isQuest=Tx;exports.isResourceTrackingEnabled=C0;exports.isSafari=Ex;exports.isUsingInstancing=Ru;exports.isiOS=kx;exports.isiPad=Px;exports.loadSync=tx;exports.logHierarchy=Ld;exports.lookAtInverse=Kx;exports.lookAtObject=zc;exports.lookAtScreenPoint=Zx;exports.makeId=yx;exports.makeIdFromRandomWords=Ab;exports.makeNameSafe=fn;exports.markAsInstancedRendered=ev;exports.microphonePermissionsGranted=Ax;exports.nameof=mx;exports.nameofFactory=Eb;exports.objectSerializer=kv;exports.offXRSessionEnd=FS;exports.offXRSessionStart=BS;exports.onAfterRender=J1;exports.onBeforeRender=Z1;exports.onClear=Y1;exports.onDestroy=K1;exports.onInitialized=Cv;exports.onStart=Pv;exports.onUpdate=Ov;exports.onXRSessionEnd=Nm;exports.onXRSessionStart=Su;exports.parseSync=ex;exports.placeOnSurface=Jb;exports.postprocessFBXMaterials=Bm;exports.prefix=tP;exports.pushState=Tb;exports.randomNumber=bx;exports.registerBinaryType=Wm;exports.registerComponent=Eu;exports.registerComponentExtension=zu;exports.registerCustomEffectType=Qi;exports.registerExportExtensions=Mg;exports.registerExtensions=eu;exports.registerHotReloadType=BT;exports.registerLoader=Pm;exports.registerPrefabProvider=U0;exports.registerPrototypeExtensions=X0;exports.registerType=kC;exports.relativePathPrefix=Lb;exports.removeAttributeChangeCallback=jb;exports.removeComponent=sg;exports.removeCustomImportExtensionType=FO;exports.removeGltfLoadEventListener=kT;exports.removePatch=IS;exports.resolveUrl=mo;exports.sanitizeString=Db;exports.saveImage=qw;exports.screenshot=aT;exports.screenshot2=h_;exports.sendDestroyed=Jm;exports.serializable=p;exports.serializeObject=$0;exports.serializeable=yr;exports.setActive=sc;exports.setAllowBalloonMessages=Nb;exports.setAllowOverlayMessages=zx;exports.setAutoFitEnabled=Ad;exports.setCameraController=Bp;exports.setDestroyed=iv;exports.setDevEnvironment=gS;exports.setDisposable=Ym;exports.setDontDestroy=ia;exports.setOrAddParamsToUrl=Dp;exports.setParam=_x;exports.setParamWithoutReload=wc;exports.setPeerOptions=qS;exports.setResourceTrackingEnabled=uC;exports.setState=Om;exports.setVisibleInCustomShadowRendering=jm;exports.setWorldEuler=Lm;exports.setWorldPosition=it;exports.setWorldPositionXYZ=ar;exports.setWorldQuaternion=Wi;exports.setWorldQuaternionXYZW=Am;exports.setWorldRotation=Im;exports.setWorldRotationXYZ=Vc;exports.setWorldScale=Ea;exports.showBalloonError=$c;exports.showBalloonMessage=Te;exports.showBalloonWarning=pe;exports.showDebugConsole=Fm;exports.slerp=Yx;exports.syncDestroy=Gc;exports.syncField=jg;exports.syncInstantiate=eg;exports.textureToCanvas=cS;exports.tryCastBinary=u0;exports.tryDetermineFileTypeFromBinary=Qw;exports.tryDetermineFileTypeFromURL=Xw;exports.tryFindObject=ka;exports.tryGetGuid=f0;exports.unregisterHotReloadType=FT;exports.unwatchWrite=Mm;exports.useForAutoFit=Gb;exports.validate=Ct;exports.watchWrite=vu;
