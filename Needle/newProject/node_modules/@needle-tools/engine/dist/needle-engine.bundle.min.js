var uS=Object.defineProperty,pS=(n,t,i)=>t in n?uS(n,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):n[t]=i,a=(n,t,i)=>(pS(n,typeof t!="symbol"?t+"":t,i),i),im=(n,t,i)=>{if(!t.has(n))throw TypeError("Cannot "+i)},ge=(n,t,i)=>(im(n,t,"read from private field"),i?i.call(n):t.get(n)),pn=(n,t,i)=>{if(t.has(n))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(n):t.set(n,i)},Fn=(n,t,i,s)=>(im(n,t,"write to private field"),s?s.call(n,i):t.set(n,i),i),nd=(n,t,i)=>(im(n,t,"access private method"),i);import{Vector2 as re,Vector3 as x,Vector4 as fe,Quaternion as V,PlaneGeometry as zn,PerspectiveCamera as _e,Scene as wi,ShaderMaterial as mn,Uniform$1 as to,Mesh as X,WebGLRenderer as sr,Texture as Le,Euler as Bt,Box3 as xi,MeshStandardMaterial as Ft,Color as ae,ShadowMaterial as zy,Box3Helper as Uy,GridHelper as nm,Material as ke,Matrix3 as Ny,Matrix4 as se,Layers as io,Object3D as j,Ray as no,MathUtils as ms,AxesHelper as Si,MeshBasicMaterial as Re,DoubleSide as Ci,BufferGeometry as gs,Group as so,SphereGeometry as sd,BoxGeometry as ma,SpriteMaterial as mS,Sprite as gS,Shape as fS,ExtrudeGeometry as yS,Fog as Wy,DirectionalLight as sm,PointLight as om,Line as ql,BufferAttribute as yt,CylinderGeometry as vS,EdgesGeometry as bS,LineSegments as Vy,LineBasicMaterial as Hy,Sphere as od,Plane as or,Raycaster as rd,ArrayCamera as _S,SkinnedMesh as fs,InterleavedBufferAttribute as $y,Skeleton as wS,Bone as xS,Source as SS,WebGLCubeRenderTarget as CS,CubeCamera as OS,AnimationClip as oo,TextureLoader as ga,PropertyBinding as fa,LinearSRGBColorSpace as rr,ShaderChunk as qt,UniformsLib as PS,FileLoader as Gy,DataTexture as rm,RGBAFormat as ad,EquirectangularReflectionMapping as ys,SRGBColorSpace as gn,Clock as kS,NoToneMapping as ya,PCFSoftShadowMap$1 as MS,BasicNodeLibrary as RS,WebGLRenderTarget as vs,DepthTexture as TS,NearestFilter as ld,LoopRepeat as ES,LoopOnce as am,AnimationMixer as lm,CompressedTexture as AS,FrontSide as ro,Frustum as qy,OrthographicCamera as cm,AudioListener as IS,PositionalAudio as jS,AudioLoader as hm,EventDispatcher as dm,BackSide as cd,MeshDepthMaterial as LS,CustomBlending as DS,MaxEquation as BS,AmbientLight as FS,HemisphereLight as zS,InvertStencilOp as US,DecrementWrapStencilOp as NS,IncrementWrapStencilOp as WS,DecrementStencilOp as VS,IncrementStencilOp as HS,ReplaceStencilOp as $S,ZeroStencilOp as GS,KeepStencilOp as qS,AlwaysStencilFunc as XS,GreaterEqualStencilFunc as QS,NotEqualStencilFunc as YS,GreaterStencilFunc as ZS,LessEqualStencilFunc as KS,EqualStencilFunc as JS,LessStencilFunc as eC,NeverStencilFunc as Xy,RawShaderMaterial as Qy,GLSL3 as tC,AlwaysDepth as iC,GreaterEqualDepth as nC,GreaterDepth as sC,LessEqualDepth as oC,LessDepth as rC,NotEqualDepth as aC,EqualDepth as lC,BatchedMesh as Yy,MeshPhysicalMaterial as um,UnsignedByteType as cC,LinearFilter as Zy,RingGeometry as hC,Line3 as dC,AdditiveBlending as Ky,BoxHelper as uC,SpotLight as pC,DirectionalLightHelper as mC,CameraHelper as gC,LOD as fC,Triangle as yC,NormalBlending as vC,NeutralToneMapping as Xl,AgXToneMapping as hd,ACESFilmicToneMapping as pm,ReinhardToneMapping as mm,LinearToneMapping as dd,HalfFloatType as bC,VideoTexture as _C,CubeTexture as wC,CompressedCubeTexture as xC,EquirectangularRefractionMapping as SC,VectorKeyframeTrack as CC,QuaternionKeyframeTrack as OC,Audio as PC,MirroredRepeatWrapping as Jy,UniformsUtils as ev,ShaderLib as ud,MeshNormalMaterial as kC,AudioContext as MC,PMREMGenerator$1 as RC}from"./three.min.js";import{createLoaders as gm,getRaycastMesh as tv,LODsManager as va,NEEDLE_progressive as it,addDracoAndKTX2Loaders as TC,configureLoader as EC,setDracoDecoderLocation as AC,setKTX2TranscoderLocation as IC}from"./gltf-progressive.min.js";import{GroundedSkybox as ba,Font as jC,TextGeometry as LC,FontLoader as DC,GLTFLoader as ar,TransformControlsGizmo as iv,EXRLoader as pd,RGBELoader as fm,Stats as BC,nodeFrame as FC,OrbitControls as nv,PositionalAudioHelper as zC,HorizontalBlurShader as UC,VerticalBlurShader as NC,GLTFExporter as sv,strToU8 as ov,zipSync as WC,XRControllerModelFactory as VC,XRHandMeshModel as HC,Line2 as $C,LineGeometry as GC,LineMaterial as qC,KTX2Loader as XC,TransformControls as QC,InteractiveGroup as YC,HTMLMesh as ZC,VertexNormalsHelper as KC,OBJLoader as ym,FBXLoader as rv,mergeVertices as JC}from"./three-examples.min.js";import{fetchProfile as eO,MotionController as tO,$70d766613f57b014$export$2e2bcd8739ae039 as av,ByteBuffer as iO,v5 as lv,md5 as cv,SIZE_PREFIX_LENGTH as hv,Builder as vm,createNoise4D as nO,Matrix4 as bm,BatchedParticleRenderer as sO,ParticleSystem as oO,RenderMode as bs,TrailParticle as dv,ConstantColor as rO,Vector4 as aO,ConstantValue as lO,WorkerBase as cO,WorkerWrapper as hO,MeshBVH as dO}from"./vendor.min.js";import{__webpack_exports__default as Te,__webpack_exports__Text as uv,__webpack_exports__Block as pv,__webpack_exports__update as uO,SimpleStateBehavior as pO,__webpack_exports__Inline as _m,__webpack_exports__FontLibrary as mv,ThreeMeshUI as gv}from"./three-mesh-ui.min.js";let fv,yv=null;function fn(){return fv}function wm(n){if(n==null){console.warn("Oh no: someone tried registering a non-existend gltf-loader. When you see this log it might mean that needle-engine is being imported multiple times. Please check your project setup.");return}yv!==n&&(yv=n,fv=new n)}const xm=new Map;function Xt(n=(t=>(t=globalThis.location)==null?void 0:t.hostname)()){if(xm.has(n))return xm.get(n);const t=/(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})|localhost/.test(n);return xm.set(n,t),t===!0}function vv(){return window.location.hostname.includes("glitch.me")}const bv=typeof window!==void 0?window.location.search.includes("debugcontext"):!1;var pe=(n=>(n.ContextRegistered="ContextRegistered",n.ContextCreationStart="ContextCreationStart",n.ContextCreated="ContextCreated",n.ContextFirstFrameRendered="ContextFirstFrameRendered",n.ContextDestroying="ContextDestroying",n.ContextDestroyed="ContextDestroyed",n.MissingCamera="MissingCamera",n.ContextClearing="ContextClearing",n.ContextCleared="ContextCleared",n))(pe||{});class ue{static get Current(){return globalThis["NeedleEngine.Context.Current"]}static set Current(t){globalThis["NeedleEngine.Context.Current"]=t}static get All(){return this.Registered}static register(t){this.Registered.indexOf(t)===-1&&(bv&&console.warn("Registering context"),this.Registered.push(t),this.dispatchCallback("ContextRegistered",t))}static unregister(t){const i=this.Registered.indexOf(t);i!==-1&&(bv&&console.warn("Unregistering context"),this.Registered.splice(i,1))}static registerCallback(t,i){this._callbacks[t]||(this._callbacks[t]=[]),this._callbacks[t].push(i)}static unregisterCallback(t,i){if(!this._callbacks[t])return;const s=this._callbacks[t].indexOf(i);s!==-1&&this._callbacks[t].splice(s,1)}static dispatchCallback(t,i,s){if(!this._callbacks[t])return!0;const o={event:t,context:i};if(s)for(const l in s)o[l]=s[l];const r=new Array;return this._callbacks[t].forEach(l=>{const c=l(o);c instanceof Promise&&r.push(c)}),Promise.all(r)}static addContextCreatedCallback(t){this.registerCallback("ContextCreated",t)}static addContextDestroyedCallback(t){this.registerCallback("ContextDestroyed",t)}}a(ue,"Registered",[]),a(ue,"_callbacks",{});const _v=()=>n=>n;function mO(n){return _v()(n)}function gO(){return!!C("debug")}class Oi{constructor(t,i){a(this,"_factory"),a(this,"_cache",[]),a(this,"_maxSize"),a(this,"_index",0),this._factory=t,this._maxSize=i}get(){const t=this._index%this._maxSize;return this._index++,this._cache.length<=t&&(this._cache[t]=this._factory()),this._cache[t]}}let lr=!1;const Sm=new Array;typeof window<"u"&&setTimeout(()=>{if(lr){const n={},t=new URL(window.location.href),i=new URL(t);i.searchParams.append("console","");const s=i.toString().replace(/=$|=(?=&)/g,"");for(const r of Sm){const l=new URL(t);l.searchParams.append(r,""),n[r]=l.toString().replace(/=$|=(?=&)/g,"")}console.log(`\u{1F335} ?help: Debug Options for Needle Engine.
Append any of these parameters to the URL to enable specific debug options.
Example: ${s} will show an onscreen console window.`);const o=lr===!0?"":` (containing "${lr}")`;console.group("Available URL parameters:"+o);for(const r of Object.keys(n).sort())typeof lr=="string"&&!r.toLowerCase().includes(lr.toLowerCase())||(console.groupCollapsed(r),console.log("Reload with this flag enabled:"),console.log(n[r]),console.groupEnd());console.groupEnd()}},100);function Ql(){var n;return new URLSearchParams((n=globalThis.location)==null?void 0:n.search)}function C(n){lr&&!Sm.includes(n)&&Sm.push(n);const t=Ql();if(t.has(n)){const i=t.get(n);if(i){const s=Number(i);return isNaN(s)?i:s}else return!0}return!1}lr=C("help");function fO(n,t){const i=Ql();i.has(n)?i.set(n,t):i.append(n,t),document.location.search=i.toString()}function Yl(n,t,i=!0){const s=Ql();s.has(n)?t===null?s.delete(n):s.set(n,t):t!==null&&s.append(n,t),i?wv(n,s):Om(n,s)}function Cm(n,t,i){n.has(t)?n.set(t,i.toString()):n.append(t,i.toString())}function wv(n,t,i){window.history.pushState(i,n,"?"+t.toString())}function Om(n,t,i){window.history.replaceState(i,n,"?"+t.toString())}function yO(n){for(var t="",i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",s=i.length,o=0;o<n;o++)t+=i.charAt(Math.floor(Math.random()*s));return t}function vO(n,t){return Math.floor(Math.random()*(t-n+1))+n}const xv=["smol","tiny","giant","interesting","smart","bright","dull","extreme","beautiful","pretty","dark","epic","salty","silly","funny","lame","lazy","loud","lucky","mad","mean","mighty","mysterious","nasty","odd","old","powerful","quiet","rapid","scary","shiny","shy","silly","smooth","sour","spicy","stupid","sweet","tasty","terrible","ugly","unusual","vast","wet","wild","witty","wrong","zany","zealous","zippy","zombie","zorro"],Sv=["cat","dog","mouse","pig","cow","horse","sheep","chicken","duck","goat","panda","tiger","lion","elephant","monkey","bird","fish","snake","frog","turtle","hamster","penguin","kangaroo","whale","dolphin","crocodile","snail","ant","bee","beetle","butterfly","dragon","eagle","fish","giraffe","lizard","panda","penguin","rabbit","snake","spider","tiger","zebra"];function Cv(){const n=xv[Math.floor(Math.random()*xv.length)],t=Sv[Math.floor(Math.random()*Sv.length)];return n+"_"+t}function Ov(n){return n=n.replace(/[^a-z0-9áéíóúñü \.,_-]/gim,""),n.trim()}function _a(n,t,i=!0,s=!1){var o;if(t==null)return null;if(t.userData&&t.userData.guid===n||t.guid==n)return t;if(s&&(o=t.userData)!=null&&o.components){for(const r of t.userData.components)if(r.guid===n)return r}if(i){if(t.scenes)for(const r in t.scenes){const l=t.scenes[r],c=_a(n,l,i,s);if(c)return c}if(t.children)for(const r in t.children){const l=t.children[r],c=_a(n,l,i,s);if(c)return c}}}function Zl(n,t){if(n!=null&&typeof n=="object"){let i;Array.isArray(n)?i=[]:(i=Object.create(n),Object.assign(i,n));for(const s of Object.keys(n)){const o=n[s];t&&!t(n,s,o)?i[s]=o:o?.clone!==void 0&&typeof o.clone=="function"?i[s]=o.clone():i[s]=Zl(o,t)}return i}return n}function yn(n){return new Promise((t,i)=>{setTimeout(t,n)})}function Kl(n,t){if(n<=0)return Promise.resolve();if(t||(t=ue.Current),!t)return Promise.reject("No context");const i=t.time.frameCount+n;return new Promise((s,o)=>{if(!t)return o("No context");const r=()=>{t.time.frameCount>=i&&(t.pre_update_callbacks.splice(t.pre_update_callbacks.indexOf(r),1),s())};t.pre_update_callbacks.push(r)})}const md=C("debugresolveurl"),Pv="rel:";function bO(n,t){return ao(n,t)}function ao(n,t){if(t===void 0)return md&&console.warn("getPath: uri is undefined, returning uri",t),t;if(t.startsWith("./"))return t;if(t.startsWith("http"))return md&&console.warn("getPath: uri is absolute, returning uri",t),t;if(n===void 0)return md&&console.warn("getPath: source is undefined, returning uri",t),t;t.startsWith(Pv)&&(t=t.substring(4));const i=n.lastIndexOf("/");if(i>=0){const s=n.substring(0,i+1);for(;s.endsWith("/")&&t.startsWith("/");)t=t.substring(1);const o=s+t;return md&&console.log("source:",n,`changed uri 
from`,t,`
to `,o,`
basePath: `+s),o}return t}class _O{constructor(t,i){a(this,"writeCallbacks",[]),a(this,"_applied",!1),a(this,"_object"),a(this,"_prop"),a(this,"_wrapperProp"),this._object=t,this._prop=i,this._wrapperProp=Symbol("$"+i),this.apply()}subscribeWrite(t){this.writeCallbacks.push(t)}unsubscribeWrite(t){const i=this.writeCallbacks.indexOf(t);i!==-1&&this.writeCallbacks.splice(i,1)}apply(){if(this._applied||!this._object)return;const t=this._object,i=this._prop;if(t[i]===void 0)return;this._applied=!0,t[this._wrapperProp]!==void 0&&console.warn("Watcher is being applied to an object that already has a wrapper property. This is not (yet) supported");const s=t[i];t[this._wrapperProp]=s,Object.defineProperty(t,i,{get:()=>t[this._wrapperProp],set:o=>{t[this._wrapperProp]=o;for(const r of this.writeCallbacks)r(o,this._prop)}})}revoke(){if(!this._applied||!this._object)return;this._applied=!1;const t=this._object,i=this._prop;Reflect.deleteProperty(t,i);const s=t[this._wrapperProp];t[i]=s,Reflect.deleteProperty(t,this._wrapperProp)}dispose(){this.revoke(),this.writeCallbacks.length=0,this._object=null}}class Js{constructor(t,i){if(a(this,"_watches",[]),Array.isArray(i))for(const s of i)this._watches.push(new Js(t,s));else this._watches.push(new _O(t,i))}subscribeWrite(t){for(const i of this._watches)i.subscribeWrite(t)}unsubscribeWrite(t){for(const i of this._watches)i.unsubscribeWrite(t)}apply(){for(const t of this._watches)t.apply()}revoke(){for(const t of this._watches)t.revoke()}dispose(){for(const t of this._watches)t.dispose();this._watches.length=0}}const wa=Symbol("needle:watches");function gd(n,t){if(!n[wa])if(n instanceof re)n[wa]=new Js(n,["x","y"]);else if(n instanceof x)n[wa]=new Js(n,["x","y","z"]);else if(n instanceof fe||n instanceof V)n[wa]=new Js(n,["x","y","z","w"]);else return!1;return n[wa].subscribeWrite(t),!0}function Pm(n,t){if(!n)return;const i=n[wa];i&&i.unsubscribeWrite(t)}var Q;(n=>{let t;function i(){if(t!==void 0)return t;const z=window.navigator.userAgent,H=/Windows|MacOS|Mac OS/.test(z),ie=/Windows NT/.test(z)&&/Edg/.test(z)&&!/Win64/.test(z);return t=H&&!ie&&!_()}n.isDesktop=i;let s;function o(){return s!==void 0?s:typeof window.orientation<"u"||navigator.userAgent.indexOf("IEMobile")!==-1?s=!0:s=/iPhone|iPad|iPod|Android|IEMobile/i.test(navigator.userAgent)}n.isMobileDevice=o;function r(){return c()}n.isIPad=r;let l;function c(){return l!==void 0?l:l=/iPad/.test(navigator.userAgent)}n.isiPad=c;let h;function d(){return h!==void 0?h:h=/Android/.test(navigator.userAgent)}n.isAndroidDevice=d;let u;function p(){return u!==void 0?u:u=/WebXRViewer\//i.test(navigator.userAgent)}n.isMozillaXR=p;let g;function y(){if(g!==void 0)return g;if(navigator.userAgentData)return g=navigator.userAgentData.platform==="macOS";{const z=navigator.userAgent.toLowerCase();return g=z.includes("mac os x")||z.includes("macintosh")}}n.isMacOS=y;let f;function v(){return f!==void 0?f:f=y()&&"xr"in navigator}n.isVisionOS=v;let b;const w=["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"];function _(){return b!==void 0?b:b=w.includes(navigator.platform)||navigator.userAgent.includes("Mac")&&"ontouchend"in document}n.isiOS=_;let S;function R(){return S!==void 0||(S=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)),S}n.isSafari=R;let M;function T(){return M!==void 0?M:M=navigator.userAgent.includes("OculusBrowser")}n.isQuest=T;let L;function D(){return L!==void 0||(L=document.createElement("a").relList.supports("ar")),L}n.supportsQuickLookAR=D;async function U(){try{return(await navigator.permissions.query({name:"microphone"})).state!=="denied"}catch(z){return console.error("Error querying `microphone` permissions.",z),!1}}n.microphonePermissionsGranted=U;let B;function Y(){if(B!==void 0)return B;const z=navigator.userAgent.match(/iPhone OS (\d+_\d+)/);if(z&&(B=z[1].replace("_",".")),!B){const H=navigator.userAgent.match(/(?:\(Macintosh;|iPhone;|iPad;).*Version\/(\d+\.\d+)/);H&&(B=H[1])}return B||(B=null),B}n.getiOSVersion=Y;let $;function E(){if($!==void 0)return $;const z=navigator.userAgent.match(/(?:CriOS|Chrome)\/(\d+\.\d+\.\d+\.\d+)/);return z?$=z[1].replace("_","."):$=null,$}n.getChromeVersion=E})(Q||(Q={}));function wO(){return Q.isDesktop()}function xO(){return Q.isMobileDevice()}function SO(){return Q.isiPad()}function CO(){return Q.isiPad()}function OO(){return Q.isAndroidDevice()}function PO(){return Q.isMozillaXR()}function kO(){return Q.isMacOS()}function MO(){return Q.isiOS()}function RO(){return Q.isSafari()}function TO(){return Q.isQuest()}async function EO(){return Q.microphonePermissionsGranted()}const AO=/ip=(?<ip>.+?)\n/s;async function IO(){const n=await(await fetch("https://www.cloudflare.com/cdn-cgi/trace")).text(),t=AO.exec(n);return t?t[1]:null}async function jO(){const n=await fetch("https://api.db-ip.com/v2/free/self").catch(()=>null);return n?(await n.json()).ipAddress:void 0}async function LO(){const n=await fetch("https://api.db-ip.com/v2/free/self").catch(()=>null);return n?await n.json():void 0}const lo=new WeakMap;function kv(n,t,i){if(!lo.get(n)){const o=new MutationObserver(r=>{DO(n,r)});lo.set(n,{observer:o,attributeChangedListeners:new Map}),o.observe(n,{attributes:!0})}const s=lo.get(n).attributeChangedListeners;s.has(t)||s.set(t,[]),s.get(t).push(i)}function Mv(n,t,i){if(!lo.get(n))return;const s=lo.get(n).attributeChangedListeners;if(!s.has(t))return;const o=s.get(t),r=o.indexOf(i);if(r!==-1&&(o.splice(r,1),o.length<=0)){s.delete(t);const l=lo.get(n);l?.observer.disconnect(),lo.delete(n)}}function DO(n,t){const i=lo.get(n).attributeChangedListeners;for(const s of t)if(s.type==="attributes"){const o=s.attributeName,r=n.getAttribute(o);if(i.has(o))for(const l of i.get(o))l(r)}}class km{constructor(t){a(this,"reason"),this.reason=t}}async function Mm(n){const t=await Promise.allSettled(n).catch(o=>[new km(o.message)]);let i=!1;const s=t.map(o=>"value"in o?o.value:(i=!0,new km(o.reason)));return{anyFailed:i,results:s}}async function Rv(n){if(!globalThis.QRCode){const s="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js";let o=document.head.querySelector(`script[src="${s}"]`);o||(o=document.createElement("script"),o.src=s,document.head.appendChild(o)),await new Promise((r,l)=>{o.addEventListener("load",()=>{r(!0)})})}const t=globalThis.QRCode,i=n.domElement??document.createElement("div");return new t(i,{width:n.width??256,height:n.height??256,colorDark:"#000000",colorLight:"#ffffff",correctLevel:t.CorrectLevel.M,...n}),i}const Tv=C("debugdebug");let Jl=!1;(C("noerrors")||C("nooverlaymessages"))&&(Jl=!0);const Rm="needle_engine_global_error_container";var Pi=(n=>(n[n.Log=0]="Log",n[n.Warn=1]="Warn",n[n.Error=2]="Error",n))(Pi||{});function Tm(){return jv}const Em=new Array;function BO(n){Em.push(n)}let Am=!1;function FO(...n){if(!Am){Am=!0;try{for(let t=0;t<Em.length;t++)Em[t](...n)}catch(t){console.error(t)}Am=!1}}const Ev=console.error,Av=function(...n){Ev.apply(console,n),NO(n),Un(2,n),Im(...n)};function Iv(n){Jl=!n,n?console.error=Av:console.error=Ev}function zO(n){return Iv(n)}function UO(){Jl||(Tv&&console.warn("Patch console",window.location.hostname),console.error=Av,window.addEventListener("error",n=>{if(!n)return;const t=n.error;if(t===void 0){Xt()&&console.warn("Received unknown error",n,n.target);return}Un(2,t,n.filename,n.lineno),Im(n)},!0),window.addEventListener("unhandledrejection",n=>{Jl||n&&(n.reason?Un(2,n.reason.message,n.reason.stack):Un(2,"unhandled rejection"),Im(n))}))}let jv=0;function Im(...n){jv+=1,FO(...n)}function NO(n){if(Array.isArray(n))for(let t=0;t<n.length;t++){const i=n[t];typeof i=="string"&&i.startsWith("THREE.PropertyBinding: Trying to update node for track:")&&(n[t]="Some animated objects couldn't be found: see console for details")}}function Un(n,t,i,s){if(Jl)return;const o=ue.Current,r=o?.domElement??document.querySelector("needle-engine");if(r){if(Array.isArray(t)){let l="";for(let c=0;c<t.length;c++){let h=t[c];h instanceof Error&&(h=h.message),typeof h!="object"&&(c>0&&(l+=" "),l+=h)}t=l}!t||t.length<=0||WO(n,r,t)}}const ec=new Map;function WO(n,t,i){if(i==null)return;const s=$O(t);if(s.childElementCount>=20){const c=s.lastElementChild;Dv(c)}i.length>400&&(i=i.substring(0,400)+"...");const o=i;if(ec.has(o))return;const r=GO(n,i);s.prepend(r);const l=()=>{ec.delete(o),Dv(r)};ec.set(o,l),setTimeout(l,1e4)}function VO(){Tv&&console.log("Clearing messages");for(const n of ec.values())n?.call(n);ec.clear()}const HO=`

@import url('https://fonts.googleapis.com/css2?family=Roboto+Flex:opsz,wght@8..144,100..1000&display=swap');

div[data-needle_engine_debug_overlay] {
    font-family: 'Roboto Flex', sans-serif;
    font-weight: 400;
    font-size: 16px;
}

div[data-needle_engine_debug_overlay] strong {
    font-weight: 700;
}

div[data-needle_engine_debug_overlay] a {
    color: white;
    text-decoration: none;
    border-bottom: 1px solid rgba(255, 255, 255, 0.3);
}

div[data-needle_engine_debug_overlay] a:hover {
    text-decoration: none;
    border: none;
}

div[data-needle_engine_debug_overlay] .log strong {
    color: rgba(200,200,200,.9);
}

div[data-needle_engine_debug_overlay] .warn strong {
    color: rgba(255,255,230, 1);
}

div[data-needle_engine_debug_overlay] .error strong {
    color: rgba(255,100,120, 1);
}
`;function $O(n){globalThis[Rm]||(globalThis[Rm]=new Map);const t=globalThis[Rm];if(t.has(n))return t.get(n);{const i=document.createElement("div");t.set(n,i),i.setAttribute("data-needle_engine_debug_overlay",""),i.classList.add("debug-container"),i.style.cssText=`
            position: absolute;
            top: 0;
            right: 5px;
            padding-top: 0px;
            max-width: 70%;
            max-height: calc(100% - 5px);
            z-index: 9999999999;
            pointer-events: scroll;
            display: flex;
            align-items: end;
            flex-direction: column;
            color: white;
            overflow: auto;
            word-break: break-word;
        `,n.shadowRoot?n.shadowRoot.appendChild(i):n.appendChild(i);const s=document.createElement("style");return s.innerHTML=HO,i.appendChild(s),i}}const Lv=Symbol("logtype"),fd=new Map;function Dv(n){n.remove();const t=n[Lv],i=fd.get(t)??[];i.push(n),fd.set(t,i)}function GO(n,t){if(fd.has(n)){const s=fd.get(n);if(s.length>0){const o=s.pop();return o.innerHTML=t,o}}const i=document.createElement("div");switch(i.setAttribute("data-id","__needle_engine_debug_overlay"),i.style.marginRight="5px",i.style.padding=".5em",i.style.backgroundColor="rgba(0,0,0,.9)",i.style.marginTop="5px",i.style.marginBottom="3px",i.style.borderRadius="8px",i.style.pointerEvents="all",i.style.userSelect="text",i.style.maxWidth="250px",i.style.whiteSpace="pre-wrap",i.style["backdrop-filter"]="blur(10px)",i.style["-webkit-backdrop-filter"]="blur(10px)",i.style.backgroundColor="rgba(20,20,20,.8)",i.style.boxShadow="inset 0 0 80px rgba(0,0,0,.2), 0 0 5px rgba(0,0,0,.2)",i.style.border="1px solid rgba(160,160,160,.2)",i[Lv]=n,n){case 0:i.classList.add("log"),i.style.color="rgba(200,200,200,.7)",i.style.backgroundColor="rgba(40,40,40,.7)";break;case 1:i.classList.add("warn"),i.style.color="rgb(255, 255, 150)",i.style.backgroundColor="rgba(50,50,20,.8)";break;case 2:i.classList.add("error"),i.style.color="rgb(255, 50, 50",i.style.backgroundColor="rgba(50,20,20,.8)";break}return i.title="Open the browser console (F12) for more information",i.innerHTML=t,i}class qO{constructor(){a(this,"Rad2Deg",180/Math.PI),a(this,"Deg2Rad",Math.PI/180),a(this,"Epsilon",1e-5)}random(t,i){return Array.isArray(t)?t.length<=0?null:t[Math.floor(Math.random()*t.length)]:t!==void 0&&i!==void 0?Math.random()*(i-t)+t:Math.random()}randomVector3(t,i=0,s=1){t.x=this.random(i,s),t.y=this.random(i,s),t.z=this.random(i,s)}clamp(t,i,s){return t<i?i:t>s?s:t}clamp01(t){return this.clamp(t,0,1)}lerp(t,i,s){return s=s<0?0:s,s=s>1?1:s,t+(i-t)*s}inverseLerp(t,i,s){return(s-t)/(i-t)}remap(t,i,s,o,r){return o+(r-o)*(t-i)/(s-i)}moveTowards(t,i,s){return t+=s,(s<0&&t<i||s>0&&t>i)&&(t=i),t}toDegrees(t){return t*180/Math.PI}toRadians(t){return t*Math.PI/180}tan(t){return Math.tan(t)}gammaToLinear(t){return Math.pow(t,2.2)}linearToGamma(t){return Math.pow(t,1/2.2)}approximately(t,i,s=Number.EPSILON){for(const o of XO){const r=t[o],l=i[o];if(r===void 0||l===void 0)break;if(Math.abs(r-l)>s)return!1}return!0}easeInOutCubic(t){return t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2}}const XO=["x","y","z","w"],W=new qO;class Bv{constructor(t){a(this,"y"),a(this,"s"),a(this,"alpha",0),this.setAlpha(t),this.y=null,this.s=null}setAlpha(t){if(t<=0||t>1)throw new Error;this.alpha=t}filter(t,i){i&&this.setAlpha(i);let s;return this.y?s=this.alpha*t+(1-this.alpha)*this.s:s=t,this.y=t,this.s=s,s}lastValue(){return this.y}reset(t){this.y=t,this.s=t}}class yd{constructor(t,i=1,s=0,o=1){if(a(this,"freq"),a(this,"minCutOff"),a(this,"beta"),a(this,"dCutOff"),a(this,"x"),a(this,"dx"),a(this,"lasttime"),t<=0||i<=0||o<=0)throw new Error;this.freq=t,this.minCutOff=i,this.beta=s,this.dCutOff=o,this.x=new Bv(this.alpha(this.minCutOff)),this.dx=new Bv(this.alpha(this.dCutOff)),this.lasttime=null}alpha(t){const i=1/this.freq;return 1/(1+1/(2*Math.PI*t)/i)}filter(t,i=null){this.lasttime&&i&&(this.freq=1/(i-this.lasttime)),this.lasttime=i;const s=this.x.lastValue(),o=s?(t-s)*this.freq:0,r=this.dx.filter(o,this.alpha(this.dCutOff)),l=this.minCutOff+this.beta*Math.abs(r);return this.x.filter(t,this.alpha(l))}reset(t){t!=null&&this.x.reset(t),this.x.alpha=this.alpha(this.minCutOff),this.dx.alpha=this.alpha(this.dCutOff),this.lasttime=null}}class jm{constructor(t,i=1,s=0,o=1){a(this,"x"),a(this,"y"),a(this,"z"),this.x=new yd(t,i,s,o),this.y=new yd(t,i,s,o),this.z=new yd(t,i,s,o)}filter(t,i,s=null){i.x=this.x.filter(t.x,s),i.y=this.y.filter(t.y,s),i.z=this.z.filter(t.z,s)}reset(t){this.x.reset(t?.x),this.y.reset(t?.y),this.z.reset(t?.z)}}const vd="needle:cameraController";function Fv(n){return n[vd]}function Lm(n,t,i){i?n[vd]=t:n[vd]===t&&(n[vd]=null)}const Dm="needle:autofit";function zv(n){return n[Dm]===void 0?!0:n[Dm]!==!1}function bd(n,t){n[Dm]=t}function QO(n,t,i){const s=n.length(),o=t.length(),r=W.lerp(s,o,i);return n.lerp(t,i).normalize().multiplyScalar(r)}const Bm=new V,Uv=new V().setFromAxisAngle(new x(0,1,0),Math.PI);function YO(n,t){n.lookAt(t),n.quaternion.multiply(Uv)}function tc(n,t,i=!0,s=!1){if(n===t)return;Bm.copy(n.quaternion);const o=te(t),r=te(n);if(s){if(Vi(n,Ce(t)),i){const l=r.y,c=r.sub($v(n));c.y=l,n.lookAt(c),n.quaternion.multiply(Uv)}Number.isNaN(n.quaternion.x)&&n.quaternion.copy(Bm);return}i&&(o.y=r.y),n.lookAt(o),Number.isNaN(n.quaternion.x)&&n.quaternion.copy(Bm)}function ZO(n,t,i,s=1){if(i){const o=q(0,0,0),r=t.x/window.innerWidth*2-1,l=-(t.y/window.innerHeight)*2+1;o.set(r,l,0),o.unproject(i);const c=i.worldPosition,h=n.worldPosition.distanceTo(c),d=o.sub(c);d.multiplyScalar(s*3.6*h);const u=i.worldPosition.add(d);return n.lookAt(u),u}return null}const KO=new Oi(()=>new x,100);function q(n,t,i){const s=KO.get();return s.set(0,0,0),n instanceof x?s.copy(n):Array.isArray(n)?s.set(n[0],n[1],n[2]):n instanceof DOMPointReadOnly?s.set(n.x,n.y,n.z):typeof n=="number"?(s.x=n,s.y=t!==void 0?t:s.x,s.z=i!==void 0?i:s.x):typeof n=="object"&&(s.x=n.x,s.y=n.y,s.z=n.z),s}const JO=new Oi(()=>new ae,30);function Nv(n){const t=JO.get();return n?t.copy(n):t.set(0,0,0),t}const eP=new Oi(()=>new V,100);function vn(n){const t=eP.get();return t.identity(),n instanceof V?t.copy(n):n instanceof DOMPointReadOnly&&t.set(n.x,n.y,n.z,n.w),t}const Fm=new Oi(()=>new x,100),Wv=Symbol("lastMatrixWorldUpdateKey");function te(n,t=null,i=!0){const s=t??Fm.get();return n?n.parent?(i&&n.updateWorldMatrix(!0,!1),n.matrixWorldNeedsUpdate&&n[Wv]!==Date.now()&&(n[Wv]=Date.now(),n.updateMatrixWorld()),s.setFromMatrixPosition(n.matrixWorld),s):s.copy(n.position):s.set(0,0,0)}function dt(n,t){if(!n)return n;const i=Fm.get();return t!==i&&i.copy(t),(n?.parent??n).worldToLocal(i),n.position.set(i.x,i.y,i.z),n}function cr(n,t,i,s){const o=Fm.get();return o.set(t,i,s),dt(n,o),n}const _d=new Oi(()=>new V,100),hr=new V,zm=new V;function Ce(n,t=null){if(!n)return _d.get().identity();const i=t??_d.get();return n.parent?(n.getWorldQuaternion(i),i):i.copy(n.quaternion)}function Vi(n,t){if(!n)return;t!==hr&&hr.copy(t);const i=hr,s=n?.parent;s?.getWorldQuaternion(zm),zm.invert();const o=zm.multiply(i);n.quaternion.set(o.x,o.y,o.z,o.w)}function Um(n,t,i,s,o){hr.set(t,i,s,o),Vi(n,hr)}const tP=new Oi(()=>new x,100),iP=new x;function Ye(n,t=null){return t||(t=tP.get()),n?n.parent?(n.getWorldScale(t),t):t.copy(n.scale):t.set(0,0,0)}function xa(n,t){if(!n)return;if(!n.parent){n.scale.copy(t);return}const i=iP;n.parent.getWorldScale(i),n.scale.copy(t),n.scale.divide(i)}const nP=new x,Vv=new V;function sP(n){return Ce(n,Vv),nP.set(0,0,1).applyQuaternion(Vv)}const oP=new Oi(()=>new x,100),Hv=new V;function $v(n,t){return t||(t=oP.get().set(0,0,1)),Ce(n,Hv),t.applyQuaternion(Hv)}const Gv=new Bt,qv=new Bt,rP=new x;function Nm(n){const t=_d.get();return n.getWorldQuaternion(t),qv.setFromQuaternion(t),qv}function Wm(n,t){const i=_d.get();Vi(n,i.setFromEuler(t))}function ic(n){const t=Nm(n),i=rP;return i.set(t.x,t.y,t.z),i.x=W.toDegrees(i.x),i.y=W.toDegrees(i.y),i.z=W.toDegrees(i.z),i}function Vm(n,t){nc(n,t.x,t.y,t.z,!0)}function nc(n,t,i,s,o=!0){o&&(t=W.toRadians(t),i=W.toRadians(i),s=W.toRadians(s)),Gv.set(t,i,s),hr.setFromEuler(Gv),Vi(n,hr)}function wd(n,t=!0){n&&(t?function i(s){console.groupCollapsed((s.name?s.name:"(no name : "+s.type+")")+" %o",s),s.children.forEach(i),console.groupEnd()}(n):n.traverse(function(i){for(var s="|___",o=i;o.parent!==null;)s="	"+s,o=o.parent;console.log(s+i.name+" <"+i.type+">")}))}function aP(n){let t=n?.name||"";if(!n)return t;let i=n.parent;for(;i;)t=i.name+"/"+t,i=i.parent;return t}function Xv(n){if(n){const t=n;return t.blendMode!==void 0&&t.clampWhenFinished!==void 0&&t.enabled!==void 0&&t.fadeIn!==void 0&&t.getClip!==void 0}return!1}class Hi{static createBlitMaterial(t){return new mn({uniforms:{map:new to(null)},vertexShader:this.vertex,fragmentShader:t})}static copyTexture(t,i){this.blitMaterial||(this.blitMaterial=new mn({uniforms:{map:new to(null)},vertexShader:this.vertex,fragmentShader:this.fragment}));const s=i||this.blitMaterial;s.uniforms.map.value=t,s.needsUpdate=!0,s.uniformsNeedUpdate=!0;const o=s.vertexShader;s.vertexShader=this.vertex,this.mesh||(this.mesh=new X(this.planeGeometry,this.blitMaterial));const r=this.mesh;r.material=s,r.frustumCulled=!1,this.scene.children.length=0,this.scene.add(r),this.renderer||(this.renderer=new sr({antialias:!1})),this.renderer.setSize(t.image.width,t.image.height),this.renderer.clear(),this.renderer.render(this.scene,this.perspectiveCam);const l=new Le(this.renderer.domElement);return l.name="Copy",l.needsUpdate=!0,s.vertexShader=o,l}static textureToCanvas(t,i=!1){if(!t)return null;(i===!0||t.isCompressedTexture===!0)&&(t=Qv(t));const s=t.image;if(cP(s)){const o=document.createElement("canvas");o.width=s.width,o.height=s.height;const r=o.getContext("2d");return r?(r.drawImage(s,0,0,s.width,s.height,0,0,o.width,o.height),o):(console.error("Failed getting canvas 2d context"),null)}return null}}a(Hi,"planeGeometry",new zn(2,2,1,1)),a(Hi,"renderer"),a(Hi,"perspectiveCam",new _e),a(Hi,"scene",new wi),a(Hi,"vertex",`
    varying vec2 vUv;
    void main(){
        vUv = uv;
        gl_Position = vec4(position.xy * 1.0,0.,.999999);
    }`),a(Hi,"fragment",`
    uniform sampler2D map; 
    varying vec2 vUv;
    void main(){ 
        vec2 uv = vUv;
        uv.y = 1.0 - uv.y;
        gl_FragColor = texture2D( map, uv);
        // gl_FragColor = vec4(uv.xy, 0, 1);
    }`),a(Hi,"blitMaterial"),a(Hi,"mesh");function Qv(n){return Hi.copyTexture(n)}function lP(n,t=!1){return Hi.textureToCanvas(n,t)}function cP(n){return typeof HTMLImageElement<"u"&&n instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&n instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&n instanceof OffscreenCanvas||typeof ImageBitmap<"u"&&n instanceof ImageBitmap}function hP(n){const t=n.type;return t==="Mesh"||t==="SkinnedMesh"}function Hm(n,t){t?n["needle:rendercustomshadow"]=!0:n["needle:rendercustomshadow"]=!1}function Yv(n){return!!(n&&(n["needle:rendercustomshadow"]===!0||n["needle:rendercustomshadow"]==null))}function oi(n,t=void 0,i=void 0,s=void 0){const o=s||new xi;o.makeEmpty();const r=[];function l(h){let d=!0;if(h.visible&&zv(h)!==!1&&!(h.type==="TransformControlsGizmo"||h.type==="TransformControlsPlane")){if(h instanceof Uy&&(d=!1),h instanceof nm&&(d=!1),h instanceof ba&&(d=!1),h.isGizmo===!0&&(d=!1),h.material instanceof zy&&(d=!1),hP(h)||(d=!1),i&&h.layers.test(i)===!1&&(d=!1),d&&(t&&Array.isArray(t)&&t!=null&&t.includes(h)||typeof t=="function"&&t(h)===!0))return;if(h.isUI!==!0){if(d){const u=h.children;h.children=r;const p=h.position,g=h.scale;if(Number.isNaN(p.x)||Number.isNaN(p.y)||Number.isNaN(p.z)){console.warn(`Object "${h.name}" has NaN values in position or scale.... will ignore it`,p,g);return}o.expandByObject(h,!0),h.children=u}for(const u of h.children)l(u)}}}let c=!1;Array.isArray(n)||(n=[n]);for(const h of n)h&&(c=!0,h.updateMatrixWorld(),l(h));return c||console.warn("No objects to fit camera to..."),o}function Zv(n,t,i){const s=oi([n],i?.ignore),o=new x;s.getSize(o);const r=new x;s.getCenter(r);const l=new x;t.getSize(l);const c=new x;t.getCenter(c);const h=new x;h.set(l.x/o.x,l.y/o.y,l.z/o.z);const d=Math.min(h.x,h.y,h.z),u=i?.scale!==!1;if(u&&xa(n,Ye(n).multiplyScalar(d)),i?.position!==!1){const p=new x;s.getCenter(p),p.y=s.min.y;const g=new x;t.getCenter(g),g.y=t.min.y;const y=g.clone().sub(p);u&&y.multiplyScalar(d),dt(n,te(n).add(y))}return{boundsBefore:s,scale:h}}function Kv(n,t){const i=oi([n]),s=new x;i.getCenter(s),s.y=i.min.y;const o=t.clone().sub(s),r=te(n);return dt(n,r.add(o)),{offset:o,bounds:i}}function $m(n,t,i,s){if(Array.isArray(t)){let l=!0;for(let c=0;c<t.length;c++)$m(n,t[c],c,t)||(l=!1);return l}if(t.type==="MeshStandardMaterial"||t.type==="MeshBasicMaterial")return!1;if(t["material:fbx"]!=null)return!0;const o=new Ft;o["material:fbx"]=t;const r=t;return r&&(r.map?o.color.set(1,1,1):o.color.copyLinearToSRGB(r.color),o.emissive.copyLinearToSRGB(r.emissive),o.emissiveIntensity=r.emissiveIntensity,o.opacity=r.opacity,o.displacementScale=r.displacementScale,o.transparent=r.transparent,o.bumpMap=r.bumpMap,o.aoMap=r.aoMap,o.map=r.map,o.displacementMap=r.displacementMap,o.emissiveMap=r.emissiveMap,o.normalMap=r.normalMap,o.envMap=r.envMap,o.alphaMap=r.alphaMap,o.metalness=r.reflectivity,o.vertexColors=r.vertexColors,r.shininess&&(o.roughness=1-Math.sqrt(r.shininess)/10),o.needsUpdate=!0),i===void 0?n.material=o:s[i]=o,!0}let xd=!1;BO((...n)=>{var t;F()&&(t=ue.Current)!=null&&t.isInXR&&(dr(!0),Jv("error",...n))});function dr(n){if(n){if(xd)return;xd=!0,uP()}else{if(!xd)return;xd=!1,pP()}}const sc={log:void 0,warn:void 0,error:void 0};class dP{constructor(){a(this,"familyName","needle-xr"),a(this,"root",null),a(this,"context",null),a(this,"defaultFontSize",.06),a(this,"targetObject",new j),a(this,"userForwardViewPoint",new x),a(this,"oneEuroFilter",new jm(90,.8)),a(this,"_lastElementRemoveTime",0),a(this,"onBeforeRender",()=>{var t,i;const s=(t=this.context)==null?void 0:t.mainCamera;if(this.context&&s instanceof _e){const o=this.getRoot();Number.isNaN(o.position.x)&&o.position.set(0,0,0),Number.isNaN(o.quaternion.x)&&o.quaternion.set(0,0,0,1),this.context.scene.add(this.targetObject);const r=((i=this.context.xr)==null?void 0:i.rigScale)??1,l=3.5*r,c=s.worldForward;c.y=0,c.normalize().multiplyScalar(l),this.userForwardViewPoint.copy(s.worldPosition).sub(c),this.targetObject.position.distanceTo(this.userForwardViewPoint)>2*r&&(this.targetObject.position.copy(this.userForwardViewPoint),tc(this.targetObject,s,!0,!0),this.targetObject.rotateY(Math.PI)),this.oneEuroFilter.filter(this.targetObject.position,o.position,this.context.time.time);const h=this.context.time.deltaTime;if(o.quaternion.slerp(this.targetObject.quaternion,h*5),o.scale.setScalar(r),this.targetObject.removeFromParent(),this.context.scene.add(o),this.context.time.time-this._lastElementRemoveTime>.1){this._lastElementRemoveTime=this.context.time.time;const d=Date.now();for(let u=0;u<this._activeTexts.length;u++){const p=this._activeTexts[u];if(p instanceof Te.Text&&d-p._activatedTime>2e4){p.removeFromParent(),this._textBuffer.push(p),this._activeTexts.splice(u,1);break}}}}}),a(this,"textOptions",{fontSize:this.defaultFontSize,fontFamily:this.familyName,padding:.03,margin:.005,color:0,backgroundColor:16777215,backgroundOpacity:.4,borderRadius:.03,offset:.025}),a(this,"_textBuffer",[]),a(this,"_activeTexts",[]),this.ensureFont()}onEnable(){this.context=ue.Current||ue.All[0],this.context.pre_render_callbacks.push(this.onBeforeRender)}onDisable(){var t,i,s;(i=this.context)==null||i.pre_render_callbacks.splice((t=this.context)==null?void 0:t.pre_render_callbacks.indexOf(this.onBeforeRender),1),(s=this.root)==null||s.removeFromParent()}addLog(t,i){const s=this.getRoot(),o=this.getText();let r=16777215,l=0;switch(t){case"log":r=16777215,l=0;break;case"warn":r=16772761,l=4465152;break;case"error":r=16755370,l=7798784;break}i.length>1e3&&(i=i.substring(0,1e3)+"...");const c=new Date().toISOString().split("T")[1].split(".")[0];o.textContent="["+c+"] "+i,o.visible=!0,o._activatedTime=Date.now(),s.add(o),this._activeTexts.push(o),this.context&&this.context.scene.add(s),o.set({backgroundColor:r,color:l}),Te.update()}ensureFont(){let t=Te.FontLibrary.getFontFamily(this.familyName);if(!t){t=Te.FontLibrary.addFontFamily(this.familyName);const i=t.addVariant("normal","normal","./include/needle/arial-msdf.json","./include/needle/arial.png");i?.addEventListener("ready",()=>{Te.update()})}}getText(){const t=this.getRoot();if(this._textBuffer.length>0){const s=this._textBuffer.pop();return s.visible=!0,setTimeout(()=>this.disableDepthTestRecursive(s),100),s}if(t.children.length>20&&this._activeTexts.length>0)return this._activeTexts.shift();const i=new Te.Text(this.textOptions);return setTimeout(()=>this.disableDepthTestRecursive(i),500),setTimeout(()=>this.disableDepthTestRecursive(i),1500),i}disableDepthTestRecursive(t,i=0){for(let o=0;o<t.children.length;o++){const r=t.children[o];r instanceof j&&this.disableDepthTestRecursive(r,i+1)}t.renderOrder=10*i,t.layers.set(2);const s=t.material;s&&(s.depthWrite=!1,s.depthTest=!1,s.transparent=!0),i===0&&Te.update()}getRoot(){if(this.root)return this.root;const t=this.defaultFontSize,i={boxSizing:"border-box",fontFamily:this.familyName,width:"2.6",fontSize:t,color:0,lineHeight:1,backgroundColor:16777215,backgroundOpacity:0,whiteSpace:"pre-wrap",flexDirection:"column-reverse"};return this.root=new Te.Block(i),this.root}}let bn=null;function uP(){bn||(bn=new dP),bn.onEnable();for(const n in sc){sc[n]=console[n];let t=!1;console[n]=function(){var i;if((i=sc[n])==null||i.apply(console,arguments),!t)try{t=!0,Jv(n,...arguments)}finally{t=!1}}}}function pP(){bn?.onDisable();for(const n in sc)console[n]=sc[n]}const oc=new Map;function Jv(n,...t){try{switch(oc.clear(),n){case"log":bn?.addLog("log",i());break;case"warn":bn?.addLog("warn",i());break;case"error":bn?.addLog("error",i());break}}catch(r){console.error("Error in spatial console",r)}finally{oc.clear()}function i(){let r="";for(let l=0;l<t.length;l++){const c=t[l];r+=s(c),l<t.length-1&&(r+=", ")}return r}function s(r,l=0){if(typeof r=="string")return'"'+r+'"';if(typeof r=="number"){if(r%1!==0){const c=r.toFixed(5),h=c.indexOf(".");let d=c.length-1;for(;d>h&&c[d]==="0";)d--;return c.substring(0,d+1)}return r.toString()}else if(Array.isArray(r)){let c="[";for(let h=0;h<r.length;h++){const d=r[h];c+=s(d,l+1),h<r.length-1&&(c+=", ")}return c+="]",c}else{if(r===null)return"null";if(r===void 0)return"undefined";if(typeof r=="function")return r.name+"()"}if(r instanceof re)return`(${s(r.x)}, ${s(r.y)})`;if(r instanceof x)return`(${s(r.x)}, ${s(r.y)}, ${s(r.z)})`;if(r instanceof fe)return`(${s(r.x)}, ${s(r.y)}, ${s(r.z)}, ${s(r.w)})`;if(r instanceof V)return`(${s(r.x)}, ${s(r.y)}, ${s(r.z)}, ${s(r.w)})`;if(r instanceof ke||r instanceof Le)return r.name;if(r instanceof Ny)return`[${r.elements.join(", ")}]`;if(r instanceof se)return`[${r.elements.join(", ")}]`;if(r instanceof io)return r.mask.toString();if(typeof r=="object"){if(oc.has(r))return"*";let c=`{
`;c+=o(l);const h=Object.keys(r);let d="";for(let u=0;u<h.length;u++){const p=h[u],g=r[p];if(oc.has(g)){d+="";continue}oc.set(g,!0),d+=p+":"+s(g,l+1),u<h.length-1&&(d+=", "),d.length>=60&&(d+=`
`,d+=o(l),c+=d,d="")}return c+=d,c+=`
}`,c}return r}function o(r){let l="";for(let c=0;c<r;c++)l+=" ";return l}}const mP=C("nodevlogs");function De(n,t=Pi.Log){Un(t,n)}function we(n){De(n,Pi.Warn)}function rc(n){De(n,Pi.Error)}let Gm,qm;function F(){if(mP)return!1;if(Gm!==void 0)return Gm;if(qm!==void 0)return qm;let n=Xt();return n||(n=window.location.hostname.endsWith(".local-credentialless.webcontainer.io")),qm=n,n}function gP(n){Gm=n}let ri,$i=null,Nn=null,ac=!1,eb=null;const tb="terminal",lc=C("console"),fP=C("noerrors")||C("noconsole")||window.crossOriginIsolated;if(lc&&Qm(),!fP&&(lc||Xt())){if(Xt()&&!lc){const t=new URL(window.location.href);t.searchParams.set("console","1"),console.log('\u{1F335} Tip: You can add the "?console" query parameter to the url to show the debug console (on mobile it will automatically open in the bottom right corner when your get errors during development. In VR a spatial console will appear.)',`
Open this page to get the console: `+t.toString())}const n=Q.isMobileDevice()||Q.isQuest()&&F();if((n||lc)&&(UO(),nb(),ob(!0),n)){const t=document.querySelector("needle-engine");t?.addEventListener("enter-ar",()=>{(lc||ri||Tm()>0)&&C("noerrors")}),t?.addEventListener("exit-ar",()=>{_P()})}}const Xm=Symbol("consoleParent");function Qm(){if(ri){ri.showSwitch();return}ob()}function ib(){ri&&(ri.hide(),ri.hideSwitch())}function nb(){eb||(eb=setInterval(yP,500))}let sb=0;function yP(){const n=Tm(),t=n!==sb;sb=n,t&&vP()}function vP(){Qm(),Nn&&(Nn.setAttribute("error","true"),Nn.innerText="\u{1F92C}")}function bP(){Nn&&(Nn.removeAttribute("error"),Nn.innerText=tb)}function _P(){$i&&$i[Xm]&&$i[Xm].appendChild($i)}function ob(n=!1){if(ri!==void 0||ac)return;ac=!0;const t=document.createElement("script");t.onload=()=>{if(!globalThis.VConsole){console.warn("\u{1F335} Debug console failed to load."),ac=!1,ri=null;return}ac=!1,nb(),ri=new VConsole({pluginOrder:["default","needle-console"]});const i=globalThis["needle:codegen_files"];if(i&&i.length>0&&ri.addPlugin(wP()),$i=SP(),$i&&($i[Xm]=$i.parentElement,$i.style.position="absolute",$i.style.zIndex=Number.MAX_SAFE_INTEGER.toString()),ri.setSwitchPosition(20,30),Nn=xP(),Nn){Nn.innerText=tb,Nn.addEventListener("click",bP);const s=document.createElement("style"),o=40;s.innerHTML=`
                #__vconsole .vc-switch {
                    border: 1px solid rgba(255, 255, 255, .1);
                    border-radius: 50%;
                    width: ${o}px;
                    height: ${o}px;
                    padding: 0;
                    line-height: ${o}px;
                    font-size: ${o*.4}px;
                    text-align: center;
                    background: #ffffff5c;
                    backdrop-filter: blur(16px);
                    -webkit-backdrop-filter: blur(16px);
                    user-select: none;
                    pointer-events: auto;
                    transition: transform .2s ease-in-out;
                    box-shadow: 0px 7px 0.5rem 0px rgb(0 0 0 / 6%), inset 0px 0px 1.3rem rgba(0,0,0,.05);

                    font-family: 'Material Symbols Outlined';
                    color: black;
                    font-size: 2.3em;
                    font-weight: 100;
                }
                #__vconsole .vc-switch:hover {
                    cursor: pointer;
                    transform: scale(1.1);
                    transition: transform .1s ease-in-out, background .1s linear;
                    background: rgba(245, 245, 245, .8);
                    outline: rgba(0, 0, 0, .05) 1px solid;
                }
                #__vconsole .vc-switch[error] {
                    background: rgba(255,0,0,.2);
                    animation: vconsole-notify 1s ease-in-out;
                    line-height: 35px;
                }
                @keyframes vconsole-notify {
                    from {
                        transform: scale(1, 1);
                    }
                    10% {
                        transform: scale(1.3, 1.3);
                    }
                    70% {
                        transform: scale(1.4, 1.4);
                    }
                    to {
                        transform: scale(1, 1);
                    }
                }
                #__vconsole .vc-panel {
                    font-family: monospace;
                    font-size: 11px;
                }
                #__vconsole .vc-plugin-box.vc-actived {
                    height: 100%;
                }
                #__vconsole .vc-mask {
                    overflow: hidden;
                }
            `,$i?.prepend(s),n===!0&&Tm()<=0&&ib(),console.log("\u{1F335} Debug console has loaded")}},t.onerror=()=>{console.warn("\u{1F335} Debug console failed to load."+(window.crossOriginIsolated?"This page is using cross-origin isolation, so external scripts can't be loaded.":"")),ac=!1,ri=null},t.src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js",document.body.appendChild(t)}function wP(){if(!globalThis.VConsole)return;const n=new VConsole.VConsolePlugin("needle-console","\u{1F335} Inspect glTF"),t=()=>document.querySelector("#__vc_plug_"+n._id+" iframe");return n.on("renderTab",function(i){const s=globalThis["needle:codegen_files"];if(!s||s.length===0)return;let o=globalThis["needle:codegen_files"][0];const r=o.indexOf("?");r>-1&&(o=o.substring(0,r));const l=location.protocol+"//"+location.host+location.pathname+"/"+o,c=encodeURIComponent(l);n.fullUrl="https://viewer.needle.tools?inspect&file="+c;var h='<iframe src="" style="width: 100%; height: 99%; border: none;"></iframe>';i(h)}),n.on("show",function(){const i=t();i&&i.src!==n.fullUrl&&(i.src=n.fullUrl)}),n.on("hide",function(){const i=t();i&&(i.src="")}),n.on("addTopBar",function(i){var s=new Array;s.push({name:"Open in new window \u2197",onClick:function(o){window.open(n.fullUrl,"_blank"),ri?.hide()}}),s.push({name:"Reload",onClick:function(o){const r=t();r&&(r.src=n.fullUrl)}}),s.push({name:"Fullscreen",onClick:function(o){const r=t();r.requestFullscreen?r.requestFullscreen():r.webkitRequestFullscreen instanceof Function&&r.webkitRequestFullscreen()}}),i(s)}),n}function xP(){return document.querySelector("#__vconsole .vc-switch")||null}function SP(){return document.querySelector("#__vconsole")||null}const rb=C("debugdefines");co('if(!globalThis[""4.4.0-alpha.5""]) globalThis[""4.4.0-alpha.5""] = "0.0.0";'),co('if(!globalThis[""undefined""]) globalThis[""undefined""] = "unknown";'),co('if(!globalThis[""Thu Mar 27 2025 13:24:11 GMT+0100 (Central European Standard Time)""]) globalThis[""Thu Mar 27 2025 13:24:11 GMT+0100 (Central European Standard Time)""] = "unknown";'),co('if(!globalThis[""npk_74222a9fbd1b42572cdd3bf7f639eeb17a07d07f40a6185fac5f722e8fd34df9""]) globalThis[""npk_74222a9fbd1b42572cdd3bf7f639eeb17a07d07f40a6185fac5f722e8fd34df9""] = "unknown";'),co('globalThis["__NEEDLE_ENGINE_VERSION__"] = "4.4.0-alpha.5";'),co('globalThis["__NEEDLE_ENGINE_GENERATOR__"] = "undefined";'),co('globalThis["__NEEDLE_PROJECT_BUILD_TIME__"] = "Thu Mar 27 2025 13:24:11 GMT+0100 (Central European Standard Time)";'),co('globalThis["__NEEDLE_PUBLIC_KEY__"] = "npk_74222a9fbd1b42572cdd3bf7f639eeb17a07d07f40a6185fac5f722e8fd34df9";');const _n="4.4.0-alpha.5",Sd="undefined",Ym="Thu Mar 27 2025 13:24:11 GMT+0100 (Central European Standard Time)";rb&&console.log(`Engine version: ${_n} (generator: ${Sd})
Project built at ${Ym}`);const cc="npk_74222a9fbd1b42572cdd3bf7f639eeb17a07d07f40a6185fac5f722e8fd34df9",_s="needle_isActiveInHierarchy",ur="builtin_components",hc="needle_editor_guid";function co(n){try{(0,eval)(n)}catch(t){rb&&console.error(t)}}const CP='<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 160 187.74"><defs><linearGradient id="a" x1="89.64" y1="184.81" x2="90.48" y2="21.85" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#62d399"/><stop offset=".51" stop-color="#acd842"/><stop offset=".9" stop-color="#d7db0a"/></linearGradient><linearGradient id="b" x1="69.68" y1="178.9" x2="68.08" y2="16.77" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#0ba398"/><stop offset=".5" stop-color="#4ca352"/><stop offset="1" stop-color="#76a30a"/></linearGradient><linearGradient id="c" x1="36.6" y1="152.17" x2="34.7" y2="84.19" gradientUnits="userSpaceOnUse"><stop offset=".19" stop-color="#36a382"/><stop offset=".54" stop-color="#49a459"/><stop offset="1" stop-color="#76a30b"/></linearGradient><linearGradient id="d" x1="15.82" y1="153.24" x2="18" y2="90.86" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#267880"/><stop offset=".51" stop-color="#457a5c"/><stop offset="1" stop-color="#717516"/></linearGradient><linearGradient id="e" x1="135.08" y1="135.43" x2="148.93" y2="63.47" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#b0d939"/><stop offset="1" stop-color="#eadb04"/></linearGradient><linearGradient id="f" x1="-4163.25" y1="2285.12" x2="-4160.81" y2="2215.34" gradientTransform="rotate(20 4088.49 13316.712)" gradientUnits="userSpaceOnUse"><stop offset=".17" stop-color="#74af52"/><stop offset=".48" stop-color="#99be32"/><stop offset="1" stop-color="#c0c40a"/></linearGradient><symbol id="g" viewBox="0 0 160 187.74"><path style="fill:url(#a)" d="M79.32 36.98v150.76L95 174.54l6.59-156.31-22.27 18.75z"/><path style="fill:url(#b)" d="M79.32 36.98 57.05 18.23l6.59 156.31 15.68 13.2V36.98z"/><path style="fill:url(#c)" d="m25.19 104.83 8.63 49.04 12.5-14.95-2.46-56.42-18.67 22.33z"/><path style="fill:url(#d)" d="M25.19 104.83 0 90.24l16.97 53.86 16.85 9.77-8.63-49.04z"/><path style="fill:#9c3" d="M43.86 82.5 18.69 67.98 0 90.24l25.18 14.59L43.86 82.5z"/><path style="fill:url(#e)" d="m134.82 78.69-9.97 56.5 15.58-9.04L160 64.1l-25.18 14.59z"/><path style="fill:url(#f)" d="m134.82 78.69-18.68-22.33-2.86 65 11.57 13.83 9.97-56.5z"/><path style="fill:#ffe113" d="m160 64.1-18.69-22.26-25.17 14.52 18.67 22.33L160 64.1z"/><path style="fill:#f3e600" d="M101.59 18.23 79.32 0 57.05 18.23l22.27 18.75 22.27-18.75z"/></symbol></defs><use width="160" height="187.74" xlink:href="#g"/></svg>',OP=btoa(CP),PP="data:image/svg+xml;base64,"+OP,kP=PP,MP=`<?xml version="1.0" encoding="UTF-8"?> <!DOCTYPE svg PUBLIC '-//W3C//DTD SVG 1.1//EN' 'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'> <svg clip-rule="evenodd" fill-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="2" version="1.1" viewBox="0 0 1014 282" xml:space="preserve" xmlns="http://www.w3.org/2000/svg"> <g transform="matrix(1.008 0 0 1.008 -2.239 .61874)"> <path d="m665.95 132.73v44.88l-10.56-8.4c-0.8-0.64-1.2-1.44-1.2-2.4v-32.4c0-6.48-4.12-9.72-12.36-9.72-2.16 0-4.18 0.4-6.06 1.2s-3.54 1.8-4.98 3-2.56 2.5-3.36 3.9-1.2 2.7-1.2 3.9v40.92l-10.68-8.4c-0.72-0.64-1.08-1.44-1.08-2.4v-53.76l10.92 8.52c0.32 0.24 0.56 0.44 0.72 0.6s0.36 0.32 0.6 0.48c0.96-1.2 2.14-2.28 3.54-3.24s2.92-1.76 4.56-2.4 3.34-1.14 5.1-1.5 3.44-0.54 5.04-0.54c1.44 0 2.92 0.04 4.44 0.12s2.84 0.28 3.96 0.6c4.56 1.12 7.8 3.12 9.72 6s2.88 6.56 2.88 11.04z" fill-rule="nonzero"/> </g> <g transform="matrix(1.008 0 0 1.008 -2.239 .61874)"> <path d="m732.38 146.05c0 0.88 0.02 1.5 0.06 1.86s-0.02 0.98-0.18 1.86h-7.08c-2.08 0-4.44-0.02-7.08-0.06s-5.36-0.06-8.16-0.06h-22.08c0 2.88 0.56 5.36 1.68 7.44s2.6 3.8 4.44 5.16 3.94 2.36 6.3 3 4.74 0.96 7.14 0.96c3.04 0 5.9-0.76 8.58-2.28s4.94-3.52 6.78-6c0.64 0.56 1.54 1.48 2.7 2.76s2.94 3.2 5.34 5.76c-2.8 3.36-6.22 6.02-10.26 7.98s-8.42 2.94-13.14 2.94-8.92-0.64-12.84-1.92-7.32-3.24-10.2-5.88-5.12-5.98-6.72-10.02-2.4-8.82-2.4-14.34c0-4.96 0.66-9.42 1.98-13.38s3.22-7.32 5.7-10.08 5.44-4.9 8.88-6.42 7.32-2.28 11.64-2.28c5.76 0 10.52 0.88 14.28 2.64s6.72 4.16 8.88 7.2 3.66 6.54 4.5 10.5 1.26 8.18 1.26 12.66zm-29.4-22.8c-2.16 0.16-4.16 0.72-6 1.68s-3.42 2.2-4.74 3.72-2.36 3.28-3.12 5.28-1.14 4.12-1.14 6.36h33.12c0-2-0.22-4.06-0.66-6.18s-1.3-4.02-2.58-5.7-3.1-3.02-5.46-4.02-5.5-1.38-9.42-1.14z" fill-rule="nonzero"/> </g> <g transform="matrix(1.008 0 0 1.008 -2.239 .61874)"> <path d="m795.93 146.05c0 0.88 0.02 1.5 0.06 1.86s-0.02 0.98-0.18 1.86h-7.08c-2.08 0-4.44-0.02-7.08-0.06s-5.36-0.06-8.16-0.06h-22.08c0 2.88 0.56 5.36 1.68 7.44s2.6 3.8 4.44 5.16 3.94 2.36 6.3 3 4.74 0.96 7.14 0.96c3.04 0 5.9-0.76 8.58-2.28s4.94-3.52 6.78-6c0.64 0.56 1.54 1.48 2.7 2.76s2.94 3.2 5.34 5.76c-2.8 3.36-6.22 6.02-10.26 7.98s-8.42 2.94-13.14 2.94-8.92-0.64-12.84-1.92-7.32-3.24-10.2-5.88-5.12-5.98-6.72-10.02-2.4-8.82-2.4-14.34c0-4.96 0.66-9.42 1.98-13.38s3.22-7.32 5.7-10.08 5.44-4.9 8.88-6.42 7.32-2.28 11.64-2.28c5.76 0 10.52 0.88 14.28 2.64s6.72 4.16 8.88 7.2 3.66 6.54 4.5 10.5 1.26 8.18 1.26 12.66zm-29.4-22.8c-2.16 0.16-4.16 0.72-6 1.68s-3.42 2.2-4.74 3.72-2.36 3.28-3.12 5.28-1.14 4.12-1.14 6.36h33.12c0-2-0.22-4.06-0.66-6.18s-1.3-4.02-2.58-5.7-3.1-3.02-5.46-4.02-5.5-1.38-9.42-1.14z" fill-rule="nonzero"/> </g> <g transform="matrix(1.008 0 0 1.008 -2.239 .61874)"> <path d="m858.57 97.21c0.64 0.48 0.96 1.16 0.96 2.04v74.88c-0.08 1.04-0.12 2.12-0.12 3.24-1.84-1.52-3.56-2.92-5.16-4.2-1.36-1.12-2.66-2.18-3.9-3.18s-2.06-1.66-2.46-1.98c-1.76 2.48-4.26 4.44-7.5 5.88s-7.02 2.16-11.34 2.16c-3.84 0-7.4-0.7-10.68-2.1s-6.14-3.44-8.58-6.12-4.34-5.94-5.7-9.78-2.04-8.16-2.04-12.96c0-4.32 0.78-8.34 2.34-12.06s3.6-6.92 6.12-9.6 5.38-4.78 8.58-6.3 6.48-2.28 9.84-2.28c2.56 0 4.82 0.22 6.78 0.66s3.68 1.06 5.16 1.86 2.78 1.74 3.9 2.82 2.16 2.22 3.12 3.42v-35.04l10.68 8.64zm-27.96 67.92c3.6 0 6.52-0.68 8.76-2.04s3.98-3.06 5.22-5.1 2.1-4.22 2.58-6.54 0.72-4.44 0.72-6.36v-1.2c0-1.12-0.22-2.7-0.66-4.74s-1.28-4.06-2.52-6.06-3-3.7-5.28-5.1-5.22-2.02-8.82-1.86c-3.44 0-6.26 0.74-8.46 2.22s-3.96 3.26-5.28 5.34-2.24 4.2-2.76 6.36-0.78 3.92-0.78 5.28c0 1.84 0.24 3.92 0.72 6.24s1.36 4.48 2.64 6.48 3.04 3.68 5.28 5.04 5.12 2.04 8.64 2.04z" fill-rule="nonzero"/> </g> <g transform="matrix(1.008 0 0 1.008 -2.239 .61874)"> <path d="m882.81 97.09c0.64 0.48 0.96 1.12 0.96 1.92l-0.12 41.04v37.08l-10.56-8.4c-0.72-0.64-1.08-1.44-1.08-2.4v-77.88l10.8 8.64z" fill-rule="nonzero"/> </g> <g transform="matrix(1.008 0 0 1.008 -2.239 .61874)"> <path d="m950.36 146.05c0 0.88 0.02 1.5 0.06 1.86s-0.02 0.98-0.18 1.86h-7.08c-2.08 0-4.44-0.02-7.08-0.06s-5.36-0.06-8.16-0.06h-22.08c0 2.88 0.56 5.36 1.68 7.44s2.6 3.8 4.44 5.16 3.94 2.36 6.3 3 4.74 0.96 7.14 0.96c3.04 0 5.9-0.76 8.58-2.28s4.94-3.52 6.78-6c0.64 0.56 1.54 1.48 2.7 2.76s2.94 3.2 5.34 5.76c-2.8 3.36-6.22 6.02-10.26 7.98s-8.42 2.94-13.14 2.94-8.92-0.64-12.84-1.92-7.32-3.24-10.2-5.88-5.12-5.98-6.72-10.02-2.4-8.82-2.4-14.34c0-4.96 0.66-9.42 1.98-13.38s3.22-7.32 5.7-10.08 5.44-4.9 8.88-6.42 7.32-2.28 11.64-2.28c5.76 0 10.52 0.88 14.28 2.64s6.72 4.16 8.88 7.2 3.66 6.54 4.5 10.5 1.26 8.18 1.26 12.66zm-29.4-22.8c-2.16 0.16-4.16 0.72-6 1.68s-3.42 2.2-4.74 3.72-2.36 3.28-3.12 5.28-1.14 4.12-1.14 6.36h33.12c0-2-0.22-4.06-0.66-6.18s-1.3-4.02-2.58-5.7-3.1-3.02-5.46-4.02-5.5-1.38-9.42-1.14z" fill-rule="nonzero"/> </g> <g transform="matrix(1.8559 0 0 .7642 45.348 36.475)"> <g transform="translate(2.7114)"> <path d="m3.935 173.02c-0.331 0-0.497-0.402-0.497-1.207v-51.002c0-0.738 0.138-1.107 0.414-1.107h1.781c0.277 0 0.415 0.335 0.415 1.006v5.935c0 0.336 0.027 0.553 0.083 0.654 0.055 0.101 0.151-0.017 0.289-0.352 0.912-1.744 1.754-3.236 2.527-4.477 0.773-1.24 1.554-2.179 2.341-2.816s1.65-0.956 2.588-0.956c1.685 0 3.011 0.922 3.977 2.766 0.967 1.845 1.602 3.84 1.905 5.986 0.056 0.268 0.139 0.369 0.249 0.302s0.221-0.235 0.331-0.503c0.939-1.811 1.802-3.353 2.589-4.628 0.787-1.274 1.581-2.246 2.382-2.917s1.671-1.006 2.61-1.006c2.016 0 3.569 1.392 4.66 4.175 1.09 2.783 1.636 6.421 1.636 10.915v37.925c0 0.871-0.18 1.307-0.539 1.307h-1.739c-0.138 0-0.249-0.1-0.332-0.301-0.083-0.202-0.124-0.503-0.124-0.906v-36.315c0-3.555-0.338-6.321-1.015-8.3-0.676-1.978-1.76-2.967-3.251-2.967-0.884 0-1.726 0.386-2.527 1.157s-1.519 1.727-2.154 2.867-1.201 2.213-1.699 3.219c-0.248 0.469-0.421 0.905-0.517 1.308-0.097 0.402-0.145 0.972-0.145 1.71v37.221c0 0.871-0.166 1.307-0.497 1.307h-1.74c-0.166 0-0.29-0.1-0.373-0.301-0.083-0.202-0.124-0.503-0.124-0.906v-36.315c0-3.555-0.332-6.321-0.994-8.3-0.663-1.978-1.754-2.967-3.273-2.967-1.242 0-2.375 0.704-3.396 2.112-1.022 1.409-2.223 3.555-3.604 6.439v39.031c0 0.805-0.18 1.207-0.539 1.207h-1.698z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> <g transform="translate(2.7114)"> <path d="m53.642 166.28c-1.077 2.549-2.237 4.477-3.479 5.785-1.243 1.307-2.61 1.961-4.101 1.961-2.154 0-3.853-1.324-5.095-3.973-1.243-2.649-1.864-6.187-1.864-10.613 0-3.488 0.4-6.489 1.201-9.004s1.988-4.51 3.562-5.985c1.574-1.476 3.521-2.414 5.841-2.817l3.686-0.704c0.221-0.067 0.394-0.218 0.518-0.453 0.124-0.234 0.187-0.587 0.187-1.056v-2.917c0-3.89-0.504-6.975-1.512-9.255s-2.354-3.42-4.039-3.42c-1.298 0-2.472 0.72-3.521 2.162s-2.002 3.572-2.858 6.388c-0.083 0.268-0.159 0.453-0.228 0.554-0.069 0.1-0.172 0.083-0.311-0.051l-1.698-1.71c-0.083-0.134-0.138-0.285-0.166-0.453-0.027-0.167 0.014-0.452 0.125-0.855 0.856-3.353 2.009-6.052 3.459-8.098 1.449-2.045 3.224-3.068 5.322-3.068 1.74 0 3.211 0.687 4.412 2.062s2.112 3.37 2.734 5.986c0.621 2.615 0.932 5.7 0.932 9.255v35.712c0 0.536-0.035 0.888-0.104 1.056s-0.2 0.251-0.393 0.251h-1.533c-0.166 0-0.29-0.117-0.373-0.352-0.083-0.234-0.124-0.553-0.124-0.955l-0.083-5.231c-0.055-0.939-0.221-1.006-0.497-0.202zm0.456-19.314c0-1.14-0.194-1.643-0.58-1.509l-3.107 0.603c-1.436 0.202-2.686 0.638-3.749 1.308-1.063 0.671-1.953 1.543-2.671 2.616s-1.257 2.33-1.616 3.772-0.538 3.102-0.538 4.98c0 3.152 0.455 5.616 1.367 7.393 0.911 1.778 2.14 2.666 3.686 2.666 0.939 0 1.85-0.419 2.734-1.257s1.671-1.895 2.361-3.169c0.663-1.408 1.181-2.85 1.553-4.326 0.373-1.475 0.56-2.883 0.56-4.225v-8.852z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> <g transform="translate(2.7114)"> <path d="m79.034 173.02c-0.166 0-0.297-0.117-0.394-0.352-0.096-0.234-0.145-0.553-0.145-0.955v-4.628c0-0.536-0.041-0.838-0.124-0.905s-0.207 0.1-0.373 0.503c-0.276 0.67-0.69 1.593-1.242 2.766-0.553 1.174-1.271 2.23-2.154 3.169-0.884 0.939-1.961 1.408-3.231 1.408-1.74 0-3.314-0.989-4.722-2.967-1.409-1.979-2.534-4.963-3.376-8.953-0.843-3.991-1.264-8.937-1.264-14.838 0-5.701 0.415-10.68 1.243-14.939s1.988-7.595 3.479-10.009c1.492-2.415 3.204-3.622 5.137-3.622 1.436 0 2.616 0.57 3.541 1.71 0.926 1.14 1.719 2.381 2.382 3.722 0.249 0.47 0.414 0.637 0.497 0.503s0.125-0.536 0.125-1.207v-23.841c0-0.805 0.151-1.208 0.455-1.208h1.864c0.276 0 0.414 0.369 0.414 1.107v72.128c0 0.537-0.041 0.905-0.124 1.107-0.083 0.201-0.235 0.301-0.455 0.301h-1.533zm-0.621-42.049c-0.939-2.213-1.885-3.94-2.838-5.181s-2.009-1.861-3.169-1.861c-1.463 0-2.768 0.889-3.914 2.666s-2.044 4.376-2.693 7.796-0.973 7.578-0.973 12.474c0 5.097 0.338 9.272 1.015 12.524 0.676 3.253 1.567 5.651 2.672 7.193 1.104 1.543 2.305 2.314 3.603 2.314 1.188 0 2.258-0.704 3.211-2.113 0.952-1.408 1.705-3.118 2.257-5.13s0.829-3.957 0.829-5.835v-24.847z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> <g transform="translate(2.7114)"> <path d="m89.514 149.38c0 3.42 0.345 6.606 1.035 9.557 0.691 2.951 1.609 5.315 2.755 7.092s2.437 2.666 3.873 2.666c1.519 0 2.837-0.738 3.956-2.213 1.118-1.476 2.064-3.655 2.837-6.539 0.083-0.336 0.166-0.52 0.249-0.554 0.083-0.033 0.179 0.017 0.29 0.151l1.408 1.912c0.221 0.268 0.235 0.67 0.041 1.207-0.69 2.548-1.47 4.661-2.34 6.337-0.87 1.677-1.857 2.935-2.962 3.773-1.104 0.838-2.319 1.257-3.645 1.257-2.043 0-3.838-1.14-5.385-3.42-1.546-2.28-2.761-5.482-3.645-9.607-0.884-4.124-1.325-8.836-1.325-14.134 0-5.901 0.455-10.931 1.367-15.089 0.911-4.158 2.14-7.377 3.686-9.658 1.547-2.28 3.3-3.42 5.261-3.42 1.988 0 3.714 1.073 5.178 3.219 1.463 2.146 2.595 5.231 3.396 9.255s1.201 8.886 1.201 14.587c0 0.469-0.02 0.939-0.062 1.408-0.041 0.469-0.214 0.704-0.517 0.704h-16.362c-0.083 0-0.152 0.151-0.207 0.453-0.056 0.302-0.083 0.654-0.083 1.056zm13.752-6.237c0.304 0 0.497-0.1 0.58-0.302 0.083-0.201 0.124-0.57 0.124-1.106 0-3.219-0.283-6.187-0.849-8.903s-1.367-4.896-2.402-6.539c-1.036-1.643-2.272-2.464-3.708-2.464-1.629 0-2.996 0.955-4.101 2.867-1.104 1.911-1.94 4.342-2.506 7.293s-0.849 6.002-0.849 9.154h13.711z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> <g transform="translate(2.7114)"> <path d="m148.54 119.7c0.165 0 0.283 0.117 0.352 0.352s0.076 0.52 0.02 0.855l-6.254 50.902c-0.028 0.47-0.104 0.788-0.228 0.956s-0.297 0.251-0.518 0.251h-1.615c-0.442 0-0.718-0.402-0.829-1.207l-5.26-40.138c-0.111-0.604-0.201-0.905-0.27-0.905s-0.131 0.301-0.186 0.905l-5.012 40.138c-0.028 0.47-0.097 0.788-0.207 0.956-0.111 0.168-0.277 0.251-0.497 0.251h-1.74c-0.442 0-0.718-0.402-0.829-1.207l-6.503-50.801c-0.055-0.403-0.048-0.721 0.021-0.956s0.2-0.352 0.393-0.352h1.823c0.166 0 0.297 0.067 0.393 0.201 0.097 0.134 0.159 0.403 0.187 0.805l5.302 41.848c0.083 0.671 0.179 0.989 0.29 0.956 0.11-0.034 0.207-0.386 0.29-1.056l5.219-41.949c0.055-0.268 0.124-0.47 0.207-0.604s0.193-0.201 0.331-0.201h1.533c0.138 0 0.262 0.067 0.373 0.201 0.11 0.134 0.179 0.403 0.207 0.805l5.468 41.848c0.083 0.671 0.179 0.989 0.29 0.956 0.11-0.034 0.207-0.386 0.29-1.056l5.053-41.849c0.055-0.335 0.138-0.57 0.249-0.704 0.11-0.134 0.234-0.201 0.373-0.201h1.284z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> <g transform="translate(2.7114)"> <path d="m156.49 171.51c0 0.604-0.042 1.006-0.125 1.208-0.082 0.201-0.262 0.301-0.538 0.301h-1.533c-0.221 0-0.366-0.083-0.435-0.251s-0.103-0.486-0.103-0.956v-50.902c0-0.805 0.152-1.207 0.456-1.207h1.822c0.304 0 0.456 0.402 0.456 1.207v50.6zm0.165-63.979c0 1.207-0.207 1.811-0.621 1.811h-1.905c-0.221 0-0.366-0.135-0.435-0.403s-0.104-0.67-0.104-1.207v-7.847c0-1.006 0.18-1.509 0.539-1.509h1.988c0.359 0 0.538 0.47 0.538 1.409v7.746z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> <g transform="translate(2.7114)"> <path d="m168.3 124.83c-0.221 0-0.331 0.269-0.331 0.805v33.801c0 3.42 0.221 5.667 0.663 6.74 0.441 1.073 1.09 1.609 1.946 1.609h3.024c0.138 0 0.242 0.084 0.311 0.252 0.069 0.167 0.103 0.419 0.103 0.754v2.716c0 0.537-0.138 0.906-0.414 1.107-0.248 0.067-0.614 0.134-1.098 0.201-0.483 0.067-0.959 0.118-1.429 0.151-0.469 0.034-0.828 0.05-1.077 0.05-1.712 0-2.934-0.955-3.665-2.867-0.732-1.911-1.098-5.013-1.098-9.305v-35.108c0-0.604-0.124-0.906-0.373-0.906h-3.521c-0.248 0-0.373-0.268-0.373-0.804v-3.521c0-0.537 0.111-0.805 0.332-0.805h3.686c0.166 0 0.263-0.268 0.29-0.805l0.415-16.095c0-0.805 0.124-1.207 0.372-1.207h1.492c0.303 0 0.455 0.436 0.455 1.307v15.995c0 0.537 0.097 0.805 0.29 0.805h5.468c0.221 0 0.331 0.268 0.331 0.805v3.521c0 0.536-0.124 0.804-0.373 0.804h-5.426z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> <g transform="translate(2.7114)"> <path d="m179.4 173.02c-0.331 0-0.497-0.402-0.497-1.207v-72.329c0-0.738 0.138-1.107 0.414-1.107h1.782c0.276 0 0.414 0.336 0.414 1.006v27.162c0 0.335 0.034 0.536 0.103 0.603s0.159-0.033 0.27-0.302c0.994-1.81 1.898-3.319 2.713-4.526 0.814-1.208 1.629-2.113 2.444-2.717 0.814-0.603 1.691-0.905 2.63-0.905 2.182 0 3.839 1.375 4.971 4.125 1.132 2.749 1.698 6.404 1.698 10.965v37.925c0 0.871-0.166 1.307-0.497 1.307h-1.74c-0.165 0-0.29-0.1-0.373-0.301-0.082-0.202-0.124-0.503-0.124-0.906v-36.315c0-3.555-0.366-6.321-1.097-8.3-0.732-1.978-1.899-2.967-3.501-2.967-0.883 0-1.705 0.318-2.464 0.956-0.76 0.637-1.526 1.576-2.299 2.816-0.773 1.241-1.643 2.834-2.61 4.779v39.031c0 0.805-0.179 1.207-0.538 1.207h-1.699z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> </g> <g transform="matrix(.80638 0 0 .80638 452.53 65.421)" fill-rule="nonzero"> <path d="m79.32 36.98v150.76l15.68-13.2 6.59-156.31-22.27 18.75z" fill="url(#f)"/> <path d="m79.32 36.98-22.27-18.75 6.59 156.31 15.68 13.2v-150.76z" fill="url(#e)"/> <path d="m25.19 104.83 8.63 49.04 12.5-14.95-2.46-56.42-18.67 22.33z" fill="url(#d)"/> <path d="m25.19 104.83-25.19-14.59 16.97 53.86 16.85 9.77-8.63-49.04z" fill="url(#c)"/> <path d="M43.86,82.5L18.69,67.98L0,90.24L25.18,104.83L43.86,82.5Z" fill="#9c3"/> <path d="m134.82 78.69-9.97 56.5 15.58-9.04 19.57-62.05-25.18 14.59z" fill="url(#b)"/> <path d="m134.82 78.69-18.68-22.33-2.86 65 11.57 13.83 9.97-56.5z" fill="url(#a)"/> <path d="m160 64.1-18.69-22.26-25.17 14.52 18.67 22.33 25.19-14.59z" fill="#ffe113"/> <path d="M101.59,18.23L79.32,0L57.05,18.23L79.32,36.98L101.59,18.23Z" fill="#f3e600"/> </g> <defs> <linearGradient id="f" x2="1" gradientTransform="matrix(.84 -162.96 162.96 .84 89.64 184.81)" gradientUnits="userSpaceOnUse"><stop stop-color="#62d399" offset="0"/><stop stop-color="#acd842" offset=".51"/><stop stop-color="#d7db0a" offset=".9"/><stop stop-color="#d7db0a" offset="1"/></linearGradient> <linearGradient id="e" x2="1" gradientTransform="matrix(-1.6,-162.13,162.13,-1.6,69.68,178.9)" gradientUnits="userSpaceOnUse"><stop stop-color="#0ba398" offset="0"/><stop stop-color="#4ca352" offset=".5"/><stop stop-color="#76a30a" offset="1"/></linearGradient> <linearGradient id="d" x2="1" gradientTransform="matrix(-1.9,-67.98,67.98,-1.9,36.6,152.17)" gradientUnits="userSpaceOnUse"><stop stop-color="#36a382" offset="0"/><stop stop-color="#36a382" offset=".19"/><stop stop-color="#49a459" offset=".54"/><stop stop-color="#76a30b" offset="1"/></linearGradient> <linearGradient id="c" x2="1" gradientTransform="matrix(2.18,-62.38,62.38,2.18,15.82,153.24)" gradientUnits="userSpaceOnUse"><stop stop-color="#267880" offset="0"/><stop stop-color="#457a5c" offset=".51"/><stop stop-color="#717516" offset="1"/></linearGradient> <linearGradient id="b" x2="1" gradientTransform="matrix(13.85,-71.96,71.96,13.85,135.08,135.43)" gradientUnits="userSpaceOnUse"><stop stop-color="#b0d939" offset="0"/><stop stop-color="#eadb04" offset="1"/></linearGradient> <linearGradient id="a" x2="1" gradientTransform="matrix(26.159 -64.737 64.737 26.159 107.42 128.14)" gradientUnits="userSpaceOnUse"><stop stop-color="#74af52" offset="0"/><stop stop-color="#74af52" offset=".17"/><stop stop-color="#99be32" offset=".48"/><stop stop-color="#c0c40a" offset="1"/></linearGradient> </defs> </svg>`;btoa(MP);const RP='<svg viewBox="0 0 509 154" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2"><path d="M665.95 132.73v44.88l-10.56-8.4c-.8-.64-1.2-1.44-1.2-2.4v-32.4c0-6.48-4.12-9.72-12.36-9.72-2.16 0-4.18.4-6.06 1.2-1.88.8-3.54 1.8-4.98 3-1.44 1.2-2.56 2.5-3.36 3.9-.8 1.4-1.2 2.7-1.2 3.9v40.92l-10.68-8.4c-.72-.64-1.08-1.44-1.08-2.4v-53.76l10.92 8.52c.32.24.56.44.72.6.16.16.36.32.6.48.96-1.2 2.14-2.28 3.54-3.24 1.4-.96 2.92-1.76 4.56-2.4 1.64-.64 3.34-1.14 5.1-1.5 1.76-.36 3.44-.54 5.04-.54 1.44 0 2.92.04 4.44.12 1.52.08 2.84.28 3.96.6 4.56 1.12 7.8 3.12 9.72 6 1.92 2.88 2.88 6.56 2.88 11.04ZM732.38 146.05c0 .88.02 1.5.06 1.86.04.36-.02.98-.18 1.86h-7.08c-2.08 0-4.44-.02-7.08-.06-2.64-.04-5.36-.06-8.16-.06h-22.08c0 2.88.56 5.36 1.68 7.44 1.12 2.08 2.6 3.8 4.44 5.16 1.84 1.36 3.94 2.36 6.3 3 2.36.64 4.74.96 7.14.96 3.04 0 5.9-.76 8.58-2.28 2.68-1.52 4.94-3.52 6.78-6 .64.56 1.54 1.48 2.7 2.76 1.16 1.28 2.94 3.2 5.34 5.76-2.8 3.36-6.22 6.02-10.26 7.98-4.04 1.96-8.42 2.94-13.14 2.94-4.72 0-8.92-.64-12.84-1.92-3.92-1.28-7.32-3.24-10.2-5.88-2.88-2.64-5.12-5.98-6.72-10.02-1.6-4.04-2.4-8.82-2.4-14.34 0-4.96.66-9.42 1.98-13.38 1.32-3.96 3.22-7.32 5.7-10.08s5.44-4.9 8.88-6.42c3.44-1.52 7.32-2.28 11.64-2.28 5.76 0 10.52.88 14.28 2.64 3.76 1.76 6.72 4.16 8.88 7.2 2.16 3.04 3.66 6.54 4.5 10.5.84 3.96 1.26 8.18 1.26 12.66Zm-29.4-22.8c-2.16.16-4.16.72-6 1.68-1.84.96-3.42 2.2-4.74 3.72-1.32 1.52-2.36 3.28-3.12 5.28-.76 2-1.14 4.12-1.14 6.36h33.12c0-2-.22-4.06-.66-6.18-.44-2.12-1.3-4.02-2.58-5.7-1.28-1.68-3.1-3.02-5.46-4.02-2.36-1-5.5-1.38-9.42-1.14ZM795.93 146.05c0 .88.02 1.5.06 1.86.04.36-.02.98-.18 1.86h-7.08c-2.08 0-4.44-.02-7.08-.06-2.64-.04-5.36-.06-8.16-.06h-22.08c0 2.88.56 5.36 1.68 7.44 1.12 2.08 2.6 3.8 4.44 5.16 1.84 1.36 3.94 2.36 6.3 3 2.36.64 4.74.96 7.14.96 3.04 0 5.9-.76 8.58-2.28 2.68-1.52 4.94-3.52 6.78-6 .64.56 1.54 1.48 2.7 2.76 1.16 1.28 2.94 3.2 5.34 5.76-2.8 3.36-6.22 6.02-10.26 7.98-4.04 1.96-8.42 2.94-13.14 2.94-4.72 0-8.92-.64-12.84-1.92-3.92-1.28-7.32-3.24-10.2-5.88-2.88-2.64-5.12-5.98-6.72-10.02-1.6-4.04-2.4-8.82-2.4-14.34 0-4.96.66-9.42 1.98-13.38 1.32-3.96 3.22-7.32 5.7-10.08s5.44-4.9 8.88-6.42c3.44-1.52 7.32-2.28 11.64-2.28 5.76 0 10.52.88 14.28 2.64 3.76 1.76 6.72 4.16 8.88 7.2 2.16 3.04 3.66 6.54 4.5 10.5.84 3.96 1.26 8.18 1.26 12.66Zm-29.4-22.8c-2.16.16-4.16.72-6 1.68-1.84.96-3.42 2.2-4.74 3.72-1.32 1.52-2.36 3.28-3.12 5.28-.76 2-1.14 4.12-1.14 6.36h33.12c0-2-.22-4.06-.66-6.18-.44-2.12-1.3-4.02-2.58-5.7-1.28-1.68-3.1-3.02-5.46-4.02-2.36-1-5.5-1.38-9.42-1.14ZM858.57 97.21c.64.48.96 1.16.96 2.04v74.88c-.08 1.04-.12 2.12-.12 3.24-1.84-1.52-3.56-2.92-5.16-4.2-1.36-1.12-2.66-2.18-3.9-3.18-1.24-1-2.06-1.66-2.46-1.98-1.76 2.48-4.26 4.44-7.5 5.88-3.24 1.44-7.02 2.16-11.34 2.16-3.84 0-7.4-.7-10.68-2.1-3.28-1.4-6.14-3.44-8.58-6.12-2.44-2.68-4.34-5.94-5.7-9.78-1.36-3.84-2.04-8.16-2.04-12.96 0-4.32.78-8.34 2.34-12.06 1.56-3.72 3.6-6.92 6.12-9.6 2.52-2.68 5.38-4.78 8.58-6.3 3.2-1.52 6.48-2.28 9.84-2.28 2.56 0 4.82.22 6.78.66 1.96.44 3.68 1.06 5.16 1.86s2.78 1.74 3.9 2.82a35.92 35.92 0 0 1 3.12 3.42V88.57l10.68 8.64Zm-27.96 67.92c3.6 0 6.52-.68 8.76-2.04 2.24-1.36 3.98-3.06 5.22-5.1a20.5 20.5 0 0 0 2.58-6.54c.48-2.32.72-4.44.72-6.36v-1.2c0-1.12-.22-2.7-.66-4.74-.44-2.04-1.28-4.06-2.52-6.06s-3-3.7-5.28-5.1c-2.28-1.4-5.22-2.02-8.82-1.86-3.44 0-6.26.74-8.46 2.22-2.2 1.48-3.96 3.26-5.28 5.34-1.32 2.08-2.24 4.2-2.76 6.36-.52 2.16-.78 3.92-.78 5.28 0 1.84.24 3.92.72 6.24.48 2.32 1.36 4.48 2.64 6.48s3.04 3.68 5.28 5.04c2.24 1.36 5.12 2.04 8.64 2.04ZM882.81 97.09c.64.48.96 1.12.96 1.92l-.12 41.04v37.08l-10.56-8.4c-.72-.64-1.08-1.44-1.08-2.4V88.45l10.8 8.64ZM950.36 146.05c0 .88.02 1.5.06 1.86.04.36-.02.98-.18 1.86h-7.08c-2.08 0-4.44-.02-7.08-.06-2.64-.04-5.36-.06-8.16-.06h-22.08c0 2.88.56 5.36 1.68 7.44 1.12 2.08 2.6 3.8 4.44 5.16 1.84 1.36 3.94 2.36 6.3 3 2.36.64 4.74.96 7.14.96 3.04 0 5.9-.76 8.58-2.28 2.68-1.52 4.94-3.52 6.78-6 .64.56 1.54 1.48 2.7 2.76 1.16 1.28 2.94 3.2 5.34 5.76-2.8 3.36-6.22 6.02-10.26 7.98-4.04 1.96-8.42 2.94-13.14 2.94-4.72 0-8.92-.64-12.84-1.92-3.92-1.28-7.32-3.24-10.2-5.88-2.88-2.64-5.12-5.98-6.72-10.02-1.6-4.04-2.4-8.82-2.4-14.34 0-4.96.66-9.42 1.98-13.38 1.32-3.96 3.22-7.32 5.7-10.08s5.44-4.9 8.88-6.42c3.44-1.52 7.32-2.28 11.64-2.28 5.76 0 10.52.88 14.28 2.64 3.76 1.76 6.72 4.16 8.88 7.2 2.16 3.04 3.66 6.54 4.5 10.5.84 3.96 1.26 8.18 1.26 12.66Zm-29.4-22.8c-2.16.16-4.16.72-6 1.68-1.84.96-3.42 2.2-4.74 3.72-1.32 1.52-2.36 3.28-3.12 5.28-.76 2-1.14 4.12-1.14 6.36h33.12c0-2-.22-4.06-.66-6.18-.44-2.12-1.3-4.02-2.58-5.7-1.28-1.68-3.1-3.02-5.46-4.02-2.36-1-5.5-1.38-9.42-1.14Z" style="fill-rule:nonzero" transform="translate(-452.406 -63.709) scale(1.00797)"/><path d="M79.32 36.98v150.76L95 174.54l6.59-156.31-22.27 18.75Z" style="fill:url(#a);fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="M79.32 36.98 57.05 18.23l6.59 156.31 15.68 13.2V36.98Z" style="fill:url(#b);fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="m25.19 104.83 8.63 49.04 12.5-14.95-2.46-56.42-18.67 22.33Z" style="fill:url(#c);fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="M25.19 104.83 0 90.24l16.97 53.86 16.85 9.77-8.63-49.04Z" style="fill:url(#d);fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="M43.86 82.5 18.69 67.98 0 90.24l25.18 14.59L43.86 82.5Z" style="fill:#9c3;fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="m134.82 78.69-9.97 56.5 15.58-9.04L160 64.1l-25.18 14.59Z" style="fill:url(#e);fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="m134.82 78.69-18.68-22.33-2.86 65 11.57 13.83 9.97-56.5Z" style="fill:url(#f);fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="m160 64.1-18.69-22.26-25.17 14.52 18.67 22.33L160 64.1Z" style="fill:#ffe113;fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="M101.59 18.23 79.32 0 57.05 18.23l22.27 18.75 22.27-18.75Z" style="fill:#f3e600;fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><defs><linearGradient id="a" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="matrix(.84 -162.96 162.96 .84 89.64 184.81)"><stop offset="0" style="stop-color:#62d399;stop-opacity:1"/><stop offset=".51" style="stop-color:#acd842;stop-opacity:1"/><stop offset=".9" style="stop-color:#d7db0a;stop-opacity:1"/><stop offset="1" style="stop-color:#d7db0a;stop-opacity:1"/></linearGradient><linearGradient id="b" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="rotate(-90.565 123.412 54.953) scale(162.14)"><stop offset="0" style="stop-color:#0ba398;stop-opacity:1"/><stop offset=".5" style="stop-color:#4ca352;stop-opacity:1"/><stop offset="1" style="stop-color:#76a30a;stop-opacity:1"/></linearGradient><linearGradient id="c" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="scale(-68) rotate(88.4 .881 -1.396)"><stop offset="0" style="stop-color:#36a382;stop-opacity:1"/><stop offset=".19" style="stop-color:#36a382;stop-opacity:1"/><stop offset=".54" style="stop-color:#49a459;stop-opacity:1"/><stop offset="1" style="stop-color:#76a30b;stop-opacity:1"/></linearGradient><linearGradient id="d" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="rotate(-88 87.255 68.431) scale(62.42)"><stop offset="0" style="stop-color:#267880;stop-opacity:1"/><stop offset=".51" style="stop-color:#457a5c;stop-opacity:1"/><stop offset="1" style="stop-color:#717516;stop-opacity:1"/></linearGradient><linearGradient id="e" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="rotate(-79.1 149.53 -14.065) scale(73.28)"><stop offset="0" style="stop-color:#b0d939;stop-opacity:1"/><stop offset="1" style="stop-color:#eadb04;stop-opacity:1"/></linearGradient><linearGradient id="f" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="rotate(-67.997 148.705 -15.558) scale(69.8226)"><stop offset="0" style="stop-color:#74af52;stop-opacity:1"/><stop offset=".17" style="stop-color:#74af52;stop-opacity:1"/><stop offset=".48" style="stop-color:#99be32;stop-opacity:1"/><stop offset="1" style="stop-color:#c0c40a;stop-opacity:1"/></linearGradient></defs></svg>',TP=btoa(RP),EP="data:image/svg+xml;charset=utf-8;base64,"+TP,AP=EP,IP=C("debugpatch");function Cd(n,t,i,s){const o=IP===t;if(!i&&!s)return;const r=t+"___needle";LP(n,t,i,s);const l=Object.getOwnPropertyDescriptor(n,t),c=n[t];o&&console.log("Patch",n.constructor.name,t,l,c),l?(o&&console.log("Apply patch with existing descriptor",n.constructor.name,t,l),typeof l.value=="function"&&(n[t]=lb(l.value,n,t))):(o&&console.log("Create patch with new property",n.constructor.name,t,l),Object.defineProperty(n,t,{set:function(h){if(typeof h=="function")this[r]=lb(h,n,t);else{const d=this[r];cb(n,t,this,d,h),this[r]=h,hb(n,t,this,d,h)}},get:function(){const h=this[r];return typeof h=="function"&&h[r]?h[r]:h}}))}function jP(n,t,i){const s=Km(n,t);if(s)for(let o=s.length-1;o>=0;o--){const r=s[o];r.prefix===i&&(r.prefix=null),r.postfix===i&&(r.postfix=null),!r.prefix&&!r.postfix&&s.splice(o,1)}}const ab=Symbol("Needle:Patches:WrappedFunction");function lb(n,t,i){if(n[ab])return n;const s=function(...o){cb(t,i,this,...o);const r=n.apply(this,o);return hb(t,i,this,r,...o),r};return s[ab]=!0,s}const Od="Needle:Patches";function Zm(){return globalThis[Od]||(globalThis[Od]=new WeakMap),globalThis[Od]}function Km(n,t){const i=Zm().get(n);return i?i.get(t):null}function LP(n,t,i,s){let o=Zm().get(n);o||(o=new Map,Zm().set(n,o));let r=o.get(t);r||(r=[],o.set(t,r)),r.push({prefix:i,postfix:s})}function cb(n,t,i,...s){var o;if(!i)return;const r=Km(n,t);if(r)for(const l of r)(o=l.prefix)==null||o.call(i,...s)}function hb(n,t,i,s,...o){var r;if(!i)return;const l=Km(n,t);if(l)for(const c of l)(r=c.postfix)==null||r.call(i,s,...o)}const Sa=[];function Pd(n){Sa.indexOf(n)===-1&&Sa.push(n)}function DP(n){const t=Sa.indexOf(n);t!==-1&&Sa.splice(t,1)}const Ca=[];function Jm(n){Ca.indexOf(n)===-1&&Ca.push(n)}function BP(n){const t=Ca.indexOf(n);t!==-1&&Ca.splice(t,1)}function db(n){globalThis.dispatchEvent(new CustomEvent("needle-xrsession-start",{detail:n}));for(let t=0;t<Sa.length;t++)Sa[t](n)}function ub(n){globalThis.dispatchEvent(new CustomEvent("needle-xrsession-end",{detail:n}));for(let t=0;t<Ca.length;t++)Ca[t](n)}const ut=C("debuginput");var kd=(n=>(n.Mouse="mouse",n.Touch="touch",n.Controller="controller",n.Hand="hand",n))(kd||{}),Be=(n=>(n.PointerDown="pointerdown",n.PointerUp="pointerup",n.PointerMove="pointermove",n.KeyDown="keydown",n.KeyUp="keyup",n.KeyPressed="keypress",n))(Be||{});class ws extends PointerEvent{constructor(t,i,s){super(t,s),a(this,"clientZ"),a(this,"deviceIndex"),a(this,"origin"),a(this,"source"),a(this,"mode"),a(this,"_ray"),a(this,"space"),a(this,"isClick",!1),a(this,"isDoubleClick",!1),a(this,"_used",!1),a(this,"_pointerid"),a(this,"_pointerType"),a(this,"_type"),a(this,"metadata",{}),a(this,"intersections",new Array),a(this,"_immediatePropagationStopped",!1),a(this,"_propagationStopped",!1),this.clientZ=s.clientZ,this._pointerid=s.pointerId,this._pointerType=s.pointerType,this._type=t,this.deviceIndex=s.deviceIndex,this.origin=s.origin,this.source=i,this.mode=s.mode,this._ray=s.ray,this.space=s.device}get isSpatial(){return this.mode!="screen"}get ray(){return this._ray||(this._ray=new no(this.space.worldPosition.clone(),this.space.worldForward.clone())),this._ray}set ray(t){this._ray=t}get hasRay(){return this._ray!==void 0}get used(){return this._used}use(){this._used=!0}get pointerId(){return this._pointerid}get pointerType(){return this._pointerType}get type(){return this._type}get immediatePropagationStopped(){return this._immediatePropagationStopped}get propagationStopped(){return this._immediatePropagationStopped||this._propagationStopped}stopImmediatePropagation(){var t;this._immediatePropagationStopped=!0,super.stopImmediatePropagation(),(t=this.source)==null||t.stopImmediatePropagation()}stopPropagation(){var t;this._propagationStopped=!0,super.stopPropagation(),(t=this.source)==null||t.stopPropagation(),ut&&console.warn("Stop propagation...",this.pointerId,this.pointerType)}}class dc extends KeyboardEvent{constructor(t,i,s){super(t,s),a(this,"source"),this.source=i}stopImmediatePropagation(){var t;super.stopImmediatePropagation(),(t=this.source)==null||t.stopImmediatePropagation()}}class FP{constructor(t){a(this,"key"),a(this,"keyType"),a(this,"source"),this.key=t.key,this.keyType=t.type,this.source=t}}var ai=(n=>(n[n.Early=-100]="Early",n[n.Default=0]="Default",n[n.Late=100]="Late",n))(ai||{});class pb{constructor(t){a(this,"_eventListeners",{}),a(this,"_doubleClickTimeThreshold",.2),a(this,"_longPressTimeThreshold",1),a(this,"_setCursorTypes",[]),a(this,"context"),a(this,"_pointerDown",[!1]),a(this,"_pointerUp",[!1]),a(this,"_pointerClick",[!1]),a(this,"_pointerDoubleClick",[!1]),a(this,"_pointerPressed",[!1]),a(this,"_pointerPositions",[new re]),a(this,"_pointerPositionsLastFrame",[new re]),a(this,"_pointerPositionsDelta",[new re]),a(this,"_pointerPositionsRC",[new re]),a(this,"_pointerPositionDown",[new x]),a(this,"_pointerDownTime",[]),a(this,"_pointerUpTime",[]),a(this,"_pointerUpTimestamp",[]),a(this,"_pointerIds",[]),a(this,"_pointerTypes",[""]),a(this,"_mouseWheelChanged",[!1]),a(this,"_mouseWheelDeltaY",[0]),a(this,"_pointerEvent",[]),a(this,"_pointerEventsPressed",[]),a(this,"_pointerSpace",[]),a(this,"_pressedStack",new Map),a(this,"_htmlEventSource"),a(this,"onLostFocus",()=>{for(const i in this.keysPressed)this.keysPressed[i].pressed=!1}),a(this,"_receivedPointerMoveEventsThisFrame",new Array),a(this,"onEndOfFrame",()=>{this._receivedPointerMoveEventsThisFrame.length=0;for(let i=0;i<this._pointerUp.length;i++)this._pointerUp[i]=!1;for(let i=0;i<this._pointerDown.length;i++)this._pointerDown[i]=!1;for(let i=0;i<this._pointerClick.length;i++)this._pointerClick[i]=!1;for(let i=0;i<this._pointerDoubleClick.length;i++)this._pointerDoubleClick[i]=!1;for(const i of this._pointerPositionsDelta)i.set(0,0);for(let i=0;i<this._mouseWheelChanged.length;i++)this._mouseWheelChanged[i]=!1;for(let i=0;i<this._mouseWheelDeltaY.length;i++)this._mouseWheelDeltaY[i]=0}),a(this,"onContextMenu",i=>{this.canReceiveInput(i)!==!1&&i instanceof PointerEvent&&i.pointerType}),a(this,"keysPressed",{}),a(this,"onKeyDown",i=>{if(ut&&console.log(`key down ${i.code}, ${this.context.application.hasFocus}`,i),!this.context.application.hasFocus)return;const s=this.keysPressed[i.code];if(s&&s.pressed)return;this.keysPressed[i.code]={pressed:!0,frame:this.context.time.frameCount+1,startFrame:this.context.time.frameCount+1,key:i.key,code:i.code};const o=new dc("keydown",i,i);this.onDispatchEvent(o)}),a(this,"onKeyPressed",i=>{if(!this.context.application.hasFocus)return;const s=this.keysPressed[i.code];if(!s)return;s.pressed=!0,s.frame=this.context.time.frameCount+1;const o=new dc("keypress",i,i);this.onDispatchEvent(o)}),a(this,"onKeyUp",i=>{if(!this.context.application.hasFocus)return;const s=this.keysPressed[i.code];if(!s)return;s.pressed=!1,s.frame=this.context.time.frameCount+1;const o=new dc("keyup",i,i);this.onDispatchEvent(o)}),a(this,"onWheelWindow",i=>{document.pointerLockElement&&this.onMouseWheel(i)}),a(this,"onMouseWheel",i=>{if(this.canReceiveInput(i)===!1)return;this._mouseWheelDeltaY.length<=0&&this._mouseWheelDeltaY.push(0),this._mouseWheelChanged.length<=0&&this._mouseWheelChanged.push(!1),this._mouseWheelChanged[0]=!0;const s=this._mouseWheelDeltaY[0];this._mouseWheelDeltaY[0]=s+i.deltaY}),a(this,"onPointerDown",i=>{if(this.context.isInAR||this.canReceiveInput(i)===!1)return;i.target instanceof HTMLElement&&i.target.setPointerCapture(i.pointerId);const s=this.getPointerId(i);ut&&De(`pointer down #${s}, identifier:${i.pointerId}`);const o=this.getAndUpdateSpatialObjectForScreenPosition(s,i.clientX,i.clientY),r=new ws("pointerdown",i,{origin:this,mode:"screen",deviceIndex:0,pointerId:s,button:i.button,clientX:i.clientX,clientY:i.clientY,pointerType:i.pointerType,buttonName:this.getButtonName(i),device:o,pressure:i.pressure});this.onDown(r)}),a(this,"onPointerMove",i=>{if(this.context.isInAR||this._receivedPointerMoveEventsThisFrame.includes(i.pointerId))return;this._receivedPointerMoveEventsThisFrame.push(i.pointerId);let s=i.button;i.pointerType==="mouse"&&(s=this.getFirstPressedButtonForPointer(0)??0);const o=this.getPointerId(i,s);s===-1&&(s=o);const r=this.getAndUpdateSpatialObjectForScreenPosition(o,i.clientX,i.clientY),l=new ws("pointermove",i,{origin:this,mode:"screen",deviceIndex:0,pointerId:o,button:s,clientX:i.clientX,clientY:i.clientY,pointerType:i.pointerType,buttonName:this.getButtonName(i),device:r,pressure:i.pressure});this.onMove(l)}),a(this,"onPointerCancel",i=>{this.context.isInAR||(ut&&console.log("Pointer cancel",i),this.onPointerUp(i))}),a(this,"onPointerUp",i=>{if(this.context.isInAR)return;i.target instanceof HTMLElement&&i.target.releasePointerCapture(i.pointerId);const s=this.getPointerId(i),o=new ws("pointerup",i,{origin:this,mode:"screen",deviceIndex:0,pointerId:s,button:i.button,clientX:i.clientX,clientY:i.clientY,pointerType:i.pointerType,buttonName:this.getButtonName(i),device:this.getAndUpdateSpatialObjectForScreenPosition(s,i.clientX,i.clientY),pressure:i.pressure});this.onUp(o),this._pointerIds[s]=-1,ut&&console.log("ID="+s,"PointerId="+i.pointerId,"ALL:",[...this._pointerIds])}),a(this,"onTouchStart",i=>{if(this.context.isInAR)for(let s=0;s<i.changedTouches.length;s++){const o=i.changedTouches[s],r=this.getPointerIndex(o.identifier),l=this.getAndUpdateSpatialObjectForScreenPosition(r,o.clientX,o.clientY),c=new ws("pointerdown",i,{origin:this,mode:"screen",deviceIndex:0,pointerId:r,button:0,clientX:o.clientX,clientY:o.clientY,pointerType:"touch",buttonName:"unknown",device:l,pressure:o.force});this.onDown(c)}}),a(this,"onTouchMove",i=>{if(this.context.isInAR)for(let s=0;s<i.changedTouches.length;s++){const o=i.changedTouches[s],r=this.getPointerIndex(o.identifier),l=this.getAndUpdateSpatialObjectForScreenPosition(r,o.clientX,o.clientY),c=new ws("pointermove",i,{origin:this,mode:"screen",deviceIndex:0,pointerId:r,button:0,clientX:o.clientX,clientY:o.clientY,pointerType:"touch",buttonName:"unknown",device:l,pressure:o.force});this.onMove(c)}}),a(this,"onTouchEnd",i=>{if(this.context.isInAR)for(let s=0;s<i.changedTouches.length;s++){const o=i.changedTouches[s],r=this.getPointerIndex(o.identifier),l=new ws("pointerup",i,{origin:this,mode:"screen",deviceIndex:0,pointerId:r,button:0,clientX:o.clientX,clientY:o.clientY,pointerType:"touch",buttonName:"unknown",device:this.getAndUpdateSpatialObjectForScreenPosition(r,o.clientX,o.clientY),pressure:o.force});this.onUp(l),this._pointerIds[r]=-1}}),a(this,"tempNearPlaneVector",new x),a(this,"tempFarPlaneVector",new x),a(this,"tempLookMatrix",new se),this.context=t,this.context.post_render_callbacks.push(this.onEndOfFrame)}addEventListener(t,i,s){if(this._eventListeners[t]||(this._eventListeners[t]=[]),!i||typeof i!="function"){console.error("Invalid call to addEventListener: callback is required and must be a function!");return}s?s={...s}:s={};let o=0;s?.queue!=null&&(o=s.queue);const r=this._eventListeners[t],l=r.find(c=>c.priority===o);l?l.listeners.push({callback:i,options:s}):(r.push({priority:o,listeners:[{callback:i,options:s}]}),r.sort((c,h)=>c.priority-h.priority))}removeEventListener(t,i,s){if(!this._eventListeners[t]||!i)return;const o=this._eventListeners[t];if(s?.queue!=null){const r=o.find(c=>c.priority===s.queue);if(!r)return;const l=r.listeners.findIndex(c=>c.callback===i);l>=0&&r.listeners.splice(l,1)}else for(const r of o){const l=r.listeners.findIndex(c=>c.callback===i);l>=0&&r.listeners.splice(l,1)}}dispatchEvent(t){var i,s,o,r;let l=!1;if(t instanceof dc){const c=this._eventListeners[t.type];if(c)for(const h of c)for(let d=0;d<h.listeners.length;d++){const u=h.listeners[d];if((s=(i=u.options)==null?void 0:i.signal)!=null&&s.aborted){h.listeners.splice(d,1),d--;continue}u.options.once&&(h.listeners.splice(d,1),d--),u.callback(t)}}if(t instanceof ws){const c=this._eventListeners[t.type];if(c)for(const h of c){if(l)break;for(let d=0;d<h.listeners.length;d++){const u=h.listeners[d];if((r=(o=u.options)==null?void 0:o.signal)!=null&&r.aborted){h.listeners.splice(d,1),d--;continue}if(t.immediatePropagationStopped){l=!0,ut&&console.log("immediatePropagationStopped",t.type);break}else t.propagationStopped&&(l=!0,ut&&console.log("propagationStopped",t.type));u.options.once&&(h.listeners.splice(d,1),d--),u.callback(t)}}}}get mousePosition(){return this._pointerPositions[0]}get mousePositionRC(){return this._pointerPositionsRC[0]}get mouseDown(){return this._pointerDown[0]}get mouseUp(){return this._pointerUp[0]}get mouseClick(){return this._pointerClick[0]}get mouseDoubleClick(){return this._pointerDoubleClick[0]}get mousePressed(){return this._pointerPressed[0]}get mouseWheelChanged(){return this.getMouseWheelChanged(0)}get click(){return this._pointerClick[0]}get doubleClick(){return this._pointerDoubleClick[0]}getGamepad(t=0){return typeof navigator<"u"&&"getGamepads"in navigator&&navigator.getGamepads()[t]||null}setCursorPointer(){this.setCursor("pointer")}setCursorNormal(){this.unsetCursor("pointer")}setCursor(t){this._setCursorTypes.push(t),this._setCursorTypes.length>10&&this._setCursorTypes.shift(),this.updateCursor()}unsetCursor(t){for(let i=this._setCursorTypes.length-1;i>=0;i--)if(this._setCursorTypes[i]===t){this._setCursorTypes.splice(i,1),this.updateCursor();break}}updateCursor(){var t;((t=this._setCursorTypes)==null?void 0:t.length)==0?this.context.domElement.style.cursor="default":this.context.domElement.style.cursor=this._setCursorTypes[this._setCursorTypes.length-1]}getIsPointerIdInUse(t){for(const i of this._pointerEventsPressed)if(i.pointerId===t&&i.used)return!0;return!1}getPointerPressedCount(){let t=0;for(let i=0;i<this._pointerPressed.length;i++)this._pointerPressed[i]&&t++;return t}getPointerPosition(t){return t>=this._pointerPositions.length?null:this._pointerPositions[t]}getPointerPositionLastFrame(t){return t>=this._pointerPositionsLastFrame.length?null:this._pointerPositionsLastFrame[t]}getPointerPositionDelta(t){return t>=this._pointerPositionsDelta.length?null:this._pointerPositionsDelta[t]}getPointerPositionRC(t){return t>=this._pointerPositionsRC.length?null:this._pointerPositionsRC[t]}getPointerDown(t){return t>=this._pointerDown.length?!1:this._pointerDown[t]}getPointerUp(t){return t>=this._pointerUp.length?!1:this._pointerUp[t]}getPointerPressed(t){return t>=this._pointerPressed.length?!1:this._pointerPressed[t]}getPointerClicked(t){return t>=this._pointerClick.length?!1:this._pointerClick[t]}getPointerDoubleClicked(t){return t>=this._pointerDoubleClick.length?!1:this._pointerDoubleClick[t]}getPointerDownTime(t){return t>=this._pointerDownTime.length?-1:this._pointerDownTime[t]}getPointerUpTime(t){return t>=this._pointerUpTime.length?-1:this._pointerUpTime[t]}getPointerLongPress(t){return t>=this._pointerDownTime.length?!1:this.getPointerPressed(t)&&this.context.time.time-this._pointerDownTime[t]>this._longPressTimeThreshold}getIsMouse(t){return t<0||t>=this._pointerTypes.length?!1:this._pointerTypes[t]==="mouse"}getIsTouch(t){return t<0||t>=this._pointerTypes.length?!1:this._pointerTypes[t]==="touch"}getTouchesPressedCount(){let t=0;for(let i=0;i<this._pointerPressed.length;i++)this._pointerPressed[i]&&this.getIsTouch(i)&&t++;return t}getMouseWheelChanged(t=0){return t>=this._mouseWheelChanged.length?!1:this._mouseWheelChanged[t]}getMouseWheelDeltaY(t=0){return t>=this._mouseWheelDeltaY.length?0:this._mouseWheelDeltaY[t]}getPointerEvent(t){if(!(t>=this._pointerEvent.length))return this._pointerEvent[t]??void 0}*foreachPointerId(t){for(let i=0;i<this._pointerTypes.length;i++)if(this._pointerIsActive(i)){if(t!==void 0){const s=this._pointerTypes[i];if(Array.isArray(t)){let o=!1;for(const r of t)if(s===r){o=!0;break}if(!o)continue}else if(t!==s)continue}yield i}}*foreachTouchId(){for(let t=0;t<this._pointerTypes.length;t++)this._pointerTypes[t]==="touch"&&this._pointerIsActive[t]&&(yield t)}_pointerIsActive(t){return t<0?!1:this._pointerPressed[t]||this._pointerDown[t]||this._pointerUp[t]}onDownButton(t,i){let s=this._pressedStack.get(t);s||(s=[],this._pressedStack.set(t,s)),s.push(i)}onReleaseButton(t,i){const s=this._pressedStack.get(t);if(!s)return;const o=s.indexOf(i);o>=0&&s.splice(o,1)}getFirstPressedButtonForPointer(t){const i=this._pressedStack.get(t);if(i)return i[0]}getLatestPressedButtonForPointer(t){const i=this._pressedStack.get(t);if(i)return i[i.length-1]}getKeyDown(){for(const t in this.keysPressed){const i=this.keysPressed[t];if(i.startFrame===this.context.time.frameCount)return i.key}return null}getKeyPressed(){for(const t in this.keysPressed){const i=this.keysPressed[t];if(i.pressed)return i.key}return null}isKeyDown(t){var i;if(!this.context.application.isVisible||!this.context.application.hasFocus)return!1;const s=this.getCodeForCommonKeyName(t);if(s!==null){for(const o of s)if(this.isKeyDown(o))return!0;return!1}return((i=this.keysPressed[t])==null?void 0:i.startFrame)===this.context.time.frameCount&&this.keysPressed[t].pressed}isKeyUp(t){var i;if(!this.context.application.isVisible||!this.context.application.hasFocus)return!1;const s=this.getCodeForCommonKeyName(t);if(s!==null){for(const o of s)if(this.isKeyUp(o))return!0;return!1}return((i=this.keysPressed[t])==null?void 0:i.frame)===this.context.time.frameCount&&!this.keysPressed[t].pressed}isKeyPressed(t){var i;if(!this.context.application.isVisible||!this.context.application.hasFocus)return!1;const s=this.getCodeForCommonKeyName(t);if(s!==null){for(const o of s)if(this.isKeyPressed(o))return!0;return!1}return(i=this.keysPressed[t])==null?void 0:i.pressed}getCodeForCommonKeyName(t){if(t.length===1){if(t>="0"&&t<="9")return["Digit"+t];if(t>="a"&&t<="z")return["Key"+t.toUpperCase()];if(t==" ")return["Space"]}switch(t){case"shift":case"Shift":return["ShiftLeft","ShiftRight"];case"control":case"Control":return["ControlLeft","ControlRight"];case"alt":case"Alt":return["AltLeft","AltRight"]}return null}createInputEvent(t){switch(t.type){case"pointerdown":ut&&De("Create Pointer down"),this.onDownButton(t.deviceIndex,t.button),this.onDown(t);break;case"pointermove":ut&&De("Create Pointer move"),this.onMove(t);break;case"pointerup":ut&&De("Create Pointer up"),this.onUp(t),this.onReleaseButton(t.deviceIndex,t.button);break}}convertScreenspaceToRaycastSpace(t){return t.x=(t.x-this.context.domX)/this.context.domWidth*2-1,t.y=-((t.y-this.context.domY)/this.context.domHeight)*2+1,t}bindEvents(){this.unbindEvents(),this._htmlEventSource=this.context.renderer.domElement,window.addEventListener("contextmenu",this.onContextMenu),this._htmlEventSource.addEventListener("pointerdown",this.onPointerDown,{passive:!0}),window.addEventListener("pointermove",this.onPointerMove,{passive:!0,capture:!0}),window.addEventListener("pointerup",this.onPointerUp,{passive:!0}),window.addEventListener("pointercancel",this.onPointerCancel,{passive:!0}),window.addEventListener("touchstart",this.onTouchStart,{passive:!0}),window.addEventListener("touchmove",this.onTouchMove,{passive:!0}),window.addEventListener("touchend",this.onTouchEnd,{passive:!0}),this._htmlEventSource.addEventListener("wheel",this.onMouseWheel,{passive:!0}),window.addEventListener("wheel",this.onWheelWindow,{passive:!0}),window.addEventListener("keydown",this.onKeyDown,!1),window.addEventListener("keypress",this.onKeyPressed,!1),window.addEventListener("keyup",this.onKeyUp,!1),window.addEventListener("blur",this.onLostFocus)}unbindEvents(){var t,i;window.removeEventListener("contextmenu",this.onContextMenu),(t=this._htmlEventSource)==null||t.removeEventListener("pointerdown",this.onPointerDown),window.removeEventListener("pointermove",this.onPointerMove),window.removeEventListener("pointerup",this.onPointerUp),window.removeEventListener("pointercancel",this.onPointerCancel),window.removeEventListener("touchstart",this.onTouchStart),window.removeEventListener("touchmove",this.onTouchMove),window.removeEventListener("touchend",this.onTouchEnd),(i=this._htmlEventSource)==null||i.removeEventListener("wheel",this.onMouseWheel,!1),window.removeEventListener("wheel",this.onWheelWindow,!1),window.removeEventListener("keydown",this.onKeyDown,!1),window.removeEventListener("keypress",this.onKeyPressed,!1),window.removeEventListener("keyup",this.onKeyUp,!1),window.removeEventListener("blur",this.onLostFocus)}dispose(){const t=this.context.post_render_callbacks.indexOf(this.onEndOfFrame);t>=0&&this.context.post_render_callbacks.splice(t,1),this.unbindEvents()}canReceiveInput(t){var i;return t.target===((i=this.context.renderer)==null?void 0:i.domElement)||t.target===this.context.domElement||this.context.isInAR||this.context.isInAR&&t.target===document.body&&Q.isMozillaXR()?!0:(ut&&console.warn("CanReceiveInput:False for",t.target),!1)}getPointerId(t,i){return t.pointerType==="mouse"?0+(i??t.button):this.getPointerIndex(t.pointerId)}getButtonName(t){const i=t.button;if(t.pointerType==="mouse")switch(i){case 0:return"left";case 1:return"middle";case 2:return"right"}return"unknown"}getAndUpdateSpatialObjectForScreenPosition(t,i,s){let o=this._pointerSpace[t];o||(o=new j,this._pointerSpace[t]=o),this._pointerSpace[t]=o;const r=this.context.mainCamera;if(r){const l=this.tempNearPlaneVector.set(i,s,-1);this.convertScreenspaceToRaycastSpace(l);const c=this.tempFarPlaneVector.set(l.x,l.y,1);l.unproject(r),c.unproject(r);const h=r.worldUp||q(0,1,0).applyQuaternion(Ce(r));this.tempLookMatrix.lookAt(c,l,h),o.position.set(l.x,l.y,l.z),o.quaternion.setFromRotationMatrix(this.tempLookMatrix)}return o}isInRect(t){if(this.context.isInXR)return!0;const i=this.context.domElement.getBoundingClientRect(),s=t.clientX,o=t.clientY,r=s>=i.x&&s<=i.right&&o>=i.y&&o<=i.bottom;return ut&&!r&&console.log("Not in rect",i,s,o),r}onDown(t){const i=t.pointerId;if(this.getPointerPressed(i)&&console.warn(`Received pointerDown for pointerId that is already pressed: ${i}`,ut?t:""),ut&&console.log(t.pointerType,"DOWN",i),!!this.isInRect(t)){for(this.setPointerState(i,this._pointerPressed,!0),this.setPointerState(i,this._pointerDown,!0),this.setPointerStateT(i,this._pointerEvent,t.source);i>=this._pointerTypes.length;)this._pointerTypes.push(t.pointerType);for(this._pointerTypes[i]=t.pointerType;i>=this._pointerPositionDown.length;)this._pointerPositionDown.push(new x);for(this._pointerPositionDown[i].set(t.clientX,t.clientY,t.clientZ??0);i>=this._pointerPositions.length;)this._pointerPositions.push(new re);this._pointerPositions[i].set(t.clientX,t.clientY),i>=this._pointerDownTime.length&&this._pointerDownTime.push(0),this._pointerDownTime[i]=this.context.time.realtimeSinceStartup,this.updatePointerPosition(t),this._pointerEventsPressed.push(t),this.onDispatchEvent(t)}}onMove(t){const i=t.pointerId,s=this.getPointerPressed(i);s===!1&&!this.isInRect(t)||t.pointerType==="touch"&&!s||(this.updatePointerPosition(t),this.setPointerStateT(i,this._pointerEvent,t.source),this.onDispatchEvent(t))}onUp(t){const i=t.pointerId;if(!this.getPointerPressed(i)){ut&&console.log(t.pointerType,"UP",i,"was not down");return}ut&&console.log(t.pointerType,"UP",i),this.setPointerState(i,this._pointerPressed,!1),this.setPointerStateT(i,this._pointerEvent,t.source),this.setPointerState(i,this._pointerUp,!0),this.updatePointerPosition(t);for(let c=this._pointerEventsPressed.length-1;c>=0;c--)if(this._pointerEventsPressed[c].pointerId===i){this._pointerEventsPressed.splice(c,1);break}if(!this._pointerPositionDown[i]){ut&&we("Received pointer up event without matching down event for button: "+i),console.warn("Received pointer up event without matching down event for button: "+i);return}const s=this._pointerUpTime[i],o=this._pointerDownTime[i],r=this.context.time.realtimeSinceStartup,l=r-o;if(i>=this._pointerUpTime.length&&this._pointerUpTime.push(-99),this._pointerUpTime[i]=r,l<1){let c=t.clientX-this._pointerPositionDown[i].x,h=t.clientY-this._pointerPositionDown[i].y,d=0;if(t.isSpatial&&t.clientZ!=null&&(d=t.clientZ-this._pointerPositionDown[i].z,c*=200,h*=200,d*=200),Math.abs(c)<5&&Math.abs(h)<5&&Math.abs(d)<5){this.setPointerState(i,this._pointerClick,!0),t.isClick=!0;const u=r-s;ut&&console.log("CLICK",i,c,h,d,u),u<this._doubleClickTimeThreshold&&u>0&&(this.setPointerState(i,this._pointerDoubleClick,!0),t.isDoubleClick=!0)}}this.onDispatchEvent(t)}updatePointerPosition(t){const i=t.pointerId;for(;i>=this._pointerPositions.length;)this._pointerPositions.push(new re);for(;i>=this._pointerPositionsLastFrame.length;)this._pointerPositionsLastFrame.push(new re);for(;i>=this._pointerPositionsDelta.length;)this._pointerPositionsDelta.push(new re);const s=this._pointerPositionsLastFrame[i];s.copy(this._pointerPositions[i]);const o=this._pointerPositionsDelta[i];let r=t.clientX-s.x,l=t.clientY-s.y;if(t.source instanceof MouseEvent||t.source instanceof TouchEvent){const u=t.source;r===0&&u.movementX!==0&&(r=u.movementX||0),l===0&&u.movementY!==0&&(l=u.movementY||0)}o.x+=r,o.y+=l,this._pointerPositions[i].x=t.clientX,this._pointerPositions[i].y=t.clientY;const c=t.clientX,h=t.clientY;for(;i>=this._pointerPositionsRC.length;)this._pointerPositionsRC.push(new re);const d=this._pointerPositionsRC[i];d.set(c,h),this.convertScreenspaceToRaycastSpace(d)}getPointerIndex(t){let i=-1;for(let s=0;s<this._pointerIds.length;s++){if(this._pointerIds[s]===t)return s;i===-1&&this._pointerIds[s]===-1&&(i=s)}return i!==-1?(this._pointerIds[i]=t,i):(ut&&console.log("PUSH pointerId:",t),this._pointerIds.push(t),this._pointerIds.length-1)}setPointerState(t,i,s){i[t]=s}setPointerStateT(t,i,s){return i[t]=s,s}onDispatchEvent(t){const i=ee.Current;try{ee.Current=this.context,this.dispatchEvent(t)}finally{ee.Current=i}}}const Oa=new se().makeRotationY(Math.PI),Gi=new V().setFromAxisAngle(new x(0,1,0),Math.PI),zP=C("debugwebxr");class UP{constructor(){if(a(this,"priority",-1e5),a(this,"gameObject"),this.gameObject=new j,this.gameObject.name="Implicit XR Rig",zP){const t=gg(16733661);t.position.y+=.5,this.gameObject.add(t)}}isXRRig(){return!0}get isActive(){return this.gameObject.visible}}const xs=C("debugwebxr"),Md=C("debugcustomgesture"),NP="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles",WP="generic-trigger",VP=new V().setFromEuler(new Bt(ms.degToRad(0),ms.degToRad(-90),ms.degToRad(-90))),HP=new x(.04,-.04,0);class eg{constructor(t,i,s){a(this,"xr"),a(this,"inputSource"),a(this,"index",0),a(this,"emitEvents",!0),a(this,"_connected",!0),a(this,"_isTracking",!1),a(this,"__gamepad"),a(this,"__hand"),a(this,"__side"),a(this,"_hitTestSource"),a(this,"_hasSelectEvent",!1),a(this,"_isMxInk",!1),a(this,"_isMetaQuestTouchController",!1),a(this,"_handJointPoses",new Map),a(this,"_gripMatrix",new se),a(this,"_gripPosition",new x),a(this,"_gripQuaternion",new V),a(this,"_linearVelocity",new x),a(this,"_rayPositionRaw",new x),a(this,"_rayRotationRaw",new V),a(this,"_rayMatrix",new se),a(this,"_rayPosition",new x),a(this,"_rayQuaternion",new V),a(this,"_gripWorldPosition",new x),a(this,"_gripWorldQuaternion",new V),a(this,"_rayWorldPosition",new x),a(this,"_rayWorldQuaternion",new V),a(this,"_pinchPosition",new x),a(this,"_ray"),a(this,"_hand_wristDotUp"),a(this,"_object"),a(this,"_gripSpaceObject"),a(this,"_raySpaceObject"),a(this,"model",null),a(this,"_debugAxesHelper",new Si(.15)),a(this,"_debugGripAxesHelper",new Si(.07)),a(this,"_debugRayAxesHelper",new Si(.07)),a(this,"_hitTestSourcePromise",null),a(this,"onPointerHits",o=>{}),a(this,"_needleGamepadButtons",{}),a(this,"_buttonMap",new Map),a(this,"_motioncontroller"),a(this,"_layout"),a(this,"getMotionController"),a(this,"emitPointerDownEvent",!0),a(this,"emitPointerUpEvent",!0),a(this,"emitPointerMoveEvent",!0),a(this,"pointerMoveDistanceThreshold",.03),a(this,"pointerMoveAngleThreshold",.05),a(this,"_selectButtonIndex"),a(this,"_squeezeButtonIndex"),a(this,"onSelectStart",o=>{var r,l,c,h;if(!this.emitPointerDownEvent||this.inputSource!==o.inputSource)return;this.onUpdateFrame(o.frame),this._hasSelectEvent=!0;const d=(r=this._layout)==null?void 0:r.selectComponentId,u=(h=(c=(l=this._layout)==null?void 0:l.components[d])==null?void 0:c.gamepadIndices)==null?void 0:h.button;u!==void 0&&(this._selectButtonIndex=u),!Md&&(xs&&G.DrawDirection(this.rayWorldPosition,q(0,.01,1).applyQuaternion(this.rayWorldQuaternion),16711680,10),this.emitPointerEvent(Be.PointerDown,this._selectButtonIndex||0,"xr-standard-trigger",!0,o))}),a(this,"onSelectEnd",o=>{this.emitPointerUpEvent&&(Md||this.inputSource===o.inputSource&&this.emitPointerEvent(Be.PointerUp,this._selectButtonIndex||0,"xr-standard-trigger",!0,o))}),a(this,"onSequeezeStart",o=>{var r,l,c;this.emitPointerDownEvent&&this.inputSource===o.inputSource&&(this._squeezeButtonIndex=(c=(l=(r=this._layout)==null?void 0:r.components["xr-standard-squeeze"])==null?void 0:l.gamepadIndices)==null?void 0:c.button,this._squeezeButtonIndex!==void 0&&(xs&&G.DrawDirection(this.rayWorldPosition,q(0,.01,1).applyQuaternion(this.rayWorldQuaternion),255,10),this.emitPointerEvent(Be.PointerDown,this._squeezeButtonIndex||0,"xr-standard-squeeze",!0,o)))}),a(this,"onSequeezeEnd",o=>{this.emitPointerUpEvent&&this.inputSource===o.inputSource&&this._squeezeButtonIndex!==void 0&&this.emitPointerEvent(Be.PointerUp,this._squeezeButtonIndex||0,"xr-standard-squeeze",!0,o)}),a(this,"states",{}),a(this,"_didMoveLastFrame",!1),a(this,"_lastPointerMovePosition",new x),a(this,"_lastPointerMoveQuaternion",new V),a(this,"pointerInit"),this.xr=t,this.inputSource=i,this.index=s,this._object=new j,this._object.name=`NeedleXRController_${s}`,xs&&(this._object.add(this._debugAxesHelper),this._gripSpaceObject=new j,this._raySpaceObject=new j,this._gripSpaceObject.name=`NeedleXRController_${s}_gripSpace`,this._raySpaceObject.name=`NeedleXRController_${s}_raySpace`,this._gripSpaceObject.add(this._debugGripAxesHelper),this._raySpaceObject.add(this._debugRayAxesHelper),this.xr.context.scene.add(this._gripSpaceObject),this.xr.context.scene.add(this._raySpaceObject)),this.xr.context.scene.add(this._object),this._ray=new no,this.pointerInit={origin:this,pointerType:this.hand?"hand":"controller",deviceIndex:this.index,pointerId:-1,mode:this.inputSource.targetRayMode,ray:this._ray,device:this._object,buttonName:"none"},this.initialize(),this.subscribeEvents()}get context(){return this.xr.context}get connected(){return this._connected}get isTracking(){return this._isTracking}get gamepad(){return this.__gamepad??(this.__gamepad=this.inputSource.gamepad)}get isHand(){return this.hand!=null}get hand(){return this.__hand??(this.__hand=this.inputSource.hand)}get handObject(){return this.context.renderer.xr.getHand(this.index)}get profiles(){return this.inputSource.profiles}get layout(){return this._layout}get targetRayMode(){return this.inputSource.targetRayMode}get targetRaySpace(){return this.inputSource.targetRaySpace}get gripSpace(){return this.inputSource.gripSpace}get side(){return this.__side??(this.__side=this.inputSource.handedness)}get isRight(){return this.side==="right"}get isLeft(){return this.side==="left"}get isStylus(){return this._isMxInk}getHitTestSource(){return this._hitTestSource||this._requestHitTestSource(),this._hitTestSource}get hasHitTestSource(){return this._hitTestSource}cancelHitTestSource(){this._hitTestSource&&(this._hitTestSource.cancel(),this._hitTestSource=void 0)}get hasSelectEvent(){return this._hasSelectEvent}getHitTest(){return this.xr.getHitTest(this)}getHandJointPose(t,i){var s;if(i=i||this.xr.frame,!this.hand||!(i!=null&&i.getJointPose)||!this.xr.referenceSpace)return null;let o=(s=this._handJointPoses)==null?void 0:s.get(t);return o||(o=i.getJointPose(t,this.xr.referenceSpace),o&&this._handJointPoses.set(t,o),o)}get gripPosition(){return q(this._gripPosition)}get gripQuaternion(){return vn(this._gripQuaternion)}get gripMatrix(){return this._gripMatrix}get gripLinearVelocity(){return q(this._linearVelocity).applyQuaternion(Gi)}get rayPosition(){return q(this._rayPosition)}get rayQuaternion(){return vn(this._rayQuaternion)}get gripWorldPosition(){return q(this._gripWorldPosition)}get gripWorldQuaternion(){return vn(this._gripWorldQuaternion)}get rayWorldPosition(){return q(this._rayWorldPosition)}updateRayWorldPosition(){var t;const i=(t=this.xr.context.mainCamera)==null?void 0:t.parent;this._rayWorldPosition.copy(this._rayPositionRaw),i&&this._rayWorldPosition.applyMatrix4(i.matrixWorld)}get rayWorldQuaternion(){return vn(this._rayWorldQuaternion)}get pinchPosition(){return q(this._pinchPosition)}updateRayWorldQuaternion(){var t;const i=(t=this.xr.context.mainCamera)==null?void 0:t.parent,s=i?Ce(i):void 0;this._rayWorldQuaternion.copy(this._rayRotationRaw).multiply(Gi),s&&this._rayWorldQuaternion.premultiply(s)}get ray(){return this._ray.origin.copy(this.rayWorldPosition),this._ray.direction.copy(q(0,0,1).applyQuaternion(this.rayWorldQuaternion)),this._ray}get handWristDotUp(){var t;if(this._hand_wristDotUp!==void 0)return this._hand_wristDotUp;const i=(t=this.handObject)==null?void 0:t.joints.wrist;if(i){const s=q(0,1,0).applyQuaternion(i.quaternion),o=q(0,1,0).dot(s);return this._hand_wristDotUp=o}}get isHandUpsideDown(){return this.handWristDotUp!==void 0?this.handWristDotUp<-.7:!1}get isTeleportGesture(){var t;return this.isHandUpsideDown&&((t=this.getGesture("pinch"))==null?void 0:t.isDown)}get object(){return this._object}async getModelUrl(){var t;return(t=this.getMotionController)==null?void 0:t.then(i=>i?.assetUrl||null)}_requestHitTestSource(){var t;return this._hitTestSourcePromise?this._hitTestSourcePromise:this.xr.mode==="immersive-ar"&&this.inputSource.targetRayMode==="tracked-pointer"&&this.xr.session.requestHitTestSourceForTransientInput?this._hitTestSourcePromise=((t=this.xr.session.requestHitTestSourceForTransientInput({profile:this.inputSource.profiles[0],offsetRay:new XRRay}))==null?void 0:t.then(i=>(this._hitTestSourcePromise=null,this.connected?this._hitTestSource=i:(i.cancel(),null))))??null:null}onUpdate(t){performance.mark("NeedleXRController onUpdate start"),this.onUpdateFrame(t),this.updateInputEvents(),this.onUpdateMove(),performance.mark("NeedleXRController onUpdate end"),performance.measure("NeedleXRController onUpdate","NeedleXRController onUpdate start","NeedleXRController onUpdate end")}onRenderDebug(){var t;G.DrawSphere(this.rayWorldPosition,.003),G.DrawDirection(this.rayWorldPosition,q(0,0,10).applyQuaternion(this.rayWorldQuaternion));const i=(this.inputSource.gripSpace?this.gripWorldPosition:this.object.worldPosition).sub(this.object.worldForward.multiplyScalar(.1)),s=this.inputSource.profiles.join(`
`);let o=`Controller[${this.index}] (${this.inputSource.targetRayMode}, ${this.side})
C:${this.connected?"x":"-"} T:${this.isTracking?"x":"-"} Hand:${this.inputSource.hand?"x":"-"} Pen: ${this._isMxInk?"x":"-"}`;if(this.inputSource.hand&&(o+=`
Pinch: ${(t=this.getGesture("pinch"))==null?void 0:t.value.toFixed(3)}`),o+=`
`+s,o+=`
`+(this.inputSource.targetRaySpace?"Ray: x":"Ray: -")+(this.inputSource.gripSpace?" Grip: x":" Grip: -")+(this.inputSource.gamepad?` Gamepad: ${this.inputSource.gamepad.mapping}`:" Gamepad: -"),this.inputSource.gamepad){const r=this.inputSource.gamepad;let l="[btns "+r.buttons.length+"]: "+r.buttons.map(c=>c.value.toPrecision(1)).join(",");l+=`
[axes `+r.axes.length+"]: "+r.axes.map(c=>c.toPrecision(1)).join(","),o+=`
`+l}G.DrawLabel(i,o,.006)}onUpdateFrame(t){var i,s,o,r,l,c,h,d,u,p,g;if(this._handJointPoses.clear(),this._hand_wristDotUp=void 0,!this.xr.referenceSpace){this._isTracking=!1;return}const y=t.getPose(this.inputSource.targetRaySpace,this.xr.referenceSpace);this._isTracking=y!=null;let f=null,v=null,b=null,w=null;if(y){const M=y.transform;this._rayMatrix.fromArray(M.matrix).premultiply(Oa),this._rayMatrix.decompose(this._rayPosition,this._rayQuaternion,q(1,1,1)),b=q(M.position),w=vn(M.orientation),this._rayPositionRaw.copy(b),this._rayRotationRaw.copy(w)}if(this.inputSource.gripSpace){const M=t.getPose(this.inputSource.gripSpace,this.xr.referenceSpace);if(M){const T=M.transform;if(f=q(T.position),v=vn(T.orientation),this._gripMatrix.fromArray(T.matrix).premultiply(Oa),this._gripMatrix.decompose(this._gripPosition,this._gripQuaternion,q(1,1,1)),"linearVelocity"in M&&M.linearVelocity){const L=M.linearVelocity;this._linearVelocity.set(L.x,L.y,L.z)}}}(i=this.xr.context.mainCamera)!=null&&i.parent&&(this._object.parent!==((s=this.xr.context.mainCamera)==null?void 0:s.parent)&&this.xr.context.mainCamera.parent.add(this._object),this._gripSpaceObject!==void 0&&((o=this._gripSpaceObject)==null?void 0:o.parent)!==((r=this.xr.context.mainCamera)==null?void 0:r.parent)&&this.xr.context.mainCamera.parent.add(this._gripSpaceObject),this._raySpaceObject!==void 0&&((l=this._raySpaceObject)==null?void 0:l.parent)!==((c=this.xr.context.mainCamera)==null?void 0:c.parent)&&this.xr.context.mainCamera.parent.add(this._raySpaceObject));const _=this.hand;if(_){let M=!1;const T=_.get("wrist"),L=T&&this.getHandJointPose(T,t);if(L){M=!0;const B=L.transform.position,Y=L.transform.orientation;this._object.position.set(B.x,B.y,B.z),this._object.quaternion.set(Y.x,Y.y,Y.z,Y.w).multiply(Gi)}M||(this._object.position.copy(this._rayPosition),this._object.quaternion.copy(this._rayQuaternion).multiply(Gi));const D=_.get("middle-finger-metacarpal"),U=D&&this.getHandJointPose(D,t);U&&(this._gripMatrix.fromArray(U.transform.matrix).premultiply(Oa),this._gripMatrix.decompose(this._gripPosition,this._gripQuaternion,q(1,1,1)),f=q().copy(U.transform.position),v=vn().copy(U.transform.orientation),v.multiply(VP),f.add(q(HP).applyQuaternion(v)))}else this.inputSource.gripSpace&&this.targetRayMode==="transient-pointer"&&f&&v?(this._object.position.copy(f),this._object.quaternion.copy(v).multiply(Gi)):b&&w&&(this._object.position.copy(b),this._object.quaternion.copy(w).multiply(Gi));xs&&(b&&w&&((h=this._raySpaceObject)==null||h.position.copy(b),(d=this._raySpaceObject)==null||d.quaternion.copy(w).multiply(Gi)),f&&v&&((u=this._gripSpaceObject)==null||u.position.copy(f),(p=this._gripSpaceObject)==null||p.quaternion.copy(v).multiply(Gi)));const S=(g=this.xr.context.mainCamera)==null?void 0:g.parent,R=S?Ce(S):void 0;f&&v&&(this._gripWorldPosition.copy(f),S&&this._gripWorldPosition.applyMatrix4(S.matrixWorld),this._gripWorldQuaternion.copy(v),this._gripWorldQuaternion.multiply(Gi),R&&this._gripWorldQuaternion.premultiply(R)),this.updateRayWorldPosition(),this.updateRayWorldQuaternion()}onDisconnected(){var t,i,s,o,r,l;this._connected=!1,xs&&console.warn("Controller disconnected",this.index);for(const c of this._object.children)this.xr.context.scene.attach(c);(t=this._object)==null||t.removeFromParent(),(i=this._debugAxesHelper)==null||i.removeFromParent(),(s=this._debugGripAxesHelper)==null||s.removeFromParent(),(o=this._debugRayAxesHelper)==null||o.removeFromParent(),(r=this._gripSpaceObject)==null||r.removeFromParent(),(l=this._raySpaceObject)==null||l.removeFromParent(),this.unsubscribeEvents(),this._hitTestSource&&(this._hitTestSource.cancel(),this._hitTestSource=void 0)}getButton(t){var i;if(!this._layout)return;switch(t){case"primary-button":if(this.isLeft)t="x-button";else if(this.isRight)t="a-button";else return;break;case"primary":return this.hand?this.getGesture("pinch"):this.toNeedleGamepadButton(0,t)}if(this._buttonMap.has(t))return this.toNeedleGamepadButton(this._buttonMap.get(t),t);const s=(i=this._layout)==null?void 0:i.components[t];if(s!=null&&s.gamepadIndices)switch(s.type){case"button":case"squeeze":if(this.inputSource.gamepad){const o=s.gamepadIndices.button;return this._buttonMap.set(t,o),this.toNeedleGamepadButton(o,t)}break;default:console.warn("Unsupported component type",s.type);break}this._buttonMap.set(t,void 0)}getGesture(t){const i=this.states[t];if(!i)return null;this.states[t]=i;const s=this._needleGamepadButtons[t]||new gb(void 0,t);return s.pressed=i.pressed,s.value=i.value,s.isDown=i.isDown,s.isUp=i.isUp,this._needleGamepadButtons[t]=s,s}getPointerId(t){if((t==="primary"||t==="pinch")&&(t=0),typeof t!="number"){const i=this._buttonMap.get(t);if(i===void 0)return;t=i}return this.index*10+t}toNeedleGamepadButton(t,i){var s,o;if(!((s=this.inputSource.gamepad)!=null&&s.buttons))return;const r=(o=this.inputSource.gamepad)==null?void 0:o.buttons[t],l=this.states[t],c=this._needleGamepadButtons[t]||new gb(t,i);return r&&(c.pressed=r.pressed,c.value=r.value,c.touched=r.touched),l&&(c.isDown=l.isDown,c.isUp=l.isUp),this._needleGamepadButtons[t]=c,c}getStick(t){var i,s,o,r,l,c,h,d,u;if(!this._layout)return{x:0,y:0,z:0};if(t==="primary"){const g=((i=this.inputSource.gamepad)==null?void 0:i.axes[0])||0,y=((s=this.inputSource.gamepad)==null?void 0:s.axes[1])||0,f=((r=(o=this.inputSource.gamepad)==null?void 0:o.buttons[3])==null?void 0:r.value)||0;return{x:g,y,z:f}}const p=(l=this._layout)==null?void 0:l.components[t];if(p!=null&&p.gamepadIndices)switch(p.type){case"thumbstick":if(this.inputSource.gamepad){const g=p.gamepadIndices.xAxis,y=p.gamepadIndices.yAxis;let f=(c=this.inputSource.gamepad)==null?void 0:c.axes[g],v=(h=this.inputSource.gamepad)==null?void 0:h.axes[y];f*=-1,v*=-1;const b=p.gamepadIndices.button,w=(u=(d=this.inputSource.gamepad)==null?void 0:d.buttons[b])==null?void 0:u.value;return{x:f,y:v,z:w}}}return{x:0,y:0,z:0}}initialize(){if(this._hasSelectEvent=this.profiles.includes("generic-hand-select")||this.profiles.some(t=>t.startsWith("generic-trigger")),this._isMetaQuestTouchController=this.profiles.includes("meta-quest-touch-plus")||this.profiles.includes("oculus-touch-v3"),this._isMxInk=this.profiles.includes("logitech-mx-ink"),!this._layout){if(this.inputSource.targetRayMode==="transient-pointer")return;const t=eO(this.inputSource,NP,WP);this.getMotionController=t.then(i=>{var s;if(!this.connected)return null;this._motioncontroller=new tO(this.inputSource,i.profile,i.assetPath||"");const o=i.profile.layouts[this.inputSource.handedness];if(this._layout=o,this._layout&&!((s=this._layout.gamepad)!=null&&s.length)){this._layout.gamepad=[];for(const r in this._layout.components){const l=this._layout.components[r];this._layout.gamepad[l.gamepadIndices.button]=r}}return this._motioncontroller}).catch(i=>(this.inputSource&&console.warn("Couldn't initialize motion controller profile for ",this.inputSource,i),null))}}subscribeEvents(){this.xr.session.addEventListener("selectstart",this.onSelectStart),this.xr.session.addEventListener("selectend",this.onSelectEnd),this.xr.session.addEventListener("squeezestart",this.onSequeezeStart),this.xr.session.addEventListener("squeezeend",this.onSequeezeEnd)}unsubscribeEvents(){this.xr.session.removeEventListener("selectstart",this.onSelectStart),this.xr.session.removeEventListener("selectend",this.onSelectEnd),this.xr.session.removeEventListener("squeezestart",this.onSequeezeStart),this.xr.session.removeEventListener("squeezeend",this.onSequeezeEnd)}updateInputEvents(){var t,i,s;if((t=this.gamepad)!=null&&t.buttons){for(let o=0;o<this.gamepad.buttons.length;o++){const r=this.gamepad.buttons[o],l=this.states[o]||new mb;let c=null;this._isMxInk&&(o===4||o===5)?(r.value>0&&!l.pressed?(c="pointerdown",l.isDown=!0,l.isUp=!1):r.value===0&&l.pressed?(c="pointerup",l.isDown=!1,l.isUp=!0):l.pressed&&(c="pointermove",l.isDown=!1,l.isUp=!1),l.pressed=r.value>0,l.value=r.value):(r.pressed&&!l.pressed?(c="pointerdown",l.isDown=!0,l.isUp=!1):!r.pressed&&l.pressed?(c="pointerup",l.isDown=!1,l.isUp=!0):(l.isDown=!1,l.isUp=!1),l.pressed=r.pressed,l.value=r.value),this.states[o]=l;const h=o!==this._selectButtonIndex&&o!==this._squeezeButtonIndex;if(c!=null&&h){let d=(i=this._layout)==null?void 0:i.gamepad[o];this._isMxInk&&o===4&&(d="stylus-touch"),this._isMxInk&&o===5&&(d="stylus-tip"),(xs||Md)&&console.log("Emitting pointer event",c,o,d,r.value,this.gamepad,this._layout),this.emitPointerEvent(c,o,d??"none",!1,null,r.value)}}if(this._isMetaQuestTouchController){const o=this.gamepad.buttons.length-1,r=this.states[o];if(r&&r.isDown){const l=this.context.menu;l.spatialMenuIsVisible?l.setSpatialMenuVisible(!1):this.context.menu.setSpatialMenuVisible(!0)}}}if(this.hand){const o=this.handObject;if(o){const r=o.joints["index-finger-tip"],l=o.joints["thumb-tip"];if(r&&l){const c=r.position.distanceTo(l.position);this._pinchPosition.lerpVectors(r.position,l.position,.5);const h=(s=this.xr.context.mainCamera)==null?void 0:s.parent;if(h&&this._pinchPosition.applyMatrix4(h.matrixWorld),c!==0){const d=this.states.pinch||new mb,u=(.02+.01)*1.5;d.value=1-(c-.02)/u;const p=c<.02-.01,g=c>.02+.01;p&&!d.pressed?(Md&&console.log("pinch start",c),d.isDown=!0,d.isUp=!1,d.pressed=!0):g&&d.pressed?(d.isDown=!1,d.isUp=!0,d.pressed=!1):(d.isDown=!1,d.isUp=!1),this.states.pinch=d}}}}}onUpdateMove(){var t,i;if(!this.emitPointerMoveEvent)return;let s=!1;if(this._lastPointerMovePosition.distanceTo(this.gripWorldPosition)>this.pointerMoveDistanceThreshold*this.xr.rigScale&&(s=!0),s||this._lastPointerMoveQuaternion.angleTo(this.gripWorldQuaternion)>this.pointerMoveAngleThreshold&&(s=!0),s){this._didMoveLastFrame=!0,this._lastPointerMovePosition.copy(this.gripWorldPosition),this._lastPointerMoveQuaternion.copy(this.gripWorldQuaternion),xs&&G.DrawLabel(this.rayWorldPosition.add(this.object.worldForward.multiplyScalar(.1)),"move",.01);let o=this.xr.context.input.getFirstPressedButtonForPointer(this.index);o===void 0&&(o=0);const r=(i=(t=this.gamepad)==null?void 0:t.buttons[o])==null?void 0:i.value;this.emitPointerEvent("pointermove",o,"none",!1,null,r)}else this._didMoveLastFrame=!1}emitPointerEvent(t,i,s,o,r=null,l){if(!this.emitEvents){xs&&t!==Be.PointerMove&&console.warn("Pointer events are disabled for this controller",this.index,t,i);return}if(this.xr.mode==="immersive-vr"||this.xr.isPassThrough){this.pointerInit.origin=this,this.pointerInit.pointerId=this.getPointerId(i),this.pointerInit.pointerType=this.hand?"hand":"controller",this.pointerInit.button=i,this.pointerInit.buttonName=s,this.pointerInit.isPrimary=o,this.pointerInit.mode=this.inputSource.targetRayMode,this.pointerInit.ray=this.ray,this.pointerInit.device=this.object,this.pointerInit.pressure=l,this.pointerInit.clientX=this._rayPosition.x/this.xr.rigScale,this.pointerInit.clientY=this._rayPosition.y/this.xr.rigScale,this.pointerInit.clientZ=this._rayPosition.z/this.xr.rigScale;const c=ee.Current;ee.Current=this.xr.context,xs&&t!=="pointermove"&&console.warn("Pointer event",t,i,s,{...this.pointerInit}),this.xr.context.input.createInputEvent(new ws(t,r,this.pointerInit)),ee.Current=c}}}class mb{constructor(){a(this,"isDown",!1),a(this,"isUp",!1),a(this,"pressed",!1),a(this,"value",0)}}class gb{constructor(t,i){a(this,"index"),a(this,"name"),a(this,"touched",!1),a(this,"pressed",!1),a(this,"value",0),a(this,"isDown",!1),a(this,"isUp",!1),this.index=t,this.name=i}}const Pa=new Map,ka=new Map;let fb=0;function Ss(n,t,i){if(Pa.has(t)||Pa.set(t,new Array),Pa.get(t).push({method:n,options:{once:!1,...i}}),fb<30){const s=ka.get(t);s&&s?.length>100&&(fb+=1,console.warn(`You have ${s.length} methods registered for Event ${t}.

This might be a performance issue!
Consider unregistering the methods when they are not needed anymore!

To unregister you can call the function returned by your event hook (e.g.const unregister = onStart(...)) 

or by using the once option like onStart(()=>{}, { once:true }).

See https://engine.needle.tools/docs/scripting.html#special-lifecycle-hooks for more information.`))}}function ho(n,t){const i=ka.get(t);if(i){for(let o=0;o<i.length;o++)if(i[o].method===n){i.splice(o,1);return}}const s=Pa.get(t);if(s){for(let o=0;o<s.length;o++)if(s[o].method===n){s.splice(o,1);return}}}function Wn(n,t){t===pe.ContextCreated&&tg.delete(n),yb(n,t)}function yb(n,t){t===Me.Start&&Pa.get(pe.ContextCreated)&&yb(n,pe.ContextCreated);const i=t===Me.Start||t===pe.ContextCreated,s=ka.get(t);s&&s.length>0&&bb(n,s,i);const o=Pa.get(t);if(o&&o.length>0){const r=[...o];o.length=0,bb(n,r,i),r.length>0&&(ka.has(t)||ka.set(t,new Array),ka.get(t).push(...r))}}const Rd=new Array,vb={context:null};function bb(n,t,i){var s,o;Rd.length=0;for(let l=0;l<t.length;l++)Rd.push(t[l]);let r=tg.get(n);for(let l=0;l<Rd.length;l++){const c=Rd[l];let h=!0;if(r&&r.has(c)&&(h=!1),h)try{vb.context=n,(s=c.method)==null||s.call(vb,n)}catch(d){console.error("Error in lifecycle method",d)}if((o=c.options)!=null&&o.once){for(let d=0;d<t.length;d++)if(t[d]===c){t.splice(d,1);break}}else i&&(r||(r=new Set,tg.set(n,r)),r.add(c))}}const tg=new WeakMap,ig={};function ng(n,t){ig[n]=t}function _b(n){const t=n.getBufferIdentifier(),i=ig[t];return i(n)}function wb(n){return typeof n.guid=="function"?n.guid():null}let sg;function $P(){return sg}function GP(n){sg=n}function xb(n,t){return t||(t={}),t={...sg,...t},n?new av(n,t):new av(t)}async function Sb(){const n=await import("./vendor.min.js").then(t=>t.bundler);return console.log(n),n.default===void 0?n:n.default}class Cb{constructor(){a(this,"_host"),a(this,"_client"),a(this,"_clientData"),this.onEnable()}get isHost(){return this._host!==void 0}onEnable(){const t="HOST-5980e65c-8438-453e-8b35-f13c736dcd81";this.trySetupHost(t)}async trySetupHost(t){const i=await Sb(),s=new i(t);s.on("error",o=>{console.error(o),this._host=void 0,this.trySetupClient(t)}),s.on("open",o=>{this._host=new XP(s)})}async trySetupClient(t){const i=await Sb();this._client=new i,this._client.on("error",s=>{console.error("Client error",s)}),this._client.on("open",s=>{console.log("client connected",s),this._clientData=this._client.connect(t,{metadata:{id:s}}),this._clientData.on("open",()=>{console.log("Connected to host")}),this._clientData.on("data",o=>{console.log("<<",o)})})}}class qP{constructor(t){a(this,"_peer"),this._peer=t}}class XP extends qP{constructor(t){var i;super(t),a(this,"_connections",[]),console.log("I AM THE HOST"),(i=this._peer)==null||i.on("connection",this.onConnection.bind(this)),this._peer.on("close",()=>{this.broadcast("BYE")}),setInterval(()=>{this.broadcast("HELLO")},2e3)}get isHost(){return!0}onConnection(t){console.log("host connection",t),t.on("open",()=>{this._connections.push(t),this.broadcastConnection(t)})}broadcastConnection(t){const i=this._connections.map(s=>{var o;return(o=s.metadata)==null?void 0:o.id}).filter(s=>s!==void 0);this.broadcast({type:"connection-list",connections:i})}broadcast(t){if(t!=null){console.log(">>",t);for(const i in this._peer.connections){const s=this._peer.connections[i];if(s)if(Array.isArray(s))for(const o of s)o&&o.send(t);else console.warn(s)}}}}var wn=(n=>(n[n.OnConnection=0]="OnConnection",n[n.OnRoomJoin=1]="OnRoomJoin",n[n.Queued=2]="Queued",n[n.Immediate=3]="Immediate",n))(wn||{});const Ob="https://urls.needle.tools/default-networking-backend/index";let ki="wss://networking.needle.tools/socket";const li=!!C("debugnet"),uc=!!(li||C("debugowner")),og=C("debugnetbin");var Pb=(n=>(n.ConnectionInfo="connection-start-info",n))(Pb||{}),ne=(n=>(n.Join="join-room",n.Leave="leave-room",n.JoinedRoom="joined-room",n.LeftRoom="left-room",n.UserJoinedRoom="user-joined-room",n.UserLeftRoom="user-left-room",n.RoomStateSent="room-state-sent",n))(ne||{});class QP{constructor(){a(this,"room"),a(this,"viewId"),a(this,"allowEditing"),a(this,"inRoom")}}class YP{constructor(){a(this,"room")}}class ZP{constructor(){a(this,"userId")}}var kb=(n=>(n.RequestHasOwner="request-has-owner",n.ResponseHasOwner="response-has-owner",n.RequestIsOwner="request-is-owner",n.ResponseIsOwner="response-is-owner",n.RequestOwnership="request-ownership",n.GainedOwnership="gained-ownership",n.RemoveOwnership="remove-ownership",n.LostOwnership="lost-ownership",n.GainedOwnershipBroadcast="gained-ownership-broadcast",n.LostOwnershipBroadcast="lost-ownership-broadcast",n))(kb||{});class rg{constructor(t,i){a(this,"guid"),a(this,"connection"),a(this,"_hasOwnership",!1),a(this,"_isOwned"),a(this,"_gainSubscription"),a(this,"_lostSubscription"),a(this,"_hasOwnerResponse"),a(this,"_isWaitingForOwnershipResponseCallback",null),this.connection=t,this.guid=i,this._gainSubscription=this.onGainedOwnership.bind(this),this._lostSubscription=this.onLostOwnership.bind(this),t.beginListen("lost-ownership",this._lostSubscription),t.beginListen("gained-ownership-broadcast",this._gainSubscription),this._hasOwnerResponse=this.onHasOwnerResponse.bind(this),t.beginListen("response-has-owner",this._hasOwnerResponse)}get hasOwnership(){return this._hasOwnership}get isOwned(){return this._isOwned}get isConnected(){return this.connection.isConnected}updateIsOwned(){this.connection.send("request-has-owner",{guid:this.guid})}onHasOwnerResponse(t){t.guid===this.guid&&(this._isOwned=t.value)}requestOwnershipIfNotOwned(){return this._isWaitingForOwnershipResponseCallback!==null?this:(this._isWaitingForOwnershipResponseCallback=this.waitForHasOwnershipRequestResponse.bind(this),this.connection.beginListen("response-has-owner",this._isWaitingForOwnershipResponseCallback),this.connection.send("request-has-owner",{guid:this.guid}),this)}waitForHasOwnershipRequestResponse(t){t.guid===this.guid&&(this._isWaitingForOwnershipResponseCallback&&(this.connection.stopListen("response-has-owner",this._isWaitingForOwnershipResponseCallback),this._isWaitingForOwnershipResponseCallback=null),this._isOwned=t.value,t.value||(uc&&console.log("request ownership",this.guid),this.requestOwnership()))}requestOwnershipAsync(){return new Promise((t,i)=>{this.requestOwnership();let s=0;const o=()=>{if(s++>10)return i("Timeout");setTimeout(()=>{this.hasOwnership?t(this):o()},100)};o()})}requestOwnership(){return uc&&console.log("Request ownership",this.guid),this.connection.send("request-ownership",{guid:this.guid}),this}freeOwnership(){return this.connection.send("remove-ownership",{guid:this.guid}),this._isWaitingForOwnershipResponseCallback&&(this.connection.stopListen("response-has-owner",this._isWaitingForOwnershipResponseCallback),this._isWaitingForOwnershipResponseCallback=null),this}destroy(){this.connection.stopListen("gained-ownership",this._gainSubscription),this.connection.stopListen("lost-ownership",this._lostSubscription),this.connection.stopListen("response-has-owner",this._hasOwnerResponse),this._isWaitingForOwnershipResponseCallback&&(this.connection.stopListen("response-has-owner",this._isWaitingForOwnershipResponseCallback),this._isWaitingForOwnershipResponseCallback=null)}onGainedOwnership(t){t.guid===this.guid&&(this._isOwned=!0,this.connection.connectionId===t.owner?(uc&&console.log("GAINED OWNERSHIP",this.guid),this._hasOwnership=!0):this._hasOwnership=!1)}onLostOwnership(t){t===this.guid&&(uc&&console.log("LOST OWNERSHIP",this.guid),this._hasOwnership=!1,this._isOwned=!1)}}class Mb{constructor(t){a(this,"context"),a(this,"_peer",null),a(this,"_usersInRoomCopy",[]),a(this,"_defaultMessagesBuffer",[]),a(this,"_defaultMessagesBufferArray",[]),a(this,"netWebSocketUrlProvider"),a(this,"_listeners",{}),a(this,"_listenersBinary",{}),a(this,"connected",!1),a(this,"channelId"),a(this,"_connectionId",null),a(this,"_ws"),a(this,"_waitingForSocket",{}),a(this,"_isInRoom",!1),a(this,"_currentRoomName",null),a(this,"_currentRoomViewId",null),a(this,"_currentRoomAllowEditing",!0),a(this,"_currentInRoom",[]),a(this,"_state",{}),a(this,"_currentDelay",-1),a(this,"_connectingToWebsocketPromise",null),this.context=t}get peer(){return this._peer||(this._peer=new Cb),this._peer}tryGetState(t){return t==="invalid"?null:this._state[t]}get connectionId(){return this._connectionId}get isDebugEnabled(){return li}get isConnected(){return this.connected}get currentRoomName(){return this._currentRoomName}get allowEditing(){return this._currentRoomAllowEditing}get currentRoomViewId(){return this._currentRoomViewId}getViewOnlyUrl(){if(this.currentRoomViewId===null)return null;const t=new URL(window.location.href);return t.searchParams.set("view",this.currentRoomViewId),t.href}get isInRoom(){return this._isInRoom}get currentLatency(){return this._currentDelay}get currentServerUrl(){var t;return((t=this._ws)==null?void 0:t.url)??null}sendPing(){this.send("ping",{time:this.context.time.time})}userIsInRoom(t){return this._currentInRoom.indexOf(t)!==-1}usersInRoom(t=null){t||(t=this._usersInRoomCopy),t.length=0;for(const i of this._currentInRoom)t.push(i);return t}joinRoom(t,i=!1){return t?t.length>1024?(console.error('Room name too long, can not join: "'+t+'". Max length is 1024 characters.'),!1):(this.connect(),li&&console.log("join: "+t),this.send("join-room",{room:t,viewOnly:i},wn.OnConnection),!0):(console.error('Missing room name, can not join: "'+t+'"'),!1)}leaveRoom(t=null){return t||(t=this.currentRoomName),t?(this.send("leave-room",{room:t}),!0):(console.error('Missing room name, can not join: "'+t+'"'),!1)}send(t,i=null,s=wn.Queued){if(i===null&&(i={}),s===wn.Queued){this._defaultMessagesBuffer.push({key:t,value:i});return}return this.sendWithWebsocket(t,i,s)}sendDeleteRemoteState(t){this.send("delete-state",{guid:t,dontSave:!0}),delete this._state[t]}sendDeleteRemoteStateAll(){this.send("delete-all-state"),this._state={}}sendBinary(t){var i;og&&console.log("<< send binary",this.context.time.frame,t.length/1024+" KB"),(i=this._ws)==null||i.send(t)}sendBufferedMessagesNow(){var t;if(!this._ws)return;this._defaultMessagesBufferArray.length=0;const i=Object.keys(this._defaultMessagesBuffer).length;for(const o in this._defaultMessagesBuffer){const r=this._defaultMessagesBuffer[o];if(i<=1){this.sendWithWebsocket(r.key,r.value,wn.Immediate);break}const l=this.toMessage(r.key,r.value);this._defaultMessagesBufferArray.push(l)}if(this._defaultMessagesBuffer.length=0,this._defaultMessagesBufferArray.length>0&&li&&console.log("SEND BUFFERED",this._defaultMessagesBufferArray.length),this._defaultMessagesBufferArray.length<=0)return;const s=JSON.stringify(this._defaultMessagesBufferArray);(t=this._ws)==null||t.send(s)}beginListen(t,i){return this._listeners[t]||(this._listeners[t]=[]),this._listeners[t].push(i),i}stopListening(t,i){return this.stopListen(t,i)}stopListen(t,i){if(!i||!this._listeners[t])return;const s=this._listeners[t].indexOf(i);s>=0&&this._listeners[t].splice(s,1)}beginListenBinary(t,i){return this._listenersBinary[t]||(this._listenersBinary[t]=[]),this._listenersBinary[t].push(i),i}stopListenBinary(t,i){if(!this._listenersBinary[t])return;const s=this._listenersBinary[t].indexOf(i);s>=0&&this._listenersBinary[t].splice(s,1)}registerProvider(t){this.netWebSocketUrlProvider=t}async connect(t){var i;if(this.connected&&t&&t!==ki)return Promise.reject("Can not connect to different server url. Please disconnect first.");if(this.connected)return Promise.resolve(!0);t&&console.debug("Connecting to user provided url "+t);const s=t||((i=this.netWebSocketUrlProvider)==null?void 0:i.getWebsocketUrl());return s?ki=s:vv()&&(ki="wss://"+window.location.host+"/socket"),this.connectWebsocket()}disconnect(){var t;(t=this._ws)==null||t.close(),this._ws=void 0,ki=void 0}connectWebsocket(){return this._connectingToWebsocketPromise?this._connectingToWebsocketPromise:this._connectingToWebsocketPromise=new Promise(async(t,i)=>{var s,o;let r=!1;const l=p=>{r||(r=!0,t(p))};if(ki===void 0&&(console.log("Fetch default backend url: "+Ob),ki=await(await fetch(Ob)).text()),ki===void 0){l(!1);return}console.debug(`\u22A1 Connecting to networking backend on
`+ki);const c=await import("./vendor.min.js").then(p=>p.index),h=((s=c.default)==null?void 0:s.WebsocketBuilder)??c.WebsocketBuilder,d=((o=c.default)==null?void 0:o.ExponentialBackoff)??c.ExponentialBackoff,u=new h(ki).withMaxRetries(10).withBackoff(new d(2e3,4)).onOpen(()=>{this._connectingToWebsocketPromise=null,this._ws=u,this.connected=!0,F()||li?console.log(`\u229E Connected to networking backend
`+ki):console.debug("\u229E Connected to networking backend",ki),l(!0),this.onSendQueued(wn.OnConnection)}).onClose(p=>{this._connectingToWebsocketPromise=null,this.connected=!1,this._isInRoom=!1,l(!1);let g="Websocket connection closed...";ki!=null&&ki.includes("/socket")||(g+=' Do you perhaps mean to connect to "/socket"?'),console.error(g)}).onError(p=>{console.error("\u22A0 Websocket connection failed..."),l(!1)}).onRetry(()=>{console.log("\u2192 Retry connecting to networking websocket")}).build();u.addEventListener(c.WebsocketEvent.message,(p,g)=>{this.onMessage(p,g)})})}onMessage(t,i){const s=i.data;try{if(typeof s!="string"){s.size&&this.handleIncomingBinaryMessage(s);return}const o=JSON.parse(s);if(Array.isArray(o))for(const r of o)this.handleIncomingStringMessage(r);else this.handleIncomingStringMessage(o);return}catch(o){li&&s==="pong"?console.log("<<",s):F()&&console.error("Failed to parse message",o)}}async handleIncomingBinaryMessage(t){og&&console.log("<< bin",this.context.time.frame);const i=await t.arrayBuffer();var s=new Uint8Array(i);const o=new iO(s),r=o.getBufferIdentifier(),l=this._listenersBinary[r],c=_b(o),h=wb(c);if(h&&typeof h=="string"&&(this._state[h]=c),!l)return;const d=c??o;for(const u of l)u(d)}handleIncomingStringMessage(t){var i,s;if(li&&console.log("<<",t.key??t),t.key)switch(t.key){case"connection-start-info":if(t.data){const c=t.data;c&&(console.assert(c.id!==void 0&&c.id!==null&&c.id.length>0,"server did not send connection id",c.id),console.debug("Your id is: "+c.id,this.context.alias??""),this._connectionId=c.id)}else console.warn("Expected connection id in "+t.key);break;case"joined-room":if(li&&console.log(t),t){this._isInRoom=!0;const c=t;this._currentRoomName=c.room,this._currentRoomViewId=c.viewId,this._currentRoomAllowEditing=c.allowEditing??!0,this._currentInRoom.length=0,this._currentInRoom.push(...c.inRoom),(og||F())&&console.debug("Joined Needle Engine Room: "+c.room);const h=new URL(window.location.href);h.searchParams.has("room")&&h.searchParams.delete("room"),h.searchParams.set("view",this._currentRoomViewId),console.debug(`Room view id: ${this._currentRoomViewId}
${h.href}`)}this.onSendQueued(wn.OnRoomJoin);break;case"left-room":t.room===this.currentRoomName&&(this._isInRoom=!1,this._currentRoomName=null,this._currentInRoom.length=0);break;case"user-joined-room":if(t.data){const c=t.data;this._currentInRoom.push(c.userId),li&&console.log(c.userId+" joined","now in room:",this._currentInRoom)}break;case"user-left-room":if(t.data){const c=t.data,h=this._currentInRoom.indexOf(c.userId);h>=0&&(li&&console.log(c.userId+" left","now in room:",this._currentInRoom),this._currentInRoom.splice(h,1)),c.userId===this.connectionId&&console.log("you left the room")}break;case"all-room-state-deleted":li&&console.log("RECEIVED all-room-state-deleted"),this._state={};break;case"ping":case"pong":const l=(i=t.data)==null?void 0:i.time;l&&(this._currentDelay=this.context.time.time-l),li&&console.log("Current latency: "+this._currentDelay.toFixed(4)+" sec","Clients in room: "+((s=this._currentInRoom)==null?void 0:s.length));break}const o=t.data;o&&(this._state[o.guid]=o);let r=this._listeners[t.key];if(r){r=[...r];for(const l of r)try{l(t.data)}catch(c){console.error('Error invoking callback for "'+t.key+'"',c)}}}toMessage(t,i){return{key:t,data:i}}sendWithWebsocket(t,i,s=wn.OnRoomJoin){if(!this._ws){const r=this._waitingForSocket[s]||[];r.push(()=>this.sendWithWebsocket(t,i,s)),this._waitingForSocket[s]=r;return}const o=JSON.stringify(this.toMessage(t,i));li&&console.log(">>",t),this._ws.send(o)}onSendQueued(t){const i=this._waitingForSocket[t];if(i){for(const s of i)s();i.length=0}}}const pc=C("debugwebxr");class ag{constructor(t,i){a(this,"controllerStates",[]),a(this,"userId"),a(this,"context"),a(this,"userStateEvtName"),a(this,"onReceivedControllerState",s=>{pc&&console.log(`XRSync: Received change for ${this.userId}: ${s.type} ${s.handedness}; tracked=${s.isTracking}`);let o=!1;for(let r=0;r<this.controllerStates.length;r++)if(this.controllerStates[r].index===s.index){this.controllerStates[r]=s,o=!0;break}o||this.controllerStates.push(s)}),this.userId=t,this.context=i,this.userStateEvtName="xr-sync-user-state-"+t,this.context.connection.beginListen(this.userStateEvtName,this.onReceivedControllerState)}dispose(){this.context.connection.stopListen(this.userStateEvtName,this.onReceivedControllerState)}update(t){if(this.context.connection.isConnected!=!1){for(let i=this.controllerStates.length-1;i>=0;i--){const s=this.controllerStates[i];let o=!1;for(let r=0;r<t.controllers.length;r++)t.controllers[r].index===s.index&&(o=!0);o||(pc&&console.log(`XRSync: ${s.type} ${s.handedness} removed`,s.index),this.controllerStates.splice(i,1),this.sendControllerRemoved(s))}for(const i of t.controllers)this.updateControllerStates(i)}}onExitXR(t){for(const i of this.controllerStates)this.sendControllerRemoved(i);this.controllerStates.length=0}sendControllerRemoved(t){t.isTracking=!1,t.guid="",this.context.connection.send(this.userStateEvtName,t),this.context.connection.sendDeleteRemoteState(t.guid)}updateControllerStates(t){const i=this.controllerStates.find(s=>s.index===t.index);if(i){let s=!1;s||(s=i.isTracking!=t.isTracking),s&&(i.isTracking=t.isTracking,this.context.connection.send(this.userStateEvtName,i))}else{const s={guid:this.userId+"-"+t.index,isTracking:t.isTracking,handedness:t.side,index:t.index,type:t.hand?"hand":"controller"};this.controllerStates.push(s),this.context.connection.send(this.userStateEvtName,s),pc&&console.log(`XRSync: ${s.type} ${s.handedness} added`,s.index)}}}class Rb{constructor(t){a(this,"context"),a(this,"onJoinedRoom",()=>{if(this.context.connection.connectionId){this._states.has(this.context.connection.connectionId)||(pc&&console.log("XRSync: Local user joined room",this.context.connection.connectionId),this._states.set(this.context.connection.connectionId,new ag(this.context.connection.connectionId,this.context)));for(const i of this.context.connection.usersInRoom())this._states.has(i)||this._states.set(i,new ag(i,this.context))}}),a(this,"onLeftRoom",()=>{if(this.context.connection.connectionId&&!this._states.has(this.context.connection.connectionId)){const i=this._states.get(this.context.connection.connectionId);i?.dispose(),this._states.delete(this.context.connection.connectionId)}}),a(this,"onOtherUserJoinedRoom",i=>{const s=i.userId;this._states.has(s)||(pc&&console.log("XRSync: Remote user joined room",s),this._states.set(s,new ag(s,this.context)))}),a(this,"onOtherUserLeftRoom",i=>{const s=i.userId;if(!this._states.has(s)){const o=this._states.get(s);o?.dispose(),this._states.delete(s)}}),a(this,"_states",new Map),this.context=t,this.context.connection.beginListen(ne.JoinedRoom,this.onJoinedRoom),this.context.connection.beginListen(ne.LeftRoom,this.onLeftRoom),this.context.connection.beginListen(ne.UserJoinedRoom,this.onOtherUserJoinedRoom),this.context.connection.beginListen(ne.UserLeftRoom,this.onOtherUserLeftRoom)}hasState(t){return t?this._states.has(t):!1}isTracking(t,i){if(!t)return;const s=this._states.get(t);if(!s)return;const o=s.controllerStates.find(r=>r.handedness===i);return o?.isTracking||!1}getDeviceType(t,i){if(!t)return;const s=this._states.get(t);if(!s)return;const o=s.controllerStates.find(r=>r.handedness===i);return o?.type||"unknown"}destroy(){this.context.connection.stopListen(ne.JoinedRoom,this.onJoinedRoom),this.context.connection.stopListen(ne.LeftRoom,this.onLeftRoom),this.context.connection.stopListen(ne.UserJoinedRoom,this.onOtherUserJoinedRoom),this.context.connection.stopListen(ne.UserLeftRoom,this.onOtherUserLeftRoom)}onUpdate(t){if(this.context.connection.isConnected&&this.context.connection.connectionId){const i=this._states.get(this.context.connection.connectionId);i?.update(t)}}onExitXR(t){if(this.context.connection.isConnected&&this.context.connection.connectionId){const i=this._states.get(this.context.connection.connectionId);i?.onExitXR(t)}}}class Tb{constructor(){a(this,"_fadeToColorQuad"),a(this,"_fadeToColorMaterial"),a(this,"_requestedFadeValue",0),a(this,"_transitionPromise",null),a(this,"_transitionResolve",null),this._fadeToColorMaterial=new Re({color:0,transparent:!0,depthTest:!1,fog:!1,side:Ci}),this._fadeToColorQuad=new X(new zn(10,10),this._fadeToColorMaterial)}dispose(){this._fadeToColorQuad.geometry.dispose(),this._fadeToColorMaterial.dispose()}update(t,i){const s=this._fadeToColorQuad,o=this._fadeToColorMaterial;s.parent!==t&&o.opacity>0?t.add(s):o.opacity===0&&s.removeFromParent(),s.layers.set(2),s.material=this._fadeToColorMaterial,s.position.z=-1,s.renderOrder=1/0;const r=this._requestedFadeValue;o.opacity=W.lerp(o.opacity,r,i/.03),Math.abs(o.opacity-r)<=.01&&this._transitionResolve&&(this._transitionResolve(),this._transitionResolve=null,this._transitionPromise=null,this._requestedFadeValue=0)}remove(){this._fadeToColorQuad.removeFromParent()}fadeTransition(){if(this._transitionPromise)return this._transitionPromise;this._requestedFadeValue=1;const t=new Promise(i=>{this._transitionResolve=i});return this._transitionPromise=t,t}}var pr=(n=>(n[n.Quad=0]="Quad",n[n.Cube=1]="Cube",n[n.Sphere=2]="Sphere",n[n.RoundedCube=10]="RoundedCube",n))(pr||{}),Td,lg;class uo{static createText(t,i){let s=null;const o=i?.font||JP(i?.familyFamily||null);o instanceof jC?s=nd(this,Td,lg).call(this,t,o,i):s==null&&(s=new gs);const r=i?.color||16777215,l=new X(s,i?.material??new Ft({color:r}));return this.applyDefaultObjectOptions(l,i),o instanceof Promise?o.then(c=>{l.geometry=nd(this,Td,lg).call(this,t,c,i),i!=null&&i.onGeometry&&i.onGeometry(l)}):i!=null&&i.onGeometry&&i.onGeometry(l),l}static createOccluder(t){const i=new Re({colorWrite:!1,depthWrite:!0,side:Ci});return this.createPrimitive(t,{material:i})}static createPrimitive(t,i){let s;const o=i?.color||16777215;switch(t){case"Quad":case 0:{const r=new zn(1,1,1,1),l=i?.material??new Ft({color:o});i!=null&&i.texture&&"map"in l&&(l.map=i.texture),s=new X(r,l),s.name="Quad"}break;case"Cube":case 1:{const r=new ma(1,1,1),l=i?.material??new Ft({color:o});i!=null&&i.texture&&"map"in l&&(l.map=i.texture),s=new X(r,l),s.name="Cube"}break;case 10:case"RoundedCube":{const r=KP(1,1,1,.1,2),l=i?.material??new Ft({color:o});i!=null&&i.texture&&"map"in l&&(l.map=i.texture),s=new X(r,l),s.name="RoundedCube"}break;case"Sphere":case 2:{const r=new sd(.5,16,16),l=i?.material??new Ft({color:o});i!=null&&i.texture&&"map"in l&&(l.map=i.texture),s=new X(r,l),s.name="Sphere"}break;case"ShaderBall":s=new so,s.name="ShaderBall",e2(s,i);break}return this.applyDefaultObjectOptions(s,i),s}static createSprite(t){const i=new mS({color:16777215});t!=null&&t.texture&&"map"in i&&(i.map=t.texture);const s=new gS(i);return this.applyDefaultObjectOptions(s,t),s}static applyDefaultObjectOptions(t,i){t.receiveShadow=!0,t.castShadow=!0,i!=null&&i.name&&(t.name=i.name),i!=null&&i.position&&(Array.isArray(i.position)?t.position.set(i.position[0],i.position[1],i.position[2]):t.position.set(i.position.x,i.position.y,i.position.z)),i!=null&&i.rotation&&(Array.isArray(i.rotation)?t.rotation.set(i.rotation[0],i.rotation[1],i.rotation[2]):t.rotation.set(i.rotation.x,i.rotation.y,i.rotation.z)),i!=null&&i.scale&&(typeof i.scale=="number"?t.scale.set(i.scale,i.scale,i.scale):Array.isArray(i.scale)?t.scale.set(i.scale[0],i.scale[1],i.scale[2]):t.scale.set(i.scale.x,i.scale.y,i.scale.z)),i?.receiveShadow!=null&&(t.receiveShadow=i.receiveShadow),i?.castShadow!=null&&(t.castShadow=i.castShadow),i!=null&&i.parent&&i.parent.add(t)}}Td=new WeakSet,lg=function(n,t,i){const s=i?.depth||.1;return new LC(n,{font:t,size:1,depth:s,height:s,bevelEnabled:i?.bevel||!1,bevelThickness:.01,bevelOffset:.01,bevelSize:.01})},pn(uo,Td);function KP(n,t,i,s,o){const r=new fS,l=1e-5,c=s-l;r.absarc(l,l,l,-Math.PI/2,-Math.PI,!0),r.absarc(l,t-c*2,l,Math.PI,Math.PI/2,!0),r.absarc(n-c*2,t-c*2,l,Math.PI/2,0,!0),r.absarc(n-c*2,l,l,0,-Math.PI/2,!0);const h=new yS(r,{bevelEnabled:!0,bevelSegments:o*2,steps:1,bevelSize:c,bevelThickness:s,curveSegments:o});return h.scale(1,1,1-s),h.center(),h.computeVertexNormals(),h}const Ed=new Map;function JP(n){let t="";switch(n){default:case"OpenSans":t="https://cdn.needle.tools/static/fonts/facetype/Open Sans_Regular_ascii.json";break;case"Helvetiker":t="https://raw.githubusercontent.com/mrdoob/three.js/master/examples/fonts/helvetiker_regular.typeface.json";break}if(Ed.has(t)){const o=Ed.get(t);if(o)return o}const i=new DC,s=new Promise((o,r)=>{i.load(t,l=>{Ed.set(t,l),o(l)},void 0,r)});return Ed.set(t,s),s}let cg=!1,hg=null;function e2(n,t){if(hg===null){const i="https://cdn.needle.tools/static/models/shaderball.glb",s=new ar,o=gm(null);s.setDRACOLoader(o.dracoLoader),s.setKTX2Loader(o.ktx2Loader),cg=!0,hg=s.loadAsync(i).then(r=>{const l=r.scene;return l.position.y-=.5,l}).catch(r=>(console.warn("Failed to load shaderball mesh: "+r.message),Ab())).finally(()=>{cg=!1})}if(cg){const i=Ab();i.name="ShaderBall-Placeholder";const s=i.children[0];s?.type==="Mesh"&&Eb(s,t),n.add(i)}hg.then(i=>{n.children.forEach(r=>{r.name==="ShaderBall-Placeholder"&&n.remove(r)});const s=i.clone(),o=s.children[0];o?.type==="Mesh"&&Eb(o,t),n.add(s)})}function Eb(n,t){var i;if(t?.color||t?.material||t?.texture){const s=t?.material??((i=n.material)==null?void 0:i.clone())??new Ft;t.color&&"color"in s&&s.color instanceof ae&&s.color.set(t.color),t!=null&&t.texture&&"map"in s&&(s.map=t.texture),n.material=s}}function Ab(){return new so().add(uo.createPrimitive("Sphere",{material:new Re({transparent:!0,opacity:.1})}))}const Ib=class{constructor(n,t,i){a(this,"_session"),a(this,"_mode"),a(this,"_init"),a(this,"_renderer"),a(this,"_camera"),a(this,"_scene"),a(this,"onEnd",()=>{var s;(s=this._session)==null||s.removeEventListener("end",this.onEnd),this._renderer.setAnimationLoop(null),this._renderer.dispose(),this._scene.clear()}),a(this,"_lastTime",0),a(this,"onFrame",(s,o)=>{const r=s-this._lastTime;this.update(s,r),this._camera.parent!==this._scene&&this._scene.add(this._camera),this._renderer.render(this._scene,this._camera)}),a(this,"_objects",[]),this._mode=n,this._init=t,this._session=i,this._session.addEventListener("end",this.onEnd),this._renderer=new sr({alpha:!0}),this._renderer.setAnimationLoop(this.onFrame),this._renderer.xr.setSession(i),this._renderer.xr.enabled=!0,this._camera=new _e,this._scene=new wi,this._scene.fog=new Wy(4473924,10,250),this._scene.add(this._camera),this.setupScene()}static get active(){return this._active}static async start(n,t){if(this._active)return console.error("Cannot start a new XR session while one is already active"),null;if(this._requestInFlight)return console.error("Cannot start a new XR session while a request is already in flight"),null;if("xr"in navigator&&navigator.xr){if(!t)return console.error("XRSessionInit must be provided"),null;this._requestInFlight=!0;const i=await navigator.xr.requestSession(n,t);return i.addEventListener("end",()=>{this._active=null}),this._requestInFlight?(this._requestInFlight=!1,this._active=new Ib(n,t,i),this._active):(i.end(),null)}return null}static async handoff(){return this._active?this._active.handoff():null}static async stop(){this._requestInFlight=!1,this._active&&(await this._active.end(),await yn(100)),this._active=null}get isAR(){return this._mode==="immersive-ar"}end(){return this._session?this._session.end():Promise.resolve()}async handoff(){if(!this._session)throw new Error("Cannot handoff a session that has already ended");const n={session:this._session,mode:this._mode,init:this._init};return await this.onBeforeHandoff(),this.onEnd(),this._session=null,n}async onBeforeHandoff(){await yn(1e3),this._scene.clear()}setupScene(){this._scene.background=new ae(0),this._scene.add(new nm(5,10,1118481,1118481));const n=new sm(16777215,1);n.position.set(0,20,0),n.castShadow=!1,this._scene.add(n);const t=new sm(16777215,1);t.position.set(0,-1,0),t.castShadow=!1,this._scene.add(t);const i=new om(16777215,1,100,1);i.position.set(0,2,0),i.castShadow=!1,i.distance=200,this._scene.add(i);const s=50;for(let o=0;o<100;o++){const r=new Ft({color:2236962,metalness:1,roughness:.8});this.isAR&&(r.emissive=new ae(Math.random(),Math.random(),Math.random()),r.emissiveIntensity=Math.random());const l=W.random(0,1)>.5?pr.Sphere:pr.Cube,c=uo.createPrimitive(l,{material:r});c.position.x=W.random(-s,s),c.position.y=W.random(-2,s),c.position.z=W.random(-s,s),c.rotation.x=W.random(0,Math.PI*2),c.rotation.y=W.random(0,Math.PI*2),c.rotation.z=W.random(0,Math.PI*2),c.scale.multiplyScalar(.5+Math.random()*10);const h=c.position.distanceTo(this._camera.position)-c.scale.x;h<1&&c.position.multiplyScalar(1+1/h),this._objects.push(c),this._scene.add(c)}}update(n,t){const i=n*4e-4;for(let s=0;s<this._objects.length;s++){const o=this._objects[s];o.position.y+=Math.sin(i+s*.5)*.005,o.rotateY(.002)}}};let Ma=Ib;a(Ma,"_active",null),a(Ma,"_requestInFlight",!1);var mc;(n=>{const t=[];function i(){if(!(t!=null&&t.length))return!1;for(const r of t)r.exportAndOpen();return!0}n.exportAndOpen=i;function s(r){t.push(r)}n.registerExporter=s;function o(r){if(!t)return;const l=t.indexOf(r);l>=0&&t.splice(l,1)}n.unregisterExporter=o})(mc||(mc={}));const jb="NeedleXRSession onStart",Lb="NeedleXRSession onEnd",vt=C("debugwebxr"),Db=C("stats");let dg=0;function t2(n){let t=null;const i=n;return i.getAROverlayContainer?t=i.getAROverlayContainer():t=n,t}i2();async function i2(){var n;if(C("debugasap")){let t=globalThis["needle:XRSession"];if(t instanceof Promise){delete globalThis["needle:XRSession"],ue.addContextCreatedCallback(async i=>{if(!t)return;dr(!0);const s=await t;if(s){const o=J.getDefaultSessionInit("immersive-vr");J.setSession("immersive-vr",s,o,i.context)}else console.error("NeedleXRSession: ASAP session was rejected");t=void 0});return}}if("xr"in navigator){if(/WebXRViewer\//i.test(navigator.userAgent)){console.warn("WebXRViewer does not support addEventListener");return}(n=navigator.xr)==null||n.addEventListener("sessiongranted",async()=>{dr(!0),console.log("Received Session Granted..."),await yn(100);const t=sessionStorage.getItem("needle_xr_session_mode"),i=sessionStorage.getItem("needle_xr_session_init")??null,s=i?JSON.parse(i):null;let o=null;if(Bb()&&(await Ma.start(t||"immersive-vr",s||J.getDefaultSessionInit("immersive-vr")),await o2(),o=await Ma.handoff()),o)J.setSession(o.mode,o.session,o.init,ee.Current);else if(t&&i){console.log("Session Granted: Restore last session");const r=JSON.parse(i);J.start(t,r).catch(l=>console.warn(l))}else J.start("immersive-vr").catch(r=>console.warn("Session Granted failed:",r))},{once:!0})}}function n2(n,t){sessionStorage.setItem("needle_xr_session_mode",n),sessionStorage.setItem("needle_xr_session_init",JSON.stringify(t))}function s2(){sessionStorage.removeItem("needle_xr_session_mode"),sessionStorage.removeItem("needle_xr_session_init")}const ug=new Set;ue.registerCallback(pe.ContextCreationStart,async n=>{ug.add(n.context)}),ue.registerCallback(pe.ContextCreated,async n=>{ug.delete(n.context)});function Bb(){return ug.size>0}function o2(){return new Promise(n=>{const t=Date.now(),i=setInterval(()=>{(!Bb()||Date.now()-t>6e4)&&(clearInterval(i),n())},100)})}Q.isDesktop()&&F()&&window.addEventListener("keydown",n=>{(n.key==="x"||n.key==="Escape")&&J.active&&J.stop()});const po=class{constructor(n,t,i,s){a(this,"context"),a(this,"session"),a(this,"mode"),a(this,"controllers",[]),a(this,"_rigScale",1),a(this,"_lastRigScaleUpdate",-1),a(this,"_rigs",[]),a(this,"_viewerHitTestSource",null),a(this,"_defaultRig"),a(this,"_xr_scripts"),a(this,"_xr_update_scripts",[]),a(this,"_inactive_scripts",[]),a(this,"_controllerAdded"),a(this,"_controllerRemoved"),a(this,"_originalCameraWorldPosition"),a(this,"_originalCameraWorldRotation"),a(this,"_originalCameraWorldScale"),a(this,"_originalCameraParent"),a(this,"_mainCamera",null),a(this,"onRendererSessionSet",()=>{var l;this.running&&(this.context.renderer.xr.enabled=!0,this.context.renderer.xr.updateCamera(this.context.mainCamera),(l=this.context.mainCameraComponent)==null||l.applyClearFlags())}),a(this,"onInputSourceAdded",l=>{if(l.targetRayMode==="screen")return;let c=0;for(let d=0;d<this.session.inputSources.length;d++)if(this.session.inputSources[d]===l){c=d;break}if(this.controllers.find(d=>d.inputSource===l)){console.debug("Controller already exists for input source",c);return}else if(this._newControllers.find(d=>d.inputSource===l)){console.debug("Controller already registered for input source",c);return}const h=new eg(this,l,c);this._newControllers.push(h)}),a(this,"_ended",!1),a(this,"_newControllers",[]),a(this,"onEnd",l=>{var c,h,d;if(this._ended)return;this._ended=!0,console.debug("XR Session ended"),s2(),this.onAfterRender(),this.revertCustomForward(),this._didStart=!1,this._previousCameraParent=null,ho(this.onBefore,Me.LateUpdate);const u=this.context.pre_render_callbacks.indexOf(this.onBeforeRender);u>=0&&this.context.pre_render_callbacks.splice(u,1);const p=this.context.post_render_callbacks.indexOf(this.onAfterRender);p>=0&&this.context.post_render_callbacks.splice(p,1),this.context.xr=null,this.context.renderer.xr.enabled=!1,this.context.pre_update_oneshot_callbacks.push(()=>{var y,f;(y=this.context.mainCameraComponent)==null||y.applyClearFlags(),(f=this.context.mainCameraComponent)==null||f.applyClippingPlane()}),ub({session:this});for(const y of po._xrEndListeners)y({xr:this});const g=[...this.controllers];for(let y=0;y<g.length;y++)this.disconnectInputSource(g[y].inputSource);this._newControllers.length=0,this.controllers.length=0;for(const y of this._xr_scripts)(c=y?.onLeaveXR)==null||c.call(y,{xr:this});(h=this.sync)==null||h.onExitXR(this),this.context.mainCamera&&((d=this._originalCameraParent)==null||d.add(this.context.mainCamera),this._originalCameraWorldPosition&&dt(this.context.mainCamera,this._originalCameraWorldPosition),this._originalCameraWorldRotation&&Vi(this.context.mainCamera,this._originalCameraWorldRotation),this._originalCameraWorldScale&&xa(this.context.mainCamera,this._originalCameraWorldScale)),this.context.requestSizeUpdate(),this._defaultRig.gameObject.removeFromParent(),dr(!1),performance.mark(Lb),performance.measure("NeedleXRSession",jb,Lb)}),a(this,"_didStart",!1),a(this,"onBefore",l=>{var c,h,d,u,p,g,y,f;const v=l.xrFrame;if(!v)return;performance.mark("NeedleXRSession onBefore start"),this.context.xr=this,this.context.mainCameraComponent&&this.context.mainCameraComponent!==this._mainCamera&&(this._mainCamera=this.context.mainCameraComponent),((c=this.rig)==null?void 0:c.isActive)==!1&&(vt&&console.warn("Latest rig is not active - trying to activate a different rig",this.rig),this.updateActiveXRRig()),this.rig&&(h=this._mainCamera)!=null&&h.gameObject&&((u=(d=this._mainCamera)==null?void 0:d.gameObject)==null?void 0:u.parent)!==this.rig.gameObject&&this.rig.gameObject.add((p=this._mainCamera)==null?void 0:p.gameObject),this.internalUpdateState(),this.applyCustomForward();const b={xr:this};if(this._didStart){if(this.context.new_scripts_xr.length>0){const w=[...this.context.new_scripts_xr];for(let _=0;_<w.length;_++){const S=this.context.new_scripts_xr[_];if(!S||S.destroyed||((g=S.supportsXR)==null?void 0:g.call(S,this.mode))==!1){this.context.new_scripts_xr.splice(_,1);continue}if(!S.activeAndEnabled){this.context.new_scripts_xr.splice(_,1),this.markInactive(S);continue}if(this.addScript(S)){this.invokeCallback_EnterXR(S);for(const R of this.controllers)this.invokeCallback_ControllerAdded(S,R)}}}}else{if(this._didStart=!0,this.mode==="immersive-vr"){const _=oi(this.context.scene.children);if(_){const S=_.getSize(q());if(S.length()>0){const R=this._defaultRig.gameObject;R.position.set(_.min.x+S.x*.5,_.min.y,_.max.z+S.z*.5+1.5);const M=_.getCenter(q());M.y=R.position.y,R.lookAt(M)}}}db({session:this});for(const _ of po._xrStartListeners)_(b);const w=[...this._xr_scripts];vt&&console.log("NeedleXRSession start, handle scripts:",w);for(const _ of w){if(_.destroyed){this._script_to_remove.push(_);continue}if(!_.activeAndEnabled){this.markInactive(_);continue}this.invokeCallback_EnterXR(_);for(const S of this.controllers)this.invokeCallback_ControllerAdded(_,S)}}this.syncCameraCullingMask();for(const w of this.controllers)w.onUpdate(v);if(this._newControllers.length>0){const w=[...this._newControllers];this._newControllers.length=0;for(const _ of w){if(!_.connected){console.warn("New controller is not connected",_);continue}this.controllers.push(_);for(const S of this._xr_scripts){if(S.destroyed){this._script_to_remove.push(S);continue}S.activeAndEnabled!==!1&&this.invokeCallback_ControllerAdded(S,_)}}this.controllers.sort((_,S)=>_.index-S.index)}vt&&this.context.time.frame%30===0&&this.controllers.length<=0&&this.session.inputSources.length>0&&(dr(!0),console.error("XRControllers are not added but inputSources are present")),performance.mark("NeedleXRSession update scripts start");for(const w of this._xr_update_scripts){if(w.destroyed===!0){this._script_to_remove.push(w);continue}if(w.activeAndEnabled===!1){this.markInactive(w);continue}w.onUpdateXR&&w.onUpdateXR(b)}if(performance.mark("NeedleXRSession update scripts end"),performance.measure("NeedleXRSession update scripts","NeedleXRSession update scripts start","NeedleXRSession update scripts end"),this.handleInactiveScripts(),this._script_to_remove.length>0){const w=[...new Set(this._script_to_remove)];this._script_to_remove.length=0;for(const _ of w)!_.destroyed&&this.running&&((y=_.onLeaveXR)==null||y.call(_,b)),this.removeScript(_)}(f=this.sync)==null||f.onUpdate(this),this.onRenderDebug(),performance.mark("NeedleXRSession onBefore end"),performance.measure("NE XR frame","NeedleXRSession onBefore start","NeedleXRSession onBefore end")}),a(this,"onBeforeRender",()=>{this.context.mainCamera&&this.updateFade(this.context.mainCamera)}),a(this,"onAfterRender",()=>{if(this.onUpdateFade_PostRender(),Q.isDesktop()||!this._renderOnceOnDevice){const l=this.context.renderer;if(l.xr.isPresenting&&this.context.mainCamera){this._renderOnceOnDevice=!0;const c=l.xr.enabled,h=l.getRenderTarget(),d=this.context.scene.background;l.xr.enabled=!1,l.setRenderTarget(null),this.isPassThrough&&(this.context.scene.background=null),this.context.composer?this.context.composer.render(this.context.time.deltaTime):l.render(this.context.scene,this.context.mainCamera),l.xr.enabled=c,l.setRenderTarget(h),this.context.scene.background=d}}}),a(this,"_script_to_remove",[]),a(this,"_camera"),a(this,"_cameraRenderParent",new j().rotateY(Math.PI)),a(this,"_previousCameraParent"),a(this,"_customforward",!0),a(this,"originalCameraNearPlane"),a(this,"_viewerPose"),a(this,"_transformOrientation",new V),a(this,"_transformPosition",new x),a(this,"_transition");var o,r;performance.mark(jb),n2(n,s.init),this.session=t,this.mode=n,this.context=i,(vt||C("console"))&&dr(!0),this._xr_scripts=[...s.scripts],this._xr_update_scripts=this._xr_scripts.filter(l=>typeof l.onUpdateXR=="function"),this._controllerAdded=s.controller_added,this._controllerRemoved=s.controller_removed,Ss(this.onBefore,Me.LateUpdate),this.context.pre_render_callbacks.push(this.onBeforeRender),this.context.post_render_callbacks.push(this.onAfterRender),((o=s.init.optionalFeatures)!=null&&o.includes("hit-test")||(r=s.init.requiredFeatures)!=null&&r.includes("hit-test"))&&t.requestReferenceSpace("viewer").then(l=>{var c,h;return(h=(c=t.requestHitTestSource)==null?void 0:c.call(t,{space:l}))==null?void 0:h.then(d=>this._viewerHitTestSource=d).catch(d=>console.error(d))}).catch(l=>console.error(l)),this.context.mainCamera&&(this._originalCameraWorldPosition=te(this.context.mainCamera,new x),this._originalCameraWorldRotation=Ce(this.context.mainCamera,new V),this._originalCameraWorldScale=Ye(this.context.mainCamera,new x),this._originalCameraParent=this.context.mainCamera.parent),this._defaultRig=new UP,this.context.scene.add(this._defaultRig.gameObject),this.addRig(this._defaultRig);for(let l=0;l<t.inputSources.length;l++){const c=t.inputSources[l];if(!c.handedness){console.warn("Input source in xr session has no handedness - ignoring",l);continue}this.onInputSourceAdded(c)}this.session.addEventListener("end",this.onEnd),this.session.addEventListener("inputsourceschange",l=>{for(const c of l.removed)this.disconnectInputSource(c);for(const c of l.added)this.onInputSourceAdded(c)}),this.context.xr=this,this.context.renderer.xr.setSession(this.session).then(this.onRendererSessionSet),"controllerAutoUpdate"in this.context.renderer.xr?(console.debug("Disabling three.js controllerAutoUpdate"),this.context.renderer.xr.controllerAutoUpdate=!1):vt&&console.warn("controllerAutoUpdate is not available in three.js - cannot disable it")}static getXRSync(n){return this._sync||(this._sync=new Rb(n)),this._sync}static get currentSessionRequest(){return this._currentSessionRequestMode}static get active(){return this._activeSession}static get activeMode(){var n;return((n=this._activeSession)==null?void 0:n.mode)??null}static get xrSystem(){return"xr"in navigator?navigator.xr:void 0}static isXRSupported(){return Promise.all([this.isVRSupported(),this.isARSupported()]).then(n=>n.some(t=>t)).catch(()=>!1)}static isVRSupported(){return this.isSessionSupported("immersive-vr")}static isARSupported(){return this.isSessionSupported("immersive-ar")}static isSessionSupported(n){var t;return((t=this.xrSystem)==null?void 0:t.isSessionSupported(n).catch(i=>(vt&&console.error(i),!1)))??Promise.resolve(!1)}static onSessionRequestStart(n){this._sessionRequestStartListeners.push(n)}static offSessionRequestStart(n){const t=this._sessionRequestStartListeners.indexOf(n);t>=0&&this._sessionRequestStartListeners.splice(t,1)}static onSessionRequestEnd(n){this._sessionRequestEndListeners.push(n)}static offSessionRequestEnd(n){const t=this._sessionRequestEndListeners.indexOf(n);t>=0&&this._sessionRequestEndListeners.splice(t,1)}static onXRSessionStart(n){this._xrStartListeners.push(n)}static offXRSessionStart(n){const t=this._xrStartListeners.indexOf(n);t>=0&&this._xrStartListeners.splice(t,1)}static onXRSessionEnd(n){this._xrEndListeners.push(n)}static offXRSessionEnd(n){const t=this._xrEndListeners.indexOf(n);t>=0&&this._xrEndListeners.splice(t,1)}static onControllerAdded(n){this._controllerAddedListeners.push(n)}static offControllerAdded(n){const t=this._controllerAddedListeners.indexOf(n);t>=0&&this._controllerAddedListeners.splice(t,1)}static onControllerRemoved(n){this._controllerRemovedListeners.push(n)}static offControllerRemoved(n){const t=this._controllerRemovedListeners.indexOf(n);t>=0&&this._controllerRemovedListeners.splice(t,1)}static offerSession(n,t,i){return"xr"in navigator&&navigator.xr&&"offerSession"in navigator.xr?(typeof navigator.xr.offerSession=="function"&&(console.log("WebXR offerSession is available - requesting mode: "+n),t=="default"&&(t=this.getDefaultSessionInit(n)),navigator.xr.offerSession(n,{...t}).then(s=>po.setSession(n,s,t,i)).catch(s=>{console.log("XRSession offer rejected (perhaps because another call to offerSession was made or a call to requestSession was made)")})),!0):!1}static getDefaultSessionInit(n){switch(n){case"immersive-ar":const t=["anchors","local-floor","layers","dom-overlay","hit-test","unbounded"];return Q.isVisionOS()||t.push("hand-tracking"),{optionalFeatures:t};case"immersive-vr":const i=["local-floor","bounded-floor","high-fixed-foveation-level","layers"];return Q.isVisionOS()||i.push("hand-tracking"),{optionalFeatures:i};default:return console.warn("No default session init for mode",n),{}}}static async start(n,t,i){var s,o,r,l;if(Q.isiOS()){if(n==="ar")if(await this.isARSupported())n="immersive-ar";else return mc.exportAndOpen(),null}else n=="ar"&&(n="immersive-ar");if(F()&&C("debugxrpreroom"))return console.warn("Debug: Starting temporary XR session"),await Ma.start(n,t||po.getDefaultSessionInit(n)),null;if(this._currentSessionRequest)return console.warn("A XRSession is already being requested"),(vt||F())&&we("A XRSession is already being requested"),this._currentSessionRequest.then(()=>this._activeSession);if(this._activeSession)return console.error("A XRSession is already running"),this._activeSession;if(i||(i=ee.Current),i||(i=ue.All[0]),!i)throw new Error("No Needle Engine Context found");switch(performance.mark("NeedleXRSession start"),t||(t={}),n){case"immersive-ar":{if(await((s=this.xrSystem)==null?void 0:s.isSessionSupported("immersive-ar"))!==!0)return console.error(n+" is not supported by this browser."),null;const u=this.getDefaultSessionInit(n),p=t2(i.domElement);p&&!Q.isQuest()&&(u.domOverlay={root:p},u.optionalFeatures.push("dom-overlay")),t={...u,...t}}break;case"immersive-vr":{if(await((o=this.xrSystem)==null?void 0:o.isSessionSupported("immersive-vr"))!==!0)return console.error(n+" is not supported by this browser."),null;t={...this.getDefaultSessionInit(n),...t}}break;default:console.warn("No default session init for mode",n);break}t.optionalFeatures??(t.optionalFeatures=[]),t.requiredFeatures??(t.requiredFeatures=[]),await Ma.stop();const c=n=="immersive-ar"?i.scripts_immersive_ar:i.scripts_immersive_vr;vt?console.log(`%cRequesting ${n} session`,"font-weight:bold;",t,c):console.log(`%cRequesting ${n} session`,"font-weight:bold;");for(const u of c)u.onBeforeXR&&u.onBeforeXR(n,t);for(const u of this._sessionRequestStartListeners)u({mode:n,init:t});vt&&De("Requesting "+n+" session ("+Date.now()+")"),this._currentSessionRequest=(r=navigator.xr)==null?void 0:r.requestSession(n,t),this._currentSessionRequestMode=n;const h=await((l=this._currentSessionRequest)==null?void 0:l.catch(u=>{console.error(u,"Code: "+u.code),u.code===9&&we("Make sure your device has the required permissions (e.g. camera access)"),console.log("If the specified XR configuration is not supported (e.g. entering AR doesnt work) - make sure you access the website on a secure connection (HTTPS) and your device has the required permissions (e.g. camera access)"),location.protocol==="http:"&&we("XR requires a secure connection (HTTPS)")}));this._currentSessionRequest=void 0,this._currentSessionRequestMode=null;for(const u of this._sessionRequestEndListeners)u({mode:n,init:t,newSession:h||null});if(!h)return console.warn("XR Session request was rejected"),null;const d=this.setSession(n,h,t,i);return performance.mark("NeedleXRSession end"),performance.measure("NeedleXRSession Startup","NeedleXRSession start","NeedleXRSession end"),d}static setSession(n,t,i,s){if(this._activeSession)return console.error("A XRSession is already running"),this._activeSession;const o=n=="immersive-ar"?s.scripts_immersive_ar:s.scripts_immersive_vr;return this._activeSession=new po(n,t,s,{scripts:o,controller_added:this._controllerAddedListeners,controller_removed:this._controllerRemovedListeners,init:i}),t.addEventListener("end",this.onEnd),vt?console.log(`%cStarted ${n} session`,"font-weight:bold;",o):console.log(`%cStarted ${n} session`,"font-weight:bold;"),this._activeSession}static stop(){var n;(n=this._activeSession)==null||n.end()}get sync(){return po._sync}get running(){return!this._ended&&this.session!=null}get interactionMode(){return this.session.interactionMode}get visibilityState(){return this.session.visibilityState}get isVisibleBlurred(){return this.session.visibilityState==="visible-blurred"}get isSystemKeyboardSupported(){return this.session.isSystemKeyboardSupported}get environmentBlendMode(){return this.session.environmentBlendMode}get frame(){return this.context.xrFrame}get leftController(){return this.controllers.find(n=>n.side==="left")}get rightController(){return this.controllers.find(n=>n.side==="right")}getController(n){return typeof n=="number"?this.controllers[n]||null:this.controllers.find(t=>t.side===n)||null}get isPassThrough(){return!!(this.environmentBlendMode!=="opaque"&&this.interactionMode==="world-space"||this.mode==="immersive-ar"&&this.environmentBlendMode!=="opaque"&&this.controllers.some(n=>n.inputSource.targetRayMode==="tracked-pointer")||F()&&Q.isDesktop()&&this.mode==="immersive-ar")}get isAR(){return this.mode==="immersive-ar"}get isVR(){return this.mode==="immersive-vr"}get isScreenBasedAR(){return this.isAR&&!this.isPassThrough}get posePosition(){return this._transformPosition}get poseOrientation(){return this._transformOrientation}get referenceSpace(){return this.context.renderer.xr.getReferenceSpace()}get viewerPose(){return this._viewerPose}get isTrackingImages(){if(this.frame&&"getImageTrackingResults"in this.frame&&typeof this.frame.getImageTrackingResults=="function")try{const n=this.frame.getImageTrackingResults();for(const t of n)if(t.trackingState==="tracked")return!0}catch{return!1}return!1}get rig(){const n=this._rigs[0]??null;return n!=null&&n.gameObject&&br(n.gameObject)||n?.isActive===!1?(this.updateActiveXRRig(),this._rigs[0]??null):n}get rigScale(){return this._rigs[0]?(this._lastRigScaleUpdate!==this.context.time.frame&&(this._lastRigScaleUpdate=this.context.time.frame,this._rigScale=this._rigs[0].gameObject.worldScale.x),this._rigScale):1}addRig(n){this._rigs.indexOf(n)>=0||(n.priority===void 0&&(n.priority=0),this._rigs.push(n),this.updateActiveXRRig())}removeRig(n){const t=this._rigs.indexOf(n);t!==-1&&(this._rigs.splice(t,1),this.updateActiveXRRig())}setRigActive(n){const t=this._rigs.indexOf(n),i=this._rigs[0];this._rigs.splice(t,1),this._rigs.unshift(n),n.priority=i?.priority??0,this.updateActiveXRRig()}getUserOffsetInRig(){var n;const t=(n=this.context.mainCamera)==null?void 0:n.position;if(!t||!this.rig)return q(0,0,0);const i=q(t);return i.x*=-1,i.z*=-1,i.applyQuaternion(vn(this.rig.gameObject.quaternion)),i}updateActiveXRRig(){const n=this._rigs[0]??null;this._defaultRig.gameObject.parent!==this.context.scene&&this.context.scene.add(this._defaultRig.gameObject),this._defaultRig.gameObject.visible=!0,this._rigs.includes(this._defaultRig)||this._rigs.push(this._defaultRig);let t=this._rigs[0];t&&t.priority===void 0&&(t.priority=0);for(let i=1;i<this._rigs.length;i++){const s=this._rigs[i];if(s.isActive){if(br(s.gameObject)){this._rigs.splice(i,1),i--;continue}(!t||t.isActive===!1||s.priority!==void 0&&s.priority>t.priority)&&(t=s)}}if(n!==t){const i=this._rigs.indexOf(t);i>=0&&this._rigs.splice(i,1),this._rigs.unshift(t)}vt&&(n===t?console.log("Updated Active XR Rig:",t,"prev:",n):console.log("Updated Active XRRig:",t," (the same as before)"))}getHitTest(n){if(n)return this.getControllerHitTest(n);if(!this._viewerHitTestSource)return null;const t=this._viewerHitTestSource,i=this.frame.getHitTestResults(t);if(i.length>0){const s=i[0];return this.convertHitTestResult(s)}return null}getControllerHitTest(n){const t=n.getHitTestSource();if(!t)return null;const i=this.frame.getHitTestResultsForTransientInput(t);for(const s of i)if(s.inputSource===n.inputSource)for(const o of s.results)return this.convertHitTestResult(o);return null}convertHitTestResult(n){const t=this.context.renderer.xr.getReferenceSpace(),i=t&&n.getPose(t);if(i){const s=q(i.transform.position),o=vn(i.transform.orientation),r=this.context.mainCamera;if(r?.parent!==this._cameraRenderParent&&s.applyMatrix4(Oa),r!=null&&r.parent){s.applyMatrix4(r.parent.matrixWorld),o.multiply(Gi);const l=Ce(r.parent);l.premultiply(Gi),o.premultiply(l)}return{hit:n,position:s,quaternion:o}}return null}convertSpace(n){const t=q(n.position);t.applyMatrix4(Oa);const i=vn(n.orientation);return i.premultiply(Gi),{position:t,quaternion:i}}disconnectInputSource(n){const t=(i,s,o)=>{if(i.inputSource===n){vt&&console.log("Disconnecting controller",i.index),this.controllers.splice(o,1),this.invokeControllerEvent(i,this._controllerRemoved,"removed");const r={xr:this,controller:i,change:"removed"};for(const l of this._xr_scripts)l.onXRControllerRemoved&&l.onXRControllerRemoved(r);i.onDisconnected()}};for(let i=this.controllers.length-1;i>=0;i--){const s=this.controllers[i];t(s,this.controllers,i)}for(let i=this._newControllers.length-1;i>=0;i--){const s=this._newControllers[i];t(s,this._newControllers,i)}}end(){this._ended||this.session.end().catch(n=>console.warn(n))}onRenderDebug(){if(vt)for(const n of this.controllers)n.onRenderDebug();if((vt||Db)&&this.rig&&(dg++,dg>=20)){const n=this.rig.gameObject.worldPosition,t=this.rig.gameObject.worldForward;n.add(t.multiplyScalar(1.5));const i=this.rig.gameObject.worldUp;n.add(i.multiplyScalar(2.5));let s="";if(s+=`${this.context.time.smoothedFps.toFixed(0)} FPS`,s+=`, calls: ${this.context.renderer.info.render.calls}, tris: ${this.context.renderer.info.render.triangles.toLocaleString()}`,vt||Db)for(const o of this.controllers)s+=`
${o.hand?"hand":"ctrl"} ${o.inputSource.handedness}[${o.index}] con:${o.connected} tr:${o.isTracking} hts:${o.hasHitTestSource?"yes":"no"}`;dg=0,G.DrawLabel(n,s,void 0,1/60*20)}}addScript(n){return this._xr_scripts.includes(n)?!1:(vt&&console.log("Register new XRScript",n),this._xr_scripts.push(n),typeof n.onUpdateXR=="function"&&this._xr_update_scripts.push(n),!0)}markInactive(n){if(!(this._inactive_scripts.indexOf(n)>=0)){this.removeScript(n,!1),this._inactive_scripts.push(n);for(const t of this.controllers)this.invokeCallback_ControllerRemoved(n,t);this.invokeCallback_LeaveXR(n)}}handleInactiveScripts(){if(this._inactive_scripts.length>0)for(let n=this._inactive_scripts.length-1;n>=0;n--){const t=this._inactive_scripts[n];if(t.activeAndEnabled){this._inactive_scripts.splice(n,1),this.addScript(t),this.invokeCallback_EnterXR(t);for(const i of this.controllers)this.invokeCallback_ControllerAdded(t,i)}}}removeScript(n,t=!0){vt&&console.log("Remove XRScript",n);const i=this._xr_scripts.indexOf(n);i>=0&&this._xr_scripts.splice(i,1);const s=this._xr_update_scripts.indexOf(n);if(s>=0&&this._xr_update_scripts.splice(s,1),t){const o=this._inactive_scripts.indexOf(n);o>=0&&this._inactive_scripts.splice(o,1)}}invokeCallback_EnterXR(n){n.onEnterXR&&n.onEnterXR({xr:this})}invokeCallback_ControllerAdded(n,t){n.onXRControllerAdded&&n.onXRControllerAdded({xr:this,controller:t,change:"added"})}invokeCallback_ControllerRemoved(n,t){n.onXRControllerRemoved&&n.onXRControllerRemoved({xr:this,controller:t,change:"removed"})}invokeCallback_LeaveXR(n){n.onLeaveXR&&!n.destroyed&&n.onLeaveXR({xr:this})}syncCameraCullingMask(){var n;const t=this.context.xrCamera,i=(n=this.context.mainCameraComponent)==null?void 0:n.cullingMask;if(t&&i!==void 0){for(const s of t.cameras)s.layers.mask=i;t.layers.mask=i}else if(t){for(const s of t.cameras)s.layers.enableAll();t.layers.enableAll()}}invokeControllerEvent(n,t,i){for(let s=t.length-1;s>=0;s--){const o=t[s];if(o)try{o({xr:this,controller:n,change:i})}catch(r){console.error(r)}}}applyCustomForward(){var n;if(this.context.mainCamera&&this._customforward){this._camera=this.context.mainCamera,this._camera.parent!==this._cameraRenderParent&&(this._previousCameraParent=this._camera.parent,(n=this._previousCameraParent)==null||n.add(this._cameraRenderParent)),this._cameraRenderParent.name="XR Camera Render Parent",this._cameraRenderParent.add(this._camera);let t=.02;if(this.rig){const i=Ye(this.rig.gameObject);t*=i.x}this._camera instanceof _e&&this._camera.near>t&&(this.originalCameraNearPlane=this._camera.near,this._camera.near=t)}}revertCustomForward(){this._camera&&this._previousCameraParent&&this._previousCameraParent.add(this._camera),this._previousCameraParent=null,this._camera instanceof _e&&this.originalCameraNearPlane!=null&&(this._camera.near=this.originalCameraNearPlane)}internalUpdateState(){const n=this.context.renderer.xr.getReferenceSpace();if(!n){this._viewerPose=void 0;return}if(this._viewerPose=this.frame.getViewerPose(n),this._viewerPose){const t=this._viewerPose.transform;this._transformPosition.set(t.position.x,t.position.y,t.position.z),this._transformOrientation.set(t.orientation.x,t.orientation.y,t.orientation.z,t.orientation.w)}}get transition(){return this._transition||(this._transition=new Tb),this._transition}fadeTransition(){return this._transition||(this._transition=new Tb),this._transition.fadeTransition()}updateFade(n){this._transition&&n instanceof _e&&this._transition.update(n,this.context.time.deltaTime)}onUpdateFade_PostRender(){var n;(n=this._transition)==null||n.remove()}};let J=po;a(J,"_sync",null),a(J,"_currentSessionRequestMode",null),a(J,"_currentSessionRequest"),a(J,"_activeSession"),a(J,"_sessionRequestStartListeners",[]),a(J,"_sessionRequestEndListeners",[]),a(J,"_xrStartListeners",[]),a(J,"_xrEndListeners",[]),a(J,"_controllerAddedListeners",[]),a(J,"_controllerRemovedListeners",[]),a(J,"onEnd",()=>{vt&&console.log("XR Session ended"),po._activeSession=null});const pg=C("debugwebxr");class Fb{static tryFindAvatarObjects(t,i,s){if(s.head&&s.leftHand&&s.rightHand)return;const o=t.name.toLocaleLowerCase();!s.head&&o.includes("head")&&(pg&&console.log("FOUND AVATAR HEAD",t.name),s.head=new le("",i,t)),o.includes("hand")&&(!s.leftHand&&o.includes("left")&&(pg&&console.log("FOUND AVATAR LEFT HAND",t.name),s.leftHand=new le("",i,t)),!s.rightHand&&o.includes("right")&&(pg&&console.log("FOUND AVATAR RIGHT HAND",t.name),s.rightHand=new le("",i,t)));for(let r=0;r<t.children.length;r++){if(s.head&&s.leftHand&&s.rightHand)return;const l=t.children[r];this.tryFindAvatarObjects(l,i,s)}}}const zt=new x,zb=new x,Ub=new V,r2=C("debuggizmos"),xn=8947848,mg=32,Sn=class{constructor(){}static isGizmo(n){return n[fg]!==void 0}static setVisible(n){for(const t of Ae.timedObjectsBuffer)t.visible=n}static DrawLabel(n,t,i=.05,s=0,o,r,l){var c;if(!Sn.enabled)return null;o||(o=xn);const h=((c=J.active)==null?void 0:c.rigScale)??1,d=Ae.getTextLabel(s,t,i*h,o,r);return l instanceof j&&l.add(d),d.position.x=n.x,d.position.y=n.y,d.position.z=n.z,d}static DrawRay(n,t,i=xn,s=0,o=!0){if(!Sn.enabled)return;const r=Ae.getLine(s),l=r.geometry.getAttribute("position");l.setXYZ(0,n.x,n.y,n.z),zt.set(t.x,t.y,t.z).multiplyScalar(999999999),l.setXYZ(1,n.x+zt.x,n.y+zt.y,n.z+zt.z),l.needsUpdate=!0,r.material.color.set(i),r.material.depthTest=o,r.material.depthWrite=!1}static DrawDirection(n,t,i=xn,s=0,o=!0,r=1){if(!Sn.enabled)return;const l=Ae.getLine(s),c=l.geometry.getAttribute("position");c.setXYZ(0,n.x,n.y,n.z),t.w!==void 0?(zt.set(0,0,-r),Ub.set(t.x,t.y,t.z,t.w),zt.applyQuaternion(Ub)):(zt.set(t.x,t.y,t.z),zt.multiplyScalar(r)),c.setXYZ(1,n.x+zt.x,n.y+zt.y,n.z+zt.z),c.needsUpdate=!0,l.material.color.set(i),l.material.depthTest=o,l.material.depthWrite=!1}static DrawLine(n,t,i=xn,s=0,o=!0){if(!Sn.enabled)return;const r=Ae.getLine(s),l=r.geometry.getAttribute("position");l.setXYZ(0,n.x,n.y,n.z),l.setXYZ(1,t.x,t.y,t.z),l.needsUpdate=!0,r.material.color.set(i),r.material.depthTest=o,r.material.depthWrite=!1,r.material.fog=!1}static DrawCircle(n,t,i,s=xn,o=0,r=!0){if(!Sn.enabled)return;const l=Ae.getCircle(o);l.position.set(n.x,n.y,n.z),l.scale.set(i,i,i),l.quaternion.setFromUnitVectors(this._up,zt.set(t.x,t.y,t.z).normalize()),l.material.color.set(s),l.material.depthTest=r,l.material.depthWrite=!1,l.material.fog=!1}static DrawWireSphere(n,t,i=xn,s=0,o=!0){if(!Sn.enabled)return;const r=Ae.getSphere(t,s,!0);cr(r,n.x,n.y,n.z),r.material.color.set(i),r.material.depthTest=o,r.material.depthWrite=!1,r.material.fog=!1}static DrawSphere(n,t,i=xn,s=0,o=!0){if(!Sn.enabled)return;const r=Ae.getSphere(t,s,!1);cr(r,n.x,n.y,n.z),r.material.color.set(i),r.material.depthTest=o,r.material.depthWrite=!1}static DrawWireBox(n,t,i=xn,s=0,o=!0){if(!Sn.enabled)return;const r=Ae.getBox(s);r.position.set(n.x,n.y,n.z),r.scale.set(t.x,t.y,t.z),r.material.color.set(i),r.material.depthTest=o,r.material.wireframe=!0,r.material.depthWrite=!1,r.material.fog=!1}static DrawWireBox3(n,t=xn,i=0,s=!0){if(!Sn.enabled)return;const o=Ae.getBox(i);o.position.copy(n.getCenter(zt)),o.scale.copy(n.getSize(zt)),o.material.color.set(t),o.material.depthTest=s,o.material.wireframe=!0,o.material.depthWrite=!1,o.material.fog=!1}static DrawArrow(n,t,i=xn,s=0,o=!0,r=!1){if(!Sn.enabled)return;const l=Ae.getArrowHead(s);l.position.set(t.x,t.y,t.z),l.quaternion.setFromUnitVectors(this._up.set(0,1,0),zt.set(t.x,t.y,t.z).sub(zb.set(n.x,n.y,n.z)).normalize());const c=zt.set(t.x,t.y,t.z).sub(zb.set(n.x,n.y,n.z)).length()*.1;l.scale.set(c,c,c),l.material.color.set(i),l.material.depthTest=o,l.material.wireframe=r,this.DrawLine(n,t,i,s,o)}static DrawWireMesh(n){const t=Ae.getMesh(n.duration??0);"mesh"in n?(t.geometry=n.mesh.geometry,t.matrix.copy(n.mesh.matrixWorld)):(t.geometry=n.geometry,t.matrix.copy(n.matrix)),t.matrixAutoUpdate=!1,t.matrixWorldAutoUpdate=!1,t.material.color.set(n.color??xn),t.material.depthTest=n.depthTest??!0,t.material.wireframe=!0}};let G=Sn;a(G,"enabled",!0),a(G,"_up",new x(0,1,0));const a2=new ma(1,1,1);function gg(n=null){const t=new ae(n??14540253),i=new bS(a2);return new Vy(i,new Hy({color:t}))}const fg=Symbol("GizmoCache");class Ae{static ensureFont(){let t=Te.FontLibrary.getFontFamily(this.familyName);if(!t){t=Te.FontLibrary.addFontFamily(this.familyName);const i=t.addVariant("normal","normal","https://uploads.needle.tools/include/font-msdf.json","https://uploads.needle.tools/include/font.png");i?.addEventListener("ready",()=>{Te.update()})}}static getTextLabel(t,i,s,o,r){this.ensureFont();let l=this.textLabelCache.pop(),c=1;r&&typeof r=="string"&&r?.length>=8&&r.startsWith("#")?(c=parseInt(r.substring(7),16)/255,r=r.substring(0,7),r2&&console.log(r,c)):typeof r=="object"&&r.a!==void 0&&(c=r.a);const h={boxSizing:"border-box",fontFamily:this.familyName,width:"auto",fontSize:s,color:o,lineHeight:1,backgroundColor:r??void 0,backgroundOpacity:c,textContent:i,borderRadius:.5*s,padding:.8*s,whiteSpace:"pre",offset:.05*s};if(l)l.set(h);else{l=new uv(h);const d=this,u=l;u.setText=function(p){this.set({textContent:p}),d.tmuiNeedsUpdate=!0}}return this.tmuiNeedsUpdate=!0,this.registerTimedObject(ee.Current,l,t,this.textLabelCache),l}static getBox(t){let i=this.boxesCache.pop();if(!i){const s=new ma(1,1,1);i=new X(s)}return this.registerTimedObject(ee.Current,i,t,this.boxesCache),i}static getLine(t){let i=this.linesCache.pop();if(!i){i=new ql;let s=i.geometry.getAttribute("position");s||(s=new yt(new Float32Array(2*3),3),i.geometry.setAttribute("position",s))}return i.frustumCulled=!1,this.registerTimedObject(ee.Current,i,t,this.linesCache),i}static getCircle(t){let i=this.circlesCache.pop();if(!i){i=new ql;let s=i.geometry.getAttribute("position");if(!s){s=new yt(new Float32Array(mg*3),3),i.geometry.setAttribute("position",s);const o=q(0,1,0),r=q(0,0,1),l=q(r);l.cross(o).normalize();const c=q(l),h=Math.PI*2/(mg-1);for(let d=0;d<mg+1;d++){const u=h*d;o.copy(c).multiplyScalar(Math.cos(u)*1),l.copy(r).multiplyScalar(Math.sin(u)*1);const p=o.add(l);s.setXYZ(d,p.x,p.y,p.z)}}}return i.frustumCulled=!1,this.registerTimedObject(ee.Current,i,t,this.circlesCache),i}static getSphere(t,i,s){let o=this.spheresCache.pop();return o||(o=new X(new sd(1,8,8))),o.scale.set(t,t,t),o.material.wireframe=s,this.registerTimedObject(ee.Current,o,i,this.spheresCache),o}static getArrowHead(t){let i=this.arrowHeadsCache.pop();return i||(i=new X(new vS(0,.5,1,8))),this.registerTimedObject(ee.Current,i,t,this.arrowHeadsCache),i}static getMesh(t){let i=this.mesh.pop();return i||(i=new X,i.material=new Re),this.registerTimedObject(ee.Current,i,t,this.mesh),i}static registerTimedObject(t,i,s,o){if(!t){console.error("No Needle Engine context available. Did you call a Gizmos function in global scope?");return}const r=this.contextBeforeRenderCallbacks.get(t),l=this.contextPostRenderCallbacks.get(t);if(r){if(t.pre_render_callbacks[t.pre_render_callbacks.length-1]!==r){const c=t.pre_render_callbacks.indexOf(r);c>=0&&t.pre_render_callbacks.splice(c,1),t.pre_render_callbacks.push(r)}}else{const c=()=>{this.onBeforeRender(t,this.timedObjectsBuffer)};this.contextBeforeRenderCallbacks.set(t,c),t.pre_render_callbacks.push(c)}if(l){if(t.post_render_callbacks[t.post_render_callbacks.length-1]!==l){const c=t.post_render_callbacks.indexOf(l);c>=0&&t.post_render_callbacks.splice(c,1),t.post_render_callbacks.push(l)}}else{const c=()=>{this.onPostRender(t,this.timedObjectsBuffer,this.timesBuffer)};this.contextPostRenderCallbacks.set(t,c),t.post_render_callbacks.push(c)}i.traverse(c=>{c.layers.disableAll(),c.layers.enable(2)}),i.renderOrder=999999,i[fg]=o,i.castShadow=!1,i.receiveShadow=!1,i.isGizmo=!0,this.timedObjectsBuffer.push(i),this.timesBuffer.push(ee.Current.time.realtimeSinceStartup+s),t.scene.add(i)}static onBeforeRender(t,i){this.tmuiNeedsUpdate&&(this.tmuiNeedsUpdate=!1,Te.update());for(let s=0;s<i.length;s++){const o=i[s];if(t.mainCamera&&o instanceof Te.MeshUIBaseElement){if(br(o))continue;const r=t.isInVR,l=!1,c=!r;tc(o,t.mainCamera,l,c)}}}static onPostRender(t,i,s){const o=t.time.realtimeSinceStartup;for(let r=i.length-1;r>=0;r--){const l=i[r];o>=s[r]-1e-6&&(i.splice(r,1),s.splice(r,1),l.removeFromParent(),br(l)!=!0&&l[fg].push(l))}}}a(Ae,"familyName","needle-gizmos"),a(Ae,"linesCache",[]),a(Ae,"circlesCache",[]),a(Ae,"spheresCache",[]),a(Ae,"boxesCache",[]),a(Ae,"arrowHeadsCache",[]),a(Ae,"mesh",[]),a(Ae,"textLabelCache",[]),a(Ae,"timedObjectsBuffer",new Array),a(Ae,"timesBuffer",new Array),a(Ae,"contextPostRenderCallbacks",new Map),a(Ae,"contextBeforeRenderCallbacks",new Map),a(Ae,"tmuiNeedsUpdate",!1);const Mi=C("debugphysics"),Nb=new io;class Vn{constructor(){a(this,"ray"),a(this,"cam"),a(this,"screenPoint"),a(this,"raycaster"),a(this,"results"),a(this,"targets"),a(this,"recursive",!0),a(this,"minDistance"),a(this,"maxDistance"),a(this,"lineThreshold"),a(this,"layerMask"),a(this,"ignore"),a(this,"testObject"),a(this,"useAcceleratedRaycast")}screenPointFromOffset(t,i){this.screenPoint===void 0&&(this.screenPoint=new re),this.screenPoint.x=t/window.innerWidth*2-1,this.screenPoint.y=-(i/window.innerHeight)*2+1}setLayer(t){Nb.set(t),this.layerMask=Nb}setMask(t){this.layerMask||(this.layerMask=new io);const i=this.layerMask;i?i.mask=t:this.layerMask=t}}a(Vn,"AllLayers",4294967295);class yg{constructor(t,i,s){a(this,"distance"),a(this,"point"),a(this,"object"),this.object=t,this.distance=i,this.point=s}}const vg=class{constructor(n){a(this,"context"),a(this,"engine"),a(this,"raycaster",new rd),a(this,"defaultRaycastOptions",new Vn),a(this,"targetBuffer",new Array(1)),a(this,"defaultThresholds",{Mesh:{},Line:{threshold:-1},LOD:{},Points:{threshold:0},Sprite:{}}),a(this,"sphereResults",new Array),a(this,"sphereMask",new io),a(this,"sphere",new od),a(this,"tempBoundingBox",new xi),this.context=n}static get raycasting(){return this._raycasting>0}raycastPhysicsFast(n,t=void 0,i=1/0,s=!0){var o;return((o=this.context.physics.engine)==null?void 0:o.raycast(n,t,{maxDistance:i,solid:s}))??null}raycastPhysicsFastAndGetNormal(n,t=void 0,i=1/0,s=!0){var o;return((o=this.context.physics.engine)==null?void 0:o.raycastAndGetNormal(n,t,{maxDistance:i,solid:s}))??null}sphereOverlapPhysics(n,t){var i;return((i=this.context.physics.engine)==null?void 0:i.sphereOverlap(n,t))??null}sphereOverlap(n,t,i=!0,s=!1,o=null){if(this.sphereResults.length=0,!this.context.scene)return this.sphereResults;const r=this.sphereMask;r.enableAll(),r.disable(2);for(const l of this.context.scene.children)this.intersectSphere(l,n,t,r,this.sphereResults,i,s,o);return this.sphereResults.sort((l,c)=>l.distance-c.distance)}raycastFromRay(n,t=null){const i=t??this.defaultRaycastOptions;i.ray=n;const s=this.raycast(i);return i===this.defaultRaycastOptions&&(i.ray=void 0),s}raycast(n=null){Mi&&performance.mark("raycast.start"),n||(n=this.defaultRaycastOptions);const t=n.screenPoint??this.context.input.mousePositionRC,i=n.raycaster??this.raycaster;if(i.near=n.minDistance??0,i.far=n.maxDistance??1/0,i.params=this.defaultThresholds,n.lineThreshold===void 0&&(n.lineThreshold=-1),i.params.Line={threshold:n.lineThreshold},n.ray)i.ray.copy(n.ray);else{const l=n.cam??this.context.mainCamera;if(!l)return Mi&&console.error("Can not perform raycast - no main camera found"),this.defaultRaycastOptions.results&&(this.defaultRaycastOptions.results.length=0),this.defaultRaycastOptions.results??[];const c=this.context.xrCamera;this.context.isInXR&&c instanceof _S&&c.cameras.length>0?i.setFromCamera(t,c.cameras[0]):i.setFromCamera(t,l)}let s=n.targets;s||(s=this.targetBuffer,s.length=1,s[0]=this.context.scene);let o=n.results;this.defaultRaycastOptions.results&&(this.defaultRaycastOptions.results.length=0),o||(this.defaultRaycastOptions.results||(this.defaultRaycastOptions.results=new Array),o=this.defaultRaycastOptions.results),n.layerMask!==void 0?n.layerMask instanceof io?i.layers.mask=n.layerMask.mask:i.layers.mask=n.layerMask:(i.layers.enableAll(),i.layers.disable(2)),Mi&&console.time("raycast"),o.length=0,vg._raycasting++,this.intersect(this.raycaster,s,o,n),o.sort((l,c)=>l.distance-c.distance);const r=n.ignore;return r!==void 0&&r.length>0&&(o=o.filter(l=>!r.includes(l.object))),vg._raycasting--,Mi&&(console.timeEnd("raycast"),console.warn("#"+this.context.time.frame+", hits:",o!=null&&o.length?[...o]:"nothing"),performance.mark("raycast.end"),performance.measure("raycast","raycast.start","raycast.end")),o}intersect(n,t,i,s){var o,r,l;for(const c of t){if(!c||c.visible===!1||G.isGizmo(c)||s.lineThreshold!==void 0&&s.lineThreshold<0&&c instanceof ql)continue;let h=!0;const d=c,u=d.geometry;if(s.testObject){const p=(o=s.testObject)==null?void 0:o.call(s,c);if(p===!1)continue;p==="continue in children"&&(h=!1)}if(h&&(u&&Wb(u)||(h=!1)),h){const p=tv(c);p&&(d.geometry=p);const g=i.length;let y=!0;if(s.precise===!1&&(y=!1),y||(y=((l=(r=u.getAttribute("position"))==null?void 0:r.array)==null?void 0:l.length)<64),d instanceof ba&&(y=!1),!y&&c2(d,n,i)||(s.useAcceleratedRaycast!==!1?jd.runMeshBVHRaycast(n,d,i,this.context):n.intersectObject(d,!1,i)),Mi&&i.length!=g){const f=i[i.length-1],v=p?8969557:7798784;G.DrawWireSphere(f.point,.1,v,1,!1),G.DrawWireMesh({mesh:c,depthTest:!1,duration:.2,color:v})}d.geometry=u}s.recursive!==!1&&this.intersect(n,c.children,i,s)}return i}intersectSphere(n,t,i,s,o,r,l,c){let h=n&&n.isMesh&&n.layers.test(s)&&!G.isGizmo(n);h&&(h=n.visible),h&&(h=!(n instanceof ql)),h&&(h=!(n instanceof ba));const d=n,u=d.geometry;if(h&&c){const p=c(n);if(p===!1)return;p==="continue in children"&&(h=!1)}if(u&&Wb(u)||(h=!1),h){if(l){const p=this.sphere;p.center.copy(t),p.radius=i;const g=o.length;if(jd.runMeshBVHRaycast(this.sphere,d,o,this.context),g!=o.length&&!r)return}else if(u.boundingBox||u.computeBoundingBox(),u.boundingBox){d.matrixWorldNeedsUpdate&&d.updateWorldMatrix(!1,!1);const p=this.tempBoundingBox.copy(u.boundingBox).applyMatrix4(d.matrixWorld),g=this.sphere;if(g.center.copy(t),g.radius=i,g.intersectsBox(p)){const y=te(n),f=y.distanceTo(g.center),v=new yg(n,f,y);if(o.push(v),!r)return}}}if(n.children)for(const p of n.children){const g=o.length;if(this.intersectSphere(p,t,i,s,o,r,l,c),g!=o.length&&!r)return}}};let Ad=vg;a(Ad,"_raycasting",0);function Wb(n){return!(n.index&&n.index.array.length<3)}const mr=new od,Id=new or,l2=new Ny;function c2(n,t,i){const s=n._computeIntersections;if(!s)return!1;let o=n["_computeIntersections:Needle"];return o||(o=n["_computeIntersections:Needle"]=function(r,l,c){const h=this,d=h.geometry.boundingSphere;if(d){if(h instanceof ba){Id.setFromNormalAndCoplanarPoint(q(0,1,0),q(0,-h.position.y,0)),Id.applyMatrix4(h.matrixWorld,l2);const p=r.ray.intersectPlane(Id,q());if(p){mr.copy(d),mr.applyMatrix4(h.matrixWorld);const g=q(p).sub(r.ray.origin).length(),y=mr.radius*.5;g<y&&l.push({distance:g,point:p,object:h,normal:Id.normal.clone()})}return}mr.copy(d),mr.applyMatrix4(h.matrixWorld);const u=r.ray.intersectSphere(mr,q());if(u){const p=q(u).sub(r.ray.origin),g=p.length();if(g>mr.radius){const y=p.clone().normalize();l.push({distance:g,point:u,object:h,normal:y})}}}}),n._computeIntersections=o,t.intersectObject(n,!1,i),n._computeIntersections=s,!0}var jd;(n=>{function t(w,_,S,R){var M,T,L;if(!_.geometry||!_.geometry.hasAttribute("position"))return!1;const D=_.geometry;if(_!=null&&_.isSkinnedMesh){const U=_,B=U.bvhNeedsUpdate;if(!U.staticGenerator)c(),r&&(U.staticGenerator=new r(_),U.staticGenerator.applyWorldTransforms=!1,U.staticGeometry=U.staticGenerator.generate(),D.boundsTree=l?.call(U.staticGeometry),U.staticGeometryLastUpdate=performance.now()+Math.random()*200,U.autoUpdateMeshBVH===void 0&&(U.autoUpdateMeshBVH=!1));else if(D.boundsTree&&(U.autoUpdateMeshBVH===!0||B===!0)){const Y=performance.now(),$=Y-U.staticGeometryLastUpdate;(B||$>100)&&(U.bvhNeedsUpdate=!1,U.staticGeometryLastUpdate=Y,(M=U.staticGenerator)==null||M.generate(U.staticGeometry),D.boundsTree.refit())}}else if(!D.boundsTree){d||b();let U=!0;if((R.xr||D[y]===!1||(T=D.getAttribute("position"))!=null&&T.isInterleavedBufferAttribute||D.index&&(L=D.index)!=null&&L.isInterleavedBufferAttribute)&&(U=!1),U&&p){if(D[g]===void 0){let B=null;if(v.length>0){const Y=v.shift();Y&&!Y.running&&(B=Y)}if(!B&&f.length<3&&(B=new p,f.push(B)),B!=null&&!B.running){const Y=_.name;Mi&&console.log("<<<< worker start",Y,B),D[g]="queued",performance.mark("bvh.create.start");const $=D.clone();try{B.generate($).then(E=>{D[g]="done",D.boundsTree=E}).catch(E=>{D[g]="failed - "+E?.message,D[y]=!1,Mi&&console.error("Failed to generate mesh bvh on worker",E)}).finally(()=>{Mi&&console.log(">>>>> worker done",Y,{hasBoundsTre:D.boundsTree!=null}),v.push(B),$.dispose(),performance.mark("bvh.create.end"),performance.measure("bvh.create (worker)","bvh.create.start","bvh.create.end")})}catch(E){console.error("Failed to generate mesh bvh on worker",E)}}else Mi&&console.warn("No worker available")}}else(!u||!U)&&(c(),o&&(performance.mark("bvh.create.start"),D.boundsTree=new o(D),performance.mark("bvh.create.end"),performance.measure("bvh.create","bvh.create.start","bvh.create.end")))}if(w instanceof rd){const U=w,B=_.raycast;D.boundsTree?(c(),s&&(_.acceleratedRaycast||(_.acceleratedRaycast=s.bind(_),Mi&&console.debug(`Physics: bind acceleratedRaycast fn to "${_.name}"`)),_.raycast=_.acceleratedRaycast)):Mi&&console.warn("No bounds tree found for mesh",_.name,{workerTask:D[g],hasAcceleratedRaycast:s!=null});const Y=U.firstHitOnly;return U.firstHitOnly=!1,U.intersectObject(_,!1,S),U.firstHitOnly=Y,_.raycast=B,!0}else if(w instanceof od){const U=D.boundsTree;if(U){const B=w;if(h.copy(_.matrixWorld).invert(),B.applyMatrix4(h),U.intersectsSphere(B)){const Y=te(_),$=Y.distanceTo(B.center),E=new yg(_,$,Y);S.push(E)}}return!0}return!1}n.runMeshBVHRaycast=t;let i=!1,s=null,o=null,r=null,l=null;function c(){i||(i=!0,import("./vendor.min.js").then(w=>w.index$1).then(w=>{s=w.acceleratedRaycast,o=w.MeshBVH,r=w.StaticGeometryGenerator,l=w.computeBoundsTree}).catch(w=>{(Mi||F())&&console.error("Failed to load BVH library...",w.message)}))}const h=new se;let d=!1,u=!1,p=null;const g=Symbol("Needle:MeshBVH-Worker"),y=Symbol("Needle:MeshBVH-CanUseWorker"),f=[],v=[];function b(){d=!0,u=!0,Promise.resolve().then(()=>eL).then(w=>{p=w.GenerateMeshBVHWorker}).catch(w=>{(Mi||F())&&console.warn("Failed to setup mesh bvh worker")}).finally(()=>{u=!1})}})(jd||(jd={}));const Vb=Symbol("gltf-loader-internal-usage-tracker"),h2=C("debugusers"),Ld=class{constructor(n){a(this,"parser"),a(this,"_getDependency"),a(this,"_loadingId"),a(this,"_loadedObjects",new Set),this.parser=n,this._getDependency=this.parser.getDependency,this._loadingId=Date.now().toString()}get name(){return"NEEDLE_internal_usage_tracker"}static isLoading(n){return Ld._loadingProcesses>0}beforeRoot(){Ld._loadingProcesses++;const n=this,t=this._getDependency;return this.parser.getDependency=function(i,s){const o=t.call(this,i,s);return o.then(r=>(r&&(n._loadedObjects.add(r),r[Vb]=n._loadingId),r)),o},null}afterRoot(n){Ld._loadingProcesses--,this.parser.getDependency=this._getDependency;for(const t of this._loadedObjects)delete t[Vb],t instanceof j&&(t.parent||t instanceof X&&setTimeout(()=>{h2&&console.warn("> GLTF LOADER: Mesh not used in scene!",t),t.material=null,t.geometry=null},1e3));return null}};let bg=Ld;a(bg,"_loadingProcesses",0);class Hb{constructor(){window.addEventListener("unhandledrejection",t=>{var i;if(t.defaultPrevented)return;const s=(i=t?.reason)==null?void 0:i.path;if(s){const o=s[0];o&&o.tagName==="IMG"&&(console.warn(`Could not load image:
`+o.src),t.preventDefault())}})}}const Dd=C("trackresources");function $b(){return Dd==="dispose"}let gr=!0;Dd===0&&(gr=!1);function d2(n){gr=n}function Gb(){return gr}const qb=Symbol("disposable");function _g(n,t){n&&(n[qb]=t,fr&&console.warn("Set disposable",t,n))}const Xb=Symbol("disposed");function u2(n){return n[Xb]===!0}function Ee(n){var t;if(n){if(n[qb]===!1){fr&&console.warn("Object is marked as not disposable",n);return}if(n[Xb]=!0,n instanceof wi)Ee(n.environment),Ee(n.background),Ee(n.customDepthMaterial),Ee(n.customDistanceMaterial);else if(n instanceof fs)Ee(n.geometry),Ee(n.material),Ee(n.skeleton),Ee(n.bindMatrix),Ee(n.bindMatrixInverse),Ee(n.customDepthMaterial),Ee(n.customDistanceMaterial),n.geometry=null,n.material=null,n.visible=!1;else if(n instanceof X)Ee(n.geometry),Ee(n.material),Ee(n.customDepthMaterial),Ee(n.customDistanceMaterial),n.geometry=null,n.material=null,n.visible=!1;else if(n instanceof gs){Ra(n);for(const i of Object.keys(n.attributes)){const s=n.attributes[i];Ee(s)}}else if(n instanceof yt||n instanceof $y)fr&&console.warn("BufferAttribute dispose not supported",n.count);else if(n instanceof Array)for(const i of n)i instanceof ke&&Ee(i);else if(n instanceof ke){Ra(n);for(const s of Object.keys(n)){const o=n[s];o instanceof Le&&(Ee(o),n[s]=null)}const i=n.uniforms;if(i)for(const s of Object.keys(i)){const o=i[s];o instanceof Le?(Ee(o),i[s]=null):o instanceof to&&(Ee(o.value),o.value=null)}}else n instanceof Le?(Ra(n),Ra(n.source),((t=n.source)==null?void 0:t.data)instanceof ImageBitmap&&Ra(n.source.data)):n instanceof wS?(Ra(n.boneTexture),n.boneTexture=null):n instanceof xS||!(n instanceof j)&&fr&&console.warn("Unknown object type",n)}}function Ra(n){n&&((fr||$b()||Dd)&&console.warn("\u{1F9E8} FREE",n),n instanceof ImageBitmap?n.close():n instanceof SS?n.data=null:n.dispose())}function Qb(n){(n instanceof X||n instanceof fs)&&(n.material=null,n.geometry=null)}const p2=new Set;function wg(n,t,i=null,s){if(s||(s=p2,s.clear()),!n)return s;const o=n[gc];if(o)for(const r of o)s.has(r)||i?.call(null,r)!==!1&&(s.add(r),t&&wg(r,!0,i,s));return s}function m2(n){return n[fc]}const fr=C("debugresourceusers")||C("debugmemory"),gc=Symbol("needle-resource-users"),fc=Symbol("needle-resource-users-count");function Qt(n,t){Cd(n,t,function(i,s){gr&&!Ad.raycasting&&(Bd(gc,this,i,!1),Bd(gc,this,s,!0))})}gr&&(Qt(X.prototype,"material"),Qt(X.prototype,"geometry"),Qt(ke.prototype,"map"),Qt(ke.prototype,"bumpMap"),Qt(ke.prototype,"alphaMap"),Qt(ke.prototype,"normalMap"),Qt(ke.prototype,"displacementMap"),Qt(ke.prototype,"roughnessMap"),Qt(ke.prototype,"metalnessMap"),Qt(ke.prototype,"emissiveMap"),Qt(ke.prototype,"specularMap"),Qt(ke.prototype,"envMap"),Qt(ke.prototype,"lightMap"),Qt(ke.prototype,"aoMap"),Qt(ke.prototype,"gradientMap"));function g2(n){if(gr===!1)return;const t=n[gc];if(t)for(const i of t)Bd(gc,i,n,!1)}gr&&Cd(ke.prototype,"dispose",function(){g2(this)});let xg=0;function Bd(n,t,i,s){if(xg>0)return;if(Array.isArray(i)){for(const r of i)Bd(n,t,r,s);return}if(!i)return;let o=i[n];if(o||(o=new Set),s){if(t&&!o.has(t)){o.add(t);let r=i[fc]||0;r+=1,i[fc]=r,fr&&console.warn(`\u{1F7E2} Added user of "${i.type}"`,t,i,r,"users:",o)}}else if(t&&o.has(t)){o.delete(t);let r=i[fc]||0;r>0&&(r-=1,i[fc]=r),fr&&console.warn(`\u{1F534} Removed user of "${i.type}"`,t,i,r,"users:",o),r<=0&&(bg.isLoading(i)||(Dd&&console.warn(`\u{1F534} Removed all user of "${i.type}"`,i),$b()&&Ee(i)))}i[n]=o}try{Cd(sr.prototype,"render",function(){xg++},function(){xg--})}catch(n){console.warn("Could not wrap WebGLRenderer.render",n)}const Yb=C("debugcomponentevents");class yc{static addComponentLifecylceEventListener(t,i){this.eventListeners.has(t)&&this.eventListeners.set(t,[]);let s=this.eventListeners.get(t);s||(s=[]),s.push(i),this.eventListeners.set(t,s),Yb&&console.log("Added event listener for "+t,this.eventListeners)}static removeComponentLifecylceEventListener(t,i){const s=this.eventListeners.get(t);if(!s)return;const o=s.indexOf(i);o<0||s.splice(o,1)}static dispatchComponentLifecycleEvent(t,i){const s=this.eventListeners.get(t);if(Yb&&console.log("Dispatching event "+t,s),!!s)for(const o of s)o(i)}}a(yc,"eventListeners",new Map);const vc=Symbol("NEEDLE_NEED_UPDATE_INSTANCE"),Zb=Symbol("isUsingInstancing"),Kb=Symbol("instancingRenderer"),bc=Symbol("instancingAutoUpdateBounds");class an{static isUsingInstancing(t){return t[Zb]===!0}static getRenderer(t){return t[Kb]||null}setAutoUpdateBounds(t,i){const s=an.getRenderer(t);s&&(s[bc]=i)}static markDirty(t,i=!0){if(t&&(this.isUsingInstancing(t)&&(t[vc]=!0,t.matrixWorldNeedsUpdate=!0),i))for(const s of t.children)an.markDirty(s,!0)}}function Ta(n,t){try{t?n(t):n()}catch(i){return console.error(i),!1}return!0}const Sg=C("debugnewscripts"),f2=C("debughierarchy"),Fe=[];function y2(){return Fe.length>0}function Fd(n){if(Sg&&console.log("Register new components",n.new_scripts.length,[...n.new_scripts],n.alias?"element: "+n.alias:n.hash,n),n.new_scripts_pre_setup_callbacks.length>0){for(const t of n.new_scripts_pre_setup_callbacks)t&&t();n.new_scripts_pre_setup_callbacks.length=0}if(!(n.new_scripts.length<=0)){Fe.length=0,n.new_scripts.length>0&&Fe.push(...n.new_scripts),n.new_scripts.length=0;for(let t=0;t<Fe.length;t++)try{const i=Fe[t];if(i.isComponent!==!0){(F()||Sg)&&console.error(`Registered script is not a Needle Engine component. 
The script will be ignored. Please make sure your component extends "Behaviour" imported from "@needle-tools/engine"
`,i),Fe.splice(t,1),t--;continue}if(i.destroyed)continue;if(!i.gameObject){console.warn(`Component can not be initialized: no GameObject assigned.
Did you add and remove a component in the same frame?`),Fe.splice(t,1),t--;continue}i.context=n,_c(i.gameObject),Cg(i,n)}catch(i){console.error(i),Cs(Fe[t],n),Fe.splice(t,1),t--}for(let t=0;t<Fe.length;t++)try{const i=Fe[t];if(i.destroyed){Cs(Fe[t],n),Fe.splice(t,1),t--;continue}if(i.registering)try{i.registering()}catch(s){console.error(s)}i.__internalAwake!==void 0&&(i.gameObject||console.error("Calling awake for a component without a GameObject",i,i.gameObject),_c(i.gameObject),i.activeAndEnabled&&Ta(i.__internalAwake.bind(i)))}catch(i){console.error(i),Cs(Fe[t],n),Fe.splice(t,1),t--}for(let t=0;t<Fe.length;t++)try{const i=Fe[t];if(i.destroyed||i.enabled===!1||(_c(i.gameObject),i.activeAndEnabled===!1))continue;i.__internalEnable!==void 0&&(i.enabled=!0,Ta(i.__internalEnable.bind(i)))}catch(i){console.error(i),Cs(Fe[t],n),Fe.splice(t,1),t--}for(let t=0;t<Fe.length;t++)try{const i=Fe[t];if(i.destroyed||!i.gameObject)continue;n.new_script_start.push(i)}catch(i){console.error(i),Cs(Fe[t],n),Fe.splice(t,1),t--}Fe.length=0;for(const t of n.new_scripts_post_setup_callbacks)t&&t();n.new_scripts_post_setup_callbacks.length=0}}function v2(n){n&&(n.__internalDisable(!0),Cs(n,n.context))}function Jb(n,t){for(let i=0;i<n.new_script_start.length;i++)try{const s=n.new_script_start[i];if(t!==void 0&&s.gameObject!==t||s.destroyed||s.activeAndEnabled===!1)continue;Ta(s.__internalAwake.bind(s)),s.enabled&&(Ta(s.__internalEnable.bind(s)),Ta(s.__internalStart.bind(s)),n.new_script_start.splice(i,1),i--)}catch(s){console.error(s),Cs(n.new_script_start[i],n),n.new_script_start.splice(i,1),i--}}function Cg(n,t){t.scripts.indexOf(n)===-1&&(t.scripts.push(n),n.earlyUpdate&&t.scripts_earlyUpdate.push(n),n.update&&t.scripts_update.push(n),n.lateUpdate&&t.scripts_lateUpdate.push(n),n.onBeforeRender&&t.scripts_onBeforeRender.push(n),n.onAfterRender&&t.scripts_onAfterRender.push(n),n.onPausedChanged&&t.scripts_pausedChanged.push(n),Og(n,null)&&t.new_scripts_xr.push(n),Og(n,"immersive-vr")&&t.scripts_immersive_vr.push(n),Og(n,"immersive-ar")&&t.scripts_immersive_ar.push(n))}function Cs(n,t){qi(n,t.new_scripts),qi(n,t.new_script_start),qi(n,t.scripts),qi(n,t.scripts_earlyUpdate),qi(n,t.scripts_update),qi(n,t.scripts_lateUpdate),qi(n,t.scripts_onBeforeRender),qi(n,t.scripts_onAfterRender),qi(n,t.scripts_pausedChanged),qi(n,t.new_scripts_xr),qi(n,t.scripts_immersive_vr),qi(n,t.scripts_immersive_ar),t.stopAllCoroutinesFrom(n)}function qi(n,t){const i=t.indexOf(n);i>=0&&t.splice(i,1)}function Og(n,t){var i;if(n){const s=n;if(s.onBeforeXR||s.onEnterXR||s.onUpdateXR||s.onLeaveXR||s.onXRControllerAdded||s.onXRControllerRemoved)return!(t!=null&&((i=s.supportsXR)==null?void 0:i.call(s,t))===!1)}return!1}function zd(n){if(n||(n=ue.Current.scene),!n){console.trace("Invalid call - no current context.");return}const t=ja(n);e_(n,t,!0)||(Sg||F()?console.error(`Error updating hierarchy
Do you have circular references in your project? <a target="_blank" href="https://docs.needle.tools/circular-reference"> Click here for more information.`,n):console.error('Failed to update active state in hierarchy of "'+n.name+'"',n),console.warn(" \u2191 this error might be caused by circular references. Please make sure you don't have files with circular references (e.g. one GLB 1 is loading GLB 2 which is then loading GLB 1 again)."))}function e_(n,t,i,s=0){if(s>1e3)return console.warn("Hierarchy is too deep (> 1000 level) - will abort updating active state"),!1;const o=ja(n);if(t&&(t=o,t&&n.parent)){const c=n.parent;t=c[_s],t===void 0&&(c instanceof wi||(t=!0))}const r=n[_s]!==t;n[_s]=t,r&&(f2&&console.warn("ACTIVE CHANGE",n.name,o,n.visible,t,"changed?"+r,n),i&&b2(n,c=>{t?c.enabled&&(Ta(c.__internalAwake.bind(c)),c.enabled&&c.__internalEnable()):c.__didAwake&&c.enabled&&(c.__didEnable=!1,c.onDisable())}));let l=!0;if(n.children)for(const c of n.children)e_(c,t,i,s+1)===!1&&(l=!1);return l}function _c(n){let t=!0,i=n,s=!1;for(;i&&i;){if(i.type==="Scene"&&(s=!0),!ja(i)){t=!1;break}i=i.parent}if(!n){console.error("GO is null");return}n[_s]=t&&s}function b2(n,t){var i;if((i=n.userData)!=null&&i.components)for(const s of n.userData.components)t(s)}const Ud=new Map,t_=Symbol("prewarmFlag"),Pg=Symbol("waitingForPrewarm"),kg=C("debugprewarm");function _2(n,t){!n||n[t_]===!0||n[Pg]===!0||(Ud.has(t)||Ud.set(t,[]),n[Pg]=!0,Ud.get(t).push(n),kg&&console.debug("register prewarm",n.name))}let Mg=null,Rg=null;function w2(n){if(!n)return;const t=Ud.get(n);if(!(t!=null&&t.length))return;const i=n.mainCamera;if(i){kg&&console.log("prewarm",t.length,"objects",[...t]);const s=n.renderer;if(s.compile){const o=n.scene;s.compile(o,i),Mg??(Mg=new CS(64)),Rg??(Rg=new OS(.001,9999999,Mg)),Rg.update(s,o);for(const r of t)r[t_]=!0,r[Pg]=!1;t.length=0,kg&&console.log("prewarm done")}}}ue.registerCallback(pe.ContextCreated,n=>{const t=n.context;a_(t),s_(t)});const Nd=C("debugcomponents"),i_="eff8ba80-635d-11ec-90d6-0242ac120003";class Dt{constructor(t){a(this,"_originalSeed"),a(this,"_seed"),typeof t=="string"&&(t=Dt.hash(t)),this._originalSeed=t,this._seed=t}get seed(){return this._seed}set seed(t){this._seed=t}reset(){this._seed=this._originalSeed}generateUUID(t){if(typeof t=="string")return lv(t,i_);const i=this._seed;return this._seed-=1,lv(i.toString(),i_)}initialize(t){typeof t=="string"?this._seed=Dt.hash(t):this._seed=t}static createFromString(t){return new Dt(this.hash(t))}static hash(t){let i=0;for(let s=0;s<t.length;s++)i=t.charCodeAt(s)+((i<<5)-i);return i}}var n_=(n=>(n.NewInstanceCreated="new-instance-created",n.InstanceDestroyed="instance-destroyed",n))(n_||{});class x2{constructor(t){a(this,"guid"),a(this,"dontSave"),this.guid=t}}function wc(n,t,i=!0,s){if(!n)return;const o=n;if(Ti(n,i),!t){console.warn("Can not send destroy: No networking connection provided",n.guid);return}if(!t.isConnected){F()&&console.debug("Can not send destroy: not connected",n.guid);return}let r=n.guid;if(!r&&o.uuid&&(r=o.uuid),!r){console.warn("Can not send destroy: failed to find guid",n);return}Tg(r,t,s)}function Tg(n,t,i){const s=new x2(n);i?.saveInRoom===!1&&(s.dontSave=!0),t.send("instance-destroyed",s,wn.Queued)}function s_(n){n.connection.beginListen("instance-destroyed",t=>{Nd&&console.log("[Remote] Destroyed",n.scene,t);const i=Ng(t.guid,n.scene);i&&Ti(i)})}class S2{constructor(t,i,s){a(this,"filename"),a(this,"hash"),a(this,"size"),this.filename=t,this.hash=i,this.size=s}}class o_{constructor(t,i){a(this,"guid"),a(this,"originalGuid"),a(this,"seed"),a(this,"visible"),a(this,"hostData"),a(this,"dontSave"),a(this,"parent"),a(this,"position"),a(this,"rotation"),a(this,"scale"),a(this,"preventCreation"),a(this,"deleteStateOnDisconnect"),this.originalGuid=t,this.guid=i}}function Eg(n,t,i,s){var o,r;const l=n;if(!l.guid)return console.warn("Can not instantiate: No guid",l),null;if(t.context||(t.context=ee.Current),!t.context)return console.error("Missing network instantiate options / reference to network connection in sync instantiate"),null;const c=t?{...t}:null,{instance:h,seed:d}=C2(l,t);if(h){const u=h;if(u.guid){Nd&&console.log("[Local] new instance","gameobject:",h?.guid);const p=new o_(l.guid,u.guid);p.seed=d,t.deleteOnDisconnect===!0&&(p.deleteStateOnDisconnect=!0),c&&(c.position&&(p.position={x:c.position.x,y:c.position.y,z:c.position.z}),c.rotation&&(p.rotation={x:c.rotation.x,y:c.rotation.y,z:c.rotation.z,w:c.rotation.w}),c.scale&&(p.scale={x:c.scale.x,y:c.scale.y,z:c.scale.z})),p.position||(p.position={x:u.position.x,y:u.position.y,z:u.position.z}),p.rotation||(p.rotation={x:u.quaternion.x,y:u.quaternion.y,z:u.quaternion.z,w:u.quaternion.w}),p.scale||(p.scale={x:u.scale.x,y:u.scale.y,z:u.scale.z}),p.visible=l.visible,c!=null&&c.parent&&(typeof c.parent=="string"?p.parent=c.parent:p.parent=c.parent.guid),p.hostData=i,s===!1&&(p.dontSave=!0),!((o=t?.context)!=null&&o.connection)&&F()&&console.debug("Object will be instantiated but it will not be synced: not connected",l.guid),t.context.connection.isInRoom&&Ea.push(new WeakRef(u)),(r=t?.context)==null||r.connection.send("new-instance-created",p)}else console.warn("Missing guid, can not send new instance event",u)}return h}function r_(){return Math.random()*9999999}const Ea=new Array;function a_(n){n.connection.beginListen("new-instance-created",async t=>{const i=await O2(t.originalGuid,n.scene);if(t.preventCreation===!0)return;if(!i){console.warn("could not find object that was instantiated: "+t.guid);return}const s=new Bn;t.position&&(s.position=new x(t.position.x,t.position.y,t.position.z)),t.rotation&&(s.rotation=new V(t.rotation.x,t.rotation.y,t.rotation.z,t.rotation.w)),t.scale&&(s.scale=new x(t.scale.x,t.scale.y,t.scale.z)),s.parent=t.parent,t.seed&&(s.idProvider=new Dt(t.seed)),s.visible=t.visible,s.context=n,Nd&&n.alias&&console.log("[Remote] instantiate in: "+n.alias);const o=Da(i,s);Ea.push(new WeakRef(o)),o&&(t.parent==="scene"&&n.scene.add(o),Nd&&console.log("[Remote] new instance","gameobject:",o?.guid,i))}),n.connection.beginListen("left-room",()=>{Ea.length>0&&console.debug(`Left networking room, cleaning up ${Ea.length} instantiated objects`);for(const t of Ea){const i=t.deref();i&&i.destroy()}Ea.length=0})}function C2(n,t){const i=r_(),s=t??new Bn;s.idProvider=new Dt(i);const o=Da(n,s);return{seed:i,instance:o}}const l_={};function c_(n,t){l_[n]=t}async function O2(n,t){const i=l_[n];if(i!=null){const s=await i(n);if(s)return s}return h_(n,t)}function h_(n,t){if(t===null||!n)return null;if(t.guid===n)return t;if(t.children)for(const i of t.children){const s=h_(n,i);if(s)return s}return null}const xc=C("gizmos"),bt=C("debugextension"),Ag=C("debugtypes");class P2{constructor(){a(this,"_types",new Map),Ag&&console.warn("TypeStore: Created",this)}add(t,i){Ag&&console.warn("ADD TYPE",t);const s=this._types.get(t);s?Ag&&s!==i&&console.warn("Type name exists multiple times in your project and may lead to runtime errors:",t):this._types.set(t,i)}get(t){return this._types.get(t)||null}getKey(t){for(const[i,s]of this._types)if(s===t)return i;return null}}const k2=Symbol("BuiltInType"),k=new P2,M2=function(n){k.get(n.name)||k.add(n.name,n)},Ig=C("debugresolvedependencies"),R2=["/extensions/","extensions/"],T2=[{prefix:"/nodes/",dependencyName:"node"},{prefix:"/meshes/",dependencyName:"mesh"},{prefix:"/materials/",dependencyName:"material"},{prefix:"/textures/",dependencyName:"texture"},{prefix:"/animations/",dependencyName:"animation"},{prefix:"nodes/",dependencyName:"node"},{prefix:"meshes/",dependencyName:"mesh"},{prefix:"materials/",dependencyName:"material"},{prefix:"textures/",dependencyName:"texture"},{prefix:"animations/",dependencyName:"animation"}];async function jg(n,t){Ig&&console.log(n,t);const i=[];Lg(T2,n,t,i);const s=await Promise.all(i);return typeof t=="string"&&s.length===1?s[0]:s}function d_(n,t){return!n||!t?!1:n["needle:identifier"]!=null&&t["needle:identifier"]!=null?n["needle:identifier"]===t["needle:identifier"]:!1}function E2(n,t){n["needle:identifier"]=t}function Lg(n,t,i,s){if(typeof i=="object"&&i!==void 0&&i!==null)for(const o of Object.keys(i)){const r=i[o];if(typeof r=="string"){const l=u_(t,r);if(l!=null)typeof l.then=="function"?s.push(l.then(c=>i[o]=c)):i[o]=l;else{const c=p_(n,t,r);if(c){s.push(c.then(h=>(i[o]=h,h)));continue}}}else if(Array.isArray(r))for(let l=0;l<r.length;l++){const c=r[l],h=u_(t,c);if(h!==null){typeof h.then=="function"?s.push(h.then(d=>r[l]=d)):r[l]=h;continue}for(const d of n){const u=m_(d.prefix,c);if(u>=0){Ig&&console.log(d,u,d.dependencyName),s.push(t.getDependency(d.dependencyName,u).then(p=>r[l]=p));break}}typeof c=="object"&&Lg(n,t,c,s)}else typeof r=="object"&&Lg(n,t,r,s)}else if(typeof i=="string"){const o=p_(n,t,i);o&&s.push(o)}}function u_(n,t){if(n&&n.plugins&&typeof t=="string"){for(const i of R2)if(t.startsWith(i)){let s=t.substring(i.length);const o=s.indexOf("/");o>=0&&(s=s.substring(0,o));const r=n.plugins[s];if(bt&&console.log(s,r),typeof r?.resolve=="function"){const l=t.substring(i.length+s.length+1);return r.resolve(n,l)}break}}return null}function p_(n,t,i){for(const s of n){const o=m_(s.prefix,i);if(o>=0)return Ig&&console.warn("GET DEPENDENCY",s,o,s.dependencyName),t.getDependency(s.dependencyName,o)}return null}function m_(n,t){if(typeof t=="string"&&t.startsWith(n)){const i=t.substring(n.length),s=Number.parseInt(i);if(s>=0)return s}return-1}const Dg="NEEDLE_persistent_assets";function A2(n){return n?.___persistentAsset===!0}class I2{constructor(t){a(this,"parser"),this.parser=t}get name(){return Dg}async afterRoot(t){var i,s;if(!((s=(i=this.parser)==null?void 0:i.json)!=null&&s.extensions))return;const o=this.parser.json.extensions[Dg];if(!o)return;bt&&console.log(o);const r=new Array;for(const l of o?.assets){const c=jg(this.parser,l);c&&r.push(c)}await Promise.all(r)}resolve(t,i){const s=Number.parseInt(i);if(s>=0){bt&&console.log(i);const o=t.json.extensions[Dg];if(o){const r=o?.assets[s];if(r&&typeof r=="object"){r.___persistentAsset=!0;const l=r.__type;l&&k.get(l)}return r}}return null}}const Hn=C("debugserializer");class j2{constructor(){a(this,"typeMap",new Map)}register(t,i){if(this.typeMap.has(t)){const s=this.typeMap.get(t);if(s===i)return;Hn&&console.warn("Type: "+t+" is already registered",i,s)}Hn&&console.log("Register type serializer",i.name,i,t),this.typeMap.set(t,i)}getSerializer(t){if(t)return this.typeMap.get(t)}getSerializerForConstructor(t,i=0){if(i>20)return;if(!t||!t.constructor){Hn&&console.log("invalid type");return}const s=t.name,o=this.getSerializer(t);if(o!==void 0)return Hn&&console.log("FOUND SERIALIZER",o?.name,t.name,t.constructor.name,"for type: "+s,o,t,this.typeMap),o;const r=Object.getPrototypeOf(t);if(r&&r!==t){const l=this.getSerializerForConstructor(r,++i);if(l){const c=r.constructor||r.prototype;Hn&&console.log("FOUND SERIALIZER(in constructor) "+c.constructor.name,c.name,c,l),this.register(c,l)}return l}Hn&&console.warn("No serializer found for "+s,t,t.name,t.constructor.name)}}const Wd=new j2;class Xi{constructor(t,i){if(a(this,"name"),this.name=i,Array.isArray(t))for(const s of t)Wd.register(s,this);else Wd.register(t,this)}}class L2{constructor(){a(this,"isDevMode",Xt()),a(this,"cache",{})}registerDefinedKeys(t,i){if(this.isDevMode&&this.cache[t]===void 0){this.cache[t]=Object.keys(i);const s=i;s.$serializedTypes&&Object.keys(s.$serializedTypes)&&this.cache[t].push(...Object.keys(s.$serializedTypes)),Hn&&console.log("registerDefinedKeys for "+t,this.cache[t],i)}}getDefinedKey(t,i){return this.cache[t]===void 0?!1:this.cache[t].includes(i)}}class Bg{constructor(t){a(this,"root"),a(this,"gltf"),a(this,"gltfId"),a(this,"object"),a(this,"target"),a(this,"nodeId"),a(this,"nodeToObject"),a(this,"objectToNode"),a(this,"context"),a(this,"path"),a(this,"type"),a(this,"serializable"),a(this,"implementationInformation"),this.root=t}}function g_(n,t){const i=n.$serializedTypes;if(i===void 0)return null;const s={};for(const r in i){const l=n[r];if(l!=null&&typeof l=="object"){const c=Wd.getSerializerForConstructor(l);if(c){s[r]=c.onSerialize(l,t);continue}}s[r]=l}function o(r){const l=k._types;for(const[c,h]of l)if(h===n.constructor)return c;return r.__name||r.constructor.name}return s.name=o(n),typeof n.guid=="string"&&(s.guid=n.guid),s}const Vd=[];function f_(n,t){if(!n)return t;typeof n.$serializedTypes=="object"&&(t||(t={}),Object.assign(t,n.$serializedTypes));const i=Object.getPrototypeOf(n);return f_(i,t)}function Hd(n,t,i){if(!n)return!1;if(i.target=n,n.onBeforeDeserialize!==void 0){const o=n.onBeforeDeserialize(t,i);if(typeof o=="boolean")return o}const s=f_(n);if(t){if(typeof t.guid=="string"&&(n.guid=t.guid),s)for(const o in s){let r=function(h){const d=h.type;return d?Fg(c,d,i,void 0,n[o]):Fg(c,h,i,void 0,n[o])};const l=s[o],c=t[o];if(Hn&&console.log(o,c,n,l),!(n[o]!==void 0&&c===void 0)&&(i.type=void 0,i.path=o,i.serializable=l,!(n.onBeforeDeserializeMember!==void 0&&n.onBeforeDeserializeMember(o,c,i)===!0))){if(l===null)n[o]=c;else{if(Array.isArray(l))for(let h=0;h<l.length;h++){const d=l[h],u=r(d);if(u!==void 0||h===l.length-1){n[o]=u;break}}else n[o]=r(l);Vd.length=0}n.onAfterDeserializeMember!==void 0&&n.onAfterDeserializeMember(o,c,i)}}F2(n,t)}return B2(n,t,i.implementationInformation),n.onAfterDeserialize!==void 0&&n.onAfterDeserialize(t,i),!0}const D2=C("noerrors");function B2(n,t,i){var s,o;if(D2||!t||!Xt()||!n||n.constructor&&n.constructor[k2]===!0)return;const r=(s=n.constructor)==null?void 0:s.name,l=Object.getOwnPropertyNames(t);for(const c of l){if(c==="sourceId")continue;const h=n[c];if(h==null)continue;const d=t[c];if(i?.getDefinedKey(r,c)===!1){const u=c.charAt(0).toUpperCase()+c.slice(1);i.getDefinedKey(r,u)&&(Un(Pi.Warn,'<strong>Please rename</strong> "'+u+'" to "'+c+'" in '+r),console.warn('Please use lowercase for field: "'+u+'" in '+r,d,n));continue}if(d!=null){if(typeof d=="object"&&(h===void 0||!h.isObject3D)){if(typeof d.node=="number"||typeof d.guid=="string"){if(d.could_not_resolve)continue;if(!(h!==void 0&&Object.keys(h).length>1)){Un(Pi.Warn,`<strong>Missing serialization for object reference!</strong>

Please change to: 
@serializable(Object3D)
${c}? : Object3D;

in ${r}.ts
<a href="https://docs.needle.tools/serializable" target="_blank">See documentation</a>`),console.warn(r,c,n[c],n);continue}}else if(!Array.isArray(h)){const u=(o=h.constructor)==null?void 0:o.name;if(u==="Object"&&!h.constructor["did_warn:missing_serializable"]){h.constructor["did_warn:missing_serializable"]=!0;const p='You might be missing a @serializable(Type) decorator for field "'+c+'" in '+r+".ts";console.warn(p+`
${c}:`,d,u),Un(Pi.Warn,"Dev Warning: Are you missing a type in @serializable? Please check the browser console for details")}}}if(typeof h=="string"&&typeof d=="string"&&(d.endsWith(".gltf")||d.endsWith(".glb"))){Un(Pi.Warn,`<strong>Missing serialization for object reference!</strong>

Please change to: 
@serializable(AssetReference)
${c}? : AssetReference;

in script ${r}.ts
<a href="https://docs.needle.tools/serializable" target="_blank">documentation</a>`),console.warn(r,c,n[c],n);continue}}}}function F2(n,t){for(const i of Object.keys(t)){const s=t[i];if(typeof s=="object"&&s!==null&&s!==void 0){const o=n[i];if(!o){Hn&&console.log(i,"is undefined on",n);continue}for(const r of Object.keys(s))if(o[r]===void 0&&y_(s[r])&&!y_(o)){const l=z2(o,r);if(l&&(l?.writable===void 0||l?.writable===!1)&&l.set===void 0){Hn&&console.warn('Property is not writable "'+r+'"',o,l,s[r],o[r]);continue}o[r]=s[r]}}}}function z2(n,t){for(;n;){const i=Object.getOwnPropertyDescriptor(n,t);if(i)return i;n=Object.getPrototypeOf(n)}}function y_(n){switch(typeof n){case"number":case"string":case"boolean":return!0}return!1}function Fg(n,t,i,s,o){let r=typeof t=="function"&&t.prototype===void 0,l=t;if(r)try{if(l=t?.call(t,o),r=!1,l==null)return}catch(u){console.error("Error in callback",u,n)}if(i.type=l,!r&&o&&(o instanceof ke||o instanceof Le||o instanceof X||o instanceof gs||o instanceof oo))return o;if(s||(s={serializer:Wd.getSerializerForConstructor(l)}),o&&typeof o=="object"&&A2(o)){if(o.__concreteInstance)return o.__concreteInstance;const u=o;if(!u.$serializedTypes&&l.prototype.$serializedTypes&&(u.$serializedTypes=l.prototype.$serializedTypes),u.$serializedTypes&&Hd(u,n,i),o&&l!==void 0)try{let p=null;s.serializer&&(p=s.serializer.onDeserialize(n,i)),p||(p=new l,bt&&console.log("Create concrete instance for persistent asset",o,"instance:",p),Aa(p,o)),o.__concreteInstance=p,o=p}catch(p){console.error("Error creating instance or creating values on instance",p,o,l)}return o}if(Array.isArray(n)){const u=[];for(let p=0;p<n.length;p++){const g=n[p],y=Fg(g,t,i,s,g);u.push(y)}return u}const c=s?.serializer;if(c)return c.onDeserialize(n,i);let h;if(n&&(n.isMaterial||n.isTexture||n.isObject3D||n instanceof oo))h=n;else{if(n===void 0)return;if(n===null&&(l===ke||l===Le||l===X||l===oo))return null;try{h=new l(...U2(n))}catch(u){console.error("Error creating "+i.path,i.target,u);return}}const d=h;return d.$serializedTypes&&Hd(d,n,i),h}function U2(n){if(Vd.length=0,typeof n=="object"&&n!==null&&n!==void 0)for(const t of Object.keys(n))Vd.push(n[t]);return Vd}const zg=Symbol("assigned component properties");function Aa(n,t,i){var s;if(t==null||n==null)return;n[zg]=!0;const o=((s=n.constructor)==null?void 0:s.name)??"unknown";i?.registerDefinedKeys(o,n);for(const r of Object.keys(t)){const l=N2(n,r);typeof l?.value!="function"&&(!l||l.writable===!0||l?.set!==void 0)&&(n[r]=t[r])}delete n[zg]}function N2(n,t){let i;do i=Object.getOwnPropertyDescriptor(n,t);while(!i&&(n=Object.getPrototypeOf(n)));return i}const v_=Symbol("customVisibilityFlag");function Os(n,t){n.layers[v_]=t}const b_=Symbol("DidPatchLayers");function W2(){const n=io.prototype;if(n[b_])return;n[b_]=!0;const t=n.test;n.test=function(i){return this[v_]===!1?!1:t.call(this,i)}}W2(),Object.defineProperty(_e.prototype,"fov",{get:function(){return this._fov},set:function(n){const t=n!==this._fov;this._fov=n,t&&this.view!==void 0&&this.updateProjectionMatrix()},configurable:!0}),Object.defineProperty(_e.prototype,"near",{get:function(){return this._near},set:function(n){const t=n!==this._near;this._near=n,t&&this.view!==void 0&&this.updateProjectionMatrix()},configurable:!0}),Object.defineProperty(_e.prototype,"far",{get:function(){return this._far},set:function(n){const t=n!==this._far;this._far=n,t&&this.view!==void 0&&this.updateProjectionMatrix()},configurable:!0});const __=new Map;function w_(n,t){if(!n)return;if(!t){console.warn("No prototype found",n,n.prototype,n.constructor);return}const i=__.get(t);i&&i.apply(n)}function x_(n){const t=V2(n.prototype);__.set(n,t)}function V2(n){return new H2(n)}class H2{constructor(t){a(this,"$symbol"),a(this,"extensions"),a(this,"descriptors"),this.$symbol=Symbol("prototype-extension"),this.extensions=Object.keys(t),this.descriptors=new Array;for(let i=0;i<this.extensions.length;i++){const s=this.extensions[i],o=Object.getOwnPropertyDescriptor(t,s);o&&this.descriptors.push(o)}}apply(t){if(!t[this.$symbol]){t[this.$symbol]=!0;for(let i=0;i<this.extensions.length;i++){const s=this.extensions[i],o=this.descriptors[i];o&&Object.defineProperty(t,s,o)}}}}const $2=C("debuggetcomponent"),S_=()=>$2||globalThis.NEEDLE_DEBUG_GETCOMPONENT===!0;function G2(n){return n==null||n.isObject3D?n:n.object&&n.object.isObject3D?n.object:n}function Ug(n,t){if(!n||!n.userData.components)return t;const i=n.userData.components.indexOf(t);return i<0||(yc.dispatchComponentLifecycleEvent("removing-component",t),t.gameObject=null,n.userData.components.splice(i,1)),t}function Sc(n,t,i){return vr(n,t)||Ri(n,t,i)}const C_=new Dt("addComponentIdProvider");function yr(n,t,i=!0){n.userData||(n.userData={}),n.userData.components||(n.userData.components=[]),n.userData.components.push(t),t.gameObject=n,(t.guid===void 0||t.guid==="invalid")&&(t.guid=C_.generateUUID()),Gd(n),pu(t,t.context);try{i&&t.__internalAwake&&(_c(n),t.activeAndEnabled&&t.__internalAwake()),yc.dispatchComponentLifecycleEvent("component-added",t)}catch(s){console.error(s)}return t}function Ri(n,t,i,s){if(typeof t=="function"){const o=new t;i&&o.__internalNewInstanceCreated(i);let r=!0;return s?.callAwake!=null&&(r=s.callAwake),yr(n,o,r)}if(t.destroyed)return console.warn("Can not move/add a destroyed component",t),t;if(t.gameObject===n)return t;if(t.gameObject&&t.gameObject.userData.components){const o=t.gameObject.userData.components.indexOf(t);t.gameObject.userData.components.splice(o,1)}if(!n.userData.components)n.userData.components=[];else if(n.userData.components.includes(t))return t;return n.userData.components.push(t),t.gameObject=n,(t.guid===void 0||t.guid==="invalid")&&(t.guid=C_.generateUUID()),i&&t._internalInit(i),pu(t,t.context),t}function O_(n){if(n.gameObject&&n.gameObject.userData.components){const t=n.gameObject.userData.components.indexOf(n);n.gameObject.userData.components.splice(t,1)}n.__internalDisable&&n.__internalDisable(),Cs(n,n.context??ee.Current),n.destroy(),n.gameObject=null}let P_=!1;function k_(n,t,i){var s;if(n==null)return null;if(!n.isObject3D)return console.error("Object is not object3D"),null;if(!((s=n?.userData)!=null&&s.components)||(typeof t=="string"&&(P_||(P_=!0,console.warn(`Accessing components by name is not supported.
Please use the component type instead. This may keep working in local development but it will fail when bundling your application.

You can import other modules your main module to get access to types
or if you use npmdefs you can make types available globally using globalThis:
https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/globalThis`,t))),S_()&&console.log("[onGetComponent] FIND",t),t==null))return null;for(let o=0;o<n.userData.components.length;o++){const r=n.userData.components[o];let l=Object.getPrototypeOf(r);for(;l;){if(l===t.prototype)if(S_()&&console.log("[onGetComponent] MATCH BY PROTOYPE",l),i)i.push(r);else return r;l=Object.getPrototypeOf(l)}}return i||null}function vr(n,t){const i=k_(n,t);return i?Array.isArray(i)?i[0]:i:null}function Cc(n,t,i,s=!0){return i||(i=[]),s&&(i.length=0),k_(n,t,i),i}function Oc(n,t,i){var s;const o=vr(n,t);if(i===!1&&o?.enabled===!1)return null;if(o)return o;for(let r=0;r<((s=n?.children)==null?void 0:s.length);r++){const l=Oc(n.children[r],t);if(l)return l}return null}function Ia(n,t,i,s=!0){var o;i||(i=[]),s&&(i.length=0),Cc(n,t,i,!1);for(let r=0;r<((o=n?.children)==null?void 0:o.length);r++)Ia(n.children[r],t,i,!1);return i}function Pc(n,t){if(!n)return null;if(Array.isArray(n)){for(let s=0;s<n.length;s++){const o=G2(n[s]),r=Pc(o,t);if(r)return r}return null}return vr(n,t)||(n.parent?Pc(n.parent,t):null)}function $d(n,t,i,s=!0){return i||(i=[]),s&&(i.length=0),n?(Cc(n,t,i,!1),n.parent?$d(n.parent,t,i,!1):i):i}function kc(n,t=void 0,i=!0){if(!n)return null;if(!t&&(t=ee.Current,!t))return console.error("Can not search object without any needle context or scene!!!"),null;let s=t;if(s.isScene||(s=t?.scene),!s)return null;for(const o in s.children){const r=s.children[o];if(i===!1&&r[_s]===!1)continue;const l=Oc(r,n);if(l)return l}return null}function M_(n,t,i=void 0){if(!n)return t??[];if(t||(t=[]),t.length=0,!i&&(i=ee.Current,!i))return console.error("Can not search object without any needle context or scene!!!"),t;"scene"in i&&(i=i.scene);const s=i;if(!s)return t;for(const o in s.children){const r=s.children[o];Ia(r,n,t,!1)}return t}function Gd(n){n&&n.isObject3D===!0&&w_(n,j)}j.prototype.SetActive=function(n){this.visible=n},j.prototype.setActive=function(n){this.visible=n},j.prototype.destroy=function(){Ti(this)},j.prototype.addComponent=function(n,t){return Ri(this,n,t)},j.prototype.addNewComponent=function(n,t){return Ri(this,n,t)},j.prototype.removeComponent=function(n){return Ug(this,n)},j.prototype.getOrAddComponent=function(n,t){return Sc(this,n,t)},j.prototype.getComponent=function(n){return vr(this,n)},j.prototype.getComponents=function(n,t){return Cc(this,n,t)},j.prototype.getComponentInChildren=function(n){return Oc(this,n)},j.prototype.getComponentsInChildren=function(n,t){return Ia(this,n,t)},j.prototype.getComponentInParent=function(n){return Pc(this,n)},j.prototype.getComponentsInParent=function(n,t){return $d(this,n,t)},Object.getOwnPropertyDescriptor(j.prototype,"activeSelf")||Object.defineProperty(j.prototype,"activeSelf",{get:function(){return ja(this)},set:function(n){Mc(this,n)}}),Object.getOwnPropertyDescriptor(j.prototype,"worldPosition")||Object.defineProperty(j.prototype,"worldPosition",{get:function(){return this instanceof iv?te(this.object):te(this)},set:function(n){dt(this,n)}}),Object.getOwnPropertyDescriptor(j.prototype,"worldQuaternion")||Object.defineProperty(j.prototype,"worldQuaternion",{get:function(){return this instanceof iv?Ce(this.object):Ce(this)},set:function(n){Vi(this,n)}}),Object.getOwnPropertyDescriptor(j.prototype,"worldRotation")||Object.defineProperty(j.prototype,"worldRotation",{get:function(){return ic(this)},set:function(n){Vm(this,n)}}),Object.getOwnPropertyDescriptor(j.prototype,"worldScale")||Object.defineProperty(j.prototype,"worldScale",{get:function(){return Ye(this)},set:function(n){xa(this,n)}}),Object.getOwnPropertyDescriptor(j.prototype,"worldForward")||Object.defineProperty(j.prototype,"worldForward",{get:function(){return q().set(0,0,1).applyQuaternion(Ce(this))}}),Object.getOwnPropertyDescriptor(j.prototype,"worldRight")||Object.defineProperty(j.prototype,"worldRight",{get:function(){return q().set(1,0,0).applyQuaternion(Ce(this))}}),Object.getOwnPropertyDescriptor(j.prototype,"worldUp")||Object.defineProperty(j.prototype,"worldUp",{get:function(){return q().set(0,1,0).applyQuaternion(Ce(this))}}),x_(j);class xe extends ae{constructor(t,i,s,o){var r=(...l)=>{super(...l),a(this,"alpha",1)};i!=null&&s!=null?(r(t,i,s),this.alpha=o):(r(t),this.alpha=1)}get isRGBAColor(){return!0}set a(t){this.alpha=t}get a(){return this.alpha}clone(){const t=super.clone();return t.alpha=this.alpha,t}copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,"alpha"in t&&typeof t.alpha=="number"?this.alpha=t.alpha:typeof t.a=="number"&&(this.alpha=t.a),this}lerp(t,i){const s=t;return s.alpha!=null&&(this.alpha=W.lerp(this.alpha,s.alpha,i)),super.lerp(t,i)}lerpColors(t,i,s){const o=t,r=i;return o.alpha!=null&&r.alpha!=null&&(this.alpha=W.lerp(o.alpha,r.alpha,s)),super.lerpColors(t,i,s)}multiply(t){const i=t;return i.alpha!=null&&(this.alpha=this.alpha*i.alpha),super.multiply(t)}fromArray(t,i=0){return this.alpha=t[i+3],super.fromArray(t,i)}}const qd=C("debuggetcomponent"),Xd=C("debuginstantiate");class Bn{constructor(){a(this,"idProvider"),a(this,"parent"),a(this,"keepWorldPosition"),a(this,"position"),a(this,"rotation"),a(this,"scale"),a(this,"visible"),a(this,"context"),a(this,"components")}clone(){var t,i,s;const o=new Bn;return o.idProvider=this.idProvider,o.parent=this.parent,o.keepWorldPosition=this.keepWorldPosition,o.position=(t=this.position)==null?void 0:t.clone(),o.rotation=(i=this.rotation)==null?void 0:i.clone(),o.scale=(s=this.scale)==null?void 0:s.clone(),o.visible=this.visible,o.context=this.context,o.components=this.components,o}cloneAssign(t){var i,s,o;this.idProvider=t.idProvider,this.parent=t.parent,this.keepWorldPosition=t.keepWorldPosition,this.position=(i=t.position)==null?void 0:i.clone(),this.rotation=(s=t.rotation)==null?void 0:s.clone(),this.scale=(o=t.scale)==null?void 0:o.clone(),this.visible=t.visible,this.context=t.context,this.components=t.components}}function ja(n){return n.visible}function Mc(n,t){return typeof t=="number"&&(t=t>.5),n.visible=t,n.visible}function R_(n){return n[_s]||Qd(n)}function T_(n,t){n[Zb]=t}function Qd(n){return an.isUsingInstancing(n)}function Ng(n,t){return _a(n,t,!0,!0)}const E_=Symbol("isDestroyed");function br(n){return n[E_]}function A_(n,t){n[E_]=t}const Wg=Symbol("isDontDestroy");function La(n,t=!0){n[Wg]=t}const Yd=[],Zd=[];function Ti(n,t=!0,i=!1){Yd.length=0,Zd.length=0,Vg(n,t,!0);for(const s of Yd)s.gameObject=null,s.context=null;for(const s of Zd)A_(s,!0),i&&Ee(s),Qb(s);Zd.length=0,Yd.length=0}function Vg(n,t=!0,i=!0){var s;if(n==null)return;const o=n;if(o.isComponent){if(o[Wg])return;Yd.push(o);const c=o.gameObject;o.__internalDisable(),o.__internalDestroy(),o.gameObject=c;return}if(n[Wg])return;const r=n;qd&&console.log(r),Zd.push(r);const l=(s=r.userData)==null?void 0:s.components;if(l!=null&&Array.isArray(l)){let c=l.length;for(let h=0;h<l.length;h++){const d=l[h];Vg(d,t,!1),l.length<c&&(c=l.length,h--)}}if(t&&r.children)for(const c of r.children)Vg(c,t,!1);i&&r.removeFromParent()}function _r(n,t,i=!0){return I_(n,t,i)}function*Kd(n,t,i=!1,s=999,o=0){if(n!=null&&n.userData.components&&!(o>s)){for(const r of n.userData.components)t&&r?.isComponent===!0&&r instanceof t?yield r:yield r;if(i===!0)for(const r of n.children)yield*Kd(r,t,!0,s,o+1)}}function I_(n,t,i,s=0){var o;if(n){if(n.isObject3D,s>1e3){console.warn("Failed to iterate components: too many levels");return}if((o=n.userData)!=null&&o.components)for(let r=0;r<n.userData.components.length;r++){const l=n.userData.components[r];if(l?.isComponent===!0){const c=t(l);if(c!==void 0)return c}}if(i&&n.children){const r=s+1;for(let l=0;l<n.children.length;l++){const c=n.children[l];if(!c)continue;const h=I_(c,t,i,r);if(h!==void 0)return h}}}}function Da(n,t){if("isAssetReference"in n)return n.instantiate(t??void 0);let i=null;t!=null&&(t.x!==void 0?(i=new Bn,i.position=t):i=t);let s=ee.Current;i!=null&&i.context&&(s=i.context),qd&&s.alias&&console.log("context",s.alias),i&&!i.idProvider&&(i.idProvider=new Dt(Date.now()));const o=[],r={},l={},c=j_(s,n,i,o,r,l);c&&(X2(r),q2(l,r)),qd&&(wd(n,!0),wd(c,!0));const h={};if(i?.components!==!1){for(const d in o){const u=o[d],p=u.guid;i&&i.idProvider&&(u.guid=i.idProvider.generateUUID(),h[p]=u.guid,qd&&console.log(u.name,u.guid)),pu(u,s),u.__internalNewInstanceCreated&&u.__internalNewInstanceCreated()}for(const d in o){const u=o[d];u.resolveGuids&&u.resolveGuids(h),u.enabled!==!1&&(u.enabled=!0)}Fd(s)}return c}function j_(n,t,i,s,o,r){var l;if(!t)return null;const c=t.userData;t.userData={};const h=t.children;t.children=[];const d=t.clone(!1);if(Gd(d),t.userData=c,t.children=h,o[t.uuid]={original:t,clone:d},Xd&&console.log("ADD",t,d),t.type==="SkinnedMesh"&&(r[t.uuid]={original:t,clone:d}),i?.visible!==void 0&&(d.visible=i.visible),i!=null&&i.idProvider){d.uuid=i.idProvider.generateUUID();const p=d;p&&(p.guid=d.uuid)}t.animations&&t.animations.length>0&&(d.animations=[...t.animations]);const u=t.parent;if(u&&u.add(d),i!=null&&i.position?dt(d,i.position):d.position.copy(t.position),i!=null&&i.rotation?Vi(d,i.rotation):d.quaternion.copy(t.quaternion),i!=null&&i.scale?d.scale.copy(i.scale):d.scale.copy(t.scale),i!=null&&i.parent&&i.parent!=="scene"){let p=null;if(typeof i.parent=="string"?p=_a(i.parent,n.scene,!0):p=i.parent,p){const g=i.keepWorldPosition===!0?p.attach:p.add;g?g.call(p,d):console.error("Invalid parent object",p,"received when instantiating:",t)}else console.warn("could not find parent:",i.parent)}for(const[p,g]of Object.entries(t.userData))p!=="components"&&(d.userData[p]=g);if((l=t.userData)!=null&&l.components){const p=t.userData.components,g=[];d.userData.components=g;for(let y=0;y<p.length;y++){const f=p[y],v=new f.constructor;Aa(v,f),f[hc]!==void 0&&(v[hc]=f[hc]),g.push(v),v.gameObject=d,s.push(v),o[f.guid]={original:f,clone:v},yc.dispatchComponentLifecycleEvent("component-added",v)}}i&&(i.position=void 0,i.rotation=void 0,i.scale=void 0,i.parent=void 0);for(const p in t.children){const g=t.children[p],y=j_(n,g,i,s,o,r);y&&d.add(y)}return d}function q2(n,t){for(const i in n){const s=n[i],o=s.original,r=o.skeleton,l=s.clone;if(!r){console.warn("Skinned mesh has no skeleton?",s);continue}const c=r.bones,h=l.skeleton.clone();l.skeleton=h,l.bindMatrix.clone().copy(o.bindMatrix),l.bindMatrixInverse.copy(o.bindMatrixInverse);const d=[];h.bones=d;for(let u=0;u<c.length;u++){const p=c[u],g=t[p.uuid].clone;d.push(g)}}for(const i in n){const s=n[i].clone;s.skeleton.update(),s.bind(s.skeleton,s.bindMatrix),s.updateMatrixWorld(!0)}}function X2(n){var t;for(const i in n){const s=n[i].clone;if(s!=null&&s.isObject3D&&(t=s?.userData)!=null&&t.components)for(let o=0;o<s.userData.components.length;o++){const r=s.userData.components[o],l=Object.entries(r);for(const[c,h]of l)if(Array.isArray(h)){const d=[];r[c]=d;for(let u=0;u<h.length;u++){const p=h[u];if(typeof p!="object"){d.push(p);continue}const g=L_(r,c,p,n);g!==void 0?d.push(g):d.push(p)}}else if(typeof h=="object"){const d=L_(r,c,h,n);d!==void 0&&(r[c]=d)}}}}function L_(n,t,i,s){var o,r;if(i!=null)if(i.isComponent===!0){const l=i.gameObject;if(l){const c=l.uuid,h=(o=s[c])==null?void 0:o.clone;if(!h){Xd&&console.log("reference did not change",t,n,i);return}const d=l.userData.components.indexOf(i);if(d>=0&&h.isObject3D)return Xd&&console.log(t,c),h.userData.components[d];console.warn("could not find component",t,i)}}else if(i.isObject3D===!0){if(t==="gameObject")return;const l=i;if(l){const c=l.uuid,h=(r=s[c])==null?void 0:r.clone;if(h)return Xd&&console.log(t,"old",i,"new",h),h}}else{if(i.isVector4||i.isVector3||i.isVector2||i.isQuaternion||i.isEuler||i.isColor===!0)return i.clone();if(i.isEventList===!0)return i.__internalOnInstantiate(s)}}var wr;(n=>{n.baseUrl="https://networking.needle.tools";function t(h){return cv(new Uint8Array(h))}n.hashMD5=t;function i(h){const d=cv(new Uint8Array(h),{encoding:"binary",asBytes:!0});return btoa(String.fromCharCode(...d))}n.hashMD5_Base64=i;function s(h){const d=new Uint8Array(h);return crypto.subtle.digest("SHA-256",d).then(u=>btoa(String.fromCharCode(...new Uint8Array(u))))}n.hashSha256=s;function o(h){const d=h.filesize/1024/1024;return On()?d<50:d<5}n.canUpload=o;async function r(h,d){var u;const p=n.baseUrl;if(p){if(!h.name)return console.error("Upload: file name is missing"),null}else return console.error("Blob storage base url is not set"),null;let g=null;h instanceof File?g=await h.arrayBuffer():g=h.data;const y=g.byteLength,f=y/1024/1024;if(f>50)return d?.silent!==!0&&we(`File (${f.toFixed(1)}MB) is too large for uploading (see console for details)`),console.warn(`Your file is too large for uploading (${f.toFixed(1)}MB). Max allowed size is 50MB`),null;if(!On()&&f>5)return d?.silent!==!0&&we('File is too large for uploading. Please get a <a href="https://needle.tools/pricing" target="_blank">commercial license</a> to upload files larger than 5MB'),console.warn(`Your file is too large for uploading (${f.toFixed(1)}MB). Max size is 5MB for non-commercial users. Please get a commercial license at https://needle.tools/pricing for larger files (up to 50MB)`),null;if(y<1)return console.warn(`Your file is too small for uploading (${f.toFixed(1)}MB). Min size is 1 byte`),null;const v=i(g),b={filename:h.name,"Content-Md5":v,"Content-Type":h.type||"application/octet-stream",FileSize:y.toString(),"Content-Disposition":`attachment; filename="${h.name}"`,"x-amz-server-side-encryption":"AES256"},w=await fetch(p+"/api/needle/blob",{method:"POST",headers:b,signal:d?.abort}).then(_=>_.json()).catch(_=>(console.error(_),null));if(w==null)return console.warn("Upload failed..."),null;if("error"in w)return console.error(w.error),null;if("upload"in w&&w.upload){let _=function(M){var T;return(T=d?.onProgress)==null||T.call(null,{progress01:0,state:"inprogress"}),fetch(M,{method:"PUT",headers:b,body:g,signal:d?.abort}).then(L=>{var D;return(D=d?.onProgress)==null||D.call(null,{progress01:1,state:"finished"}),L}).catch(L=>L)};console.debug("Uploading file",w.upload);let S=!1,R=null;for(let M=0;M<3;M++)try{if(S)break;if((u=d?.abort)!=null&&u.aborted)return console.debug("Aborted upload"),null;const T=await _(w.upload);T instanceof Error?(R=T,await yn(1e3*M)):T.ok&&(console.debug("File uploaded successfully"),S=!0)}catch(T){console.error(T)}if(!S)return console.error(R?.message||"Failed to upload file"),null}if("download"in w){const _=p+w.download;return console.debug("File found in blob storage",_),{key:w.key,success:!0,download_url:_}}return null}n.upload=r;function l(h){return`${n.baseUrl}/api/needle/blob/${h}`}n.getBlobUrlForKey=l;async function c(h,d){var u;const p=await fetch(h),g=(u=p.body)==null?void 0:u.getReader(),y=p.headers.get("Content-Length"),f=y?parseInt(y):0;if(!g)return null;let v=0;const b=[];for(;;){const{done:S,value:R}=await g.read();if(R&&(b.push(R),v+=R.length,d?.call(null,new ProgressEvent("progress",{loaded:v,total:f}))),S)break}const w=new Uint8Array(v);let _=0;for(const S of b)w.set(S,_),_+=S.length;return w}n.download=c})(wr||(wr={}));const mo=C("debugaddressables");class D_{constructor(t){a(this,"_context"),a(this,"_assetReferences",{}),a(this,"preUpdate",()=>{}),this._context=t,this._context.pre_update_callbacks.push(this.preUpdate)}dispose(){const t=this._context.pre_update_callbacks.indexOf(this.preUpdate);t>=0&&this._context.pre_update_callbacks.splice(t,1);for(const i in this._assetReferences){const s=this._assetReferences[i];s?.unload()}this._assetReferences={}}findAssetReference(t){return this._assetReferences[t]||null}registerAssetReference(t){return t.url&&(this._assetReferences[t.url]?console.warn("Asset reference already registered",t):this._assetReferences[t.url]=t),t}unregisterAssetReference(t){t.url&&delete this._assetReferences[t.url]}}const Hg=Symbol("assetReference"),Ba=class{constructor(n,t,i=null){a(this,"_loading"),a(this,"_asset"),a(this,"_glbRoot"),a(this,"_url"),a(this,"_urlName"),a(this,"_progressListeners",[]),a(this,"_hash"),a(this,"_hashedUri"),a(this,"_isLoadingRawBinary",!1),a(this,"_rawBinary"),this._url=n;const s=n.lastIndexOf("/");if(s>=0){this._urlName=n.substring(s+1);const o=this._urlName.lastIndexOf(".");o>=0&&(this._urlName=this._urlName.substring(0,o))}else this._urlName=n;this._hash=t,n.includes("?v=")?this._hashedUri=n:this._hashedUri=t?n+"?v="+t:n,i!==null&&(this.asset=i),c_(this._url,this.onResolvePrefab.bind(this))}static getOrCreateFromUrl(n,t){if(!t&&(t=ee.Current,!t))throw new Error('Context is required when sourceId is a string. When you call this method from a component you can call it with "getOrCreate(this, url)" where "this" is the component.');const i=t.addressables,s=i.findAssetReference(n);if(s)return s;const o=new Ba(n,t.hash);return i.registerAssetReference(o),o}static getOrCreate(n,t,i){if(typeof n=="string"){if(!i&&(i=ee.Current,!i))throw new Error('Context is required when sourceId is a string. When you call this method from a component you can call it with "getOrCreate(this, url)" where "this" is the component.')}else i=n.context,n=n.sourceId;const s=ao(n,t);mo&&console.log("GetOrCreate Addressable from",n,t,"FinalPath=",s);const o=i.addressables,r=o.findAssetReference(s);if(r)return r;const l=new Ba(s,i.hash);return o.registerAssetReference(l),l}get isAssetReference(){return!0}get asset(){return this._glbRoot??this._asset}set asset(n){this._asset=n}get uri(){return this._url}get url(){return this._url}get urlName(){return this._urlName}get hasUrl(){return this._url!==void 0&&(this._url.startsWith("http")||this._url.startsWith("blob:")||this._url.startsWith("www.")||this._url.includes("/"))}get rawAsset(){return this._asset}async onResolvePrefab(n){return n===this.url&&(this.mustLoad&&await this.loadAssetAsync(),this.asset)?this.asset:null}get mustLoad(){return!this.asset||this.asset.__destroyed===!0||br(this.asset)===!0}isLoaded(){return this._rawBinary||this.asset!==void 0}unload(){this.asset&&(mo&&console.log("Unload",this.asset),"scene"in this.asset&&this.asset.scene&&Ti(this.asset.scene,!0,!0),Ti(this.asset,!0,!0)),this.asset=null,this._rawBinary=void 0,this._glbRoot=null,this._loading=void 0,ee.Current&&ee.Current.addressables.unregisterAssetReference(this)}async preload(){if(!this.mustLoad||this._isLoadingRawBinary)return null;if(this._rawBinary!==void 0)return this._rawBinary;this._isLoadingRawBinary=!0,mo&&console.log("Preload",this._hashedUri);const n=await wr.download(this._hashedUri,t=>{this.raiseProgressEvent(t)});return this._rawBinary=n?.buffer??null,this._isLoadingRawBinary=!1,this._rawBinary}async loadAssetAsync(n){if(mo&&console.log("loadAssetAsync",this.url),!this.mustLoad)return this.asset;if(n&&this._progressListeners.push(n),this._loading!==void 0)return this._loading.then(s=>this.asset);const t=ee.Current;if(this._rawBinary){if(!(this._rawBinary instanceof ArrayBuffer))return console.error("Invalid raw binary data",this._rawBinary),null;this._loading=fn().parseSync(t,this._rawBinary,this.url,null),this.raiseProgressEvent(new ProgressEvent("progress",{loaded:this._rawBinary.byteLength,total:this._rawBinary.byteLength}))}else mo&&console.log("Load async",this.url),this._loading=fn().loadSync(t,this._hashedUri,this.url,null,s=>{this.raiseProgressEvent(s)});const i=await this._loading;return this._progressListeners.length=0,this._glbRoot=this.tryGetActualGameObjectRoot(i),this._loading=void 0,i?(i[Hg]=this,this._glbRoot&&(this._glbRoot[Hg]=this),this.asset&&(this.asset[Hg]=this),Fd(t),i.scene!==void 0&&(this.asset=i),this.asset):null}async instantiate(n){return this.onInstantiate(n,!1)}async instantiateSynced(n,t=!0){return this.onInstantiate(n,!0,t)}beginListenDownload(n){this._progressListeners.indexOf(n)<0&&this._progressListeners.push(n)}endListenDownload(n){const t=this._progressListeners.indexOf(n);t>=0&&this._progressListeners.splice(t,1)}raiseProgressEvent(n){for(const t of this._progressListeners)t(this,n)}async onInstantiate(n,t=!1,i){const s=ee.Current,o=new Bn;if(n instanceof j?o.parent=n:n&&(Object.assign(o,n),o.cloneAssign(n)),o.parent||(o.parent=s.scene),this.mustLoad&&await this.loadAssetAsync(),mo&&console.log("Instantiate",this.url,"parent:",n),this.asset){mo&&console.log("Add to scene",this.asset);let r=Ba.currentlyInstantiating.get(this.url);if(r!==void 0&&r>=1e4)return console.error("Recursive or too many instantiations of "+this.url+" in the same frame ("+r+")"),null;try{if(r===void 0&&(r=0),r+=1,Ba.currentlyInstantiating.set(this.url,r),t){o.context=s;const l=this.asset;l.guid=this.url;const c=Eg(l,o,void 0,i);if(c)return c}else{const l=Da(this.asset,o);if(l)return l}}finally{s.post_render_callbacks.push(()=>{r===void 0||r<0?r=0:r-=1,Ba.currentlyInstantiating.set(this.url,r)})}}else mo&&console.warn("Failed to load asset",this.url);return null}tryGetActualGameObjectRoot(n){if(n&&n.scene){const t=n.scene;return t.isGroup&&t.children.length===1&&t.children[0].name+"glb"===t.name?t.children[0]:t}return null}};let le=Ba;a(le,"currentlyInstantiating",new Map);class Q2 extends Xi{constructor(){super([le],"AssetReferenceSerializer")}onSerialize(t,i){if(t&&t.uri!==void 0&&typeof t.uri=="string")return t.uri}onDeserialize(t,i){if(typeof t=="string")return i.context?i.gltfId?le.getOrCreate(i.gltfId,t,i.context):(console.error("Missing source id"),null):(console.error("Missing context"),null);if(t instanceof j){if(!i.context)return console.error("Missing context"),null;if(!i.gltfId)return console.error("Missing source id"),null;const s=t,o=i.context,r=s.guid??s.uuid,l=o.addressables.findAssetReference(r);if(l)return l;const c=new le(r,void 0,s);return o.addressables.registerAssetReference(c),c}return null}}new Q2;const Y2=Promise.resolve(null),Jd=class{constructor(n){a(this,"url"),a(this,"_bitmap"),a(this,"_bitmapObject"),a(this,"loader",null),this.url=n}static getOrCreate(n){let t=Jd.imageReferences.get(n);return t||(t=new Jd(n),Jd.imageReferences.set(n,t)),t}dispose(){this._bitmapObject&&this._bitmapObject.close(),this._bitmap=void 0}createHTMLImage(){const n=new Image;return n.src=this.url,n}createTexture(){return this.url?(this.loader||(this.loader=new ga),this.loader.setCrossOrigin("anonymous"),this.loader.loadAsync(this.url).then(n=>{var t;return n&&!((t=n.name)!=null&&t.length)&&(n.name=this.url.split("/").pop()??this.url),n})):(console.error("Can not load texture without url"),Y2)}getBitmap(){return this._bitmap?this._bitmap:(this._bitmap=new Promise((n,t)=>{const i=document.createElement("img");i.addEventListener("load",()=>{this._bitmap=createImageBitmap(i).then(s=>(this._bitmapObject=s,n(s),s))}),i.addEventListener("error",s=>{console.error("Failed to load image:"+this.url,s),n(null)}),i.src=this.url}),this._bitmap)}};let eu=Jd;a(eu,"imageReferences",new Map);class B_ extends Xi{constructor(){super([eu],"ImageReferenceSerializer")}onSerialize(t,i){return null}onDeserialize(t,i){if(typeof t=="string"){const s=ao(i.gltfId,t);return eu.getOrCreate(s)}}}new B_;const tu=class{constructor(n){a(this,"url"),a(this,"res"),this.url=n}static getOrCreate(n){let t=tu.cache.get(n);return t||(t=new tu(n),tu.cache.set(n,t)),t}async loadRaw(){return this.res||(this.res=fetch(this.url)),this.res.then(n=>n.blob())}async loadText(){return this.res||(this.res=fetch(this.url)),this.res.then(n=>n.text())}};let iu=tu;a(iu,"cache",new Map);class F_ extends Xi{constructor(){super([iu],"FileReferenceSerializer")}onSerialize(t,i){return null}onDeserialize(t,i){if(typeof t=="string"){const s=ao(i.gltfId,t);return iu.getOrCreate(s)}}}new F_;class Z2{constructor(t){a(this,"context"),a(this,"mixers",[]),this.context=t}onDestroy(){this.mixers.forEach(t=>t.stopAllAction()),this.mixers.length=0}registerAnimationMixer(t){if(!t){console.warn("AnimationsRegistry.registerAnimationMixer called with null or undefined mixer");return}this.mixers.includes(t)||this.mixers.push(t)}unregisterAnimationMixer(t){if(!t){console.warn("AnimationsRegistry.unregisterAnimationMixer called with null or undefined mixer");return}const i=this.mixers.indexOf(t);i!==-1&&this.mixers.splice(i,1)}}class Fa{static tryGetActionsFromMixer(t){return t._actions||null}static tryGetAnimationClipsFromObjectHierarchy(t,i){if(i||(i=new Array),t)t.animations&&i.push(...t.animations);else return i;if(t.children)for(const s of t.children)this.tryGetAnimationClipsFromObjectHierarchy(s,i);return i}static assignAnimationsFromFile(t,i){if(!t||!t.animations){console.debug("No animations found in file");return}for(let o=0;o<t.animations.length;o++){const r=t.animations[o];if(!r.tracks||r.tracks.length<=0){console.warn("Animation has no tracks");continue}for(const l in r.tracks){const c=r.tracks[l],h=fa.parseTrackName(c.name);let d=fa.findNode(t.scene,h.nodeName);if(!d){const p=c.__objectName??c.name.substring(0,c.name.indexOf("."));if(d=t.scene.getObjectByProperty("uuid",p),!d)continue}let u=s(d);if(!u){if(!(i!=null&&i.createAnimationComponent)){console.warn("No AnimationComponent found in parent hierarchy of object and no 'createAnimationComponent' callback was provided in options.");continue}u=i.createAnimationComponent(t.scene,r)}u.addClip&&u.addClip(r)}}function s(o){var r;if(!o)return null;const l=(r=o.userData)==null?void 0:r.components;if(l&&l.length>0){for(let c=0;c<l.length;c++)if(l[c].isAnimationComponent===!0)return o}return s(o.parent)}}}var nu=(n=>(n.Visible="application-visible",n.Hidden="application-hidden",n.MuteChanged="application-mutechanged",n))(nu||{});let su=!1;const za=[];function xr(){if(su)return;F()&&console.debug("User interaction registered: audio can now be played"),su=!0;const n=[...za];za.length=0,n.forEach(t=>t())}document.addEventListener("mousedown",xr),document.addEventListener("pointerup",xr),document.addEventListener("click",xr),document.addEventListener("dragstart",xr),document.addEventListener("touchend",xr),document.addEventListener("keydown",xr),J.onXRSessionStart(()=>{xr()});const z_=class extends EventTarget{constructor(n){super(),a(this,"_mute",!1),a(this,"context"),a(this,"_isVisible",!0),this.context=n,window.addEventListener("visibilitychange",this.onVisiblityChanged.bind(this),!1)}static get userInteractionRegistered(){return su}static registerWaitForInteraction(n){if(n!==null){if(su){n();return}za.indexOf(n)===-1&&za.push(n)}}static unregisterWaitForInteraction(n){const t=za.indexOf(n);t!==-1&&za.splice(t,1)}get muted(){return this._mute}set muted(n){n!==this._mute&&(this._mute=n,this.dispatchEvent(new Event("application-mutechanged")))}get hasFocus(){return document.hasFocus()}get isVisible(){return this._isVisible}onVisiblityChanged(n){switch(n.target.visibilityState){case"hidden":this._isVisible=!1,this.dispatchEvent(new Event("application-hidden"));break;case"visible":this._isVisible=!0,this.dispatchEvent(new Event("application-visible"));break}}};let Ps=z_;a(Ps,"registerWaitForAllowAudio",z_.registerWaitForInteraction);function*$g(n,t=null){const i=t?t.time:ee.Current.time,s=i.time;for(;i.time-s<n;)yield}function*K2(n){for(let t=0;t<n;t++)yield}function*U_(n){let t=!0;for(n.then(()=>t=!1),n.catch(()=>t=!1);t;)yield}const N_="NEEDLE_lightmaps",Rc=C("debuglightmapsextension")||C("debuglightmaps");var go=(n=>(n[n.Lightmap=0]="Lightmap",n[n.Skybox=1]="Skybox",n[n.Reflection=2]="Reflection",n))(go||{});class J2{constructor(t,i,s){a(this,"parser"),a(this,"registry"),a(this,"source"),this.parser=t,this.registry=i,this.source=s}get name(){return N_}afterRoot(t){const i=this.parser.json.extensions;if(i){const s=i[N_];if(s){const o=s.textures;return o!=null&&o.length?(Rc&&console.log(s),new Promise(async(r,l)=>{const c=[];for(const d of o)if(d.pointer){Rc&&console.log(d);let u=null;if(d.pointer.startsWith("/textures/"))Rc&&console.log("Load texture from gltf",d.pointer),u=jg(this.parser,d.pointer).then(p=>this.resolveTexture(d,p));else if(typeof d.pointer=="string"){Rc&&console.log("Load texture from path",d.pointer);const p=ao(this.source,d.pointer);let g;p.endsWith(".exr")?g=new pd(this.parser.options.manager):p.endsWith(".hdr")?g=new fm(this.parser.options.manager):g=new ga(this.parser.options.manager),u=g.loadAsync(p,void 0).then(y=>this.resolveTexture(d,y))}else d.pointer;u&&c.push(u)}const h=await Mm(c);h!=null&&h.anyFailed&&F()&&console.error("Failed to load lightmap extension",h),r()})):null}}return null}resolveTexture(t,i){const s=i;Rc&&console.log("Lightmap loaded:",s),s!=null&&s.isTexture&&(this.registry?(s.colorSpace=rr,this.registry.registerTexture(this.source,t.type,s,t.index)):console.log(go[t.type],t.pointer,s))}}const W_=!!C("debuglightmaps");class ek{constructor(t){a(this,"_context"),a(this,"_lightmaps",new Map),this._context=t}clear(){this._lightmaps.clear()}registerTexture(t,i,s,o){W_&&console.log("Registering ",go[i]+' "'+t+'"',s),this._lightmaps.has(t)||this._lightmaps.set(t,new Map);const r=this._lightmaps.get(t),l=r?.get(i)??[];l.length<o&&(l.length=o+1),l[o]=s,r?.set(i,l)}tryGetLightmap(t,i=0){return this.tryGet(t,go.Lightmap,i)}tryGetSkybox(t){return this.tryGet(t,go.Skybox,0)}tryGetReflection(t){return this.tryGet(t,go.Reflection,0)}tryGet(t,i,s){if(!t)return W_&&console.warn("Missing source id"),null;const o=this._lightmaps.get(t);if(!o)return null;const r=o.get(i);return r===void 0||!(r!=null&&r.length)||r.length<=s?null:r[s]}}qt.lights_fragment_maps=qt.lights_fragment_maps.replace("vec4 lightMapTexel = texture2D( lightMap, vLightMapUv );",`
    vec2 lUv = vLightMapUv.xy * lightmapScaleOffset.xy + vec2(lightmapScaleOffset.z, (1. - (lightmapScaleOffset.y + lightmapScaleOffset.w)));
    vec4 lightMapTexel = texture2D( lightMap, lUv);
    // The range of RGBM lightmaps goes from 0 to 34.49 (5^2.2) in linear space, and from 0 to 5 in gamma space.
    lightMapTexel.rgb *= lightMapTexel.a * 8.; // no idea where that "8" comes from... heuristically derived
    lightMapTexel.a = 1.;
    lightMapTexel = conv_sRGBToLinear(lightMapTexel);
    `),qt.lightmap_pars_fragment=`
    #ifdef USE_LIGHTMAP
        uniform sampler2D lightMap;
        uniform float lightMapIntensity;
        uniform vec4 lightmapScaleOffset;
        
        // took from threejs 05fc79cd52b79e8c3e8dec1e7dca72c5c39983a4
        vec4 conv_sRGBToLinear( in vec4 value ) {
            return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );
        }
    #endif
    `,qt.lights_fragment_begin=qt.lights_fragment_begin.replace("irradiance += getLightProbeIrradiance( lightProbe, geometry.normal );",`
#if defined(USE_LIGHTMAP)
irradiance += 0.;
#else
irradiance += getLightProbeIrradiance( lightProbe, geometry.normal );
#endif`),PS.lightmap.lightmapScaleOffset={value:new fe(1,1,0,0)};const Gg=C("debugprogressive"),ou=new xi,ru=new od;class tk{constructor(t){a(this,"context"),a(this,"_lodsManager"),this.context=t}get manager(){return this._lodsManager}get targetTriangleDensity(){var t;return((t=this._lodsManager)==null?void 0:t.targetTriangleDensity)??-1}set targetTriangleDensity(t){this._lodsManager&&(this._lodsManager.targetTriangleDensity=t)}setRenderer(t){var i;(i=this._lodsManager)==null||i.disable(),va.removePlugin(this),va.addPlugin(this),va.debugDrawLine=G.DrawLine,this._lodsManager=va.get(t),this._lodsManager.enable()}disable(){var t;(t=this._lodsManager)==null||t.disable(),va.removePlugin(this)}onAfterUpdatedLOD(t,i,s,o,r){Gg&&this.onRenderDebug(s,o,r)}onRenderDebug(t,i,s){var o,r,l;if(!i.geometry||!it.hasLODLevelAvailable(i.geometry)&&!it.hasLODLevelAvailable(i.material))return;const c=va.getObjectLODState(i);if(!c)return;let h=s.mesh_lod;const d=s.mesh_lod!=c.lastLodLevel_Mesh||s.texture_lod!=c.lastLodLevel_Texture;if(Gg&&i.geometry.boundingSphere){const u=i.geometry.boundingSphere;ru.copy(u),ru.applyMatrix4(i.matrixWorld);const p=ru.center,g=ru.radius,y=["#76c43e","#bcc43e","#c4ac3e","#c4673e","#ff3e3e"];if(d)G.DrawWireSphere(p,g,y[h],.1);else{const f=((o=i.geometry.index)==null?void 0:o.count)??0,v=(r=it.getMeshLODInformation(i.geometry))==null?void 0:r.lods;h=v?Math.min(v?.length-1,h):0;let b="";if(v&&c.lastScreenCoverage>0)for(let S=0;S<v.length;S++){const R=v[S].density,M=S==v.length-1;b+=R.toFixed(0)+">"+(R/c.lastScreenCoverage).toFixed(0)+(M?"":",")}const w=v?(l=v[h])==null?void 0:l.density:-1;let _="LOD "+s.mesh_lod+`
TEX `+s.texture_lod;if(Gg=="density"&&(_+=`
`+f+` tris
`+(w/c.lastScreenCoverage).toFixed(0)+` dens
`+(c.lastScreenCoverage*100).toFixed(1)+`% cov
`+(c.lastCentrality*100).toFixed(1)+`% centr
`+(ou.min.x.toFixed(2)+"-"+ou.max.x.toFixed(2)+"x"+ou.min.y.toFixed(2)+"-"+ou.max.y.toFixed(2))+" scr"),c.lastScreenCoverage>.1){const S=t,R=S.worldForward,M=S.worldPosition,T=q(R).multiplyScalar(g*.7).add(p),L=T.distanceTo(M),D=y[Math.min(y.length-1,Math.max(0,h))]+"88",U=this.context.domHeight>0?screen.height/this.context.domHeight:1,B=t.isPerspectiveCamera?Math.tan(t.fov*Math.PI/180/2):1;G.DrawLabel(T,_,L*.012*U*B,void 0,16777215,D)}}}}}const ik=C("debugplayerview");var fo=(n=>(n.Browser="browser",n.Headset="headset",n.Handheld="handheld",n))(fo||{});class V_{constructor(t,i){a(this,"userId"),a(this,"context"),a(this,"viewDevice","browser"),a(this,"removed",!1),a(this,"_object"),this.userId=t,this.context=i}get currentObject(){return this._object}set currentObject(t){this._object=t}get isConnected(){return this.context.connection.userIsInRoom(this.userId)}}class H_{constructor(t){a(this,"context"),a(this,"playerViews",new Map),this.context=t}setPlayerView(t,i,s){let o=this.playerViews.get(t);o||(o=new V_(t,this.context),this.playerViews.set(t,o)),o.viewDevice=s,o.currentObject=i,o.removed=!1}getPlayerView(t){if(!!t){if(!this.context.connection.userIsInRoom(t)){this.playerViews.delete(t);return}return this.playerViews.get(t)}}removePlayerView(t,i){const s=this.playerViews.get(t);s?.viewDevice===i&&(ik&&console.log("REMOVE",t),s.removed=!0,this.playerViews.delete(t))}}new Gy;const Tc=new Uint8Array(4);Tc[0]=255,Tc[1]=255,Tc[2]=255,Tc[3]=255;const nk=new rm(Tc,1,1,ad);function qg(n,t=1){const i="alpha"in n,s=t*t,o=new Uint8Array(4*s),r=Math.floor(n.r*255),l=Math.floor(n.g*255),c=Math.floor(n.b*255);for(let d=0;d<s;d++){const u=d*4;o[u+0]=r,o[u+1]=l,o[u+2]=c,i?o[u+3]=Math.floor(n.alpha*255):o[u+3]=255}const h=new rm(o,t,t);return h.needsUpdate=!0,h}function sk(n,t,i,s=1,o=3){const r=s*o,l=[n,t,i],c=l.length,h=new Uint8Array(4*c*r),d=new ae;for(let p=0;p<o;p++){const g=Math.floor(p/o*c),y=W.clamp(g+1,0,c-1),f=l[g],v=l[y],b=p/o*c%1;d.lerpColors(f,v,b);const w=Math.floor(d.r*255),_=Math.floor(d.g*255),S=Math.floor(d.b*255);for(let R=0;R<s;R++){const M=(p*s+R)*4;h[M+0]=w,h[M+1]=_,h[M+2]=S,h[M+3]=255}}const u=new rm(h,s,o);return u.needsUpdate=!0,u}function au(n,t){const i=n.elements;t||(t=[]),t.length=0;for(let s=0;s<16;s+=4){const o=i[s],r=i[s+1],l=i[s+2],c=i[s+3],h=new fe(o,r,l,c);t.push(h)}return t}const Xg=[],$_=[];function ok(n,t){if(Xg.length===0)for(let i=0;i<27;i++)Xg.push(0);t||(t=Xg);for(let i=0;i<27;i++)$_[i]=t[i];t=$_,n.unity_SHAr={value:new fe(t[9],t[3],t[6],t[0])},n.unity_SHBr={value:new fe(t[12],t[15],t[18],t[21])},n.unity_SHAg={value:new fe(t[10],t[4],t[7],t[1])},n.unity_SHBg={value:new fe(t[13],t[16],t[19],t[22])},n.unity_SHAb={value:new fe(t[11],t[5],t[8],t[2])},n.unity_SHBb={value:new fe(t[14],t[17],t[20],t[23])},n.unity_SHC={value:new fe(t[24],t[25],t[26],1)}}class rk{constructor(t,i,s){a(this,"vertexShader"),a(this,"fragmentShader"),a(this,"technique"),this.vertexShader=t,this.fragmentShader=i,this.technique=s}}async function ak(n,t){if(!n)return console.error("Can not find technique: no shader data"),null;const i=n.programs[t],s=i.vertexShader,o=i.fragmentShader;if(s!==void 0&&o!==void 0){const r=n.shaders[s],l=n.shaders[o];if(r.uri&&l.uri||r.code&&l.code){if(!r.code&&r.uri&&await G_(r),!l.code&&l.uri&&await G_(l),!r.code||!l.code)return null;const c=n.techniques[t];return new rk(r.code,l.code,c)}}return console.error("Shader technique not found",t),null}async function G_(n){const t=n.uri;if(t)if(t.endsWith(".glsl")){const i=await new Gy().loadAsync(t);n.code=i.toString()}else n.code=lk(n.uri)}function lk(n){return decodeURIComponent(Array.prototype.map.call(atob(n),function(t){return"%"+("00"+t.charCodeAt(0).toString(16)).slice(-2)}).join(""))}const Cn=C("debugenvlight");var Ua=(n=>(n[n.Skybox=0]="Skybox",n[n.Trilight=1]="Trilight",n[n.Flat=3]="Flat",n[n.Custom=4]="Custom",n))(Ua||{}),lu=(n=>(n[n.Skybox=0]="Skybox",n[n.Custom=1]="Custom",n))(lu||{});class q_{constructor(t){a(this,"context"),a(this,"_currentLightSettingsId"),a(this,"_sceneLightSettings"),a(this,"_timevec4",new fe),a(this,"__currentReflectionId",null),a(this,"_lighting",{}),this.context=t,this.context.pre_update_callbacks.push(this.preUpdate.bind(this))}preUpdate(){const t=this.context.time;this._timevec4.x=t.time,this._timevec4.y=Math.sin(t.time),this._timevec4.z=Math.cos(t.time),this._timevec4.w=t.deltaTime}get timeVec4(){return this._timevec4}get environmentIntensity(){if(!this._sceneLightSettings||!this._currentLightSettingsId)return 1;const t=this._sceneLightSettings.get(this._currentLightSettingsId);return t?t.ambientIntensity:1}get sceneLightSettings(){var t;return(t=this._sceneLightSettings)==null?void 0:t.values()}enable(t){var i;t instanceof le&&(t=t.url);const s=(i=this._sceneLightSettings)==null?void 0:i.get(t);return s?(Cn&&console.log("Enable scene light settings",t,s),t!==this._currentLightSettingsId&&this._currentLightSettingsId&&this.disable(this._currentLightSettingsId),this._currentLightSettingsId=t,s.enabled=!0,!0):(Cn&&console.warn("No light settings found for",t),!1)}disable(t){var i;if(t instanceof le&&(t=t.url),t==null)return!1;const s=(i=this._sceneLightSettings)==null?void 0:i.get(t);return s?(Cn&&console.log("Disable scene light settings",t,s),s.enabled=!1,!0):!1}disableCurrent(){if(this._currentLightSettingsId){const t=this._currentLightSettingsId;return this.disable(this._currentLightSettingsId),t}return null}internalRegisterSceneLightSettings(t){const i=t.sourceId;if(!i){console.error("Missing source id for scene light settings, can not register:",t);return}Cn&&console.log("Register "+t?.sourceId+" lighting",t),this._sceneLightSettings||(this._sceneLightSettings=new Map),this._sceneLightSettings.set(i,t)}internalUnregisterSceneLightSettings(t){const i=t.sourceId;if(!i){console.error("Missing source id for scene light settings, can not unregister:",t);return}Cn&&console.log("Unregister "+t?.sourceId+" lighting",t),this._sceneLightSettings&&this._sceneLightSettings.delete(i)}internalRegisterReflection(t,i){Cn&&console.log("Register reflection",t,i);const s=new X_(this.context,i,1);this._lighting[t]=s}internalGetReflection(t){return this._lighting[t]}internalEnableReflection(t){var i;this.__currentReflectionId=t;const s=(i=this._sceneLightSettings)==null?void 0:i.get(t);switch(Cn&&console.log("Enable reflection",t,s?Ua[s.ambientMode]:"Unknown ambient mode",s),s?.ambientMode){case 0:case 4:const o=this.internalGetReflection(t);if(o&&o.Source){Cn&&console.log("Setting environment reflection",o);const r=this.context.scene,l=o.Source;l.mapping=ys,r.environment=l;return}else Cn&&console.warn("Could not find reflection for source",t);break}if(s?.environmentReflectionSource===1)switch(s?.ambientMode){case 1:if(s.ambientTrilight){const o=s.ambientTrilight,r=sk(o[0],o[1],o[2],64,64);r.colorSpace=gn,r.mapping=ys,this.context.scene.environment=r}else console.error("Missing ambient trilight",s.sourceId);return;case 3:if(s.ambientLight){const o=qg(s.ambientLight,64);o.colorSpace=gn,o.mapping=ys,this.context.scene.environment=o}else console.error("Missing ambientlight",s.sourceId);return;default:return}}internalDisableReflection(t){if(t&&t!==this.__currentReflectionId){Cn&&console.log("Not disabling reflection for",t,"because it is not the current light settings id",this.__currentReflectionId);return}Cn&&console.log("Disable reflection",t);const i=this.context.scene;i.environment=null}}class X_{constructor(t,i,s=1){a(this,"_source"),this._source=i,i.mapping=ys}get Source(){return this._source}}const Q_=C("timescale");let Qg=1;typeof Q_=="number"&&(Qg=Q_);class Y_{constructor(){a(this,"_time",0),a(this,"_deltaTime",0),a(this,"_deltaTimeUnscaled",0),a(this,"timeScale",1),a(this,"_frame",0),a(this,"clock",new kS),a(this,"_smoothedFps",0),a(this,"_smoothedDeltaTime",0),a(this,"_fpsSamples",[]),a(this,"_fpsSampleIndex",0),typeof Qg=="number"&&(this.timeScale=Qg)}get time(){return this._time}set time(t){this._time=t}get deltaTime(){return this._deltaTime}set deltaTime(t){this._deltaTime=t}get deltaTimeUnscaled(){return this._deltaTimeUnscaled}get frame(){return this._frame}set frame(t){this._frame=t}get frameCount(){return this.frame}get realtimeSinceStartup(){return this.clock.elapsedTime}get fps(){return 1/this.deltaTime}get smoothedFps(){return this._smoothedFps}get smoothedDeltaTime(){return 1/this._smoothedFps}update(){this.deltaTime=this.clock.getDelta(),this.deltaTime=Math.min(.1,this.deltaTime),this._deltaTimeUnscaled=this.deltaTime,this.deltaTime<=0&&(this.deltaTime=1e-12),this.deltaTime*=this.timeScale,this.frame+=1,this.time+=this.deltaTime,this._fpsSamples.length<60?this._fpsSamples.push(this.deltaTime):this._fpsSamples[this._fpsSampleIndex++%60]=this.deltaTime;let t=0;for(let i=0;i<this._fpsSamples.length;i++)t+=this._fpsSamples[i];this._smoothedDeltaTime=t/this._fpsSamples.length,this._smoothedFps=1/this._smoothedDeltaTime}}let Z_=!1;function K_(n){Z_||(Z_=!0,ck(),hk())}K_();function ck(){const n=`
float startCompression = 0.8;
float desaturation = 0.5;
// Patched tonemapping function
vec3 NeutralToneMapping( vec3 color ) {
    color *= toneMappingExposure;
    
    float d = 1. - startCompression;
    // float peak = dot(color, vec3(0.299, 0.587, 0.114));
    float peak = max(color.r, max(color.g, color.b));
    if (peak < startCompression) return color;
    float newPeak = 1. - d * d / (peak + d - startCompression);
    float invPeak = 1. / peak;
    
    float extraBrightness = dot(color * (1. - startCompression * invPeak), vec3(1, 1, 1));
    
    color *= newPeak * invPeak;
    float g = 1. - 3. / (desaturation * extraBrightness + 3.);
    return mix(color, vec3(1, 1, 1), g);
}
`,t="vec3 NeutralToneMapping( vec3 color ) {",i=`return mix( color, vec3( newPeak ), g );
}`,s=qt.tonemapping_pars_fragment.indexOf(t),o=qt.tonemapping_pars_fragment.indexOf(i,s);if(s>=0&&o>=0){const r=qt.tonemapping_pars_fragment.substring(s,o+i.length);qt.tonemapping_pars_fragment=qt.tonemapping_pars_fragment.replace(r,n)}else F()&&console.error("Couldn't find NeutralToneMapping in ShaderChunk.tonemapping_pars_fragment")}function hk(){const n=`
// 0: Default, 1: Golden, 2: Punchy
#define AGX_LOOK 0        

vec3 userSlope = vec3(1.0);
vec3 userOffset = vec3(0.0);
vec3 userPower = vec3(1.0);
float userSaturation = 1.0;

// Mean error^2: 3.6705141e-06
vec3 _agxDefaultContrastApprox(vec3 x) {
    vec3 x2 = x * x;
    vec3 x4 = x2 * x2;
    
    return  + 15.5     * x4 * x2
            - 40.14    * x4 * x
            + 31.96    * x4
            - 6.868    * x2 * x
            + 0.4298   * x2
            + 0.1191   * x
            - 0.00232;
}

vec3 _agx(vec3 val) {
    const mat3 agx_mat = mat3(
        0.842479062253094, 0.0423282422610123, 0.0423756549057051,
        0.0784335999999992,  0.878468636469772,  0.0784336,
        0.0792237451477643, 0.0791661274605434, 0.879142973793104);
    
    const float min_ev = -12.47393;
    const float max_ev = 4.026069;

    // val = pow(val, vec3(2.2)); 

    // Input transform (inset)
    val = agx_mat * val;
    
    // Log2 space encoding
    val = clamp(log2(val), min_ev, max_ev);
    val = (val - min_ev) / (max_ev - min_ev);
    
    // Apply sigmoid function approximation
    val = _agxDefaultContrastApprox(val);

    return val;
}

vec3 _agxEotf(vec3 val) {
    const mat3 agx_mat_inv = mat3(
        1.19687900512017, -0.0528968517574562, -0.0529716355144438,
        -0.0980208811401368, 1.15190312990417, -0.0980434501171241,
        -0.0990297440797205, -0.0989611768448433, 1.15107367264116);
        
    // Inverse input transform (outset)
    val = agx_mat_inv * val;
    
    // sRGB IEC 61966-2-1 2.2 Exponent Reference EOTF Display
    // NOTE: We're linearizing the output here. Comment/adjust when
    // *not* using a sRGB render target
    val = pow(val, vec3(2.2)); 

    return val;
}

vec3 _agxLook(vec3 val) {
    const vec3 lw = vec3(0.2126, 0.7152, 0.0722);
    float luma = dot(val, lw);
    
    // Default
    vec3 offset = vec3(0.0);
    vec3 slope = vec3(1.0);
    vec3 power = vec3(1.0);
    float sat = 1.0;
    
    #if AGX_LOOK == 1
    // Golden
    slope = vec3(1.0, 0.9, 0.5);
    power = vec3(0.8);
    sat = 0.8;
    #elif AGX_LOOK == 2
    // Punchy
    slope = vec3(1.0);
    power = vec3(1.35, 1.35, 1.35);
    sat = 1.4;
    #endif        
    
    // Needle
    slope = vec3(1.05);
    power = vec3(1.10, 1.10, 1.10);
    sat = 1.15;

    // User
    // slope = userSlope;
    // offset = userOffset;
    // power = userPower;
    // sat = userSaturation;
    
    // ASC CDL
    val = pow(val * slope + offset, power);
    return luma + sat * (val - luma);
}


vec3 AgXToneMapping( vec3 color ) {
    // apply AGX
    color *= toneMappingExposure;
    color = _agx(color);
    color = _agxLook(color); // Optional
    color = _agxEotf(color);
    return color;
`,t="vec3 AgXToneMapping( vec3 color ) {",i="return color;",s=qt.tonemapping_pars_fragment.indexOf(t),o=qt.tonemapping_pars_fragment.indexOf(i,s);if(s>=0&&o>=0){const r=qt.tonemapping_pars_fragment.substring(s,o+i.length);qt.tonemapping_pars_fragment=qt.tonemapping_pars_fragment.replace(r,n)}else F()&&console.error("Couldn't find AgXToneMapping in ShaderChunk.tonemapping_pars_fragment")}function Pt(n){const t=document.createElement("span");return t.style.maxWidth="48px",t.style.maxHeight="48px",t.style.overflow="hidden",t.classList.add("material-symbols-outlined","notranslate"),t.setAttribute("translate","no"),t.innerText=n,t}function J_(n){var t;return((t=n.classList)==null?void 0:t.contains("material-symbols-outlined"))||!1}const cu=new Map;async function Yg(n){const t="Material Symbols Outlined";if(document.fonts.check(`1em '${t}'`)||(console.log("Font not loaded yet"),await document.fonts.ready),cu.has(n))return cu.get(n);const i=document.createElement("canvas"),s=48;i.width=s,i.height=s;const o=i.getContext("2d");if(o){o.font=`${s}px '${t}'`,o.fillStyle="black",o.fillText(n,0,s);const r=i.toDataURL(),l=new Le;return l.name=n+" icon",l.image=new Image,l.image.src=r,l.needsUpdate=!0,cu.set(n,l),l}return cu.set(n,null),null}const Zg=class{constructor(){a(this,"_fullscreenButton"),a(this,"_muteButton"),a(this,"_qrButton")}static getOrCreate(){return this._instance||(this._instance=new Zg),this._instance}static create(){return new Zg}get fullscreenButton(){return this._fullscreenButton}createFullscreenButton(n){if(this._fullscreenButton)return this._fullscreenButton;if(!document.fullscreenEnabled)return F()&&console.warn("NeedleMenu: Fullscreen button could not be created, device doesn't support the Fullscreen API"),null;const t=document.createElement("button");this._fullscreenButton=t,t.classList.add("fullscreen-button"),t.title="Click to enter fullscreen mode";const i=Pt("fullscreen"),s=Pt("fullscreen_exit");return t.appendChild(i),t.onclick=()=>{document.fullscreenElement?document.exitFullscreen():"webkitRequestFullscreen"in n.domElement&&typeof n.domElement.webkitRequestFullscreen=="function"?n.domElement.webkitRequestFullscreen():"requestFullscreen"in n.domElement&&n.domElement.requestFullscreen()},document.addEventListener("fullscreenchange",()=>{document.fullscreenElement?(i.remove(),t.appendChild(s),t.title="Click to enter fullscreen mode"):(s.remove(),t.appendChild(i),t.title="Click to exit fullscreen mode")}),globalThis.addEventListener("needle-xrsession-start",()=>{t.style.display="none"}),globalThis.addEventListener("needle-xrsession-end",()=>{t.style.display=""}),t}get muteButton(){return this._muteButton}createMuteButton(n){if(this._muteButton)return this._muteButton;const t=document.createElement("button");this._muteButton=t,t.classList.add("mute-button"),t.title="Click to mute/unmute";const i=Pt("volume_off"),s=Pt("volume_up");return n.application.muted?t.appendChild(i):t.appendChild(s),t.onclick=()=>{n.application.muted?(i.remove(),t.appendChild(s),n.application.muted=!1):(s.remove(),t.appendChild(i),n.application.muted=!0)},t}get qrButton(){return this._qrButton}createQRCode(){if(this._qrButton)return this._qrButton;const n=document.createElement("button");this._qrButton=n,n.innerText="QR Code",n.prepend(Pt("qr_code")),n.title="Scan this QR code with your phone to open this page",this.hideElementDuringXRSession(n);const t=document.createElement("div");t.style.cssText=`
            position: fixed;
            display: inline-block;
            padding: 1rem;
            background-color: white;
            border-radius: 0.4rem;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 0 12px rgba(0, 0, 0, 0.2);
        `;const i=document.createElement("div");i.classList.add("qr-code-container"),t.appendChild(i),n.addEventListener("click",()=>{if(t.parentNode)return o();window.location.href.includes("://localhost")&&we("To access your website from another device in the same local network you have to use the IP address instead of localhost."),s()});async function s(){await r(),document.body.appendChild(t);const l=i.getBoundingClientRect(),c=n.getBoundingClientRect();t.style.left=c.left+c.width*.5-l.width*.5+"px",c.top<l.height?t.style.top=`calc(${c.bottom}px + ${t.style.padding} * .6)`:t.style.top=`calc(${c.top-l.height}px - ${t.style.padding} * 2.5)`,t.style.opacity="0",t.style.pointerEvents="all",t.style.transition="opacity 0.2s ease-in-out",setTimeout(()=>{t.style.opacity="1",window.addEventListener("click",o,{once:!0})}),window.addEventListener("resize",o),window.addEventListener("scroll",o),document.fullscreenElement?document.fullscreenElement.appendChild(t):document.body.appendChild(t)}function o(){t.style.pointerEvents="none",t.style.transition="opacity 0.2s",t.style.opacity="0",setTimeout(()=>{var l;return(l=t.parentNode)==null?void 0:l.removeChild(t)},500),window.removeEventListener("click",o),window.removeEventListener("resize",o),window.removeEventListener("scroll",o)}async function r(){const l=await Rv({text:window.location.href,width:200,height:200});i.innerHTML="",i.appendChild(l)}return n.addEventListener("pointerenter",()=>{r()},{once:!0}),n}hideElementDuringXRSession(n){Pd(t=>{n["previous-display"]=n.style.display,n.style.display="none"}),Jm(t=>{n["previous-display"]!=null&&(n.style.display=n["previous-display"])})}};let ks=Zg;a(ks,"_instance");function hu(n,t){const i=t?.element||document.head,s=Array.from(i.querySelectorAll(`link[rel=stylesheet][href*='${n}']`));if(s.length<=0){const o=document.createElement("link");o.href=n,o.rel="stylesheet",i.appendChild(o),s.push(o)}if(t!=null&&t.loadedCallback)for(let o=0;o<s.length;o++)t!=null&&t.loadedCallback&&s[o].addEventListener("load",t.loadedCallback)}function ew(){hu("https://fonts.googleapis.com/css2?family=Roboto+Flex:opsz,wght@8..144,100..1000&display=swap")}const Kg="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&display=block",du="needle-logo-element";class tw extends HTMLElement{constructor(){super(),a(this,"_root"),a(this,"wrapper"),a(this,"logoElement",document.createElement("img")),a(this,"textElement",document.createElement("span")),this._root=this.attachShadow({mode:"closed"});const t=document.createElement("template");t.innerHTML=`<style>
        :host {
            position: relative;
            min-width: fit-content;
            /* height: 100%; can not have height 100% because of align-items: stretch; in the parent */
            display: flex;
        }

        .wrapper {
            position: relative;
            display: grid;
            grid-template-columns: auto auto;
            padding: .1rem;
        }
        .wrapper:hover {
            cursor: pointer;
        }
        img {
            width: 95px;
            height: 100%;
            align-self: end;
            margin-left: 0.6rem;
        }
        span {
            font-size: 1rem;
            white-space: nowrap;
        }
        </style>
        <div class="wrapper">
            <img class="logo" src=${AP} />
        </div>
        `,this._root.appendChild(t.content.cloneNode(!0)),this.wrapper=this._root.querySelector(".wrapper"),this._root.appendChild(this.wrapper),this.addEventListener("click",()=>{globalThis.open("https://needle.tools","_blank")}),this.wrapper.setAttribute("title","Made with Needle Engine")}static get elementName(){return du}static create(){return document.createElement(du)}setLogoVisible(t){this.logoElement.style.display=t?"block":"none"}}customElements.get(du)||customElements.define(du,tw);const Jg=C("debugspatialmenu");class dk{constructor(t,i){a(this,"_context"),a(this,"needleMenu"),a(this,"htmlButtonsMap",new Map),a(this,"enabled",!0),a(this,"userRequestedMenu",!1),a(this,"uiisDirty",!1),a(this,"_showNeedleLogo"),a(this,"_wasInXR",!1),a(this,"preRender",()=>{var r;if(!this.enabled){(r=this.menu)==null||r.removeFromParent();return}Jg&&Q.isDesktop()&&this.updateMenu();const l=this._context.xr;if(!(l!=null&&l.running)){this._wasInXR&&(this._wasInXR=!1,this.onExitXR());return}this._wasInXR||(this._wasInXR=!0,this.onEnterXR()),this.updateMenu()}),a(this,"_menuTarget",new j),a(this,"positionFilter",new jm(90,.5)),a(this,"familyName","Needle Spatial Menu"),a(this,"menu"),a(this,"_poweredByNeedleElement");var s;this._context=t,this._context.pre_render_callbacks.push(this.preRender),this.needleMenu=i;const o=(s=this.needleMenu.shadowRoot)==null?void 0:s.querySelector(".options");o?new MutationObserver(r=>{if(this.enabled&&!(this._context.isInXR==!1&&!Jg))for(const l of r)l.type==="childList"&&(l.addedNodes.forEach(c=>{this.createButtonFromHTMLNode(c)}),l.removedNodes.forEach(c=>{const h=c,d=this.htmlButtonsMap.get(h);d&&(this.htmlButtonsMap.delete(h),d.remove(),Te.update())}))}).observe(o,{childList:!0}):console.error("Could not find options container in needle menu")}setEnabled(t){var i;this.enabled=t,t||(i=this.menu)==null||i.removeFromParent()}setDisplay(t){return this.enabled?(this.userRequestedMenu=t,!0):!1}onDestroy(){const t=this._context.pre_render_callbacks.indexOf(this.preRender);t>-1&&this._context.pre_render_callbacks.splice(t,1)}markDirty(){this.uiisDirty=!0}showNeedleLogo(t){this._showNeedleLogo=t}onEnterXR(){var t;const i=(t=this.needleMenu.shadowRoot)==null?void 0:t.querySelector(".options");i&&i.childNodes.forEach(s=>{this.createButtonFromHTMLNode(s)})}onExitXR(){var t;(t=this.menu)==null||t.removeFromParent()}createButtonFromHTMLNode(t){const i=this.getMenu(),s=this.htmlButtonsMap.get(t);if(s){s.add();return}if(t instanceof HTMLButtonElement){const o=this.createButton(i,t);this.htmlButtonsMap.set(t,o),o.add()}else t instanceof HTMLSlotElement&&t.assignedNodes().forEach(o=>{this.createButtonFromHTMLNode(o)})}updateMenu(){var t,i;performance.mark("NeedleSpatialMenu updateMenu start");const s=this.getMenu();this.handleNeedleWatermark(),this._context.scene.add(s);const o=this._context.mainCamera,r=this._context.xr,l=r?.rigScale||1;if(o){const c=o.worldPosition,h=o.worldForward.multiplyScalar(-1),d=h.y>.6,u=h.y>.4,p=(s.visible?u:d)||this.userRequestedMenu,g=!s.visible&&p;s.visible=p||Q.isDesktop()&&Jg,h.multiplyScalar(3*l),c.add(h),g&&(s.position.copy(this._menuTarget.position),s.position.y+=.25,this._menuTarget.position.copy(s.position),this.positionFilter.reset(s.position),s.quaternion.copy(this._menuTarget.quaternion),this.markDirty());const y=this._menuTarget.position.distanceTo(c);(g||y>1.5*l)&&(this.ensureRenderOnTop(this.menu),this._menuTarget.position.copy(c),this._context.scene.add(this._menuTarget),tc(this._menuTarget,this._context.mainCamera,!0,!0),this._menuTarget.removeFromParent()),this.positionFilter.filter(this._menuTarget.position,s.position,this._context.time.time);const f=5;(t=this.menu)==null||t.quaternion.slerp(this._menuTarget.quaternion,this._context.time.deltaTime*f),(i=this.menu)==null||i.scale.setScalar(l)}this.uiisDirty&&(performance.mark("SpatialMenu.update.uiisDirty.start"),this.uiisDirty=!1,Te.update(),performance.mark("SpatialMenu.update.uiisDirty.end"),performance.measure("SpatialMenu.update.uiisDirty","SpatialMenu.update.uiisDirty.start","SpatialMenu.update.uiisDirty.end")),performance.mark("NeedleSpatialMenu updateMenu end"),performance.measure("SpatialMenu.update","NeedleSpatialMenu updateMenu start","NeedleSpatialMenu updateMenu end")}ensureRenderOnTop(t,i=0){t instanceof X&&(t.material.depthTest=!1,t.material.depthWrite=!1),t.renderOrder=1e3+i*2;for(const s of t.children)this.ensureRenderOnTop(s,i+1)}get isVisible(){var t;return(t=this.menu)==null?void 0:t.visible}getMenu(){if(this.menu)return this.menu;this.ensureFont(),this.menu=new Te.Block({boxSizing:"border-box",fontFamily:this.familyName,height:"auto",fontSize:.1,color:0,lineHeight:1,backgroundColor:16777215,backgroundOpacity:.55,borderRadius:1,whiteSpace:"pre-wrap",flexDirection:"row",alignItems:"center",padding:new fe(0,.05,0,.05),borderColor:0,borderOpacity:.05,borderWidth:.005});const t=k.get("ObjectRaycaster");return t&&yr(this.menu,new t),this.menu}handleNeedleWatermark(){var t;if(!this._poweredByNeedleElement){this._poweredByNeedleElement=new Te.Block({width:"auto",height:"auto",fontSize:.05,whiteSpace:"pre-wrap",flexDirection:"row",flexWrap:"wrap",justifyContent:"center",margin:.02,borderRadius:.02,padding:.02,backgroundColor:16777215,backgroundOpacity:1}),this._poweredByNeedleElement["needle:use_eventsystem"]=!0;const i=new iw(this._context,()=>globalThis.open("https://needle.tools","_self"));yr(this._poweredByNeedleElement,i);const s=new Te.Text({textContent:"Powered by",width:"auto",height:"auto"}),o=new Te.Text({textContent:"needle",width:"auto",height:"auto",fontSize:.07,margin:new fe(0,0,0,.02)});this._poweredByNeedleElement.add(s),this._poweredByNeedleElement.add(o),(t=this.menu)==null||t.add(this._poweredByNeedleElement),this.markDirty(),new ga().load("./include/needle/poweredbyneedle.webp",r=>{var l;i.allowModifyUI=!1,s.removeFromParent(),o.removeFromParent();const c=r.image.width/r.image.height;(l=this._poweredByNeedleElement)==null||l.set({backgroundImage:r,backgroundOpacity:1,width:.1*c,height:.1}),this.markDirty()})}if(this.menu){const i=this.menu.children.indexOf(this._poweredByNeedleElement);if(!this._showNeedleLogo&&yo())i>=0&&(this._poweredByNeedleElement.removeFromParent(),this.markDirty());else{this._poweredByNeedleElement.visible=!0,this.menu.add(this._poweredByNeedleElement);const s=this.menu.children.indexOf(this._poweredByNeedleElement);i!==s&&this.markDirty()}}}ensureFont(){let t=Te.FontLibrary.getFontFamily(this.familyName);if(!t){t=Te.FontLibrary.addFontFamily(this.familyName);const i=t.addVariant("normal","normal","./include/needle/arial-msdf.json","./include/needle/arial.png");i?.addEventListener("ready",()=>{this.markDirty()})}}createButton(t,i){const s=new Te.Block({width:"auto",height:"auto",whiteSpace:"pre-wrap",flexDirection:"row",flexWrap:"wrap",justifyContent:"center",backgroundColor:16777215,backgroundOpacity:0,padding:.02,margin:.01,borderRadius:.02,cursor:"pointer",fontSize:.05}),o=new Te.Text({textContent:"",width:"auto",justifyContent:"center",alignItems:"center",backgroundOpacity:0,backgroundColor:16777215,fontFamily:this.familyName,color:0,borderRadius:.02,padding:.01});s.add(o),s["needle:use_eventsystem"]=!0;const r=new iw(this._context,()=>i.click());return yr(s,r),new uk(this,t,i,s,o)}}class uk{constructor(t,i,s,o,r){a(this,"menu"),a(this,"root"),a(this,"htmlbutton"),a(this,"spatialContainer"),a(this,"spatialText"),a(this,"spatialIcon"),a(this,"_lastText",""),a(this,"_lastTexture"),this.menu=t,this.root=i,this.htmlbutton=s,this.spatialContainer=o,this.spatialText=r,new MutationObserver(l=>{for(const c of l)c.type==="attributes"?c.attributeName==="style"&&this.updateVisible():c.type==="childList"&&this.updateText()}).observe(s,{attributes:!0,childList:!0}),this.updateText()}add(){this.spatialContainer.parent!=this.root&&(this.root.add(this.spatialContainer),this.menu.markDirty(),this.updateVisible(),this.updateText())}remove(){this.spatialContainer.parent&&(this.spatialContainer.removeFromParent(),this.menu.markDirty())}updateVisible(){const t=this.spatialContainer.visible;this.spatialContainer.visible=this.htmlbutton.style.display!=="none",t!==this.spatialContainer.visible&&this.menu.markDirty()}updateText(){let t="",i="";this.htmlbutton.childNodes.forEach(s=>{s.nodeType===Node.TEXT_NODE?t+=s.textContent:s instanceof HTMLElement&&J_(s)&&s.textContent&&(i=s.textContent)}),this._lastText!==t&&(this._lastText=t,this.spatialText.name=t,this.spatialText.set({textContent:t}),this.menu.markDirty()),t.length<=0?this.spatialText.parent&&(this.spatialText.removeFromParent(),this.menu.markDirty()):this.spatialText.parent||(this.spatialContainer.add(this.spatialText),this.menu.markDirty()),i&&this.createIcon(i)}async createIcon(t){var i;if(!this.spatialIcon){const o=await Yg(t);if(o&&!this.spatialIcon){const r=new Te.Block({width:.08,height:.08,backgroundColor:16777215,backgroundImage:o,backgroundOpacity:1,margin:new fe(0,.005,0,0)});this.spatialIcon=r,this.spatialContainer.add(r),this.menu.markDirty()}}if(t!=this._lastTexture){this._lastTexture=t;const o=await Yg(t);o&&((i=this.spatialIcon)==null||i.set({backgroundImage:o}),this.menu.markDirty())}const s=this.spatialContainer.children.indexOf(this.spatialIcon);s>0&&(this.spatialContainer.children.splice(s,1),this.spatialContainer.children.unshift(this.spatialIcon),this.menu.markDirty())}}class iw{constructor(t,i){a(this,"isComponent",!0),a(this,"enabled",!0),a(this,"gameObject"),a(this,"allowModifyUI",!0),a(this,"context"),a(this,"onclick"),this.context=t,this.onclick=i}get activeAndEnabled(){return!0}__internalAwake(){}__internalEnable(){}__internalDisable(){}__internalStart(){}onEnable(){}onDisable(){}get element(){return this.gameObject}onPointerEnter(){this.context.input.setCursor("pointer"),this.allowModifyUI&&(this.element.set({backgroundOpacity:1}),Te.update())}onPointerExit(){this.context.input.unsetCursor("pointer"),this.allowModifyUI&&(this.element.set({backgroundOpacity:0}),Te.update())}onPointerDown(t){t.use()}onPointerUp(t){t.use()}onPointerClick(t){t.use(),this.onclick()}}const Sr="needle-menu",Ec=C("debugmenu"),nw=C("debugnoncommercial");let pk=class{constructor(n){a(this,"_context"),a(this,"_menu"),a(this,"_spatialMenu"),a(this,"onPostMessage",t=>{if(t.origin===globalThis.location.origin&&typeof t.data=="object"){const i=t.data,s=i.type;if(s==="needle:menu"){const o=i.button;if(o){if(!o.label)return console.error("NeedleMenu: buttoninfo.label is required");if(!o.onclick)return console.error("NeedleMenu: buttoninfo.onclick is required");const r=document.createElement("button");if(r.textContent=o.label,o.icon){const l=Pt(o.icon);r.prepend(l)}o.priority&&r.setAttribute("priority",o.priority.toString()),r.onclick=()=>{if(o.onclick){const l=o.onclick.startsWith("http")||o.onclick.startsWith("www."),c=o.target||"_blank";l?globalThis.open(o.onclick,c):console.error("NeedleMenu: onclick is not a valid link",o.onclick)}},this._menu.appendChild(r)}else Ec&&console.error("NeedleMenu: unknown postMessage event",i)}else Ec&&console.warn("NeedleMenu: unknown postMessage type",s,i)}}),a(this,"onStartXR",t=>{t.session.isScreenBasedAR&&(this._menu.previousParent=this._menu.parentNode,this._context.arOverlayElement.appendChild(this._menu),t.session.session.addEventListener("end",this.onExitXR),this._menu.closeFoldout())}),a(this,"onExitXR",()=>{this._menu.previousParent&&(this._menu.previousParent.appendChild(this._menu),delete this._menu.previousParent)}),a(this,"_muteButton"),a(this,"_fullscreenButton"),this._menu=ow.getOrCreate(n.domElement,n),this._context=n,this._spatialMenu=new dk(n,this._menu),window.addEventListener("message",this.onPostMessage),Pd(this.onStartXR)}onDestroy(){window.removeEventListener("message",this.onPostMessage),this._menu.remove(),this._spatialMenu.onDestroy()}setPosition(n){this._menu.setPosition(n)}setVisible(n){this._menu.setVisible(n)}showNeedleLogo(n){var t;this._menu.showNeedleLogo(n),(t=this._spatialMenu)==null||t.showNeedleLogo(n)}showSpatialMenu(n){this._spatialMenu.setEnabled(n)}setSpatialMenuVisible(n){this._spatialMenu.setDisplay(n)}get spatialMenuIsVisible(){return this._spatialMenu.isVisible}showQRCodeButton(n){if(n==="desktop-only"&&(n=!Q.isMobileDevice()),n){const t=ks.getOrCreate().createQRCode();return t.style.display="",this._menu.appendChild(t),t}else{const t=ks.getOrCreate().qrButton;return t&&(t.style.display="none"),t??null}}showAudioPlaybackOption(n){var t;if(!n){(t=this._muteButton)==null||t.remove();return}this._muteButton=ks.getOrCreate().createMuteButton(this._context),this._muteButton.setAttribute("priority","100"),this._menu.appendChild(this._muteButton)}showFullscreenOption(n){var t;if(!n){(t=this._fullscreenButton)==null||t.remove();return}this._fullscreenButton=ks.getOrCreate().createFullscreenButton(this._context),this._fullscreenButton&&(this._fullscreenButton.setAttribute("priority","150"),this._menu.appendChild(this._fullscreenButton))}appendChild(n){return this._menu.appendChild(n)}};var uu;const sw=class extends HTMLElement{constructor(){var n,t,i,s,o,r;super(),a(this,"_domElement",null),a(this,"_context",null),a(this,"_sizeChangeInterval"),pn(this,uu,f=>{if(!f.defaultPrevented&&f.target==this._domElement&&f instanceof PointerEvent&&f.button===0&&this.root.classList.contains("open")){const v=this.foldout.getBoundingClientRect(),b=f;b.clientX>v.left&&b.clientX<v.right&&b.clientY>v.top&&b.clientY<v.bottom||this.root.classList.toggle("open",!1)}}),a(this,"_userRequestedLogoVisible"),a(this,"_userRequestedMenuVisible"),a(this,"root"),a(this,"wrapper"),a(this,"options"),a(this,"logoContainer"),a(this,"compactMenuButton"),a(this,"foldout"),a(this,"_isHandlingChange",!1),a(this,"_didSort",new Map),a(this,"_lastAvailableWidthChange",0),a(this,"_timeoutHandle",0),a(this,"handleSizeChange",(f,v)=>{if(!this._domElement)return;const b=this._domElement.clientWidth;if(b<100){clearTimeout(this._timeoutHandle),this.root.classList.add("compact"),this.foldout.classList.add("floating-panel-style");return}const w=20*2,_=b-w;if(!v&&Math.abs(_-this._lastAvailableWidthChange)<1)return;this._lastAvailableWidthChange=_,clearTimeout(this._timeoutHandle),this._timeoutHandle=setTimeout(()=>{const M=R();M<0?(this.root.classList.add("compact"),this.foldout.classList.add("floating-panel-style")):M>0&&(this.root.classList.remove("compact"),this.foldout.classList.remove("floating-panel-style"),R()<0&&(this.root.classList.add("compact"),this.foldout.classList.add("floating-panel-style")))},5);const S=()=>this.options.clientWidth+this.logoContainer.clientWidth,R=()=>_-S()});const l=document.createElement("template");l.innerHTML=`<style>

        #root {
            position: absolute;
            width: auto;
            max-width: 95%;
            left: 50%;
            transform: translateX(-50%);
            top: min(20px, 10vh);
            padding: 0.3rem;
            display: flex;
            visibility: visible;
            flex-direction: row-reverse; /* if we overflow this should be right aligned so the logo is always visible */
            pointer-events: all;
            z-index: 1000;
        }

        /** hide the menu if it's empty **/
        #root.has-no-options.logo-hidden {
            display: none; 
        }

        /** using a div here because then we can change the class for placement **/
        #root.bottom {
            top: auto;
            bottom: min(30px, 10vh);
        }
        #root.top {
            top: calc(.7rem + env(safe-area-inset-top));
        }
        
        .wrapper {
            position: relative;
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: stretch;
            gap: 0px;
            padding: 0 0rem;
        }

        .wrapper > *, .options > button, .options > select, ::slotted(*) {
            position: relative;
            border: none;
            border-radius: 0;
            outline: 1px solid rgba(0,0,0,0);
            display: flex;
            justify-content: center;
            align-items: center;
            max-height: 2.3rem;
            max-width: 100%;

            /** basic font settings for all entries **/
            font-size: 1rem;
            font-family: 'Roboto Flex', sans-serif;
            font-optical-sizing: auto;
            font-weight: 500;
            font-weight: 200;
            font-variation-settings: "wdth" 100;
            color: rgb(20,20,20);
        }

        .options > select[multiple]:hover {
            max-height: 300px;
        }

        .floating-panel-style {
            background: rgba(255, 255, 255, .4);
            outline: rgb(0 0 0 / 5%) 1px solid;
            border: 1px solid rgba(255, 255, 255, .1);
            box-shadow: 0px 7px 0.5rem 0px rgb(0 0 0 / 6%), inset 0px 0px 1.3rem rgba(0,0,0,.05);
            border-radius: 1.5rem;
            /** 
             * to make nested background filter work 
             * https://stackoverflow.com/questions/60997948/backdrop-filter-not-working-for-nested-elements-in-chrome 
             **/
            &::before {
                content: '';
                position: absolute;
                width: 100%;
                height: 100%;
                top: 0;
                left: 0;
                z-index: -1;
                border-radius: 1.5rem;
                -webkit-backdrop-filter: blur(8px);
                backdrop-filter: blur(8px);
            }
        }

        a {
            color: inherit;
            text-decoration: none;
        }

        .options {
            display: flex;
            flex-direction: row;
            align-items: center;
        }

        .options > *, ::slotted(*) {
            max-height: 2.25rem;
            padding: .4rem .5rem;
        }
        
        :host .options > *, ::slotted(*) {
            background: transparent;
            border: none;
            white-space: nowrap;
            transition: all 0.1s linear .02s;
            border-radius: 1.5rem;
            user-select: none;
        }
        :host .options > *:hover, ::slotted(*:hover) {
            cursor: pointer;
            color: black;
            background: rgba(245, 245, 245, .8);
            box-shadow: inset 0 0 1rem rgba(0,0,30,.2);
            outline: rgba(0,0,0,.1) 1px solid;
        }
        :host .options > *:active, ::slotted(*:active) {
            background: rgba(255, 255, 255, .8);
            box-shadow: inset 0px 1px 1px rgba(255,255,255,.5), inset 0 0 2rem rgba(0,0,30,.2), inset 0px 2px 4px rgba(0,0,20,.5);
            transition: all 0.05s linear;
        }
        :host .options > *:focus, ::slotted(*:focus) {
            outline: rgba(255,255,255,.5) 1px solid;
        }
        :host .options > *:focus-visible, ::slotted(*:focus-visible) {
            outline: rgba(0,0,0,.5) 1px solid;
        }

        :host .options > *:disabled, ::slotted(*:disabled) {
            background: rgba(0,0,0,.05);
            color: rgba(60,60,60,.7);
            pointer-events: none;
        }

        button, ::slotted(button) {
            gap: 0.3rem;
        }

        /** XR button animation **/
        :host button.this-mode-is-requested {
            background: repeating-linear-gradient(to right, #fff 0%, #fff 40%, #aaffff 55%, #fff 80%);
            background-size: 200% auto;
            background-position: 0 100%;
            animation: AnimationName .7s ease infinite forwards;
        }
        :host button.other-mode-is-requested {
            opacity: .5;
        }
        
        @keyframes AnimationName {
            0% { background-position: 0% 0 }
            100% { background-position: -200% 0 }
        }




        .logo {
            cursor: pointer;
            padding-left: 0.6rem;
            padding-bottom: .02rem;
            margin-right: 0.5rem;
        }
        .logo-hidden {
            .logo {
                display: none;
            }
        }
        :host .has-options .logo {
            border-left: 1px solid rgba(40,40,40,.4);
            margin-left: 0.3rem;
            margin-right: 0.5rem;
        }

        .logo > span {
            white-space: nowrap;
        }



        /** COMPACT */

        /** Hide the menu button normally **/
        .compact-menu-button { display: none; }
        /** And show it when we're in compact mode **/
        .compact .compact-menu-button {
            position: relative;
            display: block;
            background: none;
            border: none;
            border-radius: 2rem;

            margin: 0;
            padding: 0 .3rem;
            padding-top: .2rem;

            z-index: 100;

            color: #000;

            &:hover {
                background: rgba(255,255,255,.2);
                cursor: pointer;
            }
            &:focus {
                outline: 1px solid rgba(255,255,255,.5);
            }
            &:focus-visible {
                outline: 1px solid rgba(0,0,0,.5);
            }
            & .expanded-click-area {
                position: absolute;
                left: 0;
                right: 0;
                top: 10%;
                bottom: 10%;
                transform: scale(1.8);
            }
        }  
        .has-no-options .compact-menu-button {
            display: none;
        }
        .open .compact-menu-button {
            background: rgba(255,255,255,.2);
        }
        .logo-visible .compact-menu-button { 
            margin-left: .2rem;
        }
        
        /** Open and hide menu **/
        .compact .foldout { 
            display: none;
        }
        .open .options, .open .foldout {
            display: flex;
            justify-content: center;
        }
        .compact .wrapper {
            padding: 0;
        }
        .compact .wrapper, .compact .options {
            height: auto;
            max-height: initial;
            flex-direction: row;
            gap: .12rem;
        }
        .compact .options { 
            flex-wrap: wrap;
            gap: .3rem;
        }
        .compact .top .options {
            height: auto;
            flex-direction: row;
        }
        .compact .bottom .wrapper {
            height: auto;
            flex-direction: column;
        }

        .compact .foldout {
            max-height: min(100ch, calc(100vh - 100px));
            overflow: auto;
            overflow-x: hidden;
            align-items: center;

            position: fixed;
            bottom: calc(100% + 5px);
            z-index: 100;
            width: auto;
            left: .2rem;
            right: .2rem;
            padding: .2rem;

        }
        .compact.logo-hidden .foldout {
            /** for when there's no logo we want to center the foldout **/
            min-width: 24ch;
            margin-left: 50%;
            transform: translateX(calc(-50% - .2rem));
        }
        
        .compact.top .foldout {
            top: calc(100% + 5px);
            bottom: auto;
        }

        ::-webkit-scrollbar {
            max-width: 7px;
            background: rgba(100,100,100,.2);
            border-radius: .2rem;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, .3);
            border-radius: .2rem;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgb(150,150,150);
        }

        .compact .options > *, .compact .options > ::slotted(*) {
            font-size: 1.2rem;
            padding: .6rem .5rem;
            width: 100%;
        }
        .compact.has-options .logo {
            border: none;
            padding-left: 0;
            margin-left: 1rem;
            margin-bottom: .02rem;
        }
        .compact .options {
            /** e.g. if we have a very wide menu item like a select with long option names we don't want to overflow **/
            max-width: 100%;

            & > button, & > select {
                display: flex;
                flex-basis: 100%;
                min-height: 3rem;
            }
            & > button.row2 {
                //border: 1px solid red !important;
                display: flex;
                flex: 1;
                flex-basis: 30%;
            }
        }

        /** If there's really not enough space then just hide all options **/
        @media (max-width: 100px) or (max-height: 100px){
            .foldout {
                display: none !important;
            }
            .compact-menu-button {
                display: none !important;
            }
        }
        
        /* dark mode */
        /*
        @media (prefers-color-scheme: dark) {
            :host {
                background: rgba(0,0,0, .6);
            }
            :host button {
                color: rgba(200,200,200);
            }
            :host button:hover {
                background: rgba(100,100,100, .8);
            }
        }
        */

        </style>
        
        <div id="root" class="logo-visible floating-panel-style bottom">
            <div class="wrapper">
                <div class="foldout">
                    <div class="options" part="options">
                        <slot></slot>
                    </div>
                    <div class="options" part="options">
                        <slot name="end"></slot>
                    </div>
                </div>
                <div style="user-select:none" class="logo">
                    <span class="madewith notranslate">powered by</span>
                </div>
            </div>
            <button class="compact-menu-button">
                <div class="expanded-click-area"></div>
            </button>
        </div>
        `;const c=this.attachShadow({mode:"open"});ew(),hu(Kg,{loadedCallback:()=>{this.handleSizeChange()}}),hu(Kg,{element:c});const h=l.content.cloneNode(!0);c?.appendChild(h),this.root=c.querySelector("#root"),this.wrapper=(n=this.root)==null?void 0:n.querySelector(".wrapper"),this.options=(t=this.root)==null?void 0:t.querySelector(".options"),this.logoContainer=(i=this.root)==null?void 0:i.querySelector(".logo"),this.compactMenuButton=(s=this.root)==null?void 0:s.querySelector(".compact-menu-button"),this.compactMenuButton.append(Pt("more_vert")),this.foldout=(o=this.root)==null?void 0:o.querySelector(".foldout"),(r=this.root)==null||r.appendChild(this.wrapper),this.wrapper.classList.add("wrapper");const d=tw.create();d.style.minHeight="1rem",this.logoContainer.append(d),this.logoContainer.addEventListener("click",()=>{globalThis.open("https://needle.tools","_blank")});try{window.requestAnimationFrame(()=>_k(f=>{if(f==!0&&On()&&!nw){let v=this._userRequestedLogoVisible;v===void 0&&(v=!1),this.___onSetLogoVisible(v)}}))}catch(f){console.error("[Needle Menu] License check failed.",f)}this.compactMenuButton.addEventListener("click",f=>{f.preventDefault(),this.root.classList.toggle("open")});let u=this._context;setTimeout(()=>u=this._context);let p=0;const g=(f,v)=>{var b,w,_;Ec&&console.log("Set menu visible",v),u!=null&&u.isInAR&&u.arOverlayElement?f!=u.arOverlayElement&&u.arOverlayElement.appendChild(this):this.parentNode!=((b=this._domElement)==null?void 0:b.shadowRoot)&&((_=(w=this._domElement)==null?void 0:w.shadowRoot)==null||_.appendChild(this)),this.style.display=v?"flex":"none",this.style.visibility="visible",this.style.opacity="1"};let y=!1;new MutationObserver(f=>{var v;if(!y)try{y=!0,this.onChangeDetected(f);const b=this==null?void 0:this.parentNode;if((this.style.display!="flex"||this.style.visibility!="visible"||this.style.opacity!="1"||b!=((v=this._domElement)==null?void 0:v.shadowRoot))&&!On()){const w=p++;Xt()&&this._userRequestedMenuVisible===!1?(w===0&&g(b,this._userRequestedMenuVisible),w===1&&console.warn("Needle Menu Warning: You need a PRO license to hide the Needle Engine menu \u2192 The menu will be visible in your deployed website if you don't have a PRO license. See https://needle.tools/pricing for details.")):w===0?g(b,!0):setTimeout(()=>g(b,!0),5)}}finally{y=!1}}).observe(this.root,{childList:!0,subtree:!0,attributes:!0}),Ec&&this.___insertDebugOptions()}static create(){return document.createElement(Sr,{is:Sr})}static getOrCreate(n,t){let i=n.querySelector(Sr);return!i&&n.shadowRoot&&(i=n.shadowRoot.querySelector(Sr)),i||(i=window.document.body.querySelector(Sr)),i||(i=sw.create(),n.shadowRoot?n.shadowRoot.appendChild(i):n.appendChild(i)),i._domElement=n,i._context=t,i}connectedCallback(){window.addEventListener("resize",this.handleSizeChange),this.handleMenuVisible(),this._sizeChangeInterval=setInterval(()=>this.handleSizeChange(void 0,!0),5e3),setTimeout(()=>{var n,t;(n=this._domElement)==null||n.addEventListener("resize",this.handleSizeChange),(t=this._domElement)==null||t.addEventListener("click",ge(this,uu))},1)}disconnectedCallback(){var n,t;window.removeEventListener("resize",this.handleSizeChange),clearInterval(this._sizeChangeInterval),(n=this._domElement)==null||n.removeEventListener("resize",this.handleSizeChange),(t=this._context)==null||t.domElement.removeEventListener("click",ge(this,uu))}showNeedleLogo(n){this._userRequestedLogoVisible=n,!(!n&&(!On()||nw)&&(console.warn("Needle Menu: You need a PRO license to hide the Needle Engine logo."),!Xt()))&&this.___onSetLogoVisible(n)}___onSetLogoVisible(n){this.logoContainer.style.display="",this.logoContainer.style.opacity="1",this.logoContainer.style.visibility="visible",n?(this.root.classList.remove("logo-hidden"),this.root.classList.add("logo-visible")):(this.root.classList.remove("logo-visible"),this.root.classList.add("logo-hidden"))}setPosition(n){if(n!=="top"&&n!=="bottom")return console.error("NeedleMenu.setPosition: invalid position",n);this.root.classList.remove("top","bottom"),this.root.classList.add(n)}setVisible(n){this._userRequestedMenuVisible=n,this.style.display=n?"flex":"none"}closeFoldout(){this.root.classList.remove("open")}append(...n){for(const t of n)if(typeof t=="string"){const i=document.createTextNode(t);this.options.appendChild(i)}else this.options.appendChild(t)}appendChild(n){var t;if(!(n instanceof Node)){const i=document.createElement("button");if(i.textContent=n.label,i.onclick=n.onClick,i.setAttribute("priority",((t=n.priority)==null?void 0:t.toString())??"0"),n.title&&(i.title=n.title),n.icon){const s=Pt(n.icon);n.iconSide==="right"?i.appendChild(s):i.prepend(s)}n.class&&i.classList.add(n.class),n=i}return this.options.appendChild(n)}prepend(...n){for(const t of n)if(typeof t=="string"){const i=document.createTextNode(t);this.options.prepend(i)}else this.options.prepend(t)}onChangeDetected(n){if(!this._isHandlingChange){this._isHandlingChange=!0;try{this.handleMenuVisible();for(const t of n)t.target==this.options&&this.onOptionsChildrenChanged(t)}finally{this._isHandlingChange=!1}}}onOptionsChildrenChanged(n){if(this.root.classList.toggle("has-options",this.hasAnyVisibleOptions),this.root.classList.toggle("has-no-options",!this.hasAnyVisibleOptions),this.handleSizeChange(void 0,!0),n.type==="childList"&&n.addedNodes.length>0){const t=Array.from(this.options.children);t.sort((s,o)=>{const r=parseInt(s.getAttribute("priority")||"0"),l=parseInt(o.getAttribute("priority")||"0");return r-l});let i=!1;for(let s=0;s<t.length;s++){const o=this.options.children[s],r=t[s];if(o!==r){i=!0;break}}if(i)for(const s of t)this.options.appendChild(s)}}handleMenuVisible(){Ec&&console.log("Update VisibleState: Any Content?",this.hasAnyContent),this.hasAnyContent?this.root.style.display="":this.root.style.display="none",this.root.classList.toggle("has-options",this.hasAnyVisibleOptions),this.root.classList.toggle("has-no-options",!this.hasAnyVisibleOptions)}get hasAnyContent(){return!!(this.logoContainer.style.display!="none"||this.hasAnyVisibleOptions)}get hasAnyVisibleOptions(){for(let n=0;n<this.options.children.length;n++){const t=this.options.children[n];if(t.tagName==="SLOT"){const i=t.assignedNodes();for(const s of i)if(s instanceof HTMLElement&&s.style.display!="none")return!0}else if(t.style.display!="none")return!0}return!1}___insertDebugOptions(){window.addEventListener("keydown",i=>{i.key==="p"&&this.setPosition(this.root.classList.contains("top")?"bottom":"top")});const n=document.createElement("button");n.textContent="Hide Buttons",n.onclick=()=>{const i=new Array(this.options.children.length);for(let s=0;s<this.options.children.length;s++)i[s]=this.options.children[s];for(const s of i)this.options.removeChild(s);setTimeout(()=>{for(const s of i)this.options.appendChild(s)},1e3)},this.appendChild(n);const t=document.createElement("button");t.textContent="Toggle Logo",t.addEventListener("click",()=>{this.logoContainer.style.display=this.logoContainer.style.display==="none"?"":"none"}),this.appendChild(t)}};let ow=sw;uu=new WeakMap,customElements.get(Sr)||customElements.define(Sr,ow);const at=C("debugcontext"),mk=C("stats"),gk=C("debugactive"),fk=C("debugframerate"),yk=C("debugcoroutine"),vk={};class bk{constructor(){a(this,"name"),a(this,"alias"),a(this,"hash"),a(this,"runInBackground"),a(this,"domElement"),a(this,"renderer"),a(this,"camera"),a(this,"scene")}}var Me=(n=>(n[n.Start=-1]="Start",n[n.EarlyUpdate=0]="EarlyUpdate",n[n.Update=1]="Update",n[n.LateUpdate=2]="LateUpdate",n[n.OnBeforeRender=3]="OnBeforeRender",n[n.OnAfterRender=4]="OnAfterRender",n[n.PrePhysicsStep=9]="PrePhysicsStep",n[n.PostPhysicsStep=10]="PostPhysicsStep",n[n.Undefined=-1]="Undefined",n))(Me||{});function pu(n,t){if(!n)return;if(!n.isComponent){(F()||at)&&console.error(`Registered script is not a Needle Engine component. 
The script will be ignored. Please make sure your component extends "Behaviour" imported from "@needle-tools/engine"
`,n);return}t||(t=ee.Current,at&&console.warn("> Registering component without context"));const i=t?.new_scripts;i.includes(n)||i.push(n)}const Ie=class{constructor(n){a(this,"name"),a(this,"alias"),a(this,"isManagedExternally",!1),a(this,"isPaused",!1),a(this,"runInBackground",!1),a(this,"targetFrameRate"),a(this,"physicsSteps",1),a(this,"hash"),a(this,"domElement"),a(this,"_resolutionScaleFactor",1),a(this,"_boundingClientRectFrame",-1),a(this,"_boundingClientRect",null),a(this,"_domX"),a(this,"_domY"),a(this,"xr",null),a(this,"_xrFrame",null),a(this,"_currentFrameEvent",-1),a(this,"scene"),a(this,"renderer"),a(this,"composer",null),a(this,"scripts",[]),a(this,"scripts_pausedChanged",[]),a(this,"scripts_earlyUpdate",[]),a(this,"scripts_update",[]),a(this,"scripts_lateUpdate",[]),a(this,"scripts_onBeforeRender",[]),a(this,"scripts_onAfterRender",[]),a(this,"scripts_WithCorroutines",[]),a(this,"scripts_immersive_vr",[]),a(this,"scripts_immersive_ar",[]),a(this,"coroutines",{}),a(this,"post_setup_callbacks",[]),a(this,"pre_update_callbacks",[]),a(this,"pre_render_callbacks",[]),a(this,"post_render_callbacks",[]),a(this,"pre_update_oneshot_callbacks",[]),a(this,"new_scripts",[]),a(this,"new_script_start",[]),a(this,"new_scripts_pre_setup_callbacks",[]),a(this,"new_scripts_post_setup_callbacks",[]),a(this,"new_scripts_xr",[]),a(this,"mainCameraComponent"),a(this,"_mainCamera",null),a(this,"_fallbackCamera",null),a(this,"application"),a(this,"animations"),a(this,"time"),a(this,"input"),a(this,"physics"),a(this,"connection"),a(this,"assets"),a(this,"mainLight",null),a(this,"sceneLighting"),a(this,"addressables"),a(this,"lightmaps"),a(this,"players"),a(this,"lodsManager"),a(this,"menu"),a(this,"_sizeChanged",!1),a(this,"_isCreated",!1),a(this,"_isCreating",!1),a(this,"_isVisible",!1),a(this,"_stats",mk?new BC:null),a(this,"_intersectionObserver",null),a(this,"_disposeCallbacks",[]),a(this,"maxRenderResolution"),a(this,"_originalCreationArgs"),a(this,"onUnhandledRejection",s=>{this.onError(s.reason)}),a(this,"_cameraStack",[]),a(this,"_onBeforeRenderListeners",new Map),a(this,"_onAfterRenderListeners",new Map),a(this,"_requireDepthTexture",!1),a(this,"_requireColorTexture",!1),a(this,"_renderTarget"),a(this,"_isRendering",!1),a(this,"_createId",0),a(this,"_renderlooperrors",0),a(this,"_lastTimestamp",0),a(this,"_accumulatedTime",0),a(this,"_dispatchReadyAfterFrame",!1),a(this,"_contextRestoreTries",0),a(this,"_wasPaused",!1),this.name=n?.name||"",this.alias=n?.alias,this.domElement=n?.domElement||document.body,this.hash=n?.hash,n!=null&&n.renderer&&(this.renderer=n.renderer,this.isManagedExternally=!0),n?.runInBackground!==void 0&&(this.runInBackground=n.runInBackground),n!=null&&n.scene?this.scene=n.scene:this.scene=new wi,n!=null&&n.camera&&(this._mainCamera=n.camera),this.application=new Ps(this),this.time=new Y_,this.input=new pb(this),this.physics=new Ad(this),this.connection=new Mb(this),this.assets=new Hb,this.sceneLighting=new q_(this),this.addressables=new D_(this),this.lightmaps=new ek(this),this.players=new H_(this),this.menu=new pk(this),this.lodsManager=new tk(this),this.animations=new Z2(this);const t=()=>this._sizeChanged=!0;window.addEventListener("resize",t),this._disposeCallbacks.push(()=>window.removeEventListener("resize",t));const i=new ResizeObserver(s=>this._sizeChanged=!0);i.observe(this.domElement),this._disposeCallbacks.push(()=>i.disconnect()),this._intersectionObserver=new IntersectionObserver(s=>{this._isVisible=s[0].isIntersecting}),this._disposeCallbacks.push(()=>{var s;return(s=this._intersectionObserver)==null?void 0:s.disconnect()}),ue.register(this)}static get DefaultTargetFrameRate(){return Ie._defaultTargetFramerate.value}static set DefaultTargetFrameRate(n){Ie._defaultTargetFramerate.value=n}static get DefaultWebGLRendererParameters(){return Ie._defaultWebglRendererParameters}get version(){return _n}static get Current(){return ue.Current}static set Current(n){ue.Current=n}static get All(){return ue.All}appendHTMLElement(n){return this.domElement.shadowRoot?this.domElement.shadowRoot.appendChild(n):this.domElement.appendChild(n)}get resolutionScaleFactor(){return this._resolutionScaleFactor}set resolutionScaleFactor(n){if(n!==this._resolutionScaleFactor&&typeof n=="number"){if(n<=0){console.error("Invalid resolution scale factor",n);return}this._resolutionScaleFactor=n,this.updateSize()}}calculateBoundingClientRect(){if(this.xr){this._domX=0,this._domY=0;return}this._boundingClientRectFrame!==this.time.frame&&(this._boundingClientRectFrame=this.time.frame,this._boundingClientRect=this.domElement.getBoundingClientRect(),this._domX=this._boundingClientRect.x,this._domY=this._boundingClientRect.y)}get domWidth(){return this.isInAR?window.innerWidth:this.domElement.clientWidth}get domHeight(){return this.isInAR?window.innerHeight:this.domElement.clientHeight}get domX(){return this.calculateBoundingClientRect(),this._domX}get domY(){return this.calculateBoundingClientRect(),this._domY}get isInXR(){var n,t;return((t=(n=this.renderer)==null?void 0:n.xr)==null?void 0:t.isPresenting)||!1}get xrSessionMode(){var n;return(n=this.xr)==null?void 0:n.mode}get isInVR(){return this.xrSessionMode==="immersive-vr"}get isInAR(){return this.xrSessionMode==="immersive-ar"}get isInPassThrough(){return this.xr?this.xr.isPassThrough:!1}get xrSession(){var n,t;return(t=(n=this.renderer)==null?void 0:n.xr)==null?void 0:t.getSession()}get xrFrame(){return this._xrFrame}get xrCamera(){var n,t;return this.renderer.xr.isPresenting?(t=(n=this.renderer)==null?void 0:n.xr)==null?void 0:t.getCamera():void 0}get arOverlayElement(){const n=this.domElement;return typeof n.getAROverlayContainer=="function"?n.getAROverlayContainer():this.domElement}get currentFrameEvent(){return this._currentFrameEvent}get mainCamera(){if(this._mainCamera)return this._mainCamera;if(this.mainCameraComponent){const n=this.mainCameraComponent;return n.threeCamera||n.buildCamera(),n.threeCamera}return this._fallbackCamera||(this._fallbackCamera=new _e(75,this.domWidth/this.domHeight,.1,1e3)),this._fallbackCamera}set mainCamera(n){this._mainCamera=n}get rendererData(){return this.sceneLighting}get isCreated(){return this._isCreated}createNewRenderer(n){var t,i,s;if((t=this.renderer)==null||t.dispose(),n={...Ie.DefaultWebGLRendererParameters,...n},!n.canvas){const o=(s=(i=this.domElement)==null?void 0:i.shadowRoot)==null?void 0:s.querySelector("canvas");o&&(n.canvas=o,at&&console.log("Using canvas from shadow root",o))}at&&console.log("Using Renderer Parameters:",n,this.domElement),this.renderer=new sr(n),this.renderer.debug.checkShaderErrors=F()||C("checkshadererrors")===!0,this.renderer.toneMappingExposure=1,this.renderer.toneMapping=ya,this.renderer.setClearColor(new ae("lightgrey"),0),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=MS,this.renderer.setSize(this.domWidth,this.domHeight),this.renderer.outputColorSpace=gn,this.renderer.nodes={library:new RS,modelViewMatrix:null,modelNormalViewMatrix:null},this.lodsManager.setRenderer(this.renderer),this.input.bindEvents()}internalOnUpdateVisible(){var n,t;(n=this._intersectionObserver)==null||n.disconnect(),(t=this._intersectionObserver)==null||t.observe(this.domElement)}requestSizeUpdate(){this._sizeChanged=!0}updateSize(n=!1){var t,i,s;if(n||!this.isManagedExternally&&((t=this.renderer.xr)==null?void 0:t.isPresenting)===!1){this._sizeChanged=!1;const o=this.resolutionScaleFactor;let r=this.domWidth*o,l=this.domHeight*o;this.maxRenderResolution&&(this.maxRenderResolution.x=Math.max(1,this.maxRenderResolution.x),r=Math.min(this.maxRenderResolution.x,r),this.maxRenderResolution.y=Math.max(1,this.maxRenderResolution.y),l=Math.min(this.maxRenderResolution.y,l));const c=this.mainCamera;this.updateAspect(c),this.renderer.setSize(r,l,!0),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.domElement.style.width="100%",this.renderer.domElement.style.height="100%",this.composer&&((i=this.composer.setSize)==null||i.call(this.composer,r,l),"setPixelRatio"in this.composer&&typeof this.composer.setPixelRatio=="function"&&((s=this.composer.setPixelRatio)==null||s.call(this.composer,window.devicePixelRatio)))}}updateAspect(n,t,i){if(!n)return;t===void 0&&(t=this.domWidth),i===void 0&&(i=this.domHeight);const s=t/i;if(n.isPerspectiveCamera){const o=n,r=o.aspect;o.aspect=s,r!==o.aspect&&n.updateProjectionMatrix()}else if(n.isOrthographicCamera){const o=n,r=o.top-o.bottom,l=r*s/2,c=r/2;(o.left!=-l||o.top!=c)&&(o.left=-l,o.right=l,o.top=c,o.bottom=-c,n.updateProjectionMatrix())}}recreate(){this.clear(),this.create(this._originalCreationArgs)}async onCreate(n){return this.create(n)}async create(n){try{this._isCreating=!0,n!==this._originalCreationArgs&&(this._originalCreationArgs=Zl(n)),window.addEventListener("unhandledrejection",this.onUnhandledRejection);const t=await this.internalOnCreate(n);return this._isCreated=t,t}finally{window.removeEventListener("unhandledrejection",this.onUnhandledRejection),this._isCreating=!1}}onError(n){this.domElement.dispatchEvent(new CustomEvent("error",{detail:n}))}clear(){var n,t,i,s;ue.dispatchCallback(pe.ContextClearing,this),Wn(this,pe.ContextClearing),Ti(this.scene,!0,!0),this.scene=new wi,(n=this.addressables)==null||n.dispose(),(t=this.lightmaps)==null||t.clear(),(s=(i=this.physics)==null?void 0:i.engine)==null||s.clearCaches(),this.lodsManager.disable(),this.isManagedExternally||this.renderer&&(this.renderer.renderLists.dispose(),this.renderer.state.reset(),this.renderer.resetState()),ue.dispatchCallback(pe.ContextCleared,this)}dispose(){this.internalOnDestroy()}onDestroy(){this.internalOnDestroy()}internalOnDestroy(){var n,t;Ie.Current=this,ue.dispatchCallback(pe.ContextDestroying,this),Wn(this,pe.ContextDestroying),this.clear(),(n=this.renderer)==null||n.setAnimationLoop(null),this.renderer&&(this.renderer.setClearAlpha(0),this.renderer.clear(),this.isManagedExternally||(at&&console.log("Disposing renderer"),this.renderer.dispose())),this.scene=null,this.renderer=null,this.input.dispose(),this.menu.onDestroy(),this.animations.onDestroy();for(const i of this._disposeCallbacks)try{i()}catch(s){console.error("Error in on dispose callback:",s,i)}(t=this.domElement)!=null&&t.parentElement&&this.domElement.parentElement.removeChild(this.domElement),this._isCreated=!1,ue.dispatchCallback(pe.ContextDestroyed,this),Wn(this,pe.ContextDestroyed),ue.unregister(this),Ie.Current===this&&(Ie.Current=null)}registerCoroutineUpdate(n,t,i){return typeof t?.next!="function"?(console.error("Registered invalid coroutine function from "+n.name+`
Coroutine functions must be generators: "*myCoroutine() {...}"
Start a coroutine from a component by calling "this.startCoroutine(myCoroutine())"`),t):(this.coroutines[i]||(this.coroutines[i]=[]),this.coroutines[i].push({comp:n,main:t}),t)}unregisterCoroutineUpdate(n,t){if(!this.coroutines[t])return;const i=this.coroutines[t].findIndex(s=>s.main===n);i>=0&&this.coroutines[t].splice(i,1)}stopAllCoroutinesFrom(n){for(const t in this.coroutines){const i=this.coroutines[t];for(let s=i.length-1;s>=0;s--)i[s].comp===n&&i.splice(s,1)}}setCurrentCamera(n){var t;if(!n)return;if(n.threeCamera||n.buildCamera(),!n.threeCamera){console.warn("Camera component is missing camera",n);return}const i=this._cameraStack.indexOf(n);i>=0&&this._cameraStack.splice(i,1),this._cameraStack.push(n),this.mainCameraComponent=n;const s=n.threeCamera;s.isPerspectiveCamera&&this.updateAspect(s),(t=this.mainCameraComponent)==null||t.applyClearFlagsIfIsActiveCamera()}removeCamera(n){if(!n)return;const t=this._cameraStack.indexOf(n);if(t>=0&&this._cameraStack.splice(t,1),this.mainCameraComponent===n&&(this.mainCameraComponent=void 0,this._cameraStack.length>0)){const i=this._cameraStack[this._cameraStack.length-1];this.setCurrentCamera(i)}}addBeforeRenderListener(n,t){this._onBeforeRenderListeners.has(n.uuid)||(this._onBeforeRenderListeners.set(n.uuid,[]),n.onBeforeRender=this._createRenderCallbackWrapper(n,this._onBeforeRenderListeners)),this._onBeforeRenderListeners.get(n.uuid).push(t)}removeBeforeRenderListener(n,t){if(this._onBeforeRenderListeners.has(n.uuid)){const i=this._onBeforeRenderListeners.get(n.uuid),s=i.indexOf(t);s>=0&&i.splice(s,1)}}addAfterRenderListener(n,t){var i;this._onAfterRenderListeners.has(n.uuid)||(this._onAfterRenderListeners.set(n.uuid,[]),n.onAfterRender=this._createRenderCallbackWrapper(n,this._onAfterRenderListeners)),(i=this._onAfterRenderListeners.get(n.uuid))==null||i.push(t)}removeAfterRenderListener(n,t){if(this._onAfterRenderListeners.has(n.uuid)){const i=this._onAfterRenderListeners.get(n.uuid),s=i.indexOf(t);s>=0&&i.splice(s,1)}}_createRenderCallbackWrapper(n,t){return(i,s,o,r,l,c)=>{const h=t.get(n.uuid);if(h)for(let d=0;d<h.length;d++){const u=h[d];u(i,s,o,r,l,c)}}}get isRendering(){return this._isRendering}setRequireDepth(n){this._requireDepthTexture=n}setRequireColor(n){this._requireColorTexture=n}get depthTexture(){var n;return((n=this._renderTarget)==null?void 0:n.depthTexture)||null}get opaqueColorTexture(){var n;return((n=this._renderTarget)==null?void 0:n.texture)||null}get isVisibleToUser(){if(this.isInXR)return!0;if(!this._isVisible)return!1;const n=getComputedStyle(this.domElement);return n.visibility!=="hidden"&&n.display!=="none"&&n.opacity!=="0"}async internalOnCreate(n){var t,i,s,o,r,l,c,h;const d=++this._createId;at&&console.log("Creating context",this.name,n);const u=globalThis["needle:dependencies:ready"];u instanceof Promise&&(at&&console.log("Waiting for dependencies to be ready"),await u.catch(f=>{if(at||F()){if(rc("Needle Engine dependencies failed to load. Please check the console for more details"),f instanceof ReferenceError){let v="YourComponentName";const b=f.message.indexOf("'");if(b>0){const w=f.message.indexOf("'",b+1);if(w>0){const _=f.message.substring(b+1,w);_.length>3&&(v=_)}}console.error(`Needle Engine dependencies failed to load:

# Make sure you don't have circular imports in your scripts!

Possible solutions: 
\u2192 Replace @serializable(${v}) in your script with @serializable(Behaviour)
\u2192 If you only need type information try importing the type only, e.g: import { type ${v} }

---`,f);return}console.error("Needle Engine dependencies failed to load",f)}}).then(()=>{at&&console.log("Needle Engine dependencies are ready")})),this.clear(),this.isManagedExternally===!1&&(this.createNewRenderer(),(t=this.renderer)==null||t.setAnimationLoop(null)),await yn(1),Ie.Current=this,await ue.dispatchCallback(pe.ContextCreationStart,this);let p=!0,g;try{Ie.Current=this,n?g=await this.internalLoadInitialContent(d,n):g=[]}catch(f){console.error(f),p=!1}if(!p)return this.onError("Failed to load initial content"),!1;if(d!==this._createId||(i=n?.abortSignal)!=null&&i.aborted)return!1;if(this.internalOnUpdateVisible(),!this.renderer)return at&&console.warn("Context has no renderer (perhaps it was disconnected?",this.domElement.isConnected),!1;!this.isManagedExternally&&!this.domElement.shadowRoot&&this.domElement.prepend(this.renderer.domElement),Ie.Current=this,Ie.Current=this;for(let f=0;f<this.new_scripts.length;f++){const v=this.new_scripts[f];if(v.gameObject!==void 0&&v.gameObject!==null){v.gameObject.userData===void 0&&(v.gameObject.userData={}),v.gameObject.userData.components===void 0&&(v.gameObject.userData.components=[]);const b=v.gameObject.userData.components;b.includes(v)||b.push(v)}}if(this.post_setup_callbacks)for(let f=0;f<this.post_setup_callbacks.length;f++)Ie.Current=this,await this.post_setup_callbacks[f](this);if(!this._mainCamera){Ie.Current=this;let f=null;_r(this.scene,v=>{const b=v;if(b!=null&&b.isCamera){if(_c(b.gameObject),!b.activeAndEnabled)return;if(b.tag==="MainCamera")return f=b,!0;f=b}}),f?this.setCurrentCamera(f):!ue.dispatchCallback(pe.MissingCamera,this,{files:g})&&!this.mainCamera&&!this.isManagedExternally&&console.warn("Missing camera in main scene",this)}this.input.bindEvents(),Ie.Current=this,Fd(this),this.physics.engine&&((s=this.physics.engine)==null||s.step(0),(o=this.physics.engine)==null||o.postStep()),!this.isManagedExternally&&this.composer&&this.mainCamera,this._sizeChanged=!0,this._stats&&(this._stats.showPanel(0),this._stats.dom.style.position="absolute",(r=this.domElement.shadowRoot)==null||r.appendChild(this._stats.dom)),at&&wd(this.scene,!0),this.targetFrameRate===void 0?(at&&console.warn("No target framerate set, using default",Ie.DefaultTargetFrameRate),this.targetFrameRate=Ie._defaultTargetFramerate):at&&console.log("Target framerate set to",this.targetFrameRate),this._dispatchReadyAfterFrame=!0;const y=ue.dispatchCallback(pe.ContextCreated,this,{files:g});return y&&("internalSetLoadingMessage"in this.domElement&&typeof this.domElement.internalSetLoadingMessage=="function"&&((l=this.domElement)==null||l.internalSetLoadingMessage("finish loading")),await y),(c=n?.abortSignal)!=null&&c.aborted?!1:(Wn(this,pe.ContextCreated),at&&console.log("Context Created...",this.renderer,this.renderer.domElement),this._isCreating=!1,!this.isManagedExternally&&!((h=n?.abortSignal)!=null&&h.aborted)&&this.restartRenderLoop(),!0)}async internalLoadInitialContent(n,t){var i,s,o,r;const l=new Array;if(t.files.length===0)return l;const c=[...t.files],h={name:"",progress:null,index:0,count:c.length},d=fn(),u=0;for(let p=0;p<c.length;p++){if((i=t.abortSignal)!=null&&i.aborted){at&&console.log("Aborting loading because of abort signal");break}if(n!==this._createId){at&&console.log("Aborting loading because create id changed",n,this._createId);break}const g=c[p];(s=t?.onLoadingStart)==null||s.call(this,p,g),at&&console.log("Context Load "+g);const y=await d.loadSync(this,g,g,u,f=>{var v,b;(v=t.abortSignal)!=null&&v.aborted||(h.name=g,h.progress=f,h.index=p,h.count=c.length,(b=t.onLoadingProgress)==null||b.call(this,h))});(o=t?.onLoadingFinished)==null||o.call(this,p,g,y??null),y?l.push({src:g,file:y}):console.warn("Could not load file: "+g)}if(n!==this._createId||(r=t.abortSignal)!=null&&r.aborted){at&&console.log("Aborting loading because create id changed or abort signal was set",n,this._createId);for(const p of l)if(p&&p.file)for(const g of p.file.scenes)Ti(g,!0,!0)}else{let p=!1;for(const g of l)g&&g.file&&(g.file.scene?(p=!0,this.scene.add(g.file.scene)):console.warn("No scene found in loaded file"));if(!p){for(const g of l)if(g&&g.file&&"parser"in g.file){let y=0;if(!Array.isArray(g.file.parser.json.materials))continue;for(let f=0;f<g.file.parser.json.materials.length;f++){const v=await g.file.parser.getDependency("material",f),b=new j;b.position.x=f*1.1,b.position.y=y,this.scene.add(b),uo.createPrimitive("ShaderBall",{parent:b,material:v})}y+=1}}}return l}restartRenderLoop(){return this.renderer?this._isCreating?(console.warn("Can not start render loop while creating context"),!1):(this.renderer.setAnimationLoop((n,t)=>{this.isManagedExternally||this.update(n,t)}),!0):(console.error("Can not start render loop without renderer"),!1)}update(n,t){if(t===void 0&&(t=null),F()||at||y2())try{performance.mark("update.start"),this.internalStep(n,t),this._renderlooperrors=0,performance.mark("update.end"),performance.measure("NE Frame","update.start","update.end")}catch(i){this._renderlooperrors+=1,(F()||at)&&(i instanceof Error||i instanceof TypeError)&&De("Caught unhandled exception during render-loop - see console for details.",Pi.Error),console.error("Frame #"+this.time.frame+`
`,i),this._renderlooperrors>=3&&(console.warn("Stopping render loop due to error"),this.renderer.setAnimationLoop(null)),this.domElement.dispatchEvent(new CustomEvent("error",{detail:i}))}else this.internalStep(n,t)}updatePhysics(n){this.internalUpdatePhysics(n)}internalStep(n,t){this.internalOnBeforeRender(n,t)!==!1&&(this.internalOnRender(),this.internalOnAfterRender())}internalOnBeforeRender(n,t){var i;this.renderer.info.autoReset=!0;const s=t!==null&&this._xrFrame===null;if(this._xrFrame=t,s&&this.domElement.dispatchEvent(new CustomEvent("xr-session-started",{detail:{context:this,session:this.xrSession,frame:t}})),this._currentFrameEvent=-1,this.isManagedExternally===!1&&this.isInXR===!1&&this.targetFrameRate!==void 0){this._lastTimestamp===0&&(this._lastTimestamp=n),this._accumulatedTime+=(n-this._lastTimestamp)/1e3,this._lastTimestamp=n;let o=this.targetFrameRate;if(typeof o=="object"&&(o=o.value),this._accumulatedTime<1/(o+1))return!1;this._accumulatedTime=0}if((i=this._stats)==null||i.begin(),Ie.Current=this,this.onHandlePaused())return!1;for(Ie.Current=this,this.time.update(),fk&&console.log("FPS",this.time.smoothedFps.toFixed(0)),Fd(this),zd(this.scene),Jb(this),Wn(this,-1);this._cameraStack.length>0&&(!this.mainCameraComponent||this.mainCameraComponent.destroyed);){this._cameraStack.splice(this._cameraStack.length-1,1);const o=this._cameraStack[this._cameraStack.length-1];this.setCurrentCamera(o)}if(this.pre_update_oneshot_callbacks){for(const o in this.pre_update_oneshot_callbacks)this.pre_update_oneshot_callbacks[o]();this.pre_update_oneshot_callbacks.length=0}if(this.pre_update_callbacks)for(const o in this.pre_update_callbacks)this.pre_update_callbacks[o]();this._currentFrameEvent=0;for(let o=0;o<this.scripts_earlyUpdate.length;o++){const r=this.scripts_earlyUpdate[o];r.activeAndEnabled&&r.earlyUpdate!==void 0&&(Ie.Current=this,r.earlyUpdate())}if(this.executeCoroutines(0),Wn(this,0),this.onHandlePaused())return!1;this._currentFrameEvent=1;for(let o=0;o<this.scripts_update.length;o++){const r=this.scripts_update[o];r.activeAndEnabled&&r.update!==void 0&&(Ie.Current=this,r.update())}if(this.executeCoroutines(1),Wn(this,1),this.onHandlePaused())return!1;this._currentFrameEvent=2;for(let o=0;o<this.scripts_lateUpdate.length;o++){const r=this.scripts_lateUpdate[o];r.activeAndEnabled&&r.lateUpdate!==void 0&&(Ie.Current=this,r.lateUpdate())}if(this.executeCoroutines(2),Wn(this,2),this.onHandlePaused()||(this.physicsSteps===void 0&&(this.physicsSteps=1),this.physics.engine&&this.physicsSteps>0&&this.internalUpdatePhysics(this.physicsSteps),this.onHandlePaused()))return!1;if(this.isVisibleToUser||this.runInBackground){this._currentFrameEvent=3;for(let o=0;o<this.scripts_onBeforeRender.length;o++){const r=this.scripts_onBeforeRender[o];r.activeAndEnabled&&r.onBeforeRender!==void 0&&(Ie.Current=this,r.onBeforeRender(t))}if(this.executeCoroutines(3),Wn(this,3),this._sizeChanged&&this.updateSize(),this.pre_render_callbacks)for(const o in this.pre_render_callbacks)this.pre_render_callbacks[o](t)}return!0}internalUpdatePhysics(n){if(!this.physics.engine)return!1;const t=n,i=this.time.deltaTime/t;for(let s=0;s<t;s++)this._currentFrameEvent=9,this.executeCoroutines(9),this.physics.engine.step(i),this._currentFrameEvent=10,this.executeCoroutines(10);return this.physics.engine.postStep(),!0}internalOnRender(){this.isManagedExternally||(w2(this),this._currentFrameEvent=-1,FC.update(),this.renderNow(),this._currentFrameEvent=4)}internalOnAfterRender(){if(this.isVisibleToUser||this.runInBackground){for(let n=0;n<this.scripts_onAfterRender.length;n++){const t=this.scripts_onAfterRender[n];t.activeAndEnabled&&t.onAfterRender!==void 0&&(Ie.Current=this,t.onAfterRender())}if(this.executeCoroutines(4),Wn(this,4),this.post_render_callbacks)for(const n in this.post_render_callbacks)this.post_render_callbacks[n]()}this._currentFrameEvent=-1,this.connection.sendBufferedMessagesNow(),this._stats&&(this._stats.end(),this.time.frameCount%150===0&&console.log(this.renderer.info.render.calls+" DrawCalls",`
Render:`,{...this.renderer.info.render},`
Memory:`,{...this.renderer.info.memory},`
Target Framerate: `+this.targetFrameRate)),this._dispatchReadyAfterFrame&&(this._dispatchReadyAfterFrame=!1,this.domElement.dispatchEvent(new CustomEvent("ready")),ue.dispatchCallback(pe.ContextFirstFrameRendered,this))}renderNow(n){var t;return!n&&(n=this.mainCamera,!n)?!1:(this.handleRendererContextLost(),this._isRendering=!0,this.renderRequiredTextures(),this.renderer.toneMapping!==ya&&K_(),this.composer&&!this.isInXR?(n&&"setMainCamera"in this.composer&&((t=this.composer.passes[0])==null?void 0:t.mainCamera)!=n&&this.composer.setMainCamera(n),this.composer.render(this.time.deltaTime)):n&&(this.isInXR&&Q.isMacOS()&&this.renderer.clearDepth(),this.renderer.render(this.scene,n)),this._isRendering=!1,!0)}handleRendererContextLost(){this.time.frame%10&&this.renderer.getContext().isContextLost()&&this._contextRestoreTries++<100&&(console.warn("Attempting to recover WebGL context..."),this.renderer.forceContextRestore())}onHandlePaused(){const n=this.evaluatePaused();if(this._wasPaused!==n){gk&&console.log("Paused?",n,"context:"+this.alias);for(let t=0;t<this.scripts_pausedChanged.length;t++){const i=this.scripts_pausedChanged[t];i.activeAndEnabled&&i.onPausedChanged!==void 0&&(Ie.Current=this,i.onPausedChanged(n,this._wasPaused))}}return this._wasPaused=n,n}evaluatePaused(){return this.isInXR?!1:this.isPaused?!0:this.runInBackground?!1:!this.isVisibleToUser}renderRequiredTextures(){if(!this.mainCamera||!this._requireDepthTexture&&!this._requireColorTexture)return;if(!this._renderTarget){if(this._renderTarget=new vs(this.domWidth,this.domHeight),this._requireDepthTexture){const i=new TS(this.domWidth,this.domHeight);this._renderTarget.depthTexture=i}this._requireColorTexture&&(this._renderTarget.texture=new Le,this._renderTarget.texture.generateMipmaps=!1,this._renderTarget.texture.minFilter=ld,this._renderTarget.texture.magFilter=ld,this._renderTarget.texture.format=ad)}const n=this._renderTarget;n.texture&&(n.texture.colorSpace=this.renderer.outputColorSpace);const t=this.renderer.getRenderTarget();this.renderer.setRenderTarget(n),this.renderer.render(this.scene,this.mainCamera),this.renderer.setRenderTarget(t)}executeCoroutines(n){var t;if(this.coroutines[n]){const s=this.coroutines[n];for(let o=0;o<s.length;o++)try{const r=s[o];if(!r.comp||r.comp.destroyed||!r.main||r.comp.enabled===!1){yk&&console.log("Removing coroutine",r.comp,r.comp.enabled),s.splice(o,1),--o;continue}const l=r.chained;if(l&&l.length>0){const d=l[l.length-1].next();if(d.done&&l.pop(),i(d)&&(r.chained||(r.chained=[]),r.chained.push(d.value)),!d.done)continue}const c=r.main.next();if(c.done===!0){s.splice(o,1),--o;continue}const h=c.value;if(i(h)){if(h.next().done)continue;r.chained||(r.chained=[]),r.chained.push(h)}else if(h instanceof Promise){const d=h;r.chained||(r.chained=[]);const u=U_(d);(t=r.chained)==null||t.push(u);continue}}catch(r){console.error(r)}}function i(s){return!!(s&&s.next&&s.return)}}};let ee=Ie;a(ee,"_defaultTargetFramerate",{value:90,toString(){return this.value}}),a(ee,"_defaultWebglRendererParameters",{antialias:!0,alpha:!1,powerPreference:Q.isiOS()||Q.isMacOS()?"default":"high-performance",stencil:!0});const Qi=C("debuglicense"),rw=[];let Cr="basic";Qi&&console.log("License Type: "+Cr);function yo(){switch(Cr){case"pro":case"enterprise":return!0}return!1}function ef(){switch(Cr){case"indie":return!0}return!1}function On(){return yo()||ef()}function _k(n){if(yo()||ef())return n(!0);rw.push(n)}function wk(n){for(const t of rw)try{t(n)}catch{}}ue.registerCallback(pe.ContextRegistered,n=>{Ck(n.context),Pk(),Sk(n.context)});let Or,tf=!1,mu="";async function xk(){if(Or)return Or;if(Cr==="basic")try{const n="https://engine.needle.tools/licensing/check?location="+encodeURIComponent(window.location.href)+"&version="+_n+"&generator="+encodeURIComponent(Sd),t=await fetch(n,{method:"GET"}).catch(i=>{Qi&&console.error("License check failed",i)});t?.status===200?(tf=!1,Qi&&console.log("License check succeeded"),Cr="pro",wk(!0)):t?.status===403?(tf=!0,mu=await t.text()):Qi&&console.log("License check failed with status "+t?.status)}catch(n){Qi&&console.error("License check failed",n)}else Qi&&console.log('Runtime license check is skipped because license is already applied as "'+Cr+'"')}Or=xk();async function Sk(n){function t(){const o=document.createElement("div");o.className="needle-forbidden",o.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: all;
        zIndex: 2147483647;
        line-height: 1.5;
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        `;const r=o.style.cssText,l=document.createElement("div");o.appendChild(l),l.style.cssText=`
        position: absolute;
        left: 0;
        right: 0;
        top:0;
        bottom: 0;
        padding: 10%;
        color: white;
        font-size: 20px;
        font-family: sans-serif;
        text-align: center;
        pointer-events: all;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: rgba(0,0,0,.3);
        text-shadow: 0 0 2px black;
        `;const c=l.style.cssText,h=mu?.length>1?mu:"This web application has been paused.<br/>You might be in violation of the Needle Engine terms of use.<br/>Please contact the Needle support if you think this is a mistake.";return l.innerHTML=h,setInterval(()=>{l.innerHTML!==h&&(l.innerHTML=h),l.parentNode!==o&&o.appendChild(l),o.style.cssText!==r&&(o.style.cssText=r),l.style.cssText!==c&&(l.style.cssText=c)},500),o}let i=t();const s=i.style.cssText;setInterval(()=>{var o;tf===!0&&(i.style.cssText!==s&&(i=t()),n.domElement.shadowRoot?i.parentNode!==n.domElement.shadowRoot&&((o=n.domElement.shadowRoot)==null||o.appendChild(i)):i.parentNode!=document.body&&document.body.appendChild(i))},500)}async function Ck(n){try{if(On()!==!0)return nf(n)}catch(t){return Qi&&console.log("License check failed",t),nf(n)}Qi&&nf(n)}async function nf(n){n.domElement.addEventListener("ready",()=>!0),await Or?.catch(()=>{}),!On()&&Ok()}let aw=0;async function Ok(n){var t;const i=Date.now();if(i-aw<2e3)return;aw=i;const s=`
        position: relative;
        display: block;
        font-size: 18px;
        background-size: 20px;
        background-position: 10px 5px;
        background-repeat:no-repeat;
        background-image:url('data:image/webp;base64,UklGRrABAABXRUJQVlA4WAoAAAAQAAAAHwAAHwAAQUxQSKEAAAARN6CmbSM4WR7vdARON11EBDq3fLiNbVtVzpMCPlKAEzsx0Y/x+Ovuv4dn0EFE/ydAvz6YggXzgh5sVgXM/zOC/4sii7qgGvB5N7hmuQYwkvazWAu1JPW41FXSHq6pnaQWvqYH18Fc0j1hO/BFTtIeSBlJi5w6qIIO7IOrwhFsB2Yxukif0FTRLpXswHR8MxbslKe9VZsn/Ub5C7YFOpqSTABWUDgg6AAAAFAGAJ0BKiAAIAA+7VyoTqmkpCI3+qgBMB2JbACdMt69DwMIQBLhkTO6XwY00UEDK6cNIDnuNibPf0EgAP7Y1myuiQHLDsF/0h5unrGh6WAbv7aegg2ZMd3uRKfT/3SJztcaujYfTvMXspfCTmYcoO6a+vhC3ss4M8uM58t4siiu59I4aOl59e9Sr6xoxYlHf2v+NnBNpJYeJf8jABQAId/PXuBkLEFkiCucgSGEcfhvajql/j3reCGl0M5/9gQWy7ayNPs+wlvIxFnNfSlfuND4CZOCyxOHhRqOmHN4ULHo3tCSrUNvgAA=');
        background-max-size: 40px;
        margin-bottom: 5px;
        margin-top: .3em;
        margin-bottom: .5em;
        padding: .2em;
        padding-left: 25px;
        border-radius: .5em;
        border: 2px solid rgba(160,160,160,.3);
    `,o=`Needle Engine \u2014 No license active, commercial use is not allowed. Visit https://needle.tools/pricing for more information and licensing options! v${_n}`;(t=ee.Current)!=null&&t.xr?console.log(o):console.log("%c "+o,s)}async function Pk(){var n;if(!window.crossOriginIsolated)try{const t="https://needle-engine-analytics-v2-r26roub2hq-lz.a.run.app";if(t){Qi&&console.log("Analytics backend url",t);const i=window.location.href.split("?")[0];let s="api/v2/new/request";t.endsWith("/")||(s="/"+s);const o=Cr,r=`${t}${s}`;Qi&&console.log("Sending non-commercial usage message to analytics backend",r);const l={license:o,url:i,hostname:window.location.hostname,pathname:window.location.pathname,version:_n,generator:Sd,build_time:Ym,public_key:cc},c=(n=navigator.sendBeacon)==null?void 0:n.call(navigator,r,JSON.stringify(l));Qi&&console.log("Send beacon result",c)}}catch(t){Qi&&console.log("Failed to send non-commercial usage message to analytics backend",t)}}const Pr=C("debugloading"),Ac=C("debugloadingrendering"),lw=C("debuglicense");class kk{constructor(){a(this,"className"),a(this,"additionalClasses")}}let Ic=0,cw;function sf(n){Pr&&console.log(n.progress.loaded.toFixed(0)+"/"+n.progress.total.toFixed(0),n);const t=n.count,i=n.progress.total;i===0||i===void 0?(cw!==n.name&&(Ic=0),cw=n.name,Ic+=(1-Ic)*.001,Pr&&we("Loading "+n.name+" did not report total size")):Ic=n.progress.loaded/i;const s=n.index/t+Ic/t;return W.clamp01(s)}const of=class{constructor(n,t){a(this,"loadingProgress",0),a(this,"_element"),a(this,"_progress",0),a(this,"_allowCustomLoadingElement",!0),a(this,"_loadingElement"),a(this,"_loadingTextContainer",null),a(this,"_loadingBar",null),a(this,"_messageContainer",null),a(this,"_loadingElementOptions"),a(this,"_progressLoop"),this._element=n,this._loadingElementOptions=t}async onLoadingBegin(n){const t=this._element.shadowRoot||this._element;if(Pr&&console.warn("Begin Loading"),!this._loadingElement){for(let i=0;i<t.children.length;i++){const s=t.children[i];if(s.classList.contains(of.LoadingContainerClassName)){if(!this._allowCustomLoadingElement){Pr&&console.warn("Remove custom loading container"),t.removeChild(s);continue}this._loadingElement=this.createLoadingElement(s)}}this._loadingElement||(this._loadingElement=this.createLoadingElement())}this._progress=0,this.loadingProgress=0,this._loadingElement.style.display="flex",t.appendChild(this._loadingElement),this.smoothProgressLoop(),this.setMessage(n??"")}onLoadingUpdate(n,t){var i;if(!((i=this._loadingElement)!=null&&i.parentNode))return;let s=0;typeof n=="number"?s=n:("index"in n&&(s=sf(n)),!t&&"name"in n&&this.setMessage("loading "+n.name)),this.loadingProgress=s,t&&this.setMessage(t),this.updateDisplay()}onLoadingFinished(){Pr&&console.warn("Finished Loading"),Ac||(this.loadingProgress=1,this.onDoneLoading())}setMessage(n){this._messageContainer&&(this._messageContainer.innerText=n)}smoothProgressLoop(){if(this._progressLoop)return;let n=1/12;Ac&&(n=1/500,typeof Ac=="number"&&(n*=Ac)),this._progressLoop=setInterval(()=>{this.loadingProgress>=.95&&!Ac&&(n=.9),this._progress=W.lerp(this._progress,this.loadingProgress,n*this.loadingProgress),this.updateDisplay()},n)}onDoneLoading(){this._loadingElement&&(Pr&&console.log("Hiding loading element"),this._loadingElement.style.display="none",this._loadingElement.remove()),this._progressLoop&&clearInterval(this._progressLoop),this._progressLoop=null}updateDisplay(){const n=this._progress,t=(n*100).toFixed(0)+"%";this._loadingBar&&(this._loadingBar.style.width=n*100+"%"),this._loadingTextContainer&&(this._loadingTextContainer.textContent=t)}createLoadingElement(n){var t,i;Pr&&!n&&console.log("Creating loading element"),this._loadingElement=n||document.createElement("div");let s=this._element.getAttribute("loading-style");(!s||s==="auto")&&(window.matchMedia("(prefers-color-scheme: dark)").matches?s="dark":s="light");const o=yo();if(!n&&(this._loadingElement.style.position="absolute",this._loadingElement.style.width="100%",this._loadingElement.style.height="100%",this._loadingElement.style.left="0",this._loadingElement.style.top="0",s==="light"?this._loadingElement.style.backgroundColor="#ddd":this._loadingElement.style.backgroundColor="#222",this._loadingElement.style.display="flex",this._loadingElement.style.alignItems="center",this._loadingElement.style.justifyContent="center",this._loadingElement.style.zIndex=Number.MAX_SAFE_INTEGER.toString(),this._loadingElement.style.flexDirection="column",this._loadingElement.style.pointerEvents="none",this._loadingElement.style.color="white",this._loadingElement.style.fontFamily='system-ui, Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"',this._loadingElement.style.fontSize="1rem",s==="light"?this._loadingElement.style.color="rgba(0,0,0,.6)":this._loadingElement.style.color="rgba(255,255,255,.3)",o&&this._element)){const f=this._element.getAttribute("loading-background-color");f&&(this._loadingElement.style.backgroundColor=f);const v=this._element.getAttribute("loading-text-color");v&&(this._loadingElement.style.color=v)}const r=((t=this._loadingElementOptions)==null?void 0:t.className)??of.LoadingContainerClassName;if(this._loadingElement.classList.add(r),(i=this._loadingElementOptions)!=null&&i.additionalClasses)for(const f of this._loadingElementOptions.additionalClasses)this._loadingElement.classList.add(f);const l=document.createElement("div");this._loadingElement.appendChild(l);const c=document.createElement("img"),h=120;if(c.style.width=`${h}px`,c.style.height=`${h}px`,c.style.paddingTop="20px",c.style.paddingBottom="10px",c.style.margin="0px",c.style.userSelect="none",c.style.objectFit="contain",c.style.transition="transform 1.5s ease-out, opacity .3s ease-in-out",c.style.transform="translateY(30px)",c.style.opacity="0.05",setTimeout(()=>{c.style.opacity="1",c.style.transform="translateY(0px)"},1),c.src=kP,o&&this._element){const f=this._element.getAttribute("loading-logo-src");f&&(c.src=f)}l.appendChild(c);const d=document.createElement("div");d.style.cssText=`
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        opacity: 0;
        transition: opacity 1s ease-in-out 4s;
        `,setTimeout(()=>{d.style.opacity="1"},1),this._loadingElement.appendChild(d);const u=document.createElement("div"),p=100;u.style.display="flex",u.style.width=p+"%",u.style.height="3px",u.style.position="absolute",u.style.left="0",u.style.bottom="0px",u.style.opacity="0",u.style.transition="opacity 1s ease-in-out 2s",setTimeout(()=>{u.style.opacity="1"},1),s==="light"?u.style.backgroundColor="rgba(0,0,0,.2)":u.style.backgroundColor="rgba(255,255,255,.2)",this._loadingElement.appendChild(u),this._loadingBar=document.createElement("div"),u.appendChild(this._loadingBar);const g=function(f){return W.lerp(0,p,f)+"%"};if(this._loadingBar.style.background=`linear-gradient(90deg, #204f49 ${g(0)}, #0BA398 ${g(.3)}, #66A22F ${g(.6)}, #D7DB0A ${g(1)})`,this._loadingBar.style.backgroundAttachment="fixed",this._loadingBar.style.width="0%",this._loadingBar.style.height="100%",o&&this._element){const f=this._element.getAttribute("primary-color"),v=this._element.getAttribute("secondary-color");f&&v?this._loadingBar.style.background=`linear-gradient(90deg, ${f} ${g(0)}, ${v} ${g(1)})`:f?this._loadingBar.style.background=f:v&&(this._loadingBar.style.background=v)}this._loadingTextContainer=document.createElement("div"),this._loadingTextContainer.style.display="flex",this._loadingTextContainer.style.justifyContent="center",this._loadingTextContainer.style.marginTop=".2rem",d.appendChild(this._loadingTextContainer);const y=document.createElement("div");if(this._messageContainer=y,y.style.display="flex",y.style.fontSize=".8rem",y.style.paddingTop=".1rem",y.style.justifyContent="center",d.appendChild(y),o&&this._element){const f=this._element.getAttribute("loading-text-color");f&&(y.style.color=f)}return this.handleRuntimeLicense(this._loadingElement),this._loadingElement}async handleRuntimeLicense(n){let t=On();if(t)return;lw&&console.log("Loading UI has commercial license?",t);const i=document.createElement("div");i.style.paddingTop=".6em",i.style.fontSize=".8em",i.style.textTransform="uppercase",i.innerText=`NEEDLE ENGINE NON COMMERCIAL VERSION
CLICK HERE TO GET A LICENSE`,i.style.cursor="pointer",i.style.userSelect="none",i.style.textAlign="center",i.style.pointerEvents="all",i.addEventListener("click",()=>window.open("https://needle.tools/pricing","_self")),i.style.opacity="0",n.appendChild(i),!F()&&Or&&(lw&&console.log("Waiting for runtime license check"),await Or,t=On()),!t&&(i.style.transition="opacity .5s ease-in-out",i.style.opacity="1")}};let rf=of;a(rf,"LoadingContainerClassName","loading");const jc=C("debugoverlay"),hw="ar",Mk="quit-ar";class Rk{constructor(){a(this,"arContainer",null),a(this,"currentSession",null),a(this,"_createdAROnlyElements",[]),a(this,"_reparentedObjects",[]),a(this,"contentElement",null),a(this,"originalDomOverlayParent",null),a(this,"requestEndAR",()=>{this.onRequestedEndAR()})}get ARContainer(){return this.arContainer}onBegin(t,i,s){var o;if(this.currentSession=s,this.arContainer=i,Q.isMozillaXR()){const r=t.domElement.children;for(let l=0;l<r?.length;l++){const c=r[l];if(!c||c===this.arContainer)return;this._reparentedObjects.push({el:c,previousParent:c.parentElement}),(o=this.arContainer)==null||o.appendChild(c)}i?(this.originalDomOverlayParent=i.parentNode,this.originalDomOverlayParent&&(console.log("Reparent DOM Overlay to body",i,i.style.display),i.style.display="",i.style.visibility="",document.body.appendChild(i))):console.warn("WebXRViewer: No DOM Overlay found")}this.ensureQuitARButton(this.arContainer)}onEnd(t){var i;for(const s of this._createdAROnlyElements)s.remove&&s.remove();for(const s of this._reparentedObjects){const o=s.el;(i=s.previousParent)==null||i.appendChild(o)}this._reparentedObjects.length=0,Q.isMozillaXR()&&setTimeout(()=>{var s;const o=t.renderer.domElement;o&&((s=t.domElement.shadowRoot)==null||s.prepend(o));const r=document.querySelectorAll("*");for(var l=0;l<r.length;l++){const c=r[l];c&&c._displayChanged!==void 0&&c._displayWas!==void 0&&(c.style.display=c._displayWas)}},10)}createOverlayContainer(t){if(this.contentElement)return this.contentElement;jc&&console.log("Setup overlay container");const i=t.shadowRoot.querySelector(".content");this.contentElement=i;const s=t.shadowRoot.querySelector(".overlay-content");return s&&i.appendChild(s),jc&&!Q.isMobileDevice()&&this.ensureQuitARButton(i),i}onRequestedEndAR(){this.currentSession&&(this.currentSession.end(),this.currentSession=null)}ensureQuitARButton(t){const i=document.createElement("slot");i.setAttribute("name","quit-ar"),this.appendElement(i,t),this._createdAROnlyElements.push(i),i.style.pointerEvents="auto";const s=document.querySelector(`.${Mk}`);if(s){s.addEventListener("click",this.requestEndAR),jc&&s.addEventListener("click",()=>console.log("Clicked quit-ar button"));return}i.addEventListener("click",this.requestEndAR),jc&&i.addEventListener("click",()=>console.log("Clicked fallback close button"));const o=document.createElement("div");o.style.cssText=`
            position: fixed;
            top: 0;
            right: 0;
            z-index: 600;
            pointer-events: all;
        `,this.appendElement(o,i);var r=document.createElementNS("http://www.w3.org/2000/svg","svg");r.classList.add("quit-ar-button"),r.setAttribute("width","40px"),r.setAttribute("height","40px"),r.style.cssText=`
            background: rgba(255, 255, 255, .4);
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(0,0,0,.3);
            outline: 1px solid rgba(255, 255, 255, .6);
            display: flex;
            justify-content: center;
            align-items: center;
        `,o.appendChild(r);var l=document.createElementNS("http://www.w3.org/2000/svg","path");l.setAttribute("d","M 12,12 L 28,28 M 28,12 12,28"),l.setAttribute("stroke","#000000"),l.setAttribute("stroke-width","2px"),l.style.cssText=`
            /**filter: drop-shadow(0 0px 1.2px rgba(0,0,0,.7));**/
        `,r.appendChild(l),jc&&console.log("Created fallback close button",r,t)}appendElement(t,i){return i.shadowRoot?i.shadowRoot.appendChild(t):i.appendChild(t)}}const Tk=C("debugdecoders");let af=null;function dw(){if(!af){const n=gm(null);af={dracoLoader:n.dracoLoader,ktx2Loader:n.ktx2Loader,meshoptDecoder:n.meshoptDecoder}}return af}function uw(n){n!==void 0&&typeof n=="string"&&AC(n)}function pw(n){if(n!==void 0&&typeof n=="string"&&n!=="js"){const t=dw();Tk&&console.log("Setting draco decoder type to",n),t.dracoLoader.setDecoderConfig({type:n})}}function mw(n){n!==void 0&&typeof n=="string"&&IC(n)}function gu(n,t){const i=dw();return t.renderer?i.ktx2Loader.detectSupport(t.renderer):console.warn("No renderer provided to detect ktx2 support - loading KTX2 textures will probably fail"),TC(n),n.dracoLoader||n.setDRACOLoader(i.dracoLoader),n.ktx2Loader||n.setKTX2Loader(i.ktx2Loader),n.meshoptDecoder||n.setMeshoptDecoder(i.meshoptDecoder),EC(n,{progressive:!0}),n}const kr=function(n){return m(n)},m=function(n){if(n===void 0&&(n=null),!Array.isArray(n))n=gw(n);else for(let t=0;t<n.length;t++){const i=n[t];n[t]=gw(i)}return function(t,i){if(!t){console.error("Found @serializable decorator without a target");return}typeof i!="string"&&(i=i.name),Object.getOwnPropertyDescriptor(t,"$serializedTypes")||(t.$serializedTypes={});const s=t.$serializedTypes=t.$serializedTypes||{};s[i]=n}};function gw(n){var t,i;switch((i=(t=n?.prototype)==null?void 0:t.constructor)==null?void 0:i.name){case"Number":case"String":case"Boolean":return null}return n}class O extends j{constructor(){super(...arguments),a(this,"guid")}static isDestroyed(t){return br(t)}static setActive(t,i,s=!0){t&&(Mc(t,i),zd(t),i&&s&&Jb(ee.Current,t))}static isActiveSelf(t){return ja(t)}static isActiveInHierarchy(t){return R_(t)}static markAsInstancedRendered(t,i){T_(t,i)}static isUsingInstancing(t){return Qd(t)}static foreachComponent(t,i,s=!0){return _r(t,i,s)}static instantiateSynced(t,i){return t?Eg(t,i):null}static instantiate(t,i=null){return"isAssetReference"in t,Da(t,i)}static destroySynced(t,i,s=!0){if(!t)return;const o=t;i=i??ee.Current,wc(o,i.connection,s)}static destroy(t,i=!0){return Ti(t,i)}static add(t,i,s){if(!(!t||!i)){if(t===i){console.warn("Can not add object to self",t);return}s||(s=ee.Current),i.add(t),Mc(t,!0),zd(t),s?O.foreachComponent(t,o=>{Cg(o,s),!o.__internalDidAwakeAndStart&&s.new_script_start.includes(o)===!1&&s.new_script_start.push(o)},!0):console.warn("Missing context")}}static remove(t){var i;t&&((i=t.parent)==null||i.remove(t),Mc(t,!1),zd(t),O.foreachComponent(t,s=>{v2(s)},!0))}static invokeOnChildren(t,i,...s){this.invoke(t,i,!0,s)}static invoke(t,i,s=!1,...o){t&&this.foreachComponent(t,r=>{const l=r[i];l&&typeof l=="function"&&l?.call(r,...o)},s)}static addNewComponent(t,i,s,o=!0){return Ri(t,i,s,{callAwake:o})}static addComponent(t,i,s,o){return Ri(t,i,s,o)}static moveComponent(t,i){return Ri(t,i)}static removeComponent(t){return Ug(t.gameObject,t),t}static getOrAddComponent(t,i){return Sc(t,i)}static getComponent(t,i){return t===null?null:vr(t,i)}static getComponents(t,i,s=null){return t===null?s??[]:Cc(t,i,s)}static findByGuid(t,i){return Ng(t,i)}static findObjectOfType(t,i,s=!0){return kc(t,i??ee.Current,s)}static findObjectsOfType(t,i){const s=[];return M_(t,s,i),s}static getComponentInChildren(t,i){return Oc(t,i)}static getComponentsInChildren(t,i,s=null){return Ia(t,i,s??void 0)}static getComponentInParent(t,i){return Pc(t,i)}static getComponentsInParent(t,i,s=null){return $d(t,i,s)}static getAllComponents(t){var i;const s=(i=t.userData)==null?void 0:i.components;return s?[...s]:[]}static*iterateComponents(t){var i;const s=(i=t?.userData)==null?void 0:i.components;if(s&&Array.isArray(s))for(let o=0;o<s.length;o++)yield s[o]}}const fu=class{constructor(n){a(this,"__context"),a(this,"__name"),a(this,"gameObject"),a(this,"guid","invalid"),a(this,"sourceId"),a(this,"__didAwake",!1),a(this,"__didStart",!1),a(this,"__didEnable",!1),a(this,"__isEnabled"),a(this,"__destroyed",!1),a(this,"_eventListeners",new Map),this.__didAwake=!1,this.__didStart=!1,this.__didEnable=!1,this.__isEnabled=void 0,this.__destroyed=!1,this._internalInit(n)}get isComponent(){return!0}get context(){return this.__context??ee.Current}set context(n){this.__context=n}get scene(){return this.context.scene}get layer(){var n,t;return(t=(n=this.gameObject)==null?void 0:n.userData)==null?void 0:t.layer}get name(){var n,t;return(n=this.gameObject)!=null&&n.name?this.gameObject.name:(t=this.gameObject)==null?void 0:t.userData.name}set name(n){this.gameObject?(this.gameObject.userData||(this.gameObject.userData={}),this.gameObject.userData.name=n,this.__name=n):this.__name=n}get tag(){var n;return(n=this.gameObject)==null?void 0:n.userData.tag}set tag(n){this.gameObject&&(this.gameObject.userData||(this.gameObject.userData={}),this.gameObject.userData.tag=n)}get static(){var n;return(n=this.gameObject)==null?void 0:n.userData.static}set static(n){this.gameObject&&(this.gameObject.userData||(this.gameObject.userData={}),this.gameObject.userData.static=n)}get activeAndEnabled(){return!(this.destroyed||this.__isEnabled===!1||!this.__isActiveInHierarchy)}get __isActive(){return this.gameObject.visible}get __isActiveInHierarchy(){if(!this.gameObject)return!1;const n=this.gameObject[_s];return n===void 0?!0:n}set __isActiveInHierarchy(n){this.gameObject&&(this.gameObject[_s]=n)}awake(){}onEnable(){}onDisable(){}onDestroy(){this.__destroyed=!0}startCoroutine(n,t=Me.Update){return this.context.registerCoroutineUpdate(this,n,t)}stopCoroutine(n,t=Me.Update){this.context.unregisterCoroutineUpdate(n,t)}get destroyed(){return this.__destroyed}destroy(){this.__destroyed||this.__internalDestroy()}get __internalDidAwakeAndStart(){return this.__didAwake&&this.__didStart}__internalNewInstanceCreated(n){return this.__didAwake=!1,this.__didStart=!1,this.__didEnable=!1,this.__isEnabled=void 0,this.__destroyed=!1,this._internalInit(n),this}_internalInit(n){if(typeof n=="object")for(const t of Object.keys(n)){const i=n[t];typeof i!="function"&&(this[t]=i)}}__internalAwake(){this.__didAwake||(this.__didAwake=!0,this.awake())}__internalStart(){this.__didStart||(this.__didStart=!0,this.start&&this.start())}__internalEnable(n){return this.__destroyed?(F()&&console.warn("[Needle Engine Dev] Trying to enable destroyed component"),!1):this.__didAwake?this.__didEnable?(n!==!0&&(this.__isEnabled=!0),!1):(this.__didEnable=!0,this.__isEnabled=!0,this.onEnable(),!0):!1}__internalDisable(n){if(this.__didAwake){if(!this.__didEnable){n!==!0&&(this.__isEnabled=!1);return}this.__didEnable=!1,this.__isEnabled=!1,this.onDisable()}}__internalDestroy(){var n;this.__destroyed||(this.__destroyed=!0,this.__didAwake&&((n=this.onDestroy)==null||n.call(this),this.dispatchEvent(new CustomEvent("destroyed",{detail:this}))),O_(this))}get enabled(){return typeof this.__isEnabled=="boolean"?this.__isEnabled:!0}set enabled(n){if(this.__destroyed){F()&&console.warn(`[Needle Engine Dev] Trying to ${n?"enable":"disable"} destroyed component`);return}if(typeof n=="number"&&(n>=.5?n=!0:n=!1),!this.__didAwake){this.__isEnabled=n;return}n?this.__internalEnable():this.__internalDisable()}get worldPosition(){return te(this.gameObject)}set worldPosition(n){dt(this.gameObject,n)}setWorldPosition(n,t,i){cr(this.gameObject,n,t,i)}get worldQuaternion(){return Ce(this.gameObject)}set worldQuaternion(n){Vi(this.gameObject,n)}setWorldQuaternion(n,t,i,s){Um(this.gameObject,n,t,i,s)}get worldEuler(){return Nm(this.gameObject)}set worldEuler(n){Wm(this.gameObject,n)}get worldRotation(){return this.gameObject.worldRotation}set worldRotation(n){this.setWorldRotation(n.x,n.y,n.z,!0)}setWorldRotation(n,t,i,s=!0){nc(this.gameObject,n,t,i,s)}get forward(){return fu._forward.set(0,0,-1).applyQuaternion(this.worldQuaternion)}get right(){return fu._right.set(1,0,0).applyQuaternion(this.worldQuaternion)}get up(){return fu._up.set(0,1,0).applyQuaternion(this.worldQuaternion)}addEventListener(n,t){this._eventListeners[n]=this._eventListeners[n]||[],this._eventListeners[n].push(t)}removeEventListener(n,t){if(!this._eventListeners[n])return;const i=this._eventListeners[n].indexOf(t);i>=0&&this._eventListeners[n].splice(i,1)}dispatchEvent(n){if(!n||!this._eventListeners[n.type])return!1;const t=this._eventListeners[n.type];for(let i=0;i<t.length;i++)t[i](n);return!1}};let A=fu;a(A,"_forward",new x),a(A,"_right",new x),a(A,"_up",new x);const Ek=Object.freeze(Object.defineProperty({__proto__:null,Behaviour:A,Component:A,GameObject:O},Symbol.toStringTag,{value:"Module"}));var Ak=Object.defineProperty,Ik=Object.getOwnPropertyDescriptor,fw=(n,t,i,s)=>{for(var o=s>1?void 0:s?Ik(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&Ak(t,i,o),o};class Lc extends A{constructor(){super(...arguments),a(this,"from"),a(this,"to"),a(this,"width",0),a(this,"centered",!0),a(this,"_centerPos")}awake(){this._centerPos=new x}update(){if(!this.from||!this.to)return;const t=te(this.from).clone(),i=te(this.to).clone(),s=t.distanceTo(i);this._centerPos.copy(t),this._centerPos.add(i),this._centerPos.multiplyScalar(.5),dt(this.gameObject,this.centered?this._centerPos:t),this.gameObject.lookAt(te(this.to).clone()),this.gameObject.scale.set(this.width,this.width,s)}}fw([m(O)],Lc.prototype,"from",2),fw([m(O)],Lc.prototype,"to",2);var jk=Object.defineProperty,Lk=Object.getOwnPropertyDescriptor,Mr=(n,t,i,s)=>{for(var o=s>1?void 0:s?Lk(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&jk(t,i,o),o};const vo=C("debuganimation");let yw=class{constructor(){a(this,"x"),a(this,"y")}};class Ut extends A{constructor(){super(...arguments),a(this,"playAutomatically",!0),a(this,"randomStartTime",!0),a(this,"minMaxSpeed"),a(this,"minMaxOffsetNormalized"),a(this,"loop",!0),a(this,"clampWhenFinished",!1),a(this,"_tempAnimationClipBeforeGameObjectExisted",null),a(this,"_tempAnimationsArray"),a(this,"mixer"),a(this,"_actions"),a(this,"_handles")}get isAnimationComponent(){return!0}addClip(t){this.animations||(this.animations=[]),this.animations.push(t)}get time(){if(this.actions){for(const t of this.actions)if(t.isRunning())return t.time}return 0}set time(t){if(this.actions)for(const i of this.actions)i.time=t}get clip(){var t;return(t=this.animations)!=null&&t.length?this.animations[0]:null}set clip(t){if(!this.__didAwake){vo&&console.warn("Assign clip during serialization",t),this._tempAnimationClipBeforeGameObjectExisted=t;return}t&&(this.gameObject.animations||(this.gameObject.animations=[]),!this.animations.includes(t)&&(this.animations.length>0?this.animations.splice(0,0,t):this.animations.push(t)))}set clips(t){this.animations=t}set animations(t){t==null||!Array.isArray(t)||(this.gameObject?this.gameObject.animations=t:this._tempAnimationsArray=t)}get animations(){return this.gameObject.animations||this._tempAnimationsArray||[]}get actions(){return this._actions}set actions(t){this._actions=t}awake(){this.mixer=void 0,vo&&console.log("Animation Awake",this.name,this),this._tempAnimationsArray&&(this.animations=this._tempAnimationsArray,this._tempAnimationsArray=void 0),this._tempAnimationClipBeforeGameObjectExisted&&(this.clip=this._tempAnimationClipBeforeGameObjectExisted,this._tempAnimationClipBeforeGameObjectExisted=null),this.actions=[],this._handles=[]}onEnable(){var t;if(this.playAutomatically&&((t=this.animations)==null?void 0:t.length)>0){const i=Math.floor(Math.random()*this.animations.length),s=this.animations[i];this.play(i,{exclusive:!0,fadeDuration:0,startTime:this.randomStartTime?Math.random()*s.duration:0,loop:this.loop,clampWhenFinished:this.clampWhenFinished})}}update(){this.mixer&&(this.mixer.update(this.context.time.deltaTime),this._handles.forEach(t=>t.update()))}onDisable(){this.mixer&&this.mixer.stopAllAction()}onDestroy(){this.context.animations.unregisterAnimationMixer(this.mixer)}getAction(t){var i;return((i=this.actions)==null?void 0:i.find(s=>s.getClip().name===t))||null}get isPlaying(){if(this.actions){for(let t=0;t<this.actions.length;t++)if(this.actions[t].isRunning())return!0}return!1}stopAll(t){if(this.actions)for(const i of this.actions)t!=null&&t.fadeDuration?i.fadeOut(t.fadeDuration):i.stop()}stop(t,i){if(t===void 0){this.stopAll();return}else if(typeof t=="number"){if(t>=this.animations.length){vo&&console.log("No animation at index",t);return}t=this.animations[t]}else typeof t=="string"&&(t=this.animations.find(o=>o.name===t));if(!t){console.error("Could not find clip",t);return}const s=this.actions.find(o=>o.getClip()===t);if(!s){console.error("Could not find action",t);return}i!=null&&i.fadeDuration?s.fadeOut(i.fadeDuration):s.stop()}pause(t,i=!1){if(t===void 0){for(const o of this.actions)o.paused=!i;return}else if(typeof t=="number"){if(t>=this.animations.length){vo&&console.log("No animation at index",t);return}t=this.animations[t]}else typeof t=="string"&&(t=this.animations.find(o=>o.name===t));if(!t){console.error("Could not find clip",t);return}const s=this.actions.find(o=>o.getClip()===t);if(!s){console.error("Could not find action",t);return}s.paused=!i}resume(){for(const t of this.actions)t.paused=!1}play(t=0,i){if(vo&&console.log("PLAY",t),this.ensureMixer(),!this.mixer){vo&&console.warn("Missing mixer",this);return}t===void 0&&(t=0);let s=t;if(typeof t=="number"){if(t>=this.animations.length){vo&&console.log("No animation at index",t);return}s=this.animations[t]}else typeof t=="string"&&(s=this.animations.find(r=>r.name===t));if(!s){console.error("Could not find clip",t);return}i||(i={});for(const r of this.actions)if(r.getClip()===s)return this.internalOnPlay(r,i);if(!s.tracks){console.warn("Clip is no AnimationClip",s);return}const o=this.mixer.clipAction(s);return this.actions.push(o),this.internalOnPlay(o,i)}internalOnPlay(t,i){var s=this.actions.find(r=>r===t);if(s===t&&s.isRunning()&&s.time<s.getClip().duration){const r=this.tryFindHandle(t);if(s.paused&&(s.paused=!1),r)return r.waitForFinish()}if(i.loop===void 0&&(i.loop=this.loop),i.clampWhenFinished===void 0&&(i.clampWhenFinished=this.clampWhenFinished),i.minMaxOffsetNormalized===void 0&&this.randomStartTime&&(i.minMaxOffsetNormalized=this.minMaxOffsetNormalized),i.minMaxSpeed===void 0&&(i.minMaxSpeed=this.minMaxSpeed),i?.exclusive??!0)for(const r of this.actions)r!=s&&(i.fadeDuration?r.fadeOut(i.fadeDuration):r.stop());if(i!=null&&i.fadeDuration&&t.fadeIn(i.fadeDuration),t.enabled=!0,i?.startTime!=null)t.time=i.startTime;else if(i!=null&&i.minMaxOffsetNormalized&&i.minMaxOffsetNormalized.x!=0&&i.minMaxOffsetNormalized.y!=0){const r=t.getClip();t.time=W.lerp(i.minMaxOffsetNormalized.x,i.minMaxOffsetNormalized.y,Math.random())*r.duration}else t.time>=t.getClip().duration&&(t.time=0);i!=null&&i.minMaxSpeed?t.timeScale=W.lerp(i.minMaxSpeed.x,i.minMaxSpeed.y,Math.random()):t.timeScale=i?.speed??1,i?.loop!=null?t.loop=i.loop?ES:am:t.loop=am,i!=null&&i.clampWhenFinished&&(t.clampWhenFinished=!0),t.paused=!1,t.play(),vo&&console.log("PLAY",t.getClip().name,t);const o=new Dk(t,this.mixer,i,r=>{this._handles.splice(this._handles.indexOf(o),1)});return this._handles.push(o),o.waitForFinish()}tryFindHandle(t){for(const i of this._handles)if(i.action===t)return i}ensureMixer(){if(!this.mixer){const t="animationMixer";this.gameObject[t]&&(this.mixer=this.gameObject[t]),(!this.mixer||!this.mixer.clipAction)&&(this.mixer=new lm(this.gameObject),this.gameObject[t]=this.mixer)}this.context.animations.registerAnimationMixer(this.mixer)}}Mr([m()],Ut.prototype,"playAutomatically",2),Mr([m()],Ut.prototype,"randomStartTime",2),Mr([m(yw)],Ut.prototype,"minMaxSpeed",2),Mr([m(yw)],Ut.prototype,"minMaxOffsetNormalized",2),Mr([m()],Ut.prototype,"loop",2),Mr([m()],Ut.prototype,"clampWhenFinished",2),Mr([m(oo)],Ut.prototype,"clips",1);class Dk{constructor(t,i,s,o){a(this,"mixer"),a(this,"action"),a(this,"promise",null),a(this,"_options"),a(this,"_resolveCallback",null),a(this,"_resolvedOrRejectedCallback"),a(this,"onFinished",r=>{r.action===this.action&&this.onResolve()}),this.action=t,this.mixer=i,this._resolvedOrRejectedCallback=o,this._options=s}waitForFinish(){return this.promise?this.promise:(this.promise=new Promise(t=>{this._resolveCallback=t}),this.mixer.addEventListener("finished",this.onFinished),this.promise)}update(){this._options&&this._options.endTime!==void 0&&this.action.time>this._options.endTime&&(this._options.loop===!0?this.action.time=this._options.startTime??0:(this.action.time=this._options.endTime,this.action.timeScale=0,this.onResolve()))}onResolve(){var t,i;this.dispose(),(t=this._resolvedOrRejectedCallback)==null||t.call(this,this),(i=this._resolveCallback)==null||i.call(this,this.action)}dispose(){this.mixer.removeEventListener("finished",this.onFinished)}}const yu=Symbol("objectIsAnimatedData");function vw(n,t,i){if(!n)return;if(n[yu]===void 0){if(!i)return;n[yu]=new Set}const s=n[yu];i?s.add(t):s.has(t)&&s.delete(t)}function Bk(n){if(!n)return!1;const t=n[yu];return t!==void 0&&t.size>0}class Fk{constructor(){a(this,"_context")}get context(){return this._context??ee.Current}get isStateMachineBehaviour(){return!0}}class Dc{constructor(t,i,s,o){a(this,"name"),a(this,"nameHash"),a(this,"normalizedTime"),a(this,"length"),a(this,"speed"),a(this,"action"),a(this,"hasTransitions");var r;this.name=t.name,this.nameHash=t.hash,this.normalizedTime=i,this.length=s,this.speed=o,this.action=t.motion.action||null,this.hasTransitions=((r=t.transitions)==null?void 0:r.length)>0||!1}}function bw(n,t){return{name:"Empty",isLooping:!1,guid:t?.generateUUID()??ms.generateUUID(),index:-1,clip:new oo(n,0,[])}}var bo=(n=>(n[n.If=1]="If",n[n.IfNot=2]="IfNot",n[n.Greater=3]="Greater",n[n.Less=4]="Less",n[n.Equals=6]="Equals",n[n.NotEqual=7]="NotEqual",n))(bo||{}),lf=(n=>(n[n.Float=1]="Float",n[n.Int=3]="Int",n[n.Bool=4]="Bool",n[n.Trigger=9]="Trigger",n))(lf||{});const pt=C("debuganimatorcontroller"),vu=C("debugrootmotion");class ln{constructor(t){a(this,"_speed",1),a(this,"normalizedStartOffset",0),a(this,"animator"),a(this,"model"),a(this,"_mixer"),a(this,"_activeState"),a(this,"_activeStates",[]),a(this,"_heldActions",[]),a(this,"rootMotionHandler"),this.model=t,pt&&console.log(this)}static createFromClips(t,i={looping:!1,autoTransition:!0,transitionDuration:0}){const s=[];for(let r=0;r<t.length;r++){const l=t[r],c=[];if(i.autoTransition!==!1){const d=i.transitionDuration??0,u=d/l.duration;let p=r;(i.autoTransition===void 0||i.autoTransition===!0)&&(p=(r+1)%t.length),c.push({exitTime:1-u,offset:0,duration:d,hasExitTime:!0,destinationState:p,conditions:[]})}const h={name:l.name,hash:r,motion:{name:l.name,clip:l,isLooping:i?.looping??!1},transitions:c,behaviours:[]};s.push(h)}const o={name:"AnimatorController",guid:new Dt(Date.now()).generateUUID(),parameters:[],layers:[{name:"Base Layer",stateMachine:{defaultState:0,states:s}}]};return new ln(o)}play(t,i=-1,s=Number.NEGATIVE_INFINITY,o=0){if(i<0)i=0;else if(i>=this.model.layers.length){console.warn("invalid layer");return}const r=this.model.layers[i].stateMachine;for(const l of r.states)if(l.name===t||l.hash===t){pt&&console.log("transition to ",l),this.transitionTo(l,o,s);return}console.warn("Could not find "+t+" to play")}reset(){this.setStartTransition()}setBool(t,i){var s,o;const r=typeof t=="string"?"name":"hash";return(o=(s=this.model)==null?void 0:s.parameters)==null?void 0:o.filter(l=>l[r]===t).forEach(l=>l.value=i)}getBool(t){var i,s,o;const r=typeof t=="string"?"name":"hash";return((o=(s=(i=this.model)==null?void 0:i.parameters)==null?void 0:s.find(l=>l[r]===t))==null?void 0:o.value)??!1}setFloat(t,i){var s,o;const r=typeof t=="string"?"name":"hash",l=(o=(s=this.model)==null?void 0:s.parameters)==null?void 0:o.filter(c=>c[r]===t);return l.forEach(c=>c.value=i),l?.length>0}getFloat(t){var i,s,o;const r=typeof t=="string"?"name":"hash";return((o=(s=(i=this.model)==null?void 0:i.parameters)==null?void 0:s.find(l=>l[r]===t))==null?void 0:o.value)??0}setInteger(t,i){var s,o;const r=typeof t=="string"?"name":"hash";return(o=(s=this.model)==null?void 0:s.parameters)==null?void 0:o.filter(l=>l[r]===t).forEach(l=>l.value=i)}getInteger(t){var i,s,o;const r=typeof t=="string"?"name":"hash";return((o=(s=(i=this.model)==null?void 0:i.parameters)==null?void 0:s.find(l=>l[r]===t))==null?void 0:o.value)??0}setTrigger(t){var i,s;pt&&console.log("SET TRIGGER",t);const o=typeof t=="string"?"name":"hash";return(s=(i=this.model)==null?void 0:i.parameters)==null?void 0:s.filter(r=>r[o]===t).forEach(r=>r.value=!0)}resetTrigger(t){var i,s;const o=typeof t=="string"?"name":"hash";return(s=(i=this.model)==null?void 0:i.parameters)==null?void 0:s.filter(r=>r[o]===t).forEach(r=>r.value=!1)}getTrigger(t){var i,s,o;const r=typeof t=="string"?"name":"hash";return((o=(s=(i=this.model)==null?void 0:i.parameters)==null?void 0:s.find(l=>l[r]===t))==null?void 0:o.value)??!1}isInTransition(){return this._activeStates.length>1}setSpeed(t){this._speed=t}FindState(t){return this.findState(t)}findState(t){if(!t)return null;if(Array.isArray(this.model.layers)){for(const i of this.model.layers)for(const s of i.stateMachine.states)if(s.name===t||s.hash==t)return s}return null}getCurrentStateInfo(){if(!this._activeState)return null;const t=this._activeState.motion.action;if(!t)return null;const i=this._activeState.motion.clip.duration,s=i<=0?0:Math.abs(t.time/i);return new Dc(this._activeState,s,i,this._speed)}get currentAction(){return this._activeState&&this._activeState.motion.action||null}get context(){var t;return(t=this.animator)==null?void 0:t.context}get mixer(){return this._mixer}dispose(){var t;if(this._mixer.stopAllAction(),this.animator){this._mixer.uncacheRoot(this.animator.gameObject);for(const i of this._activeStates)i.motion.clip&&this.mixer.uncacheAction(i.motion.clip,this.animator.gameObject)}(t=this.context)==null||t.animations.unregisterAnimationMixer(this._mixer)}bind(t){var i,s;t?this.animator!==t&&(this._mixer&&(this._mixer.stopAllAction(),(i=this.context)==null||i.animations.unregisterAnimationMixer(this._mixer)),this.animator=t,this._mixer=new lm(this.animator.gameObject),(s=this.context)==null||s.animations.registerAnimationMixer(this._mixer),this.createActions(this.animator)):console.error("AnimatorController.bind: animator is null")}clone(){if(typeof this.model=="string")return console.warn("AnimatorController has not been resolved, can not create model from string",this.model),null;pt&&console.warn("AnimatorController clone()",this.model);const t=Zl(this.model,(i,s,o)=>o==null?!0:!(o.type==="Object3D"||o.isObject3D===!0||Xv(o)||o.tracks!==void 0||o instanceof ln));return console.assert(t!==this.model),new ln(t)}update(t){var i,s;if(!this.animator)return;this.evaluateTransitions(),this.updateActiveStates(t);const o=this.animator.context.time.deltaTime;this.animator.applyRootMotion&&((i=this.rootMotionHandler)==null||i.onBeforeUpdate(t)),this._mixer.update(o),this.animator.applyRootMotion&&((s=this.rootMotionHandler)==null||s.onAfterUpdate(t))}get activeState(){return this._activeState}updateActiveStates(t){for(let i=0;i<this._activeStates.length;i++){const s=this._activeStates[i],o=s.motion;if(!o.action)this._activeStates.splice(i,1),i--;else{const r=o.action;r.weight=t,r.getEffectiveWeight()<=0&&!r.isRunning()&&(pt&&console.debug("REMOVE",s.name,r.getEffectiveWeight(),r.isRunning(),r.isScheduled()),this._activeStates.splice(i,1),i--)}}}setStartTransition(){var t;this.model.layers.length>1&&(pt||F())&&console.warn("Multiple layers are not supported yet "+((t=this.animator)==null?void 0:t.name));for(const i of this.model.layers){const s=i.stateMachine;s.defaultState===void 0&&(pt&&console.warn("AnimatorController default state is undefined, will assign state 0 as default",i),s.defaultState=0);const o=s.states[s.defaultState];this.transitionTo(o,0,this.normalizedStartOffset);break}}evaluateTransitions(){var t;let i=!1;if(!this._activeState){if(this.setStartTransition(),!this._activeState)return;i=!0}const s=this._activeState,o=s.motion.action;for(const l of s.transitions){if(!l.hasExitTime&&l.conditions.length<=0)continue;let c=!0;for(const h of l.conditions)if(!this.evaluateCondition(h)){c=!1;break}if(c)if(o){const h=s.motion.clip.duration,d=h<=0?1:Math.abs(o.time/h);let u=l.exitTime;o.timeScale<0&&(u=1-u);let p=!1;if(l.hasExitTime?o.timeScale>0?p=d>=l.exitTime:o.timeScale<0&&(p=1-d>=l.exitTime):p=!0,p){for(const g of l.conditions){const y=this.model.parameters.find(f=>f.name===g.parameter);y?.type===lf.Trigger&&y.value&&(y.value=!1)}if(o.clampWhenFinished=!0,pt){const g=this.getState(l.destinationState,0);console.log(`Transition to ${l.destinationState} / ${g?.name}`,l,`
Timescale: `+o.timeScale,`
Normalized time: `+d.toFixed(3),`
Exit Time: `+u,l.hasExitTime)}this.transitionTo(l.destinationState,l.duration,l.offset);return}}else{this.transitionTo(l.destinationState,l.duration,l.offset);return}}o&&this.setTimescale(o,s);let r=!1;if(s.motion.isLooping&&o&&(o.time>=o.getClip().duration?(r=!0,o.reset(),o.time=0,o.play()):o.time<=0&&o.timeScale<0&&(r=!0,o.reset(),o.time=o.getClip().duration,o.play())),!r&&s&&!i&&o&&this.animator&&s.behaviours){const l=o?.getClip().duration,c=o.time/l,h=new Dc(this._activeState,c,l,this._speed);for(const d of s.behaviours)d.instance&&((t=d.instance.onStateUpdate)==null||t.call(d.instance,this.animator,h,0))}}setTimescale(t,i){let s=i.speed??1;i.speedParameter&&(s*=this.getFloat(i.speedParameter)),s!==void 0&&(t.timeScale=s*this._speed)}getState(t,i){return typeof t=="number"&&(t==-1&&(t=this.model.layers[i].stateMachine.defaultState,t===void 0&&(pt&&console.warn("AnimatorController default state is undefined: ",this.model,"Layer: "+i),t=0)),t=this.model.layers[i].stateMachine.states[t]),t}releaseHeldActions(t){for(const i of this._heldActions)i.fadeOut(t);this._heldActions.length=0}transitionTo(t,i,s){var o,r,l,c,h,d,u,p;if(!this.animator)return;const g=0;if(t=this.getState(t,g),!(t!=null&&t.motion)||!t.motion.clip||!(t.motion.clip instanceof oo))return;const y=this._activeState===t;if(y){const _=t.motion;if(!_.action_loopback&&_.clip){const S=this.rootMotionHandler?this.animator.gameObject.matrix.clone():null;this._mixer.uncacheAction(_.clip,this.animator.gameObject),S&&S.decompose(this.animator.gameObject.position,this.animator.gameObject.quaternion,this.animator.gameObject.scale),_.action_loopback=this.createAction(_.clip)}}if((o=this._activeState)!=null&&o.behaviours&&this._activeState.motion.action){const _=(r=this._activeState)==null?void 0:r.motion.clip.duration,S=this._activeState.motion.action.time/_,R=new Dc(this._activeState,S,_,this._speed);for(const M of this._activeState.behaviours)(c=(l=M.instance)==null?void 0:l.onStateExit)==null||c.call(M.instance,this.animator,R,g)}const f=(h=this._activeState)==null?void 0:h.motion.action;y&&(t.motion.action=t.motion.action_loopback,t.motion.action_loopback=f);const v=this._activeState;this._activeState=t;const b=(d=t.motion)==null?void 0:d.action,w=t.motion.clip;if(w?.duration<=0&&w.tracks.length<=0?f&&this._heldActions.push(f):f&&(f.fadeOut(i),this.releaseHeldActions(i)),b){if(s=Math.max(0,Math.min(1,s)),t.cycleOffsetParameter){let S=this.getFloat(t.cycleOffsetParameter);typeof S=="number"?(S<0&&(S+=1),s+=S,s%=1):pt&&console.warn("AnimatorController cycle offset parameter is not a number",t.cycleOffsetParameter)}else typeof t.cycleOffset=="number"&&(s+=t.cycleOffset,s%=1);b.isRunning()&&b.stop(),b.reset(),b.enabled=!0,this.setTimescale(b,t);const _=t.motion.clip.duration;if(b.time=y?0:s*_,b.timeScale<0&&(b.time=_-b.time),b.clampWhenFinished=!0,b.setLoop(am,0),i>0?b.fadeIn(i):b.weight=1,b.play(),this.rootMotionHandler&&this.rootMotionHandler.onStart(b),this._activeStates.includes(t)||this._activeStates.push(t),this._activeState.behaviours){const S=new Dc(t,s,_,this._speed);for(const R of this._activeState.behaviours)(p=(u=R.instance)==null?void 0:u.onStateEnter)==null||p.call(R.instance,this.animator,S,g)}}else pt&&(t.__warned_no_motion||(t.__warned_no_motion=!0,console.warn("No action",t.motion,this)));pt&&console.log("TRANSITION FROM "+v?.name+" TO "+t.name,i,f,b,b?.getEffectiveTimeScale(),b?.getEffectiveWeight(),b?.isRunning(),b?.isScheduled(),b?.paused)}createAction(t){var i,s;if(this._mixer.existingAction(t)&&this._mixer.uncacheAction(t,(i=this.animator)==null?void 0:i.gameObject),(s=this.animator)!=null&&s.applyRootMotion){this.rootMotionHandler||(this.rootMotionHandler=new zk(this));const o=this.animator.gameObject;return this.rootMotionHandler.createClip(this._mixer,o,t)}else return this._mixer.clipAction(t)}evaluateCondition(t){const i=this.model.parameters.find(s=>s.name===t.parameter);if(!i)return!1;switch(t.mode){case bo.If:return i.value===!0;case bo.IfNot:return i.value===!1;case bo.Greater:return i.value>t.threshold;case bo.Less:return i.value<t.threshold;case bo.Equals:return i.value===t.threshold;case bo.NotEqual:return i.value!==t.threshold}return!1}createActions(t){var i,s,o,r;pt&&console.log("AnimatorController createActions",this.model);for(const l of this.model.layers){const c=l.stateMachine;for(let h=0;h<c.states.length;h++){const d=c.states[h];d.transitions||(d.transitions=[]);for(const u of d.transitions)u.conditions||(u.conditions=[]);if(d.motion||(pt&&console.warn("No motion",d),d.motion=bw(d.name)),this.animator&&d.motion.clips){const u=(i=d.motion.clips)==null?void 0:i.find(p=>{var g,y;return p.node.name===((y=(g=this.animator)==null?void 0:g.gameObject)==null?void 0:y.name)});u?d.motion.clip=u.clip:(pt||F())&&console.warn('Could not find clip for animator "'+((o=(s=this.animator)==null?void 0:s.gameObject)==null?void 0:o.name)+'"',d.motion.clips.map(p=>p.node.name))}if(!d.motion.clip){pt&&console.warn("No clip assigned to state",d);const u=new oo(void 0,void 0,[]);d.motion.clip=u}if((r=d.motion)!=null&&r.clip){const u=d.motion.clip;if(u instanceof oo){const p=this.createAction(u);d.motion.action=p}else(pt||F())&&console.warn("No valid animationclip assigned",d)}if(d.behaviours&&Array.isArray(d.behaviours))for(const u of d.behaviours){if(!(u!=null&&u.typeName))continue;const p=k.get(u.typeName);if(p){const g=new p;g.isStateMachineBehaviour&&(g._context=this.context??void 0,Aa(g,u.properties),u.instance=g),pt&&console.log("Created animator controller behaviour",d.name,u.typeName,u.properties,g)}else(pt||F())&&console.warn("Could not find AnimatorBehaviour type: "+u.typeName)}}}}*enumerateActions(){if(this.model.layers)for(const t of this.model.layers){const i=t.stateMachine;for(let s=0;s<i.states.length;s++){const o=i.states[s];o!=null&&o.motion&&(o.motion.action&&(yield o.motion.action),o.motion.action_loopback&&(yield o.motion.action_loopback))}}}}class _w{constructor(t,i){a(this,"track"),a(this,"createdInterpolant"),a(this,"originalEvaluate"),a(this,"customEvaluate"),this.track=t;const s=t,o=s.createInterpolant.bind(t);s.createInterpolant=()=>(s.createInterpolant=o,this.createdInterpolant=o(),this.originalEvaluate=this.createdInterpolant.evaluate.bind(this.createdInterpolant),this.customEvaluate=r=>{if(!this.originalEvaluate)return;const l=this.originalEvaluate(r);return i(r,l)},this.createdInterpolant.evaluate=this.customEvaluate,this.createdInterpolant)}dispose(){this.createdInterpolant&&this.originalEvaluate&&(this.createdInterpolant.evaluate=this.originalEvaluate),this.track=void 0,this.createdInterpolant=null,this.originalEvaluate=void 0,this.customEvaluate=void 0}}const _t=class{constructor(n,t,i,s,o){if(a(this,"_action"),a(this,"root"),a(this,"clip"),a(this,"positionWrapper",null),a(this,"rotationWrapper",null),a(this,"context"),a(this,"positionChange",new x),a(this,"rotationChange",new V),a(this,"_prevTime",0),this.context=n,this.root=t,this.clip=i,_t.firstKeyframeRotation[this.cacheId]||(_t.firstKeyframeRotation[this.cacheId]=new V),o){const r=o.values;_t.firstKeyframeRotation[this.cacheId].set(r[0],r[1],r[2],r[3])}_t.spaceRotation[this.cacheId]||(_t.spaceRotation[this.cacheId]=new V),_t.effectiveSpaceRotation[this.cacheId]||(_t.effectiveSpaceRotation[this.cacheId]=new V),_t.clipOffsetRotation[this.cacheId]=new V,o&&_t.clipOffsetRotation[this.cacheId].set(o.values[0],o.values[1],o.values[2],o.values[3]).invert(),this.handlePosition(i,s),this.handleRotation(i,o)}set action(n){this._action=n}get action(){return this._action}get cacheId(){return this.root.uuid}onStart(n){if(n.getClip()!==this.clip)return;_t.lastObjRotation[this.cacheId]||(_t.lastObjRotation[this.cacheId]=this.root.quaternion.clone());const t=_t.lastObjRotation[this.cacheId];if(_t.spaceRotation[this.cacheId].copy(t),vu){const i=new Bt().setFromQuaternion(t);console.log("START",this.clip.name,W.toDegrees(i.y),this.root.position.z)}}getClipRotationOffset(){return _t.clipOffsetRotation[this.cacheId]}handlePosition(n,t){if(t){const i=this.root;vu&&i.add(new Si),_t.lastObjPosition[this.cacheId]||(_t.lastObjPosition[this.cacheId]=this.root.position.clone());const s=new x,o=new x;this.positionWrapper=new _w(t,(r,l)=>{const c=this.action.getEffectiveWeight();return vu&&i.position.length()>8&&i.position.set(0,i.position.y,0),r>this._prevTime&&(s.set(l[0],l[1],l[2]),s.sub(o),s.multiplyScalar(c),s.applyQuaternion(this.getClipRotationOffset()),s.applyQuaternion(i.quaternion),this.positionChange.copy(s)),o.fromArray(l),this._prevTime=r,l[0]=0,l[1]=0,l[2]=0,l})}}handleRotation(n,t){if(t){if(vu){const r=t.values,l=new Bt().setFromQuaternion(new V(r[0],r[1],r[2],r[3]));console.log(n.name,t.name,"FIRST ROTATION IN TRACK",W.toDegrees(l.y));const c=t.values.length-4,h=new V().set(r[c],r[c+1],r[c+2],r[c+3]),d=new Bt().setFromQuaternion(h);console.log(n.name,t.name,"LAST ROTATION IN TRACK",W.toDegrees(d.y))}let i=0;const s=new V,o=new V;this.rotationWrapper=new _w(t,(r,l)=>(r>i&&(o.set(l[0],l[1],l[2],l[3]),s.invert(),o.multiply(s),this.rotationChange.copy(o)),s.fromArray(l),i=r,l[0]=0,l[1]=0,l[2]=0,l[3]=1,l))}}onBeforeUpdate(n){this.positionChange.set(0,0,0),this.rotationChange.set(0,0,0,1)}onAfterUpdate(n){return!this.action||(n*=this.action.getEffectiveWeight(),n<=0)?!1:(this.positionChange.multiplyScalar(n),this.rotationChange.slerp(_t.identityQuaternion,1-n),!0)}};let _o=_t;a(_o,"lastObjPosition",{}),a(_o,"lastObjRotation",{}),a(_o,"firstKeyframeRotation",{}),a(_o,"spaceRotation",{}),a(_o,"effectiveSpaceRotation",{}),a(_o,"clipOffsetRotation",{}),a(_o,"identityQuaternion",new V);class zk{constructor(t){a(this,"controller"),a(this,"handler",[]),a(this,"root"),a(this,"basePosition",new x),a(this,"baseQuaternion",new V),a(this,"baseRotation",new Bt),a(this,"summedPosition",new x),a(this,"summedRotation",new V),this.controller=t}createClip(t,i,s){this.root=i,i&&"name"in i&&i.name;const o=this.findRootTrack(s,".position"),r=this.findRootTrack(s,".quaternion"),l=new _o(this.controller.context,i,s,o,r);this.handler.push(l);const c=t.clipAction(s);return l.action=c,c}onStart(t){for(const i of this.handler)i.onStart(t)}onBeforeUpdate(t){this.basePosition.copy(this.root.position),this.baseQuaternion.copy(this.root.quaternion);for(const i of this.handler)i.onBeforeUpdate(t)}onAfterUpdate(t){if(!(t<=0)){this.root.position.copy(this.basePosition),this.root.quaternion.copy(this.baseQuaternion),this.summedPosition.set(0,0,0),this.summedRotation.set(0,0,0,1);for(const i of this.handler)i.onAfterUpdate(t)&&(this.summedPosition.add(i.positionChange),this.summedRotation.multiply(i.rotationChange));this.root.position.add(this.summedPosition),this.root.quaternion.multiply(this.summedRotation)}}findRootTrack(t,i){const s=t.tracks;if(!s)return null;for(const o of s)if(o.name.endsWith(i))return o;return null}}class Uk extends Xi{onSerialize(t,i){}onDeserialize(t,i){if(i.type===ln&&t?.__type==="AnimatorController")return new ln(t)}}new Uk(ln);var Nk=Object.defineProperty,Wk=Object.getOwnPropertyDescriptor,bu=(n,t,i,s)=>{for(var o=s>1?void 0:s?Wk(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&Nk(t,i,o),o};const Yi=C("debuganimator");class kt extends A{constructor(){super(...arguments),a(this,"applyRootMotion",!1),a(this,"hasRootMotion",!1),a(this,"keepAnimatorControllerStateOnDisable",!1),a(this,"_parametersAreDirty",!1),a(this,"_isDirty",!1),a(this,"_speed",1),a(this,"_normalizedStartOffset",0),a(this,"_animatorController",null),a(this,"_initializeWithRuntimeAnimatorController")}get isAnimationComponent(){return!0}set runtimeAnimatorController(t){var i;this._animatorController&&this._animatorController.model===t||(t?t instanceof ln?(t.animator&&t.animator!==this&&(console.warn("AnimatorController can not be bound to multiple animators",(i=t.model)==null?void 0:i.name),t.model||console.error("AnimatorController has no model"),t=new ln(t.model)),this._animatorController=t,this._animatorController.bind(this)):(Yi&&console.log("Assign animator controller",t,this),this._animatorController=new ln(t),this.__didAwake&&this._animatorController.bind(this)):this._animatorController=null)}get runtimeAnimatorController(){return this._animatorController}getCurrentStateInfo(){var t;return(t=this.runtimeAnimatorController)==null?void 0:t.getCurrentStateInfo()}get currentAction(){var t;return((t=this.runtimeAnimatorController)==null?void 0:t.currentAction)||null}get parametersAreDirty(){return this._parametersAreDirty}get isDirty(){return this._isDirty}Play(t,i=-1,s=Number.NEGATIVE_INFINITY,o=0){this.play(t,i,s,o)}play(t,i=-1,s=Number.NEGATIVE_INFINITY,o=0){var r;(r=this.runtimeAnimatorController)==null||r.play(t,i,s,o),this._isDirty=!0}Reset(){this.reset()}reset(){var t;(t=this._animatorController)==null||t.reset(),this._isDirty=!0}SetBool(t,i){this.setBool(t,i)}setBool(t,i){var s,o;Yi&&console.log("setBool",t,i),((s=this.runtimeAnimatorController)==null?void 0:s.getBool(t))!==i&&(this._parametersAreDirty=!0),(o=this.runtimeAnimatorController)==null||o.setBool(t,i)}GetBool(t){return this.getBool(t)}getBool(t){var i;const s=((i=this.runtimeAnimatorController)==null?void 0:i.getBool(t))??!1;return Yi&&console.log("getBool",t,s),s}toggleBool(t){this.setBool(t,!this.getBool(t))}SetFloat(t,i){this.setFloat(t,i)}setFloat(t,i){var s,o;((s=this.runtimeAnimatorController)==null?void 0:s.getFloat(t))!==i&&(this._parametersAreDirty=!0),Yi&&console.log("setFloat",t,i),(o=this.runtimeAnimatorController)==null||o.setFloat(t,i)}GetFloat(t){return this.getFloat(t)}getFloat(t){var i;const s=((i=this.runtimeAnimatorController)==null?void 0:i.getFloat(t))??-1;return Yi&&console.log("getFloat",t,s),s}SetInteger(t,i){this.setInteger(t,i)}setInteger(t,i){var s,o;((s=this.runtimeAnimatorController)==null?void 0:s.getInteger(t))!==i&&(this._parametersAreDirty=!0),Yi&&console.log("setInteger",t,i),(o=this.runtimeAnimatorController)==null||o.setInteger(t,i)}GetInteger(t){return this.getInteger(t)}getInteger(t){var i;const s=((i=this.runtimeAnimatorController)==null?void 0:i.getInteger(t))??-1;return Yi&&console.log("getInteger",t,s),s}SetTrigger(t){this.setTrigger(t)}setTrigger(t){var i;this._parametersAreDirty=!0,Yi&&console.log("setTrigger",t),(i=this.runtimeAnimatorController)==null||i.setTrigger(t)}ResetTrigger(t){this.resetTrigger(t)}resetTrigger(t){var i;this._parametersAreDirty=!0,Yi&&console.log("resetTrigger",t),(i=this.runtimeAnimatorController)==null||i.resetTrigger(t)}GetTrigger(t){this.getTrigger(t)}getTrigger(t){var i;const s=(i=this.runtimeAnimatorController)==null?void 0:i.getTrigger(t);return Yi&&console.log("getTrigger",t,s),s}IsInTransition(){return this.isInTransition()}isInTransition(){var t;return((t=this.runtimeAnimatorController)==null?void 0:t.isInTransition())??!1}SetSpeed(t){return this.setSpeed(t)}setSpeed(t){var i;t!==this._speed&&(Yi&&console.log("setSpeed",t),this._speed=t,((i=this._animatorController)==null?void 0:i.animator)==this&&this._animatorController.setSpeed(t))}set minMaxSpeed(t){var i;this._speed=W.lerp(t.x,t.y,Math.random()),((i=this._animatorController)==null?void 0:i.animator)==this&&this._animatorController.setSpeed(this._speed)}set minMaxOffsetNormalized(t){var i;this._normalizedStartOffset=W.lerp(t.x,t.y,Math.random()),((i=this.runtimeAnimatorController)==null?void 0:i.animator)==this&&(this.runtimeAnimatorController.normalizedStartOffset=this._normalizedStartOffset)}awake(){Yi&&console.log("ANIMATOR",this.name,this),this.gameObject&&this.initializeRuntimeAnimatorController()}initializeRuntimeAnimatorController(t=!1){const i=t||this.runtimeAnimatorController!==this._initializeWithRuntimeAnimatorController;if(this.runtimeAnimatorController&&i){const s=this.runtimeAnimatorController.clone();this._initializeWithRuntimeAnimatorController=s,s?(console.assert(this.runtimeAnimatorController!==s),this.runtimeAnimatorController=s,console.assert(this.runtimeAnimatorController===s),this.runtimeAnimatorController.bind(this),this.runtimeAnimatorController.setSpeed(this._speed),this.runtimeAnimatorController.normalizedStartOffset=this._normalizedStartOffset):console.warn("Could not clone animator controller",this.runtimeAnimatorController)}}onDisable(){var t;this.keepAnimatorControllerStateOnDisable||(t=this._animatorController)==null||t.reset()}onBeforeRender(){this._isDirty=!1,this._parametersAreDirty=!1,!Bk(this.gameObject)&&this._animatorController&&this._animatorController.update(1)}}bu([m()],kt.prototype,"applyRootMotion",2),bu([m()],kt.prototype,"hasRootMotion",2),bu([m()],kt.prototype,"keepAnimatorControllerStateOnDisable",2),bu([m()],kt.prototype,"runtimeAnimatorController",1);const ww=Symbol("previous-visibility"),Bc=class extends vs{render(n,t,i){if("addPass"in i)this._unsupported_effectcomposer_warning||(console.warn("RenderTexture.render() does not yet support EffectComposer"),this._unsupported_effectcomposer_warning=!0);else if(i instanceof sr){this.onBeforeRender();const s=i.getRenderTarget(),o=i.xr.enabled;i.xr.enabled=!1,i.setRenderTarget(this),i.clear(!0,!0,!0),i.render(n,t),i.setRenderTarget(s),i.xr.enabled=o,this.onAfterRender()}}onBeforeRender(){Bc._userSet.clear();const n=wg(this.texture,!0,null,Bc._userSet);for(const t of n)t instanceof X&&(t[ww]=t.visible,t.visible=!1)}onAfterRender(){for(const n of Bc._userSet)n instanceof X&&(n.visible=n[ww]);Bc._userSet.clear()}};let Na=Bc;a(Na,"_userSet",new Set);var Vk=Object.defineProperty,Hk=Object.getOwnPropertyDescriptor,Fc=(n,t,i,s)=>{for(var o=s>1?void 0:s?Hk(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&Vk(t,i,o),o};const _u=C("debuggroundprojection");class $n extends A{constructor(){super(...arguments),a(this,"applyOnAwake",!1),a(this,"autoFit",!0),a(this,"_radius",50),a(this,"_height",3),a(this,"_arblending",0),a(this,"_lastBackground"),a(this,"_lastRadius"),a(this,"_lastHeight"),a(this,"_projection"),a(this,"_watcher"),a(this,"_needsTextureUpdate",!1),a(this,"_blurrynessShader",null),a(this,"_lastBlurriness",-1)}set radius(t){this._radius=t,this._projection&&this.updateProjection()}get radius(){return this._radius}set height(t){this._height=t,this._projection&&this.updateProjection()}get height(){return this._height}set arBlending(t){this._arblending=t,this._needsTextureUpdate=!0}get arBlending(){return this._arblending}awake(){this.applyOnAwake&&this.updateAndCreate()}onEnable(){this.context.time.frameCount>0&&this.applyOnAwake&&this.updateAndCreate(),this._watcher||(this._watcher=new Js(this.context.scene,"background"),this._watcher.subscribeWrite(t=>{_u&&console.log("Background changed",this.context.scene.background),this._needsTextureUpdate=!0}))}onDisable(){var t,i;(t=this._watcher)==null||t.revoke(),(i=this._projection)==null||i.removeFromParent()}onEnterXR(){this.activeAndEnabled&&(this._needsTextureUpdate=!0,this.updateProjection())}async onLeaveXR(){this.activeAndEnabled&&(await Kl(1),this.updateProjection())}onBeforeRender(){this._projection&&this.scene.backgroundRotation&&this._projection.rotation.copy(this.scene.backgroundRotation),this.context.scene.backgroundBlurriness!==void 0&&this._lastBlurriness!=this.context.scene.backgroundBlurriness&&this.context.scene.backgroundBlurriness>.001?this.updateProjection():this._needsTextureUpdate&&this.context.scene.background instanceof Le&&this.updateBlurriness(this.context.scene.background,this.context.scene.backgroundBlurriness)}updateAndCreate(){var t;this.updateProjection(),(t=this._watcher)==null||t.apply()}updateProjection(){var t,i,s,o,r,l;if(!this.context.scene.background){(t=this._projection)==null||t.removeFromParent();return}const c=this.context.scene.background;if(!(c instanceof Le)){(i=this._projection)==null||i.removeFromParent();return}if(((s=this.context.xr)!=null&&s.isPassThrough||(o=this.context.xr)!=null&&o.isAR)&&this.arBlending===0){(r=this._projection)==null||r.removeFromParent();return}if(!this.gameObject||this.destroyed)return;let h=!0;const d=0,u=c!==this._lastBackground||this._height!==this._lastHeight||this._radius!==this._lastRadius;if(!this._projection||u){_u&&console.log("Create/Update Ground Projection",c.name),(l=this._projection)==null||l.removeFromParent();try{this._projection=new ba(c,this._height,this._radius,64)}catch(p){console.error("Error creating three GroundProjection",p);return}this._projection.position.y=this._height-d,this._projection.name="GroundProjection",Hm(this._projection,!1)}else h=!1;if(this._projection.parent||this.gameObject.add(this._projection),this.autoFit&&h){this._projection.updateWorldMatrix(!0,!0);const p=oi(this.context.scene.children,[this._projection]),g=p.min.y;if(g<1/0){const y=q();y.x=p.min.x+(p.max.x-p.min.x)*.5;const f=Ye(this.gameObject).x;y.y=g+this._height*f-d,y.z=p.min.z+(p.max.z-p.min.z)*.5,dt(this._projection,y)}_u&&G.DrawWireBox3(p,65280,5)}this.context.scene.backgroundBlurriness>.001&&this._needsTextureUpdate&&this.updateBlurriness(c,this.context.scene.backgroundBlurriness),this._lastBackground=c,this._lastHeight=this._height,this._lastRadius=this._radius,this._needsTextureUpdate=!1}updateBlurriness(t,i){var s;if(this._projection){if(!t)return}else return;this._needsTextureUpdate=!1,_u&&console.log("Update Blurriness",i),this._blurrynessShader??(this._blurrynessShader=new mn({name:"GroundProjectionBlurriness",uniforms:{map:{value:t},blurriness:{value:i},blending:{value:0},alphaFactor:{value:1}},vertexShader:$k,fragmentShader:Gk})),this._blurrynessShader.depthWrite=!1,this._blurrynessShader.uniforms.map.value=t,this._blurrynessShader.uniforms.blurriness.value=1,this._lastBlurriness=i,t.needsUpdate=!0;const o=this._projection.material.transparent;this._projection.material.transparent=(((s=this.context.xr)==null?void 0:s.isAR)===!0&&this.arBlending>1e-6)??!1,this._projection.material.transparent?this._blurrynessShader.uniforms.blending.value=this.arBlending:this._blurrynessShader.uniforms.blending.value=0,this.context.isInPassThrough?this._blurrynessShader.uniforms.alphaFactor.value=.95:this._blurrynessShader.uniforms.alphaFactor.value=1,o!==this._projection.material.transparent&&(this._projection.material.needsUpdate=!0),this._projection.material.map=Hi.copyTexture(t,this._blurrynessShader),this._projection.material.depthTest=!0,this._projection.material.depthWrite=!1}}Fc([m()],$n.prototype,"applyOnAwake",2),Fc([m()],$n.prototype,"autoFit",2),Fc([m()],$n.prototype,"radius",1),Fc([m()],$n.prototype,"height",1),Fc([m()],$n.prototype,"arBlending",1);const $k=`
  varying vec2 vUv;

  void main() {
    vUv = uv;
    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
  }
`,Gk=`
  uniform sampler2D map;
  uniform float blurriness;
  uniform float alphaFactor;
  uniform float blending;
  varying vec2 vUv;

  const float PI = 3.14159265359;

  // Gaussian function
  float gaussian(float x, float sigma) {
    return exp(-(x * x) / (2.0 * sigma * sigma)) / (sqrt(2.0 * PI) * sigma);
  }

  // Custom smoothstep function for desired falloff
  float customSmoothstep(float edge0, float edge1, float x) {
    float t = clamp((x - edge0) / (edge1 - edge0), 0.0, 1.0);
    return t * t * (3.0 - 2.0 * t);
  }

  void main() {
    vec2 center = vec2(0.0, 0.0);
    vec2 pos = vUv;
    pos.x = 0.0; // Only consider vertical distance
    float distance = length(pos - center);
    
    // Calculate blur amount based on custom falloff
    float blurAmount = customSmoothstep(0.5, 1.0, distance * 2.0);
    blurAmount = clamp(blurAmount, 0.0, 1.0); // Ensure blur amount is within valid range

    // Gaussian blur
    vec2 pixelSize = 1.0 / vec2(textureSize(map, 0));
    vec4 color = vec4(0.0);
    float totalWeight = 0.0;
    int blurSize = int(60.0 * min(1.0, blurriness) * blurAmount); // Adjust blur size based on distance and blurriness
    float lodLevel = log2(float(blurSize)) * 0.5; // Compute LOD level

    for (int x = -blurSize; x <= blurSize; x++) {
        for (int y = -blurSize; y <= blurSize; y++) {
            vec2 offset = vec2(float(x), float(y)) * pixelSize * blurAmount;
            float weight = gaussian(length(vec2(float(x), float(y))), 1000.0 * blurAmount); // Use a fixed sigma value
            color += textureLod(map, vUv + offset, lodLevel) * weight;
            totalWeight += weight;
        }
    }

    color = totalWeight > 0.0 ? color / totalWeight : texture2D(map, vUv);

    gl_FragColor = color;

    float brightness = dot(gl_FragColor.rgb, vec3(0.299, 0.587, 0.114));
    float stepFactor = blending - brightness * .1;
    gl_FragColor.a = pow(1.0 - blending * customSmoothstep(0.35 * stepFactor, 0.45 * stepFactor, distance), 5.);
    gl_FragColor.a *= alphaFactor;
    // gl_FragColor.rgb = vec3(1.0);

    // #include <tonemapping_fragment>
    // #include <colorspace_fragment>
    
    // Uncomment to visualize blur amount
    // gl_FragColor = vec4(blurAmount, 0.0, 0.0, 1.0);
  }
`;var qk=Object.defineProperty,Xk=Object.getOwnPropertyDescriptor,cf=(n,t,i,s)=>{for(var o=s>1?void 0:s?Xk(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&qk(t,i,o),o};class Rr extends A{constructor(){super(...arguments),a(this,"constraintActive",!0),a(this,"locked",!1),a(this,"sources",[])}}cf([m()],Rr.prototype,"constraintActive",2),cf([m()],Rr.prototype,"locked",2),cf([m(j)],Rr.prototype,"sources",2);function xw(n,t){return Ss(n,pe.ContextCreated,t),()=>ho(n,pe.ContextCreated)}function Qk(n,t){return Ss(n,pe.ContextClearing,t),()=>ho(n,pe.ContextClearing)}function Yk(n,t){return Ss(n,pe.ContextDestroying,t),()=>ho(n,pe.ContextDestroying)}function Sw(n,t){return Ss(n,Me.Start,t),()=>ho(n,Me.Start)}function Cw(n,t){return Ss(n,Me.Update,t),()=>ho(n,Me.Update)}function Zk(n,t){return Ss(n,Me.OnBeforeRender,t),()=>ho(n,Me.OnBeforeRender)}function Kk(n,t){return Ss(n,Me.OnAfterRender,t),()=>ho(n,Me.OnAfterRender)}let Tr=class{constructor(){a(this,"bb",null),a(this,"bb_pos",0)}__init(n,t){return this.bb_pos=n,this.bb=t,this}x(){return this.bb.readFloat32(this.bb_pos)}y(){return this.bb.readFloat32(this.bb_pos+4)}z(){return this.bb.readFloat32(this.bb_pos+8)}static sizeOf(){return 12}static createVec3(n,t,i,s){return n.prep(4,12),n.writeFloat32(s),n.writeFloat32(i),n.writeFloat32(t),n.offset()}};class Ow{constructor(){a(this,"bb",null),a(this,"bb_pos",0)}__init(t,i){return this.bb_pos=t,this.bb=i,this}position(t){return(t||new Tr).__init(this.bb_pos,this.bb)}rotation(t){return(t||new Tr).__init(this.bb_pos+12,this.bb)}scale(t){return(t||new Tr).__init(this.bb_pos+24,this.bb)}static sizeOf(){return 36}static createTransform(t,i,s,o,r,l,c,h,d,u){return t.prep(4,36),t.prep(4,12),t.writeFloat32(u),t.writeFloat32(d),t.writeFloat32(h),t.prep(4,12),t.writeFloat32(c),t.writeFloat32(l),t.writeFloat32(r),t.prep(4,12),t.writeFloat32(o),t.writeFloat32(s),t.writeFloat32(i),t.offset()}}class eo{constructor(){a(this,"bb",null),a(this,"bb_pos",0)}__init(t,i){return this.bb_pos=t,this.bb=i,this}static getRootAsSyncedTransformModel(t,i){return(i||new eo).__init(t.readInt32(t.position())+t.position(),t)}static getSizePrefixedRootAsSyncedTransformModel(t,i){return t.setPosition(t.position()+hv),(i||new eo).__init(t.readInt32(t.position())+t.position(),t)}guid(t){const i=this.bb.__offset(this.bb_pos,4);return i?this.bb.__string(this.bb_pos+i,t):null}fast(){const t=this.bb.__offset(this.bb_pos,6);return t?!!this.bb.readInt8(this.bb_pos+t):!1}transform(t){const i=this.bb.__offset(this.bb_pos,8);return i?(t||new Ow).__init(this.bb_pos+i,this.bb):null}dontSave(){const t=this.bb.__offset(this.bb_pos,10);return t?!!this.bb.readInt8(this.bb_pos+t):!1}static startSyncedTransformModel(t){t.startObject(4)}static addGuid(t,i){t.addFieldOffset(0,i,0)}static addFast(t,i){t.addFieldInt8(1,+i,0)}static addTransform(t,i){t.addFieldStruct(2,i,0)}static addDontSave(t,i){t.addFieldInt8(3,+i,0)}static endSyncedTransformModel(t){return t.endObject()}static finishSyncedTransformModelBuffer(t,i){t.finish(i)}static finishSizePrefixedSyncedTransformModelBuffer(t,i){t.finish(i,void 0,!0)}}var I;(n=>{(t=>{t.MAYBEMODULE=null;const i=[];function s(){return t.MODULE?Promise.resolve(t.MODULE):new Promise(r=>{i.push(r)})}t.ready=s;async function o(){if(t.MODULE)return t.MODULE;const r=await import("./rapier.min.js");return t.MODULE=r,t.MAYBEMODULE=r,i.forEach(l=>l(r)),i.length=0,r}t.load=o})(n.RAPIER_PHYSICS||(n.RAPIER_PHYSICS={})),(t=>{t.MAYBEMODULE=null;const i=[];function s(){return t.MODULE?Promise.resolve(t.MODULE):new Promise(r=>{i.push(r)})}t.ready=s;async function o(){if(t.MODULE)return t.MODULE;const r=await import("./postprocessing.min.js").then(l=>l.index);return t.MODULE=r,t.MAYBEMODULE=r,i.forEach(l=>l(r)),i.length=0,r}t.load=o})(n.POSTPROCESSING||(n.POSTPROCESSING={})),(t=>{t.MAYBEMODULE=null;const i=[];function s(){return t.MODULE?Promise.resolve(t.MODULE):new Promise(r=>{i.push(r)})}t.ready=s;async function o(){if(t.MODULE)return t.MODULE;const r=await import("./postprocessing.min.js").then(l=>l.N8AO);return t.MODULE=r,t.MAYBEMODULE=r,i.forEach(l=>l(r)),i.length=0,r}t.load=o})(n.POSTPROCESSING_AO||(n.POSTPROCESSING_AO={}))})(I||(I={}));var wt=(n=>(n[n.Average=0]="Average",n[n.Multiply=1]="Multiply",n[n.Minimum=2]="Minimum",n[n.Maximum=3]="Maximum",n))(wt||{}),wu=(n=>(n[n.Discrete=0]="Discrete",n[n.Continuous=1]="Continuous",n))(wu||{}),nt=(n=>(n[n.None=0]="None",n[n.FreezePositionX=2]="FreezePositionX",n[n.FreezePositionY=4]="FreezePositionY",n[n.FreezePositionZ=8]="FreezePositionZ",n[n.FreezePosition=14]="FreezePosition",n[n.FreezeRotationX=16]="FreezeRotationX",n[n.FreezeRotationY=32]="FreezeRotationY",n[n.FreezeRotationZ=64]="FreezeRotationZ",n[n.FreezeRotation=112]="FreezeRotation",n[n.FreezeAll=126]="FreezeAll",n))(nt||{}),Wa=(n=>(n[n.None=0]="None",n[n.X=2]="X",n[n.Y=4]="Y",n[n.Z=8]="Z",n[n.All=-1]="All",n))(Wa||{});const Mt=function(n,t){return function(i,s,o){Jk(i,s,o,n,t)}};function Jk(n,t,i,s,o){if(!o&&!s&&!n.onValidate)return;if(i!==void 0){console.error("Invalid usage of validate decorator. Only fields can be validated.",n,t,i),De("Invalid usage of validate decorator. Only fields can be validated. Property: "+t,Pi.Error);return}let r="";if(typeof t=="string"?r=t:r=t.name,n.__internalAwake){const l=Symbol(r),c=n.__internalAwake;n.__internalAwake=function(){var h;if(!this.onValidate){F()&&console.warn('Usage of @validate decorate detected but there is no onValidate method in your class: "'+((h=n.constructor)==null?void 0:h.name)+'"');return}if(this[l]===void 0){this[l]=this[r];const d=this[r];if(d instanceof re||d instanceof x||d instanceof fe||d instanceof V){const u=this[r];gd(u,()=>{this.onValidate(r)})}Object.defineProperty(this,r,{set:function(u){var p;if(this[zg]===!0)this[l]=u;else{s?.call(this,u);const g=this[l];this[l]=u,(p=this.onValidate)==null||p.call(this,r,g)}},get:function(){return o?.call(this),this[l]}})}c.call(this)}}}const eM=function(n){return function(t,i,s){let o="";typeof i=="string"?o=i:o=i.name;const r=n.prototype,l=Object.getOwnPropertyDescriptor(r,o);if(!(l!=null&&l.value)){console.warn("Can not apply prefix: type does not have method named",i,n);return}const c=l.value,h=t[o];Object.defineProperty(r,o,{value:function(...d){const u=h?.call(this,...d);if(u instanceof Promise){u.then(p=>{if(p!==!1)return c.call(this,...d)});return}if(u!==!1)return c.call(this,...d)}})}};var tM=Object.defineProperty,iM=Object.getOwnPropertyDescriptor,Ei=(n,t,i,s)=>{for(var o=s>1?void 0:s?iM(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&tM(t,i,o),o};class nM{constructor(t,i){a(this,"positionChanged",!1),a(this,"rotationChanged",!1),a(this,"position"),a(this,"quaternion"),a(this,"_positionKeys",["x","y","z"]),a(this,"_quaternionKeys",["_x","_y","_z","_w"]),a(this,"mute",!1),a(this,"context"),a(this,"obj"),a(this,"_positionWatch"),a(this,"_rotationWatch"),this.context=i,this.obj=t}get isDirty(){return this.positionChanged||this.rotationChanged}reset(t=!1){if(this.positionChanged=!1,this.rotationChanged=!1,this.mute=!1,t){if(this.position)for(const i of this._positionKeys)delete this.position[i];if(this.quaternion)for(const i of this._quaternionKeys)delete this.quaternion[i]}}syncValues(){for(const t of this._positionKeys)this.position[t]=this.obj.position[t];for(const t of this._quaternionKeys)this.quaternion[t]=this.obj.quaternion[t]}applyValues(){if(this.positionChanged&&this.position)for(const t of this._positionKeys){const i=this.position[t];i!==void 0&&(this.obj.position[t]=i)}if(this.rotationChanged&&this.quaternion)for(const t of this._quaternionKeys){const i=this.quaternion[t];i!==void 0&&(this.obj.quaternion[t]=i)}}start(t,i){this.reset(),t&&(this._positionWatch||(this._positionWatch=new Js(this.obj.position,["x","y","z"])),this._positionWatch.apply(),this.position={},this._positionWatch.subscribeWrite((r,l)=>{var c;if((c=this.context.physics.engine)!=null&&c.isUpdating||this.mute)return;const h=this.position[l];Math.abs(h-r)<1e-5||(this.position[l]=r,this.positionChanged=!0)})),i&&(this._rotationWatch||(this._rotationWatch=new Js(this.obj.quaternion,["_x","_y","_z","_w"])),this._rotationWatch.apply(),this.quaternion={},this._rotationWatch.subscribeWrite((r,l)=>{var c;if((c=this.context.physics.engine)!=null&&c.isUpdating||this.mute)return;const h=this.quaternion[l];Math.abs(h-r)<1e-5||(this.quaternion[l]=r,this.rotationChanged=!0)}));const s=this.obj.matrixWorld.multiplyMatrices.bind(this.obj.matrixWorld),o=new se;this.obj.matrixWorld.multiplyMatrices=(r,l)=>{var c;return(c=this.context.physics.engine)!=null&&c.isUpdating||this.mute||o.equals(r)||(this.positionChanged=!0,this.rotationChanged=!0,o.copy(r)),s(r,l)}}stop(){var t,i;(t=this._positionWatch)==null||t.revoke(),(i=this._rotationWatch)==null||i.revoke()}}var hf;const xu=(hf=class extends A{constructor(){super(...arguments),a(this,"autoMass",!0),a(this,"_mass",0),a(this,"useGravity",!0),a(this,"centerOfMass",new x(0,0,0)),a(this,"constraints",nt.None),a(this,"isKinematic",!1),a(this,"drag",0),a(this,"angularDrag",1),a(this,"detectCollisions",!0),a(this,"sleepThreshold",.01),a(this,"collisionDetectionMode",wu.Discrete),a(this,"_gravityScale",1),a(this,"dominanceGroup",0),a(this,"_propertiesChanged",!1),a(this,"_currentVelocity",new x),a(this,"_smoothedVelocity",new x),a(this,"_smoothedVelocityGetter",new x),a(this,"_lastPosition",new x),a(this,"_watch")}get isRigidbody(){return!0}set mass(n){n!==this._mass&&(this._mass=n,this._propertiesChanged=!0,this.__didAwake&&(this.autoMass=!1))}get mass(){var n,t;return this.autoMass?((t=(n=this.context.physics.engine)==null?void 0:n.getBody(this))==null?void 0:t.mass())??-1:this._mass}get lockPositionX(){return(this.constraints&nt.FreezePositionX)!==0}get lockPositionY(){return(this.constraints&nt.FreezePositionY)!==0}get lockPositionZ(){return(this.constraints&nt.FreezePositionZ)!==0}get lockRotationX(){return(this.constraints&nt.FreezeRotationX)!==0}get lockRotationY(){return(this.constraints&nt.FreezeRotationY)!==0}get lockRotationZ(){return(this.constraints&nt.FreezeRotationZ)!==0}set lockPositionX(n){n?this.constraints|=nt.FreezePositionX:this.constraints&=~nt.FreezePositionX}set lockPositionY(n){n?this.constraints|=nt.FreezePositionY:this.constraints&=~nt.FreezePositionY}set lockPositionZ(n){n?this.constraints|=nt.FreezePositionZ:this.constraints&=~nt.FreezePositionZ}set lockRotationX(n){n?this.constraints|=nt.FreezeRotationX:this.constraints&=~nt.FreezeRotationX}set lockRotationY(n){n?this.constraints|=nt.FreezeRotationY:this.constraints&=~nt.FreezeRotationY}set lockRotationZ(n){n?this.constraints|=nt.FreezeRotationZ:this.constraints&=~nt.FreezeRotationZ}set gravityScale(n){this._gravityScale=n}get gravityScale(){return this._gravityScale}awake(){this._watch=void 0,this._propertiesChanged=!1}onEnable(){this._watch||(this._watch=new nM(this.gameObject,this.context)),this._watch.start(!0,!0),this.startCoroutine(this.beforePhysics(),Me.LateUpdate),F()&&(globalThis.true?I.RAPIER_PHYSICS.ready().then(async()=>{var n;await Kl(3),(n=this.context.physics.engine)!=null&&n.getBody(this)||console.warn(`Rigidbody could not be created. Ensure "${this.name}" has a Collider component.`)}):console.warn("Rigidbody could not be created: Rapier physics are explicitly disabled."))}onDisable(){var n,t;(n=this._watch)==null||n.stop(),(t=this.context.physics.engine)==null||t.removeBody(this)}onDestroy(){var n;(n=this.context.physics.engine)==null||n.removeBody(this)}onValidate(){this._propertiesChanged=!0}*beforePhysics(){for(var n,t,i,s;;)this._propertiesChanged&&(this._propertiesChanged=!1,(n=this.context.physics.engine)==null||n.updateProperties(this)),(t=this._watch)!=null&&t.isDirty?(this._watch.mute=!0,this._watch.applyValues(),(i=this.context.physics.engine)==null||i.updateBody(this,this._watch.positionChanged,this._watch.rotationChanged),this._watch.reset()):(s=this._watch)==null||s.syncValues(),this.captureVelocity(),yield}teleport(n,t=!0){var i;(i=this._watch)==null||i.reset(!0),t?this.gameObject.position.set(n.x,n.y,n.z):this.setWorldPosition(n.x,n.y,n.z),this.resetForcesAndTorques(),this.resetVelocities()}resetForces(n=!0){var t;(t=this.context.physics.engine)==null||t.resetForces(this,n)}resetTorques(n=!0){var t;(t=this.context.physics.engine)==null||t.resetTorques(this,n)}resetVelocities(){this.setVelocity(0,0,0),this.setAngularVelocity(0,0,0)}resetForcesAndTorques(){this.resetForces(),this.resetTorques()}wakeUp(){var n;(n=this.context.physics.engine)==null||n.wakeup(this)}get isSleeping(){var n;return(n=this.context.physics.engine)==null?void 0:n.isSleeping(this)}updateProperties(){var n;return this._propertiesChanged=!1,(n=this.context.physics.engine)==null?void 0:n.updateProperties(this)}applyForce(n,t,i=!0){var s;this._propertiesChanged&&this.updateProperties(),(s=this.context.physics.engine)==null||s.addForce(this,n,i)}applyImpulse(n,t=!0){var i;this._propertiesChanged&&this.updateProperties(),(i=this.context.physics.engine)==null||i.applyImpulse(this,n,t)}setForce(n,t,i,s=!0){var o,r,l;(o=this.context.physics.engine)==null||o.resetForces(this,s),typeof n=="number"?(t??(t=0),i??(i=0),(r=this.context.physics.engine)==null||r.addForce(this,{x:n,y:t,z:i},s)):(l=this.context.physics.engine)==null||l.addForce(this,n,s)}getVelocity(){var n;const t=(n=this.context.physics.engine)==null?void 0:n.getLinearVelocity(this);return t?(this._currentVelocity.x=t.x,this._currentVelocity.y=t.y,this._currentVelocity.z=t.z,this._currentVelocity):this._currentVelocity.set(0,0,0)}setVelocity(n,t,i,s=!0){var o,r;if(n instanceof x){const l=n;(o=this.context.physics.engine)==null||o.setLinearVelocity(this,l,s);return}t===void 0||i===void 0||(r=this.context.physics.engine)==null||r.setLinearVelocity(this,{x:n,y:t,z:i},s)}getAngularVelocity(){var n;const t=(n=this.context.physics.engine)==null?void 0:n.getAngularVelocity(this);return t?(this._currentVelocity.x=t.x,this._currentVelocity.y=t.y,this._currentVelocity.z=t.z,this._currentVelocity):this._currentVelocity.set(0,0,0)}setAngularVelocity(n,t,i,s=!0){var o,r;if(typeof n=="object"){const l=n;(o=this.context.physics.engine)==null||o.setAngularVelocity(this,l,s);return}if(t===void 0||i===void 0||typeof t=="boolean"){console.warn("setAngularVelocity expects either a Vec3 or 3 numbers");return}(r=this.context.physics.engine)==null||r.setAngularVelocity(this,{x:n,y:t,z:i},s)}setTorque(n,t,i){typeof n=="number"?this.setAngularVelocity(n,t,i):this.setAngularVelocity(n)}get smoothedVelocity(){return this._smoothedVelocityGetter.copy(this._smoothedVelocity),this._smoothedVelocityGetter.multiplyScalar(1/this.context.time.deltaTime)}setBodyFromGameObject(n=null){}captureVelocity(){const n=this.gameObject.matrixWorld;xu.tempPosition.setFromMatrixPosition(n);const t=xu.tempPosition.sub(this._lastPosition);this._lastPosition.copy(xu.tempPosition),this._smoothedVelocity.lerp(t,this.context.time.deltaTime/.1)}},a(hf,"tempPosition",new x),hf);let ye=xu;Ei([Mt()],ye.prototype,"autoMass",2),Ei([m()],ye.prototype,"mass",1),Ei([Mt(),m()],ye.prototype,"useGravity",2),Ei([m(x)],ye.prototype,"centerOfMass",2),Ei([Mt(),m()],ye.prototype,"constraints",2),Ei([Mt(),m()],ye.prototype,"isKinematic",2),Ei([Mt(),m()],ye.prototype,"drag",2),Ei([Mt(),m()],ye.prototype,"angularDrag",2),Ei([Mt(),m()],ye.prototype,"detectCollisions",2),Ei([Mt(),m()],ye.prototype,"sleepThreshold",2),Ei([Mt(),m()],ye.prototype,"collisionDetectionMode",2),Ei([Mt()],ye.prototype,"_gravityScale",2),Ei([Mt()],ye.prototype,"dominanceGroup",2),new x,new x;const wo=C("debugsync"),zc="STRS";ng(zc,eo.getRootAsSyncedTransformModel);const Gn=new vm;function Pw(n,t,i=!0){Gn.clear();const s=Gn.createString(n);eo.startSyncedTransformModel(Gn),eo.addGuid(Gn,s),eo.addFast(Gn,i);const o=t.worldPosition,r=t.worldEuler,l=t.gameObject.scale;eo.addTransform(Gn,Ow.createTransform(Gn,o.x,o.y,o.z,r.x,r.y,r.z,l.x,l.y,l.z));const c=eo.endSyncedTransformModel(Gn);return Gn.finish(c,zc),Gn.asUint8Array()}let df=0,Uc=0;Cw(n=>{var t;const i=(t=n.connection.currentServerUrl)!=null&&t.includes("glitch")?10:40;Uc=Math.floor(df/i),df=0,wo&&Uc>0&&console.log("Sync Transform Fast Interval",Uc)});class qn extends A{constructor(){super(...arguments),a(this,"overridePhysics",!0),a(this,"interpolatePosition",!0),a(this,"interpolateRotation",!0),a(this,"fastMode",!1),a(this,"syncDestroy",!1),a(this,"_model",null),a(this,"_needsUpdate",!0),a(this,"rb",null),a(this,"_wasKinematic",!1),a(this,"_receivedDataBefore",!1),a(this,"_targetPosition"),a(this,"_targetRotation"),a(this,"_receivedFastUpdate",!1),a(this,"_shouldRequestOwnership",!1),a(this,"joinedRoomCallback",null),a(this,"receivedDataCallback",null),a(this,"tempEuler",new Bt),a(this,"receivedUpdate",!1),a(this,"lastPosition"),a(this,"lastRotation"),a(this,"lastScale")}requestOwnership(){wo&&console.log("Request ownership"),this._model?this._model.requestOwnership():(this._shouldRequestOwnership=!0,this._needsUpdate=!0)}hasOwnership(){var t;return((t=this._model)==null?void 0:t.hasOwnership)??void 0}isOwned(){var t;return(t=this._model)==null?void 0:t.isOwned}awake(){wo&&console.log("new instance",this.guid,this),this._receivedDataBefore=!1,this._targetPosition=new x,this._targetRotation=new V,this.lastPosition=new x,this.lastRotation=new V,this.lastScale=new x,this.rb=O.getComponentInChildren(this.gameObject,ye),this.rb&&(this._wasKinematic=this.rb.isKinematic),this.receivedUpdate=!0,this._model=new rg(this.context.connection,this.guid),this.context.connection.isConnected&&this.tryGetLastState(),this.joinedRoomCallback=this.tryGetLastState.bind(this),this.context.connection.beginListen(ne.JoinedRoom,this.joinedRoomCallback),this.receivedDataCallback=this.onReceivedData.bind(this),this.context.connection.beginListenBinary(zc,this.receivedDataCallback)}onDestroy(){this.syncDestroy&&Tg(this.guid,this.context.connection),this._model=null,this.context.connection.stopListen(ne.JoinedRoom,this.joinedRoomCallback),this.context.connection.stopListenBinary(zc,this.receivedDataCallback)}tryGetLastState(){const t=this.context.connection.tryGetState(this.guid);t&&this.onReceivedData(t)}onReceivedData(t){var i;if(!this.destroyed&&typeof t.guid=="function"&&t.guid()===this.guid){wo&&console.log("new data",this.context.connection.connectionId,this.context.time.frameCount,this.guid,t),this.receivedUpdate=!0,this._receivedFastUpdate=t.fast();const s=t.transform();if(s){an.markDirty(this.gameObject,!0);const o=s.position();o&&(this.interpolatePosition&&((i=this._targetPosition)==null||i.set(o.x(),o.y(),o.z())),(!this.interpolatePosition||!this._receivedDataBefore)&&this.setWorldPosition(o.x(),o.y(),o.z()));const r=s.rotation();r&&(this.tempEuler.set(r.x(),r.y(),r.z()),this.interpolateRotation&&this._targetRotation.setFromEuler(this.tempEuler),(!this.interpolateRotation||!this._receivedDataBefore)&&Wm(this.gameObject,this.tempEuler));const l=s.scale();l&&this.gameObject.scale.set(l.x(),l.y(),l.z())}this._receivedDataBefore=!0}}onEnable(){this.lastPosition.copy(this.worldPosition),this.lastRotation.copy(this.worldQuaternion),this.lastScale.copy(this.gameObject.scale),this._needsUpdate=!0,this._model&&this._model.updateIsOwned()}onDisable(){this._model&&this._model.freeOwnership()}onBeforeRender(){if(!this.activeAndEnabled||!this.context.connection.isConnected)return;if(!this.context.connection.isInRoom||!this._model){wo&&console.log("no model or room",this.name,this.guid,this.context.connection.isInRoom);return}this._shouldRequestOwnership&&(this._shouldRequestOwnership=!1,this._model.requestOwnership());const t=this.worldPosition,i=this.worldQuaternion,s=this.gameObject.scale;if(this._model.isOwned&&!this.receivedUpdate){const l=this._model.hasOwnership||this.fastMode?1e-4:.001;(t.distanceTo(this.lastPosition)>l||i.angleTo(this.lastRotation)>l||s.distanceTo(this.lastScale)>l)&&(this._model.hasOwnership?this._needsUpdate=!0:(wo&&console.log(this.guid,"reset because not owned but",this.gameObject.name,this.lastPosition),this.worldPosition=this.lastPosition,t.copy(this.lastPosition),this.worldQuaternion=this.lastRotation,i.copy(this.lastRotation),this.gameObject.scale.copy(this.lastScale),an.markDirty(this.gameObject,!0),this._needsUpdate=!1))}if(this._model&&!this._model.hasOwnership&&this._model.isOwned&&this._receivedDataBefore){const l=this._receivedFastUpdate||this.fastMode?.5:.3;let c=!1;if(this.interpolatePosition&&this._targetPosition){const h=this.worldPosition;h.lerp(this._targetPosition,l),this.worldPosition=h,c=!0}if(this.interpolateRotation&&this._targetRotation){const h=this.worldQuaternion;h.slerp(this._targetRotation,l),this.worldQuaternion=h,c=!0}c&&an.markDirty(this.gameObject,!0)}if(this.receivedUpdate=!1,this.lastPosition.copy(t),this.lastRotation.copy(i),this.lastScale.copy(s),!this._model||!this._model||this._model.hasOwnership===void 0||!this._model.hasOwnership)return;this.rb&&this.overridePhysics&&this._wasKinematic!==void 0&&(wo&&console.log("reset kinematic",this.rb.name,this._wasKinematic),this.rb.isKinematic=this._wasKinematic);const o=10,r=this.rb||this.fastMode;if(this._needsUpdate&&(this.context.time.frameCount%o===0||r)){if(df++,r&&Uc>0&&this.context.time.frameCount%Uc!==0)return;wo&&console.log("send update",this.context.connection.connectionId,this.guid,this.gameObject.name,this.gameObject.guid),this._needsUpdate=!1;const l=Pw(this.guid,this,!!r);this.context.connection.sendBinary(l)}}}const sM=C("debugshadowcomponents");pv.prototype.interactable={get(){return this.interactive},set(n){this.interactable=n}};const Zi=Symbol("shadowDomOwner");class rn extends A{constructor(){super(...arguments),a(this,"_shadowComponent",null),a(this,"_controlsChildLayout",!0),a(this,"_root"),a(this,"_parentComponent")}isRoot(){var t;return((t=this.Root)==null?void 0:t.gameObject)===this.gameObject}get canvas(){const t=this.Root;return t!=null&&t.isCanvas?t:null}get Canvas(){return this.canvas}markDirty(){si.markUIDirty(this.context)}get shadowComponent(){return this._shadowComponent}set shadowComponent(t){this._shadowComponent=t}get controlsChildLayout(){return this._controlsChildLayout}set controlsChildLayout(t){this._controlsChildLayout=t,this.shadowComponent&&(this.shadowComponent.autoLayout=t)}get Root(){return this._root===void 0&&(this._root=O.getComponentInParent(this.gameObject,Nc)),this._root}__internalNewInstanceCreated(t){return super.__internalNewInstanceCreated(t),this.shadowComponent=null,this._root=void 0,this._parentComponent=void 0,this}onEnable(){super.onEnable()}addShadowComponent(t,i){var s;if(!t)return;this.removeShadowComponent();const o=this.isRoot()?this.gameObject:this.gameObject.parent;if(this._parentComponent=O.getComponentInParent(o,rn),!this._parentComponent){console.warn(`Component "${this.name}" doesn't have a UI parent anywhere. Do you have an UI element outside a Canvas? UI components must be a child of a Canvas component`,this);return}t.name=this.name+" ("+(this.constructor.name??"UI")+")",t.autoLayout=this._parentComponent.controlsChildLayout,t[Zi]=this,this.setShadowComponentOwner(t);let r=!1;if(((s=this.Root)==null?void 0:s.gameObject)===this.gameObject)this.gameObject.add(t);else{const l=this._parentComponent.shadowComponent;l&&(l?.add(t),r=!0)}this.shadowComponent=t,i&&i.shadowComponent&&this.shadowComponent&&i.shadowComponent.add(this.shadowComponent),xc&&t.add(new Si(.5)),this.onAfterAddedToScene(),r&&uO(),sM&&console.warn("Added shadow component",this.shadowComponent)}setShadowComponentOwner(t){if(t&&(t[Zi]===void 0||t[Zi]===this)&&(t[Zi]=this,t.children))for(const i of t.children)this.setShadowComponentOwner(i)}traverseOwnedShadowComponents(t,i,s){if(t&&t[Zi]===i){s(t);for(const o of t.children)this.traverseOwnedShadowComponents(o,i,s)}}removeShadowComponent(){this.shadowComponent&&this.shadowComponent.removeFromParent()}onAfterAddedToScene(){}setInteractable(t){this.shadowComponent&&(this.shadowComponent.interactable=t)}}class Nc extends rn{awake(){super.awake()}}class td{constructor(t,i){a(this,"event"),a(this,"button"),a(this,"buttonName"),a(this,"_used",!1),a(this,"_propagationStopped",!1),a(this,"z__pointer_ctured",!1),a(this,"z__pointer_cture_rleased",!1),a(this,"inputSource"),a(this,"object"),a(this,"point"),a(this,"normal"),a(this,"face"),a(this,"distance"),a(this,"instanceId"),a(this,"intersection"),a(this,"isDown"),a(this,"isUp"),a(this,"isPressed"),a(this,"isClick"),a(this,"isDoubleClick"),a(this,"input"),this.event=i,this.input=t,this.button=i.button}get deviceIndex(){return this.event.deviceIndex}get pointerId(){return this.event.pointerId}get pressure(){return this.event.pressure}get used(){return this._used}use(){this._used||(this._used=!0,this.event.use())}get propagationStopped(){return this._propagationStopped}stopPropagation(){this._propagationStopped=!0,this.event.stopImmediatePropagation()}stopImmediatePropagation(){this._propagationStopped=!0,this.event.stopImmediatePropagation()}setPointerCapture(){this.z__pointer_ctured=!0}releasePointerCapture(){this.z__pointer_cture_rleased=!0}get mode(){return this.event.mode}clone(){const t=new td(this.input,this.event);return Object.assign(t,this),t}Use(){this.use()}StopPropagation(){this.event.stopImmediatePropagation()}}function Su(n,t){return O.foreachComponent(n,i=>{if(!i.enabled)return;const s=i;if(t)switch(t){case"pointerdown":if(s.onPointerDown)return!0;break;case"pointerup":if(s.onPointerUp||s.onPointerClick)return!0;break;case"pointermove":if(s.onPointerEnter||s.onPointerExit||s.onPointerMove)return!0;break}else if(s.onPointerDown||s.onPointerUp||s.onPointerEnter||s.onPointerExit||s.onPointerClick)return!0},!1)===!0}const Ms=new Array;class Rs{constructor(t,i,s,o){a(this,"enabled",!0),a(this,"target"),a(this,"methodName"),a(this,"arguments"),this.target=t,this.methodName=i||null,this.arguments=s,o!=null&&(this.enabled=o)}get canClone(){return this.target instanceof Object}invoke(...t){if(this.enabled!==!1){if(typeof this.target=="function")this.arguments?(Ms.length=0,t!==void 0&&t.length>0&&Ms.push(...t),Ms.push(...this.arguments),this.target(...this.arguments),Ms.length=0):this.target(...t);else if(this.methodName!=null){const i=this.target[this.methodName];typeof i=="function"?this.arguments?(Ms.length=0,t!==void 0&&t.length>0&&Ms.push(...t),Ms.push(...this.arguments),i.call(this.target,...Ms),Ms.length=0):i.call(this.target,...t):this.arguments?this.target[this.methodName]=this.arguments[0]||t[0]:this.target[this.methodName]=t[0]}}}}const oM=n=>/^[A-Z]*$/.test(n);class Cu extends Event{constructor(){super(...arguments),a(this,"args")}}class Se{constructor(t){if(a(this,"isEventList",!0),a(this,"target"),a(this,"key"),a(this,"_isInvoking",!1),a(this,"methods",[]),a(this,"_methodsCopy",[]),this.methods=[],Array.isArray(t))for(const i of t)i instanceof Rs?this.methods.push(i):typeof i=="function"&&this.methods.push(new Rs(i));else typeof t=="function"&&this.methods.push(new Rs(t))}__internalOnInstantiate(t){var i;const s=new Array;for(let o=0;o<this.methods.length;o++){const r=this.methods[o];if(!(r.target instanceof Function)){const l=r.target;let c=l?.uuid;if(l&&(c=l.guid),c){const h=t[c];if(h){const d=(i=r.arguments)==null?void 0:i.map(u=>u instanceof Object&&u.uuid?t[u.uuid]:u!=null&&u.isComponent?t[u.guid]:u);s.push(new Rs(h.clone,r.methodName,d,r.enabled))}else F()&&console.warn("Could not find target for event listener")}}}return new Se(s)}setEventTarget(t,i){if(this.key=t,this.target=i,this.key!==void 0){let s="",o=!1;for(const r of this.key)o&&oM(r)&&(s+="-"),o=!0,s+=r.toLowerCase();this.key=s}}get listenerCount(){var t;return((t=this.methods)==null?void 0:t.length)??0}get isInvoking(){return this._isInvoking}static from(...t){return new Se(t)}invoke(...t){var i;if(this._isInvoking)return console.warn("Circular event invocation detected. Please check your event listeners for circular references.",this),!1;if(((i=this.methods)==null?void 0:i.length)<=0)return!1;this._isInvoking=!0;try{this._methodsCopy.length=0,this._methodsCopy.push(...this.methods);for(const s of this._methodsCopy)s.invoke(...t);if(typeof this.target=="object"&&typeof this.key=="string"){const s=this.target.dispatchEvent;if(typeof s=="function"){const o=new Cu(this.key);o.args=t,s.call(this.target,o)}}}finally{this._isInvoking=!1,this._methodsCopy.length=0}return!0}addEventListener(t){return this.methods.push(new Rs(t)),t}removeEventListener(t){if(t)for(let i=this.methods.length-1;i>=0;i--)this.methods[i].target===t&&(this.methods[i].enabled=!1,this.methods.splice(i,1))}removeAllEventListeners(){this.methods.length=0}}class rM extends Xi{constructor(){super([ae,xe],"ColorSerializer")}onDeserialize(t){if(t!=null)return t.a!==void 0?new xe(t.r,t.g,t.b,t.a):t.alpha!==void 0?new xe(t.r,t.g,t.b,t.alpha):new ae(t.r,t.g,t.b)}onSerialize(t){if(t!=null)return t.a!==void 0?{r:t.r,g:t.g,b:t.b,a:t.a}:{r:t.r,g:t.g,b:t.b}}}const aM=new rM;class lM extends Xi{constructor(){super([Bt],"EulerSerializer")}onDeserialize(t,i){if(t!=null){if(t.order)return new Bt(t.x,t.y,t.z,t.order);if(t.x!=null)return new Bt(t.x,t.y,t.z)}}onSerialize(t,i){return{x:t.x,y:t.y,z:t.z,order:t.order}}}const cM=new lM;class hM extends Xi{constructor(){super(j,"ObjectSerializer")}onSerialize(t,i){if(i.objectToNode!==void 0&&t.uuid){const s=i.objectToNode[t.uuid];return bt&&console.log(s,t.name,t.uuid),{node:s}}}onDeserialize(t,i){var s,o,r;if(typeof t=="string"){if(t.endsWith(".glb")||t.endsWith(".gltf")){if(i.serializable instanceof Array&&i.serializable.includes(le))return;F()&&we("Detected wrong usage of @serializable with Object3D or GameObject. Instead you should use AssetReference here! Please see the console for details.");const l=(o=(s=i.target)==null?void 0:s.constructor)==null?void 0:o.name;console.warn(`Wrong usage of @serializable detected in your script "${l}"

It looks like you used @serializable(Object3D) or @serializable(GameObject) for a prefab or scene reference which is exported to a separate glTF file.

To fix this please change your code to:

@serializable(AssetReference)
${i.path}! : AssetReference;
\0`)}return}if(t){if(t.node!==void 0&&i.nodeToObject){const l=i.nodeToObject[t.node];return bt&&console.log("Deserialized object reference?",t,l,i?.nodeToObject),l||console.warn("Did not find node: "+t.node,i.nodeToObject,i.object),l}else if(t.guid){if(!i.context){console.error("Missing context");return}let l;const c=(r=i.gltf)==null?void 0:r.scene;return c&&(l=O.findByGuid(t.guid,c)),l||(l=O.findByGuid(t.guid,i.context.scene)),l?(l&&l.isComponent===!0&&(bt&&console.warn("Deserialized object reference is a component"),l=l.gameObject),bt&&console.log("Deserialized object reference?",t,l,i?.nodeToObject)):((F()||bt)&&console.warn("Could not resolve object reference",i.path,t,i.target,i.context.scene),t.could_not_resolve=!0),l}}}}const kw=new hM;class dM extends Xi{constructor(){super([A,A],"ComponentSerializer")}onSerialize(t,i){if(t!=null&&t.guid)return{guid:t.guid}}onDeserialize(t,i){var s;if(t!=null&&t.guid){if(t.___persistentAsset){bt&&console.log("Skipping component deserialization because it's a persistent asset",t);return}const o=i.path;bt&&console.log(t.guid,i.root,i.object,i.target);let r=this.findObjectForGuid(t.guid,i.root);if(r||i.context&&(r=this.findObjectForGuid(t.guid,(s=i.context)==null?void 0:s.scene),r))return r;(F()||bt)&&console.warn('Could not resolve component reference: "'+o+'" using guid '+t.guid,i.target),t.could_not_resolve=!0;return}}findObjectForGuid(t,i){if(i.guid===t)return i;const s=O.foreachComponent(i,o=>{if(o.guid===t)return o},!1);if(s!==void 0)return s;for(let o=0;o<i.children.length;o++){const r=i.children[o],l=this.findObjectForGuid(t,r);if(l)return l}}}const Ou=new dM;class uM extends Xi{constructor(){super([Se])}onSerialize(t,i){console.log("TODO: SERIALIZE EVENT")}onDeserialize(t,i){var s,o,r;if(typeof t=="function")return new Se([new Rs(t,null,[],!0)]);if(t&&t.type==="EventList"){bt&&console.log("DESERIALIZE EVENT",t);const l=new Array;if(t.calls&&Array.isArray(t.calls))for(const d of t.calls){let u=function(y){if(typeof y=="object"){let f=kw.onDeserialize(y,i);if(f||(f=Ou.onDeserialize(y,i)),f)return f}return y};bt&&console.log(d);let p=Ou.findObjectForGuid(d.target,i.root);!p&&(s=i.context)!=null&&s.scene&&(p=Ou.findObjectForGuid(d.target,(o=i.context)==null?void 0:o.scene));const g=((r=d.method)==null?void 0:r.length)>0;if(p&&g){const y=()=>{const f=d.method[0].toUpperCase()+d.method.slice(1);if(typeof p[f]=="function"){console.warn(`EventList method:
Could not find method ${d.method} on object ${p.name}. Please rename ${d.method} to ${f}?
`,p[f],`
 in script: `,p),we("EventList methods must start with lowercase letter, see console for details");return}else console.warn(`EventList method:
Could not find method ${d.method} on object ${p.name}`,p,typeof p[d.method])};if(typeof p[d.method]!="function"){let f=!1,v=p;for(;v;){const b=Object.getOwnPropertyDescriptor(v,d.method);if(b&&(b.writable===!0||b.set)){f=!0;break}v=Object.getPrototypeOf(v)}!f&&(F()||bt)&&y()}}if(p){let y=d.argument;if(y!==void 0?y=u(y):d.arguments!==void 0&&(y=d.arguments.map(u)),!p[d.method])console.warn(`EventList method not found: "${d.method}" on ${p?.name}`);else{y!==void 0&&!Array.isArray(y)&&(y=[y]);const f=new Rs(p,d.method,y,d.enabled);l.push(f)}}else F()&&console.warn("[Debug] EventList: Could not find event listener in scene",d,i.object,t)}const c=new Se(l);bt&&console.log(c);const h=i.target;return h!==void 0&&i.path!==void 0&&c.setEventTarget(i.path,h),c}}}const pM=new uM,Pu=new WeakMap,mM=Le.prototype.clone;Le.prototype.clone=function(){const n=mM.call(this);return Pu.has(n)||Pu.set(n,this),n};class Mw extends Xi{constructor(){super([Na,vs])}onSerialize(t,i){}onDeserialize(t,i){if(t instanceof Le&&i.type===Na){let s=t;Pu.has(s)&&(s=Pu.get(s)),s.isRenderTargetTexture=!0,s.flipY=!0,s.offset.y=1,s.repeat.y=-1,s.needsUpdate=!0,s.mipmaps=[],s instanceof AS&&(s.isCompressedTexture=!1,s.format=ad);const o=new Na(s.image.width,s.image.height,{colorSpace:rr});return o.texture=s,o}}}new Mw;class Rw extends Xi{constructor(){super([URL])}onSerialize(t,i){return null}onDeserialize(t,i){if(typeof t=="string"&&t.length>0)return ao(i.gltfId,t)}}new Rw;var gM=Object.defineProperty,fM=Object.getOwnPropertyDescriptor,yM=(n,t,i,s)=>{for(var o=s>1?void 0:s?fM(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&gM(t,i,o),o};class Va extends A{awake(){si.createIfNoneExists(this.context)}onEnable(){var t;(t=si.get(this.context))==null||t.register(this)}onDisable(){var t;(t=si.get(this.context))==null||t.unregister(this)}}class Ai extends Va{constructor(){super(...arguments),a(this,"targets",null),a(this,"raycastHits",[]),a(this,"ignoreSkinnedMeshes",!1)}start(){this.targets=[this.gameObject]}performRaycast(t=null){if(!this.targets)return null;t??(t=new Vn),t.targets=this.targets,t.results=this.raycastHits,t.useAcceleratedRaycast=!0;const i=t.testObject;this.ignoreSkinnedMeshes&&(t.testObject=o=>o instanceof fs?"continue in children":i?i(o):!0);const s=this.context.physics.raycast(t);return t.testObject=i,s}}yM([m()],Ai.prototype,"ignoreSkinnedMeshes",2);class ku extends Ai{constructor(){super(),this.ignoreSkinnedMeshes=!0}}const Tw=class extends Va{performRaycast(n){if(!J.active||!Tw.allow||!(n!=null&&n.ray))return null;const t=n.ray.origin,i=.015;return this.context.physics.sphereOverlap(t,i,!1,!0)}};let Ha=Tw;a(Ha,"allow",!0);class uf{static getObject(t){const i=t[Zi];return i&&(i.isComponent===!0?t=i.gameObject:t=i),t}static isInteractable(t,i){if(i&&(i.canvasGroup=void 0,i.graphic=void 0),t==null||!t.visible||(t=this.getObject(t),!t.visible))return!1;const s=this.tryFindCanvasGroup(t);if(s?.isCanvasGroup===!0&&(i&&(i.canvasGroup=s),s.blocksRaycasts===!1||s.interactable===!1))return!1;const o=_r(t,r=>{if(r.isGraphic===!0)return r},!1);return i&&o?.isGraphic===!0&&(i.graphic=o),!(o?.raycastTarget===!1||o?.layer===2)}static tryFindCanvasGroup(t){if(!t)return null;const i=_r(t,s=>{const o=s;if(o.blocksRaycasts!==void 0&&o.interactable!==void 0)return o},!1);return i!==void 0?i:this.tryFindCanvasGroup(t.parent)}}function pf(n){return n[Zi]||(n.parent?pf(n.parent):null)}function vM(n){return n.isUI===!0||typeof n[Zi]=="object"}function Mu(n,t){if(!n)return;const i=n.material;if(i?.isMaterial===!0){const s=n.parent;s&&s.isText,i.side=t.doubleSided??!0?Ci:ro,i.shadowSide=t.doubleSided?Ci:ro,n.castShadow=t.castShadows?t.castShadows:!1,n.receiveShadow=t.receiveShadows?t.receiveShadows:!1}for(const s of n.children)Mu(s,t)}function $a(n,t,i){n[t]===void 0&&console.warn("Field",t,"is undefined on",n);const s=Proxy.revocable(n[t],{set(l,c,h,d){const u=l[c],p=Reflect.set(l,c,h,d);return i(h,u),p}}),o=s.revoke,r=n[t];return s.revoke=()=>{n[t]=r,o()},n[t]=s.proxy,s}const Ew=Symbol("Scheduled action");function bM(n,t,i=Me.OnBeforeRender){let s=n[Ew];s||(s=n[Ew]={});const o=t.name;s[i]||(s[i]={});const r=s[i];if(r[o])return;function*l(){t?.call(n),r[o]=null}const c=n.startCoroutine(l(),i);r[o]=c}const xo=C("debugeventsystem");var mf=(n=>(n.BeforeHandleInput="BeforeHandleInput",n.AfterHandleInput="AfterHandleInput",n))(mf||{});xw(n=>{si.createIfNoneExists(n)});class si extends A{constructor(){super(...arguments),a(this,"raycaster",[]),a(this,"pressedByID",new Map),a(this,"hoveredByID",new Map),a(this,"onPointerEvent",t=>{if(t===void 0||t.propagationStopped||t.defaultPrevented||t.used)return;const i=new td(this.context.input,t);this._currentPointerEventName=t.type,i.inputSource=this.context.input,i.isClick=t.isClick,i.isDoubleClick=t.isDoubleClick,i.isDown=t.type==Be.PointerDown,i.isUp=t.type==Be.PointerUp,i.isPressed=this.context.input.getPointerPressed(t.pointerId),xo&&(i.isDown?console.log("DOWN",i.pointerId):i.isUp&&console.log("UP",i.pointerId),i.isClick&&console.log("CLICK",i.pointerId));const s=new Vn;t.hasRay?s.ray=t.ray:s.screenPoint=this.context.input.getPointerPositionRC(t.pointerId);const o=this.performRaycast(s);if(o){for(const l of o)l.event=t,t.intersections.push(l);t.origin.onPointerHits&&t.origin.onPointerHits({sender:this,event:t,hits:o})}xo&&i.isClick&&De("EventSystem: "+i.pointerId+" - "+this.context.time.frame+" - Up:"+i.isUp+", Down:"+i.isDown);const r={sender:this,args:i,hasActiveUI:this.currentActiveMeshUIComponents.length>0};this.dispatchEvent(new CustomEvent("BeforeHandleInput",{detail:r})),this.handleIntersections(o,i),this.dispatchEvent(new CustomEvent("AfterHandleInput",{detail:r}))}),a(this,"_sortedHits",[]),a(this,"_testObjectsCache",new Map),a(this,"_currentlyActiveRaycaster",null),a(this,"_currentPointerEventName",null),a(this,"shouldRaycastObject",t=>{var i;const s=t&&"getComponent"in t?t.getComponent(Va):null;if(s&&s!=this._currentlyActiveRaycaster)return!1;let o=null;if(vM(t)&&(o=(i=t[Zi])==null?void 0:i.gameObject),this._testObjectsCache.has(t)||o&&this._testObjectsCache.has(o))return this._testObjectsCache.get(t)===!1?"continue in children":!0;{let r=Su(t,this._currentPointerEventName);if(!r&&o&&(r=Su(o,this._currentPointerEventName)),r){this._testObjectsCache.set(t,!0);for(const l of t.children)this.shouldRaycastObject_AddToYesCache(l);return!0}return this._testObjectsCache.set(t,!1),"continue in children"}}),a(this,"_sortingBuffer",[]),a(this,"_noDepthTestingResults",[]),a(this,"out",{}),a(this,"_capturedPointer",{}),a(this,"pointerEnterSymbol",Symbol("pointerEnter")),a(this,"pointerExitSymbol",Symbol("pointerExit")),a(this,"currentActiveMeshUIComponents",[])}static ensureUpdateMeshUI(t,i,s=!1){So.update(t,i,s)}static markUIDirty(t){So.markDirty()}static createIfNoneExists(t){t.scene.getComponent(si)||t.scene.addComponent(si)}static get(t){return this.createIfNoneExists(t),t.scene.getComponent(si)}static get instance(){return this.get(ee.Current)}register(t){var i;t&&this.raycaster&&!this.raycaster.includes(t)&&((i=this.raycaster)==null||i.push(t))}unregister(t){var i,s;const o=(i=this.raycaster)==null?void 0:i.indexOf(t);o!==void 0&&o!==-1&&((s=this.raycaster)==null||s.splice(o,1))}get hasActiveUI(){return this.currentActiveMeshUIComponents.length>0}get isHoveringObjects(){return this.hoveredByID.size>0}awake(){this.gameObject!==this.context.scene&&(this.enabled=!1)}start(){this.context.scene.getComponent(Va)||this.context.scene.addComponent(Ai)}onEnable(){this.context.input.addEventListener(Be.PointerDown,this.onPointerEvent),this.context.input.addEventListener(Be.PointerUp,this.onPointerEvent),this.context.input.addEventListener(Be.PointerMove,this.onPointerEvent)}onDisable(){this.context.input.removeEventListener(Be.PointerDown,this.onPointerEvent),this.context.input.removeEventListener(Be.PointerUp,this.onPointerEvent),this.context.input.removeEventListener(Be.PointerMove,this.onPointerEvent)}onBeforeRender(){this.resetMeshUIStates()}shouldRaycastObject_AddToYesCache(t){this._testObjectsCache.set(t,!0);for(const i of t.children)this.shouldRaycastObject_AddToYesCache(i)}performRaycast(t){if(!this.raycaster)return null;this._testObjectsCache.clear(),this._sortedHits.length=0,t||(t=new Vn),t.testObject=this.shouldRaycastObject;for(const i of this.raycaster){if(!i.activeAndEnabled)continue;this._currentlyActiveRaycaster=i;const s=i.performRaycast(t);this._currentlyActiveRaycaster=null,s&&s.length>0&&this._sortedHits.push(...s)}return this._sortedHits.sort((i,s)=>i.distance-s.distance),this._sortedHits}assignHitInformation(t,i){i?(t.intersection=i,t.point=i.point,t.normal=i.normal,t.face=i.face,t.distance=i.distance,t.instanceId=i.instanceId):(t.intersection=void 0,t.point=void 0,t.normal=void 0,t.face=void 0,t.distance=void 0,t.instanceId=void 0)}handleIntersections(t,i){var s;if(t!=null&&t.length){t=this.sortCandidates(t);for(const r of t){if(i.event.immediatePropagationStopped)return!1;if(this.assignHitInformation(i,r),this.handleEventOnObject(r.object,i))return!0}}this.assignHitInformation(i,t?.[0]),this.invokePointerCapture(i);const o=this.hoveredByID.get(i.pointerId);return o&&this.propagatePointerExit(o.obj,o.data,null),this.hoveredByID.delete(i.pointerId),i.isUp&&((s=this.pressedByID.get(i.pointerId))==null||s.handlers.forEach(r=>this.invokeOnPointerUp(i,r)),this.pressedByID.delete(i.pointerId)),!1}sortCandidates(t){this._sortingBuffer.length=0,this._noDepthTestingResults.length=0;for(let i=0;i<t.length;i++){const s=t[i],o=s.object;if(o.material&&o.material.depthTest===!1){this._noDepthTestingResults.push(s);continue}this._sortingBuffer.push(s)}for(const i of this._sortingBuffer)this._noDepthTestingResults.push(i);return this._noDepthTestingResults}handleEventOnObject(t,i){if(!this.testIsVisible(t))return i.isClick&&xo&&console.log("not allowed",t),!1;if(i.pointerId===void 0)return xo&&console.error("Event without pointer can't be handled",i),!1;i.object=t;const s=t.parent,o=i.isClick??!1;let r=null;if(s&&s.isUI){const d=(i.isPressed||i.isClick)??!1;if(s[Zi]){const u=s[Zi].gameObject;if(u){if(!uf.isInteractable(u,this.out))return!1;r=this.out.canvasGroup??null,this.handleMeshUIIntersection(t,d),t=u}}}o&&xo&&console.log(this.context.time.frame,t);const l=this.hoveredByID.get(i.pointerId),c=l?.obj;c!==t&&c&&this.propagatePointerExit(c,l.data,t);const h=this.hoveredByID.get(i.pointerId);if(h?(h.obj=t,h.data=i):this.hoveredByID.set(i.pointerId,{obj:t,data:i}),i.isDown){const d=this.pressedByID.get(i.pointerId);d?(d.obj=t,d.data=i):this.pressedByID.set(i.pointerId,{obj:t,data:i,handlers:new Set})}return(r===null||r.interactable)&&this.handleMainInteraction(t,i,c??null),!0}propagate(t,i){for(;t;)O.foreachComponent(t,s=>{i(s)},!1),t=t.parent}handleMainInteraction(t,i,s){const o=this.pressedByID.get(i.pointerId),r=s!==t;let l=!0;switch(i.event.pointerType){case"mouse":case"touch":const c=this.context.input.getPointerPositionLastFrame(i.pointerId),h=this.context.input.getPointerPosition(i.pointerId);l=c&&!W.approximately(c,h);break}this.propagate(t,c=>{var h;const d=c;d.interactable!==!1&&(!d.activeAndEnabled||!d.enabled||(d.onPointerEnter&&r&&this.handlePointerEnter(d,i),i.isDown&&d.onPointerDown&&(d.onPointerDown(i),o?.handlers.add(d),this.handlePointerCapture(i,d)),d.onPointerMove&&(l&&d.onPointerMove(i),this.handlePointerCapture(i,d)),i.isUp&&(d.onPointerUp&&(this.invokeOnPointerUp(i,d),o?.handlers.delete(d)),d.onPointerExit&&((h=i.event)==null?void 0:h.pointerType)===kd.Touch&&(this.handlePointerExit(d,i),this.hoveredByID.delete(i.pointerId))),i.isClick&&d.onPointerClick&&d.onPointerClick(i)))}),i.isUp&&(o?.handlers.forEach(c=>{this.invokeOnPointerUp(i,c)}),this.pressedByID.delete(i.pointerId))}propagatePointerExit(t,i,s){this.propagate(t,o=>{if(!o.gameObject||o.destroyed)return;const r=o;if(r.onPointerExit||r.onPointerEnter){if(s&&this.isChild(s,o.gameObject))return;this.handlePointerExit(r,i)}})}invokeOnPointerUp(t,i){var s;(s=i.onPointerUp)==null||s.call(i,t),this.releasePointerCapture(t,i)}handlePointerEnter(t,i){t.onPointerEnter&&this.updatePointerState(t,i.pointerId,this.pointerEnterSymbol,!0)&&t.onPointerEnter(i),this.updatePointerState(t,i.pointerId,this.pointerExitSymbol,!1)}handlePointerExit(t,i){t.onPointerExit&&this.updatePointerState(t,i.pointerId,this.pointerExitSymbol,!0)&&t.onPointerExit(i),this.updatePointerState(t,i.pointerId,this.pointerEnterSymbol,!1)}updatePointerState(t,i,s,o){let r=t[s];if(o)return r&&r.includes(i)?!1:(r=r||[],r.push(i),t[s]=r,!0);{if(!r||!r.includes(i))return!1;const l=r.indexOf(i);return l!==-1&&r.splice(l,1),!0}}handlePointerCapture(t,i){if(t.z__pointer_ctured){t.z__pointer_ctured=!1;const s=t.pointerId;if(i.onPointerMove){const o=this._capturedPointer[s]||[];o.push(i),this._capturedPointer[s]=o}else F()&&!i.z__warned_no_pointermove&&(i.z__warned_no_pointermove=!0,console.warn("PointerCapture was requested but the component doesn't implement onPointerMove. It will not receive any pointer events"))}else t.z__pointer_cture_rleased&&(t.z__pointer_cture_rleased=!1,this.releasePointerCapture(t,i))}releasePointerCapture(t,i){const s=t.pointerId;if(this._capturedPointer[s]){const o=this._capturedPointer[s].indexOf(i);o!==-1&&(this._capturedPointer[s].splice(o,1),xo&&console.log("released pointer capture",s,i,this._capturedPointer))}}invokePointerCapture(t){var i;if(t.event.type===Be.PointerMove){const s=t.pointerId,o=this._capturedPointer[s];if(o){xo&&console.log("Captured",s,o);for(let r=0;r<o.length;r++){const l=o[r];if(l.destroyed){o.splice(r,1),r--;continue}(i=l.onPointerMove)==null||i.call(l,t)}}}}isChild(t,i){return!t||!i?!1:t===i?!0:t.parent?this.isChild(t.parent,i):!1}handleMeshUiObjectWithoutShadowDom(t,i){return!t||!t.isUI?!0:this.handleMeshUIIntersection(t,i)}handleMeshUIIntersection(t,i){const s=So.updateState(t,i);return s&&this.currentActiveMeshUIComponents.push(s),s!==null}resetMeshUIStates(){if(this.context.input.getPointerPressedCount()>0&&So.resetLastSelected(),!(!this.currentActiveMeshUIComponents||this.currentActiveMeshUIComponents.length<=0)){for(let t=0;t<this.currentActiveMeshUIComponents.length;t++){const i=this.currentActiveMeshUIComponents[t];So.resetState(i)}this.currentActiveMeshUIComponents.length=0}}testIsVisible(t){return t?O.isActiveSelf(t)?this.testIsVisible(t.parent):!1:!0}}class So{static markDirty(){this.needsUpdate=!0}static update(t,i,s=!1){if(s){t.update();return}const o=i.time.frameCount;for(const r of this.lastUpdateFrame)if(r.context===i){if(o===r.frame)return;r.frame=o;let l=this.needsUpdate||o<1;r.nextUpdate<=o&&(l=!0),l&&(xo&&console.log("Update threemeshui"),this.needsUpdate=!1,r.nextUpdate=o+60,t.update());return}this.lastUpdateFrame=[{context:i,frame:o,nextUpdate:o+60}],t.update(),this.needsUpdate=!1}static updateState(t,i){let s=null;if(t&&(s=this.findBlockOrTextInParent(t),s&&s!==this.lastSelected)){if(s.interactable===!1)return null;this.needsUpdate=!0}return s}static resetLastSelected(){const t=this.lastSelected;t&&(this.lastSelected=null,this.resetState(t))}static resetState(t){t&&(this.needsUpdate=!0)}static findBlockOrTextInParent(t){return t?t.isBlock||t.isText?t:this.findBlockOrTextInParent(t.parent):null}}a(So,"lastSelected",null),a(So,"lastUpdateFrame",[]),a(So,"needsUpdate",!1);var _M=Object.defineProperty,wM=Object.getOwnPropertyDescriptor,ze=(n,t,i,s)=>{for(var o=s>1?void 0:s?wM(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&_M(t,i,o),o};const Co=C("debugorbit"),gf=C("freecam"),Ru=C("debugcamerafit"),Tu=C("smoothcam"),xM={LEFT:"",UP:"",RIGHT:"",BOTTOM:""};let ff;class Wc extends CustomEvent{constructor(t,i){super("target-reached",{detail:{controls:t,type:i}})}}class be extends A{constructor(){super(...arguments),a(this,"autoTarget",!0),a(this,"autoFit",!1),a(this,"enableRotate",!0),a(this,"autoRotate",!1),a(this,"autoRotateSpeed",1),a(this,"minAzimuthAngle",1/0),a(this,"maxAzimuthAngle",1/0),a(this,"minPolarAngle",0),a(this,"maxPolarAngle",Math.PI),a(this,"enableKeys",!1),a(this,"enableDamping",!0),a(this,"dampingFactor",.1),a(this,"enableZoom",!0),a(this,"minZoom",0),a(this,"maxZoom",1/0),a(this,"zoomSpeed",1),a(this,"zoomToCursor",!1),a(this,"enablePan",!0),a(this,"lookAtConstraint",null),a(this,"lookAtConstraint01",1),a(this,"allowInterrupt",!0),a(this,"middleClickToFocus",!0),a(this,"doubleClickToFocus",!0),a(this,"clickBackgroundToFitScene",2),a(this,"debugLog",!1),a(this,"targetLerpDuration",1),a(this,"_controls",null),a(this,"_cameraObject",null),a(this,"_lookTargetLerpActive",!1),a(this,"_lookTargetStartPosition",new x),a(this,"_lookTargetEndPosition",new x),a(this,"_lookTargetLerp01",0),a(this,"_lookTargetLerpDuration",0),a(this,"_cameraLerpActive",!1),a(this,"_cameraStartPosition",new x),a(this,"_cameraEndPosition",new x),a(this,"_cameraLerp01",0),a(this,"_cameraLerpDuration",0),a(this,"_fovLerpActive",!1),a(this,"_fovLerpStartValue",0),a(this,"_fovLerpEndValue",0),a(this,"_fovLerp01",0),a(this,"_fovLerpDuration",0),a(this,"_inputs",0),a(this,"_enableTime",0),a(this,"_startedListeningToKeyEvents",!1),a(this,"_eventSystem"),a(this,"_afterHandleInputFn"),a(this,"_camera",null),a(this,"_syncedTransform"),a(this,"_didSetTarget",0),a(this,"targetElement",null),a(this,"_activePointerEvents"),a(this,"_lastTimeClickOnBackground",-1),a(this,"_clickOnBackgroundCount",0),a(this,"_onPointerDown",t=>{this._activePointerEvents.push(t)}),a(this,"_onPointerDownLate",t=>{t.used&&this._controls&&(this._controls.enabled=!1)}),a(this,"_onPointerUp",t=>{for(let i=this._activePointerEvents.length-1;i>=0;i--){const s=this._activePointerEvents[i];if(s.pointerId===t.pointerId&&s.button===t.button){this._activePointerEvents.splice(i,1);break}}if(this.clickBackgroundToFitScene>0&&t.isClick&&t.button===0){if(t.hasRay||t.intersections.push(...this.context.physics.raycast()),t.intersections.length<=0){const i=this.context.time.time-this._lastTimeClickOnBackground;this._lastTimeClickOnBackground=this.context.time.time,this.clickBackgroundToFitScene<=1||i<this.clickBackgroundToFitScene*.15?(this._clickOnBackgroundCount+=1,this._clickOnBackgroundCount>=this.clickBackgroundToFitScene-1&&this.fitCamera(this.context.scene.children,{immediate:!1})):this._clickOnBackgroundCount=0}Co&&console.log(this.clickBackgroundToFitScene,t.intersections.length,this._clickOnBackgroundCount)}}),a(this,"_onPointerUpLate",t=>{this.doubleClickToFocus&&t.isDoubleClick&&!t.used&&this.setTargetFromRaycast()}),a(this,"_orbitStartAngle",0),a(this,"onControlsChangeStarted",()=>{this._controls&&(this._orbitStartAngle=this._controls.getAzimuthalAngle()+this._controls.getPolarAngle()),this._syncedTransform&&this._syncedTransform.requestOwnership()}),a(this,"onControlsChangeEnded",()=>{if(this._controls&&this.autoTarget){const t=this._controls.getAzimuthalAngle()+this._controls.getPolarAngle()-this._orbitStartAngle;Math.abs(t)<.01?(Co&&console.debug("OrbitControls: No movement detected, updating target now"),this.updateTargetNow()):Co&&console.debug("OrbitControls: Movement detected",t)}}),a(this,"_shouldDisable",!1),a(this,"__onPreRender",()=>{const t=this.context.pre_render_callbacks.indexOf(this.__onPreRender);t>=0&&this.context.pre_render_callbacks.splice(t,1),this.autoFit&&(this.autoFit=!1,this.fitCamera({centerCamera:"y",immediate:!0,objects:this.scene.children}))}),a(this,"_haveAttachedKeyboardEvents",!1)}get isCameraController(){return!0}get controls(){return this._controls}get controllerObject(){return this._cameraObject}onStartInteraction(t){var i;(i=this.controls)==null||i.addEventListener("start",t)}get targetLerpSpeed(){return 5}set targetLerpSpeed(t){this.targetLerpDuration=1/t}awake(){Co&&console.debug("OrbitControls",this),this._didSetTarget=0,this._startedListeningToKeyEvents=!1}start(){this._eventSystem=si.get(this.context)??void 0,this._eventSystem&&(this._afterHandleInputFn=this.afterHandleInput.bind(this),this._eventSystem.addEventListener(mf.AfterHandleInput,this._afterHandleInputFn))}onDestroy(){var t,i;(t=this._controls)==null||t.dispose(),(i=this._eventSystem)==null||i.removeEventListener(mf.AfterHandleInput,this._afterHandleInputFn)}onEnable(){this._didSetTarget=0,this._enableTime=this.context.time.time;const t=O.getComponent(this.gameObject,Oe);this._camera=t;let i=t?.threeCamera;if(!i&&this.gameObject instanceof _e&&(i=this.gameObject),i&&Lm(i,this,!0),!this._controls&&i instanceof j){this._cameraObject=i;const s=this.targetElement??this.context.renderer.domElement,o=i?.quaternion.clone();this._controls=new nv(i,s),i?.quaternion.copy(o),ff===void 0&&(ff={...this._controls.keys});const r=te(i),l=this.gameObject.worldForward,c=2.5,h=r.clone().sub(l.multiplyScalar(c));this._controls.target.copy(h)}if(this._controls)if(gf&&(this.enablePan=!0,this.enableZoom=!0,this.middleClickToFocus=!0,Q.isMobileDevice()&&(this.doubleClickToFocus=!0)),this._controls.addEventListener("start",this.onControlsChangeStarted),this._controls.addEventListener("end",this.onControlsChangeEnded),!this._startedListeningToKeyEvents&&this.enableKeys)this._startedListeningToKeyEvents=!0,this._controls.listenToKeyEvents(this.context.domElement);else try{this._controls.stopListenToKeyEvents()}catch{}this._syncedTransform=O.getComponent(this.gameObject,qn)??void 0,this.context.pre_render_callbacks.push(this.__onPreRender),this._activePointerEvents=[],this.context.input.addEventListener("pointerdown",this._onPointerDown,{queue:ai.Early}),this.context.input.addEventListener("pointerdown",this._onPointerDownLate,{queue:ai.Late}),this.context.input.addEventListener("pointerup",this._onPointerUp,{queue:ai.Early}),this.context.input.addEventListener("pointerup",this._onPointerUpLate,{queue:ai.Late})}onDisable(){var t;if((t=this._camera)!=null&&t.threeCamera&&Lm(this._camera.threeCamera,this,!1),this._controls){this._controls.enabled=!1,this._controls.autoRotate=!1,this._controls.removeEventListener("start",this.onControlsChangeStarted),this._controls.removeEventListener("end",this.onControlsChangeEnded);try{this._controls.stopListenToKeyEvents()}catch{}this._startedListeningToKeyEvents=!1}this._activePointerEvents.length=0,this.context.input.removeEventListener("pointerdown",this._onPointerDown),this.context.input.removeEventListener("pointerdown",this._onPointerDownLate),this.context.input.removeEventListener("pointerup",this._onPointerUp),this.context.input.removeEventListener("pointerup",this._onPointerUpLate)}updateTargetNow(){var t,i,s;const o=new no((t=this._cameraObject)==null?void 0:t.worldPosition,(i=this._cameraObject)==null?void 0:i.worldForward.multiplyScalar(-1)),r=this.context.physics.raycastFromRay(o),l=r.length>0?r[0]:void 0;l&&l.distance>this.minZoom&&l.distance<this.maxZoom&&(Co&&G.DrawWireSphere(l.point,.1,16711680,2),(s=this._controls)==null||s.target.copy(r[0].point))}afterHandleInput(t){t.detail.args.pointerId===0&&(t.detail.args.isDown?this._controls&&this._eventSystem&&(this._shouldDisable=this._eventSystem.hasActiveUI):(!t.detail.args.isPressed||t.detail.args.isUp)&&(this._shouldDisable=!1))}onBeforeRender(){var t,i,s,o;if(!!this._controls){if(this._cameraObject!==this.context.mainCamera){this._controls.enabled=!1;return}if(this._controls.enabled=!0,(this.context.input.getPointerDown(1)||this.context.input.getPointerDown(2)||this.context.input.mouseWheelChanged||this.context.input.getPointerPressed(0)&&(t=this.context.input.getPointerPositionDelta(0))!=null&&t.length()||0>.1)&&(this._inputs+=1),this._inputs>0&&this.allowInterrupt&&(this.enableRotate&&(this.autoRotate=!1),this._cameraLerpActive=!1,this._lookTargetLerpActive=!1),this._inputs=0,this.autoTarget&&this._didSetTarget++===0){const r=O.getComponent(this.gameObject,Oe);if(r&&!this.setLookTargetFromConstraint()){this.debugLog&&console.log("NO TARGET");const l=te(r.threeCamera),c=Math.max(.01,l.length()),h=new x(0,0,-c).applyMatrix4(r.threeCamera.matrixWorld);this.setLookTargetPosition(h,!0)}if(!this.setLookTargetFromConstraint()){const l=new Vn;l.screenPoint=new re(0,0),l.lineThreshold=.1;const c=this.context.physics.raycast(l);c.length>0&&this.setLookTargetPosition(c[0].point,!0),Ru&&console.log("OrbitControls hits",...c)}}if(this.middleClickToFocus&&this.context.input.getPointerClicked(1)&&this.setTargetFromRaycast(),this._lookTargetLerpActive||this._cameraLerpActive||this._fovLerpActive){if(this._cameraLerpActive&&this._cameraObject)if(this._cameraLerp01+=this.context.time.deltaTime/this._cameraLerpDuration,this._cameraLerp01>=1)this._cameraObject.position.copy(this._cameraEndPosition),this._cameraLerpActive=!1,this.dispatchEvent(new Wc(this,"camera"));else{const r=W.easeInOutCubic(this._cameraLerp01);this._cameraObject.position.lerpVectors(this._cameraStartPosition,this._cameraEndPosition,r)}if(this._lookTargetLerpActive)if(this._lookTargetLerp01+=this.context.time.deltaTime/this._lookTargetLerpDuration,this._lookTargetLerp01>=1)this._controls.target.copy(this._lookTargetEndPosition),this._lookTargetLerpActive=!1,this.dispatchEvent(new Wc(this,"lookat"));else{const r=W.easeInOutCubic(this._lookTargetLerp01);this._controls.target.lerpVectors(this._lookTargetStartPosition,this._lookTargetEndPosition,r)}if(this._fovLerpActive&&this._cameraObject){const r=this._cameraObject;if(this._fovLerp01+=this.context.time.deltaTime/this._fovLerpDuration,this._fovLerp01>=1)r.fov=this._fovLerpEndValue,this._fovLerpActive=!1;else{const l=W.easeInOutCubic(this._fovLerp01);r.fov=W.lerp(this._fovLerpStartValue,this._fovLerpEndValue,l)}r.updateProjectionMatrix()}}if(this._controls){if(this.debugLog&&(this._controls.domElement=this.context.renderer.domElement),this._controls.enabled=!this._shouldDisable&&this._camera===this.context.mainCameraComponent&&!this.context.isInXR&&!this._activePointerEvents.some(r=>r.used),this._controls.keys=this.enableKeys?ff:xM,this._controls.autoRotate=this.autoRotate,this._controls.autoRotateSpeed=this.autoRotateSpeed,this._controls.enableZoom=this.enableZoom,this._controls.zoomSpeed=this.zoomSpeed,this._controls.zoomToCursor=this.zoomToCursor,this._controls.enableDamping=this.enableDamping,this._controls.dampingFactor=this.dampingFactor,this._controls.enablePan=this.enablePan,this._controls.enableRotate=this.enableRotate,this._controls.minAzimuthAngle=this.minAzimuthAngle,this._controls.maxAzimuthAngle=this.maxAzimuthAngle,this._controls.minPolarAngle=this.minPolarAngle,this._controls.maxPolarAngle=this.maxPolarAngle,gf||(((s=(i=this._camera)==null?void 0:i.threeCamera)==null?void 0:s.type)==="PerspectiveCamera"?(this._controls.minDistance=this.minZoom,this._controls.maxDistance=this.maxZoom,this._controls.minZoom=0,this._controls.maxZoom=1/0):(this._controls.minDistance=0,this._controls.maxDistance=1/0,this._controls.minZoom=this.minZoom,this._controls.maxZoom=this.maxZoom)),typeof Tu=="number"||Tu===!0){this._controls.enableDamping=!0;const r=typeof Tu=="number"?Tu:.99;this._controls.dampingFactor=Math.max(.001,1-Math.min(1,r))}this.allowInterrupt||(this._lookTargetLerpActive&&(this._controls.enablePan=!1),this._cameraLerpActive&&(this._controls.enableRotate=!1,this._controls.autoRotate=!1),(this._lookTargetLerpActive||this._cameraLerpActive)&&(this._controls.enableZoom=!1)),this.context.isInXR||(!gf&&(o=this.lookAtConstraint)!=null&&o.locked&&this.setLookTargetFromConstraint(0,this.lookAtConstraint01),this._controls.update(this.context.time.deltaTime),Co&&G.DrawWireSphere(this._controls.target,.1,65280))}}}setCameraAndLookTarget(t,i=!1){if(!t)return F()&&console.warn("[OrbitControls] setCameraAndLookTarget target is null"),!1;if(!(t instanceof j)&&!(t instanceof Oe))return F()&&console.warn("[OrbitControls] setCameraAndLookTarget target is not an Object3D or Camera"),!1;t instanceof Oe&&(t=t.gameObject);const s=t.worldPosition,o=t.worldForward,r=new no(s,o.multiplyScalar(-1));return Co&&G.DrawRay(r.origin,r.direction,16711680,10),this.setTargetFromRaycast(r,i)||this.setLookTargetPosition(r.at(2,q()),i),this.setCameraTargetPosition(s,i),!0}setCameraTargetPosition(t,i=!1){var s;t&&(t instanceof j&&(t=te(t)),this._cameraEndPosition||(this._cameraEndPosition=new x),this._cameraEndPosition.copy(t),i===!0?(this._cameraLerpActive=!1,this._cameraObject&&this._cameraObject.position.copy(this._cameraEndPosition)):this._cameraObject&&(this._cameraLerpActive=!0,this._cameraLerp01=0,this._cameraStartPosition.copy((s=this._cameraObject)==null?void 0:s.position),typeof i=="number"?this._cameraLerpDuration=i:this._cameraLerpDuration=this.targetLerpDuration))}get cameraLerpActive(){return this._cameraLerpActive}stopCameraLerp(){this._cameraLerpActive=!1}setFieldOfView(t,i=!1){var s;if(!this._controls||typeof t!="number")return;const o=(s=this._camera)==null?void 0:s.threeCamera;o&&(i===!0?o.fov=t:(this._fovLerpActive=!0,this._fovLerp01=0,this._fovLerpStartValue=o.fov,this._fovLerpEndValue=t,typeof i=="number"?this._fovLerpDuration=i:this._fovLerpDuration=this.targetLerpDuration))}setLookTargetPosition(t=null,i=!1){this._controls&&t&&(t instanceof j&&(t=te(t)),this._lookTargetEndPosition.copy(t),this._didSetTarget++,Co&&(console.warn("OrbitControls: setLookTargetPosition",t,i),G.DrawWireSphere(this._lookTargetEndPosition,.2,16711680,2)),i===!0?this._controls.target.copy(this._lookTargetEndPosition):(this._lookTargetLerpActive=!0,this._lookTargetLerp01=0,this._lookTargetStartPosition.copy(this._controls.target),typeof i=="number"?this._lookTargetLerpDuration=i:this._lookTargetLerpDuration=this.targetLerpDuration))}get lookTargetLerpActive(){return this._lookTargetLerpActive}stopLookTargetLerp(){this._lookTargetLerpActive=!1}setLookTargetFromConstraint(t=0,i=1){var s,o;if(!this._controls||((s=this.lookAtConstraint)==null?void 0:s.enabled)===!1)return!1;const r=(o=this.lookAtConstraint)==null?void 0:o.sources;if(r&&r.length>0){const l=r[t];if(l)return l.getWorldPosition(this._lookTargetEndPosition),this.lerpLookTarget(this._lookTargetEndPosition,i),!0}return!1}lerpTarget(t,i){return this.lerpLookTarget(t,i)}lerpLookTarget(t,i){this._controls&&(i>=1?this._controls.target.copy(t):this._controls.target.lerp(t,i))}setTargetFromRaycast(t,i=!1){if(!this.controls)return!1;const s=t?this.context.physics.raycastFromRay(t):this.context.physics.raycast();for(const o of s)if(o.distance>0&&O.isActiveInHierarchy(o.object)){const r=pf(o.object);if(r){const l=r.canvas;if(l!=null&&l.screenspace)break}return this.setLookTargetPosition(o.point,i),!0}return!1}fitCamera(t,i){var s,o;if(this.context.isInXR)return;let r;if(Array.isArray(t)?r=t:t&&"type"in t?r=t.children:t&&"objects"in t&&(r=t?.objects,i=t),r&&!Array.isArray(r)&&(r=r.children),(!Array.isArray(r)||r&&r.length<=0)&&(r=this.context.scene.children),!Array.isArray(r)||r.length<=0){console.warn("No objects to fit camera to...");return}const l=this._cameraObject,c=this._controls;if(!l||!c){console.warn("No camera or controls found to fit camera to objects...");return}i||(i={});const{immediate:h=!1,centerCamera:d="y",cameraNearFar:u="auto",fitOffset:p=1.1,fov:g=l?.fov}=i,y=new x,f=new x,v=oi(r,void 0,(o=(s=this._camera)==null?void 0:s.threeCamera)==null?void 0:o.layers),b=v.clone();l.updateMatrixWorld(),l.updateProjectionMatrix(),v.getCenter(f);const w=new x;if(v.getSize(w),v.applyMatrix4(l.matrixWorldInverse),v.getSize(y),v.setFromCenterAndSize(f,y),Number.isNaN(y.x)||Number.isNaN(y.y)||Number.isNaN(y.z)){console.warn("Camera fit size resultet in NaN",l,v,[...r]);return}if(y.length()<=1e-10){Ru&&console.warn("Camera fit size is zero",v,[...r]);return}const _=i.fov||l.fov,S=2*Math.atan(Math.tan(_*Math.PI/360/2)*l.aspect)/Math.PI*360,R=y.y/(2*Math.atan(Math.PI*_/360)),M=y.x/(2*Math.atan(Math.PI*S/360)),T=p*Math.max(R,M)+y.z/2;Ru&&console.log("Fit camera to objects",{fitHeightDistance:R,fitWidthDistance:M,distance:T,verticalFov:_,horizontalFov:S}),this.maxZoom=T*10,this.minZoom=T*.01;const L=.05,D=f.clone();if(D.y-=y.y*L,this.setLookTargetPosition(D,h),this.setFieldOfView(i.fov,h),u==null||u=="auto"){const E=O.findObjectOfType($n),z=E?E.radius:0,H=Math.max(w.x,w.y,w.z,z);l.near=T/100,l.far=H+T*10,E&&(this.maxZoom=Math.max(Math.min(this.maxZoom,z*.5),T))}const U=c.getDistance();U<this.minZoom&&(this.minZoom=U*.9),U>this.maxZoom&&(this.maxZoom=U*1.1),l.updateMatrixWorld(),l.updateProjectionMatrix();const B=te(l),Y=f.clone();Y.sub(B),d==="y"&&(Y.y=0),Y.normalize(),Y.multiplyScalar(T),d==="y"&&(Y.y+=-L*4*T);let $=f.clone().sub(Y);if(l.parent&&($=l.parent.worldToLocal($)),this.setCameraTargetPosition($,h),Ru){const E=new Uy(v);this.context.scene.add(E),Vm(E,ic(l)),setTimeout(()=>{this.context.scene.remove(E)},1e4),G.DrawWireBox3(b,65280,10),this._haveAttachedKeyboardEvents||(this._haveAttachedKeyboardEvents=!0,document.body.addEventListener("keydown",z=>{if(z.code==="KeyF"){let H;this._cameraObject instanceof _e&&(H=Math.random()*Math.random()*170+10),this.fitCamera({objects:r,fitOffset:p,immediate:!1,fov:H})}z.code==="KeyV"&&this._cameraObject instanceof _e&&(this._cameraObject.fov=60)}))}c.update()}}ze([m()],be.prototype,"autoTarget",2),ze([m()],be.prototype,"autoFit",2),ze([m()],be.prototype,"enableRotate",2),ze([m()],be.prototype,"autoRotate",2),ze([m()],be.prototype,"autoRotateSpeed",2),ze([m()],be.prototype,"minAzimuthAngle",2),ze([m()],be.prototype,"maxAzimuthAngle",2),ze([m()],be.prototype,"minPolarAngle",2),ze([m()],be.prototype,"maxPolarAngle",2),ze([m()],be.prototype,"enableKeys",2),ze([m()],be.prototype,"enableDamping",2),ze([m()],be.prototype,"dampingFactor",2),ze([m()],be.prototype,"enableZoom",2),ze([m()],be.prototype,"minZoom",2),ze([m()],be.prototype,"maxZoom",2),ze([m()],be.prototype,"zoomSpeed",2),ze([m()],be.prototype,"enablePan",2),ze([m(Rr)],be.prototype,"lookAtConstraint",2),ze([m()],be.prototype,"lookAtConstraint01",2),ze([m()],be.prototype,"allowInterrupt",2),ze([m()],be.prototype,"middleClickToFocus",2),ze([m()],be.prototype,"doubleClickToFocus",2),ze([m()],be.prototype,"clickBackgroundToFitScene",2),ze([m()],be.prototype,"targetLerpDuration",2);var SM=Object.defineProperty,CM=Object.getOwnPropertyDescriptor,Yt=(n,t,i,s)=>{for(var o=s>1?void 0:s?CM(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&SM(t,i,o),o},Oo=(n=>(n[n.None=0]="None",n[n.Skybox=1]="Skybox",n[n.SolidColor=2]="SolidColor",n[n.Uninitialized=4]="Uninitialized",n))(Oo||{});const Po=C("debugcam"),Aw=C("debugscreenpointtoray");var Eu;const Vc=(Eu=class extends A{constructor(){super(...arguments),a(this,"_nearClipPlane",.1),a(this,"_farClipPlane",1e3),a(this,"orthographic",!1),a(this,"orthographicSize",5),a(this,"ARBackgroundAlpha",0),a(this,"_cullingMask",4294967295),a(this,"_backgroundBlurriness"),a(this,"_backgroundIntensity"),a(this,"_backgroundRotation"),a(this,"_environmentIntensity"),a(this,"_targetTexture",null),a(this,"_backgroundColor"),a(this,"_fov"),a(this,"_cam",null),a(this,"_clearFlags",2),a(this,"_skybox"),a(this,"_frustum"),a(this,"_projScreenMatrix",new se)}get isCamera(){return!0}get aspect(){return this._cam instanceof _e?this._cam.aspect:this.context.domWidth/this.context.domHeight}set aspect(n){this._cam instanceof _e&&this._cam.aspect!==n&&(this._cam.aspect=n,this._cam.updateProjectionMatrix())}get fieldOfView(){return this._cam instanceof _e?this._cam.fov:this._fov}set fieldOfView(n){const t=this.fieldOfView!=n;if(this._fov=n,t&&this._cam&&this._cam instanceof _e){if(this._fov===void 0){console.warn("Can not set undefined fov on PerspectiveCamera");return}this._cam.fov=this._fov,this._cam.updateProjectionMatrix()}}get nearClipPlane(){return this._nearClipPlane}set nearClipPlane(n){const t=this._nearClipPlane!=n;this._nearClipPlane=n,this._cam&&(t||this._cam.near!=n)&&(this._cam.near=n,this._cam.updateProjectionMatrix())}get farClipPlane(){return this._farClipPlane}set farClipPlane(n){const t=this._farClipPlane!=n;this._farClipPlane=n,this._cam&&(t||this._cam.far!=n)&&(this._cam.far=n,this._cam.updateProjectionMatrix())}applyClippingPlane(){this._cam&&(this._cam.near=this._nearClipPlane,this._cam.far=this._farClipPlane,this._cam.updateProjectionMatrix())}get clearFlags(){return this._clearFlags}set clearFlags(n){if(typeof n=="string")switch(n){case"skybox":n=1;break;case"solidcolor":n=2;break;default:n=0;break}n!==this._clearFlags&&(this._clearFlags=n,this.applyClearFlagsIfIsActiveCamera())}set cullingMask(n){this._cullingMask=n,this._cam&&(this._cam.layers.mask=n)}get cullingMask(){return this._cam?this._cam.layers.mask:this._cullingMask}set cullingLayer(n){this.cullingMask=(1<<n|0)>>>0}set backgroundBlurriness(n){n!==this._backgroundBlurriness&&(n===void 0?this._backgroundBlurriness=void 0:this._backgroundBlurriness=Math.min(Math.max(n,0),1),this.applyClearFlagsIfIsActiveCamera())}get backgroundBlurriness(){return this._backgroundBlurriness}set backgroundIntensity(n){n!==this._backgroundIntensity&&(n===void 0?this._backgroundIntensity=void 0:this._backgroundIntensity=Math.min(Math.max(n,0),10),this.applyClearFlagsIfIsActiveCamera())}get backgroundIntensity(){return this._backgroundIntensity}set backgroundRotation(n){n!==this._backgroundRotation&&(n===void 0?this._backgroundRotation=void 0:this._backgroundRotation=n,this.applyClearFlagsIfIsActiveCamera())}get backgroundRotation(){return this._backgroundRotation}set environmentIntensity(n){this._environmentIntensity=n}get environmentIntensity(){return this._environmentIntensity}get backgroundColor(){return this._backgroundColor??null}set backgroundColor(n){n&&(this._backgroundColor||(this._backgroundColor=new xe(1,1,1,1)),this._backgroundColor.copy(n),(!("alpha"in n)||n.alpha===void 0)&&(this._backgroundColor.alpha=1),this.applyClearFlagsIfIsActiveCamera())}set targetTexture(n){this._targetTexture=n}get targetTexture(){return this._targetTexture}get cam(){return this.threeCamera}get threeCamera(){return this.activeAndEnabled&&this.buildCamera(),this._cam}screenPointToRay(n,t,i){const s=this.threeCamera,o=Vc._origin;o.set(n,t,-1),this.context.input.convertScreenspaceToRaycastSpace(o),Aw&&console.log("screenPointToRay",n.toFixed(2),t.toFixed(2),"now:",o.x.toFixed(2),o.y.toFixed(2),"isInXR:"+this.context.isInXR),o.z=-1,o.unproject(s);const r=Vc._direction.set(o.x,o.y,o.z),l=te(s);return r.sub(l),r.normalize(),i?(i.set(l,r),i):new no(l.clone(),r.clone())}getFrustum(){return this._frustum||(this._frustum=new qy,this.updateFrustum()),this._frustum}updateFrustum(){this._frustum||(this._frustum=new qy),this._frustum.setFromProjectionMatrix(this.getProjectionScreenMatrix(this._projScreenMatrix,!0),this.context.renderer.coordinateSystem)}getProjectionScreenMatrix(n,t){return t&&this._projScreenMatrix.multiplyMatrices(this.threeCamera.projectionMatrix,this.threeCamera.matrixWorldInverse),n===this._projScreenMatrix?n:n.copy(this._projScreenMatrix)}awake(){Aw&&window.addEventListener("pointerdown",n=>{const t=n.clientX,i=n.clientY;console.log("touch",t.toFixed(2),i.toFixed(2));const s=this.screenPointToRay(t,i),o="#"+Math.floor(Math.random()*16777215).toString(16);G.DrawRay(s.origin,s.direction,o,10)})}onEnable(){Po&&console.log(`Camera enabled: "${this.name}". ClearFlags=${Oo[this._clearFlags]}`,this),this.buildCamera(),(this.tag=="MainCamera"||!this.context.mainCameraComponent)&&(this.context.setCurrentCamera(this),PM(this)),this.applyClearFlagsIfIsActiveCamera({applySkybox:!0})}onDisable(){this.context.removeCamera(this)}onBeforeRender(){if(this._cam&&(this._frustum&&this.updateFrustum(),this._clearFlags===2&&this.applyClearFlagsIfIsActiveCamera(),this._targetTexture)){this.context.isManagedExternally&&(this._warnedAboutExternalRenderer||(this._warnedAboutExternalRenderer=!0,console.warn("Rendering with external renderer is not supported yet. This may not work or throw errors. Please remove the the target texture from your camera: "+this.name,this.targetTexture))),this.context.composer;const n=this.context.renderer;if(n){const t=this.context.mainCameraComponent;this.applyClearFlags(),this._targetTexture.render(this.context.scene,this._cam,n),t?.applyClearFlags()}}}buildCamera(){if(this._cam)return;const n=this.gameObject.isCamera;let t=null;if(n?(t=this.gameObject,t?.layers.enableAll(),t instanceof _e&&(this._fov=t.fov)):t=this.gameObject.children[0],t&&t.isCamera)t instanceof _e&&(this._fov&&(t.fov=this._fov),t.near=this._nearClipPlane,t.far=this._farClipPlane,t.updateProjectionMatrix());else if(!this.orthographic)t=new _e(this.fieldOfView,window.innerWidth/window.innerHeight,this._nearClipPlane,this._farClipPlane),this.fieldOfView&&(t.fov=this.fieldOfView),this.gameObject.add(t);else{const i=this.orthographicSize*100;t=new cm(window.innerWidth/-i,window.innerWidth/i,window.innerHeight/i,window.innerHeight/-i,this._nearClipPlane,this._farClipPlane),this.gameObject.add(t)}this._cam=t,this._cam.layers.mask=this._cullingMask,this.tag=="MainCamera"&&this.context.setCurrentCamera(this)}applyClearFlagsIfIsActiveCamera(n){this.context.mainCameraComponent===this&&this.applyClearFlags(n)}applyClearFlags(n){var t;if(!this._cam){Po&&console.log("Camera does not exist (apply clear flags)");return}if(this.fieldOfView=this._fov,Po){const i=`Camera "${this.name}" clear flags: ${Oo[this._clearFlags]}`;console.debug(i)}switch(this._clearFlags){case 0:return;case 1:if(Vc.backgroundShouldBeTransparent(this.context)&&(!this.ARBackgroundAlpha||this.ARBackgroundAlpha<.001)){this.context.scene.background=null,this.context.renderer.setClearColor(0,0);return}(!this.scene.background||!this._skybox||n?.applySkybox===!0)&&this.applySceneSkybox(),this._backgroundBlurriness!==void 0?this.context.scene.backgroundBlurriness=this._backgroundBlurriness:Po&&console.warn(`Camera "${this.name}" has no background blurriness`),this._backgroundIntensity!==void 0&&(this.context.scene.backgroundIntensity=this._backgroundIntensity),this._backgroundRotation!==void 0?this.context.scene.backgroundRotation=this._backgroundRotation:Po&&console.warn(`Camera "${this.name}" has no background intensity`);break;case 2:if(this._backgroundColor){let i=this._backgroundColor.alpha;Vc.backgroundShouldBeTransparent(this.context)&&(i=this.ARBackgroundAlpha??0),this.context.scene.background=null,(t=this.context.xr)!=null&&t.isVR?this.context.renderer.setClearColor(Nv(this._backgroundColor).convertLinearToSRGB()):this.context.renderer.setClearColor(this._backgroundColor,i)}else Po&&console.warn(`Camera "${this.name}" has no background color`,this);break;case 4:this.context.scene.background=null,this.context.renderer.setClearColor(0,0);break}}applySceneSkybox(){this._skybox||(this._skybox=new OM(this)),this._skybox.apply()}static backgroundShouldBeTransparent(n){var t,i,s,o;const r=(t=n.renderer.xr)==null?void 0:t.getSession();if(!r)return!1;if(typeof r._transparent=="boolean")return r._transparent;const l=r.environmentBlendMode;Po&&De("Environment blend mode: "+l+" on "+navigator.userAgent);let c=l==="additive"||l==="alpha-blend";return n.isInAR&&l==="opaque"&&((i=navigator.userAgent)!=null&&i.includes("OculusBrowser")||(s=navigator.userAgent)!=null&&s.includes("Mozilla")&&(o=navigator.userAgent)!=null&&o.includes("Mobile WebXRViewer/v2"))&&(c=!0),r._transparent=c,c}},a(Eu,"_origin",new x),a(Eu,"_direction",new x),Eu);let Oe=Vc;Yt([m()],Oe.prototype,"aspect",1),Yt([m()],Oe.prototype,"fieldOfView",1),Yt([m()],Oe.prototype,"nearClipPlane",1),Yt([m()],Oe.prototype,"farClipPlane",1),Yt([m()],Oe.prototype,"clearFlags",1),Yt([m()],Oe.prototype,"orthographic",2),Yt([m()],Oe.prototype,"orthographicSize",2),Yt([m()],Oe.prototype,"ARBackgroundAlpha",2),Yt([m()],Oe.prototype,"cullingMask",1),Yt([m()],Oe.prototype,"backgroundBlurriness",1),Yt([m()],Oe.prototype,"backgroundIntensity",1),Yt([m(Bt)],Oe.prototype,"backgroundRotation",1),Yt([m()],Oe.prototype,"environmentIntensity",1),Yt([m(xe)],Oe.prototype,"backgroundColor",1),Yt([m(Na)],Oe.prototype,"targetTexture",1);class OM{constructor(t){a(this,"_camera"),a(this,"_skybox"),this._camera=t}get context(){var t;return(t=this._camera)==null?void 0:t.context}apply(){this._skybox=this.context.lightmaps.tryGetSkybox(this._camera.sourceId),this._skybox?this.context.scene.background!==this._skybox&&(Po&&console.log(`Camera "${this._camera.name}" set skybox`,this._camera,this._skybox),this._skybox.mapping=ys,this.context.scene.background=this._skybox):this._did_log_failed_to_find_skybox||(this._did_log_failed_to_find_skybox=!0,console.warn(`Camera "${this._camera.name}" has no skybox texture. ${this._camera.sourceId}`))}}function PM(n){C("freecam")&&n.context.mainCameraComponent===n&&O.getOrAddComponent(n.gameObject,be)}class Ts extends A{constructor(){super(...arguments),a(this,"_listener",null),a(this,"onInteraction",()=>{this.destroyed||this.listener==null||this.addListenerIfItExists()})}get listener(){return this._listener==null&&(this._listener=new IS),this._listener}onEnable(){Ps.registerWaitForInteraction(this.onInteraction),this.addListenerIfItExists()}onDisable(){Ps.unregisterWaitForInteraction(this.onInteraction),this.removeListenerIfItExists()}addListenerIfItExists(){const t=this._listener;if(!t||t!=null&&t.parent)return;const i=this.context.mainCameraComponent||O.getComponentInParent(this.gameObject,Oe);i!=null&&i.threeCamera?i.threeCamera.add(t):this.gameObject.add(t),t.filter?(t.gain.connect(t.filter),t.filter.connect(t.context.destination)):t.gain.connect(t.context.destination)}removeListenerIfItExists(){const t=this._listener;t&&(t.removeFromParent(),t.filter&&t.filter.disconnect(),t.gain&&t.gain.disconnect())}}var kM=Object.defineProperty,MM=Object.getOwnPropertyDescriptor,Pn=(n,t,i,s)=>{for(var o=s>1?void 0:s?MM(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&kM(t,i,o),o};const Nt=C("debugaudio"),ko=class extends A{constructor(){super(...arguments),a(this,"clip",""),a(this,"playOnAwake",!1),a(this,"preload",!1),a(this,"playInBackground",!0),a(this,"_spatialBlend",0),a(this,"_minDistance",1),a(this,"_maxDistance",100),a(this,"_volume",1),a(this,"rollOffMode",0),a(this,"_loop",!1),a(this,"sound",null),a(this,"helper",null),a(this,"wasPlaying",!1),a(this,"audioLoader",null),a(this,"shouldPlay",!1),a(this,"_lastClipStartedLoading",null),a(this,"_audioElement",null),a(this,"onVisibilityChanged",()=>{switch(document.visibilityState){case"hidden":(this.playInBackground===!1||Q.isMobileDevice())&&(this.wasPlaying=this.isPlaying,this.isPlaying&&this.pause());break;case"visible":Nt&&console.log("visible",this.enabled,this.playOnAwake,!this.isPlaying,ko.userInteractionRegistered,this.wasPlaying),this.enabled&&this.playOnAwake&&!this.isPlaying&&ko.userInteractionRegistered&&this.wasPlaying&&this.play();break}}),a(this,"onApplicationMuteChanged",()=>{var n,t;this.context.application.muted?(n=this.sound)==null||n.setVolume(0):(t=this.sound)==null||t.setVolume(this.volume)}),a(this,"createAudio",n=>{Nt&&console.log("AudioBuffer finished loading",n);const t=this.Sound;if(!t){Nt&&console.warn("Failed getting sound?",this.name);return}t.isPlaying&&t.stop(),n&&t.setBuffer(n),t.loop=this._loop,this.context.application.muted?t.setVolume(0):t.setVolume(this.volume),t.autoplay=this.shouldPlay&&ko.userInteractionRegistered,this.applySpatialDistanceSettings(),t.isPlaying&&t.stop(),ko.registerWaitForAllowAudio(this.__onAllowAudioCallback)}),a(this,"__onAllowAudioCallback",()=>{this.shouldPlay&&this.play()}),a(this,"_lastContextTime",0),a(this,"_hasEnded",!0),a(this,"_needUpdateSpatialDistanceSettings",!1)}static get userInteractionRegistered(){return Ps.userInteractionRegistered}static registerWaitForAllowAudio(n){Ps.registerWaitForInteraction(n)}get isPlaying(){var n;return((n=this.sound)==null?void 0:n.isPlaying)??!1}get duration(){var n,t;return(t=(n=this.sound)==null?void 0:n.buffer)==null?void 0:t.duration}get time01(){var n;const t=this.duration;return t&&this.sound?((n=this.sound)==null?void 0:n.context.currentTime)/t:0}set time01(n){const t=this.duration;t&&this.sound&&(this.time=n*t)}get time(){var n,t;return(n=this.sound)!=null&&n.source?((t=this.sound.source)==null?void 0:t.context.currentTime)-this._lastContextTime+this.sound.offset:0}set time(n){if(this.sound){if(n===this.sound.offset)return;const t=this.isPlaying;this.stop(),this.sound.offset=n,t&&this.play()}}get loop(){return this.sound&&(this._loop=this.sound.getLoop()),this._loop}set loop(n){this._loop=n,this.sound&&this.sound.setLoop(n)}get spatialBlend(){return this._spatialBlend}set spatialBlend(n){n!==this._spatialBlend&&(this._spatialBlend=n,this._needUpdateSpatialDistanceSettings=!0)}get minDistance(){return this._minDistance}set minDistance(n){this._minDistance!==n&&(this._minDistance=n,this._needUpdateSpatialDistanceSettings=!0)}get maxDistance(){return this._maxDistance}set maxDistance(n){this._maxDistance!==n&&(this._maxDistance=n,this._needUpdateSpatialDistanceSettings=!0)}get volume(){return this._volume}set volume(n){this._volume=n,this.sound&&!this.context.application.muted&&(Nt&&console.log(this.name,"audio set volume",n),this.sound.setVolume(n))}set pitch(n){this.sound&&this.sound.setPlaybackRate(n)}get pitch(){return this.sound?this.sound.getPlaybackRate():1}get Sound(){var n;if(!this.sound&&ko.userInteractionRegistered){let t=this.gameObject.getComponent(Ts)??this.context.mainCamera.getComponent(Ts)??kc(Ts,this.context,!1);!t&&this.context.mainCamera&&(t=this.context.mainCamera.addComponent(Ts)),t!=null&&t.listener?(this.sound=new jS(t.listener),(n=this.gameObject)==null||n.add(this.sound)):Nt&&console.warn("No audio listener found in scene - can not play audio")}return this.sound}get ShouldPlay(){return this.shouldPlay}get audioContext(){var n;return(n=this.sound)==null?void 0:n.context}awake(){Nt&&console.log(this),this.audioLoader=new hm,this.playOnAwake&&(this.shouldPlay=!0),this.preload&&typeof this.clip=="string"&&this.audioLoader.load(this.clip,this.createAudio,()=>{},console.error)}onEnable(){this.sound&&this.gameObject.add(this.sound),ko.userInteractionRegistered?this.playOnAwake&&this.context.application.isVisible&&this.play():ko.registerWaitForAllowAudio(()=>{this.enabled&&!this.destroyed&&this.shouldPlay&&this.onNewClip(this.clip)}),globalThis.addEventListener("visibilitychange",this.onVisibilityChanged),this.context.application.addEventListener(nu.MuteChanged,this.onApplicationMuteChanged)}onDisable(){globalThis.removeEventListener("visibilitychange",this.onVisibilityChanged),this.context.application.removeEventListener(nu.MuteChanged,this.onApplicationMuteChanged),this.pause()}applySpatialDistanceSettings(){const n=this.sound;if(!n)return;this._needUpdateSpatialDistanceSettings=!1;const t=W.lerp(10*this._maxDistance/Math.max(1e-4,this.spatialBlend),this._minDistance,this.spatialBlend);switch(Nt&&console.log(this.name,this._minDistance,this._maxDistance,this.spatialBlend,"Ref distance="+t),n.setRefDistance(t),n.setMaxDistance(Math.max(.01,this._maxDistance)),this.rollOffMode){case 0:n.setDistanceModel("exponential");break;case 1:n.setDistanceModel("linear");break;case 2:console.warn("Custom rolloff for AudioSource is not supported: "+this.name);break}this.spatialBlend>0?Nt&&!this.helper&&(this.helper=new zC(n,n.getRefDistance()),n.add(this.helper)):this.helper&&this.helper.parent&&this.helper.removeFromParent()}async onNewClip(n){if(n&&(this.clip=n),typeof n=="string")if(Nt&&console.log(n),n.endsWith(".mp3")||n.endsWith(".wav")){if(this.audioLoader||(this.audioLoader=new hm),this.shouldPlay=!0,this._lastClipStartedLoading===n){Nt&&console.log("Is currently loading:",this._lastClipStartedLoading,this);return}this._lastClipStartedLoading=n,Nt&&console.log("load audio",n);const t=await this.audioLoader.loadAsync(n).catch(console.error);this._lastClipStartedLoading=null,t&&this.createAudio(t)}else console.warn("Unsupported audio clip type",n);else this.shouldPlay=!0,this.createAudio()}play(n=void 0){var t,i,s;!n&&this.clip&&(n=this.clip),n!==void 0&&typeof n!="string"&&!(n instanceof MediaStream)&&(F()&&console.warn("Called play on AudioSource with unknown argument type:",n+`
Using the assigned clip instead:`,this.clip),n=this.clip);let o=!this.sound||n&&n!==this.clip;if(typeof n=="string"&&!this.audioLoader&&(o=!0),(n instanceof MediaStream||typeof n=="string")&&(this.clip=n),o){this.shouldPlay=!0,this.onNewClip(n);return}if(this.shouldPlay=!0,this._hasEnded=!1,Nt&&console.log("play",(t=this.sound)==null?void 0:t.getVolume(),this.sound),this.sound&&!this.sound.isPlaying){const r=this.context.application.muted;r&&this.sound.setVolume(0),(i=this.gameObject)==null||i.add(this.sound),this.clip instanceof MediaStream?(this.sound.setMediaStreamSource(this.clip),this._audioElement||(this._audioElement=document.createElement("audio"),this._audioElement.style.display="none"),this._audioElement.parentNode||(s=this.context.domElement.shadowRoot)==null||s.append(this._audioElement),this._audioElement.srcObject=this.clip,this._audioElement.autoplay=!1):(this._audioElement&&this._audioElement.remove(),this.sound.play(r?.1:0))}}pause(){var n,t;Nt&&console.log("Pause",this),this._hasEnded=!0,this.shouldPlay=!1,this.sound&&this.sound.isPlaying&&this.sound.source&&(this._lastContextTime=(n=this.sound)==null?void 0:n.context.currentTime,this.sound.pause()),(t=this._audioElement)==null||t.remove()}stop(){var n,t;Nt&&console.log("Pause",this),this._hasEnded=!0,this.shouldPlay=!1,this.sound&&this.sound.source&&(this._lastContextTime=(n=this.sound)==null?void 0:n.context.currentTime,Nt&&console.log(this._lastContextTime),this.sound.stop()),(t=this._audioElement)==null||t.remove()}update(){this.helper&&(this.isPlaying&&this.helper.update(),this.helper.visible=this.isPlaying),this._needUpdateSpatialDistanceSettings&&this.applySpatialDistanceSettings(),this.sound&&!this.sound.isPlaying&&this.shouldPlay&&!this._hasEnded&&(this._hasEnded=!0,Nt&&console.log("Audio clip ended",this.clip),this.dispatchEvent(new CustomEvent("ended",{detail:this})))}};let Ne=ko;Pn([m(URL)],Ne.prototype,"clip",2),Pn([m()],Ne.prototype,"playOnAwake",2),Pn([m()],Ne.prototype,"preload",2),Pn([m()],Ne.prototype,"playInBackground",2),Pn([m()],Ne.prototype,"loop",1),Pn([m()],Ne.prototype,"spatialBlend",1),Pn([m()],Ne.prototype,"minDistance",1),Pn([m()],Ne.prototype,"maxDistance",1),Pn([m()],Ne.prototype,"volume",1),Pn([m()],Ne.prototype,"pitch",1),Pn([m()],Ne.prototype,"rollOffMode",2);const RM=C("debugavatar"),Xn=class extends A{constructor(){super(...arguments),a(this,"connectionId"),a(this,"avatar")}static getAvatar(n){return n>=0&&n<Xn.instances.length?Xn.instances[n]:null}static onAvatarMarkerCreated(n){return Xn._onNewAvatarMarkerAdded.push(n),n}static onAvatarMarkerDestroyed(n){return Xn._onAvatarMarkerDestroyed.push(n),n}awake(){Xn.instances.push(this),RM&&console.log(this);for(const n of Xn._onNewAvatarMarkerAdded)n({avatarMarker:this,gameObject:this.gameObject})}onDestroy(){Xn.instances.splice(Xn.instances.indexOf(this),1);for(const n of Xn._onAvatarMarkerDestroyed)n({avatarMarker:this,gameObject:this.gameObject})}isLocalAvatar(){return this.connectionId===this.context.connection.connectionId}};let Rt=Xn;a(Rt,"instances",[]),a(Rt,"_onNewAvatarMarkerAdded",[]),a(Rt,"_onAvatarMarkerDestroyed",[]);class Es{static Add(t,i,s=null){if(i){for(const o of this.Pois)if(o.obj===i)return;this.Pois.push({obj:i,avatar:s}),this.LastChangeTime=t.time.time}}static Remove(t,i){var s;if(i){for(const o of this.Pois)if(o.obj===i){this.Pois.splice(this.Pois.indexOf(o),1),this.LastChangeTime=t?.time.time??((s=ee.Current)==null?void 0:s.time.time);return}}}}a(Es,"Pois",[]),a(Es,"LastChangeTime",0);class TM{constructor(){a(this,"guid"),a(this,"position",new x)}}class Hc extends A{constructor(){super(...arguments),a(this,"target",null),a(this,"avatar",null),a(this,"_model",null),a(this,"_targetModel",new TM),a(this,"_currentTargetObject",null),a(this,"_lastUpdateTime",0),a(this,"_lookDuration",0),a(this,"_lastPoiChangedTime",0)}set controlledTarget(t){this.target=t;const i=k.get("MoveRandom");if(i&&this.target){const s=O.getComponent(this.target,i);s&&s.destroy()}}awake(){if(this.avatar=O.getComponentInParent(this.gameObject,Rt),this.avatar){const t=O.getComponentInParent(this.gameObject,Rt);this._model=new rg(this.context.connection,this.guid),t!=null&&t.isLocalAvatar&&this._model.requestOwnership()}this.context.connection.beginListen("avatar-look-target-changed",t=>{var i;this.target&&t&&t.guid===((i=this.avatar)==null?void 0:i.guid)&&dt(this.target,t.position)})}update(){var t;if((!this.context.connection.isConnected||(t=this._model)!=null&&t.hasOwnership)&&(Es.LastChangeTime!==this._lastPoiChangedTime&&(this._lastPoiChangedTime=Es.LastChangeTime,this._lookDuration=0),this.selectTarget(),this._currentTargetObject&&this.context.time.frameCount%10===0&&this.target)){const i=te(this._currentTargetObject);dt(this.target,i),this.context.connection.isConnected&&this.avatar&&(this.context.connection.send("avatar-look-target-changed",this._targetModel),this._targetModel.guid=this.avatar.guid,this._targetModel.position.copy(i))}}selectTarget(){if(this.context.time.time-this._lastUpdateTime>this._lookDuration){this._lastUpdateTime=this.context.time.time,this._lookDuration=Math.random()*.5+.2;const t=Es.Pois;if(t.length>0){const i=t[Math.floor(Math.random()*t.length)];if(i&&i.obj){if(i.avatar&&i.avatar===this.avatar)return;this._currentTargetObject=i.obj}}}}}var Au=(n=>(n[n.None=0]="None",n[n.DontExport=1]="DontExport",n))(Au||{});function Iw(n){return n&&n.isComponent}const EM=Symbol("object"),yf=new Oi(()=>new x,20);class jw{constructor(t,i,s,o,r,l){a(this,"_point"),a(this,"_normal"),a(this,"_tangentVelocity"),a(this,"distance"),a(this,"impulse"),a(this,"friction"),this._point=t,this.distance=i,this._normal=s,this.impulse=o,this.friction=r,this._tangentVelocity=l}get point(){return yf.get().set(this._point.x,this._point.y,this._point.z)}get normal(){return yf.get().set(this._normal.x,this._normal.y,this._normal.z)}get tangentVelocity(){return yf.get().set(this._tangentVelocity.x,this._tangentVelocity.y,this._tangentVelocity.z)}}class Lw{constructor(t,i,s){a(this,"contacts"),a(this,"me"),a(this,"_collider"),a(this,"_gameObject"),this.me=t,this._collider=i,this._gameObject=i.gameObject,this.contacts=s}get collider(){return this._collider}get gameObject(){return this._gameObject}get rigidBody(){var t;return(t=this.collider)==null?void 0:t.attachedRigidbody}}class Dw{constructor(t,i){a(this,"object"),a(this,"collider"),this.object=t,this.collider=i}}const st=C("debugnetworkingstreams");var Qn=(n=>(n.Connected="peer-user-connected",n.StreamReceived="receive-stream",n.StreamEnded="call-ended",n.Disconnected="peer-user-disconnected",n.UserJoined="user-joined",n))(Qn||{});class vf{constructor(t,i){a(this,"type","call-ended"),a(this,"userId"),a(this,"direction"),this.userId=t,this.direction=i}}class Bw{constructor(t,i,s){a(this,"type","receive-stream"),a(this,"userId"),a(this,"stream"),a(this,"target"),this.userId=t,this.stream=i,this.target=s}}class AM{constructor(t,i){a(this,"guid"),a(this,"peerId"),a(this,"dontSave",!0),this.guid=t.id,this.peerId=i}}var Fw=(n=>(n.Incoming="incoming",n.Outgoing="outgoing",n))(Fw||{});class IM extends dm{constructor(t,i,s,o=null){super(),a(this,"peerId"),a(this,"userId"),a(this,"direction"),a(this,"call"),a(this,"_stream",null),a(this,"_isDisposed",!1),this.peerId=i.peer,this.userId=t,this.call=i,this.direction=s,this._stream=o,i.on("stream",r=>{if(st&&console.log("Receive stream",`
Audio:`,r.getAudioTracks(),`
Video:`,r.getVideoTracks()),this._stream=r,s==="incoming"){const l=new Bw(t,r,this);this.dispatchEvent(l)}}),i.on("close",()=>{this.dispatchEvent(new vf(t,s))})}get stream(){return this._stream}close(){this._isDisposed||(this._isDisposed=!0,this.call.close(),Yn(this._stream))}get isOpen(){var t;return((t=this.call.peerConnection)==null?void 0:t.connectionState)==="connected"}get isOpening(){var t;return((t=this.call.peerConnection)==null?void 0:t.connectionState)==="connecting"}get isClosed(){return!this.isOpen||this._isDisposed}}function zw(n){return n=n.replace("a=fmtp:111 minptime=10;useinbandfec=1","a=fmtp:111 ptime=5;useinbandfec=1;stereo=1;maxplaybackrate=48000;maxaveragebitrat=128000;sprop-stereo=1"),n}const $c=class extends dm{constructor(n,t){super(),a(this,"updateCalls",()=>{var i;for(let s=this._incomingCalls.length-1;s>=0;s--){const o=this._incomingCalls[s];o.isClosed&&!o.isOpening&&this._incomingCalls.splice(s,1)}for(let s=this._outgoingCalls.length-1;s>=0;s--){const o=this._outgoingCalls[s];let r=!1;o.isClosed&&!o.isOpening&&((i=o.stream)!=null&&i.active?st&&console.warn("!!! Stream is still active, don't remove call",o.userId,"Your id: "+this.context.connection.connectionId):(st&&console.warn("!!! Remove closed call",o.userId),r=!0)),this.context.connection.userIsInRoom(o.userId)===!1&&(st&&console.warn("!!! User is not in room anymore, remove call",o.userId),r=!0),r&&(o.close(),this._outgoingCalls.splice(s,1))}}),a(this,"id"),a(this,"context"),a(this,"_incomingCalls",[]),a(this,"_outgoingCalls",[]),a(this,"_peer"),a(this,"_enabled",!1),a(this,"_enabledPeer",!1),a(this,"onConnectRoomFn",this.onConnectRoom.bind(this)),a(this,"onPeerConnect",i=>{if(st&&console.log("PEER opened as",i),i===null){console.error("Peer connection failed",i);return}this.context.connection.send("peer-user-connected",new AM(this,i))}),a(this,"onPeerClose",()=>{st&&console.log("PEER closed"),this.updateCalls()}),a(this,"onPeerDisconnected",()=>{st&&console.log("PEER disconnected"),this.updateCalls()}),a(this,"onPeerError",i=>{st&&console.error("PEER error",i)}),a(this,"onPeerReceivingCall",i=>{i.answer(void 0,{sdpTransform:s=>zw(s)}),this.registerCall(i,"incoming",null)}),this.context=n,this.id=t,this.setupPeer(),navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia}static getOrCreate(n,t){if($c.instances.has(t))return $c.instances.get(t);const i=new $c(n,t);return $c.instances.set(t,i),i}getMyPeerId(){if(this.context.connection.connectionId)return this.getPeerIdFromUserId(this.context.connection.connectionId)}getPeerIdFromUserId(n){return this.id+"-"+n}getUserIdFromPeerId(n){return n.substring(this.id.length+1)}makeCall(n,t){var i;if(!(t!=null&&t.id)){st?console.warn("Can not make a call: mediastream has no id or is undefined"):console.debug("Can not make a call: mediastream has no id or is undefined");return}const s={metadata:{userId:this.context.connection.connectionId,streamId:t.id},sdpTransform:r=>zw(r)},o=(i=this._peer)==null?void 0:i.call(n,t,s);if(o){const r=this.registerCall(o,"outgoing",t);return st&&console.warn(`\u{1F4DE} CALL ${n}`,`
Outgoing:`,this._outgoingCalls,`
Incoming:`,this._incomingCalls),r}else st&&console.error("Failed to make call",n,t,this._peer)}closeAll(){for(const n of this._incomingCalls)n.close();for(const n of this._outgoingCalls)n.close();this.updateCalls()}get peer(){return this._peer}get incomingCalls(){return this._incomingCalls}enable(){this._enabled||(this._enabled=!0,this.context.connection.beginListen(ne.JoinedRoom,this.onConnectRoomFn),this.subscribePeerEvents())}disable(){this._enabled&&(this._enabled=!1,this.context.connection.stopListen(ne.JoinedRoom,this.onConnectRoomFn),this.unsubscribePeerEvents())}onConnectRoom(){this.setupPeer()}setupPeer(){if(this.context.connection.connectionId&&!this._enabledPeer){if(this._enabledPeer=!0,!this._peer){const n=this.getMyPeerId();n?this._peer=xb(n):console.error("Failed to setup peerjs because we dont have a connection id",this.context.connection.connectionId)}this._enabled&&this.subscribePeerEvents()}}subscribePeerEvents(){this._peer&&(this._peer.on("open",this.onPeerConnect),this._peer.on("close",this.onPeerClose),this._peer.on("call",this.onPeerReceivingCall),this._peer.on("disconnected",this.onPeerDisconnected),this._peer.on("error",this.onPeerError))}unsubscribePeerEvents(){this._peer&&(this._peer.off("open",this.onPeerConnect),this._peer.off("close",this.onPeerClose),this._peer.off("call",this.onPeerReceivingCall),this._peer.off("disconnected",this.onPeerDisconnected),this._peer.off("error",this.onPeerError))}registerCall(n,t,i){const s=n.metadata;(!s||!s.userId)&&console.error("Missing call metadata",n);const o=s.userId;t==="incoming"&&st?console.warn("\u2190 Receive call from",n.metadata,n.connectionId):st&&console.warn("\u2192 Make call to",n.metadata);const r=t==="incoming"?this._incomingCalls:this._outgoingCalls,l=new IM(o,n,t,i);return r.push(l),n.on("error",c=>{console.error("Call error",c)}),n.on("close",()=>{st&&console.log("Call ended",n.metadata);const c=r.indexOf(l);c!==-1&&r.splice(c,1),l.close(),this.dispatchEvent(new vf(o,t))}),l.addEventListener("call-ended",c=>{this.dispatchEvent(c)}),t==="incoming"&&(l.addEventListener("receive-stream",c=>{this.dispatchEvent(c)}),n.on("stream",()=>{st&&console.log("Received stream for call",n.metadata);let c=0;const h=setInterval(()=>{const d=c===0;!l.isOpen&&d&&(st&&console.warn("Close call because stream is not active",n.metadata),c+=1,clearInterval(h),l.close())},2e3)})),l}};let Gc=$c;a(Gc,"instances",new Map);class id extends dm{constructor(t,i){if(super(),a(this,"context"),a(this,"peer"),a(this,"_sendingStreams",new Map),a(this,"debug",!1),a(this,"_enabled",!1),a(this,"_tickIntervalId"),a(this,"tick",()=>{this.updateSendingCalls()}),a(this,"onJoinedRoom",s=>{this._sendingStreams.size>0&&(this.debug&&console.warn(`${s!=null&&s.userId?`User ${s.userId}`:"You"} joined room`,s,this._sendingStreams.size),this.updateSendingCalls())}),a(this,"onLeftRoom",s=>{this.debug&&console.warn(`${s?.userId||"You"} left room`,s),this.stopCallsToUsersThatAreNotInTheRoomAnymore(),this.peer.closeAll()}),a(this,"onCallStreamReceived",s=>{this.debug&&console.log("Call with "+s.userId+" started"),this.dispatchEvent({type:"receive-stream",target:this,stream:s.stream,userId:s.userId}),this.debug&&this.debugLogCurrentState()}),a(this,"onCallEnded",s=>{this.debug&&console.log("Call with "+s.userId+" ended"),this.dispatchEvent(s),this.debug&&this.debugLogCurrentState()}),a(this,"onUserConnected",s=>{if(this.peer.id===s.guid){this.debug&&console.log("PEER USER CONNECTED",s.guid,s,this._sendingStreams.size);const o=this._sendingStreams.keys().next().value;this.peer.makeCall(s.peerId,o)}else st&&console.log("Unknown user connected",s.guid,s.peerId)}),a(this,"onUserLeft",s=>{this.debug&&console.log("User left room: "+s.userId),this.stopCallsToUsersThatAreNotInTheRoomAnymore()}),Iw(t)){const s=t;t=s.context,i=Gc.getOrCreate(s.context,s.guid)}else typeof i=="string"&&(i=Gc.getOrCreate(t,i));if(t){if(!(t instanceof ee))throw new Error("Failed to create NetworkedStreams because context is not an instance of Context")}else throw new Error("Failed to create NetworkedStreams because context is undefined");if(!i)throw new Error("Failed to create NetworkedStreams because peer is undefined");this.context=t,this.peer=i,st&&(this.debug=!0)}static create(t,i){const s=Gc.getOrCreate(t.context,i||t.context.connection.connectionId||t.guid);return new id(t.context,s)}startSendingStream(t){this._sendingStreams.has(t)?console.warn("Received start sending stream with stream that is already being sent"):(this._sendingStreams.set(t,[]),this.updateSendingCalls())}stopSendingStream(t){if(t){const i=this._sendingStreams.get(t);if(i){for(const s of i)s.close();i.length=0}this._sendingStreams.delete(t),i&&this.debug&&this.debugLogCurrentState()}this.updateSendingCalls()}get enabled(){return this._enabled}enable(){this._enabled||(this._enabled=!0,this.peer.enable(),this.peer.addEventListener("receive-stream",this.onCallStreamReceived),this.peer.addEventListener("call-ended",this.onCallEnded),this.context.connection.beginListen("peer-user-connected",this.onUserConnected),this.context.connection.beginListen(ne.JoinedRoom,this.onJoinedRoom),this.context.connection.beginListen(ne.UserJoinedRoom,this.onJoinedRoom),this.context.connection.beginListen(ne.UserLeftRoom,this.onUserLeft),this.context.connection.beginListen(ne.LeftRoom,this.onLeftRoom),this._tickIntervalId=setInterval(this.tick,5e3))}disable(){this._enabled&&(this._enabled=!1,this.peer.disable(),this.peer.removeEventListener("receive-stream",this.onCallStreamReceived),this.peer.removeEventListener("call-ended",this.onCallEnded),this.context.connection.stopListen("peer-user-connected",this.onUserConnected),this.context.connection.stopListen(ne.JoinedRoom,this.onJoinedRoom),this.context.connection.stopListen(ne.UserJoinedRoom,this.onJoinedRoom),this.context.connection.stopListen(ne.UserLeftRoom,this.onUserLeft),this.context.connection.stopListen(ne.LeftRoom,this.onLeftRoom),this._tickIntervalId!=null&&(clearInterval(this._tickIntervalId),this._tickIntervalId=void 0))}updateSendingCalls(){const t=this.context.connection.connectionId;for(const i of this._sendingStreams.keys()){const s=this._sendingStreams.get(i)||[];for(const o of this.context.connection.usersInRoom()){if(o===t)continue;const r=this.peer.getPeerIdFromUserId(o);if(s.find(l=>{var c;return l.peerId===r&&l.direction==="outgoing"&&!l.isClosed&&((c=l.stream)==null?void 0:c.active)}))st&&console.debug("Already have a call with user "+o+" / peer "+r);else{const l=this.peer.makeCall(r,i);l&&s.push(l)}}this._sendingStreams.set(i,s)}this.stopCallsToUsersThatAreNotInTheRoomAnymore()}stopCallsToUsersThatAreNotInTheRoomAnymore(){for(const t of this._sendingStreams.keys()){const i=this._sendingStreams.get(t);if(i)for(let s=i.length-1;s>=0;s--){const o=i[s];this.context.connection.userIsInRoom(o.userId)?st&&(this.context.connection.connectionId===o.userId?console.warn(`You are still in the room [${s}] ${o.userId}`):console.log(`User is still in room [${s}] ${o.userId}`)):(st&&console.log(`Remove call ${[s]} to user that is not in room anymore ${o.userId}`),o.close(),i.splice(s,1))}}this.peer.updateCalls(),this.debug&&this.debugLogCurrentState()}debugLogCurrentState(){console.warn(`You (${this.context.connection.connectionId}) are currently sending ${this._sendingStreams.size} and receiving ${this.peer.incomingCalls.length} calls (${this.peer.incomingCalls.map(t=>t.userId).join(", ")})`,this.peer.incomingCalls)}}function Yn(n){if(n&&n instanceof MediaStream)for(const t of n.getTracks())t.stop()}var jM=Object.defineProperty,LM=Object.getOwnPropertyDescriptor,bf=(n,t,i,s)=>{for(var o=s>1?void 0:s?LM(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&jM(t,i,o),o};const DM="noVoip",BM=C("debugvoip");class Mo extends A{constructor(){super(...arguments),a(this,"autoConnect",!0),a(this,"runInBackground",!0),a(this,"createMenuButton",!0),a(this,"debug",!1),a(this,"_net"),a(this,"_menubutton"),a(this,"_allowSending",!0),a(this,"_outputStream",null),a(this,"onJoinedRoom",async()=>{this.debug&&console.log("VOIP: Joined room"),await yn(300),this.autoConnect&&!this.isSending&&this._allowSending&&this.connect()}),a(this,"onLeftRoom",()=>{this.debug&&console.log("VOIP: Left room"),this.disconnect();for(const t of this._incomingStreams.values())Yn(t.srcObject);this._incomingStreams.clear()}),a(this,"_incomingStreams",new Map),a(this,"onReceiveStream",t=>{const i=t.target.userId,s=t.stream;let o=this._incomingStreams.get(i);o||(o=new Audio,this._incomingStreams.set(i,o)),o.srcObject=s,o.setAttribute("autoplay","true"),Ps.registerWaitForInteraction(()=>{o?.play().catch(r=>{console.error("VOIP: Failed to play audio",r)})})}),a(this,"onStreamEnded",t=>{const i=this._incomingStreams.get(t.userId);Yn(i?.srcObject),this._incomingStreams.delete(t.userId)}),a(this,"onEnabledChanged",()=>{for(const t of this._incomingStreams){const i=t[1];i.muted=!this.enabled}}),a(this,"onVisibilityChanged",()=>{if(this.runInBackground)return;const t=document.visibilityState!=="visible";this.setMuted(t);for(const i of this._incomingStreams){const s=i[1];s.muted=t}})}awake(){BM&&(this.debug=!0),this.debug&&(console.log("VOIP debugging: press 'v' to toggle mute or 'c' to toggle connect/disconnect"),window.addEventListener("keydown",async t=>{switch(t.key.toLowerCase()){case"v":console.log("MUTE?",!this.isMuted),this.setMuted(!this.isMuted);break;case"c":this.isSending?this.disconnect():this.connect();break}}),window.addEventListener("blur",()=>{console.log("VOIP: MUTE ON BLUR"),this.setMuted(!0)}),window.addEventListener("focus",()=>{console.log("VOIP: UNMUTE ON FOCUS"),this.setMuted(!1)}))}onEnable(){this._net||(this._net=id.create(this)),this.debug&&(this._net.debug=!0),this._net.addEventListener(Qn.StreamReceived,this.onReceiveStream),this._net.addEventListener(Qn.StreamEnded,this.onStreamEnded),this._net.enable(),this.autoConnect&&this.context.connection.isConnected&&this.connect(),this.context.connection.beginListen(ne.JoinedRoom,this.onJoinedRoom),this.context.connection.beginListen(ne.LeftRoom,this.onLeftRoom),this.onEnabledChanged(),this.updateButton(),window.addEventListener("visibilitychange",this.onVisibilityChanged)}onDisable(){var t;this._net&&(this._net.stopSendingStream(this._outputStream),this._net.removeEventListener(Qn.StreamReceived,this.onReceiveStream),this._net.removeEventListener(Qn.StreamEnded,this.onStreamEnded),(t=this._net)==null||t.disable()),this.context.connection.stopListen(ne.JoinedRoom,this.onJoinedRoom),this.context.connection.stopListen(ne.LeftRoom,this.onLeftRoom),this.onEnabledChanged(),this.updateButton(),window.removeEventListener("visibilitychange",this.onVisibilityChanged)}onDestroy(){var t;(t=this._menubutton)==null||t.remove(),this._menubutton=void 0}get isSending(){return this._outputStream!=null&&this._outputStream.active}async connect(t){var i,s;if(!this._net)return console.error("Cannot connect to voice chat - NetworkedStreams not initialized. Make sure the component is enabled before calling this method."),!1;if(this.context.connection.isConnected){if(!await Q.microphonePermissionsGranted())return console.error("Cannot connect to voice chat - microphone permissions not granted"),this.updateButton(),!1}else return console.error("Cannot connect to voice chat - not connected to server"),this.updateButton(),!1;return this._allowSending=!0,(i=this._net)==null||i.stopSendingStream(this._outputStream),Yn(this._outputStream),this._outputStream=await this.getAudioStream(t),this._outputStream?(this.debug&&console.log("VOIP: Got audio stream"),(s=this._net)==null||s.startSendingStream(this._outputStream),this.updateButton(),!0):(this.updateButton(),await Q.microphonePermissionsGranted()?console.error("VOIP: Could not get audio stream - please make sure to connect an audio device and grant microphone permissions"):rc("Microphone permissions not granted: Please grant microphone permissions to use voice chat"),(this.debug||F())&&console.log("VOIP: Failed to get audio stream"),!1)}disconnect(t){var i;t!=null&&t.remember&&(this._allowSending=!1),(i=this._net)==null||i.stopSendingStream(this._outputStream),Yn(this._outputStream),this._outputStream=null,this.updateButton()}setMuted(t){var i;const s=(i=this._outputStream)==null?void 0:i.getAudioTracks();if(s)for(const o of s)o.enabled=!t}get isMuted(){var t;if(this._outputStream===null)return!1;const i=(t=this._outputStream)==null?void 0:t.getAudioTracks();if(i){for(const s of i)if(!s.enabled)return!0}return!1}async updateButton(){var t;if(this.createMenuButton){if(this._menubutton||(this._menubutton=document.createElement("button"),this._menubutton.addEventListener("click",()=>{this.isSending?this.disconnect({remember:!0}):this.connect(),Q.microphonePermissionsGranted().then(i=>{i||we("<strong>Microphone permissions not granted</strong>. Please allow your browser to use the microphone to be able to talk. Click on the button on the left side of your browser's address bar to allow microphone permissions.")})})),this._menubutton){this.context.menu.appendChild(this._menubutton),this.activeAndEnabled?this._menubutton.style.display="":this._menubutton.style.display="none",this._menubutton.title=this.isSending?"Click to disable your microphone":"Click to enable your microphone";let i=(this.isSending,""),s=this.isSending?"mic":"mic_off";await Q.microphonePermissionsGranted()||(i="No Permission",s="mic_off",this._menubutton.title="Microphone permissions not granted. Please allow your browser to use the microphone to be able to talk. This can usually be done in the addressbar of the webpage."),this._menubutton.innerText=i,this._menubutton.prepend(Pt(s)),this.context.connection.isConnected==!1?this._menubutton.setAttribute("disabled",""):this._menubutton.removeAttribute("disabled")}}else this.activeAndEnabled||(t=this._menubutton)==null||t.remove()}getFrequency(t){return this.unsupported_getfrequency||(this.unsupported_getfrequency=!0,F()&&we("VOIP: getFrequency is currently not supported"),console.warn("VOIP: getFrequency is currently not supported")),null}async getAudioStream(t){if(!navigator.mediaDevices.getUserMedia)return console.error("No getDisplayMedia support"),null;const i=async o=>await navigator.mediaDevices.getUserMedia({audio:o??!0,video:!1}).catch(r=>(console.warn("VOIP failed getting audio stream",r),null)),s=await i(t);if(!s)return null;if(Q.isiOS()&&t?.deviceId===void 0){const o=(await navigator.mediaDevices.enumerateDevices()).find(r=>(r.kind==="audioinput"||r.kind==="audiooutput")&&!r.label.includes("iPhone"));if(o){const r=Object.assign({},t);return r.deviceId=o.deviceId,await i(r)}}return s}}bf([m()],Mo.prototype,"autoConnect",2),bf([m()],Mo.prototype,"runInBackground",2),bf([m()],Mo.prototype,"createMenuButton",2);var FM=Object.defineProperty,zM=Object.getOwnPropertyDescriptor,Uw=(n,t,i,s)=>{for(var o=s>1?void 0:s?zM(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&FM(t,i,o),o};const UM=C("debugmouth");class qc extends A{constructor(){super(...arguments),a(this,"idle",[]),a(this,"talking",[]),a(this,"marker",null),a(this,"voip",null),a(this,"lastMouthChangeTime",0),a(this,"mouthChangeLength",0)}awake(){setTimeout(()=>{this.voip=O.findObjectOfType(Mo,this.context),this.marker||(this.marker=O.getComponentInParent(this.gameObject,Rt))},3e3)}update(){var t;if(!this.voip||this.context.time.frameCount%10!==0)return;let i=((t=this.marker)==null?void 0:t.connectionId)??null;if(!i){UM&&(i=null);return}const s=this.voip.getFrequency(i)??0;this.updateLips(s)}updateLips(t){if(this.context.time.time-this.lastMouthChangeTime>this.mouthChangeLength){if(this.mouthChangeLength=.05+Math.random()*.1,this.talking&&this.talking.length>0&&t>30){this.lastMouthChangeTime=this.context.time.time;const i=Math.floor(Math.random()*this.talking.length);this.setMouthShapeActive(this.talking,i)}else if(this.idle.length>0&&this.context.time.time-this.lastMouthChangeTime>.5){this.lastMouthChangeTime=this.context.time.time;const i=Math.floor(Math.random()*this.idle.length);this.setMouthShapeActive(this.idle,i)}}}setMouthShapeActive(t,i){if(t){t!=this.idle?this.idle.map(s=>s.visible=!1):this.talking.map(s=>s.visible=!1);for(let s=0;s<t.length;s++){const o=t[s];o&&(o.visible=s===i)}}}}Uw([m(j)],qc.prototype,"idle",2),Uw([m(j)],qc.prototype,"talking",2);class _f extends A{constructor(){super(...arguments),a(this,"voip",null),a(this,"marker",null),a(this,"_startPosition",null)}awake(){this.voip=O.findObjectOfType(Mo,this.context),this.marker=O.getComponentInParent(this.gameObject,Rt)}update(){if(!this.voip||!this.marker||this.context.time.frameCount%10!==0)return;const t=this.marker.connectionId,i=this.voip.getFrequency(t);if(i==null)return;this._startPosition||(this._startPosition=this.gameObject.position.clone());const s=i/100;this.gameObject.position.y=this._startPosition.y+s*.07}}var NM=Object.defineProperty,WM=Object.getOwnPropertyDescriptor,VM=(n,t,i,s)=>{for(var o=s>1?void 0:s?WM(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&NM(t,i,o),o};const Ga=C("debugxrflags"),Nw=C("disablexrflags");Nw&&console.warn("XRFlags are disabled");var Zn=(n=>(n[n.Never=0]="Never",n[n.Browser=1]="Browser",n[n.AR=2]="AR",n[n.VR=4]="VR",n[n.FirstPerson=8]="FirstPerson",n[n.ThirdPerson=16]="ThirdPerson",n[n.All=4294967295]="All",n))(Zn||{});const Ww=class{constructor(){a(this,"Mask",17)}Has(n){return(this.Mask&n)!==0}Set(n){Ga&&console.warn("Set XR flag state to",n),this.Mask=n,Ii.Apply()}Enable(n){this.Mask|=n,Ii.Apply()}Disable(n){this.Mask&=~n,Ii.Apply()}Toggle(n){this.Mask^=n,Ii.Apply()}EnableAll(){this.Mask=-1,Ii.Apply()}DisableAll(){this.Mask=0,Ii.Apply()}};let ci=Ww;a(ci,"Global",new Ww);var Xc;const As=(Xc=class extends A{constructor(){super(...arguments),a(this,"visibleIn")}static Apply(){for(const n of this.registry)n.UpdateVisible(ci.Global)}awake(){As.registry.push(this)}onEnable(){As.firstApply?this.UpdateVisible(ci.Global):(As.firstApply=!0,As.Apply())}onDestroy(){const n=As.registry.indexOf(this);n>=0&&As.registry.splice(n,1)}get isOn(){return this.gameObject.visible}UpdateVisible(n=null){if(Nw)return;let t;const i=n;if(i&&typeof i=="number"&&(console.assert(typeof i=="number","XRFlag.UpdateVisible: state must be a number",i),Ga&&console.log(i),As.buffer.Mask=i,n=As.buffer),n instanceof ci?(Ga&&console.warn(this.name,"use passed in mask",n.Mask,this.visibleIn),t=n.Has(this.visibleIn)):(Ga&&console.log(this.name,"use global mask"),ci.Global.Has(this.visibleIn)),t!==void 0)if(t)Ga&&console.log(this.name,"is visible",this.gameObject.uuid),O.setActive(this.gameObject,!0);else{if(Ga&&console.log(this.name,"is not visible",this.gameObject.uuid),!this.gameObject.visible)return;this.gameObject.visible=!1}}},a(Xc,"registry",[]),a(Xc,"firstApply"),a(Xc,"buffer",new ci),Xc);let Ii=As;VM([m()],Ii.prototype,"visibleIn",2);var HM=Object.defineProperty,$M=Object.getOwnPropertyDescriptor,Iu=(n,t,i,s)=>{for(var o=s>1?void 0:s?$M(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&HM(t,i,o),o};class Er extends A{constructor(){super(...arguments),a(this,"eyes",[]),a(this,"lastBlinkTime",0),a(this,"blinkLength",0),a(this,"eyesOpen",!0),a(this,"state",null)}awake(){this.state=O.getComponentInParent(this.gameObject,Ii)}update(){if(!(!this.gameObject||!this.gameObject.visible||!this.eyes||!Array.isArray(this.eyes)||this.eyes.length===0)&&this.context.time.time-this.lastBlinkTime>this.blinkLength){if(this.lastBlinkTime=this.context.time.time,this.state&&!this.state.isOn||!this.activeAndEnabled)return;if(this.eyesOpen=!this.eyesOpen,this.blinkLength=Math.random(),this.eyesOpen?(this.blinkLength*=3,this.blinkLength+=.5,Math.random()<.1&&(this.blinkLength=.1+Math.random()*.2)):(this.blinkLength*=Math.random()*.2,this.blinkLength+=.1),Math.random()<.1&&(this.blinkLength*=3),this.blinkLength=Math.max(.2,this.blinkLength),this.blinkLength=Math.min(3,this.blinkLength),this.eyes)for(const t of this.eyes)t&&(t.visible=this.eyesOpen)}}}Iu([m(j)],Er.prototype,"eyes",2),Iu([m()],Er.prototype,"lastBlinkTime",2),Iu([m()],Er.prototype,"blinkLength",2),Iu([m()],Er.prototype,"eyesOpen",2);var GM=Object.defineProperty,qM=Object.getOwnPropertyDescriptor,wf=(n,t,i,s)=>{for(var o=s>1?void 0:s?qM(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&GM(t,i,o),o},xf;const Vw=(xf=class extends A{constructor(){super(...arguments),a(this,"head",null),a(this,"eyes",null),a(this,"target",null),a(this,"brain",null),a(this,"vec",new x),a(this,"currentTargetPoint",new x)}awake(){this.brain||(this.brain=O.getComponentInParent(this.gameObject,Hc)),this.brain||(this.brain=O.addComponent(this.gameObject,Hc)),this.brain&&this.target&&(this.brain.controlledTarget=this.target)}update(){const n=this.target;if(n&&this.head){const t=this.eyes;if(t){const i=te(n);this.currentTargetPoint.lerp(i,this.context.time.deltaTime/.1);const s=te(this.head),o=this.vec.copy(this.currentTargetPoint).sub(s).normalize();if(o.length()<.1)return;const r=Vw.forward;if(r.set(0,0,1),r.applyQuaternion(Ce(this.head)),r.dot(o)>.45)for(let l=0;l<t.length;l++)t[l].lookAt(this.currentTargetPoint)}}}},a(xf,"forward",new x(0,0,1)),xf);let qa=Vw;wf([m(j)],qa.prototype,"head",2),wf([m(j)],qa.prototype,"eyes",2),wf([m(j)],qa.prototype,"target",2);var XM=Object.defineProperty,QM=Object.getOwnPropertyDescriptor,Sf=(n,t,i,s)=>{for(var o=s>1?void 0:s?QM(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&XM(t,i,o),o};class Xa extends A{constructor(){super(...arguments),a(this,"length",1),a(this,"depthTest",!0),a(this,"isGizmo",!1),a(this,"_axes",null)}onEnable(){if(this.isGizmo&&!xc)return;this._axes||(this._axes=new Si(this.length)),this._axes.layers.disableAll(),this._axes.layers.set(this.layer),this.gameObject.add(this._axes);const t=this._axes.material;t&&t.depthTest!==void 0&&(t.depthTest=this.depthTest)}onDisable(){this._axes&&this.gameObject.remove(this._axes)}}Sf([m()],Xa.prototype,"length",2),Sf([m()],Xa.prototype,"depthTest",2),Sf([m()],Xa.prototype,"isGizmo",2);class Cf extends A{constructor(){super(...arguments),a(this,"from"),a(this,"to"),a(this,"hint"),a(this,"desiredDistance",1)}onEnable(){}update(){if(!this.from||!this.to||!this.hint)return;const t=te(this.to).clone(),i=te(this.from).clone(),s=t.distanceTo(i),o=t.clone();o.sub(i);const r=i.clone();r.add(t),r.multiplyScalar(.5);const l=te(this.hint).clone();l.sub(r);const c=new x;c.crossVectors(l,o),c.crossVectors(o,c),c.normalize();const h=s*.5,d=Math.max(this.desiredDistance,h),u=Math.sqrt(d*d-h*h),p=c.clone();p.multiplyScalar(u),p.add(r),dt(this.gameObject,p);const g=r.clone();g.sub(c),this.gameObject.lookAt(g)}}const YM=C("gizmos"),ZM=C("debugboxhelper"),Kn=class extends A{constructor(){super(...arguments),a(this,"box",null),a(this,"_lastMatrixUpdateFrame",-1),a(this,"_helper",null),a(this,"_color",null)}isInBox(n){var t;if(!n)return;if(this.box||(this.box=new xi),oi([n],void 0,void 0,Kn.testBox),Kn.testBox.isEmpty()){const s=te(n,Kn._position);Kn.testBox.setFromCenterAndSize(s,Kn._emptyObjectSize)}this.updateBox();const i=(t=this.box)==null?void 0:t.intersectsBox(Kn.testBox);return i&&ZM&&G.DrawWireBox3(Kn.testBox,16711680,5),i}intersects(n){return n?this.updateBox(!1).intersectsBox(n):!1}updateBox(n=!1){if(this.box||(this.box=new xi),n||this.context.time.frameCount!=this._lastMatrixUpdateFrame){const t=this._lastMatrixUpdateFrame<0;this._lastMatrixUpdateFrame=this.context.time.frameCount;const i=t,s=te(this.gameObject,Kn._position,i),o=Ye(this.gameObject,Kn._size);this.box.setFromCenterAndSize(s,o)}return this.box}awake(){this._helper=null,this._color=null,this.box=null}showHelper(n=null,t=!1){var i;if(!(!YM&&!t)){if(this._helper){n&&((i=this._color)==null||i.set(n)),this.gameObject.add(this._helper);return}this._helper=gg(n),this.gameObject.add(this._helper)}}};let Ki=Kn;a(Ki,"testBox",new xi),a(Ki,"_position",new x),a(Ki,"_size",new x(.01,.01,.01)),a(Ki,"_emptyObjectSize",new x(.01,.01,.01));var KM=Object.defineProperty,JM=Object.getOwnPropertyDescriptor,hi=(n,t,i,s)=>{for(var o=s>1?void 0:s?JM(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&KM(t,i,o),o};class di extends A{constructor(){super(...arguments),a(this,"attachedRigidbody",null),a(this,"isTrigger",!1),a(this,"sharedMaterial"),a(this,"membership",[0]),a(this,"filter"),a(this,"updateProperties",()=>{var t;(t=this.context.physics.engine)==null||t.updateProperties(this)})}get isCollider(){return!0}awake(){super.awake(),this.attachedRigidbody||(this.attachedRigidbody=this.gameObject.getComponentInParent(ye))}start(){this.attachedRigidbody||(this.attachedRigidbody=this.gameObject.getComponentInParent(ye))}onEnable(){this.attachedRigidbody||(this.attachedRigidbody=this.gameObject.getComponentInParent(ye))}onDisable(){var t;(t=this.context.physics.engine)==null||t.removeBody(this)}get body(){var t;return(t=this.context.physics.engine)==null?void 0:t.getBody(this)}updatePhysicsMaterial(){var t;(t=this.context.physics.engine)==null||t.updatePhysicsMaterial(this)}}hi([m(ye)],di.prototype,"attachedRigidbody",2),hi([m()],di.prototype,"isTrigger",2),hi([m()],di.prototype,"sharedMaterial",2),hi([m()],di.prototype,"membership",2),hi([m()],di.prototype,"filter",2);class Qa extends di{constructor(){super(...arguments),a(this,"radius",.5),a(this,"center",new x(0,0,0))}onEnable(){var t;super.onEnable(),(t=this.context.physics.engine)==null||t.addSphereCollider(this),gd(this.gameObject.scale,this.updateProperties)}onDisable(){super.onDisable(),Pm(this.gameObject.scale,this.updateProperties)}onValidate(){this.updateProperties()}}hi([Mt(),m()],Qa.prototype,"radius",2),hi([m(x)],Qa.prototype,"center",2);const Hw=class extends di{constructor(){super(...arguments),a(this,"size",new x(1,1,1)),a(this,"center",new x(0,0,0))}static add(n,t){const i=Ri(n,Hw);return i.autoFit(),t?.rigidbody===!0&&Ri(n,ye,{isKinematic:!1}),i}onEnable(){var n;super.onEnable(),(n=this.context.physics.engine)==null||n.addBoxCollider(this,this.size),gd(this.gameObject.scale,this.updateProperties)}onDisable(){super.onDisable(),Pm(this.gameObject.scale,this.updateProperties)}onValidate(){this.updateProperties()}autoFit(n){const t=this.gameObject,i=t.position.clone(),s=t.quaternion.clone(),o=t.scale.clone(),r=t.parent;t.position.set(0,0,0),t.quaternion.set(0,0,0,1),t.scale.set(1,1,1),t.parent=null,t.updateMatrix();const l=oi([t]);t.position.copy(i),t.quaternion.copy(s),t.scale.copy(o),t.parent=r,n?.debug===!0&&G.DrawWireBox3(l,16768256,20),this.size=l.getSize(new x)||new x(1,1,1),this.center=l.getCenter(new x)||new x(0,0,0),this.size.length()<=0&&this.size.set(.01,.01,.01)}};let Ya=Hw;hi([Mt(),m(x)],Ya.prototype,"size",2),hi([m(x)],Ya.prototype,"center",2);class Ro extends di{constructor(){super(...arguments),a(this,"sharedMesh"),a(this,"convex",!1)}onEnable(){var t,i,s;if(super.onEnable(),!this.context.physics.engine)return;(t=this.sharedMesh)!=null&&t.isMesh||(this.gameObject instanceof X||this.gameObject instanceof so)&&(this.sharedMesh=this.gameObject);const o=0;if((i=this.sharedMesh)!=null&&i.isMesh)this.context.physics.engine.addMeshCollider(this,this.sharedMesh,this.convex),it.assignMeshLOD(this.sharedMesh,o).then(r=>{r&&this.activeAndEnabled&&this.context.physics.engine&&this.sharedMesh&&(this.context.physics.engine.removeBody(this),this.sharedMesh.geometry=r,this.context.physics.engine.addMeshCollider(this,this.sharedMesh,this.convex))});else{const r=this.sharedMesh;if(r!=null&&r.isGroup){console.warn(`MeshCollider mesh is a group "${((s=this.sharedMesh)==null?void 0:s.name)||this.gameObject.name}", adding all children as colliders. This is currently not fully supported (colliders can not be removed from world again)`,this);const l=new Array;for(const c in r.children){const h=r.children[c];h.isMesh&&(this.context.physics.engine.addMeshCollider(this,h,this.convex),l.push(it.assignMeshLOD(h,o)))}Promise.all(l).then(c=>{var h,d;if(c.some(p=>p)==!1)return;(h=this.context.physics.engine)==null||h.removeBody(this);const u=new X;for(const p of c)p&&this.activeAndEnabled&&(u.geometry=p,(d=this.context.physics.engine)==null||d.addMeshCollider(this,u,this.convex))})}else(F()||C("showcolliders"))&&console.warn(`[MeshCollider] A MeshCollider mesh is assigned to an unknown object on "${this.gameObject.name}", but it's neither a Mesh nor a Group. Please double check that you attached the collider component to the right object and report a bug otherwise!`,this)}}}hi([m(X)],Ro.prototype,"sharedMesh",2),hi([m()],Ro.prototype,"convex",2);class Is extends di{constructor(){super(...arguments),a(this,"center",new x(0,0,0)),a(this,"radius",.5),a(this,"height",2)}onEnable(){var t;super.onEnable(),(t=this.context.physics.engine)==null||t.addCapsuleCollider(this,this.height,this.radius)}}hi([m(x)],Is.prototype,"center",2),hi([m()],Is.prototype,"radius",2),hi([m()],Is.prototype,"height",2);var eR=Object.defineProperty,tR=Object.getOwnPropertyDescriptor,js=(n,t,i,s)=>{for(var o=s>1?void 0:s?tR(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&eR(t,i,o),o};const $w=C("debugcharactercontroller");class Ar extends A{constructor(){super(...arguments),a(this,"center",new x(0,0,0)),a(this,"radius",.5),a(this,"height",2),a(this,"_rigidbody",null),a(this,"_activeGroundCollisions"),a(this,"_contactVelocity",new x)}get rigidbody(){return this._rigidbody?this._rigidbody:(this._rigidbody=this.gameObject.getComponent(ye),this._rigidbody||(this._rigidbody=this.gameObject.addComponent(ye)),this.rigidbody)}awake(){this._activeGroundCollisions=new Set}onEnable(){const t=this.rigidbody;let i=this.gameObject.getComponent(Is);i||(i=this.gameObject.addComponent(Is)),i.center.copy(this.center),i.radius=this.radius,i.height=this.height;const s=new x(0,0,1),o=new x(1,0,0),r=new x(0,1,0),l=this.gameObject.getWorldDirection(new x);l.y=0;const c=o.dot(l)<0?-1:1,h=s.angleTo(l)*c;this.gameObject.setRotationFromAxisAngle(r,h),t.lockRotationX=!0,t.lockRotationY=!0,t.lockRotationZ=!0}move(t){this.gameObject.position.add(t)}onCollisionEnter(t){(t.contacts.length==0||t.contacts.some(i=>i.normal.y>.2))&&(this._activeGroundCollisions.add(t),$w&&console.log(`Collision(${this._activeGroundCollisions.size}): ${t.contacts.map(i=>i.normal.y.toFixed(2)).join(", ")} - ${this.isGrounded}`))}onCollisionExit(t){this._activeGroundCollisions.delete(t),$w&&console.log(`Collision(${this._activeGroundCollisions.size}) - ${this.isGrounded}`)}get isGrounded(){return this._activeGroundCollisions.size>0}get contactVelocity(){var t;this._contactVelocity.set(0,0,0);for(const i of this._activeGroundCollisions){const s=(t=this.context.physics.engine)==null?void 0:t.getLinearVelocity(i.collider);s&&(this._contactVelocity.x+=s.x,this._contactVelocity.y+=s.y,this._contactVelocity.z+=s.z)}return this._contactVelocity}}js([m(x)],Ar.prototype,"center",2),js([m()],Ar.prototype,"radius",2),js([m()],Ar.prototype,"height",2);class Ls extends A{constructor(){super(...arguments),a(this,"controller"),a(this,"movementSpeed",2),a(this,"rotationSpeed",2),a(this,"jumpForce",1),a(this,"doubleJumpForce",2),a(this,"animator"),a(this,"lookForward",!0),a(this,"lookInput",new re(0,0)),a(this,"moveInput",new re(0,0)),a(this,"jumpInput",!1),a(this,"_currentSpeed",new x(0,0,0)),a(this,"_currentAngularSpeed",new x(0,0,0)),a(this,"_temp",new x(0,0,0)),a(this,"_jumpCount",0),a(this,"_currentRotation"),a(this,"_raycastOptions",new Vn)}awake(){this._currentRotation=new V}update(){const t=this.context.input;t.isKeyPressed("KeyW")?this.moveInput.y+=1:t.isKeyPressed("KeyS")&&(this.moveInput.y-=1),t.isKeyPressed("KeyD")?this.lookInput.x+=1:t.isKeyPressed("KeyA")&&(this.lookInput.x-=1),this.jumpInput||(this.jumpInput=t.isKeyDown("Space"))}move(t){this.moveInput.add(t)}look(t){this.lookInput.add(t)}jump(){this.jumpInput=!0}onBeforeRender(){this.handleInput(this.moveInput,this.lookInput,this.jumpInput),this.lookInput.set(0,0),this.moveInput.set(0,0),this.jumpInput=!1}handleInput(t,i,s){var o,r,l,c,h,d,u,p,g,y,f;if((o=this.controller)!=null&&o.isGrounded&&(this._jumpCount=0,this.doubleJumpForce>0&&((r=this.animator)==null||r.setBool("doubleJump",!1))),this._currentSpeed.z+=t.y*this.movementSpeed*this.context.time.deltaTime,(l=this.animator)==null||l.setBool("running",t.length()>.01),(h=this.animator)==null||h.setBool("jumping",((c=this.controller)==null?void 0:c.isGrounded)===!0&&s),this._temp.copy(this._currentSpeed),this._temp.applyQuaternion(this.gameObject.quaternion),this.controller?this.controller.move(this._temp):this.gameObject.position.add(this._temp),this._currentAngularSpeed.y+=W.toRadians(-i.x*this.rotationSpeed)*this.context.time.deltaTime,this.lookForward&&Math.abs(this._currentAngularSpeed.y)<.01){const v=this.context.mainCameraComponent.forward;v.y=0,v.normalize(),this._currentRotation.setFromUnitVectors(new x(0,0,1),v),this.gameObject.quaternion.slerp(this._currentRotation,this.context.time.deltaTime*10)}if(this.gameObject.rotateY(this._currentAngularSpeed.y),this._currentSpeed.multiplyScalar(1-this.context.time.deltaTime*10),this._currentAngularSpeed.y*=1-this.context.time.deltaTime*10,this.controller&&s&&this.jumpForce>0){let v=(d=this.controller)==null?void 0:d.isGrounded;if(this.doubleJumpForce>0&&!((u=this.controller)!=null&&u.isGrounded)&&this._jumpCount===1&&(v=!0,(p=this.animator)==null||p.setBool("doubleJump",!0)),v){this._jumpCount+=1;const b=this.controller.rigidbody,w=this._jumpCount===2?this.doubleJumpForce:this.jumpForce;b.applyImpulse(new x(0,1,0).multiplyScalar(w))}}if(this.controller){const v=(g=this.controller)==null?void 0:g.rigidbody.getVelocity().y;if(v<-1){this._raycastOptions.ray||(this._raycastOptions.ray=new no),this._raycastOptions.ray.origin.copy(te(this.gameObject)),this._raycastOptions.ray.direction.set(0,-1,0);const b=this.layer;this.gameObject.layers.disableAll(),this.gameObject.layers.set(2);const w=this.context.physics.raycast(this._raycastOptions);this.gameObject.layers.set(b),(w.length&&w[0].distance>2||v<-10)&&((y=this.animator)==null||y.setBool("falling",!0))}else(f=this.animator)==null||f.setBool("falling",!1)}}}js([m(Ar)],Ls.prototype,"controller",2),js([m()],Ls.prototype,"movementSpeed",2),js([m()],Ls.prototype,"rotationSpeed",2),js([m()],Ls.prototype,"jumpForce",2),js([m()],Ls.prototype,"doubleJumpForce",2),js([m(kt)],Ls.prototype,"animator",2);var iR=Object.defineProperty,nR=Object.getOwnPropertyDescriptor,Za=(n,t,i,s)=>{for(var o=s>1?void 0:s?nR(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&iR(t,i,o),o};const Qc=C("debugcontactshadows");Sw(n=>{const t=n.domElement.getAttribute("contactshadows")||n.domElement.getAttribute("contact-shadows");if(t!=null&&t!="0"&&t!="false"){console.debug("Auto-creating ContactShadows because of `contactshadows` attribute");const i=kn.auto(n),s=parseFloat(t);isNaN(s)||(i.opacity=s,i.darkness=s)}});var Of;const Yc=(Of=class extends A{constructor(){super(...arguments),a(this,"autoFit",!1),a(this,"darkness",.5),a(this,"opacity",.5),a(this,"blur",4),a(this,"occludeBelowGround",!1),a(this,"backfaceShadows",!0),a(this,"minSize"),a(this,"shadowsRoot",new j),a(this,"shadowCamera"),a(this,"shadowGroup",new so),a(this,"renderTarget"),a(this,"renderTargetBlur"),a(this,"plane"),a(this,"occluderMesh"),a(this,"blurPlane"),a(this,"depthMaterial"),a(this,"horizontalBlurMaterial"),a(this,"verticalBlurMaterial"),a(this,"textureSize",512)}static auto(n){if(n||(n=ee.Current),!n)throw new Error("No context provided and no current context set.");let t=this._instances.get(n);if(!t||t.destroyed){const i=new j;t=Ri(i,Yc,{autoFit:!1,occludeBelowGround:!1}),this._instances.set(n,t)}return n.scene.add(t.gameObject),t.fitShadows(),t}fitShadows(){Qc&&console.warn("Fitting shadows to scene"),bd(this.shadowsRoot,!1);const n=oi(this.context.scene.children,[this.shadowsRoot]),t=Math.max(1,this.blur/32),i=n.max.x-n.min.x,s=n.max.z-n.min.z;n.expandByVector(new x(t*i,0,t*s)),Qc&&G.DrawWireBox3(n,16776960,60),this.gameObject.parent&&n.applyMatrix4(this.gameObject.parent.matrixWorld.clone().invert());const o=n.min,r=Math.max(1e-5,(n.max.y-o.y)*.002);n.max.y+=r,this.shadowsRoot.position.set((o.x+n.max.x)/2,o.y-r,(o.z+n.max.z)/2),this.shadowsRoot.scale.set(n.max.x-o.x,n.max.y-o.y,n.max.z-o.z),this.applyMinSize(),this.shadowsRoot.matrixWorldNeedsUpdate=!0,Qc&&console.log("Fitted shadows to scene",this.shadowsRoot.scale.clone())}awake(){Yc._instances.set(this.context,this),this.shadowsRoot.hideFlags=Au.DontExport,bd(this.shadowsRoot,!1)}start(){Qc&&console.log("Create ContactShadows on "+this.gameObject.name,this),this.gameObject.add(this.shadowsRoot),this.shadowsRoot.add(this.shadowGroup),this.renderTarget=new vs(this.textureSize,this.textureSize),this.renderTarget.texture.generateMipmaps=!1,this.renderTargetBlur=new vs(this.textureSize,this.textureSize),this.renderTargetBlur.texture.generateMipmaps=!1;const n=new zn(1,1).rotateX(Math.PI/2);this.gameObject instanceof X&&(console.warn("ContactShadows can not be added to a Mesh. Please add it to a Group or an empty Object"),Os(this.gameObject,!1));const t=new Re({map:this.renderTarget.texture,opacity:this.opacity,color:0,transparent:!0,depthWrite:!1,side:ro});this.plane=new X(n,t),this.plane.scale.y=-1,this.plane.layers.set(2),this.shadowsRoot.add(this.plane),this.plane&&(this.plane.renderOrder=1),this.occluderMesh=new X(this.plane.geometry,new Re({depthWrite:!0,stencilWrite:!0,colorWrite:!1,side:cd})).translateY(-1e-4),this.occluderMesh.renderOrder=-100,this.occluderMesh.layers.set(2),this.shadowsRoot.add(this.occluderMesh),this.blurPlane=new X(n),this.blurPlane.visible=!1,this.shadowGroup.add(this.blurPlane);const i=0,s=1;this.shadowCamera=new cm(-1/2,1/2,1/2,-1/2,i,s),this.shadowCamera.layers.enableAll(),this.shadowCamera.rotation.x=Math.PI/2,this.shadowGroup.add(this.shadowCamera),this.depthMaterial=new LS,this.depthMaterial.userData.darkness={value:this.darkness},this.depthMaterial.blending=DS,this.depthMaterial.blendEquation=BS,this.depthMaterial.onBeforeCompile=o=>{this.depthMaterial&&(o.uniforms.darkness=this.depthMaterial.userData.darkness,o.fragmentShader=`
                uniform float darkness;
                ${o.fragmentShader.replace("gl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );","gl_FragColor = vec4( vec3( 1.0 ), ( 1.0 - fragCoordZ ) * darkness * opacity * (gl_FrontFacing ? 1.0 : 0.66) );")}
            `)},this.depthMaterial.depthTest=!1,this.depthMaterial.depthWrite=!1,this.horizontalBlurMaterial=new mn(UC),this.horizontalBlurMaterial.depthTest=!1,this.verticalBlurMaterial=new mn(NC),this.verticalBlurMaterial.depthTest=!1,this.shadowGroup.visible=!1,this.autoFit?this.fitShadows():this.applyMinSize()}onDestroy(){var n,t,i,s,o,r,l,c;Yc._instances.get(this.context)===this&&Yc._instances.delete(this.context),(n=this.renderTarget)==null||n.dispose(),(t=this.renderTargetBlur)==null||t.dispose(),(i=this.depthMaterial)==null||i.dispose(),(s=this.horizontalBlurMaterial)==null||s.dispose(),(o=this.verticalBlurMaterial)==null||o.dispose(),(r=this.blurPlane)==null||r.geometry.dispose(),(l=this.plane)==null||l.geometry.dispose(),(c=this.occluderMesh)==null||c.geometry.dispose()}onBeforeRender(n){if(!this.renderTarget||!this.renderTargetBlur||!this.depthMaterial||!this.shadowCamera||!this.blurPlane||!this.shadowGroup||!this.plane||!this.horizontalBlurMaterial||!this.verticalBlurMaterial){Qc&&console.error("ContactShadows: not initialized yet");return}const t=this.context.scene,i=this.context.renderer,s=i.getRenderTarget();this.shadowGroup.visible=!0,this.occluderMesh&&(this.occluderMesh.visible=!1);const o=this.plane.visible;this.plane.visible=!1,this.gameObject instanceof X&&Os(this.gameObject,!1);const r=t.background;t.background=null,t.overrideMaterial=this.depthMaterial,this.backfaceShadows?this.depthMaterial.side=Ci:this.depthMaterial.side=ro;const l=i.getClearAlpha();i.setClearAlpha(0);const c=i.xr.enabled;i.xr.enabled=!1;const h=this.context.scene.matrixWorldAutoUpdate;this.context.scene.matrixWorldAutoUpdate=!1;const d=i.renderLists.get(t,0),u=d.transparent;Gw.length=0,d.transparent=Gw,Pf.length=0;for(const g of d.opaque){if(!g.object.visible)continue;const y=g.material;let f=g.material.colorWrite==!1||y.wireframe===!0||Yv(g.object)===!1;!f&&g.material.isLineMaterial&&(f=!0),!f&&g.material.isPointsMaterial&&(f=!0),f&&(Pf.push(g.object),g.object["needle:visible"]=g.object.visible,g.object.visible=!1)}i.setRenderTarget(this.renderTarget),i.clear(),i.render(t,this.shadowCamera),d.transparent=u;for(const g of Pf)g["needle:visible"]!=null&&(g.visible=g["needle:visible"]);t.overrideMaterial=null;const p=Math.max(this.blur,.05);this.blurShadow(p*2),this.blurShadow(p*.5),this.shadowGroup.visible=!1,this.occluderMesh&&(this.occluderMesh.visible=this.occludeBelowGround),this.plane.visible=o,i.setRenderTarget(s),i.setClearAlpha(l),t.background=r,i.xr.enabled=c,this.context.scene.matrixWorldAutoUpdate=h}blurShadow(n){if(!this.blurPlane||!this.shadowCamera||!this.renderTarget||!this.renderTargetBlur||!this.horizontalBlurMaterial||!this.verticalBlurMaterial)return;this.blurPlane.visible=!0;const t=this.shadowsRoot.worldScale,i=(t.x+t.z)/2,s=t.z/i,o=t.x/i;this.blurPlane.material=this.horizontalBlurMaterial,this.blurPlane.material.uniforms.tDiffuse.value=this.renderTarget.texture,this.horizontalBlurMaterial.uniforms.h.value=n*1/this.textureSize*s;const r=this.context.renderer,l=r.getRenderTarget();r.setRenderTarget(this.renderTargetBlur),r.render(this.blurPlane,this.shadowCamera),this.blurPlane.material=this.verticalBlurMaterial,this.blurPlane.material.uniforms.tDiffuse.value=this.renderTargetBlur.texture,this.verticalBlurMaterial.uniforms.v.value=n*1/this.textureSize*o,r.setRenderTarget(this.renderTarget),r.render(this.blurPlane,this.shadowCamera),this.blurPlane.visible=!1,r.setRenderTarget(l)}applyMinSize(){this.minSize&&this.shadowsRoot.scale.set(Math.max(this.minSize.x||0,this.shadowsRoot.scale.x),Math.max(this.minSize.y||0,this.shadowsRoot.scale.y),Math.max(this.minSize.z||0,this.shadowsRoot.scale.z))}},a(Of,"_instances",new Map),Of);let kn=Yc;Za([m()],kn.prototype,"autoFit",2),Za([m()],kn.prototype,"darkness",2),Za([m()],kn.prototype,"opacity",2),Za([m()],kn.prototype,"blur",2),Za([m()],kn.prototype,"occludeBelowGround",2),Za([m()],kn.prototype,"backfaceShadows",2);const Gw=[],Pf=new Array,sR=C("logstats");class kf extends A{onEnable(){console.log(this),sR&&this.startCoroutine(this.run(),Me.OnAfterRender)}*run(){for(;this.enabled;){const t=this.context.renderer.info;console.log(t.memory,t.render,t.programs),yield}}}class Zc extends A{constructor(){super(...arguments),a(this,"isUsed",!0),a(this,"usedBy",null)}}class Mf extends A{}const qw=C("debugdeletable"),ju=class extends Ki{onEnable(){ju._instances.push(this)}onDisable(){const n=ju._instances.indexOf(this);n>=0&&ju._instances.splice(n,1)}};let Kc=ju;a(Kc,"_instances",[]);class Rf extends A{update(){for(const t of Kc._instances){const i=this.gameObject;if(t.isInBox(i)===!0){const s=O.getComponentInParent(this.gameObject,Zc);if(s)qw&&console.warn("DeleteBox: Not deleting object with usage marker",this.guid,s);else{if(qw)try{if(t.box){const o=t.box,r=Ki.testBox;G.DrawWireBox3(o,16711680,5),G.DrawWireBox3(r,255,5),console.log("DeleteBox: Destroying",this.gameObject,{deleteBoxArea:o,deletedObjectArea:r})}else console.log("DeleteBox: Destroying",this.gameObject)}catch{}wc(this.gameObject,this.context.connection)}}}}}var oR=Object.defineProperty,rR=Object.getOwnPropertyDescriptor,aR=(n,t,i,s)=>{for(var o=s>1?void 0:s?rR(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&oR(t,i,o),o};class Lu extends A{constructor(){super(...arguments),a(this,"visibleOn")}onEnable(){this.apply()}apply(){this.test()||O.setActive(this.gameObject,!1)}test(){return this.visibleOn<0?!0:Q.isMobileDevice()?(this.visibleOn&2)!==0:(this.visibleOn&1)!==0}}aR([m()],Lu.prototype,"visibleOn",2);var lR=Object.defineProperty,cR=Object.getOwnPropertyDescriptor,Ir=(n,t,i,s)=>{for(var o=s>1?void 0:s?cR(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&lR(t,i,o),o};const Jn=C("debugdrag"),Tf=[];var Ef=(n=>(n[n.XZPlane=0]="XZPlane",n[n.Attached=1]="Attached",n[n.HitNormal=2]="HitNormal",n[n.DynamicViewAngle=3]="DynamicViewAngle",n[n.SnapToSurfaces=4]="SnapToSurfaces",n[n.None=5]="None",n))(Ef||{}),Jc;const Ji=(Jc=class extends A{constructor(){super(...arguments),a(this,"dragMode",3),a(this,"snapGridResolution",0),a(this,"keepRotation",!0),a(this,"xrDragMode",1),a(this,"xrKeepRotation",!1),a(this,"xrDistanceDragFactor",1),a(this,"showGizmo",!1),a(this,"_rigidbody",null),a(this,"_targetObject",null),a(this,"_dragHelper",null),a(this,"_draggingRigidbodies",[]),a(this,"_potentialDragStartEvt",null),a(this,"_dragHandlers",new Map),a(this,"_totalMovement",new x),a(this,"_marker",null),a(this,"_isDragging",!1),a(this,"_didDrag",!1)}static get HasAnySelected(){return this._active>0}static get CurrentlySelected(){Tf.length=0;for(const n of this._instances)n._isDragging&&Tf.push(n);return Tf}get draggedObject(){return this._targetObject}setTargetObject(n){var t,i;this._targetObject=n;for(const o of this._dragHandlers.values())o.setTargetObject(n);const s="_rigidbody-was-kinematic";((t=this._rigidbody)==null?void 0:t[s])===!1&&(this._rigidbody.isKinematic=!1,this._rigidbody[s]=void 0),this._rigidbody=null,n&&(this._rigidbody=O.getComponentInChildren(n,ye),((i=this._rigidbody)==null?void 0:i.isKinematic)===!1&&(this._rigidbody.isKinematic=!0,this._rigidbody[s]=!1))}awake(){this._potentialDragStartEvt=null,this._dragHandlers=new Map,this._totalMovement=new x,this._marker=null,this._isDragging=!1,this._didDrag=!1,this._dragHelper=null,this._draggingRigidbodies=[]}start(){this.gameObject.getComponentInParent(Ai)||this.gameObject.addComponent(Ai)}onEnable(){Ji._instances.push(this)}onDisable(){Ji._instances=Ji._instances.filter(n=>n!==this)}allowEdit(n=null){return this.context.connection.allowEditing}onPointerEnter(n){if(!this.allowEdit(this.gameObject)||n.mode!=="screen"||(n.event.mode==="tracked-pointer"||n.event.mode==="transient-pointer"?this.xrDragMode:this.dragMode)===5)return;const t=O.getComponentInParent(n.object,Ji);!t||t!==this||(Ji.lastHovered=n.object,this.context.domElement.style.cursor="pointer")}onPointerMove(n){(this._isDragging||this._potentialDragStartEvt!==null)&&n.use()}onPointerExit(n){this.allowEdit(this.gameObject)&&n.mode==="screen"&&Ji.lastHovered===n.object&&(this.context.domElement.style.cursor="auto")}onPointerDown(n){if(!(!this.allowEdit(this.gameObject)||n.used||(n.mode==="tracked-pointer"||n.mode==="transient-pointer"?this.xrDragMode:this.dragMode)===5)&&(Ji.lastHovered=n.object,n.button===0)){this._dragHandlers.size===0&&(this._didDrag=!1,this._totalMovement.set(0,0,0),this._potentialDragStartEvt=n),this._targetObject||this.setTargetObject(this.gameObject),Ji._active+=1;const t=new Af(this,this._targetObject);if(this._dragHandlers.set(n.event.space,t),t.onDragStart(n),this._dragHandlers.size===2){const i=this._dragHandlers.values(),s=i.next().value,o=i.next().value;if(s instanceof Af&&o instanceof Af){const r=new hR(this,this._targetObject,s,o);this._dragHandlers.set(this.gameObject,r),r.onDragStart(n)}else console.error("Attempting to construct a MultiTouchDragHandler with invalid DragPointerHandlers. This is likely a bug.",{a:s,b:o})}n.use()}}onPointerUp(n){if(Jn&&G.DrawLabel(n.point??this.gameObject.worldPosition,"POINTERUP:"+n.pointerId+", "+n.button,.03,3),!this.allowEdit(this.gameObject)||n.button!==0)return;this._potentialDragStartEvt=null;const t=this._dragHandlers.get(n.event.space),i=this._dragHandlers.get(this.gameObject);i&&(i.handlerA===t||i.handlerB===t)&&(this._dragHandlers.delete(this.gameObject),i.onDragEnd(n)),t&&(Ji._active>0&&(Ji._active-=1),this.setTargetObject(null),t.onDragEnd&&t.onDragEnd(n),this._dragHandlers.delete(n.event.space),this._dragHandlers.size===0&&this.onLastDragEnd(n),n.use())}update(){for(const n of this._dragHandlers.values())n.collectMovementInfo&&n.collectMovementInfo(),n.getTotalMovement&&this._totalMovement.add(n.getTotalMovement());if(this._potentialDragStartEvt){if(!this._didDrag)if(this._totalMovement.length()>3e-4)this._didDrag=!0;else return;const n=this._potentialDragStartEvt;this._potentialDragStartEvt=null,this.onFirstDragStart(n)}for(const n of this._dragHandlers.values())n.onDragUpdate&&n.onDragUpdate(this._dragHandlers.size);this._dragHelper&&this._dragHelper.hasSelected&&this.onAnyDragUpdate()}onFirstDragStart(n){if(!n||!n.object)return;const t=O.getComponentInParent(n.object,Ji);if(!t||t!==this&&t._isDragging)return;const i=this._targetObject||this.gameObject;if(!i)return;this._isDragging=!0;const s=O.getComponentInChildren(i,qn);Jn&&console.log("DRAG START",s,i),s&&(s.fastMode=!0,s?.requestOwnership()),this._marker=O.addComponent(i,Zc),this._draggingRigidbodies.length=0;const o=O.getComponentsInChildren(i,ye);o&&this._draggingRigidbodies.push(...o)}onAnyDragUpdate(){if(!this._dragHelper)return;this._dragHelper.showGizmo=this.showGizmo,this._dragHelper.onUpdate(this.context);for(const t of this._draggingRigidbodies)t.wakeUp(),t.resetVelocities(),t.resetForcesAndTorques();const n=this._targetObject||this.gameObject;an.markDirty(n)}onLastDragEnd(n){if(!this||!this._isDragging)return;this._isDragging=!1;for(const i of this._draggingRigidbodies)i.setVelocity(i.smoothedVelocity);if(this._draggingRigidbodies.length=0,this._targetObject=null,n!=null&&n.object){const i=O.getComponentInChildren(n.object,qn);i&&(i.fastMode=!1)}if(this._marker&&this._marker.destroy(),!this._dragHelper)return;const t=this._dragHelper.selected;Jn&&console.log("DRAG END",t,t?.visible),this._dragHelper.setSelected(null,this.context)}},a(Jc,"_active",0),a(Jc,"_instances",[]),a(Jc,"lastHovered"),Jc);let ui=Ji;Ir([m()],ui.prototype,"dragMode",2),Ir([m()],ui.prototype,"snapGridResolution",2),Ir([m()],ui.prototype,"keepRotation",2),Ir([m()],ui.prototype,"xrDragMode",2),Ir([m()],ui.prototype,"xrKeepRotation",2),Ir([m()],ui.prototype,"xrDistanceDragFactor",2),Ir([m()],ui.prototype,"showGizmo",2);class hR{constructor(t,i,s,o){a(this,"handlerA"),a(this,"handlerB"),a(this,"context"),a(this,"settings"),a(this,"gameObject"),a(this,"_handlerAAttachmentPoint",new x),a(this,"_handlerBAttachmentPoint",new x),a(this,"_followObject"),a(this,"_manipulatorObject"),a(this,"_deviceMode"),a(this,"_followObjectStartWorldQuaternion",new V),a(this,"_manipulatorPosOffset",new x),a(this,"_manipulatorRotOffset",new V),a(this,"_manipulatorScaleOffset",new x),a(this,"_tempVec1",new x),a(this,"_tempVec2",new x),a(this,"_tempVec3",new x),a(this,"tempLookMatrix",new se),a(this,"_initialScale",new x),a(this,"_initialDistance",0);var r,l;this.context=t.context,this.settings=t,this.gameObject=i,this.handlerA=s,this.handlerB=o,this._followObject=new j,this._manipulatorObject=new j,this.context.scene.add(this._manipulatorObject);const c=(l=(r=J.active)==null?void 0:r.rig)==null?void 0:l.gameObject;if(!this.handlerA||!this.handlerB||!this.handlerA.hitPointInLocalSpace||!this.handlerB.hitPointInLocalSpace){console.error("Invalid: MultiTouchDragHandler needs two valid DragPointerHandlers with hitPointInLocalSpace set.");return}if(this._tempVec1.copy(this.handlerA.hitPointInLocalSpace),this._tempVec2.copy(this.handlerB.hitPointInLocalSpace),this.gameObject.localToWorld(this._tempVec1),this.gameObject.localToWorld(this._tempVec2),c&&(c.worldToLocal(this._tempVec1),c.worldToLocal(this._tempVec2)),this._initialDistance=this._tempVec1.distanceTo(this._tempVec2),this._initialDistance<.02?(Jn&&console.log("Finding alternative drag attachment points since initial distance is too low: "+this._initialDistance.toFixed(2)),this.handlerA.followObject.parent.getWorldPosition(this._tempVec1),this.handlerB.followObject.parent.getWorldPosition(this._tempVec2),this._handlerAAttachmentPoint.copy(this._tempVec1),this._handlerBAttachmentPoint.copy(this._tempVec2),this.gameObject.worldToLocal(this._handlerAAttachmentPoint),this.gameObject.worldToLocal(this._handlerBAttachmentPoint),this._initialDistance=this._tempVec1.distanceTo(this._tempVec2),this._initialDistance<.001&&(console.warn("Not supported right now \u2013 controller drag points for multitouch are too close!"),this._initialDistance=1)):(this._handlerAAttachmentPoint.copy(this.handlerA.hitPointInLocalSpace),this._handlerBAttachmentPoint.copy(this.handlerB.hitPointInLocalSpace)),this._tempVec3.lerpVectors(this._tempVec1,this._tempVec2,.5),this._initialScale.copy(i.scale),Jn){this._followObject.add(new Si(2)),this._manipulatorObject.add(new Si(5));const h=d=>`${d.x.toFixed(2)}, ${d.y.toFixed(2)}, ${d.z.toFixed(2)}`;G.DrawLine(this._tempVec1,this._tempVec2,65535,0,!1),G.DrawLabel(this._tempVec3,"A:B "+this._initialDistance.toFixed(2)+`
`+h(this._tempVec1)+`
`+h(this._tempVec2),.03,5)}}onDragStart(t){this.gameObject.add(this._followObject),this._followObject.matrixAutoUpdate=!1,this._followObject.matrix.identity(),this._deviceMode=t.mode,this._followObjectStartWorldQuaternion.copy(this._followObject.worldQuaternion),this.alignManipulator(),this._manipulatorObject.attach(this._followObject),this._manipulatorPosOffset.copy(this._followObject.position),this._manipulatorRotOffset.copy(this._followObject.quaternion),this._manipulatorScaleOffset.copy(this._followObject.scale)}onDragEnd(t){if(!this.handlerA||!this.handlerB){console.error("onDragEnd called on MultiTouchDragHandler without valid handlers. This is likely a bug.");return}this.handlerA.recenter(),this.handlerB.recenter(),this._manipulatorObject.removeFromParent(),this._followObject.removeFromParent(),this._manipulatorObject.destroy(),this._followObject.destroy()}alignManipulator(){if(!this.handlerA||!this.handlerB){console.error("alignManipulator called on MultiTouchDragHandler without valid handlers. This is likely a bug.",this);return}if(!this.handlerA.followObject||!this.handlerB.followObject){console.error("alignManipulator called on MultiTouchDragHandler without valid follow objects. This is likely a bug.",this.handlerA,this.handlerB);return}this._tempVec1.copy(this._handlerAAttachmentPoint),this._tempVec2.copy(this._handlerBAttachmentPoint),this.handlerA.followObject.localToWorld(this._tempVec1),this.handlerB.followObject.localToWorld(this._tempVec2),this._tempVec3.lerpVectors(this._tempVec1,this._tempVec2,.5),this._manipulatorObject.position.copy(this._tempVec3);const t=this.context.mainCamera;this.tempLookMatrix.lookAt(this._tempVec3,this._tempVec2,t.worldUp),this._manipulatorObject.quaternion.setFromRotationMatrix(this.tempLookMatrix);const i=this._tempVec1.distanceTo(this._tempVec2);this._manipulatorObject.scale.copy(this._initialScale).multiplyScalar(i/this._initialDistance),this._manipulatorObject.updateMatrix(),this._manipulatorObject.updateMatrixWorld(!0),Jn&&(G.DrawLabel(this._tempVec3.clone().add(new x(0,.2,0)),"A:B "+i.toFixed(2),.03),G.DrawLine(this._tempVec1,this._tempVec2,65280,0,!1))}onDragUpdate(){this.alignManipulator();const t=30,i=1;this._followObject.position.copy(this._manipulatorPosOffset),this._followObject.quaternion.copy(this._manipulatorRotOffset),this._followObject.scale.copy(this._manipulatorScaleOffset);const s=this.gameObject,o=this._followObject;if(!s){console.error("MultiTouchDragHandler has no dragged object. This is likely a bug.");return}o.updateMatrix(),o.updateMatrixWorld(!0);const r=this._deviceMode==="tracked-pointer"||this._deviceMode==="transient-pointer"?this.settings.xrKeepRotation:this.settings.keepRotation;if(this.settings.snapGridResolution>0){const u=this._followObject.worldPosition,p=this.settings.snapGridResolution;u.x=Math.round(u.x/p)*p,u.y=Math.round(u.y/p)*p,u.z=Math.round(u.z/p)*p,this._followObject.worldPosition=u,this._followObject.updateMatrix()}r&&(this._followObject.worldQuaternion=this._followObjectStartWorldQuaternion,this._followObject.updateMatrix());const l=W.clamp01(this.context.time.deltaTime*t*i),c=s.worldPosition;c.lerp(o.worldPosition,l),s.worldPosition=c;const h=s.worldQuaternion;h.slerp(o.worldQuaternion,l),s.worldQuaternion=h;const d=s.worldScale;d.lerp(o.worldScale,l),s.worldScale=d}setTargetObject(t){this.gameObject=t}}class Af{constructor(t,i){a(this,"context"),a(this,"gameObject"),a(this,"settings"),a(this,"_lastRig"),a(this,"_followObject"),a(this,"_totalMovement",new x),a(this,"_totalMovementAlongRayDirection",0),a(this,"_grabStartDistance",0),a(this,"_deviceMode"),a(this,"_followObjectStartPosition",new x),a(this,"_followObjectStartQuaternion",new V),a(this,"_followObjectStartWorldQuaternion",new V),a(this,"_lastDragPosRigSpace"),a(this,"_tempVec",new x),a(this,"_tempMat",new se),a(this,"_hitPointInLocalSpace",new x),a(this,"_hitNormalInLocalSpace",new x),a(this,"_bottomCenter",new x),a(this,"_backCenter",new x),a(this,"_backBottomCenter",new x),a(this,"_bounds",new xi),a(this,"_dragPlane",new or(new x(0,1,0))),a(this,"_draggedOverObject",null),a(this,"_draggedOverObjectLastSetUp",null),a(this,"_draggedOverObjectLastNormal",new x),a(this,"_draggedOverObjectDuration",0),a(this,"_hasLastSurfaceHitPoint",!1),a(this,"_lastSurfaceHitPoint",new x),this.settings=t,this.context=t.context,this.gameObject=i,this._followObject=new j}getTotalMovement(){return this._totalMovement}get followObject(){return this._followObject}get hitPointInLocalSpace(){return this._hitPointInLocalSpace}setTargetObject(t){this.gameObject=t}recenter(){var t,i;if(!this._followObject.parent){console.warn("Error: space follow object doesn't have parent but recenter() is called. This is likely a bug");return}if(!this.gameObject){console.warn("Error: space follow object doesn't have a gameObject");return}const s=this._followObject.parent;this.gameObject.add(this._followObject),this._followObject.matrixAutoUpdate=!1,this._followObject.position.set(0,0,0),this._followObject.quaternion.set(0,0,0,1),this._followObject.scale.set(1,1,1),this._followObject.updateMatrix(),this._followObject.updateMatrixWorld(!0),s.attach(this._followObject),this._followObjectStartPosition.copy(this._followObject.position),this._followObjectStartQuaternion.copy(this._followObject.quaternion),this._followObjectStartWorldQuaternion.copy(this._followObject.worldQuaternion),this._followObject.updateMatrix(),this._followObject.updateMatrixWorld(!0);const o=this._hitPointInLocalSpace.clone();this.gameObject.localToWorld(o),this._grabStartDistance=o.distanceTo(s.worldPosition);const r=(i=(t=J.active)==null?void 0:t.rig)==null?void 0:i.gameObject,l=r?.worldScale.x||1;this._grabStartDistance/=l,this._totalMovementAlongRayDirection=0,this._lastDragPosRigSpace=void 0,Jn&&(G.DrawLine(o,s.worldPosition,65280,.5,!1),G.DrawLabel(s.worldPosition.add(new x(0,.1,0)),this._grabStartDistance.toFixed(2),.03,.5))}onDragStart(t){if(!this.gameObject){console.warn("Error: space follow object doesn't have a gameObject");return}if(t.event.space.add(this._followObject),this._lastDragPosRigSpace=void 0,t.point&&t.normal)this._hitPointInLocalSpace.copy(t.point),this.gameObject.worldToLocal(this._hitPointInLocalSpace),this._hitNormalInLocalSpace.copy(t.normal);else if(t){const y=t.event.space,f=y.worldPosition;this.gameObject.worldToLocal(f),this._hitPointInLocalSpace.copy(f);const v=y.worldUp;this._tempMat.copy(this.gameObject.matrixWorld).invert(),v.transformDirection(this._tempMat),this._hitNormalInLocalSpace.copy(v)}this.recenter(),this._totalMovement.set(0,0,0),this._deviceMode=t.mode;const i=this._followObject.parent.worldForward,s=this._deviceMode==="tracked-pointer"||this._deviceMode==="transient-pointer"?this.settings.xrDragMode:this.settings.dragMode,o=this._hitPointInLocalSpace.clone();switch(this.gameObject.localToWorld(o),s){case 0:const y=new x(0,1,0);this.gameObject.parent&&y.transformDirection(this.gameObject.parent.matrixWorld.clone().invert()),this._dragPlane.setFromNormalAndCoplanarPoint(y,o);break;case 2:const f=this._hitNormalInLocalSpace.clone();f.transformDirection(this.gameObject.matrixWorld),this._dragPlane.setFromNormalAndCoplanarPoint(f,o);break;case 1:this._dragPlane.setFromNormalAndCoplanarPoint(i,o);break;case 3:this.setPlaneViewAligned(o,!0);break;case 4:this.setPlaneViewAligned(o,!1);break}const r=this.gameObject.parent,l=this.gameObject.position.clone(),c=this.gameObject.quaternion.clone(),h=this.gameObject.scale.clone(),d=this.gameObject.matrixWorld.clone();r&&r.remove(this.gameObject),this.gameObject.position.set(0,0,0),this.gameObject.quaternion.set(0,0,0,1),this.gameObject.scale.set(1,1,1);const u=oi([this.gameObject]);u.expandByPoint(this.gameObject.worldPosition);const p=new x;u.getCenter(p);const g=new x;u.getSize(g),this._bottomCenter.copy(p.clone().add(new x(0,-g.y/2,0))),this._backCenter.copy(p.clone().add(new x(0,0,g.z/2))),this._backBottomCenter.copy(p.clone().add(new x(0,-g.y/2,g.z/2))),this._bounds.copy(u),r&&r.add(this.gameObject),this.gameObject.position.copy(l),this.gameObject.quaternion.copy(c),this.gameObject.scale.copy(h),this.gameObject.matrixWorld.copy(d),this._draggedOverObject=null,this._draggedOverObjectLastSetUp=null,this._draggedOverObjectLastNormal.set(0,1,0),this._draggedOverObjectDuration=0}collectMovementInfo(){var t,i;if(!this._followObject.parent)return;const s=this._followObject.parent;this._followObject.updateMatrix();const o=s.worldPosition,r=(i=(t=J.active)==null?void 0:t.rig)==null?void 0:i.gameObject;r&&r.worldToLocal(o),(this._lastDragPosRigSpace===void 0||r!=this._lastRig)&&(this._lastDragPosRigSpace=o.clone(),this._lastRig=r),this._tempVec.copy(o).sub(this._lastDragPosRigSpace);const l=s.worldForward;if(r&&(this._tempMat.copy(r.matrixWorld).invert(),l.transformDirection(this._tempMat)),this._totalMovementAlongRayDirection+=l.dot(this._tempVec),this._tempVec.x=Math.abs(this._tempVec.x),this._tempVec.y=Math.abs(this._tempVec.y),this._tempVec.z=Math.abs(this._tempVec.z),this._totalMovement.add(this._tempVec),this._lastDragPosRigSpace.copy(o),Jn){let c=o;r&&(c=c.clone(),c.transformDirection(r.matrixWorld)),G.DrawRay(c,l,255)}}onDragUpdate(t){if(t>1)return;const i=this.gameObject;if(!i||!this._followObject){console.warn("Warning: DragPointerHandler doesn't have a dragged object. This is likely a bug.");return}const s=this._followObject.parent;if(!s){console.warn("Warning: DragPointerHandler doesn't have a drag source. This is likely a bug.");return}this._followObject.updateMatrix();const o=s.worldPosition,r=s.worldForward,l=this._deviceMode==="tracked-pointer"||this._deviceMode==="transient-pointer",c=l?this.settings.xrKeepRotation:this.settings.keepRotation,h=l?this.settings.xrDragMode:this.settings.dragMode;if(h===5)return;const d=10;c&&(this._followObject.worldQuaternion=this._followObjectStartWorldQuaternion),this._followObject.updateMatrix(),this._followObject.updateMatrixWorld(!0);let u=1,p=2;if(l&&this._grabStartDistance>.5){const _=1+this._totalMovementAlongRayDirection*(2*this.settings.xrDistanceDragFactor);u=Math.max(0,_),u=u*u*u}else this._grabStartDistance<=.5&&(p=3);this._followObject.position.copy(this._followObjectStartPosition),c||this._followObject.quaternion.copy(this._followObjectStartQuaternion),this._followObject.position.multiplyScalar(u),this._followObject.updateMatrix();const g=this._hasLastSurfaceHitPoint;this._hasLastSurfaceHitPoint=!1;const y=new no(o,r);if(h==4){const _=this.context.physics.raycastFromRay(y,{testObject:S=>S!==this.followObject&&S!==s&&S!==i});if(_.length>0){const S=_[0];if(this._draggedOverObject===S.object?this._draggedOverObjectDuration+=this.context.time.deltaTime:(this._draggedOverObject=S.object,this._draggedOverObjectDuration=0),S.face){this._hasLastSurfaceHitPoint=!0,this._lastSurfaceHitPoint.copy(S.point);const R=.15,M=this._draggedOverObjectDuration>=R,T=.001,L=this._totalMovement.length()>=T,D=q(S.normal||S.face.normal).applyQuaternion(S.object.worldQuaternion);if((M||L)&&(this._draggedOverObjectLastSetUp!==this._draggedOverObject||this._draggedOverObjectLastNormal.dot(D)<.999999||this.context.time.frame%60===0)){this._draggedOverObjectLastSetUp=this._draggedOverObject,this._draggedOverObjectLastNormal.copy(S.face.normal);const U=q(),B=q();this._bounds.getCenter(U),this._bounds.getSize(B),U.sub(B.multiplyScalar(.5).multiply(D)),this._hitPointInLocalSpace.copy(U),this._hitNormalInLocalSpace.copy(S.face.normal),this._bounds.getCenter(U),this._bounds.getSize(B),U.add(B.multiplyScalar(.5).multiply(S.face.normal));const Y=q(this._hitPointInLocalSpace).add(U);this._followObject.localToWorld(Y);const $=S.point;this._dragPlane.setFromNormalAndCoplanarPoint(D,$)}else if(!(M||L))return}}else g&&this.gameObject&&this.setPlaneViewAligned(this.gameObject.worldPosition,!1)}if(h!==1&&y.intersectPlane(this._dragPlane,this._tempVec)){this._followObject.worldPosition=this._tempVec,this._followObject.updateMatrix(),this._followObject.updateMatrixWorld(!0);const _=q(this._hitPointInLocalSpace);this._followObject.localToWorld(_),Jn&&G.DrawLine(_,this._tempVec,65535,0,!1),this._followObject.worldPosition=this._tempVec.multiplyScalar(2).sub(_),this._followObject.updateMatrix(),this._followObject.updateMatrix()}if(this.settings.snapGridResolution>0){const _=this._followObject.worldPosition,S=this.settings.snapGridResolution;_.x=Math.round(_.x/S)*S,_.y=Math.round(_.y/S)*S,_.z=Math.round(_.z/S)*S,this._followObject.worldPosition=_,this._followObject.updateMatrix()}c&&(this._followObject.worldQuaternion=this._followObjectStartWorldQuaternion,this._followObject.updateMatrix());const f=W.clamp01(this.context.time.deltaTime*d*p),v=W.clamp01(this.context.time.deltaTime*d*.5*p),b=i.worldPosition;b.lerp(this._followObject.worldPosition,f),i.worldPosition=b;const w=i.worldQuaternion;if(w.slerp(this._followObject.worldQuaternion,v),i.worldQuaternion=w,Jn){const _=this._hitPointInLocalSpace.clone();i.localToWorld(_),G.DrawSphere(_,.02,16711680);const S=this._hitNormalInLocalSpace.clone();S.applyQuaternion(w),G.DrawRay(_,S,16711680),G.DrawLabel(b.add(new x(0,.25,0)),`Distance: ${this._totalMovement.length().toFixed(2)}

                Along Ray: ${this._totalMovementAlongRayDirection.toFixed(2)}

                Session: ${!!J.active}

                Device: ${this._deviceMode}

                `,.03);const R=this._bottomCenter.clone(),M=this._backCenter.clone(),T=this._backBottomCenter.clone();i.localToWorld(R),i.localToWorld(M),i.localToWorld(T),G.DrawSphere(R,.01,65280,0,!1),G.DrawSphere(M,.01,255,0,!1),G.DrawSphere(T,.01,16711935,0,!1),G.DrawLine(R,T,65535,0,!1),G.DrawLine(T,M,65535,0,!1)}}onDragEnd(t){console.assert(this._followObject.parent===t.event.space,"Drag end: _followObject is not parented to the space object"),this._followObject.removeFromParent(),this._followObject.destroy(),this._lastDragPosRigSpace=void 0}setPlaneViewAligned(t,i){if(!this._followObject.parent)return!1;const s=this._followObject.parent.worldForward,o=q(0,1,0),r=s,l=o.angleTo(r),c=.5;return i&&(l>Math.PI/2+c||l<Math.PI/2-c)?this._dragPlane.setFromNormalAndCoplanarPoint(o,t):this._dragPlane.setFromNormalAndCoplanarPoint(s,t),!0}}const Xw=class{constructor(n){a(this,"showGizmo",!0),a(this,"useViewAngle",!0),a(this,"_selected",null),a(this,"_context",null),a(this,"_camera"),a(this,"_cameraPlane",new or),a(this,"_hasGroundPlane",!1),a(this,"_groundPlane",new or),a(this,"_groundOffset",new x),a(this,"_groundOffsetFactor",0),a(this,"_groundDistance",0),a(this,"_groundPlanePoint",new x),a(this,"_raycaster",new rd),a(this,"_cameraPlaneOffset",new x),a(this,"_intersection",new x),a(this,"_worldPosition",new x),a(this,"_inverseMatrix",new se),a(this,"_rbs",[]),a(this,"_groundLine"),a(this,"_groundMarker"),a(this,"_groundOffsetVector",new x(0,1,0)),a(this,"_requireUpdateGroundPlane",!0),a(this,"_didDragOnGroundPlaneLastFrame",!1),this._camera=n;const t=new ql(Xw.geometry),i=t.material;i.color=new ae(.4,.4,.4),t.layers.set(2),t.name="line",t.scale.y=1,this._groundLine=t;const s=new sd(.5,22,22),o=new Re({color:i.color}),r=new X(s,o);r.visible=!1,r.layers.set(2),this._groundMarker=r}get hasSelected(){return this._selected!==null&&this._selected!==void 0}get selected(){return this._selected}setSelected(n,t){if(this._selected&&t)for(const i of this._rbs)i.wakeUp(),i.setVelocity(0,0,0);if(this._selected&&Es.Remove(t,this._selected),this._selected=n,this._context=t,this._rbs.length=0,n?(t.scene.add(this._groundLine),t.scene.add(this._groundMarker)):(this._groundLine.removeFromParent(),this._groundMarker.removeFromParent()),this._selected){if(!t){console.error("DragHelper: no context");return}Es.Add(t,this._selected,null),this._groundOffsetFactor=0,this._hasGroundPlane=!0,this._groundOffset.set(0,0,0),this._requireUpdateGroundPlane=!0,this.onUpdateScreenSpacePlane()}}onUpdate(n){this._selected}onUpdateWorldPosition(n,t,i){if(this._selected){if(i){const s=te(this._selected);s.y=n.y,n=s}if(dt(this._selected,n),dt(this._groundLine,n),this._hasGroundPlane?this._groundLine.scale.y=this._groundDistance:this._groundLine.scale.y=1e3,this._groundLine.visible=this.showGizmo,this._groundMarker.visible=t!==null&&this.showGizmo,t){const s=te(this._camera).distanceTo(t)*.01;this._groundMarker.scale.set(s,s,s),dt(this._groundMarker,t)}}}onUpdateScreenSpacePlane(){if(!this._selected||!this._context)return;const n=this._context.input.getPointerPositionRC(0);n&&(this._raycaster.setFromCamera(n,this._camera),this._cameraPlane.setFromNormalAndCoplanarPoint(this._camera.getWorldDirection(this._cameraPlane.normal),this._worldPosition.setFromMatrixPosition(this._selected.matrixWorld)),this._raycaster.ray.intersectPlane(this._cameraPlane,this._intersection)&&this._selected.parent&&(this._inverseMatrix.copy(this._selected.parent.matrixWorld).invert(),this._cameraPlaneOffset.copy(this._intersection).sub(this._worldPosition.setFromMatrixPosition(this._selected.matrixWorld))))}onUpdateGroundPlane(){if(!this._selected||!this._context)return;const n=te(this._selected),t=new no(q(0,.1,0).add(n),q(0,-1,0)),i=new Vn;i.testObject=o=>o!==this._selected;const s=this._context.physics.raycastFromRay(t,i);for(let o=0;o<s.length;o++){const r=s[o];if(!r.face||this.contains(this._selected,r.object))continue;const l=q(0,1,0);this._groundPlane.setFromNormalAndCoplanarPoint(l,r.point);break}this._hasGroundPlane=!0,this._groundPlane.setFromNormalAndCoplanarPoint(t.direction.multiplyScalar(-1),t.origin),this._raycaster.ray.intersectPlane(this._groundPlane,this._intersection),this._groundDistance=this._intersection.distanceTo(n),this._groundOffset.copy(this._intersection).sub(n)}contains(n,t){if(n===t)return!0;if(n.children){for(const i of n.children)if(this.contains(i,t))return!0}return!1}};let dR=Xw;a(dR,"geometry",new gs().setFromPoints([new x(0,0,0),new x(0,-1,0)]));var Qw=(n=>(n.File_Spawned="file-spawned",n))(Qw||{});class uR{constructor(t,i,s,o,r,l,c,h,d){a(this,"guid"),a(this,"file_name"),a(this,"file_hash"),a(this,"file_size"),a(this,"position"),a(this,"scale"),a(this,"seed"),a(this,"sender"),a(this,"downloadUrl"),a(this,"parentGuid"),a(this,"boundsSize"),this.seed=i,this.guid=s,this.file_name=o,this.file_hash=r,this.file_size=l,this.position=c,this.scale=h,this.sender=t,this.downloadUrl=d}}var To;(n=>{const t=new Map;function i(o){var r;t.has(o.guid)&&s(o.guid);const l=new j;t.set(o.guid,l);const c=new j;c.position.y=-.5,l.add(c);const h=new X(new ma(1,1,1,1,1,1),new Re({color:14540253,wireframe:!0,transparent:!0,opacity:.3}));h.position.y=.5,c.add(h);const d=new j;c.add(d);const u=new X(new ma(1,1,1,1,1,1),new Re({color:12307660,transparent:!0,opacity:.4}));u.position.y=.5,d.scale.y=.01,d.add(u);const p=new X(new zn(1,1,1,1),new Re({color:34,transparent:!0,opacity:.05,depthTest:!1}));return p.rotateX(-Math.PI/2),p.position.y=.51,u.add(p),o.parent.add(l),l.rotateY(Math.PI/2),o.position&&((r=l.position)==null||r.copy(o.position)),o.size&&(l.worldScale=new x().copy(o.size)),l.position.y=l.scale.y/2,{object:l,onProgress:g=>{d instanceof j&&d.scale.set(1,g,1)}}}n.addPreview=i;function s(o){const r=t.get(o);r&&(t.delete(o),r.removeFromParent())}n.removePreview=s})(To||(To={}));var pR=Object.defineProperty,mR=Object.getOwnPropertyDescriptor,Ka=(n,t,i,s)=>{for(var o=s>1?void 0:s?mR(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&pR(t,i,o),o};const Mn=C("debugdroplistener");class gR extends CustomEvent{constructor(t){super("object-added",{detail:t})}}const fR="blob";class Ds extends A{constructor(){super(...arguments),a(this,"useNetworking",!0),a(this,"dropArea"),a(this,"fitIntoVolume",!1),a(this,"fitVolumeSize",new x(1,1,1)),a(this,"placeAtHitPosition",!0),a(this,"onDropped",new Se),a(this,"onNetworkEvent",t=>{var i;if(!this.useNetworking){Mn&&console.debug("[DropListener] Ignoring networked event because networking is disabled",t);return}if((i=t.guid)!=null&&i.startsWith(this.guid)){const s=t.url;if(console.debug("[DropListener] Received networked event",t),s)if(Array.isArray(s))for(const o of s)this.addFromUrl(o,{screenposition:new re,point:t.point,size:t.size},!0);else this.addFromUrl(s,{screenposition:new re,point:t.point,size:t.size},!0)}}),a(this,"handlePaste",t=>{this.context.connection.allowEditing===!1||t.defaultPrevented||navigator.clipboard.readText().then(i=>{if(i&&(i.startsWith("http")||i.startsWith("https")||i.startsWith("blob"))){const s={screenposition:new re(this.context.input.mousePosition.x,this.context.input.mousePosition.y)};this.testIfIsInDropArea(s)&&this.addFromUrl(i,s,!1)}}).catch(console.warn)}),a(this,"onDrag",t=>{this.context.connection.allowEditing!==!1&&t.preventDefault()}),a(this,"onDrop",async t=>{if(this.context.connection.allowEditing===!1||(Mn&&console.log(t),!(t!=null&&t.dataTransfer))||t["droplistener:handled"])return;t.preventDefault();const i={screenposition:new re(t.offsetX,t.offsetY)};if(this.dropArea&&this.testIfIsInDropArea(i)===!1)return;t["droplistener:handled"]=!0;const s=t.dataTransfer.items;if(!s)return;const o=[];for(const r in s){const l=s[r];if(l.kind==="file"){const c=l.getAsFile();if(!c)continue;o.push(c)}else l.kind==="string"&&l.type=="text/plain"&&l.getAsString(c=>{this.addFromUrl(c,i,!1)})}o.length>0&&await this.addDroppedFiles(o,i)}),a(this,"_abort",null),a(this,"_addedObjects",new Array),a(this,"_addedModels",new Array)}onEnable(){this.context.renderer.domElement.addEventListener("dragover",this.onDrag),this.context.renderer.domElement.addEventListener("drop",this.onDrop),window.addEventListener("paste",this.handlePaste),this.context.connection.beginListen("droplistener",this.onNetworkEvent)}onDisable(){this.context.renderer.domElement.removeEventListener("dragover",this.onDrag),this.context.renderer.domElement.removeEventListener("drop",this.onDrop),window.removeEventListener("paste",this.handlePaste),this.context.connection.stopListen("droplistener",this.onNetworkEvent)}loadFromURL(t,i){this.addFromUrl(t,{screenposition:new re,point:i?.point,size:i?.size},!0)}forgetObjects(){this.removePreviouslyAddedObjects(!1)}async addFromUrl(t,i,s){Mn&&console.log("dropped url",t);try{if(t.startsWith("https://github.com/")){const l=t.split("/"),c=l[3],h=l[4],d=l[6],u=l.slice(7).join("/");t=`https://raw.githubusercontent.com/${c}/${h}/${d}/${u}`}else t.startsWith("https://polyhaven.com/a")&&(t=yR(t));if(!t)return null;const o=t.toLowerCase();if(o.endsWith(".hdr")||o.endsWith(".hdri")||o.endsWith(".exr")||o.endsWith(".png")||o.endsWith(".jpg")||o.endsWith(".jpeg"))return null;this.removePreviouslyAddedObjects();const r=await Du.loadFileFromURL(new URL(t),{guid:this.guid,context:this.context,parent:this.gameObject,point:i.point,size:i.size});if(r&&this._addedObjects.length<=0)return i.url=t,this.addObject(r,i,s)}catch{console.warn("String is not a valid URL",t)}return null}async addDroppedFiles(t,i){var s,o;if(Mn&&console.log("Add files",t),!!Array.isArray(t)&&t.length){this.deleteDropEvent(),this.removePreviouslyAddedObjects(),Yl(fR,null),(s=this._abort)==null||s.abort("New files dropped"),this._abort=new AbortController;for(const r of t){if(!r)continue;console.debug("Load file "+r.name);const l=await Du.loadFile(r,this.context,{guid:this.guid});if(l){this.dispatchEvent(new CustomEvent("file-dropped",{detail:r})),i.file=r;const c=this.addObject(l,i,!1);c&&this.context.connection.isConnected&&this.useNetworking&&(console.debug("Uploading dropped file to blob storage"),wr.upload(r,{abort:(o=this._abort)==null?void 0:o.signal}).then(h=>{h!=null&&h.download_url&&this._addedObjects.includes(c)&&this.sendDropEvent(h.download_url,c,l.contentMD5)}).catch(console.warn));break}}}}removePreviouslyAddedObjects(t=!0){if(t)for(const i of this._addedObjects)i.parent===this.gameObject&&Ti(i,!0,!0);this._addedObjects.length=0,this._addedModels.length=0}addObject(t,i,s){var o,r;const{model:l,contentMD5:c}=t;if(Mn&&console.log(`Dropped ${this.gameObject.name}`,l),!(l!=null&&l.scene))return console.warn("No object specified to add to scene",l),null;this.removePreviouslyAddedObjects();const h=l.scene;this.gameObject.attach(h),h.position.set(0,0,0),h.quaternion.identity(),this._addedObjects.push(h),this._addedModels.push(l);const d=new xi().setFromCenterAndSize(new x(0,this.fitVolumeSize.y*.5,0).add(this.gameObject.worldPosition),this.fitVolumeSize);if(Mn&&G.DrawWireBox3(d,255,5),this.fitIntoVolume&&Zv(h,d,{position:!this.placeAtHitPosition}),this.placeAtHitPosition&&i&&i.screenposition){h.visible=!1;const p=this.context.physics.raycast({screenPoint:this.context.input.convertScreenspaceToRaycastSpace(i.screenposition.clone())});if(h.visible=!0,p&&p.length>0)for(const g of p){const y=g.point.clone();Mn&&console.log("Place object at hit",g),Kv(h,y);break}}Fa.assignAnimationsFromFile(l,{createAnimationComponent:p=>Ri(p,Ut)});const u=new gR({sender:this,gltf:l,model:l,object:h,contentMD5:c,dropped:i.file||(i.url?new URL(i.url):void 0)});return this.dispatchEvent(u),(o=this.onDropped)==null||o.invoke(u.detail),!s&&(r=i.url)!=null&&r.startsWith("http")&&this.context.connection.isConnected&&h&&this.sendDropEvent(i.url,h,c),h}async sendDropEvent(t,i,s){if(!this.useNetworking){Mn&&console.debug("[DropListener] Ignoring networked event because networking is disabled",t);return}if(this.context.connection.isConnected){console.debug('Sending drop event "'+i.name+'"',t);const o=oi([i]),r={name:i.name,guid:this.guid,url:t,point:i.worldPosition.clone(),size:o.getSize(new x),contentMD5:s};this.context.connection.send("droplistener",r)}}deleteDropEvent(){this.context.connection.sendDeleteRemoteState(this.guid)}testIfIsInDropArea(t){if(this.dropArea){const i=this.context.input.convertScreenspaceToRaycastSpace(t.screenposition.clone());if(!this.context.physics.raycast({targets:[this.dropArea],screenPoint:i,recursive:!0,testObject:s=>!this._addedObjects.includes(s)}).length)return F()&&console.log(`Dropped outside of drop area for DropListener "${this.name}".`),!1}return!0}}Ka([m()],Ds.prototype,"useNetworking",2),Ka([m(j)],Ds.prototype,"dropArea",2),Ka([m()],Ds.prototype,"fitIntoVolume",2),Ka([m(x)],Ds.prototype,"fitVolumeSize",2),Ka([m()],Ds.prototype,"placeAtHitPosition",2),Ka([m(Se)],Ds.prototype,"onDropped",2);function yR(n){if(!n.startsWith("https://polyhaven.com/"))return n;const t="https://dl.polyhaven.org/file/ph-assets/Models/gltf/4k/",i=new URL(n).pathname.split("/").pop(),s=`${t}${i}/${i}_4k.gltf`;return console.log("Resolved polyhaven asset url",n,"\u2192",s),s}var Du;(n=>{async function t(s,o,r){const l=s.name.toLowerCase();return l.endsWith(".gltf")||l.endsWith(".glb")||l.endsWith(".fbx")||l.endsWith(".obj")||l.endsWith(".usdz")||l.endsWith(".vrm")||s.type==="model/gltf+json"||s.type==="model/gltf-binary"?new Promise((c,h)=>{const d=new FileReader;d.readAsArrayBuffer(s),d.onloadend=async u=>{const p=d.result,g=r.guid,y=new Dt(g),f=await fn().parseSync(o,p,s.name,y);if(f){const v=wr.hashMD5(p);c({model:f,contentMD5:v})}}}):(console.warn("Unsupported file type: "+l,s.type),null)}n.loadFile=t;async function i(s,o){return new Promise(async(r,l)=>{const c=new Dt(o.guid),h=s.toString();Mn&&G.DrawWireSphere(o.point,.1,16711680,3);const d=To.addPreview({guid:o.guid,parent:o.parent,position:o?.point,size:o?.size}),u=await fn().loadSync(o.context,h,h,c,p=>{d.onProgress(p.loaded/p.total)}).catch(console.warn);if(u){const p=await fetch(h).then(y=>y.arrayBuffer()),g=wr.hashMD5(p);Mn?setTimeout(()=>To.removePreview(o.guid),3e3):To.removePreview(o.guid),r({model:u,contentMD5:g})}else Mn?setTimeout(()=>To.removePreview(o.guid),3e3):To.removePreview(o.guid),console.warn("Unsupported file type: "+s.toString())})}n.loadFileFromURL=i})(Du||(Du={}));var vR=Object.defineProperty,bR=Object.getOwnPropertyDescriptor,If=(n,t,i,s)=>{for(var o=s>1?void 0:s?bR(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&vR(t,i,o),o};const Yw=class extends A{constructor(){super(...arguments),a(this,"parent",null),a(this,"object",null),a(this,"limitCount",60),a(this,"_currentCount",0),a(this,"_startPosition",null),a(this,"_startQuaternion",null),a(this,"_forwardPointerEvents",new Map)}start(){var n,t;if(this._currentCount=0,this._startPosition=null,this._startQuaternion=null,this.object||(this.object=this.gameObject),this.object){if(this.object===this.gameObject){const s=new Dt(this.guid);this.object=O.instantiate(this.object,{idProvider:s,keepWorldPosition:!1});const o=O.getComponent(this.object,Yw);o?.destroy();let r=this.object.getComponentInChildren(ui);r||(r=this.object.addComponent(ui,{dragMode:Ef.SnapToSurfaces}),r.guid=s.generateUUID());let l=O.getComponent(r.gameObject,qn);l||(l=r.gameObject.addComponent(qn),l.guid=s.generateUUID())}this.object.visible=!1;const i=this.gameObject.getComponent(ui);i&&(i.enabled=!1),this._startPosition=((n=this.object.position)==null?void 0:n.clone())??new x(0,0,0),this._startQuaternion=((t=this.object.quaternion)==null?void 0:t.clone())??new V(0,0,0,1)}this.gameObject.getComponentInParent(Ai)||this.gameObject.addComponent(Ai)}onEnable(){this.startCoroutine(this.cloneLimitIntervalFn())}onPointerEnter(n){n.used||this.object&&this.context.connection.allowEditing&&n.button===0&&this.context.input.setCursor("pointer")}onPointerExit(n){n.used||this.object&&this.context.connection.allowEditing&&n.button===0&&this.context.input.unsetCursor("pointer")}onPointerDown(n){if(n.used||!this.object||!this.context.connection.allowEditing||n.button!==0)return;const t=this.handleDuplication();if(t){const i=O.getComponent(t,ui);i?(i.onPointerDown(n),this._forwardPointerEvents.set(n.event.space,i)):console.warn("Duplicated object does not have DragControls",t)}else this._currentCount>=this.limitCount?console.warn(`[Duplicatable] Limit of ${this.limitCount} objects created within a few seconds reached. Please wait a moment before creating more objects.`):console.warn("[Duplicatable] Could not duplicate object.")}onPointerUp(n){if(n.used)return;const t=this._forwardPointerEvents.get(n.event.space);t&&(t.onPointerUp(n),this._forwardPointerEvents.delete(n.event.space))}*cloneLimitIntervalFn(){for(;this.activeAndEnabled&&!this.destroyed;)this._currentCount>0?this._currentCount-=1:this._currentCount<0&&(this._currentCount=0),yield $g(1)}handleDuplication(){var n;if(!this.object||this.limitCount>0&&this._currentCount>=this.limitCount||this.object===this.gameObject)return null;if(O.isDestroyed(this.object))return this.object=null,null;this.object.visible=!0,this._startPosition&&this.object.position.copy(this._startPosition),this._startQuaternion&&this.object.quaternion.copy(this._startQuaternion);const t=new Bn;this.parent||(this.parent=this.gameObject.parent),this.parent&&(t.parent=this.parent.guid??((n=this.parent.userData)==null?void 0:n.guid),t.keepWorldPosition=!0),t.position=this.worldPosition,t.rotation=this.worldQuaternion,t.context=this.context,this._currentCount+=1;const i=O.instantiateSynced(this.object,t);return console.assert(i!==this.object,"Duplicated object is original"),this.object.visible=!1,this._startPosition&&this.object.position.clone().copy(this._startPosition),this._startQuaternion&&this.object.quaternion.clone().copy(this._startQuaternion),i}};let Ja=Yw;If([m(j)],Ja.prototype,"parent",2),If([m(j)],Ja.prototype,"object",2),If([m()],Ja.prototype,"limitCount",2);var Bs=(n=>(n[n.PointerEnter=0]="PointerEnter",n[n.PointerExit=1]="PointerExit",n[n.PointerDown=2]="PointerDown",n[n.PointerUp=3]="PointerUp",n[n.PointerClick=4]="PointerClick",n[n.Drag=5]="Drag",n[n.Drop=6]="Drop",n[n.Scroll=7]="Scroll",n[n.UpdateSelected=8]="UpdateSelected",n[n.Select=9]="Select",n[n.Deselect=10]="Deselect",n[n.Move=11]="Move",n[n.InitializePotentialDrag=12]="InitializePotentialDrag",n[n.BeginDrag=13]="BeginDrag",n[n.EndDrag=14]="EndDrag",n[n.Submit=15]="Submit",n[n.Cancel=16]="Cancel",n))(Bs||{}),_R=Object.defineProperty,wR=Object.getOwnPropertyDescriptor,jf=(n,t,i,s)=>{for(var o=s>1?void 0:s?wR(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&_R(t,i,o),o};class Lf{constructor(){a(this,"eventID"),a(this,"callback",new Se)}}jf([m()],Lf.prototype,"eventID",2),jf([m(Se)],Lf.prototype,"callback",2);class Bu extends A{constructor(){super(...arguments),a(this,"triggers",[])}invoke(t){var i;if(this.triggers)for(const s of this.triggers)s.eventID===t&&((i=s.callback)==null||i.invoke())}hasTrigger(t){var i;return((i=this.triggers)==null?void 0:i.some(s=>s.eventID===t))??!1}shouldChangeCursor(){return this.hasTrigger(Bs.PointerClick)||this.hasTrigger(Bs.PointerDown)||this.hasTrigger(Bs.PointerUp)}onPointerClick(t){this.invoke(Bs.PointerClick)}onPointerEnter(t){this.shouldChangeCursor()&&this.context.input.setCursor("pointer"),this.invoke(Bs.PointerEnter)}onPointerExit(t){this.shouldChangeCursor()&&this.context.input.unsetCursor("pointer"),this.invoke(Bs.PointerExit)}onPointerDown(t){this.invoke(Bs.PointerDown)}onPointerUp(t){this.invoke(Bs.PointerUp)}}jf([m(Lf)],Bu.prototype,"triggers",2);class Zw{constructor(t){a(this,"writer"),this.writer=t}writeNode(t){}}class xR extends Zw{beforeWriteNode(t,i){G.isGizmo(t)&&(i.keep=!1)}}class Kw extends Zw{beforeWriteTexture(t,i){t.isRenderTargetTexture&&(i.newTexture=qg(new xe(1,1,1,0)))}}function Df(n){const t=Au.DontExport;return!(n.hideFlags&t)}const Bf=C("debugexr");class SR{constructor(t){a(this,"parser"),this.parser=t,Bf&&console.log(t)}get name(){return"EXT_texture_exr"}loadTexture(t){const i=this.name,s=this.parser,o=s.json.textures[t];if(Bf&&console.log("EXT_texture_exr.loadTexture",t,o),!o.extensions||!o.extensions[i])return null;const r=o.extensions[i],l=new pd(s.options.manager);return Bf&&console.log("EXT_texture_exr.loadTexture",r),s.loadTextureImage(t,r.source,l)}}typeof window<"u"&&window.addEventListener("unhandledrejection",n=>{});const Fs=bt,Fu="$___Export_Components",CR="NEEDLE_components";var Jw;class OR{constructor(){a(this,Jw)}}Jw=ur;class PR{constructor(t,i,s){a(this,"node"),a(this,"nodeIndex"),a(this,"nodeDef"),this.node=t,this.nodeIndex=i,this.nodeDef=s}}class ex{constructor(){a(this,"parser"),a(this,"nodeToObjectMap",{}),a(this,"gltf",null),a(this,"exportContext"),a(this,"objectToNodeMap",{}),a(this,"context"),a(this,"writer")}get name(){return CR}registerExport(t){t.register(i=>{if("serializeUserData"in i){const s=i.serializeUserData.bind(i);this.writer=i,i.serializeUserData=(o,r)=>{try{this.serializeUserData(o,r)&&(i.extensionsUsed[this.name]=!0),s(o,r)}finally{this.afterSerializeUserData(o,r)}}}return this})}beforeParse(){this.exportContext={},this.objectToNodeMap={}}serializeUserData(t,i){var s;const o=(s=t.userData)==null?void 0:s.components;return!o||o.length<=0?!1:(delete t.userData.components,t[Fu]=o,!0)}afterSerializeUserData(t,i){if(t.type==="Scene"&&Fs&&console.log("DONE",JSON.stringify(i)),t[Fu]===void 0)return;const s=t[Fu];delete t[Fu],s!==null&&(t.userData.components=s)}writeNode(t,i){const s=this.writer.json.nodes.length;Fs&&console.log(t.name,s,t.uuid);const o=new PR(t,s,i);this.exportContext[s]=o,this.objectToNodeMap[t.uuid]=s}afterParse(t){var i;Fs&&console.log("AFTER",t);for(const s in this.exportContext){const o=this.exportContext[s],r=o.node,l=o.nodeDef,c=o.nodeIndex,h=(i=r.userData)==null?void 0:i.components;if(!h||h.length<=0)continue;const d=new OR;l.extensions=l.extensions||{},l.extensions[this.name]=d,this.context.object=r,this.context.nodeId=c,this.context.objectToNode=this.objectToNodeMap;const u=[];for(const p of h){this.context.target=p;const g=fn().writeBuiltinComponentData(p,this.context);g!==null&&u.push(g)}u.length>0&&(d[ur]=u,Fs&&console.log("DID WRITE",r,"nodeIndex",c,u))}}beforeRoot(){return Fs&&console.log("BEGIN LOAD"),this.nodeToObjectMap={},null}async afterRoot(t){this.gltf=t;const i=t.parser,s=i?.extensions;if(!s)return;const o=s[this.name];Fs&&console.log("After root",t,this.parser,s);const r=[];if(o===!0){const l=i.json.nodes;if(l){for(let c=0;c<l.length;c++){const h=await i.getDependency("node",c);this.nodeToObjectMap[c]=h}for(let c=0;c<l.length;c++){const h=l[c],d=c,u=h.extensions;if(!u)continue;const p=u[this.name];if(!p)continue;Fs&&console.log("NODE",h);const g=this.nodeToObjectMap[d];if(!g){console.error("Could not find object for node index: "+d,h,i);continue}Gd(g),r.push(this.createComponents(g,p))}}}await Promise.all(r);for(const l of i.associations.keys()){const c=i.associations.get(l);if(c?.materials!=null){const h="/materials/"+c.materials;E2(l,h)}}}async createComponents(t,i){if(!i)return;const s=i[ur];if(s){const o=new Array;Fs&&console.log(t.name,s);for(const r in s){const l=s[r];Fs&&console.log("Serialized data",JSON.parse(JSON.stringify(l))),l&&this.parser&&o.push(jg(this.parser,l).catch(c=>console.error(`Error while resolving references (see console for details)
`,c,t,l))),t.userData=t.userData||{},t.userData[ur]=t.userData[ur]||[],t.userData[ur].push(l)}await Promise.all(o).catch(r=>{console.error("Error while loading components",r)})}}}const tx="NEEDLE_gameobject_data";class kR{constructor(t){a(this,"parser"),this.parser=t}get name(){return tx}afterRoot(t){var i;const s=[];for(let o=0;o<((i=this.parser.json.nodes)==null?void 0:i.length);o++){const r=this.parser.json.nodes[o];if(r&&r.extensions){const l=r.extensions[tx];if(l){const c=this.findAndApplyExtensionData(o,l);s.push(c)}}}return Promise.all(s).then(()=>null)}async findAndApplyExtensionData(t,i){const s=await this.parser.getDependency("node",t);s&&this.applyExtensionData(s,i)}applyExtensionData(t,i){i.layers===void 0&&(i.layers=0),t.userData.layer=i.layers,t.layers.disableAll(),t.layers.set(i.layers),t.userData.tag=i.tag??"none",t.hideFlags=0,t.userData.static=i.static??!1,t.visible=i.activeSelf??!0,t.guid=i.guid}}const ix="NEEDLE_lighting_settings",el=C("debugenvlight");class MR{constructor(t,i,s){a(this,"parser"),a(this,"sourceId"),a(this,"context"),this.parser=t,this.sourceId=i,this.context=s}get name(){return ix}afterRoot(t){const i=this.parser.json.extensions;if(i){const s=i[ix];if(s){el&&console.log('Loaded "'+this.name+'", src: "'+this.sourceId+'"',s);let o;if(t.scene.children.length===1){const r=t.scene.children[0];o=O.addComponent(r,zu,{},{callAwake:!1})}else{const r=new j;r.name="LightSettings "+this.sourceId,t.scene.add(r),o=O.addComponent(r,zu,{},{callAwake:!1})}o.sourceId=this.sourceId,o.ambientIntensity=s.ambientIntensity,o.ambientLight=new ae().fromArray(s.ambientLight),Array.isArray(s.ambientTrilight)&&(o.ambientTrilight=s.ambientTrilight.map(r=>new ae().fromArray(r))),o.ambientMode=s.ambientMode,o.environmentReflectionSource=s.environmentReflectionSource}}return null}}ue.registerCallback(pe.ContextCreated,n=>{const t=n.context,i=O.findObjectOfType(zu,t);i!=null&&i.sourceId&&(i.enabled=!0)});class zu extends A{constructor(){super(...arguments),a(this,"ambientMode",Ua.Skybox),a(this,"ambientLight"),a(this,"ambientTrilight"),a(this,"ambientIntensity",1),a(this,"environmentReflectionSource",lu.Skybox),a(this,"_hasReflection",!1),a(this,"_ambientLightObj"),a(this,"_hemisphereLightObj")}awake(){var t;if(this.sourceId){const s=this.environmentReflectionSource===lu.Skybox?go.Skybox:go.Reflection,o=this.context.lightmaps.tryGet(this.sourceId,s,0);this._hasReflection=o!=null,o&&this.context.sceneLighting.internalRegisterReflection(this.sourceId,o)}this.enabled=!1,this.context.sceneLighting.internalRegisterSceneLightSettings(this),el&&window.addEventListener("keydown",s=>{if(!this.destroyed)switch(s.key){case"l":this.enabled=!this.enabled;break}});const i=(t=this.gameObject.userData)==null?void 0:t.components;if(i){const s=i.indexOf(this);i.splice(s,1),i.push(this)}}onDestroy(){this.context.sceneLighting.internalUnregisterSceneLightSettings(this)}calculateIntensityFactor(t){const i=Math.max(t.r,t.g,t.b);return 2.2*W.lerp(0,1.33,i)}onEnable(){if(el&&console.warn("\u{1F4A1}\u{1F7E1} >>> Enable lighting",this.sourceId,this.enabled,this),this.ambientMode==Ua.Flat){if(this.ambientLight&&!this._ambientLightObj){const t=this.calculateIntensityFactor(this.ambientLight);this._ambientLightObj=new FS(this.ambientLight,this.ambientIntensity*t),el&&console.log("Created ambient light",this.sourceId,this._ambientLightObj,this.ambientIntensity,t)}this._ambientLightObj&&this.gameObject.add(this._ambientLightObj)}else if(this.ambientMode===Ua.Trilight){if(this.ambientTrilight){const t=this.ambientTrilight[0],i=this.ambientTrilight[this.ambientTrilight.length-1],s=this.calculateIntensityFactor(i);this._hemisphereLightObj=new zS(i,t,this.ambientIntensity*s),this.gameObject.add(this._hemisphereLightObj),el&&console.log("Created hemisphere ambient light",this.sourceId,this._hemisphereLightObj,this.ambientIntensity,s)}}else this._ambientLightObj&&this._ambientLightObj.removeFromParent(),this._hemisphereLightObj&&this._hemisphereLightObj.removeFromParent();this.sourceId&&this.context.sceneLighting.internalEnableReflection(this.sourceId)}onDisable(){el&&console.warn("\u{1F4A1}\u26AB <<< Disable lighting:",this.sourceId,this),this._ambientLightObj&&this._ambientLightObj.removeFromParent(),this._hemisphereLightObj&&this._hemisphereLightObj.removeFromParent(),this.sourceId&&this.context.sceneLighting.internalDisableReflection(this.sourceId)}}const Ff=C("debugstencil");function RR(n,t){return(n&1<<t.layer)!=0}const TR=Symbol("stencils"),tl=class{constructor(n,t){a(this,"parser"),a(this,"source"),this.parser=n,this.source=t}get name(){return"NEEDLE_render_objects"}static applyStencil(n){if(!n)return;const t=n.sourceId;if(Ff&&console.log(t,tl.stencils),!t)return;const i=tl.stencils[t];if(i)for(let s=i.length-1;s>=0;s--){const o=i[s];if(RR(o.layer,n)){Ff&&console.log(o),setTimeout(()=>{Xt()&&Qd(n.gameObject)&&(we("Stencil not supported on instanced objects"),console.warn("Stencil not supported on instanced objects",n))},500);for(let r=0;r<n.sharedMaterials.length;r++){let l=n.sharedMaterials[r];l&&(l=l.clone(),l[TR]=!0,l.stencilWrite=!0,l.stencilWriteMask=255,l.stencilFuncMask=255,l.stencilRef=o.value,l.stencilFunc=o.compareFunc,l.stencilZPass=o.passOp,l.stencilFail=o.failOp,l.stencilZFail=o.zFailOp,n.sharedMaterials[r]=l)}n.gameObject.renderOrder=o.event*1e3+o.index*50;break}}}afterRoot(n){const t=this.parser.json.extensions;if(t){const i=t[AR];if(i){Ff&&console.log(i);const s=i.stencil;if(s&&Array.isArray(s))for(const o of s){const r={...o};r.compareFunc=ER(r.compareFunc),r.passOp=Uf(r.passOp),r.failOp=Uf(r.failOp),r.zFailOp=Uf(r.zFailOp),tl.stencils[this.source]||(tl.stencils[this.source]=[]),tl.stencils[this.source].push(r)}}}return null}};let zf=tl;a(zf,"stencils",{});function Uf(n){switch(n){case 0:return qS;case 1:return GS;case 2:return $S;case 3:return HS;case 4:return VS;case 6:return WS;case 7:return NS;case 5:return US}return 0}function ER(n){switch(n){case 1:return Xy;case 2:return eC;case 3:return JS;case 4:return KS;case 5:return ZS;case 6:return YS;case 7:return QS;case 8:return XS}return Xy}const AR="NEEDLE_render_objects";var nx=(n=>(n[n.INT=5124]="INT",n[n.FLOAT=5126]="FLOAT",n[n.FLOAT_VEC2=35664]="FLOAT_VEC2",n[n.FLOAT_VEC3=35665]="FLOAT_VEC3",n[n.FLOAT_VEC4=35666]="FLOAT_VEC4",n[n.INT_VEC2=35667]="INT_VEC2",n[n.INT_VEC3=35668]="INT_VEC3",n[n.INT_VEC4=35669]="INT_VEC4",n[n.BOOL=35670]="BOOL",n[n.BOOL_VEC2=35671]="BOOL_VEC2",n[n.BOOL_VEC3=35672]="BOOL_VEC3",n[n.BOOL_VEC4=35673]="BOOL_VEC4",n[n.FLOAT_MAT2=35674]="FLOAT_MAT2",n[n.FLOAT_MAT3=35675]="FLOAT_MAT3",n[n.FLOAT_MAT4=35676]="FLOAT_MAT4",n[n.SAMPLER_2D=35678]="SAMPLER_2D",n[n.SAMPLER_3D=35680]="SAMPLER_3D",n[n.SAMPLER_CUBE=35681]="SAMPLER_CUBE",n[n.UNKNOWN=0]="UNKNOWN",n))(nx||{});const es=C("debugcustomshader"),il="NEEDLE_techniques_webgl";class IR{constructor(){a(this,"objectToWorldMatrix",new se),a(this,"worldToObjectMatrix",new se),a(this,"objectToWorld",new Array),a(this,"worldToObject",new Array)}updateFrom(t){this.objectToWorldMatrix.copy(t.matrixWorld),au(this.objectToWorldMatrix,this.objectToWorld),this.worldToObjectMatrix.copy(t.matrixWorld).invert(),au(this.worldToObjectMatrix,this.worldToObject)}}const We=class extends Qy{constructor(n,...t){super(...t),a(this,"identifier"),a(this,"onBeforeRenderSceneCallback",this.onBeforeRenderScene.bind(this)),a(this,"_sphericalHarmonicsName","unity_SpecCube0"),a(this,"_objToWorldName","hlslcc_mtx4x4unity_ObjectToWorld"),a(this,"_worldToObjectName","hlslcc_mtx4x4unity_WorldToObject"),a(this,"_viewProjectionName","hlslcc_mtx4x4unity_MatrixVP"),a(this,"_viewMatrixName","hlslcc_mtx4x4unity_MatrixV"),a(this,"_rendererData",new IR),this.identifier=n,es&&console.log(this),this.type="NEEDLE_CUSTOM_SHADER",this.uniforms[this._objToWorldName]||(this.uniforms[this._objToWorldName]={value:[]}),this.uniforms[this._worldToObjectName]||(this.uniforms[this._worldToObjectName]={value:[]}),this.uniforms[this._viewProjectionName]||(this.uniforms[this._viewProjectionName]={value:[]}),this.uniforms[this._sphericalHarmonicsName],(this.depthTextureUniform||this.opaqueTextureUniform)&&ee.Current.pre_render_callbacks.push(this.onBeforeRenderSceneCallback)}clone(){const n=super.clone();return sx(n),n}dispose(){super.dispose();const n=ee.Current.pre_render_callbacks.indexOf(this.onBeforeRenderSceneCallback);n>=0&&ee.Current.pre_render_callbacks.splice(n,1)}get depthTextureUniform(){if(this.uniforms)return this.uniforms._CameraDepthTexture}get opaqueTextureUniform(){if(this.uniforms)return this.uniforms._CameraOpaqueTexture}onBeforeRenderScene(){this.opaqueTextureUniform&&ee.Current.setRequireColor(!0),this.depthTextureUniform&&ee.Current.setRequireDepth(!0)}onBeforeRender(n,t,i,s,o,r){s.attributes.tangent||s.computeTangents(),this.onUpdateUniforms(i,o)}onUpdateUniforms(n,t){const i=ee.Current;if(n&&(We.viewProjection&&this.uniforms[this._viewProjectionName]&&(We.viewProjection.copy(n.projectionMatrix).multiply(n.matrixWorldInverse),au(We.viewProjection,We._viewProjectionValues)),We.viewMatrix&&this.uniforms[this._viewMatrixName]&&(We.viewMatrix.copy(n.matrixWorldInverse),au(We.viewMatrix,We._viewMatrixValues)),this.uniforms[We._worldSpaceCameraPosName]&&We._worldSpaceCameraPos.setFromMatrixPosition(n.matrixWorld)),this.uniforms._TimeParameters&&(this.uniforms._TimeParameters.value=i.sceneLighting.timeVec4),this.uniforms._Time){const l=this.uniforms._Time.value;l.x=i.sceneLighting.timeVec4.x/20,l.y=i.sceneLighting.timeVec4.x,l.z=i.sceneLighting.timeVec4.x*2,l.w=i.sceneLighting.timeVec4.x*3}if(this.uniforms._SinTime){const l=this.uniforms._SinTime.value;l.x=Math.sin(i.sceneLighting.timeVec4.x/8),l.y=Math.sin(i.sceneLighting.timeVec4.x/4),l.z=Math.sin(i.sceneLighting.timeVec4.x/2),l.w=Math.sin(i.sceneLighting.timeVec4.x)}if(this.uniforms._CosTime){const l=this.uniforms._CosTime.value;l.x=Math.cos(i.sceneLighting.timeVec4.x/8),l.y=Math.cos(i.sceneLighting.timeVec4.x/4),l.z=Math.cos(i.sceneLighting.timeVec4.x/2),l.w=Math.cos(i.sceneLighting.timeVec4.x)}if(this.uniforms.unity_DeltaTime){const l=this.uniforms.unity_DeltaTime.value;l.x=i.time.deltaTime,l.y=1/i.time.deltaTime,l.z=i.time.smoothedDeltaTime,l.w=1/i.time.smoothedDeltaTime}const s=i.mainLight;if(s){const l=te(s.gameObject,We._mainLightPosition);this.uniforms._MainLightPosition={value:l.normalize()},We._mainLightColor.set(s.color.r,s.color.g,s.color.b,0),this.uniforms._MainLightColor={value:We._mainLightColor};const c=s.intensity;We._lightData.z=c,this.uniforms.unity_LightData={value:We._lightData}}if(n&&(We.viewProjection&&this.uniforms[this._viewProjectionName]&&(this.uniforms[this._viewProjectionName].value=We._viewProjectionValues),We.viewMatrix&&this.uniforms[this._viewMatrixName]&&(this.uniforms[this._viewMatrixName].value=We._viewMatrixValues),this.uniforms[We._worldSpaceCameraPosName]&&(this.uniforms[We._worldSpaceCameraPosName]={value:We._worldSpaceCameraPos}),i.mainCameraComponent)){if(this.uniforms._ProjectionParams){const l=this.uniforms._ProjectionParams.value;l.x=1,l.y=i.mainCameraComponent.nearClipPlane,l.z=i.mainCameraComponent.farClipPlane,l.w=1/l.z,this.uniforms._ProjectionParams.value=l}if(this.uniforms._ZBufferParams){const l=this.uniforms._ZBufferParams.value,c=i.mainCameraComponent;l.x=1-c.farClipPlane/c.nearClipPlane,l.y=c.farClipPlane/c.nearClipPlane,l.z=l.x/c.farClipPlane,l.w=l.y/c.farClipPlane,this.uniforms._ZBufferParams.value=l}if(this.uniforms._ScreenParams){const l=this.uniforms._ScreenParams.value;l.x=i.domWidth,l.y=i.domHeight,l.z=1+1/l.x,l.w=1+1/l.y,this.uniforms._ScreenParams.value=l}if(this.uniforms._ScaledScreenParams){const l=this.uniforms._ScaledScreenParams.value;l.x=i.domWidth,l.y=i.domHeight,l.z=1+1/l.x,l.w=1+1/l.y,this.uniforms._ScaledScreenParams.value=l}}const o=this.depthTextureUniform;o&&(o.value=i.depthTexture);const r=this.opaqueTextureUniform;if(r&&(r.value=i.opaqueColorTexture),t){const l=this._rendererData;l.updateFrom(t),this.uniforms[this._worldToObjectName].value=l.worldToObject,this.uniforms[this._objToWorldName].value=l.objectToWorld}this.uniformsNeedUpdate=!0}};let Rn=We;a(Rn,"viewProjection",new se),a(Rn,"_viewProjectionValues",[]),a(Rn,"viewMatrix",new se),a(Rn,"_viewMatrixValues",[]),a(Rn,"_worldSpaceCameraPosName","_WorldSpaceCameraPos"),a(Rn,"_worldSpaceCameraPos",new x),a(Rn,"_mainLightColor",new fe),a(Rn,"_mainLightPosition",new x),a(Rn,"_lightData",new fe);class jR{constructor(t,i){a(this,"parser"),a(this,"identifier"),this.parser=t,this.identifier=i}get name(){return il}loadMaterial(t){const i=this.parser.json.materials[t];if(!i)return es&&console.log(t,this.parser.json.materials),null;if(!i.extensions||!i.extensions[il])return es&&console.log(`Material ${t} does not use NEEDLE_techniques_webgl`),null;es&&console.log(`Material ${t} uses NEEDLE_techniques_webgl`,i);const s=i.extensions[il].technique;if(s<0)return console.debug(`Material ${t} does not have a valid technique index`),null;const o=this.parser.json.extensions[il];if(!o)return es?console.error("Missing shader data",this.parser.json.extensions):console.debug("Missing custom shader data in parser.json.extensions"),null;es&&console.log(o);const r=o.techniques[s];return r?new Promise(async(l,c)=>{var h,d,u;const p=await ak(o,r.program),g=p?.fragmentShader,y=p?.vertexShader;if(!g||!y)return c();es&&console.log("loadMaterial",i,p);const f={},v=r.uniforms;(y.includes("_Time")||g.includes("_Time"))&&(f._Time={value:new fe(0,0,0,0)}),(y.includes("_SinTime")||g.includes("_SinTime"))&&(f._SinTime={value:new fe(0,0,0,0)}),(y.includes("_CosTime")||g.includes("_CosTime"))&&(f._CosTime={value:new fe(0,0,0,0)}),(y.includes("unity_DeltaTime")||g.includes("unity_DeltaTime"))&&(f.unity_DeltaTime={value:new fe(0,0,0,0)});for(const _ in v){const S=_;switch(S){case"_TimeParameters":const R=new fe;f[S]={value:R};break;case"hlslcc_mtx4x4unity_MatrixV":case"hlslcc_mtx4x4unity_MatrixVP":f[S]={value:[]};break;case"_MainLightPosition":case"_MainLightColor":case"_WorldSpaceCameraPos":f[S]={value:[0,0,0,1]};break;case"unity_OrthoParams":break;case"unity_SpecCube0":f[S]={value:null};break;default:case"_ScreenParams":case"_ZBufferParams":case"_ProjectionParams":f[S]={value:[0,0,0,0]};break;case"_CameraOpaqueTexture":case"_CameraDepthTexture":f[S]={value:null};break}}let b=!1;if(i.extensions&&i.extensions[il]){const _=i.extensions[il];if(_.technique===s){es&&console.log(i.name,"Material Properties",_);for(const S in _.values){const R=_.values[S];if(typeof R=="string"){if(R.startsWith("/textures/")){const M=R.substring(10),T=Number.parseInt(M);if(T>=0){const L=await this.parser.getDependency("texture",T);L instanceof Le&&(L.colorSpace=rr,L.needsUpdate=!0),f[S]={value:L};continue}}switch(S){case"alphaMode":R==="BLEND"&&(b=!0);continue}}if(Array.isArray(R)&&R.length===4){f[S]={value:new fe(R[0],R[1],R[2],R[3])};continue}f[S]={value:R}}}}const w=new Rn(this.identifier,{name:i.name??"",uniforms:f,vertexShader:y,fragmentShader:g,lights:!1});switch(w.glslVersion=tC,w.vertexShader=w.vertexShader.replace("#version 300 es",""),w.fragmentShader=w.fragmentShader.replace("#version 300 es",""),(h=f._Cull)==null?void 0:h.value){case 0:w.side=Ci;break;case 1:w.side=cd;break;case 2:w.side=ro;break;default:w.side=ro;break}switch((d=f._ZTest)==null?void 0:d.value){case 3:w.depthTest=!0,w.depthFunc=lC;break;case 6:w.depthTest=!0,w.depthFunc=aC;break;case 2:w.depthTest=!0,w.depthFunc=rC;break;case 4:w.depthTest=!0,w.depthFunc=oC;break;case 5:w.depthTest=!0,w.depthFunc=sC;break;case 7:w.depthTest=!0,w.depthFunc=nC;break;case 8:w.depthTest=!1,w.depthFunc=iC;break}w.transparent=b,b&&(w.depthWrite=!1),ok(f),w.onUpdateUniforms();for(const _ in v){const S=_,R=v[_].type;if(((u=f[S])==null?void 0:u.value)===void 0)switch(R){case nx.SAMPLER_2D:f[S]={value:nk},console.warn("Missing/unassigned texture, fallback to white: "+S);break;default:S==="unity_OrthoParams"||console.warn("TODO: EXPECTED UNIFORM / fallback NOT SET: "+S,v[_]);break}}es&&console.log(w.uuid,f),sx(w),l(w)}):null}}function sx(n){if(n.uniforms){es&&console.log("Uniforms:",n.uniforms);for(const i in n.uniforms)switch(t(i,i),i){case"_Color":t("color",i);break}}function t(i,s){Object.getOwnPropertyDescriptor(n,i)||Object.defineProperty(n,i,{get:()=>n.uniforms[s].value,set:o=>{n.uniforms[s].value=o,n.needsUpdate=!0}})}}const LR=C("debugextensions");let Uu;const DR=import("./three-examples.min.js").then(n=>n.GLTFLoaderAnimationPointer).then(async n=>(Uu=n.GLTFAnimationPointerExtension,Uu)).catch(n=>{console.warn("Failed to import GLTFLoaderAnimationPointer. Please use @needle-tools/three for full KHR_animation support",n)}),jr=new Array;function BR(n){jr.includes(n)||jr.push(n)}function FR(n){const t=jr.indexOf(n);t>=0&&jr.splice(t,1)}function Nu(n){const t=new ex;return n.register(i=>(t.parser=i,t)),t}class zR{resolvePath(t){return t.includes("/extensions/builtin_components/")?t.replace("/extensions/builtin_components/","/userData/components/"):t.includes("extensions/builtin_components/")?t.replace("extensions/builtin_components/","/userData/components/"):t}}async function Wu(n,t,i){const s=i.indexOf("?");s>=0&&(i=i.substring(0,s)),n.register(o=>new kR(o)),n.register(o=>new I2(o)),n.register(o=>new J2(o,t.lightmaps,i)),n.register(o=>new MR(o,i,t)),n.register(o=>new jR(o,i)),n.register(o=>new zf(o,i)),n.register(o=>new it(o,i)),n.register(o=>new SR(o)),Gb()&&n.register(o=>new bg(o)),await DR.catch(o=>{}),n.register(o=>{if(Uu){const r=new Uu(o);return r.setAnimationPointerResolver.bind(r)(new zR),r}else return(LR||F())&&console.error("Missing KHR_animation_pointer extension..."),{name:"KHR_animation_pointer_NOT_AVAILABLE"}});for(const o of jr)o.onImport&&o.onImport(n,i,t)}function Nf(n,t){for(const i of jr)i.onExport&&i.onExport(n,t)}function Wf(n,t,i){for(const s of jr)s.onLoaded&&s.onLoaded(n,t,i)}class ox{constructor(t){this.writer=t,this.name="EXT_mesh_gpu_instancing"}writeNode(t,i){if(t.constructor.name!=="InstancedMesh")return;const s=this.writer,o=s.extensionsUsed,r={};i.extensions=i.extensions||{},i.extensions[this.name]=r;let l=new se;const c=new Array,h=new Array,d=new Array;for(let y=0;y<t.count;y++){t.getMatrixAt(y,l);let f=new x,v=new V,b=new x;l.decompose(f,v,b),c.push(f.x,f.y,f.z),h.push(v.x,v.y,v.z,v.w),d.push(b.x,b.y,b.z)}const u=new Float32Array(c),p=new Float32Array(h),g=new Float32Array(d);r.attributes={TRANSLATION:s.processAccessor(new yt(u,3)),ROTATION:s.processAccessor(new yt(p,4)),SCALE:s.processAccessor(new yt(g,3))},o[this.name]=!0}}var UR=Object.defineProperty,NR=Object.getOwnPropertyDescriptor,rx=(n,t,i,s)=>{for(var o=s>1?void 0:s?NR(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&UR(t,i,o),o};const Vu=C("debugreflectionprobe"),ax=C("noreflectionprobe"),WR=Symbol("reflectionProbeKey"),VR=Symbol("original material");var Hu;const zs=(Hu=class extends A{constructor(){var n;super(),a(this,"_texture"),a(this,"center"),a(this,"size"),a(this,"_boxHelper"),zs._probes.has(this.context)||zs._probes.set(this.context,[]),(n=zs._probes.get(this.context))==null||n.push(this)}static get(n,t,i,s){if(!n||n.isObject3D!==!0||ax)return null;const o=zs._probes.get(t);if(o){for(const r of o)if(r.__didAwake||r.__internalAwake(),r.enabled&&s&&r.gameObject===s)return r}return Vu&&console.debug("Did not find reflection probe",n.name,i,n),null}set texture(n){if(n&&!(n instanceof Le)){console.error("ReflectionProbe.texture must be a Texture",n);return}this._texture=n,n&&(n.mapping=ys,n.colorSpace=gn,n.needsUpdate=!0)}get texture(){return this._texture}isInBox(n){var t;return(t=this._boxHelper)==null?void 0:t.isInBox(n)}awake(){this._boxHelper=this.gameObject.addComponent(Ki),this._boxHelper.updateBox(!0),Vu&&this._boxHelper.showHelper(5592320,!0),this.texture&&(this.texture.mapping=ys,this.texture.colorSpace=gn,this.texture.needsUpdate=!0)}onDestroy(){const n=zs._probes.get(this.context);if(n){const t=n.indexOf(this);t>=0&&n.splice(t,1)}}onSet(n){var t;if(ax||!this.enabled||((t=n.sharedMaterials)==null?void 0:t.length)<=0||!this.texture)return;let i=zs._rendererMaterialsCache.get(n);i||(i=[],zs._rendererMaterialsCache.set(n,i));for(let s=0;s<n.sharedMaterials.length;s++){const o=n.sharedMaterials[s];if(!o||o.envMap===void 0||o instanceof Re)continue;let r=i[s];const l=o===r?.copy,c=!r||r.material.uuid!==o.uuid||r.copy.version!==o.version;if(!l&&c){if(Vu){let u="";r?r.material!==o?u="reference changed; cached instance?: "+l:r.copy.version!==o.version&&(u="version changed"):u="not cached",console.warn("Cloning material",o.name,o.version,"Reason:",u,`
`,o.uuid,`
`,r?.copy.uuid,`
`,n.name)}const d=o.clone();d.version=o.version,r?(r.copy=d,r.material=o):(r={material:o,copy:d},i.push(r)),d[WR]=this,d[VR]=o,Vu&&console.log("Set reflection",n.name,n.guid)}r&&r.copy&&(r.copy.onBeforeCompile=o.onBeforeCompile);const h=r?.copy;h.envMap=this.texture,n.sharedMaterials[s]=h}}onUnset(n){const t=zs._rendererMaterialsCache.get(n);if(t)for(let i=0;i<t.length;i++){const s=t[i];n.sharedMaterials[i]=s.material}}},a(Hu,"_probes",new Map),a(Hu,"_rendererMaterialsCache",new Map),Hu);let nl=zs;rx([m(x)],nl.prototype,"center",2),rx([m(x)],nl.prototype,"size",2);const pi=C("debuginstancing"),Vf=class{constructor(){a(this,"objs",[])}setup(n,t,i,s,o,r=0){n.applySettings(t);const l=this.tryCreateOrAddInstance(t,i,o);if(l){s===null&&(s=[]),s.push(l),it.assignTextureLOD(l.renderer.material,0);for(let c=0;c<n.sharedMeshes.length;c++){const h=n.sharedMeshes[c],d=h.geometry;it.assignMeshLOD(h,0).then(u=>{u&&n.activeAndEnabled&&d!=u&&l.setGeometry(u)})}}else if(r<=0&&t.type!=="Mesh"){const c=r+1;for(const h of t.children)s=this.setup(n,h,i,s,o,c)}return r===0&&o.useMatrixWorldAutoUpdate&&s&&s.length>=0&&this.autoUpdateInstanceMatrix(t),s}tryCreateOrAddInstance(n,t,i){if(n.type==="Mesh"){const s=i.foundMeshes;if(i.foundMeshes+=1,!i.rend.enableInstancing)return null;if(i.rend.enableInstancing!==!0){if(s>=i.rend.enableInstancing.length)return pi&&console.error("Something is wrong with instance setup",n,i.rend.enableInstancing,s),null;if(!i.rend.enableInstancing[s])return null}const o=n,r=o.material;for(const d of this.objs)if(!!d.canAdd(o.geometry,r))return d.addInstance(o);let l=Vf.getStartInstanceCount(n);(!l||l<0)&&(l=4);let c=n.name;c!=null&&c.length||(c=Cv());const h=new lx(c,o.geometry,r,l,t);return this.objs.push(h),h.addInstance(o)}return null}autoUpdateInstanceMatrix(n){const t=n.matrixWorld.multiplyMatrices.bind(n.matrixWorld),i=n.matrixWorld.clone(),s=(o,r)=>{const l=t(o,r);return(n[vc]||i.equals(l)===!1)&&(i.copy(l),n[vc]=!0),l};n.matrixWorld.multiplyMatrices=s}};let sl=Vf;a(sl,"instance",new Vf),a(sl,"getStartInstanceCount",n=>4);const $u=class{constructor(n,t){a(this,"object"),a(this,"renderer"),a(this,"__instanceIndex",-1),a(this,"__reservedVertexRange",0),a(this,"__reservedIndexRange",0),a(this,"__geometryIndex",-1),a(this,"meshInformation"),this.__instanceIndex=-1,this.object=n,this.renderer=t,n[Kb]=t,this.meshInformation=Lr(n.geometry),$u.all.push(this)}get name(){return this.object.name}get isActive(){return this.__instanceIndex>=0}get vertexCount(){return this.object.geometry.attributes.position.count}get maxVertexCount(){return Math.max(this.meshInformation.vertexCount,this.vertexCount)}get reservedVertexCount(){return this.__reservedVertexRange}get indexCount(){return this.object.geometry.index?this.object.geometry.index.count:0}get maxIndexCount(){return Math.max(this.meshInformation.indexCount,this.indexCount)}get reservedIndexCount(){return this.__reservedIndexRange}updateMeshInformation(){const n=Lr(this.object.geometry),t=this.meshInformation.vertexCount,i=this.meshInformation.indexCount;return Object.assign(this.meshInformation,n),t!==this.meshInformation.vertexCount||i!==this.meshInformation.indexCount}updateInstanceMatrix(n=!1,t=!0){this.__instanceIndex<0||(t&&this.object.updateWorldMatrix(!0,n),this.renderer.updateInstance(this.object.matrixWorld,this.__instanceIndex))}setMatrix(n){this.__instanceIndex<0||this.renderer.updateInstance(n,this.__instanceIndex)}setGeometry(n){if(this.__geometryIndex<0)return!1;const t=this;if(this.vertexCount>this.__reservedVertexRange)return i(`Instancing: Can not update geometry (${this.name}), reserved vertex range is too small: ${this.__reservedVertexRange.toLocaleString()} < ${this.vertexCount.toLocaleString()} vertices for ${this.name}`);if(this.indexCount>this.__reservedIndexRange)return i(`Instancing: Can not update geometry (${this.name}), reserved index range is too small: ${this.__reservedIndexRange.toLocaleString()} < ${this.indexCount.toLocaleString()} indices for ${this.name}`);return this.renderer.updateGeometry(n,this.__geometryIndex);function i(s){return t.updateMeshInformation()&&(t.renderer.remove(t,!0),t.renderer.add(t))?!0:((F()||pi)&&console.error(s),!1)}}add(){this.__instanceIndex>=0||(this.renderer.add(this),O.markAsInstancedRendered(this.object,!0))}remove(n){if(!(this.__instanceIndex<0)&&(this.renderer.remove(this,n),O.markAsInstancedRendered(this.object,!1),n)){const t=$u.all.indexOf(this);t>=0&&$u.all.splice(t,1)}}};let Gu=$u;a(Gu,"all",[]);class lx{constructor(t,i,s,o,r){a(this,"allowResize",!0),a(this,"name",""),a(this,"geometry"),a(this,"material"),a(this,"_context"),a(this,"_batchedMesh"),a(this,"_handles",[]),a(this,"_geometryIds",new Map),a(this,"_maxInstanceCount"),a(this,"_currentInstanceCount",0),a(this,"_currentVertexCount",0),a(this,"_currentIndexCount",0),a(this,"_maxVertexCount"),a(this,"_maxIndexCount"),a(this,"_needUpdateBounds",!1),a(this,"_debugMaterial",null),a(this,"onBeforeRender",()=>{this._batchedMesh.layers.enableAll(),this._needUpdateBounds&&this._batchedMesh[bc]===!0&&(pi==="verbose"&&console.log("Update instancing bounds",this.name,this._batchedMesh.matrixWorldNeedsUpdate),this.updateBounds())}),a(this,"onAfterRender",()=>{this._batchedMesh.layers.disableAll()}),this.name=t,this.geometry=i,this.material=s,this._context=r,this._maxInstanceCount=Math.max(2,o),pi&&(this._debugMaterial=cx());const l=this.tryEstimateVertexCountSize(this._maxInstanceCount,[i],o);this._maxVertexCount=l.vertexCount,this._maxIndexCount=l.indexCount,this._batchedMesh=new Yy(this._maxInstanceCount,this._maxVertexCount,this._maxIndexCount,this._debugMaterial??this.material),this._batchedMesh[bc]=!0,this._batchedMesh.visible=!0,this._context.scene.add(this._batchedMesh),s instanceof Qy&&(s.defines.USE_INSTANCING=!0,s.needsUpdate=!0),r.pre_render_callbacks.push(this.onBeforeRender),r.post_render_callbacks.push(this.onAfterRender),pi&&console.log(`Instanced renderer created with ${this._maxInstanceCount} instances, ${this._maxVertexCount} max vertices and ${this._maxIndexCount} max indices for "${t}"`)}get batchedMesh(){return this._batchedMesh}get visible(){return this._batchedMesh.visible}set visible(t){this._batchedMesh.visible=t}get castShadow(){return this._batchedMesh.castShadow}set castShadow(t){this._batchedMesh.castShadow=t}set receiveShadow(t){this._batchedMesh.receiveShadow=t}get count(){return this._currentInstanceCount}updateBounds(t=!0,i=!0){if(this._needUpdateBounds=!1,t&&this._batchedMesh.computeBoundingBox(),i&&this._batchedMesh.computeBoundingSphere(),pi&&this._batchedMesh.boundingSphere){const s=this._batchedMesh.boundingSphere;G.DrawWireSphere(s.center,s.radius,65280)}}canAdd(t,i){return this._maxVertexCount>1e7||i!==this.material||!this.validateGeometry(t)?!1:!!(!this.mustGrow(t)||this.allowResize)}dispose(){pi&&console.warn("Dispose instanced renderer",this.name),this._context.scene.remove(this._batchedMesh),this._batchedMesh.dispose(),this._batchedMesh=null,this._handles=[]}addInstance(t){const i=new Gu(t,this);t.castShadow===!0&&this._batchedMesh.castShadow===!1&&(this._batchedMesh.castShadow=!0),t.receiveShadow===!0&&this._batchedMesh.receiveShadow===!1&&(this._batchedMesh.receiveShadow=!0);try{this.add(i)}catch(s){if(console.error(`Failed adding mesh to instancing (object name: "${t.name}", instances: ${this._currentInstanceCount.toLocaleString()}/${this._maxInstanceCount.toLocaleString()}, vertices: ${this._currentVertexCount.toLocaleString()}/${this._maxVertexCount.toLocaleString()}, indices: ${this._currentIndexCount.toLocaleString()}/${this._maxIndexCount.toLocaleString()})
`,s),F()){rc("Failed instancing mesh. See the browser console for details.");debugger}return null}return i}add(t){const i=t.object.geometry;if(!i||!i.attributes)return console.error("Cannot add object to instancing without geometry",t.name),!1;if(this.mustGrow(i))if(this.allowResize)this.grow(i);else return console.error("Cannot add instance, max count reached",this.name,this.count,this._maxInstanceCount),!1;return t.object.updateWorldMatrix(!0,!0),this.addGeometry(t),this._handles[t.__instanceIndex]=t,this._currentInstanceCount+=1,this.markNeedsUpdate(),this._currentInstanceCount>0&&(this._batchedMesh.visible=!0),!0}remove(t,i){t&&(t.__instanceIndex<0||this._handles[t.__instanceIndex]!=t||this._currentInstanceCount<=0||(this.removeGeometry(t,i),this._handles[t.__instanceIndex]=null,t.__instanceIndex=-1,this._currentInstanceCount>0&&(this._currentInstanceCount-=1),this._currentInstanceCount<=0&&(this._batchedMesh.visible=!1),this.markNeedsUpdate()))}updateInstance(t,i){this._batchedMesh.setMatrixAt(i,t),this.markNeedsUpdate()}updateGeometry(t,i){return this.validateGeometry(t)?(this.mustGrow()&&this.grow(t),pi&&console.debug("[Instancing] UPDATE GEOMETRY at "+i,this._batchedMesh._geometryCount,t.name,Lr(t),t.attributes.position.count,t.index?t.index.count:0),this._batchedMesh.setGeometryAt(i,t),this._geometryIds.set(t,i),this.markNeedsUpdate(),!0):!1}validateGeometry(t){const i=this.geometry;for(const s in i.attributes)if(s!=="batchId"&&!t.hasAttribute(s))return F()&&console.warn(`BatchedMesh: Added geometry missing "${s}". All geometries must have consistent attributes.`),!1;return!0}markNeedsUpdate(){pi==="verbose"&&console.warn("Marking instanced mesh dirty",this.name),this._needUpdateBounds=!0}mustGrow(t){if(this.count>=this._maxInstanceCount)return!0;if(!t||!t.attributes)return!1;const i=Lr(t),s=i.vertexCount,o=i.indexCount;return this._currentVertexCount+s>this._maxVertexCount||this._currentIndexCount+o>this._maxIndexCount}grow(t){var i,s;const o=Math.ceil(this._maxInstanceCount*2),r=this.tryEstimateVertexCountSize(o,[t]),l=Math.max(this._maxVertexCount,r.vertexCount),c=Math.max(this._maxIndexCount,r.indexCount,Math.ceil(this._maxVertexCount*2));if(pi){const u=Lr(t);console.warn(`[Instancing] Growing Buffer
Mesh: "${this.name}${(i=t.name)!=null&&i.length?"/"+t.name:""}"
${u.vertexCount} vertices, ${u.indexCount} indices
Max count ${this._maxInstanceCount} \u2192 ${o}
Max vertex count ${this._maxVertexCount} -> ${l}
Max index count ${this._maxIndexCount} -> ${c}`),this._debugMaterial=cx()}else F()&&console.debug(`[Instancing] Growing Buffer
Mesh: "${this.name}${(s=t.name)!=null&&s.length?"/"+t.name:""}"
Max count ${this._maxInstanceCount} \u2192 ${o}
Max vertex count ${this._maxVertexCount} -> ${l}
Max index count ${this._maxIndexCount} -> ${c}`);this._maxVertexCount=l,this._maxIndexCount=c;const h=new Yy(o,this._maxVertexCount,this._maxIndexCount,this._debugMaterial??this.material);h.layers=this._batchedMesh.layers,h.castShadow=this._batchedMesh.castShadow,h.receiveShadow=this._batchedMesh.receiveShadow,h.visible=this._batchedMesh.visible,h[bc]=this._batchedMesh[bc],h.matrixAutoUpdate=this._batchedMesh.matrixAutoUpdate,h.matrixWorldNeedsUpdate=this._batchedMesh.matrixWorldNeedsUpdate,h.matrixAutoUpdate=this._batchedMesh.matrixAutoUpdate,h.matrixWorld.copy(this._batchedMesh.matrixWorld),h.matrix.copy(this._batchedMesh.matrix),this._batchedMesh.dispose(),this._batchedMesh.removeFromParent(),this._geometryIds.clear(),this._batchedMesh=h,this._maxInstanceCount=o;const d=[...this._handles];this._handles=[];for(const u of d)u&&u.__instanceIndex>=0&&(this.addGeometry(u),this._handles[u.__instanceIndex]=u);this._context.scene.add(h)}tryEstimateVertexCountSize(t,i,s=1){const o=new Map;for(const d of this._handles)if(d&&d.__instanceIndex>=0&&d.object.geometry)if(o.has(d.object.geometry)){const u=o.get(d.object.geometry);u.count+=1}else{const u={count:1,...Lr(d.object.geometry)};o.set(d.object.geometry,u)}let r=0,l=0;for(const[d,u]of o)r+=u.vertexCount*u.count,l+=u.indexCount*u.count;let c=Math.ceil(r/Math.max(1,this._currentInstanceCount))*t,h=Math.ceil(l/Math.max(1,this._currentInstanceCount))*t*2;if(i)for(const d of i){const u=Lr(d);u!=null&&(c+=u.vertexCount*s,h+=u.indexCount*s)}return{vertexCount:c,indexCount:h}}addGeometry(t){const i=t.object.geometry;if(!i)return;let s=this._geometryIds.get(i);s==null?(pi&&console.debug(`[Instancing] > ADD NEW GEOMETRY "${t.name} (${i.name}; ${i.uuid})"
${this._currentInstanceCount} instances, ${t.maxVertexCount} max vertices, ${t.maxIndexCount} max indices`),s=this._batchedMesh.addGeometry(i,t.maxVertexCount,t.maxIndexCount),this._geometryIds.set(i,s)):pi==="verbose"&&console.log(`[Instancing] > ADD INSTANCE "${t.name}"
GEOMETRY_ID=${s}
${this._currentInstanceCount} instances`),this._currentVertexCount+=t.maxVertexCount,this._currentIndexCount+=t.maxIndexCount;const o=this._batchedMesh.addInstance(s);t.__geometryIndex=s,t.__instanceIndex=o,t.__reservedVertexRange=t.maxVertexCount,t.__reservedIndexRange=t.maxIndexCount,this._batchedMesh.setMatrixAt(o,t.object.matrixWorld),pi&&console.debug(`[Instancing] > ADDED INSTANCE "${t.name}"
GEOMETRY_ID=${s}
${this._currentInstanceCount} instances
Index: ${t.__instanceIndex}`)}removeGeometry(t,i){if(t.__instanceIndex<0){console.warn("Cannot remove geometry, instance index is invalid",t.name);return}pi&&console.debug(`[Instancing] < REMOVE INSTANCE "${t.name}" at [${t.__instanceIndex}]
GEOMETRY_ID=${t.__geometryIndex}
${this._currentInstanceCount} instances
Index: ${t.__instanceIndex}`),this._batchedMesh.deleteInstance(t.__instanceIndex)}}a(lx,"nullMatrix",new se);function Lr(n){var t,i;if(!n)return F()&&console.error("Cannot get mesh information from null geometry"),{vertexCount:0,indexCount:0};let s=((i=(t=n.attributes)==null?void 0:t.position)==null?void 0:i.count)||0,o=n.index?n.index.count:0;const r=it.getMeshLODInformation(n);if(r){const l=r.lods[0];let c=l.vertexCount,h=l.indexCount;const d=Math.min(200,Math.ceil(c*.05));c+=d,h+=20,s=Math.max(s,c),o=Math.max(o,h)}return s=Math.ceil(s),o=Math.ceil(o),{vertexCount:s,indexCount:o}}function cx(){const n=new Ft({color:new ae(Math.random(),Math.random(),Math.random())});return n.emissive=n.color,n.emissiveIntensity=.3,C("wireframe")&&(n.wireframe=!0),n}const ol=C("debuglightmaps");class qu{constructor(t,i){a(this,"lightmapIndex",-1),a(this,"lightmapScaleOffset",new fe(1,1,0,0)),a(this,"context"),a(this,"gameObject"),a(this,"lightmapTexture",null),a(this,"lightmapScaleOffsetUniform",{value:new fe(1,1,0,0)}),a(this,"lightmapUniform",{value:null}),a(this,"onBeforeCompile",(s,o)=>{ol&&console.log(`Lightmaps, before compile
`,s),this.lightmapScaleOffsetUniform.value=this.lightmapScaleOffset,this.lightmapUniform.value=this.lightmapTexture,s.uniforms.lightmapScaleOffset=this.lightmapScaleOffsetUniform}),this.gameObject=t,this.context=i}get lightmap(){return this.lightmapTexture}set lightmap(t){t!==this.lightmapTexture&&(this.lightmapTexture=t,this.applyLightmap(),this.lightmapTexture&&it.assignTextureLOD(this.lightmapTexture,0).then(i=>{i!=null&&i.isTexture&&(this.lightmapTexture=i)}))}init(t,i,s){console.assert(this.gameObject!==void 0&&this.gameObject!==null,"Missing gameobject",this),this.lightmapIndex=t,!(this.lightmapIndex<0)&&(this.lightmapScaleOffset=i,this.lightmapTexture=s,it.assignTextureLOD(s,0).then(o=>{o!=null&&o.isTexture&&(this.lightmapTexture=o)}),ol=="show"?(console.log("Lightmap:",this.gameObject.name,t,`
ScaleOffset:`,i,`
Texture:`,s),this.setLightmapDebugMaterial()):ol&&console.log("Use debuglightmaps=show to render lightmaps only in the scene."),this.applyLightmap())}updateLightmapUniforms(t){const i=t.uniforms;i&&i.lightmap&&(this.lightmapScaleOffsetUniform.value=this.lightmapScaleOffset,i.lightmapScaleOffset=this.lightmapScaleOffsetUniform)}applyLightmap(){if(this.gameObject.type==="Object3D"){ol&&console.warn("Can not add lightmap. Is this object missing a renderer?",this.gameObject.name);return}if(this.gameObject.type==="Group"){this.gameObject["Needle:Multimaterial-LightmapWarning"]===void 0&&(this.gameObject["Needle:Multimaterial-LightmapWarning"]=!0,console.warn("Lightmap on multimaterial object is not supported yet... please open a feature request on https://github.com/needle-tools/needle-engine-support if your project requires it"));return}console.assert(this.gameObject.type==="Mesh","Lightmap only works on meshes",this);const t=this.gameObject;if(t.geometry.getAttribute("uv1")||t.geometry.setAttribute("uv1",t.geometry.getAttribute("uv")),Array.isArray(this.gameObject.material)){const i=this.gameObject.material;for(let s=0;s<i.length;s++)i[s]=this.ensureLightmapMaterial(i[s])}else this.gameObject.material=this.ensureLightmapMaterial(this.gameObject.material);if(this.lightmapIndex>=0&&this.lightmapTexture){this.lightmapTexture.channel=1;const i=this.gameObject.material;if(Array.isArray(i))for(const s of i)this.assignLightmapTexture(s);else i&&this.assignLightmapTexture(i)}}ensureLightmapMaterial(t){return t.userData||(t.userData={}),t["NEEDLE:lightmap-material-version"]!=t.version&&t["NEEDLE:lightmap-material-version"]==null&&(ol&&console.warn("Cloning material for lightmap "+t.name),t=t.clone(),t.onBeforeCompile=this.onBeforeCompile),t}assignLightmapTexture(t){!t||t instanceof um&&t.transmission>0||!(t.lightMap!==this.lightmapTexture||t["NEEDLE:lightmap-material-version"]!==t.version)||(ol&&console.log("Assigning lightmap",t.name,t.version),t.lightMap=this.lightmapTexture,t["NEEDLE:lightmap-material-version"]=t.version)}setLightmapDebugMaterial(){this.gameObject.material=new mn({vertexShader:`
                varying vec2 vUv1;
                void main()
                {
                    vUv1 = uv1;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
                }
                `,fragmentShader:`
                uniform sampler2D lightMap;
                uniform float lightMapIntensity;
                uniform vec4 lightmapScaleOffset;
                varying vec2 vUv1;

                // took from threejs 05fc79cd52b79e8c3e8dec1e7dca72c5c39983a4
                vec4 conv_sRGBToLinear( in vec4 value ) {
                    return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );
                }

                void main() {
                    vec2 lUv = vUv1.xy * lightmapScaleOffset.xy + vec2(lightmapScaleOffset.z, (1. - (lightmapScaleOffset.y + lightmapScaleOffset.w)));
                    
                    vec4 lightMapTexel = texture2D( lightMap, lUv);
                    gl_FragColor = lightMapTexel;
                    gl_FragColor.a = 1.;
                }
                `,defines:{USE_LIGHTMAP:""}})}}var HR=Object.defineProperty,$R=Object.getOwnPropertyDescriptor,Us=(n,t,i,s)=>{for(var o=s>1?void 0:s?$R(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&HR(t,i,o),o};const eh=C("debugrenderer"),hx=C("debugskinnedmesh"),dx=C("noinstancing"),GR=C("wireframe");class ux{constructor(){a(this,"path",null),a(this,"asset",null),a(this,"default")}}class qR{constructor(t,i){a(this,"_renderer"),a(this,"_targets",[]),a(this,"_indexMapMaxIndex"),a(this,"_indexMap"),a(this,"_changed",!1),this._renderer=t;const s=this.setMaterial.bind(this),o=this.getMaterial.bind(this),r=t.gameObject;if(this._targets=[],r)switch(r.type){case"Group":this._targets=[...r.children];break;case"SkinnedMesh":case"Mesh":this._targets.push(r);break}let l=!1,c,h=0;for(let d=0;d<this._targets.length;d++){const u=this._targets[d];if(!u)continue;const p=u.material;if(p){p.shadowSide=p.side;for(let g=0;g<i.length;g++){const y=i[g];if(!y){l=!0;continue}if(p.name===y.name){c===void 0&&(c=new Map),c.set(g,d),h=Math.max(h,g);break}}}}if(l){this._indexMapMaxIndex=h,this._indexMap=c;const d=`Renderer ${t.name} was initialized with missing materials - this may lead to unexpected behaviour when trying to access sharedMaterials by index.`;console.warn(d),Xt()&&we("Found renderer with missing materials: please check the console for details.")}return new Proxy(this,{get(d,u){if(typeof u=="string"){const p=parseInt(u);if(!isNaN(p))return o(p)}return d[u]},set(d,u,p){return typeof u=="string"&&s(p,Number.parseInt(u)),Reflect.set(d,u,p)?(p instanceof ke&&(d.changed=!0),!0):!1}})}get changed(){return this._changed}set changed(t){t===!0&&eh&&console.warn("SharedMaterials have changed: "+this._renderer.name,this),this._changed=t}is(t){return this._renderer===t}get length(){return this._indexMapMaxIndex!==void 0?this._indexMapMaxIndex+1:this._targets.length}*[Symbol.iterator](){for(let t=0;t<this.length;t++)yield this.getMaterial(t)}resolveIndex(t){const i=this._indexMap;return i&&i.has(t)?i.get(t):t}setMaterial(t,i){if(i=this.resolveIndex(i),i<0||i>=this._targets.length)return;const s=this._targets[i];!s||s.material===void 0||(s.material=t,this.changed=!0)}getMaterial(t){if(t=this.resolveIndex(t),t<0)return null;const i=this._targets;if(t>=i.length)return null;const s=i[t];return s?s.material:null}}const Xu=class extends A{constructor(){super(...arguments),a(this,"receiveShadows",!1),a(this,"shadowCastingMode",0),a(this,"lightmapIndex",-1),a(this,"lightmapScaleOffset",new fe(1,1,0,0)),a(this,"enableInstancing"),a(this,"renderOrder"),a(this,"allowOcclusionWhenDynamic",!0),a(this,"probeAnchor"),a(this,"reflectionProbeUsage",0),a(this,"_lightmaps"),a(this,"_sharedMeshes",[]),a(this,"_sharedMaterials"),a(this,"_originalMaterials"),a(this,"_probeAnchorLastFrame"),a(this,"_lightmapTextureOverride"),a(this,"allowProgressiveLoading",!0),a(this,"_firstFrame",-1),a(this,"_isInstancingEnabled",!1),a(this,"_handles"),a(this,"_handlesTempArray",[]),a(this,"onBeforeRenderThree",(n,t,i,s,o,r)=>{var l;if(o.envMapIntensity!==void 0){const c=this.hasLightmap?Math.PI:1,h=((l=this.context.mainCameraComponent)==null?void 0:l.environmentIntensity)??1;o.envMapIntensity=Math.max(0,h*this.context.sceneLighting.environmentIntensity/c),o.envMap||(o.envMap=this.context.scene.environment)}if(this._lightmaps)for(const c of this._lightmaps)c.updateLightmapUniforms(o),c.applyLightmap()}),a(this,"_reflectionProbe",null)}static setInstanced(n,t){const i=Sc(n,Xu);return i.setInstancingEnabled(t),i}static isInstanced(n){const t=vr(n,Xu);return t?t.isInstancingActive:an.isUsingInstancing(n)}static setVisible(n,t){Os(n,t)}get sharedMesh(){if(this.gameObject.type==="Mesh")return this.gameObject;if(this.gameObject.type==="SkinnesMesh")return this.gameObject;if(this.gameObject.type==="Group")return this.gameObject.children[0]}get sharedMeshes(){if(this.destroyed||!this.gameObject)return this._sharedMeshes;if(this._sharedMeshes.length=0,this.gameObject.type==="Group")for(const n of this.gameObject.children)(n.type==="Mesh"||n.type==="SkinnedMesh")&&this._sharedMeshes.push(n);else(this.gameObject.type==="Mesh"||this.gameObject.type==="SkinnedMesh")&&this._sharedMeshes.push(this.gameObject);return this._sharedMeshes}get sharedMaterial(){return this.sharedMaterials[0]}set sharedMaterial(n){this.sharedMaterials[0]!==n&&(this.sharedMaterials[0]=n,this.applyLightmapping())}get material(){return this.sharedMaterials[0]}set material(n){this.sharedMaterial=n}set sharedMaterials(n){if(!this._originalMaterials)this._originalMaterials=n;else if(n){let t=!1;for(let i=0;i<this._sharedMaterials.length;i++){const s=i<n.length?n[i]:null;s&&s instanceof ke?this.sharedMaterials[i]=s:t||(t=!0,console.warn("Can not assign null as material: "+this.name,s))}}}get sharedMaterials(){return(!this._sharedMaterials||!this._sharedMaterials.is(this))&&(this._originalMaterials||(this._originalMaterials=[]),this._sharedMaterials=new qR(this,this._originalMaterials)),this._sharedMaterials}static get shouldSuppressInstancing(){return dx}get lightmap(){var n;return(n=this._lightmaps)!=null&&n.length?this._lightmaps[0].lightmap:null}set lightmap(n){var t;if(this._lightmapTextureOverride=n,n===void 0&&(n=this.context.lightmaps.tryGetLightmap(this.sourceId,this.lightmapIndex)),(t=this._lightmaps)!=null&&t.length)for(const i of this._lightmaps)i.lightmap=n}get hasLightmap(){return this.lightmap!=null}registering(){this.enabled||this.setVisibility(!1)}awake(){if(this._firstFrame=this.context.time.frame,eh&&console.log("Renderer ",this.name,this),this.clearInstancingState(),this.probeAnchor&&eh&&this.probeAnchor.add(new Si(.2)),this._reflectionProbe=null,this.isMultiMaterialObject(this.gameObject)){for(const n of this.gameObject.children)this.context.addBeforeRenderListener(n,this.onBeforeRenderThree),n.layers.mask=this.gameObject.layers.mask;if(this.renderOrder!==void 0){let n=0;for(let t=0;t<this.gameObject.children.length;t++){const i=this.gameObject.children[t];if(!(!this.isMeshOrSkinnedMesh(i)||O.getComponent(i,Xu))){if(this.renderOrder.length<=n){console.warn("Incorrect renderOrder element count",this,this.renderOrder.length+" but expected "+this.gameObject.children.length,"Index: "+n,"ChildElement:",i);continue}i.renderOrder=this.renderOrder[n],n+=1}}}}else this.isMeshOrSkinnedMesh(this.gameObject)?(this.context.addBeforeRenderListener(this.gameObject,this.onBeforeRenderThree),this.renderOrder!==void 0&&this.renderOrder.length>0&&(this.gameObject.renderOrder=this.renderOrder[0])):this.context.addBeforeRenderListener(this.gameObject,this.onBeforeRenderThree);if(this.applyLightmapping(),GR)for(let n=0;n<this.sharedMaterials.length;n++){const t=this.sharedMaterials[n];t&&(t.wireframe=!0)}}applyLightmapping(){var n;if(this.lightmapIndex>=0){const t=this.gameObject.type,i=this._lightmapTextureOverride!==void 0?this._lightmapTextureOverride:this.context.lightmaps.tryGetLightmap(this.sourceId,this.lightmapIndex);if(i){if(this._lightmaps||(this._lightmaps=[]),t==="Mesh"){const s=this.gameObject.material;if(s!=null&&s.isMeshBasicMaterial)s&&console.warn("Lightmapping is not supported on MeshBasicMaterial",s.name);else{if(this._lightmaps.length<=0){const o=new qu(this.gameObject,this.context);this._lightmaps.push(o)}this._lightmaps[0].init(this.lightmapIndex,this.lightmapScaleOffset,i)}}else if(this.isMultiMaterialObject(this.gameObject)&&this.sharedMaterials.length>0)for(let s=0;s<this.gameObject.children.length;s++){const o=this.gameObject.children[s];if(!((n=o.material)!=null&&n.isMeshBasicMaterial)){let r;s>=this._lightmaps.length?(r=new qu(o,this.context),this._lightmaps.push(r)):r=this._lightmaps[s],r.init(this.lightmapIndex,this.lightmapScaleOffset,i)}}}else eh&&console.warn("Lightmap not found",this.sourceId,this.lightmapIndex)}}get isInstancingActive(){return this._handles!=null&&this._handles.length>0&&this._isInstancingEnabled}get instances(){if(!this._handles||this._handles.length<=0)return null;if(this._handlesTempArray.length=0,this._handles)for(const n of this._handles)this._handlesTempArray.push(n);return this._handlesTempArray}setInstancingEnabled(n){if(this._isInstancingEnabled===n)return n&&(this._handles===void 0||this._handles!=null&&this._handles.length>0);if(this._isInstancingEnabled=n,n){if(this.enableInstancing===void 0&&(this.enableInstancing=!0),this._handles===void 0){if(this._handles=sl.instance.setup(this,this.gameObject,this.context,null,{rend:this,foundMeshes:0,useMatrixWorldAutoUpdate:this.useInstanceMatrixWorldAutoUpdate()}),this._handles)return O.markAsInstancedRendered(this.gameObject,!0),!0}else if(this._handles!==null){for(const t of this._handles)t.updateInstanceMatrix(!0),t.add();return O.markAsInstancedRendered(this.gameObject,!0),!0}}else{if(this._handles)for(const t of this._handles)t.remove(this.destroyed);return!0}return!1}clearInstancingState(){this._isInstancingEnabled=!1,this._handles=void 0}useInstanceMatrixWorldAutoUpdate(){return!0}start(){if(this.enableInstancing&&!dx&&(this.setInstancingEnabled(!0),an.markDirty(this.gameObject)),this.gameObject.frustumCulled=this.allowOcclusionWhenDynamic,this.isMultiMaterialObject(this.gameObject))for(let n=0;n<this.gameObject.children.length;n++){const t=this.gameObject.children[n];t.frustumCulled=this.allowOcclusionWhenDynamic}}onEnable(){this.sharedMeshes,this.setVisibility(!0),this._isInstancingEnabled||this.enableInstancing==!0||Array.isArray(this.enableInstancing)&&this.enableInstancing.some(n=>n)?this.__internalDidAwakeAndStart&&this.setInstancingEnabled(!0):this.enabled&&this.applyStencil(),this.updateReflectionProbe()}onDisable(){this.setVisibility(!1),this._handles&&this._handles.length>0&&this.setInstancingEnabled(!1)}onDestroy(){if(this._handles=null,this.isMultiMaterialObject(this.gameObject))for(const n of this.gameObject.children)this.context.removeBeforeRenderListener(n,this.onBeforeRenderThree);else this.context.removeBeforeRenderListener(this.gameObject,this.onBeforeRenderThree)}onBeforeRender(){var n,t,i;if(this.gameObject){if(this._probeAnchorLastFrame!==this.probeAnchor&&((n=this._reflectionProbe)==null||n.onUnset(this),this.updateReflectionProbe()),eh==this.name&&this.gameObject instanceof X){this.gameObject.geometry.computeBoundingSphere();const s=q(this.gameObject.geometry.boundingSphere.center).applyMatrix4(this.gameObject.matrixWorld);G.DrawWireSphere(s,this.gameObject.geometry.boundingSphere.radius,56831)}if(this.isMultiMaterialObject(this.gameObject)&&((t=this.gameObject.children)==null?void 0:t.length)>0)for(const s of this.gameObject.children)this.applySettings(s);else this.applySettings(this.gameObject);if(this.sharedMaterials.changed&&(this.sharedMaterials.changed=!1,this.applyLightmapping()),(i=this._handles)!=null&&i.length&&this.gameObject[vc]===!0){this.gameObject[vc]=!1;for(let s=this._handles.length-1;s>=0;s--)this._handles[s].updateInstanceMatrix();this.gameObject.matrixWorldNeedsUpdate=!1}if(this._handles&&this._handles.length<=0&&O.markAsInstancedRendered(this.gameObject,!1),this._isInstancingEnabled&&this._handles)for(let s=0;s<this._handles.length;s++){const o=this._handles[s];Os(o.object,!1)}this.reflectionProbeUsage!==0&&this._reflectionProbe&&this._reflectionProbe.onSet(this)}}onAfterRender(){if(this._isInstancingEnabled&&this._handles)for(let n=0;n<this._handles.length;n++){const t=this._handles[n];Os(t.object,!0)}this.reflectionProbeUsage!==0&&this._reflectionProbe&&this._reflectionProbe.onUnset(this),this.static&&this.gameObject.matrixAutoUpdate&&(this.gameObject.matrixAutoUpdate=!1)}applyStencil(){zf.applyStencil(this)}applySettings(n){n.receiveShadow=this.receiveShadows,this.shadowCastingMode==1?n.castShadow=!0:n.castShadow=!1}updateReflectionProbe(){this._reflectionProbe=null,this.reflectionProbeUsage!==0&&(this.startCoroutine(this._updateReflectionProbe(),Me.LateUpdate),this._probeAnchorLastFrame=this.probeAnchor)}*_updateReflectionProbe(){const n=this.probeAnchor||this.gameObject,t=!!this.probeAnchor;this._reflectionProbe=nl.get(n,this.context,t,this.probeAnchor)}setVisibility(n){if(!this.isMultiMaterialObject(this.gameObject))Os(this.gameObject,n);else for(const t of this.gameObject.children)this.isMeshOrSkinnedMesh(t)&&Os(t,n)}isMultiMaterialObject(n){return n.type==="Group"}isMeshOrSkinnedMesh(n){return n.type==="Mesh"||n.type==="SkinnedMesh"}};let Ze=Xu;Us([m()],Ze.prototype,"receiveShadows",2),Us([m()],Ze.prototype,"shadowCastingMode",2),Us([m()],Ze.prototype,"lightmapIndex",2),Us([m(fe)],Ze.prototype,"lightmapScaleOffset",2),Us([m()],Ze.prototype,"enableInstancing",2),Us([m()],Ze.prototype,"renderOrder",2),Us([m()],Ze.prototype,"allowOcclusionWhenDynamic",2),Us([m(j)],Ze.prototype,"probeAnchor",2),Us([m()],Ze.prototype,"reflectionProbeUsage",2);class th extends Ze{}class Hf extends th{constructor(){super(...arguments),a(this,"_needUpdateBoundingSphere",!1)}awake(){var t;super.awake(),hx&&console.log('SkinnedMeshRenderer for "'+this.name+'"',this),this.allowOcclusionWhenDynamic=!1;for(const i of this.sharedMeshes)(t=i.parent)==null||t.updateWorldMatrix(!1,!0),this.markBoundsDirty()}onAfterRender(){if(super.onAfterRender(),this._needUpdateBoundingSphere){for(const t of this.sharedMeshes)if(t instanceof fs){this._needUpdateBoundingSphere=!1;try{const i=t.geometry,s=tv(t);s&&(t.geometry=s),t.computeBoundingSphere(),t.geometry=i}catch(i){console.error(`Error updating bounding sphere for ${t.name}`,i)}}}if(hx){for(const t of this.sharedMeshes)if(t instanceof fs&&t.boundingSphere){const i=q(t.boundingSphere.center).applyMatrix4(t.matrixWorld);G.DrawWireSphere(i,t.boundingSphere.radius,"red")}}}markBoundsDirty(){this._needUpdateBoundingSphere=!0}}var XR=Object.defineProperty,QR=Object.getOwnPropertyDescriptor,px=(n,t,i,s)=>{for(var o=s>1?void 0:s?QR(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&XR(t,i,o),o};const Qu=C("debuggltfexport");class $f extends Ki{constructor(){super(...arguments),a(this,"sceneRoot")}}const rl=class extends A{constructor(){super(...arguments),a(this,"binary",!0),a(this,"objects",[]),a(this,"ext")}async exportNow(n,t){Qu&&console.log("Exporting objects as glTF",this.objects),n||(n="scene"),(!this.objects||this.objects.length<=0)&&(this.objects=[this.context.scene]);const i={binary:this.binary,pivot:rl.calculateCenter(this.objects),...t},s=await this.export(this.objects,i).catch(o=>(console.error(o),!1));return s===!1?!1:(this.binary?n.endsWith(".glb")||(n+=".glb"):n.endsWith(".gltf")||(n+=".gltf"),this.binary?rl.saveArrayBuffer(s,n):rl.saveJson(s,n),!0)}async export(n,t){if(!n||n.length<=0){console.warn("No objects set to export");return}const i=new sv;i.register(h=>new ox(h)),i.register(h=>new Kw(h)),Nf(i,this.context),rl.filterTopmostParent(n);const s={trs:!1,onlyVisible:!0,truncateDrawRange:!1,binary:!0,maxTextureSize:1/0,embedImages:!0,includeCustomExtensions:!0,animations:t?.animations||rl.collectAnimations(n),...t},o=new Array,r=new j;t!=null&&t.pivot&&r.position.sub(t.pivot),Qu&&console.log("EXPORT",n),n.forEach(h=>{h&&Df(h)&&(r.children.push(h),h.matrixAutoUpdate=!1,h.matrix.copy(h.matrixWorld),O.getComponentsInChildren(h,Ze).forEach(d=>{O.isActiveInHierarchy(d.gameObject)&&d.setInstancingEnabled(!1)}),h.traverse(d=>{if(!Df(d)){const u=d.parent;d.removeFromParent(),o.push(()=>{u&&u.add(d)})}}))});const l=new Bg(r);return t!=null&&t.needleComponents&&(this.ext=new ex),this.ext&&(this.ext.registerExport(i),this.ext.context=l),new Promise((h,d)=>{Qu&&console.log("Starting glTF export.");try{i?.parse(r,u=>{c(),h(u)},u=>{c(),d(u)},s)}catch(u){console.error(u),d(u)}finally{o.forEach(u=>u()),Qu&&console.log("Finished glTF export.")}});function c(){n.forEach(h=>{h&&(h.matrixAutoUpdate=!0,O.getComponentsInChildren(h,Ze).forEach(d=>{O.isActiveInHierarchy(d.gameObject)&&d.setInstancingEnabled(!1)}))})}}static saveArrayBuffer(n,t){this.save(new Blob([n],{type:"application/octet-stream"}),t)}static saveJson(n,t){this.save("data: text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(n)),t)}static save(n,t){const i=document.createElement("a");i.style.display="none",document.body.appendChild(i),typeof n=="string"?i.href=n:i.href=URL.createObjectURL(n),i.download=t,i.click(),i.remove()}static collectAnimations(n,t){t=t||[];for(const i of n)i&&i.traverseVisible(s=>{s.animations&&s.animations.length>0&&t.push(...s.animations)});return t}static calculateCenter(n,t){const i=t||new x;return i.set(0,0,0),n.forEach(s=>{i.add(te(s))}),i.divideScalar(n.length),i}static filterTopmostParent(n){if(!(n.length<=0))for(let t=0;t<n.length;t++){let i=n[t];if(!i){n.splice(t,1),t--;continue}for(;i.parent;){if(n.includes(i.parent)){n.splice(t,1),t--;break}i=i.parent}}}};let ih=rl;px([m()],ih.prototype,"binary",2),px([m(j)],ih.prototype,"objects",2),typeof globalThis!==void 0&&!("OffscreenCanvas"in globalThis)&&(globalThis.OffscreenCanvas=class{constructor(n,t){return a(this,"canvas"),this.canvas=document.createElement("canvas"),this.canvas.width=n,this.canvas.height=t,this.canvas.convertToBlob=(i,s)=>new Promise(o=>{this.canvas.toBlob(o,i,s)}),this.canvas}});const YR=C("debugprogress");function mx(n){n=n||new Date;const t=n.getMonth()+1,i=n.getDate(),s=n.getHours(),o=n.getMinutes(),r=n.getSeconds(),l=(t<10?"0":"")+t,c=(i<10?"0":"")+i,h=(s<10?"0":"")+s,d=(o<10?"0":"")+o,u=(r<10?"0":"")+r;return n.getFullYear()+l+c+"-"+h+d+u}class ce{static start(t,i){typeof i=="string"&&(i={parentScope:i});const s=new ZR(t,i);nh.set(t,s)}static report(t,i){const s=nh.get(t);if(!s){console.warn("Reporting progress for non-existing scope",t);return}typeof i=="string"&&(i={message:i,autoStep:!0}),s.report(i)}static end(t){const i=nh.get(t);i&&(i.end(),nh.delete(t))}}const nh=new Map;class ZR{constructor(t,i){a(this,"scopeLabel"),a(this,"parentScope"),a(this,"childScopes",[]),a(this,"parentDepth",0),a(this,"lastStep",0),a(this,"lastAutoStepWeight",1),a(this,"lastTotalSteps",0),a(this,"onProgress"),a(this,"showLogs",!1),a(this,"selfProgress",0),a(this,"totalProgress",0),a(this,"selfReports",0),a(this,"totalReports",0),this.parentScope=i!=null&&i.parentScope?nh.get(i.parentScope):void 0,this.parentScope&&(this.parentScope.childScopes.push(this),this.parentDepth=this.parentScope.parentDepth+1),this.scopeLabel=" ".repeat(this.parentDepth*2)+t,this.showLogs=i?.logTimings??!!YR,this.showLogs&&console.time(this.scopeLabel),this.onProgress=i?.onProgress}report(t,i=!1){if(t){if(t.totalSteps!==void 0&&(this.lastTotalSteps=t.totalSteps),t.currentStep!==void 0&&(this.lastStep=t.currentStep),t.autoStep!==void 0){if(t.currentStep===void 0){this.lastStep===void 0&&(this.lastStep=0);const o=typeof t.autoStep=="number"?t.autoStep:1;this.lastStep+=this.lastAutoStepWeight,this.lastAutoStepWeight=o,t.currentStep=this.lastStep}t.totalSteps=this.lastTotalSteps}t.progress!==void 0?this.selfProgress=t.progress:t.currentStep!==void 0&&t.totalSteps!==void 0&&(this.selfProgress=t.currentStep/t.totalSteps)}if(this.childScopes.length>0){let o=0,r=0;for(const c of this.childScopes)o+=c.selfProgress,r+=1;r>0&&(o/=r);const l=this.lastAutoStepWeight/(this.lastTotalSteps??1);this.totalProgress=this.selfProgress+o*l}else this.totalProgress=this.selfProgress;this.selfProgress=Math.min(1,this.selfProgress),this.totalProgress=Math.min(1,this.totalProgress);let s=(this.totalProgress*100).toFixed(3)+"%";this.childScopes.length>0&&(s+=" ("+(this.selfProgress*100).toFixed(3)+"% self)"),t!=null&&t.message&&(s=t.message+" \u2013 "+s),this.lastStep!==void 0&&this.lastTotalSteps!==void 0&&(s="Step "+(this.lastStep+(this.lastAutoStepWeight!=1?"\u2013"+(this.lastStep+this.lastAutoStepWeight):"")+"/"+this.lastTotalSteps)+" "+s),i?this.totalReports++:(this.selfReports++,this.totalReports++),this.showLogs&&console.timeLog(this.scopeLabel,s),this.onProgress&&this.onProgress(this.totalProgress),this.parentScope&&this.parentScope.report(void 0,!0)}end(){this.report({progress:1,autoStep:!0},!0),this.showLogs&&(console.timeLog(this.scopeLabel,"Total reports: "+this.totalReports,"Self reports: "+this.selfReports),console.timeEnd(this.scopeLabel));let t=!1;for(const i of this.childScopes)if(!(i.selfProgress>=1)){t=!0;break}t&&console.warn("Progress end with child scopes that are still running",this),this.onProgress=void 0}}function Tn(n){return n=n.replace(/[^a-zA-Z0-9_]/g,""),n.match(/^[a-zA-Z_]/)||(n="_"+n),n}function gx(n){return n=n.replace('"','\\"'),n}function fx(n){if(n.length===0)return null;const t=n.map(i=>{const s=new Array;for(;i.parent;)s.unshift(i.parent),i=i.parent;return s});return t[0].findLast(i=>t.every(s=>s.includes(i)))||null}function yx(n){const t=fx(n),i=new Set;for(const s of n){let o=s.parent;for(;o&&o!==t;)n.includes(o)||i.add(o),o=o.parent}return i}const KR=new x,JR=new V,eT=new x(1,1,1),al=class{constructor(n,t,i=null,s=null,o=null,r=null,l=null,c=null){a(this,"uuid"),a(this,"name"),a(this,"type"),a(this,"extraSchemas",[]),a(this,"displayName"),a(this,"visibility"),a(this,"transform",null),a(this,"_isDynamic"),a(this,"geometry"),a(this,"material"),a(this,"camera"),a(this,"parent"),a(this,"skinnedMesh"),a(this,"children",[]),a(this,"animations"),a(this,"_eventListeners"),a(this,"needsTranslate",!1),a(this,"needsOrient",!1),a(this,"needsScale",!1);var h,d,u;this.uuid=n,this.name=Tn(t),this.displayName=t,i?this.transform={position:((h=i.position)==null?void 0:h.clone())||null,quaternion:((d=i.quaternion)==null?void 0:d.clone())||null,scale:((u=i.scale)==null?void 0:u.clone())||null}:this.transform=null,this.geometry=s,this.material=o,this.camera=r,this.parent=null,this.children=[],this._eventListeners={},this._isDynamic=!1,this.skinnedMesh=l,this.animations=c}getMatrix(){if(!this.transform)return new se;const{position:n,quaternion:t,scale:i}=this.transform,s=new se;return s.compose(n||KR,t||JR,i||eT),s}setMatrix(n){if(!n||!(n instanceof se)){this.transform=null;return}const t=new x,i=new V,s=new x;n.decompose(t,i,s),this.transform={position:t,quaternion:i,scale:s}}get matrix(){return this.getMatrix()}set matrix(n){this.setMatrix(n)}get isDynamic(){return this._isDynamic}set isDynamic(n){this._isDynamic=n}static createEmptyParent(n){const t=new al(ms.generateUUID(),n.name+"_empty_"+al.USDObject_export_id++,n.transform),i=n.parent;return i&&i.add(t),t.add(n),t.isDynamic=!0,n.transform=null,t}static createEmpty(){const n=new al(ms.generateUUID(),"Empty_"+al.USDObject_export_id++);return n.isDynamic=!0,n}is(n){return n?this.uuid===n.uuid:!1}isEmpty(){return!this.geometry}clone(){const n=new al(ms.generateUUID(),this.name,this.transform,this.geometry,this.material);return n.isDynamic=this.isDynamic,n}deepClone(){const n=this.clone();for(const t of this.children)t&&n.add(t.deepClone());return n}getPath(){let n=this.parent,t=this.name;for(;n;)t=(n.parent?n.name:n.name+"/Scenes/Scene")+"/"+t,n=n.parent;return"</"+t+">"}add(n){n.parent&&n.parent.remove(n),n.parent=this,this.children.push(n)}remove(n){const t=this.children.indexOf(n);t>=0&&(n.parent===this&&(n.parent=null),this.children.splice(t,1))}addEventListener(n,t){this._eventListeners[n]||(this._eventListeners[n]=[]),this._eventListeners[n].push(t)}removeEventListener(n,t){if(!this._eventListeners[n])return;const i=this._eventListeners[n].indexOf(t);i>=0&&this._eventListeners[n].splice(i,1)}onSerialize(n,t){const i=this._eventListeners.serialize;i&&i.forEach(s=>s(n,t))}};let Zt=al;a(Zt,"USDObject_export_id",0);class Gf extends Zt{constructor(){super(void 0,"StageRoot",null,null,null,null),a(this,"stageLength"),this.children=[],this.stageLength=200}get isDocumentRoot(){return!0}get isDynamic(){return!1}add(t){t.parent=this,this.children.push(t)}remove(t){const i=this.children.indexOf(t);i>=0&&(t.parent===this&&(t.parent=null),this.children.splice(i,1))}traverse(t,i=null){if(i!==null?t(i):i=this,i.children)for(const s of i.children)this.traverse(t,s)}findById(t){let i=!1;function s(o){if(!i){if(o.uuid===t)return i=!0,o;if(o.children)for(const r of o.children){if(!r)continue;const l=s(r);if(l)return l}}}return s(this)}buildHeader(t){var i,s,o;const r=(i=t.extensions)==null?void 0:i.find(y=>y?.extensionName==="animation"),l=(s=t.extensions)==null?void 0:s.find(y=>y?.extensionName==="Behaviour"),c=(o=t.extensions)==null?void 0:o.find(y=>y?.extensionName==="Physics"),h=r?.getStartTimeCode()??0,d=r?.getEndTimeCode()??0;let u="";const p=r?.registeredClips;if(p)for(const y of p)u+=`	# Animation: ${y.name}, start=${r.getStartTimeByClip(y)*60}, length=${y.duration*60}
`;const g=u;return`#usda 1.0
(
	customLayerData = {
		string creator = "Needle Engine ${_n}"
		dictionary Needle = {
			bool animations = ${r?1:0}
			bool interactive = ${l?1:0}
			bool physics = ${c?1:0}
			bool quickLookCompatible = ${t.quickLookCompatible?1:0}
		}
	}
	defaultPrim = "${Tn(this.name)}"
	metersPerUnit = 1
	upAxis = "Y"
	startTimeCode = ${h}
	endTimeCode = ${d}
	timeCodesPerSecond = 60
	framesPerSecond = 60
	doc = """Generated by Needle Engine USDZ Exporter ${_n}"""
${g}
)
`}}const ll=`
`,Kt="</StageRoot/Materials";class vx{constructor(){a(this,"str"),a(this,"indent"),this.str="",this.indent=0}clear(){this.str="",this.indent=0}beginBlock(t=void 0,i="{",s=!0){t!==void 0?(t=this.applyIndent(t),this.str+=t,s?(this.str+=ll,this.str+=this.applyIndent(i)):this.str+=" "+i):this.str+=this.applyIndent(i),this.str+=ll,this.indent+=1}closeBlock(t="}"){this.indent-=1,this.str+=this.applyIndent(t)+ll}beginArray(t){t=this.applyIndent(t+" = ["),this.str+=t,this.str+=ll,this.indent+=1}closeArray(){this.indent-=1,this.str+=this.applyIndent("]")+ll}appendLine(t=""){t=this.applyIndent(t),this.str+=t,this.str+=ll}toString(){return this.str}applyIndent(t){let i="";for(let s=0;s<this.indent;s++)i+="	";return i+t}}class tT{constructor(t,i,s){a(this,"root"),a(this,"exporter"),a(this,"extensions",[]),a(this,"quickLookCompatible"),a(this,"exportInvisible"),a(this,"materials"),a(this,"textures"),a(this,"files"),a(this,"document"),a(this,"output"),a(this,"animations"),this.root=t,this.exporter=i,this.quickLookCompatible=s.quickLookCompatible,this.exportInvisible=s.exportInvisible,s.extensions&&(this.extensions=s.extensions),this.materials=new Map,this.textures={},this.files={},this.document=new Gf,this.output="",this.animations=[]}}class qf{constructor(){a(this,"ar",{anchoring:{type:"plane"},planeAnchoring:{alignment:"horizontal"}}),a(this,"quickLookCompatible",!1),a(this,"extensions",[]),a(this,"maxTextureSize",4096),a(this,"exportInvisible",!1)}}let bx=class{constructor(){a(this,"debug"),a(this,"pruneUnusedNodes"),a(this,"sceneAnchoringOptions",new qf),a(this,"extensions",[]),a(this,"keepObject"),a(this,"beforeWritingDocument"),this.debug=!1,this.pruneUnusedNodes=!0}async parse(n,t=new qf){var i,s;t=Object.assign(new qf,t),this.sceneAnchoringOptions=t;const o=new tT(n,this,t);this.extensions=o.extensions;const r=o.files,l="model.usda";r[l]=null;const c=o.materials,h=o.textures;ce.report("export-usdz","Invoking onBeforeBuildDocument"),await Yu(o,"onBeforeBuildDocument"),ce.report("export-usdz","Done onBeforeBuildDocument"),ce.report("export-usdz","Reparent bones to common ancestor");const d=[],u=new Set;n?.traverse(_=>{if(!(!t.exportInvisible&&!_.visible)&&_ instanceof fs){const S=_.skeleton.bones,R=fx(S);if(R){const M={object:_,originalParent:_.parent,newParent:R};d.push(M),u.add(M.object.uuid),M.newParent&&u.add(M.newParent.uuid),M.originalParent&&u.add(M.originalParent.uuid)}}});for(const _ of d){const{object:S,originalParent:R,newParent:M}=_;M.add(S)}ce.report("export-usdz","Traversing hierarchy"),n&&_x(n,o.document,o,this.keepObject),ce.report("export-usdz","Invoking onAfterBuildDocument"),await Yu(o,"onAfterBuildDocument");const p=o.extensions.find(_=>_.extensionName==="Behaviour"),g=p?.getAllTargetUuids()??new Set;if(this.pruneUnusedNodes){const _={allBehaviorTargets:g,debug:!1,boneReparentings:u,quickLookCompatible:o.quickLookCompatible};this.debug&&wx(o.document,"Hierarchy BEFORE pruning",_),xx(o.document,_),this.debug&&wx(o.document,"Hierarchy AFTER pruning")}else this.debug&&console.log("Pruning of empty nodes is disabled. This may result in a larger USDZ file.");ce.report("export-usdz",{message:"Parsing document",autoStep:10}),await iT(o,()=>(ce.report("export-usdz","Building materials"),hT(c,h,t.quickLookCompatible))),ce.report("export-usdz","Invoking onAfterSerialize"),await Yu(o,"onAfterSerialize");for(const _ of d){const{object:S,originalParent:R,newParent:M}=_;R&&R.add(S)}(s=(i=o.exporter)==null?void 0:i.beforeWritingDocument)==null||s.call(i);const y=o.document.buildHeader(o)+`
`+o.output;this.debug&&console.log(y),r[l]=ov(y),o.output="",ce.report("export-usdz",{message:"Exporting textures",autoStep:10}),ce.start("export-usdz-textures",{parentScope:"export-usdz",logTimings:!1});const f=new sr({antialias:!1,alpha:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!0}),v=Object.keys(h).length;ce.report("export-usdz-textures",{totalSteps:v*3,currentStep:0});const b=async _=>{const S=h[_],R=S.texture,M=Ix.includes(R.format);let T={imageData:R.image};ce.report("export-usdz-textures",{message:"read back texture",autoStep:!0});const L=S.scale!==void 0&&S.scale.x!==1&&S.scale.y!==1&&S.scale.z!==1&&S.scale.w!==1;(R.isCompressedTexture||R.isRenderTargetTexture||L)&&(T=await Cx(R,t.maxTextureSize,f,S.scale)),ce.report("export-usdz-textures",{message:"convert texture to canvas",autoStep:!0});const D=await sT(T.imageBitmap||T.imageData,t.maxTextureSize).catch(U=>{console.error("Error converting texture to canvas",R,U)});if(D){ce.report("export-usdz-textures",{message:"convert canvas to blob",autoStep:!0});const U=await D.convertToBlob({type:M?"image/png":"image/jpeg",quality:.95});r[`textures/${_}.${M?"png":"jpg"}`]=new Uint8Array(await U.arrayBuffer())}else console.warn("Can`t export texture: ",R)};for(const _ in h)await b(_);f.dispose(),ce.end("export-usdz-textures");let w=0;for(const _ in r){const S=r[_],R=34+_.length;w+=R;const M=w&63;if(M!==4){const T=64-M,L=new Uint8Array(T);r[_]=[S,{extra:{12345:L}}]}w=S.length}return ce.report("export-usdz","zip archive"),WC(r,{level:0})}};function _x(n,t,i,s){var o;if(!i.exportInvisible&&!n.visible)return;let r,l,c;const h={position:n.position,quaternion:n.quaternion,scale:n.scale};if(n.position.x===0&&n.position.y===0&&n.position.z===0&&(h.position=null),n.quaternion.x===0&&n.quaternion.y===0&&n.quaternion.z===0&&n.quaternion.w===1&&(h.quaternion=null),n.scale.x===1&&n.scale.y===1&&n.scale.z===1&&(h.scale=null),(n instanceof X||n instanceof fs)&&(l=n.geometry,c=n.material),s&&!s(n)&&(l=void 0,c=void 0),(n instanceof X||n instanceof fs)&&c&&(c instanceof Ft||c instanceof Re||c instanceof ke&&c.type==="MeshLineMaterial")){const d=Ju(n),u=n instanceof fs?n:null;r=new Zt(n.uuid,d,h,l,c,void 0,u,n.animations)}else if(n instanceof _e||n instanceof cm){const d=Ju(n);r=new Zt(n.uuid,d,h,void 0,void 0,n)}else{const d=Ju(n);r=new Zt(n.uuid,d,h,void 0,void 0,void 0,void 0,n.animations)}if(r){if(r.displayName=((o=n.userData)==null?void 0:o.name)||n.name,r.visibility=n.visible?void 0:"invisible",t&&t.add(r),t=r,i.extensions)for(const d of i.extensions)d.onExportObject&&d.onExportObject.call(d,n,r,i)}else{const d=Ju(n),u=new Zt(n.uuid,d,{position:n.position,quaternion:n.quaternion,scale:n.scale});t&&t.add(u),t=u}for(const d of n.children)_x(d,t,i,s)}function wx(n,t,...i){const s={};let o=0;function r(l,c){o++;let h=l.displayName||l.name;h+=" ("+l.uuid+")",(l.geometry||l.material||l.camera||l.skinnedMesh)&&(h+=" ("+(l.geometry?"geo, ":"")+(l.material?"mat, ":"")+(l.camera?"cam, ":"")+(l.skinnedMesh?"skin, ":"")+")"),c[h]={};const d={object:l};l.material&&(d.mat=!0),l.geometry&&(d.geo=!0),l.camera&&(d.cam=!0),l.skinnedMesh&&(d.skin=!0),c[h]._self=d;for(const u of l.children)u&&r(u,c[h])}r(n,s),console.log(t+" ("+o+" nodes)",s,...i)}function xx(n,t){var i;let s=!0;const o=new Array,r=new Array;if(n.children.length===0)s=!0;else{const u=[...n.children];for(const p of u)if(p){const g=xx(p,t);t.debug&&(g?o.push(p):r.push(p)),s=s&&g}}const l=t.allBehaviorTargets.has(n.uuid),c=n.geometry||n.material||n.camera&&!t.quickLookCompatible||n.skinnedMesh||!1,h=t.boneReparentings.has(n.uuid),d=s&&!l&&!c&&!h;return d?(t.debug&&console.log("Pruned object:",(n.displayName||n.name)+" ("+n.uuid+")",{isVisible:c,isBehaviorSourceOrTarget:l,allChildsWerePruned:s,isBoneReparenting:h,object:n,prunedChilds:o,keptChilds:r}),(i=n.parent)==null||i.remove(n)):t.debug&&console.log("Kept object:",(n.displayName||n.name)+" ("+n.uuid+")",{isVisible:c,isBehaviorSourceOrTarget:l,allChildsWerePruned:s,isBoneReparenting:h,object:n,prunedChilds:o,keptChilds:r}),d}async function iT(n,t){ce.start("export-usdz-resources","export-usdz");const i=[];for(const h of n.document.children)Sx(h,n,i);const s=i.length;for(let h=0;h<s;h++)ce.report("export-usdz-resources",{totalSteps:s,currentStep:h}),await new Promise((d,u)=>{i[h](),d()});ce.end("export-usdz-resources");const o=new vx,r=n.exporter.sceneAnchoringOptions.ar;o.beginBlock(`def Xform "${n.document.name}"`),o.beginBlock(`def Scope "Scenes" (
		kind = "sceneLibrary"
	)`),o.beginBlock('def Xform "Scene"',"(",!1),o.appendLine('apiSchemas = ["Preliminary_AnchoringAPI"]'),o.appendLine("customData = {"),o.appendLine("	bool preliminary_collidesWithEnvironment = 0"),o.appendLine('	string sceneName = "Scene"'),o.appendLine("}"),o.appendLine('sceneName = "Scene"'),o.closeBlock(")"),o.beginBlock(),o.appendLine(`token preliminary:anchoring:type = "${r.anchoring.type}"`),r.anchoring.type==="plane"&&o.appendLine(`token preliminary:planeAnchoring:alignment = "${r.planeAnchoring.alignment}"`),r.anchoring.type==="image"&&o.appendLine(`rel preliminary:imageAnchoring:referenceImage = </${n.document.name}/Scenes/Scene/AnchoringReferenceImage>`),o.appendLine();const l=h=>{if(!h)return 0;let d=1;for(const u of h.children)d+=l(u);return d},c=l(n.document);ce.start("export-usdz-xforms","export-usdz"),ce.report("export-usdz-xforms",{totalSteps:c,currentStep:1});for(const h of n.document.children)kx(h,o,n);ce.end("export-usdz-xforms"),ce.report("export-usdz","invoke onAfterHierarchy"),Yu(n,"onAfterHierarchy",o),o.closeBlock(),o.closeBlock(),o.appendLine(t()),o.closeBlock(),ce.report("export-usdz","write to string"),n.output+=o.toString()}function Sx(n,t,i){if(!n)return;const s=n.geometry,o=n.material;if(s)if(o&&("isMeshStandardMaterial"in o&&o.isMeshStandardMaterial||"isMeshBasicMaterial"in o&&o.isMeshBasicMaterial||o.type==="MeshLineMaterial")){const r="geometries/"+Qf(s,n.name)+".usda";if(!(r in t.files)){const l=()=>{var c,h;const d=aT(s,(h=(c=n.skinnedMesh)==null?void 0:c.skeleton)==null?void 0:h.bones,t.quickLookCompatible);t.files[r]=rT(d)};i.push(l)}}else console.warn("NeedleUSDZExporter: Unsupported material type (USDZ only supports MeshStandardMaterial)",o?.name);o&&(o.uuid in t.materials||(t.materials[o.uuid]=o));for(const r of n.children)Sx(r,t,i)}async function Yu(n,t,i=null){if(n.extensions){for(const s of n.extensions)if(s&&typeof s[t]=="function"){const o=s[t].call(s,n,i);o instanceof Promise&&await o}}}let Zu=null,Jt=null,Xf,cl,Ku;async function Cx(n,t=1/0,i=null,s=void 0){Xf||(Xf=new zn(2,2,1,1)),cl||(cl=new mn({uniforms:{blitTexture:new to(n),flipY:new to(!1),scale:new to(new fe(1,1,1,1))},vertexShader:`
            varying vec2 vUv;
			uniform bool flipY;
            void main(){
                vUv = uv;
				if (flipY)
					vUv.y = 1. - vUv.y;
                gl_Position = vec4(position.xy * 1.0,0.,.999999);
            }`,fragmentShader:`
            uniform sampler2D blitTexture;
			uniform vec4 scale; 
            varying vec2 vUv;

            void main(){ 
                gl_FragColor = vec4(vUv.xy, 0, 1);
                
                #ifdef IS_SRGB
                gl_FragColor = sRGBTransferOETF( texture2D( blitTexture, vUv) );
                #else
                gl_FragColor = texture2D( blitTexture, vUv);
                #endif
				
				gl_FragColor.rgba *= scale.rgba;
            }`}));const o=cl.uniforms;o.blitTexture.value=n,o.flipY.value=!1,o.scale.value=new fe(1,1,1,1),s!==void 0&&o.scale.value.copy(s),cl.defines.IS_SRGB=n.colorSpace==gn,cl.needsUpdate=!0,Ku||(Ku=new X(Xf,cl),Ku.frustumCulled=!1);const r=new _e,l=new wi;l.add(Ku),i||(i=Zu=new sr({antialias:!1,alpha:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!0}));const c=Math.min(n.image.width,t),h=Math.min(n.image.height,t);Jt&&(Jt.width!==c||Jt.height!==h)&&(Jt.dispose(),Jt=null),Jt||(Jt=new vs(c,h,{format:ad,type:cC,minFilter:Zy,magFilter:Zy})),i.setRenderTarget(Jt),i.setSize(c,h),i.clear(),i.render(l,r),Zu&&(Zu.dispose(),Zu=null);const d=new Uint8ClampedArray(Jt.width*Jt.height*4);i.readRenderTargetPixels(Jt,0,0,Jt.width,Jt.height,d);const u=new ImageData(d,Jt.width,Jt.height,void 0),p=await createImageBitmap(u,{premultiplyAlpha:"none"});return{imageData:u,imageBitmap:p}}function nT(n){return typeof HTMLImageElement<"u"&&n instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&n instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&n instanceof OffscreenCanvas||typeof ImageBitmap<"u"&&n instanceof ImageBitmap}async function sT(n,t=4096){const i=t/Math.max(n.width,n.height),s=n.width*Math.min(1,i),o=n.height*Math.min(1,i),r=new OffscreenCanvas(s,o),l={premultiplyAlpha:"none"};n.width!==s&&(l.resizeWidth=s),n.height!==o&&(l.resizeHeight=o);const c=await createImageBitmap(n,l),h=r.getContext("bitmaprenderer");return h&&h.transferFromImageBitmap(c),r}async function Ox(n,t=void 0,i=!1,s=4096){if(nT(n)){const o=s/Math.max(n.width,n.height),r=new OffscreenCanvas(n.width*Math.min(1,o),n.height*Math.min(1,o)),l=r.getContext("2d",{alpha:!0,premultipliedAlpha:!1});if(!l)throw new Error("Could not get canvas 2D context");if(i===!0&&(l.translate(0,r.height),l.scale(1,-1)),l.drawImage(n,0,0,r.width,r.height),t!==void 0){const c=t.x,h=t.y,d=t.z,u=t.w,p=l.getImageData(0,0,r.width,r.height),g=p.data;for(let y=0;y<g.length;y+=4)g[y+0]=g[y+0]*c,g[y+1]=g[y+1]*h,g[y+2]=g[y+2]*d,g[y+3]=g[y+3]*u;l.putImageData(p,0,0)}return r}else throw new Error("NeedleUSDZExporter: No valid image data found. Unable to process texture.")}const je=7;function oT(){return`#usda 1.0
(
    customLayerData = {
        string creator = "Needle Engine USDZExporter"
    }
    metersPerUnit = 1
    upAxis = "Y"
)
`}function rT(n,t){let i=oT();return i+=n,ov(i)}function Ju(n){return n.name.replace(/[-<>\(\)\[\]§$%&\/\\\=\?\,\;]/g,"")+"_"+n.id}function Px(n){return Tn(n.name||"bone_"+n.uuid)}function Qf(n,t){return Tn(n.name||"Geometry")+"_"+n.id}function Yf(n){return Tn(n.name||"Material")+"_"+n.id}function hl(n,t){let i=Px(n),s=n.parent;for(;s&&s!==t;)i=Px(s)+"/"+i,s=s.parent;return i}function kx(n,t,i){var s;if(n==null)return;ce.report("export-usdz-xforms",{message:"buildXform "+n.displayName||n.name,autoStep:!0});const o=n.transform,r=n.geometry,l=n.material,c=n.camera,h=n.name;if(n.animations)for(const f of n.animations)i.animations.push(f);const d=r&&r.isBufferGeometry&&r.attributes.skinIndex!==void 0&&r.attributes.skinIndex.count>0,u=d?"SkelRoot":"Xform",p=new Array,g=l&&l instanceof Re&&l.color&&l.color.r===1&&l.color.g===1&&l.color.b===1&&!l.map&&l.opacity===1&&r?.attributes.color;if(r!=null&&r.attributes.color&&!g&&console.warn("NeedleUSDZExporter: Geometry has vertex colors. Vertex colors will only be shown in QuickLook for unlit materials with white color and no texture. Otherwise, they will be ignored.",n.displayName),t.appendLine(),r?(t.beginBlock(`def ${u} "${h}"`,"(",!1),i.quickLookCompatible&&l&&l.side===Ci&&!d?t.appendLine(`prepend references = @./geometries/${Qf(r)}.usda@</Geometry_doubleSided>`):t.appendLine(`prepend references = @./geometries/${Qf(r)}.usda@</Geometry>`),g||p.push("MaterialBindingAPI"),d&&p.push("SkelBindingAPI")):c&&!i.quickLookCompatible?t.beginBlock(`def Camera "${h}"`,"(",!1):n.type!==void 0?t.beginBlock(`def ${n.type} "${h}"`):t.beginBlock(`def Xform "${h}"`,"(",!1),n.type===void 0&&((s=n.extraSchemas)!=null&&s.length&&p.push(...n.extraSchemas),p.length&&t.appendLine(`prepend apiSchemas = [${p.map(f=>`"${f}"`).join(", ")}]`)),n.displayName&&t.appendLine(`displayName = "${gx(n.displayName)}"`),(c||n.type===void 0)&&(t.closeBlock(")"),t.beginBlock()),r&&l){if(!g){const f=Yf(l);t.appendLine(`rel material:binding = </StageRoot/Materials/${f}>`)}!i.quickLookCompatible&&l.side===Ci&&(t.beginBlock('over "Geometry" '),t.appendLine("uniform bool doubleSided = 1"),t.closeBlock())}let y=!1;if(d?(t.appendLine("rel skel:skeleton = <Rig>"),t.appendLine("rel skel:animationSource = <Rig/_anim>"),y=!1):n.type===void 0&&o&&(y=y||o.position!==null||o.quaternion!==null||o.scale!==null,o.position&&(n.needsTranslate=!0,t.appendLine(`double3 xformOp:translate = (${he(o.position.x)}, ${he(o.position.y)}, ${he(o.position.z)})`)),o.quaternion&&(n.needsOrient=!0,t.appendLine(`quatf xformOp:orient = (${he(o.quaternion.w)}, ${he(o.quaternion.x)}, ${he(o.quaternion.y)}, ${he(o.quaternion.z)})`)),o.scale&&(n.needsScale=!0,t.appendLine(`double3 xformOp:scale = (${he(o.scale.x)}, ${he(o.scale.y)}, ${he(o.scale.z)})`))),n.visibility!==void 0&&t.appendLine(`token visibility = "${n.visibility}"`),c&&!i.quickLookCompatible&&("isOrthographicCamera"in c&&c.isOrthographicCamera?(t.appendLine(`float2 clippingRange = (${c.near}, ${c.far})`),t.appendLine(`float horizontalAperture = ${((Math.abs(c.left)+Math.abs(c.right))*10).toPrecision(je)}`),t.appendLine(`float verticalAperture = ${((Math.abs(c.top)+Math.abs(c.bottom))*10).toPrecision(je)}`),t.appendLine('token projection = "orthographic"')):"isPerspectiveCamera"in c&&c.isPerspectiveCamera&&(t.appendLine(`float2 clippingRange = (${c.near.toPrecision(je)}, ${c.far.toPrecision(je)})`),t.appendLine(`float focalLength = ${c.getFocalLength().toPrecision(je)}`),t.appendLine(`float focusDistance = ${c.focus.toPrecision(je)}`),t.appendLine(`float horizontalAperture = ${c.getFilmWidth().toPrecision(je)}`),t.appendLine('token projection = "perspective"'),t.appendLine(`float verticalAperture = ${c.getFilmHeight().toPrecision(je)}`))),n.onSerialize&&n.onSerialize(t,i),n.type===void 0){const f=new Array;n.needsTranslate&&f.push('"xformOp:translate"'),n.needsOrient&&f.push('"xformOp:orient"'),n.needsScale&&f.push('"xformOp:scale"'),f.length&&t.appendLine(`uniform token[] xformOpOrder = [${f.join(", ")}]`)}if(n.children){t.appendLine();for(const f of n.children)kx(f,t,i)}t.closeBlock()}function he(n){return Number.isInteger(n)?n.toString():n.toFixed(10)}function Mx(n){const t=n.elements;return`( ${ep(t,0)}, ${ep(t,4)}, ${ep(t,8)}, ${ep(t,12)} )`}function ep(n,t){return`(${he(n[t+0])}, ${he(n[t+1])}, ${he(n[t+2])}, ${he(n[t+3])})`}function aT(n,t=[],i=!0){return`
def "Geometry"
${lT(n,t,i)}
`}function lT(n,t=[],i=!0){const s="Geometry",o=n.attributes,r=o.position.count,l=t&&t.length>0,c=[],h=[];let d=new Array,u=o.skinIndex;if(l){const g=[];for(const b of t)c.push({bone:b,index:t.indexOf(b)}),g.push(b.uuid);let y=1e4;for(;g.length<t.length&&y-- >0;)for(const b of c){const w=b.bone.children;for(const _ of w)g.indexOf(_.uuid)===-1&&t.indexOf(_)!==-1&&(c.push({bone:_,index:t.indexOf(_)}),g.push(_.uuid))}y<=0&&console.error("Failed to sort bones in skinned mesh",c,t,g);for(const b of yx(t))c.push({bone:b,index:c.length});const f=c[0].bone.parent;c.sort((b,w)=>hl(b.bone,f)>hl(w.bone,f)?1:-1),c.map(b=>'"'+hl(b.bone,f)+'"').join(", ");for(const b in c)h[c[b].index]=parseInt(b);const v=o.skinIndex;d=new Array;for(let b=0;b<v.count;b++){const w=v.getX(b),_=v.getY(b),S=v.getZ(b),R=v.getW(b);d.push(h[w],h[_],h[S],h[R])}u=new yt(new Uint16Array(d),4)}const p=o.skinWeight&&o.skinIndex;return`
{	
    def Mesh "${s}" ${p?`(
        prepend apiSchemas = ["SkelBindingAPI"]
    )`:""}
    {
        int[] faceVertexCounts = [${Zf(n)}]
        int[] faceVertexIndices = [${Kf(n)}]
		${o.normal||i?`normal3f[] normals = [${tp(o.normal,r)}] (
            interpolation = "vertex"
        )`:""}
        point3f[] points = [${tp(o.position,r)}]
        ${o.uv?`texCoord2f[] primvars:st = [${Tx(o.uv,r,!0)}] (
            interpolation = "vertex"
        )`:""}
		${o.uv1?Jf("st1",o.uv1):""}
		${o.uv2?Jf("st2",o.uv2):""}
		${o.uv3?Jf("st3",o.uv3):""}
		${p?`matrix4d primvars:skel:geomBindTransform = ( (1, 0, 0, 0), (0, 1, 0, 0), (0, 0, 1, 0), (0, 0, 0, 1) ) (
				elementSize = 1
				interpolation = "constant"
			)`:""}
		${o.skinIndex?`int[] primvars:skel:jointIndices = [${Rx(u,!0)}] (
			elementSize = 4
			interpolation = "vertex"
		)`:""}
		${o.skinWeight?`float[] primvars:skel:jointWeights = [${Rx(o.skinWeight)}] (
			elementSize = 4
			interpolation = "vertex"
		)`:""}
		${o.color?`color3f[] primvars:displayColor = [${tp(o.color,r)}] (
			interpolation = "vertex"
		)`:""}
        uniform token subdivisionScheme = "none"
    }
}
${i?`
# This is a workaround for QuickLook/RealityKit not supporting the doubleSided attribute. We're adding a second
# geometry definition here, that uses the same mesh data but appends extra faces with reversed winding order.
def "${s}_doubleSided" (
	prepend references = </Geometry>
)
{
	over "Geometry"
	{
		int[] faceVertexCounts = [${Zf(n)+", "+Zf(n)}]
		int[] faceVertexIndices = [${Kf(n)+", "+Kf(n,!0)}]
	}
}
`:""}
`}function Zf(n){const t=n.index!==null?n.index.count:n.attributes.position.count;return Array(Math.floor(t/3)).fill(3).join(", ")}function Kf(n,t=!1){const i=n.index,s=[];if(i!==null)for(let o=0;o<i.count;o++){let r=o;t&&(r=o%3===0?o+2:o%3===2?o-2:o),s.push(i.getX(r))}else{const o=n.attributes.position.count;for(let r=0;r<o;r++){let l=r;t&&(l=r%3===0?r+2:r%3===2?r-2:r),s.push(l)}}return s.join(", ")}function Jf(n,t){const i=t.itemSize;switch(i){case 2:return`texCoord2f[] primvars:${n} = [${Tx(t,i,!0)}] (
				interpolation = "vertex"
			)`;case 3:return`texCoord3f[] primvars:${n} = [${tp(t,i)}] (
				interpolation = "vertex"
			)`;case 4:return`double4[] primvars:${n} = [${cT(t,i)}] (
				interpolation = "vertex"
			)`;default:return console.warn("USDZExporter: Attribute with "+i+" components are currently not supported. Results may be undefined for "+n+"."),""}}function tp(n,t){if(n===void 0)return console.warn("USDZExporter: A mesh attribute is missing and will be set with placeholder data. The result may look incorrect."),Array(t).fill("(0, 0, 1)").join(", ");const i=[];for(let s=0;s<n.count;s++){const o=n.getX(s),r=n.getY(s),l=n.getZ(s);i.push(`(${o.toPrecision(je)}, ${r.toPrecision(je)}, ${l.toPrecision(je)})`)}return i.join(", ")}function cT(n,t){if(n===void 0)return console.warn("USDZExporter: Attribute is missing. Results may be undefined."),Array(t).fill("(0, 0, 0, 0)").join(", ");const i=[];for(let s=0;s<n.count;s++){const o=n.getX(s),r=n.getY(s),l=n.getZ(s)||0,c=n.getW(s)||0;i.push(`(${o.toPrecision(je)}, ${r.toPrecision(je)}, ${l.toPrecision(je)}, ${c.toPrecision(je)})`)}return i.join(", ")}function Rx(n,t=!1){const i=[];for(let s=0;s<n.count;s++){const o=n.getX(s),r=n.getY(s),l=n.getZ(s),c=n.getW(s);i.push(`${t?o:o.toPrecision(je)}`),i.push(`${t?r:r.toPrecision(je)}`),i.push(`${t?l:l.toPrecision(je)}`),i.push(`${t?c:c.toPrecision(je)}`)}return i.join(", ")}function Tx(n,t,i=!1){if(n===void 0)return console.warn("USDZExporter: UVs missing."),Array(t).fill("(0, 0)").join(", ");const s=[];for(let o=0;o<n.count;o++){const r=n.getX(o);let l=n.getY(o);i&&(l=1-l),s.push(`(${r.toPrecision(je)}, ${l.toPrecision(je)})`)}return s.join(", ")}function hT(n,t,i=!1){const s=[];for(const o in n){const r=n[o];s.push(dT(r,t,i))}return`
	def "Materials"
    {
${s.join("")}
    }`}function dT(n,t,i=!1){var s,o,r;const l=Yf(n);if(n.colorWrite===!1||((s=n.userData)==null?void 0:s.isShadowCatcherMaterial)||((o=n.userData)==null?void 0:o.isLightBlendMaterial)){const b=n.userData.isLightBlendMaterial||n.userData.isShadowCatcherMaterial?"ND_realitykit_shadowreceiver_surfaceshader":"ND_realitykit_occlusion_surfaceshader";return`

		def Material "${l}" ${n.name?`(
			displayName = "${n.name}"
		)`:""}
		{
			token outputs:mtlx:surface.connect = ${Kt}/${l}/Occlusion.outputs:out>

			def Shader "Occlusion"
			{
				uniform token info:id = "${b}"
				token outputs:out
			}
		}`}const c="                ",h=[],d=[],u=new Set;function p(b){var w;return Tn(b.name)+"_"+(((w=b.source)==null?void 0:w.id)??b.id)}function g(b,w,_=void 0,S=void 0){const R=p(b),M=R+(S!==void 0&&S!==1?"_"+S:""),T=i&&S!==void 0&&S!==1,L=T?new fe(1,1,1,S):void 0;S===void 0&&(S=1),T&&(S=1),L&&L.w<=.05&&(L.w=.05),t[M]={texture:b,scale:L};const D=b.channel>0?"st"+b.channel:"st";u.add(b.channel);const U=Ix.includes(b.format),B={1e3:"repeat",1001:"clamp",1002:"mirror"},Y=b.repeat.clone(),$=b.offset.clone(),E=b.rotation,z=Math.sin(E),H=Math.cos(E);$.y=1-$.y-Y.y,i?(Y.x===0&&(Y.x=1e-4),Y.y===0&&(Y.y=1e-4),$.x=$.x/Y.x,$.y=$.y/Y.y,$.x+=z/Y.x,$.y+=H-1):($.x+=z*Y.x,$.y+=(1-H)*Y.y);const ie=Y.x!=1||Y.y!=1||$.x!=0||$.y!=0||E!=0,oe=`${Kt}/${l}/${"uvReader_"+D}.outputs:result>`,de=`${Kt}/${l}/Transform2d_${w}.outputs:result>`,me=w!=="normal"&&_&&(_.r!==1||_.g!==1||_.b!==1||S!==1)||!1,Xe=w==="normal",Qe=n instanceof Ft&&n.normalScale?n.normalScale.x*2:2,hn=Qe.toFixed(je),dn=(-1*(Qe/2)).toFixed(je),Hl=(1-Qe).toFixed(je);return`
			${ie?`def Shader "Transform2d_${w}" (
				sdrMetadata = {
					string role = "math"
				}
			)
			{
				uniform token info:id = "UsdTransform2d"
				float2 inputs:in.connect = ${oe}
				float2 inputs:scale = ${Ax(Y)}
				float2 inputs:translation = ${Ax($)}
				float inputs:rotation = ${(E/Math.PI*180).toFixed(je)}
				float2 outputs:result
			}
			`:""}
			def Shader "${R}_${w}"
			{
				uniform token info:id = "UsdUVTexture"
				asset inputs:file = @textures/${M}.${U?"png":"jpg"}@
				token inputs:sourceColorSpace = "${b.colorSpace==="srgb"?"sRGB":"raw"}"
				float2 inputs:st.connect = ${ie?de:oe}
				${me?`
				float4 inputs:scale = (${_?_.r+", "+_.g+", "+_.b:"1, 1, 1"}, ${S})
				`:""}
				${Xe?`
				float4 inputs:scale = (${hn}, ${hn}, ${hn}, 1)
				float4 inputs:bias = (${dn}, ${dn}, ${Hl}, 0)
				`:""}
				token inputs:wrapS = "${B[b.wrapS]}"
				token inputs:wrapT = "${B[b.wrapT]}"
				float outputs:r
				float outputs:g
				float outputs:b
				float3 outputs:rgb
				${n.transparent||n.alphaTest>0?"float outputs:a":""}
			}`}let y=n.transparent||n.alphaTest?n.opacity:1,f=!1,v=!1;if(n instanceof um&&n.transmission!==void 0&&(y*=1-n.transmission*(1-n.roughness*.5)),n.map?(h.push(`${c}color3f inputs:diffuseColor.connect = ${Kt}/${l}/${p(n.map)}_diffuse.outputs:rgb>`),n instanceof Re&&n.transparent&&n.alphaTest==0&&i?(h.push(`${c}float inputs:opacity.connect = ${Kt}/${l}/${p(n.map)}_diffuse.outputs:a>`),f=!0,h.push(`${c}float inputs:opacityThreshold = ${1e-10}`),v=!0):n.transparent?(h.push(`${c}float inputs:opacity.connect = ${Kt}/${l}/${p(n.map)}_diffuse.outputs:a>`),f=!0):n.alphaTest>0&&(h.push(`${c}float inputs:opacity.connect = ${Kt}/${l}/${p(n.map)}_diffuse.outputs:a>`),f=!0,h.push(`${c}float inputs:opacityThreshold = ${n.alphaTest}`),v=!0),d.push(g(n.map,"diffuse",n.color,y))):h.push(`${c}color3f inputs:diffuseColor = ${Ex(n.color)}`),n.alphaHash&&i&&(v?console.warn("Opacity threshold for "+n.name+" was already connected. Skipping alphaHash opacity threshold."):(h.push(`${c}float inputs:opacityThreshold = 0.0000000001`),v=!0)),n.aoMap&&(h.push(`${c}float inputs:occlusion.connect = ${Kt}/${l}/${p(n.aoMap)}_occlusion.outputs:r>`),d.push(g(n.aoMap,"occlusion"))),n.alphaMap?(h.push(`${c}float inputs:opacity.connect = ${Kt}/${l}/${p(n.alphaMap)}_opacity.outputs:r>`),h.push(`${c}float inputs:opacityThreshold = 0.0000000001`),f=!0,v=!0,d.push(g(n.alphaMap,"opacity",new ae(1,1,1),y))):(f?console.warn("Opacity for "+n.name+" was already connected. Skipping default opacity."):(h.push(`${c}float inputs:opacity = ${y}`),f=!0),n.alphaTest>0&&(v?console.warn("Opacity threshold for "+n.name+" was already connected. Skipping default opacity threshold."):(h.push(`${c}float inputs:opacityThreshold = ${n.alphaTest}`),v=!0))),n instanceof Ft){if(n.emissiveMap){h.push(`${c}color3f inputs:emissiveColor.connect = ${Kt}/${l}/${p(n.emissiveMap)}_emissive.outputs:rgb>`);const b=n.emissive.clone();b.multiplyScalar(n.emissiveIntensity),d.push(g(n.emissiveMap,"emissive",b))}else if(((r=n.emissive)==null?void 0:r.getHex())>0){const b=n.emissive.clone();b.multiplyScalar(n.emissiveIntensity),h.push(`${c}color3f inputs:emissiveColor = ${Ex(b)}`)}n.normalMap&&(h.push(`${c}normal3f inputs:normal.connect = ${Kt}/${l}/${p(n.normalMap)}_normal.outputs:rgb>`),d.push(g(n.normalMap,"normal"))),n.roughnessMap&&n.roughness===1?(h.push(`${c}float inputs:roughness.connect = ${Kt}/${l}/${p(n.roughnessMap)}_roughness.outputs:g>`),d.push(g(n.roughnessMap,"roughness"))):h.push(`${c}float inputs:roughness = ${n.roughness!==void 0?n.roughness:1}`),n.metalnessMap&&n.metalness===1?(h.push(`${c}float inputs:metallic.connect = ${Kt}/${l}/${p(n.metalnessMap)}_metallic.outputs:b>`),d.push(g(n.metalnessMap,"metallic"))):h.push(`${c}float inputs:metallic = ${n.metalness!==void 0?n.metalness:0}`)}return n instanceof um&&(h.push(`${c}float inputs:clearcoat = ${n.clearcoat}`),h.push(`${c}float inputs:clearcoatRoughness = ${n.clearcoatRoughness}`),h.push(`${c}float inputs:ior = ${n.ior}`),!n.transparent&&!(n.alphaTest>0)&&n.transmissionMap&&(h.push(`${c}float inputs:opacity.connect = ${Kt}/${l}/${p(n.transmissionMap)}_transmission.outputs:r>`),d.push(g(n.transmissionMap,"transmission")))),u.size>2?console.warn("USDZExporter: Material "+n.name+" uses more than 2 UV channels. Currently, only UV0 and UV1 are supported."):u.size===2&&(!u.has(0)||!u.has(1))&&console.warn("USDZExporter: Material "+n.name+" uses UV channels other than 0 and 1. Currently, only UV0 and UV1 are supported."),`

		def Material "${l}" ${n.name?`(
			displayName = "${gx(n.name)}"
		)`:""}
		{
			token outputs:surface.connect = ${Kt}/${l}/PreviewSurface.outputs:surface>

			def Shader "PreviewSurface"
			{
				uniform token info:id = "UsdPreviewSurface"
${h.join(`
`)}
				int inputs:useSpecularWorkflow = ${n instanceof Re?"1":"0"}
				token outputs:surface
			}
${d.length>0?`
${u.has(0)?`
			def Shader "uvReader_st"
			{
				uniform token info:id = "UsdPrimvarReader_float2"
				token inputs:varname = "st"
				float2 inputs:fallback = (0.0, 0.0)
				float2 outputs:result
			}
`:""}
${u.has(1)?`
			def Shader "uvReader_st1"
			{
				uniform token info:id = "UsdPrimvarReader_float2"
				token inputs:varname = "st1"
				float2 inputs:fallback = (0.0, 0.0)
				float2 outputs:result
			}
`:""}
${d.join(`
`)}`:""}
		}`}function Ex(n){return`(${n.r}, ${n.g}, ${n.b})`}function Ax(n){return`(${n.x}, ${n.y})`}const Ix=[1023,33777,33778,33779,35842,35843,37496,37808,37809,37810,37811,37812,37813,37814,37815,37816,37817,37818,37819,37820,37821,36492];C("debugusdz");const jx=class{constructor(n,t,i){a(this,"id"),a(this,"trigger"),a(this,"action"),a(this,"exclusive",!1),this.id="Behavior_"+Tn(n)+"_"+jx.global_id++,this.trigger=t,this.action=i}makeExclusive(n){return this.exclusive=n,this}writeTo(n,t,i){if(!this.trigger||!this.action)return;i.beginBlock(`def Preliminary_Behavior "${this.id}"`);let s="";if(Array.isArray(this.trigger)){s="[";for(let o=0;o<this.trigger.length;o++){const r=this.trigger[o];s+="<"+r.id+">",o+1<this.trigger.length&&(s+=", ")}s+="]"}else s=`<${this.trigger.id}>`;if(i.appendLine(`rel triggers = ${s}`),i.appendLine(`rel actions = <${this.action.id}>`),i.appendLine(`uniform bool exclusive = ${this.exclusive?1:0}`),i.appendLine(),Array.isArray(this.trigger))for(const o of this.trigger)o.writeTo(t,i),i.appendLine();else this.trigger.writeTo(t,i);i.appendLine(),this.action.writeTo(t,i),i.closeBlock()}};let Wt=jx;a(Wt,"global_id",0);const dl=new Set;function e0(n,t){var i,s;let o="";if(Array.isArray(n)){dl.clear();let r="[ ";for(let l=0;l<n.length;l++){let c=n[l];if(!c){console.warn("Invalid target object in behavior",n+". Is the object exported?");continue}if(typeof c=="string"){if(dl.has(c))continue;r+=c,dl.add(c)}else if(typeof c=="object"){if(c.isObject3D&&(c=t.findById(c.uuid),!c)){console.warn("Invalid target object in behavior",n+". Is the object exported?");continue}const h=(i=c.getPath)==null?void 0:i.call(c);if(dl.has(h))continue;r+=h,dl.add(h)}l+1<n.length&&(r+=", ")}r+=" ]",o=r,dl.clear()}else if(typeof n=="object"){const r=n;if(r.isObject3D&&(n=t.findById(r.uuid)),!n)throw console.error("Invalid target object in behavior, the target object is likely missing from USDZ export. Is the object exported?",r),new Error(`Invalid target object in behavior, the target object is likely missing from USDZ export. Please report a bug. uuid: ${r.uuid}.`);o=(s=n.getPath)==null?void 0:s.call(n)}return o}const Lx=class{constructor(n,t){a(this,"id"),a(this,"targetId"),a(this,"tokenId"),a(this,"type"),a(this,"distance"),n&&(this.targetId=n),t?this.id=t:this.id="Trigger_"+Lx.global_id++}writeTo(n,t){t.beginBlock(`def Preliminary_Trigger "${this.id}"`),this.targetId&&(typeof this.targetId!="string"&&(this.targetId=e0(this.targetId,n)),t.appendLine("rel affectedObjects = "+this.targetId)),this.tokenId&&t.appendLine(`token info:id = "${this.tokenId}"`),this.type&&t.appendLine(`token type = "${this.type}"`),typeof this.distance=="number"&&t.appendLine(`double distance = ${this.distance}`),t.closeBlock()}};let Dr=Lx;a(Dr,"global_id",0);function Dx(n,t={direct:!0,indirect:!0}){const i=Zt.createEmpty();i.name="InputTarget_"+i.name,i.displayName=void 0,i.type="RealityKitComponent",i.onSerialize=s=>{s.appendLine("bool allowsDirectInput = "+(t.direct?1:0)),s.appendLine("bool allowsIndirectInput = "+(t.indirect?1:0)),s.appendLine('uniform token info:id = "RealityKit.InputTarget"')},n.add(i)}class Tt{static sceneStartTrigger(){if(this.__sceneStartTrigger!==void 0)return this.__sceneStartTrigger;const t=new Dr(void 0,"SceneStart");return t.tokenId="SceneTransition",t.type="enter",this.__sceneStartTrigger=t,t}static tapTrigger(t,i={direct:!0,indirect:!0}){const s=new Dr(t);if(Array.isArray(t)&&t.length>1)for(const o of t)o instanceof Zt&&Dx(o,i);else t instanceof Zt&&Dx(t,i);return s.tokenId="TapGesture",s}static isTapTrigger(t){return t?.tokenId==="TapGesture"}static proximityToCameraTrigger(t,i){const s=new Dr(t);return s.tokenId="ProximityToCamera",s.distance=i,s}}a(Tt,"__sceneStartTrigger");class Eo{constructor(t,i){a(this,"id"),a(this,"actions"),a(this,"loops",0),a(this,"performCount",1),a(this,"type","serial"),a(this,"multiplePerformOperation"),this.id=t,this.actions=i}static getId(){return this.global_id++}addAction(t){return this.actions.push(t),this}makeParallel(){return this.type="parallel",this}makeSequence(){return this.type="serial",this}makeLooping(){return this.loops=1,this.performCount=0,this}makeRepeat(t){return this.performCount=t,this}writeTo(t,i){i.beginBlock(`def Preliminary_Action "${this.id}"`),i.beginArray("rel actions");for(const s of this.actions){if(!s)continue;const o=s===this.actions[this.actions.length-1];i.appendLine("<"+s.id+">"+(o?"":", "))}i.closeArray(),i.appendLine(),i.appendLine('token info:id = "Group"'),i.appendLine(`bool loops = ${this.loops}`),i.appendLine(`int performCount = ${this.loops>0?0:Math.max(0,this.performCount)}`),i.appendLine(`token type = "${this.type}"`),typeof this.multiplePerformOperation=="string"&&i.appendLine(`token multiplePerformOperation = "${this.multiplePerformOperation}"`),i.appendLine();for(const s of this.actions)s&&(s.writeTo(t,i),i.appendLine());i.closeBlock()}}a(Eo,"global_id",0);const t0=class{constructor(n,t){a(this,"id"),a(this,"tokenId"),a(this,"affectedObjects"),a(this,"easeType"),a(this,"motionType"),a(this,"duration"),a(this,"moveDistance"),a(this,"style"),a(this,"type"),a(this,"front"),a(this,"up"),a(this,"start"),a(this,"animationSpeed"),a(this,"reversed"),a(this,"pingPong"),a(this,"xFormTarget"),a(this,"audio"),a(this,"gain"),a(this,"auralMode"),a(this,"multiplePerformOperation"),a(this,"velocity"),a(this,"comment"),a(this,"animationName"),n&&(this.affectedObjects=n),t?this.id=t:this.id="Action",this.id+="_"+t0.global_id++}clone(){const n=new t0,t=n.id;return Object.assign(n,this),n.id=t,n}writeTo(n,t){t.beginBlock(`def Preliminary_Action "${this.id}"`),this.comment&&t.appendLine(`# ${this.comment}`),this.affectedObjects&&(typeof this.affectedObjects!="string"&&(this.affectedObjects=e0(this.affectedObjects,n)),t.appendLine("rel affectedObjects = "+this.affectedObjects)),typeof this.duration=="number"&&(typeof this.animationSpeed=="number"&&this.animationSpeed!==1?t.appendLine(`double duration = ${this.duration/this.animationSpeed} `):t.appendLine(`double duration = ${this.duration} `)),this.easeType&&t.appendLine(`token easeType = "${this.easeType}"`),this.tokenId&&t.appendLine(`token info:id = "${this.tokenId}"`),this.tokenId==="ChangeScene"&&t.appendLine("rel scene = </StageRoot/Scenes/Scene>"),this.motionType!==void 0&&t.appendLine(`token motionType = "${this.motionType}"`),typeof this.moveDistance=="number"&&t.appendLine(`double moveDistance = ${this.moveDistance} `),this.style&&t.appendLine(`token style = "${this.style}"`),this.type&&t.appendLine(`token type = "${this.type}"`),this.front&&t.appendLine(`vector3d front = (${this.front.x}, ${this.front.y}, ${this.front.z})`),this.up&&t.appendLine(`vector3d upVector = (${this.up.x}, ${this.up.y}, ${this.up.z})`),typeof this.start=="number"&&t.appendLine(`double start = ${this.start} `),typeof this.animationSpeed=="number"&&t.appendLine(`double animationSpeed = ${this.animationSpeed.toFixed(2)} `),typeof this.reversed=="boolean"&&t.appendLine(`bool reversed = ${this.reversed}`),typeof this.pingPong=="boolean"&&t.appendLine(`bool reverses = ${this.pingPong}`),this.xFormTarget&&(typeof this.xFormTarget!="string"&&(this.xFormTarget=e0(this.xFormTarget,n)),t.appendLine(`rel xformTarget = ${this.xFormTarget}`)),typeof this.audio=="string"&&t.appendLine(`asset audio = @${this.audio}@`),typeof this.gain=="number"&&t.appendLine(`double gain = ${this.gain}`),typeof this.auralMode=="string"&&t.appendLine(`token auralMode = "${this.auralMode}"`),typeof this.multiplePerformOperation=="string"&&t.appendLine(`token multiplePerformOperation = "${this.multiplePerformOperation}"`),typeof this.velocity=="object"&&t.appendLine(`vector3d velocity = (${this.velocity.x}, ${this.velocity.y}, ${this.velocity.z})`),t.closeBlock()}};let en=t0;a(en,"global_id",0);class cn{constructor(t,i,s){a(this,"x",0),a(this,"y",0),a(this,"z",0),this.x=t,this.y=i,this.z=s}static get up(){return new cn(0,1,0)}static get right(){return new cn(1,0,0)}static get forward(){return new cn(0,0,1)}static get back(){return new cn(0,0,-1)}static get zero(){return new cn(0,0,0)}}class ve{static sequence(...t){return new Eo("Group_"+Eo.getId(),t).makeSequence()}static parallel(...t){return new Eo("Group_"+Eo.getId(),t).makeParallel()}static fadeAction(t,i,s){const o=new en(t);return o.tokenId="Visibility",o.type=s?"show":"hide",o.duration=i,o.style="basic",o.motionType="none",o.moveDistance=0,o.easeType="none",o}static startAnimationAction(t,i,s=!1,o=!1){const r=new en(t);r.tokenId="StartAnimation";const l=i.start,c=i.duration,h=i.speed,d=i.clipName;if(r.comment=`Animation: ${d}, start=${l*60}, length=${c*60}, end=${(l+c)*60}`,r.animationName=d,r.start=l,r.duration=c,r.animationSpeed=h,r.reversed=s,r.pingPong=o,r.multiplePerformOperation="allow",s&&(r.start-=c),o){r.pingPong=!1;const u=r.clone();return u.reversed=!s,u.start=r.start,u.reversed&&(u.start-=c),ve.sequence(r,u)}return r}static waitAction(t){const i=new en;return i.tokenId="Wait",i.duration=t,i.motionType=void 0,i}static lookAtCameraAction(t,i,s,o){const r=new en(t);return r.tokenId="LookAtCamera",r.duration=i===void 0?9999999999999:i,r.front=s??cn.forward,r.up=o??cn.up,r}static emphasize(t,i,s="bounce",o=1,r="basic"){const l=new en(t);return l.tokenId="Emphasize",l.duration=i,l.style=r??"basic",l.motionType=s,l.moveDistance=o,l}static transformAction(t,i,s,o,r="inout"){const l=new en(t);return l.tokenId="Transform",l.duration=s,l.duration=Math.max(1e-6,s),l.type=o,l.easeType=s>0?r:"none",Array.isArray(i)&&console.error("Transform target must not be an array",i),l.xFormTarget=i,l}static playAudioAction(t,i,s="play",o=1,r="spatial"){const l=new en(t);return l.tokenId="Audio",l.type=s,l.audio=i,l.gain=o,l.auralMode=r,l.multiplePerformOperation="allow",l}static impulseAction(t,i){const s=new en(t);return s.tokenId="Impulse",s.velocity=i,s}}class uT{constructor(t){a(this,"object"),a(this,"model"),this.object=t}get id(){return this.object.uuid}apply(t){if(!this.model&&(this.model=t.findById(this.object.uuid),!this.model)){console.error("could not find model with id "+this.object.uuid);return}this.onApply(t)}}class i0 extends uT{constructor(t,i,s,o){super(t),a(this,"matrix"),a(this,"material"),a(this,"geometry"),a(this,"_enableAction"),a(this,"_disableAction"),this.matrix=i,this.material=s,this.geometry=o}onApply(t){var i,s;const o=this.model;if(!o)return;(i=o.parent)!=null&&i.isDynamic||Zt.createEmptyParent(o);const r=o.clone();this.matrix&&r.setMatrix(this.matrix),this.material&&(r.material=this.material),this.geometry&&(r.geometry=this.geometry),(s=o.parent)==null||s.add(r)}enable(){return this._enableAction?this._enableAction:(this._enableAction=ve.fadeAction(this.object,0,!0),this._enableAction)}disable(){return this._disableAction?this._disableAction:(this._disableAction=ve.fadeAction(this.object,0,!1),this._disableAction)}}class Bx{constructor(t){a(this,"actions"),a(this,"sortedActions"),this.actions=[...t]}organize(){this.sortedActions={};for(const t of this.actions){const i=t.id;this.sortedActions[i]||(this.sortedActions[i]=[]),this.sortedActions[i].push(t)}}getActions(t){return this.sortedActions||this.organize(),this.sortedActions[t.uuid]}}const ts=C("debugusdzanimation"),n0=C("debugusdzanimationserialization");class nr{constructor(t,i,s){a(this,"_start"),a(this,"ext"),a(this,"root"),a(this,"_nearestAnimatedRoot"),a(this,"clip"),a(this,"speed"),this.ext=t,this.root=i,this.clip=s,this._nearestAnimatedRoot=this.getNearestAnimatedRoot()}get start(){return this._start===void 0&&(this._start=this.ext.getStartTimeByClip(this.clip)),this._start}get duration(){var t;return((t=this.clip)==null?void 0:t.duration)??Ke.restPoseClipDuration}get nearestAnimatedRoot(){return this._nearestAnimatedRoot}get clipName(){var t;return((t=this.clip)==null?void 0:t.name)??"rest"}static isDescendantOf(t,i){let s=i;if(!s||!t)return!1;for(;s;){if(!s)return!1;if(s===t)return!0;s=s.parent}return!1}getNearestAnimatedRoot(){var t;let i;try{for(const s of((t=this.clip)==null?void 0:t.tracks)??[]){const o=fa.parseTrackName(s.name);let r=fa.findNode(this.root,o.nodeName);if(r)if(!i)i=r;else{if(r===i||nr.isDescendantOf(i,r))continue;if(!nr.isDescendantOf(r,i)){for(;!nr.isDescendantOf(r,i)&&r.parent;)r=r.parent;nr.isDescendantOf(r,i)||console.error("USDZExporter: Animation clip targets multiple roots that are not parent/child. Please report a bug",this.root,this.clip,i,r)}i=r}}}catch(s){console.error("USDZExporter: Exception when trying to find nearest animated root. Please report a bug",s),i=void 0}return i}}const ip=class{constructor(n,t,i){if(a(this,"clip"),a(this,"pos"),a(this,"rot"),a(this,"scale"),a(this,"root"),a(this,"target"),a(this,"duration",0),a(this,"useRootMotion",!1),this.root=n,this.target=t,this.clip=i,i?this.duration=i.duration:this.duration=ip.restPoseClipDuration,i&&i.tracks){const o=Math.max(...i.tracks.map(r=>r.times[r.times.length-1]));o!==this.duration&&(console.warn("USDZExporter: Animation clip duration does not match the maximum time value in the tracks.",i,o,this.duration),this.duration=o)}const s=O.getComponent(n,kt);s&&(this.useRootMotion=s.applyRootMotion)}addTrack(n){var t,i;if(!this.clip){console.error("This is a rest clip but you're trying to add tracks to it \u2013 this is likely a bug");return}n.name.endsWith("position")?this.pos=n:n.name.endsWith("quaternion")?this.rot=n:n.name.endsWith("scale")?this.scale=n:(n.name.endsWith("activeSelf")?console.warn("[USDZ] Animation of enabled/disabled state is not supported for USDZ export and will NOT be exported: "+n.name+" on "+(((t=this.root)==null?void 0:t.name)??this.target.name)+". Animate scale 0/1 instead."):console.warn("[USDZ] Animation track type not supported for USDZ export and will NOT be exported: "+n.name+" on "+(((i=this.root)==null?void 0:i.name)??this.target.name)+". Only .position, .rotation, .scale are supported."),F()&&we("[USDZ] Some animations can't be exported. See console for details."))}getFrames(){var n,t,i,s,o,r;return this.clip?Math.max(((t=(n=this.pos)==null?void 0:n.times)==null?void 0:t.length)??0,((s=(i=this.rot)==null?void 0:i.times)==null?void 0:s.length)??0,((r=(o=this.scale)==null?void 0:o.times)==null?void 0:r.length)??0):2}getDuration(){return this.duration}getSortedTimesArray(n=!0,t=!0,i=!0){var s,o,r;if(!this.clip)return[0,this.duration];const l=(s=this.pos)==null?void 0:s.times,c=(o=this.rot)==null?void 0:o.times,h=(r=this.scale)==null?void 0:r.times,d=[];if(n&&l)for(const u of l)d.push(u);if(t&&c)for(const u of c)d.push(u);if(i&&h)for(const u of h)d.push(u);return d.includes(0)||d.push(0),d.sort((u,p)=>u-p),[...new Set(d)]}*getValues(n,t=!0,i=!0,s=!0){var o,r,l;const c=new x,h=new V,d=new x(1,1,1),u=this.target,p=t?(o=this.pos)==null?void 0:o.createInterpolant():void 0,g=i?(r=this.rot)==null?void 0:r.createInterpolant():void 0,y=s?(l=this.scale)==null?void 0:l.createInterpolant():void 0;p||c.set(u.position.x,u.position.y,u.position.z),g||h.set(u.quaternion.x,u.quaternion.y,u.quaternion.z,u.quaternion.w),y||d.set(u.scale.x,u.scale.y,u.scale.z),p&&p.valueSize!==3&&(p.valueSize=3),g&&g.valueSize!==4&&(g.valueSize=4),y&&y.valueSize!==3&&(y.valueSize=3);const f=0;for(let v=0-f;v<n.length+f;v++){let b=0,w=0;if(v<0?(b=n[0],w=b-ip.animationDurationPadding/2+1/60):v>=n.length?(b=n[n.length-1],w=b+ip.animationDurationPadding/2-1/60):(b=n[v],w=b),p){const _=p.evaluate(b);c.set(_[0],_[1],_[2])}if(g){const _=g.evaluate(b);h.set(_[0],_[1],_[2],_[3])}if(y){const _=y.evaluate(b);d.set(_[0],_[1],_[2])}if(this.useRootMotion&&u===this.root){const _=new se;_.compose(c,h,d),_.multiply(u.matrix),_.decompose(c,h,d)}yield{time:w,translation:c,rotation:h,scale:d,index:v}}}};let Ke=ip;a(Ke,"frameRate",60),a(Ke,"animationDurationPadding",6/60),a(Ke,"restPoseClipDuration",6/60);class np{constructor(t){a(this,"dict",new Map),a(this,"rootTargetMap",new Map),a(this,"rootAndClipToRegisteredAnimationMap",new Map),a(this,"rootToRegisteredClip",new Map),a(this,"lastClipEndTime",0),a(this,"clipToStartTime",new Map),a(this,"clipToHoldClip",new Map),a(this,"serializers",[]),a(this,"injectRestPoses",!1),a(this,"injectImplicitBehaviours",!1),this.injectRestPoses=t,this.injectImplicitBehaviours=t}get extensionName(){return"animation"}get animationData(){return this.dict}get registeredClips(){return this.clipToStartTime.keys()}get animatedRoots(){return this.rootTargetMap.keys()}get holdClipMap(){return this.clipToHoldClip}getStartTimeCode(){return!this.injectRestPoses||this.rootAndClipToRegisteredAnimationMap.size===0?0:(Ke.restPoseClipDuration+Ke.animationDurationPadding)*60}getEndTimeCode(){let t=0;for(const[i,s]of this.rootAndClipToRegisteredAnimationMap){const o=s.start+s.duration;o>t&&(t=o)}return t*60}getClipCount(t){var i;return((i=this.rootToRegisteredClip.get(t))==null?void 0:i.length)??0??0}getStartTimeByClip(t){return t?this.clipToStartTime.has(t)?this.clipToStartTime.get(t):(console.error("USDZExporter: Missing start time for clip \u2013 please report a bug.",t),0):0}registerAnimation(t,i){var s;if(!t)return null;this.rootTargetMap.has(t)||this.rootTargetMap.set(t,[]);const o=t.uuid+(i?.uuid??"-rest");if(this.rootAndClipToRegisteredAnimationMap.has(o))return this.rootAndClipToRegisteredAnimationMap.get(o);ts&&console.log("registerAnimation",t,i);const r=this.injectRestPoses?1:0,l=(((s=this.rootToRegisteredClip.get(t))==null?void 0:s.length)??0)+r,c=this.rootTargetMap.get(t),h=new Set(c);if(i&&i.tracks)for(const u of i.tracks){const p=fa.parseTrackName(u.name),g=fa.findNode(t,p.nodeName);if(!g){console.warn("no object found for track",u.name,"using "+t.name+" instead");continue}this.dict.has(g)||this.dict.set(g,[]);const y=this.dict.get(g);if(!y){console.warn("no transform data found for target ",g,"at slot "+l+", this is likely a bug");continue}h.delete(g),this.injectRestPoses&&!y[0]&&(console.log("Injecting rest pose",g,i,"at slot",l),y[0]=new Ke(null,g,null));let f=y[l];f||(f=new Ke(t,g,i),y[l]=f),f.addTrack(u),c!=null&&c.includes(g)||c==null||c.push(g)}ts&&console.log("Unregistered nodes for this clip",h,"clip",i,"at slot",l,"for root",t,"targets",c);for(const u of h){const p=this.dict.get(u);if(!p)continue;if(this.injectRestPoses&&!p[0]){console.warn("Adding rest pose for ",u,i,"at slot",l,"This is likely a bug, should have been added earlier.");const y=new Ke(null,u,null);p[0]=y}let g=p[l];g||(ts&&console.log("Adding padding clip for ",u,i,"at slot",l),g=new Ke(t,u,i),p[l]=g)}const d=new nr(this,t,i);if(this.rootAndClipToRegisteredAnimationMap.set(o,d),ts&&console.log({root:t,clip:i,info:d}),i){const u=this.rootToRegisteredClip.get(t);if(u?u.push(i):this.rootToRegisteredClip.set(t,[i]),!this.clipToStartTime.get(i)){this.lastClipEndTime==null&&(this.lastClipEndTime=Ke.restPoseClipDuration);let p=this.lastClipEndTime+Ke.animationDurationPadding,g=p+i.duration;const y=Math.round(p*60)/60,f=Math.round(g*60)/60;Math.abs(y-p)<.01&&(p=y),Math.abs(f-g)<.01&&(g=f),p=Math.ceil(p),g=p+i.duration,this.clipToStartTime.set(i,p),this.lastClipEndTime=g}}return d}onAfterHierarchy(t){ts&&console.log("Animation clips per animation target node",this.dict)}onAfterBuildDocument(t){var i,s;ts&&console.log("Animation data",{dict:this.dict,rootTargetMap:this.rootTargetMap,rootToRegisteredClip:this.rootToRegisteredClip});for(const o of this.rootTargetMap.keys()){const r=this.rootTargetMap.get(o);if(!r)continue;let l;const c=[];for(const h of r){const d=this.dict.get(h);if(!d){console.error("No data found for target on USDZ export \u2013 please report a bug!",h);continue}l===void 0&&(l=d?.length),l!==d?.length&&console.error("Different array lengths for targets \u2013 please report a bug!",d);for(let u=0;u<d.length;u++){let p=d[u];if(!p){const y=u-(this.injectRestPoses?1:0);d[u]=new Ke(null,h,this.rootToRegisteredClip.get(o)[y]),p=d[u]}const g=p.getDuration();if(c[u]===void 0)c[u]=g;else if(c[u]!==g){console.error("Error during UDSZ export: Encountered different animation durations for animated targets. Please report a bug!",{datas:d,target:h}),c[u]=g;continue}}}}for(const o of this.serializers){const r=(i=o.model)==null?void 0:i.parent,l=r?.isDynamic===!0;n0&&console.log(l,(s=o.model)==null?void 0:s.parent),l&&o.registerCallback(r)}}onExportObject(t,i,s){O.foreachComponent(t,r=>{const l=r;typeof l.createAnimation=="function"&&l.createAnimation(this,i,s)},!1);const o=new pT(t,this);this.serializers.push(o),o.registerCallback(i)}}class pT{constructor(t,i){a(this,"model"),a(this,"object"),a(this,"animationData"),a(this,"ext"),a(this,"callback"),this.object=t,this.animationData=i.animationData,this.ext=i}registerCallback(t){this.model&&this.callback&&this.model.removeEventListener("serialize",this.callback),this.callback||(this.callback=this.onSerialize.bind(this)),n0&&console.log("REPARENT",t),this.model=t,this.callback&&this.model.addEventListener("serialize",this.callback)}skinnedMeshExport(t,i,s){var o;const r=this.model,l=this.animationData;if(r&&r.skinnedMesh){let c=function(E){const z=[];for(const[H,ie]of E){let oe=`${H} : [`;const de=[];for(const me of ie)de.push(`(${he(me.x)}, ${he(me.y)}, ${he(me.z)})`);oe=oe.concat(de.join(", ")),oe=oe.concat("],"),z.push(oe)}return z},h=function(E){const z=[];for(const[H,ie]of E){let oe=`${H} : [`;const de=[];for(const me of ie)de.push(`(${he(me.w)}, ${he(me.x)}, ${he(me.y)}, ${he(me.z)})`);oe=oe.concat(de.join(", ")),oe=oe.concat("],"),z.push(oe)}return z},d=function(E){let z,H=!0;const ie=new Map;for(const[de,me]of E){z===void 0&&(z=me.length),z!==me.length&&(H=!1);let Xe=0;for(const Qe of me)Xe++,Qe||(ie.has(de)||ie.set(de,[]),ie.get(de).push(Xe))}ts&&console.log("Bone count: ",E.size,"TransformData entries per bone: ",z,"Undefined bone entries: ",ie),console.assert(H,"All bones should have the same number of TransformData entries",E),console.assert(ie.size===0,"All TransformData entries should be set",ie);const oe=[];for(const[de,me]of E)for(let Xe=0;Xe<me.length;Xe++){const Qe=me[Xe],hn=s.getStartTimeByClip(Qe.clip);oe.length<=Xe&&oe.push({pos:[],rot:[],scale:[],timeOffset:hn});const dn=oe[Xe];dn.pos.push(...Qe.getSortedTimesArray(!0,!1,!1)),dn.rot.push(...Qe.getSortedTimesArray(!1,!0,!1)),dn.scale.push(...Qe.getSortedTimesArray(!1,!1,!0))}for(const de of oe)de.pos.sort((me,Xe)=>me-Xe),de.rot.sort((me,Xe)=>me-Xe),de.scale.sort((me,Xe)=>me-Xe),de.pos=[...new Set(de.pos)],de.rot=[...new Set(de.rot)],de.scale=[...new Set(de.scale)];return oe},u=function(E,z,H){const ie=new Map,oe=new Map,de=new Map,me=z.length;for(const Xe of H){const Qe=E.get(Xe);let hn;Qe?console.assert(Qe.length===me,"We should have the same number of TransformData entries for each bone",Qe,z):hn=new Ke(null,Xe,null);for(let dn=0;dn<me;dn++){const Hl=Qe?Qe[dn]:hn,pa=z[dn];for(const{time:$l,translation:Gl}of Hl.getValues(pa.pos,!0,!1,!1)){const un=($l+pa.timeOffset)*60;ie.has(un)||ie.set(un,new Array),ie.get(un).push(Gl.clone())}for(const{time:$l,rotation:Gl}of Hl.getValues(pa.rot,!1,!0,!1)){const un=($l+pa.timeOffset)*60;oe.has(un)||oe.set(un,new Array),oe.get(un).push(Gl.clone())}for(const{time:$l,scale:Gl}of Hl.getValues(pa.scale,!1,!1,!0)){const un=($l+pa.timeOffset)*60;de.has(un)||de.set(un,new Array),de.get(un).push(Gl.clone())}}}return{position:ie.size==0?void 0:ie,quaternion:oe.size==0?void 0:oe,scale:de.size==0?void 0:de}},p=function(E){const z=[];for(const H of E)z.push(`(${he(H.x)}, ${he(H.y)}, ${he(H.z)})`);return z.join(", ")},g=function(E){const z=[];for(const H of E)z.push(`(${he(H.w)}, ${he(H.x)}, ${he(H.y)}, ${he(H.z)})`);return z.join(", ")},y=function(E){const z=new Map;if(ts){const H=new Array;for(const[ie,oe]of l)H.push(ie.uuid+": "+oe.length+" "+oe.map(de=>{var me;return(me=de.clip)==null?void 0:me.uuid.substring(0,6)}).join(" "));console.log(`getPerBoneTransformData
`+H.join(`
`))}for(const H of E){const ie=l.get(H);ie&&z.set(H,ie)}return z},f=function(E){const z=y(E),H=d(z);return u(z,H,E)};const v=r.skinnedMesh.skeleton,b=new Array,w=[],_=[];for(const E of v.bones){w.push(E),_.push(E.uuid);const z=v.boneInverses[v.bones.indexOf(E)];b.push({bone:E,inverse:z})}let S=1e4;for(;_.length<v.bones.length&&S-- >0;)for(const E of w){const z=E.children;for(const H of z)if(_.indexOf(H.uuid)===-1&&v.bones.indexOf(H)!==-1){w.push(H),_.push(H.uuid);const ie=v.boneInverses[v.bones.indexOf(H)];b.push({bone:H,inverse:ie})}}S<=0&&console.error("Failed to sort bones in skinned mesh",r.skinnedMesh,v.bones,_);for(const E of yx(v.bones))b.push({bone:E,inverse:E.matrixWorld.clone().invert()});const R=b[0].bone.parent;R||console.error("No bone parent found for skinned mesh during USDZ export",r.skinnedMesh),b.sort((E,z)=>hl(E.bone,R)>hl(z.bone,R)?1:-1);const M=i.quickLookCompatible,T=[],L=[],D=[],U=[];for(const{bone:E}of b){if(M){const z=E.scale;z.x==0&&(z.x=1e-5),z.y==0&&(z.y=1e-5),z.z==0&&(z.z=1e-5),T.push(new se().compose(E.position,E.quaternion,E.scale))}else T.push(E.matrix.clone());L.push(E.position),D.push(E.quaternion),U.push(E.scale)}const B=b.map(E=>'"'+hl(E.bone,R)+'"').join(", "),Y=b.map(E=>Mx(E.inverse.clone().invert())).join(", ");t.beginBlock('def Skeleton "Rig"'),t.appendLine(`uniform matrix4d[] bindTransforms = [${Y}]`),t.appendLine(`uniform token[] joints = [${B}]`),t.appendLine('uniform token purpose = "guide"'),t.appendLine(`uniform matrix4d[] restTransforms = [${T.map(E=>Mx(E)).join(", ")}]`);const $=f(b.map(E=>E.bone));if(ts){let E=1e7,z=0;for(const H of((o=$.position)==null?void 0:o.keys())??[])E=Math.min(E,H),z=Math.max(z,H);console.log("Time samples",E,z,$)}if(t.beginBlock('def SkelAnimation "_anim"'),t.appendLine(`uniform token[] joints = [${B}]`),t.appendLine(`quatf[] rotations = [${g(D)}]`),$&&$.quaternion){t.beginBlock("quatf[] rotations.timeSamples = {","");const E=h($.quaternion);for(const z of E)t.appendLine(z);t.closeBlock()}if(t.appendLine(`half3[] scales = [${p(U)}]`),$&&$.scale){t.beginBlock("half3[] scales.timeSamples = {","");const E=c($.scale);for(const z of E)t.appendLine(z);t.closeBlock()}if(t.appendLine(`float3[] translations = [${p(L)}]`),$&&$.position){t.beginBlock("float3[] translations.timeSamples = {","");const E=c($.position);for(const z of E)t.appendLine(z);t.closeBlock()}t.closeBlock(),t.closeBlock()}}onSerialize(t,i){if(!this.model)return;const s=this.animationData.get(this.object);if(s)for(let u=0;u<s.length;u++)s[u]===void 0&&(s[u]=new Ke(null,this.object,null));const o=this.ext;this.skinnedMeshExport(t,i,o);const r=this.object,l=this.model,c=this.animationData.get(r);if(!c||r.isSkinnedMesh)return;n0&&console.log("SERIALIZE",this.model.name,this.object.type,c);const h=Intl.NumberFormat("en-US",{maximumFractionDigits:3,minimumFractionDigits:0,useGrouping:!1});function d(u,p){var g;if(u.some(y=>y&&{position:y.pos,rotation:y.rot,scale:y.scale}[p])){switch(p){case"position":l.needsTranslate=!0,t.beginBlock("double3 xformOp:translate.timeSamples = {","");break;case"rotation":l.needsOrient=!0,t.beginBlock("quatf xformOp:orient.timeSamples = {","");break;case"scale":l.needsScale=!0,t.beginBlock("double3 xformOp:scale.timeSamples = {","");break}for(let y=0;y<u.length;y++){const f=u[y];if(!f)continue;const v=o.getStartTimeByClip(f.clip),b=f.getSortedTimesArray(p==="position",p==="rotation",p==="scale");if(!b||b.length===0){console.error("got an animated object but no time values?",r,f);continue}const w=!f.clip,_=p==="position"&&(f.pos||w),S=p==="rotation"&&(f.rot||w),R=p==="scale"&&(f.scale||w);if(_||S||R){const M=((g=f.clip)==null?void 0:g.name)??"rest",T=f.getDuration();ts&&console.log("Write .timeSamples:",M,v,T,u),t.appendLine("# "+M+": start="+h.format(v*Ke.frameRate)+", length="+h.format(T*Ke.frameRate)+", frames="+f.getFrames())}if(_)for(const{time:M,translation:T}of f.getValues(b,!0,!1,!1)){const L=`${h.format((v+M)*Ke.frameRate)}: (${he(T.x)}, ${he(T.y)}, ${he(T.z)}),`;t.appendLine(L)}if(S)for(const{time:M,rotation:T}of f.getValues(b,!1,!0,!1)){const L=`${h.format((v+M)*Ke.frameRate)}: (${he(T.w)}, ${he(T.x)}, ${he(T.y)}, ${he(T.z)}),`;t.appendLine(L)}if(R)for(const{time:M,scale:T}of f.getValues(b,!1,!1,!0)){const L=`${h.format((v+M)*Ke.frameRate)}: (${he(T.x)}, ${he(T.y)}, ${he(T.z)}),`;t.appendLine(L)}}t.closeBlock()}}d(c,"position"),d(c,"rotation"),d(c,"scale")}}const mT=C("debugusdz");class ua{constructor(){a(this,"files",new Array)}static getName(t){var i;const s=t.split(".").pop();let o=(i=t.split(".").slice(0,-1).join(".").split("/").pop())==null?void 0:i.replace(".","_");return o||(o="Audio_"+Math.random().toString(36).substring(2,15)),Tn(o)+"."+s}get extensionName(){return"Audio"}onExportObject(t,i,s){const o=O.getComponents(t,Ne);if(o.length)for(const r of o){if(!r.clip||typeof r.clip!="string"||!r.playOnAwake)continue;const l=r.clip.split("/").pop()||"Audio",c=ua.getName(r.clip),h=Tn(c);if(!this.files.some(d=>d.path===r.clip)){this.files.push({path:r.clip,name:c});const d=c.toLowerCase();s.quickLookCompatible&&!d.endsWith(".mp3")&&!d.endsWith(".wav")&&!d.endsWith(".m4a")&&console.error("Audio file "+r.clip+" from "+r.name+" is not an MP3 or WAV file. QuickLook may not support playing it.")}s.quickLookCompatible||i.addEventListener("serialize",(d,u)=>{d.appendLine(),d.beginBlock(`def SpatialAudio "${h}"`,"(",!1),d.appendLine(`displayName = "${l}"`),d.closeBlock(")"),d.beginBlock(),d.appendLine(`uniform asset filePath = @audio/${c}@`),d.appendLine(`uniform token auralMode = "${r.spatialBlend>0?"spatial":"nonSpatial"}"`),d.appendLine(`uniform token playbackMode = "${r.loop?"loopFromStage":"onceFromStart"}"`),d.appendLine(`uniform float gain = ${r.volume}`),d.closeBlock()})}}async onAfterSerialize(t){for(const i of this.files){const s="audio/"+i.name;if(t.files[s]){mT&&console.warn("Audio file with name "+s+" already exists in the context. Skipping.");continue}const o=await(await(await fetch(i.path)).blob()).arrayBuffer(),r=new Uint8Array(o);t.files[s]=r}}}var gT=Object.defineProperty,fT=Object.getOwnPropertyDescriptor,Ve=(n,t,i,s)=>{for(var o=s>1?void 0:s?fT(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&gT(t,i,o),o};const Fx=C("debugusdzbehaviours");function sh(n){n&&(n.getComponentInParent(Va)||(F()&&console.debug('Raycaster on "'+n.name+'" was automatically added, because no raycaster was found in the parent hierarchy.'),n.addComponent(Ai)))}class Br extends A{constructor(){super(...arguments),a(this,"object"),a(this,"target"),a(this,"duration",1),a(this,"relativeMotion",!1),a(this,"coroutine",null),a(this,"targetPos",new x),a(this,"targetRot",new V),a(this,"targetScale",new x)}start(){sh(this.gameObject)}onPointerClick(t){t.use(),this.coroutine&&this.stopCoroutine(this.coroutine),this.relativeMotion?this.coroutine=this.startCoroutine(this.moveRelative()):this.coroutine=this.startCoroutine(this.moveToTarget())}*moveToTarget(){if(!this.target||!this.object)return;const t=te(this.object).clone(),i=te(this.target).clone(),s=Ce(this.object).clone(),o=Ce(this.target).clone(),r=Ye(this.object).clone(),l=Ye(this.target).clone(),c=t.distanceTo(i),h=s.angleTo(o),d=r.distanceTo(l);if(c<.01&&h<.01&&d<.01){dt(this.object,i),Vi(this.object,o),xa(this.object,l),this.coroutine=null;return}let u=0,p=0;for(;u<1;)u+=this.context.time.deltaTime/this.duration,u>1&&(u=1),p=u<.5?4*u*u*u:1-Math.pow(-2*u+2,3)/2,this.targetPos.lerpVectors(t,i,p),this.targetRot.slerpQuaternions(s,o,p),this.targetScale.lerpVectors(r,l,p),dt(this.object,this.targetPos),Vi(this.object,this.targetRot),xa(this.object,this.targetScale),yield;this.coroutine=null}*moveRelative(){if(!this.target||!this.object)return;const t=this.object.position.clone(),i=this.object.quaternion.clone(),s=this.object.scale.clone(),o=this.target.position.clone(),r=this.target.quaternion.clone(),l=this.target.scale.clone();o.applyQuaternion(this.object.quaternion),this.targetPos.copy(this.object.position).add(o),this.targetRot.copy(this.object.quaternion).multiply(r),this.targetScale.copy(this.object.scale).multiply(l);let c=0,h=0;for(;c<1;)c+=this.context.time.deltaTime/this.duration,c>1&&(c=1),h=c<.5?4*c*c*c:1-Math.pow(-2*c+2,3)/2,this.object.position.lerpVectors(t,this.targetPos,h),this.object.quaternion.slerpQuaternions(i,this.targetRot,h),this.object.scale.lerpVectors(s,this.targetScale,h),yield;this.coroutine=null}beforeCreateDocument(t){var i;if(this.target&&this.object&&this.gameObject){const s=new Wt("Move to "+((i=this.target)==null?void 0:i.name),Tt.tapTrigger(this.gameObject),ve.transformAction(this.object,this.target,this.duration,this.relativeMotion?"relative":"absolute"));t.addBehavior(s)}}}Ve([m(j)],Br.prototype,"object",2),Ve([m(j)],Br.prototype,"target",2),Ve([m()],Br.prototype,"duration",2),Ve([m()],Br.prototype,"relativeMotion",2);var ul;const ei=(ul=class extends A{constructor(){super(...arguments),a(this,"materialToSwitch"),a(this,"variantMaterial"),a(this,"fadeDuration",0),a(this,"_objectsWithThisMaterial",null),a(this,"selfModel"),a(this,"targetModels")}start(){var n;this._objectsWithThisMaterial=this.objectsWithThisMaterial,sh(this.gameObject),F()&&this._objectsWithThisMaterial.length<=0&&console.warn('ChangeMaterialOnClick: No objects found with material "'+((n=this.materialToSwitch)==null?void 0:n.name)+'"')}onPointerEnter(n){this.context.input.setCursor("pointer")}onPointerExit(n){this.context.input.unsetCursor("pointer")}onPointerClick(n){if(n.use(),!!this.variantMaterial)for(let t=0;t<this.objectsWithThisMaterial.length;t++){const i=this.objectsWithThisMaterial[t];i.material=this.variantMaterial}}get objectsWithThisMaterial(){return this._objectsWithThisMaterial!=null?this._objectsWithThisMaterial:(this._objectsWithThisMaterial=[],this.variantMaterial&&this.materialToSwitch&&this.context.scene.traverse(n=>{if(n instanceof X)if(Array.isArray(n.material)){for(const t of n.material)if(t===this.materialToSwitch){this.objectsWithThisMaterial.push(n);break}}else n.material===this.materialToSwitch?this.objectsWithThisMaterial.push(n):d_(n.material,this.materialToSwitch)&&this.objectsWithThisMaterial.push(n)}),this._objectsWithThisMaterial)}async beforeCreateDocument(n,t){this.targetModels=[],ei._materialTriggersPerId={},ei.variantSwitchIndex=0,this.materialToSwitch&&await it.assignTextureLOD(this.materialToSwitch,0),this.variantMaterial&&await it.assignTextureLOD(this.variantMaterial,0)}createBehaviours(n,t,i){this.objectsWithThisMaterial.find(s=>s.uuid===t.uuid)&&this.targetModels.push(t),this.gameObject.uuid===t.uuid&&(this.selfModel=t,this.materialToSwitch&&(ei._materialTriggersPerId[this.materialToSwitch.uuid]||(ei._materialTriggersPerId[this.materialToSwitch.uuid]=[]),ei._materialTriggersPerId[this.materialToSwitch.uuid].push(this)))}afterCreateDocument(n,t){if(!this.materialToSwitch)return;const i=ei._materialTriggersPerId[this.materialToSwitch.uuid];if(i){const s={};for(const o of i){const r=o.createVariants();r&&r.length>0&&(s[o.selfModel.uuid]=r)}for(const o of i){const r=[];for(const l in s)l!==o.selfModel.uuid&&r.push(...s[l]);o.createAndAttachBehaviors(n,s[o.selfModel.uuid],r)}}delete ei._materialTriggersPerId[this.materialToSwitch.uuid]}createAndAttachBehaviors(n,t,i){const s=[],o=Math.max(0,this.fadeDuration);s.push(ve.fadeAction([...this.targetModels,...i],o,!1)),s.push(ve.fadeAction(t,o,!0)),n.addBehavior(new Wt("Select_"+this.selfModel.name,Tt.tapTrigger(this.selfModel),ve.parallel(...s))),ei._parallelStartHiddenActions.push(...t),ei._startHiddenBehaviour||(ei._startHiddenBehaviour=new Wt("StartHidden_"+this.selfModel.name,Tt.sceneStartTrigger(),ve.fadeAction(ei._parallelStartHiddenActions,o,!1)),n.addBehavior(ei._startHiddenBehaviour))}static getMaterialName(n){return Tn(n.name||"Material")+"_"+n.id}createVariants(){if(!this.variantMaterial)return null;const n=[];for(const t of this.targetModels){const i=t.clone();i.name+="_Variant_"+ei.variantSwitchIndex+++"_"+ei.getMaterialName(this.variantMaterial),i.displayName=i.displayName+": Variant with material "+this.variantMaterial.name,i.material=this.variantMaterial,i.geometry=t.geometry,i.transform=t.transform,(!t.parent||!t.parent.isEmpty())&&Zt.createEmptyParent(t),t.parent&&t.parent.add(i),n.push(i)}return n}},a(ul,"_materialTriggersPerId",{}),a(ul,"_startHiddenBehaviour",null),a(ul,"_parallelStartHiddenActions",[]),a(ul,"variantSwitchIndex",0),ul);let pl=ei;Ve([m(ke)],pl.prototype,"materialToSwitch",2),Ve([m(ke)],pl.prototype,"variantMaterial",2),Ve([m()],pl.prototype,"fadeDuration",2);var ml;const He=(ml=class extends A{constructor(){super(...arguments),a(this,"target"),a(this,"toggleOnClick",!1),a(this,"targetState",!0),a(this,"hideSelf",!0),a(this,"selfModel"),a(this,"selfModelClone"),a(this,"targetModel"),a(this,"toggleModel"),a(this,"stateBeforeCreatingDocument",!1),a(this,"targetStateBeforeCreatingDocument",!1)}start(){sh(this.gameObject)}onPointerClick(n){n.use(),!this.toggleOnClick&&this.hideSelf&&(this.gameObject.visible=!1),this.target&&(this.target.visible=this.toggleOnClick?!this.target.visible:this.targetState)}createBehaviours(n,t,i){t.uuid===this.gameObject.uuid&&(this.selfModel=t,this.selfModelClone=t.clone())}beforeCreateDocument(){this.target&&(this.gameObject[He.wasVisible]===void 0&&(this.gameObject[He.wasVisible]=this.gameObject.activeSelf),this.target[He.wasVisible]===void 0&&(this.target[He.wasVisible]=this.target.activeSelf),this.stateBeforeCreatingDocument=this.gameObject[He.wasVisible],this.targetStateBeforeCreatingDocument=this.target[He.wasVisible],this.gameObject.visible=!0,this.target.visible=!0)}afterCreateDocument(n,t){if(!this.target)return;this.targetModel=t.document.findById(this.target.uuid);const i=this.selfModel;if(this.selfModel&&this.targetModel){let s=this.selfModel,o=this.targetState;if(this.toggleOnClick)if(o=!this.targetStateBeforeCreatingDocument,!this.selfModelClone.geometry)(!this.selfModel.parent||this.selfModel.parent.isEmpty())&&Gf.createEmptyParent(this.selfModel),this.toggleModel=this.selfModel.deepClone(),this.toggleModel.name+="_toggle",this.selfModel.parent.add(this.toggleModel);else{if(!this.gameObject[He.toggleClone]){const c=this.selfModelClone.clone();c.setMatrix(new se),c.name+="_toggle"+He.clonedToggleIndex++,i.add(c),this.gameObject[He.toggleClone]=c,console.warn("USDZExport: Toggle "+this.gameObject.name+" doesn't have geometry. It will be deep cloned and nested behaviours will likely not work.")}const l=this.gameObject[He.toggleClone];if(!this.gameObject[He.reverseToggleClone]){const c=this.selfModelClone.clone();c.setMatrix(new se),c.name+="_toggleReverse"+He.clonedToggleIndex++,i.add(c),this.gameObject[He.reverseToggleClone]=c}this.toggleModel=this.gameObject[He.reverseToggleClone],(!this.toggleModel.geometry||!l.geometry)&&console.error("triggers without childs and without geometry won't work!",this,i.geometry),s=l,i.geometry=null,i.material=null}if(this.toggleModel){if(this.toggleOnClick){const l=[];l.push(ve.fadeAction(s,0,!1)),l.push(ve.fadeAction(this.toggleModel,0,!0)),l.push(ve.fadeAction(this.targetModel,0,o)),n.addBehavior(new Wt("Toggle_"+s.name+"_ToggleTo"+(o?"On":"Off"),Tt.tapTrigger(s),ve.parallel(...l)));const c=[];c.push(ve.fadeAction(this.toggleModel,0,!1)),c.push(ve.fadeAction(s,0,!0)),c.push(ve.fadeAction(this.targetModel,0,!o)),n.addBehavior(new Wt("Toggle_"+s.name+"_ToggleTo"+(o?"Off":"On"),Tt.tapTrigger(this.toggleModel),ve.parallel(...c)))}}else{const l=[];this.hideSelf&&l.push(ve.fadeAction(s,0,!1)),l.push(ve.fadeAction(this.targetModel,0,o)),n.addBehavior(new Wt("Toggle_"+s.name+"_ToggleTo"+(o?"On":"Off"),Tt.tapTrigger(s),l.length>1?ve.parallel(...l):l[0]))}const r=new Array;this.targetStateBeforeCreatingDocument||r.push(this.targetModel),this.stateBeforeCreatingDocument||r.push(i),this.toggleModel&&r.push(this.toggleModel),gl.add(r,n)}}afterSerialize(n,t){this.gameObject[He.wasVisible]!==void 0&&(this.gameObject.visible=this.gameObject[He.wasVisible],delete this.gameObject[He.wasVisible]),this.target&&this.target[He.wasVisible]!==void 0&&(this.target.visible=this.target[He.wasVisible],delete this.target[He.wasVisible]),delete this.gameObject[He.toggleClone],delete this.gameObject[He.reverseToggleClone]}},a(ml,"clonedToggleIndex",0),a(ml,"wasVisible",Symbol("usdz_SetActiveOnClick_wasVisible")),a(ml,"toggleClone",Symbol("clone for toggling")),a(ml,"reverseToggleClone",Symbol("clone for reverse toggling")),ml);let Fr=He;Ve([m(j)],Fr.prototype,"target",2),Ve([m()],Fr.prototype,"toggleOnClick",2),Ve([m()],Fr.prototype,"targetState",2),Ve([m()],Fr.prototype,"hideSelf",2);const Ao=class extends A{constructor(){super(...arguments),a(this,"wasVisible",!1)}static add(n,t){const i=Array.isArray(n)?n:[n];for(const s of i)Ao._fadeObjects.includes(s)||(console.log("adding hide on start",s),Ao._fadeObjects.push(s));Ao._fadeBehaviour===void 0&&(Ao._fadeBehaviour=new Wt("HideOnStart",Tt.sceneStartTrigger(),ve.fadeAction(Ao._fadeObjects,0,!1)),t.addBehavior(Ao._fadeBehaviour))}start(){O.setActive(this.gameObject,!1)}createBehaviours(n,t,i){t.uuid===this.gameObject.uuid&&(this.wasVisible||Ao.add(t,n))}beforeCreateDocument(){this.wasVisible=O.isActiveSelf(this.gameObject)}};let gl=Ao;a(gl,"_fadeBehaviour"),a(gl,"_fadeObjects",[]);class fl extends A{constructor(){super(...arguments),a(this,"target"),a(this,"duration",.5),a(this,"motionType","bounce")}beforeCreateDocument(){}createBehaviours(t,i,s){if(this.target&&i.uuid===this.gameObject.uuid){const o=new Wt("emphasize "+this.name,Tt.tapTrigger(this.gameObject),ve.emphasize(this.target,this.duration,this.motionType,void 0,"basic"));t.addBehavior(o)}}afterCreateDocument(t,i){}}Ve([m()],fl.prototype,"target",2),Ve([m()],fl.prototype,"duration",2),Ve([m()],fl.prototype,"motionType",2);class Io extends A{constructor(){super(...arguments),a(this,"target"),a(this,"clip",""),a(this,"toggleOnClick",!1),a(this,"trigger","tap")}start(){sh(this.gameObject)}ensureAudioSource(){if(!this.target){const t=this.gameObject.addComponent(Ne);t&&(this.target=t,t.spatialBlend=1,t.volume=1,t.loop=!1,t.preload=!0)}}onPointerClick(t){var i;t.use(),!(!((i=this.target)!=null&&i.clip)&&!this.clip)&&(this.ensureAudioSource(),this.target&&(this.target.isPlaying&&this.toggleOnClick?this.target.stop():(!this.toggleOnClick&&this.target.isPlaying&&this.target.stop(),this.clip?this.target.play(this.clip):this.target.play())))}createBehaviours(t,i,s){if(!(!this.target&&!this.clip)&&i.uuid===this.gameObject.uuid){const o=this.clip?this.clip:this.target?this.target.clip:void 0;if(!o||typeof o!="string")return;const r=this.target?this.target.gameObject:this.gameObject;ua.getName(o);const l=this.target?this.target.volume:1,c=this.target&&this.target.spatialBlend==0?"nonSpatial":"spatial";let h=!1;this.gameObject.traverse(g=>{g instanceof X&&g.visible&&(h=!0)}),h=!0;const d=t.addAudioClip(o);let u=ve.playAudioAction(r,d,"play",l,c);this.target&&this.target.loop&&(u=ve.sequence(u).makeLooping());const p=this.name?"_"+this.name:"";if(h&&this.trigger==="tap"){this.toggleOnClick&&(u.multiplePerformOperation="stop");const g=new Wt("playAudio"+p,Tt.tapTrigger(i),u);t.addBehavior(g)}if(this.target&&this.target.playOnAwake&&this.target.enabled)if(h&&this.trigger==="tap")console.warn("USDZExport: Audio sources that are played on tap can't also auto-play at scene start due to a QuickLook bug.");else{const g=new Wt("playAudioOnStart"+p,Tt.sceneStartTrigger(),u);t.addBehavior(g)}}}}Ve([m(Ne)],Io.prototype,"target",2),Ve([m(URL)],Io.prototype,"clip",2),Ve([m()],Io.prototype,"toggleOnClick",2);var sp;const is=(sp=class extends A{constructor(){super(...arguments),a(this,"animator"),a(this,"stateName"),a(this,"trigger","tap"),a(this,"animation"),a(this,"selfModel"),a(this,"stateAnimationModel"),a(this,"animationSequence",new Array),a(this,"animationLoopAfterSequence",new Array),a(this,"randomOffsetNormalized",0)}get target(){var n,t;return((n=this.animator)==null?void 0:n.gameObject)||((t=this.animation)==null?void 0:t.gameObject)}start(){sh(this.gameObject)}onPointerClick(n){var t;n.use(),this.target&&this.stateName&&((t=this.animator)==null||t.play(this.stateName,0,0,.1))}createBehaviours(n,t,i){t.uuid===this.gameObject.uuid&&(this.selfModel=t)}afterSerialize(){if(is.rootsWithExclusivePlayback.size>1){const n='Multiple root objects targeted by more than one animation. To work around QuickLook bug FB13410767, animations will be set as "exclusive" and activating them will stop other animations being marked as exclusive.';F()&&we(n),console.warn(n,...is.rootsWithExclusivePlayback)}is.animationActions=[],is.rootsWithExclusivePlayback=new Set}afterCreateDocument(n,t){if(this.animationSequence===void 0&&this.animationLoopAfterSequence===void 0||!this.stateAnimationModel||!this.target)return;const i=t.document,s=t.extensions.find(l=>l instanceof np);if(!s)return;const o=s.getClipCount(this.target)>1;o&&(F()&&console.warn("Setting exclusive playback for "+this.target.name+"@"+this.stateName+" because it has "+s.getClipCount(this.target)+" animations. This works around QuickLook bug FB13410767."),is.rootsWithExclusivePlayback.add(this.target));const r=this.name?this.name:"";i.traverse(l=>{var c,h;if(l.uuid===((c=this.target)==null?void 0:c.uuid)){const d=is.getActionForSequences(i,l,this.animationSequence,this.animationLoopAfterSequence,this.randomOffsetNormalized),u=new Wt(this.trigger+"_"+r+"_toPlayAnimation_"+this.stateName+"_on_"+((h=this.target)==null?void 0:h.name),this.trigger=="tap"?Tt.tapTrigger(this.selfModel):Tt.sceneStartTrigger(),d);o&&u.makeExclusive(!0),n.addBehavior(u)}})}static getActionForSequences(n,t,i,s,o){const r=(c,h)=>{let d=is.animationActions.find(u=>u.affectedObjects==c&&u.start==h.start&&u.duration==h.duration&&u.animationSpeed==h.speed);return d||(d=ve.startAnimationAction(c,h),is.animationActions.push(d)),d},l=ve.sequence();if(i&&i.length>0)for(const c of i)l.addAction(r(t,c));if(s&&s.length>0){const c=l.actions.length==0?l:ve.sequence();for(const h of s)c.addAction(r(t,h));c.makeLooping(),l!==c&&l.addAction(c)}return o&&o>0&&l.actions.unshift(ve.waitAction(o)),l}static getAndRegisterAnimationSequences(n,t,i){var s,o,r,l,c,h,d,u;if(!t)return;const p=t.getComponent(kt),g=t.getComponent(Ut);if(!p&&!g)return;if(p&&!i)throw new Error("PlayAnimationOnClick: No stateName specified for animator "+p.name+" on "+t.name);let y=[],f=[];if(g){const M=n.registerAnimation(t,g.clip);M&&(g.loop?f.push(M):y.push(M));let T=0;if(g.minMaxOffsetNormalized){const L=g.minMaxOffsetNormalized.x,D=g.minMaxOffsetNormalized.y;T=(((s=g.clip)==null?void 0:s.duration)||1)*(L+Math.random()*(D-L))}return{animationSequence:y,animationLoopAfterSequence:f,randomTimeOffset:T}}const v=p?.runtimeAnimatorController;let b=v?.findState(i),w=[],_=[];if(v&&b){const M=new Array;M.push(b);let T=!1;for(;M.length<100;){if(!b||b===null||!b.transitions||b.transitions.length===0){(o=b.motion)!=null&&o.isLooping&&(T=!0);break}const L=b.transitions.find(U=>U.conditions.length===0),D=L?v.getState(L.destinationState,0):null;if(D&&M.includes(D)){b=D,T=!0;break}else if(L){if(b=D,!b)break;M.push(b)}else{T=((r=b.motion)==null?void 0:r.isLooping)??!1;break}}if(T&&b){const L=M.indexOf(b);w=M.slice(0,L),_=M.slice(L),Fx&&console.log("found loop from "+i,"states until loop",w,"states looping",_)}else w=M,_=[],Fx&&console.log("found no loop from "+i,"states",w);if(!_.length){const L=w[w.length-1],D=(l=L.motion)==null?void 0:l.clip;if(D){let U;if(n.holdClipMap.has(D))U=n.holdClipMap.get(D);else{const B=L.name+"_hold";U=D.clone(),U.duration=1,U.name=B;const Y=D.duration;U.tracks=D.tracks.map($=>{const E=$.clone();E.times=new Float32Array([0,Y]);const z=$.values.length,H=$.getValueSize(),ie=$.values.slice(z-H,z);return E.values=new Float32Array(2*H),E.values.set(ie,0),E.values.set(ie,H),E}),U.name=B,n.holdClipMap.set(D,U)}if(U){const B={name:U.name,motion:{clip:U,isLooping:!1,name:U.name},speed:1,transitions:[],behaviours:[],hash:L.hash+1};_.push(B)}}}}if(w.length===1&&(!((c=w[0].motion)!=null&&c.clip)||((d=(h=w[0].motion)==null?void 0:h.clip.tracks)==null?void 0:d.length)===0)){y=new Array;const M=n.registerAnimation(t,null);M&&y.push(M);return}if(w=w.filter(M=>{var T,L,D;return((T=M.motion)==null?void 0:T.clip)&&((D=(L=M.motion)==null?void 0:L.clip.tracks)==null?void 0:D.length)>0}),_=_.filter(M=>{var T,L,D;return((T=M.motion)==null?void 0:T.clip)&&((D=(L=M.motion)==null?void 0:L.clip.tracks)==null?void 0:D.length)>0}),w.length===0&&_.length===0){console.warn("No clips found for state "+i+" on "+p?.name+", can't export animation data");return}const S=(M,T)=>{if(!t)return;const L=n.registerAnimation(t,M.motion.clip??null);L?(L.speed=M.speed,T.push(L)):console.warn("Couldn't register animation for state "+M.name+" on "+p?.name)};if(w.length>0){y=new Array;for(const M of w)S(M,y)}if(_.length>0){f=new Array;for(const M of _)S(M,f)}let R=0;if(p&&v&&p.minMaxOffsetNormalized){const M=p.minMaxOffsetNormalized.x,T=p.minMaxOffsetNormalized.y,L=w.length?w[0]:_.length?_[0]:null;R=(((u=L?.motion.clip)==null?void 0:u.duration)||1)*(M+Math.random()*(T-M))}return{animationSequence:y,animationLoopAfterSequence:f,randomTimeOffset:R}}createAnimation(n,t,i){if(!this.target||!this.animator&&!this.animation)return;const s=is.getAndRegisterAnimationSequences(n,this.target,this.stateName);s&&(this.animationSequence=s.animationSequence,this.animationLoopAfterSequence=s.animationLoopAfterSequence,this.randomOffsetNormalized=s.randomTimeOffset,this.stateAnimationModel=t)}},a(sp,"animationActions",[]),a(sp,"rootsWithExclusivePlayback",new Set),sp);let zr=is;Ve([m(kt)],zr.prototype,"animator",2),Ve([m()],zr.prototype,"stateName",2);class yl extends A{constructor(){super(...arguments),a(this,"target")}getType(){}getDuration(){}}Ve([m(j)],yl.prototype,"target",2);class oh extends A{constructor(){super(...arguments),a(this,"target")}}Ve([m(yl)],oh.prototype,"target",2);class rh extends yl{constructor(){super(...arguments),a(this,"type",1),a(this,"duration",1)}getType(){switch(this.type){case 1:return"hide";case 0:return"show"}}getDuration(){return this.duration}}Ve([m()],rh.prototype,"type",2),Ve([m()],rh.prototype,"duration",2);class s0 extends oh{}const zx=class{constructor(){a(this,"_quicklookButton"),a(this,"_arButton"),a(this,"_vrButton"),a(this,"_sendToQuestButton")}static create(){return new zx}static getOrCreate(){return this._instance||(this._instance=this.create()),this._instance}get isSecureConnection(){return window.location.protocol==="https:"}get quicklookButton(){return this._quicklookButton}get arButton(){return this._arButton}get vrButton(){return this._vrButton}get sendToQuestButton(){return this._sendToQuestButton}get qrButton(){return ks.getOrCreate().createQRCode()}createQuicklookButton(){if(this._quicklookButton)return this._quicklookButton;const n=document.createElement("button");this._quicklookButton=n,n.dataset.needle="quicklook-button";const t=Q.supportsQuickLookAR();n.innerText="View in AR",n.prepend(Pt("view_in_ar"));let i=!1,s=null;return n.addEventListener("click",()=>{s=kc($e),s||(i=!0,s=new $e),i&&(s.objectToExport=ee.Current.scene),s?(n.classList.add("this-mode-is-requested"),s.exportAndOpen().then(()=>{n.classList.remove("this-mode-is-requested")}).catch(o=>{n.classList.remove("this-mode-is-requested"),console.error(o)})):console.warn("No USDZExporter component found in the scene")}),this.hideElementDuringXRSession(n),n}createARButton(n){var t;if(this._arButton)return this._arButton;const i="immersive-ar",s=document.createElement("button");return this._arButton=s,s.classList.add("webxr-button"),s.dataset.needle="webxr-ar-button",s.innerText="Enter AR",s.prepend(Pt("view_in_ar")),s.title="Click to start an AR session",s.addEventListener("click",()=>J.start(i,n)),this.updateSessionSupported(s,i),this.listenToXRSessionState(s,i),this.hideElementDuringXRSession(s),this.isSecureConnection||(s.disabled=!0,s.title="WebXR requires a secure connection (HTTPS)"),Q.isMozillaXR()||(t=navigator.xr)==null||t.addEventListener("devicechange",()=>this.updateSessionSupported(s,i)),s}createVRButton(n){var t;if(this._vrButton)return this._vrButton;const i="immersive-vr",s=document.createElement("button");return this._vrButton=s,s.classList.add("webxr-button"),s.dataset.needle="webxr-vr-button",s.innerText="Enter VR",s.prepend(Pt("panorama_photosphere")),s.title="Click to start a VR session",s.addEventListener("click",()=>J.start(i,n)),this.updateSessionSupported(s,i),this.listenToXRSessionState(s,i),this.hideElementDuringXRSession(s),this.isSecureConnection||(s.disabled=!0,s.title="WebXR requires a secure connection (HTTPS)"),Q.isMozillaXR()||(t=navigator.xr)==null||t.addEventListener("devicechange",()=>this.updateSessionSupported(s,i)),s}createSendToQuestButton(){var n;if(this._sendToQuestButton)return this._sendToQuestButton;const t="https://oculus.com/open_url/?url=",i=document.createElement("button");return this._sendToQuestButton=i,i.dataset.needle="webxr-sendtoquest-button",i.innerText="Open on Quest",i.prepend(Pt("share_windows")),i.title="Click to send this page to the Oculus Browser on your Quest",i.addEventListener("click",()=>{const s=encodeURIComponent(window.location.href),o=t+s;window.open(o)==null&&De("This page doesn't allow popups. Please paste "+o+" into your browser.")}),this.listenToXRSessionState(i),this.hideElementDuringXRSession(i),Q.isMozillaXR()||(n=navigator.xr)==null||n.addEventListener("devicechange",()=>{var s;(s=navigator.xr)!=null&&s.isSessionSupported("immersive-vr")?i.style.display="none":i.style.display=""}),i}createQRCode(){return ks.getOrCreate().createQRCode()}updateSessionSupported(n,t){if(!("xr"in navigator)){n.style.display="none";return}J.isSessionSupported(t).then(i=>{n.style.display=i?"":"none",F()&&!i&&console.log('[WebXR] "'+t+'" is not supported on this device \u2013 make sure your server runs using HTTPS and you have a device connected that supports '+t)})}hideElementDuringXRSession(n){Pd(t=>{n["previous-display"]=n.style.display,n.style.display="none"}),Jm(t=>{n["previous-display"]!=null&&(n.style.display=n["previous-display"])})}listenToXRSessionState(n,t){t&&(J.onSessionRequestStart(i=>{i.mode===t?n.classList.add("this-mode-is-requested"):(n["was-disabled"]=n.disabled,n.disabled=!0,n.classList.add("other-mode-is-requested"))}),J.onSessionRequestEnd(i=>{n.classList.remove("this-mode-is-requested"),n.classList.remove("other-mode-is-requested"),n.disabled=n["was-disabled"]}))}};let Ur=zx;a(Ur,"_instance");var yT=Object.defineProperty,vT=Object.getOwnPropertyDescriptor,xt=(n,t,i,s)=>{for(var o=s>1?void 0:s?vT(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&yT(t,i,o),o};const op=C("debugspriterenderer"),bT=C("wireframe"),o0=class{static getOrCreateGeometry(n){if(n.__cached_geometry)return n.__cached_geometry;if(n.guid&&o0.cache[n.guid])return op&&console.log("Take cached geometry for sprite",n.guid),o0.cache[n.guid];const t=new gs;n.__cached_geometry=t;const i=new Float32Array(n.triangles.length*3),s=new Float32Array(n.triangles.length*2);for(let o=0;o<n.triangles.length;o+=1){const r=n.triangles[o];i[o*3]=-n.vertices[r].x,i[o*3+1]=n.vertices[r].y,i[o*3+2]=0;const l=n.uv[r];s[o*2]=l.x,s[o*2+1]=1-l.y}return t.setAttribute("position",new yt(i,3)),t.setAttribute("uv",new yt(s,2)),n.guid&&(this.cache[n.guid]=t),op&&console.log("Built sprite geometry",n,t),t}};let ah=o0;a(ah,"cache",{});class _T{constructor(){a(this,"x"),a(this,"y")}}function Ux(n){n&&(n.colorSpace!=gn&&(n.colorSpace=gn,n.needsUpdate=!0),n.minFilter==ld&&n.magFilter==ld&&(n.anisotropy=1,n.needsUpdate=!0))}let Ns=class{constructor(n){a(this,"guid"),a(this,"texture"),a(this,"triangles"),a(this,"uv"),a(this,"vertices"),a(this,"__cached_geometry"),a(this,"_mesh"),a(this,"_material"),n&&(this.texture=n,this.triangles=[0,1,2,0,2,3],this.uv=[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:0,y:1}],this.vertices=[{x:-.5,y:-.5},{x:.5,y:-.5},{x:.5,y:.5},{x:-.5,y:.5}])}get mesh(){return this._mesh||(this._mesh=new X(ah.getOrCreateGeometry(this),this.material)),this._mesh}get material(){return this._material||(this.texture&&Ux(this.texture),this._material=new Re({map:this.texture,color:16777215,side:Ci,transparent:!0})),this._material}getGeometry(){return ah.getOrCreateGeometry(this)}};xt([m()],Ns.prototype,"guid",2),xt([m(Le)],Ns.prototype,"texture",2),xt([kr()],Ns.prototype,"triangles",2),xt([kr()],Ns.prototype,"uv",2),xt([kr()],Ns.prototype,"vertices",2);const r0=Symbol("spriteOwner");class vl{constructor(){a(this,"sprites"),this.sprites=[]}}xt([m(Ns)],vl.prototype,"sprites",2);const a0=class{constructor(){a(this,"spriteSheet"),a(this,"index",0)}static create(){const n=new a0;return n.spriteSheet=new vl,n}clone(){const n=new a0;return n.index=this.index,n.spriteSheet=this.spriteSheet,n}set sprite(n){n&&(this.spriteSheet?((this.index===null||this.index===void 0)&&(this.index=0),this.spriteSheet.sprites[this.index]=n):(this.spriteSheet=new vl,this.spriteSheet.sprites=[n],this.index=0))}get sprite(){if(this.spriteSheet)return this.spriteSheet.sprites[this.index]}update(n){if(!this.spriteSheet)return;const t=this.index;if(t<0||t>=this.spriteSheet.sprites.length)return;const i=this.spriteSheet.sprites[t],s=i?.texture;if(s&&(Ux(s),!i.__hasLoadedProgressive)){i.__hasLoadedProgressive=!0;const o=s;it.assignTextureLOD(s,0).then(r=>{r instanceof Le&&(i.texture=r,n?.map===o&&(n.map=r,n.needsUpdate=!0))})}}};let jo=a0;xt([m(vl)],jo.prototype,"spriteSheet",2),xt([m()],jo.prototype,"index",2);class mi extends A{constructor(){super(...arguments),a(this,"drawMode",0),a(this,"size",{x:1,y:1}),a(this,"color"),a(this,"sharedMaterial"),a(this,"transparent",!0),a(this,"cutoutThreshold",0),a(this,"castShadows",!1),a(this,"renderOrder",0),a(this,"toneMapped",!0),a(this,"_spriteSheet"),a(this,"_currentSprite")}set texture(t){var i;if(!this._spriteSheet)return;const s=(i=this._spriteSheet.spriteSheet)==null?void 0:i.sprites[this.spriteIndex];s&&(s.texture=t,this.updateSprite())}addSprite(t,i=!1){var s,o;if(this._spriteSheet||(this._spriteSheet=jo.create()),!this._spriteSheet.spriteSheet)return-1;(s=this._spriteSheet.spriteSheet)==null||s.sprites.push(t);const r=((o=this._spriteSheet.spriteSheet)==null?void 0:o.sprites.length)-1;return i&&(this.spriteIndex=r),r}get sprite(){return this._spriteSheet}set sprite(t){if(t!==this._spriteSheet)if(typeof t=="number"){const i=Math.floor(t);this.spriteIndex=i}else t instanceof Ns?(this._spriteSheet||(this._spriteSheet=jo.create()),this._spriteSheet.sprite!=t&&(this._spriteSheet.sprite=t),this.updateSprite()):t!=this._spriteSheet&&(this._spriteSheet=t,this.updateSprite())}set spriteIndex(t){this._spriteSheet&&(this._spriteSheet.index=t,this.updateSprite())}get spriteIndex(){var t;return((t=this._spriteSheet)==null?void 0:t.index)??0}get spriteFrames(){var t,i;return((i=(t=this._spriteSheet)==null?void 0:t.spriteSheet)==null?void 0:i.sprites.length)??0}awake(){this._currentSprite=void 0,this._spriteSheet?this._spriteSheet=this._spriteSheet.clone():this._spriteSheet=jo.create(),op&&console.log("Awake",this.name,this,this.sprite)}start(){this._currentSprite?this.gameObject&&this.gameObject.add(this._currentSprite):this.updateSprite()}updateSprite(t=!1){var i;if(!this.__didAwake&&!t)return!1;const s=this._spriteSheet;if(!((i=s?.spriteSheet)!=null&&i.sprites))return console.warn("SpriteRenderer has no data or spritesheet assigned..."),!1;const o=s.spriteSheet.sprites[this.spriteIndex];if(!o)return op&&console.warn("Sprite not found",this.spriteIndex,s.spriteSheet.sprites),!1;if(this._currentSprite)this._currentSprite.geometry=ah.getOrCreateGeometry(o),this._currentSprite.material.map=o.texture;else{const r=new Re({color:16777215,side:Ci});if(bT&&(r.wireframe=!0),this.color&&(r.color||(r.color=new ae),r.color.copy(this.color),r.opacity=this.color.alpha),r.transparent=!0,r.toneMapped=this.toneMapped,r.depthWrite=!1,o.texture&&!r.wireframe){let l=o.texture;l[r0]!==void 0&&l[r0]!==this&&this.spriteFrames>1&&(l=o.texture=l.clone()),l[r0]=this,r.map=l}this.sharedMaterial=r,this._currentSprite=new X(ah.getOrCreateGeometry(o),r),this._currentSprite.renderOrder=Math.round(this.renderOrder),it.assignTextureLOD(r,0)}return this._currentSprite.parent!==this.gameObject&&(this.drawMode===2&&this._currentSprite.scale.set(this.size.x,this.size.y,1),this.gameObject&&this.gameObject.add(this._currentSprite)),this._currentSprite&&this._currentSprite.layers.set(this.layer),this.sharedMaterial&&(this.sharedMaterial.alphaTest=this.cutoutThreshold,this.sharedMaterial.transparent=this.transparent),this._currentSprite.castShadow=this.castShadows,s?.update(this.sharedMaterial),!0}}xt([m()],mi.prototype,"drawMode",2),xt([m(_T)],mi.prototype,"size",2),xt([m(xe)],mi.prototype,"color",2),xt([m(ke)],mi.prototype,"sharedMaterial",2),xt([m()],mi.prototype,"transparent",2),xt([m()],mi.prototype,"cutoutThreshold",2),xt([m()],mi.prototype,"castShadows",2),xt([m()],mi.prototype,"renderOrder",2),xt([m()],mi.prototype,"toneMapped",2),xt([m(jo)],mi.prototype,"sprite",1);const Nx=C("debugwebxr"),wT=new se().makeRotationY(Math.PI),lh=class extends A{constructor(){super(...arguments),a(this,"_arScale",1),a(this,"invertForward",!1),a(this,"customReticle"),a(this,"arTouchTransform",!0),a(this,"autoPlace",!1),a(this,"autoCenter",!1),a(this,"useXRAnchor",!1),a(this,"_isPlacing",!0),a(this,"_startOffset",new se),a(this,"_createdPlacementObject",null),a(this,"_reparentedComponents",[]),a(this,"_placementScene",new wi),a(this,"_reticle",[]),a(this,"_hits",[]),a(this,"_placementStartTime",-1),a(this,"_rigPlacementMatrix"),a(this,"_anchor",null),a(this,"userInput"),a(this,"onPlaceScene",n=>{var t;if(this._isPlacing==!1||n!=null&&n.used)return;let i=this._reticle[0];if(!i){console.warn("No reticle to place...");return}if(!i.visible&&!this.autoPlace){console.warn("Reticle is not visible (can not place)");return}if((t=J.active)!=null&&t.isTrackingImages){console.warn("Scene Placement is disabled while images are being tracked");return}let s=this._hits[0];if(n&&n.origin instanceof eg){const o=this._reticle[n.origin.index];o&&(i=o,s=this._hits[n.origin.index])}if(n&&(n.stopImmediatePropagation(),n.stopPropagation(),n.use()),this._isPlacing=!1,this.context.input.removeEventListener("pointerup",this.onPlaceScene),this.onRevertSceneChanges(),i.position.copy(i.lastPos),i.quaternion.copy(i.lastQuat),this.onApplyPose(i),lh._hasPlaced=!0,this.useXRAnchor&&this.onCreateAnchor(J.active,s),this.context.xr)for(const o of this.context.xr.controllers)o.cancelHitTestSource()}),a(this,"upVec",new x(0,1,0)),a(this,"lookPoint",new x),a(this,"worldUpVec",new x(0,1,0))}static onPlaced(n){const t="placed";return this._eventListeners[t]||(this._eventListeners[t]=[]),this._eventListeners[t].push(n),()=>{const i=this._eventListeners[t].indexOf(n);i>=0&&this._eventListeners[t].splice(i,1)}}static get hasPlaced(){return this._hasPlaced}get arScale(){return this._arScale}set arScale(n){this._arScale=Math.max(1e-6,n),this.onSetScale()}onEnable(){var n;(n=this.customReticle)==null||n.preload()}supportsXR(n){return n==="immersive-ar"}onEnterXR(n){Nx&&console.log("ENTER WEBXR: SessionRoot start..."),this._anchor=null,lh._hasPlaced=!1,this.gameObject.updateMatrixWorld(),this._startOffset.copy(this.gameObject.matrixWorld);const t=new j;this._createdPlacementObject=t,t.name="AR Session Root",this._placementScene.name="AR Placement Scene",this._placementScene.children.length=0;for(let i=this.context.scene.children.length-1;i>=0;i--){const s=this.context.scene.children[i];this._placementScene.add(s)}if(this.context.scene.add(t),this.autoCenter){const i=oi(this._placementScene.children),s=i.getCenter(new x),o=i.getSize(new x),r=new se;r.makeTranslation(s.x,s.y-o.y*.5,s.z),this._startOffset.multiply(r)}this._reparentedComponents.length=0,this._reparentedComponents.push({comp:this,originalObject:this.gameObject}),O.addComponent(t,this);for(const i of this._reticle)Ti(i);this._reticle.length=0,this._isPlacing=!0,this.context.input.addEventListener("pointerup",this.onPlaceScene,{queue:ai.Early})}onLeaveXR(){this.context.input.removeEventListener("pointerup",this.onPlaceScene,{queue:ai.Early}),this.onRevertSceneChanges(),this._anchor=null,lh._hasPlaced=!1,this._rigPlacementMatrix=void 0}onUpdateXR(n){var t,i,s,o;if(n.xr.isTrackingImages){for(const r of this._reticle)r.visible=!1;return}if(this._isPlacing){const r=(t=n.xr.rig)==null?void 0:t.gameObject;r&&r.parent!==this.context.scene&&this.context.scene.add(r);let l=!1;if(n.xr.isPassThrough&&n.xr.controllers.length>0&&!this.autoPlace)for(const c of n.xr.controllers){const h=c.getHitTest();h&&(l=!0,this.updateReticleAndHits(n.xr,c.index,h,n.xr.rigScale))}if(!l){const c=n.xr.getHitTest();c&&this.updateReticleAndHits(n.xr,0,c,n.xr.rigScale)}}else{if(this._anchor&&n.xr.referenceSpace){const r=n.xr.frame.getPose(this._anchor.anchorSpace,n.xr.referenceSpace);if(r&&this.context.time.frame%20===0){const l=n.xr.convertSpace(r.transform),c=this._reticle[0];c&&(c.position.copy(l.position),c.quaternion.copy(l.quaternion),this.onApplyPose(c))}}if(this.arTouchTransform?(this.userInput||(this.userInput=new rp(this.context)),(i=this.userInput)==null||i.enable()):(s=this.userInput)==null||s.disable(),this.arTouchTransform&&(o=this.userInput)!=null&&o.hasChanged){if(n.xr.rig){const r=n.xr.rig.gameObject;this.userInput.applyMatrixTo(r.matrix,!0),r.matrix.decompose(r.position,r.quaternion,r.scale),this.userInput.factor=r.scale.x}this.userInput.reset()}}}updateReticleAndHits(n,t,i,s){this._hits[t]=i.hit;let o=this._reticle[t];if(!o){if(this.customReticle)if(this.customReticle.asset)o=Da(this.customReticle.asset);else{this.customReticle.loadAssetAsync();return}else o=new X(new hC(.07,.09,32).rotateX(-Math.PI/2),new Re({side:Ci,depthTest:!1,depthWrite:!1,transparent:!0,opacity:1,color:15658734})),o.name="AR Placement Reticle";if(Nx){const r=new Si(1);r.position.y+=.01,o.add(r)}this._reticle[t]=o,o.matrixAutoUpdate=!1,o.visible=!1}if(o.lastPos=o.lastPos||i.position.clone(),o.lastQuat=o.lastQuat||i.quaternion.clone(),o.position.copy(o.lastPos.lerp(i.position,this.context.time.deltaTime/.1)),o.lastPos.copy(o.position),o.quaternion.copy(o.lastQuat.slerp(i.quaternion,this.context.time.deltaTime/.05)),o.lastQuat.copy(o.quaternion),o.scale.set(s,s,s),this.customReticle&&this.applyViewBasedTransform(o),o.updateMatrix(),o.visible=!0,o.parent!==this.context.scene&&this.context.scene.add(o),this._placementStartTime<0&&(this._placementStartTime=this.context.time.realtimeSinceStartup),this.autoPlace)if(this.upVec.set(0,1,0).applyQuaternion(o.quaternion),this.upVec.dot(q(0,1,0))>.9){let r=o["autoplace:timer"]||0;r>=1?(o.visible=!1,this.onPlaceScene(null)):(r+=this.context.time.deltaTime,o["autoplace:timer"]=r)}else o["autoplace:timer"]=0}onSetScale(){var n,t,i;if(!lh._hasPlaced)return;const s=(t=(n=J.active)==null?void 0:n.rig)==null?void 0:t.gameObject;if(s){const o=((i=J.active)==null?void 0:i.rigScale)||1,r=1/this._arScale*o,l=new se().makeScale(r,r,r).invert();s.matrix.premultiply(l),s.matrix.decompose(s.position,s.quaternion,s.scale)}}onRevertSceneChanges(){var n;for(const t of this._reticle)t&&(t.visible=!1,t?.removeFromParent());this._reticle.length=0;for(let t=this._placementScene.children.length-1;t>=0;t--){const i=this._placementScene.children[t];this.context.scene.add(i)}(n=this._createdPlacementObject)==null||n.removeFromParent();for(const t of this._reparentedComponents)O.addComponent(t.originalObject,t.comp)}async onCreateAnchor(n,t){if(t.createAnchor===void 0){console.warn("Hit does not support creating an anchor",t),F()&&we("Hit does not support creating an anchor");return}else{const i=await t.createAnchor(n.viewerPose.transform);n.running&&i&&(this._anchor=i)}}applyViewBasedTransform(n){const t=this.context.mainCamera,i=n,s=t.worldPosition,o=i.worldPosition;this.upVec.set(0,1,0).applyQuaternion(n.quaternion);const r=t.worldPosition;r&&n.position.clone().sub(r).angleTo(this.upVec)<Math.PI/2&&this.upVec.negate();const l=this.upVec.angleTo(this.worldUpVec)*180/Math.PI,c=30;l>c&&l<180-c||l<-c&&l>-180+c?(this.lookPoint.copy(n.position).add(this.upVec),this.lookPoint.y=n.position.y,n.lookAt(this.lookPoint)):(s.y=o.y,n.lookAt(s))}onApplyPose(n){var t,i,s;const o=(i=(t=J.active)==null?void 0:t.rig)==null?void 0:i.gameObject;if(!o){console.warn("No rig object to place");return}const r=o.parent||this.context.scene;this._rigPlacementMatrix?(s=this._rigPlacementMatrix)==null||s.decompose(o.position,o.quaternion,o.scale):this._rigPlacementMatrix=o.matrix.clone(),this.applyViewBasedTransform(n),n.updateMatrix(),this.context.scene.add(n),n.attach(o),n.removeFromParent(),o.scale.set(this.arScale,this.arScale,this.arScale),o.position.multiplyScalar(this.arScale),o.updateMatrix(),this.invertForward&&o.matrix.premultiply(wT),o.matrix.premultiply(this._startOffset),o.matrix.decompose(o.position,o.quaternion,o.scale),r.add(o)}};let ns=lh;a(ns,"_eventListeners",{}),a(ns,"_hasPlaced",!1);const l0=class{constructor(n){a(this,"oneFingerDrag",!0),a(this,"twoFingerRotate",!0),a(this,"twoFingerScale",!0),a(this,"factor",1),a(this,"context"),a(this,"offset"),a(this,"plane"),a(this,"_scale",1),a(this,"_hasChanged",!1),a(this,"_enabled",!1),a(this,"currentlyUsedPointerIds",new Set),a(this,"currentlyUnusedPointerIds",new Set),a(this,"onPointerDownEarly",t=>{this.isActive&&t.stopPropagation()}),a(this,"onPointerDownLate",t=>{t.used?this.currentlyUsedPointerIds.add(t.pointerId):this.currentlyUsedPointerIds.size<=0&&this.currentlyUnusedPointerIds.add(t.pointerId)}),a(this,"onPointerUpEarly",t=>{this.currentlyUsedPointerIds.delete(t.pointerId),this.currentlyUnusedPointerIds.delete(t.pointerId)}),a(this,"prev",new Map),a(this,"_didMultitouch",!1),a(this,"touchStart",t=>{if(!t.defaultPrevented)for(let i=0;i<t.changedTouches.length;i++){const s=t.changedTouches[i],o=Q.isAndroidDevice()&&s.clientY<window.innerHeight*.1;this.prev.has(s.identifier)||this.prev.set(s.identifier,{ignore:o,x:0,z:0,screenx:0,screeny:0});const r=this.prev.get(s.identifier);if(r){const l=this.getPositionOnPlane(s.clientX,s.clientY);r.x=l.x,r.z=l.z,r.screenx=s.clientX,r.screeny=s.clientY}}}),a(this,"touchEnd",t=>{t.touches.length<=0&&(this._didMultitouch=!1);for(let i=0;i<t.changedTouches.length;i++){const s=t.changedTouches[i];this.prev.delete(s.identifier)}}),a(this,"touchMove",t=>{if(!t.defaultPrevented&&this.isActive){if(t.touches.length===1){if(this._didMultitouch)return;const i=t.touches[0],s=this.prev.get(i.identifier);if(!s||s.ignore)return;const o=this.getPositionOnPlane(i.clientX,i.clientY),r=o.x-s.x,l=o.z-s.z;if(r===0&&l===0)return;this.oneFingerDrag&&this.addMovement(r,l),s.x=o.x,s.z=o.z,s.screenx=i.clientX,s.screeny=i.clientY;return}else if(t.touches.length===2){this._didMultitouch=!0;const i=t.touches[0],s=t.touches[1],o=this.prev.get(i.identifier),r=this.prev.get(s.identifier);if(!o||!r)return;if(this.twoFingerRotate){const l=Math.atan2(i.clientY-s.clientY,i.clientX-s.clientX),c=Math.atan2(o.screeny-r.screeny,o.screenx-r.screenx),h=l-c;Math.abs(h)>.001&&this.addRotation(h)}if(this.twoFingerScale){const l=i.clientX-s.clientX,c=i.clientY-s.clientY,h=Math.sqrt(l*l+c*c),d=o.screenx-r.screenx,u=o.screeny-r.screeny,p=Math.sqrt(d*d+u*u),g=h-p;Math.abs(g)>2&&this.addScale(g)}o.screenx=i.clientX,o.screeny=i.clientY,r.screenx=s.clientX,r.screeny=s.clientY}}}),a(this,"_raycaster",new rd),a(this,"_intersection",new x),a(this,"_screenPos",new x),a(this,"_tempMatrix",new se),this.context=n,this.offset=new se,this.plane=new or,this.plane.setFromNormalAndCoplanarPoint(l0.up,l0.zero)}get scale(){return this._scale}reset(){this._scale=1,this.offset.identity(),this._hasChanged=!0}get hasChanged(){return this._hasChanged}applyMatrixTo(n,t){this._hasChanged=!1,t?(this.offset.invert(),n.premultiply(this.offset)):n.multiply(this.offset)}get isActive(){return this.currentlyUsedPointerIds.size<=0&&this.currentlyUnusedPointerIds.size>0}enable(){this._enabled||(this._enabled=!0,this.context.input.addEventListener("pointerdown",this.onPointerDownEarly,{queue:ai.Early}),this.context.input.addEventListener("pointerdown",this.onPointerDownLate,{queue:ai.Late}),this.context.input.addEventListener("pointerup",this.onPointerUpEarly,{queue:ai.Early}),window.addEventListener("touchstart",this.touchStart,{passive:!1}),window.addEventListener("touchmove",this.touchMove,{passive:!1}),window.addEventListener("touchend",this.touchEnd,{passive:!1}))}disable(){this._enabled&&(this._enabled=!1,this.context.input.removeEventListener("pointerdown",this.onPointerDownEarly,{queue:ai.Early}),this.context.input.removeEventListener("pointerdown",this.onPointerDownLate,{queue:ai.Late}),this.context.input.removeEventListener("pointerup",this.onPointerUpEarly,{queue:ai.Early}),window.removeEventListener("touchstart",this.touchStart),window.removeEventListener("touchmove",this.touchMove),window.removeEventListener("touchend",this.touchEnd))}getPositionOnPlane(n,t){const i=this.context.mainCamera;return this._screenPos.x=n/window.innerWidth*2-1,this._screenPos.y=-(t/window.innerHeight)*2+1,this._screenPos.z=1,this._screenPos.unproject(i),this._raycaster.set(i.position,this._screenPos.sub(i.position)),this._raycaster.ray.intersectPlane(this.plane,this._intersection),this._intersection}addMovement(n,t){n/=this._scale,t/=this._scale,n*=this.factor,t*=this.factor,this.offset.elements[12]+=n,this.offset.elements[14]+=t,(n!==0||t!==0)&&(this._hasChanged=!0)}addScale(n){n/=window.innerWidth,n*=-1,this._scale*=1+n,this._tempMatrix.makeScale(1-n,1-n,1-n),this.offset.premultiply(this._tempMatrix),n!==0&&(this._hasChanged=!0)}addRotation(n){n*=-1,this._tempMatrix.makeRotationY(n),this.offset.premultiply(this._tempMatrix),n!==0&&(this._hasChanged=!0)}};let rp=l0;a(rp,"up",new x(0,1,0)),a(rp,"zero",new x(0,0,0)),a(rp,"one",new x(1,1,1));const Lo=C("debugautosync"),c0=Symbol("syncerId");class xT{constructor(){a(this,"_syncers",{})}getOrCreateSyncer(t){if(!t.guid)return null;if(this._syncers[t.guid])return this._syncers[t.guid];const i=new ST(t);return i[c0]=t.guid,this._syncers[i[c0]]=i,i}removeSyncer(t){delete this._syncers[t[c0]]}}const h0=new xT;class ST{constructor(t){a(this,"comp"),a(this,"hasChanges",!1),a(this,"changedProperties",{}),a(this,"_isReceiving",!1),a(this,"_isInit",!1),a(this,"onHandleSending",()=>{if(!this.hasChanges)return;this.hasChanges=!1;const i=this.comp.context.connection;if(!i||!i.isConnected||!i.isInRoom){for(const s in this.changedProperties)delete this.changedProperties[s];return}for(const s in this.changedProperties){const o=this.changedProperties[s];Lo&&console.log("SEND",this.comp.guid,this.networkingKey),i.send(this.networkingKey,{guid:this.comp.guid,property:s,data:o},wn.Queued),delete this.changedProperties[s]}}),a(this,"onHandleReceiving",i=>{if(Lo&&console.log("SYNCFIELD RECEIVE",this.comp.name,this.comp.guid,i),!!this._isInit&&this.comp&&i.guid===this.comp.guid)try{this._isReceiving=!0,this.comp[i.property]=i.data}catch(s){console.error(s)}finally{this._isReceiving=!1}}),this.comp=t}get networkingKey(){return this.comp.guid}init(t){if(this._isInit)return;this._isInit=!0,this.comp=t,this.comp.context.post_render_callbacks.push(this.onHandleSending),this.comp.context.connection.beginListen(this.networkingKey,this.onHandleReceiving);const i=this.comp.context.connection.tryGetState(this.comp.guid);i&&this.onHandleReceiving(i)}destroy(){this._isInit&&(this.comp.context.post_render_callbacks.splice(this.comp.context.post_render_callbacks.indexOf(this.onHandleSending),1),this.comp.context.connection.stopListen(this.networkingKey,this.onHandleReceiving),this.comp=null,this._isInit=!1)}notifyChanged(t,i){this._isReceiving||(Lo&&console.log("Property changed: "+t,i),this.hasChanges=!0,this.changedProperties[t]=i)}}function CT(n,t){let i=t!==n;return!i&&n&&t&&(Array.isArray(n)&&Array.isArray(t)||typeof n=="object"&&typeof t=="object")&&(i=!0),i}const ch=Symbol("AutoSyncHandler");function OT(n){if(n[ch])return n[ch];const t=h0.getOrCreateSyncer(n);return t?.init(n),n[ch]=t,t}function PT(n){const t=n[ch];t&&(h0.removeSyncer(t),t.destroy(),delete n[ch])}const d0=function(n=null){return function(t,i){var s;let o="";typeof i=="string"?o=i:o=i.name;let r=null,l;typeof n=="string"?l=t[n]:typeof n=="function"&&(l=n),l==null&&(F()||Lo)&&n!=null&&console.warn('syncField: no callback function found for property "'+o+'"','"'+n+'"');const c=t,h=c.__internalAwake;if(typeof h!="function"){(Lo||F())&&console.error('@syncField can currently only used on Needle Engine Components, custom object of type "'+((s=t?.constructor)==null?void 0:s.name)+'" is not supported',t);return}Lo&&console.log(o);const d=Symbol(o);c.__internalAwake=function(){if(this[d]!==void 0)return;this[d]=this[o],r=h0.getOrCreateSyncer(this);const p=Object.getOwnPropertyDescriptor(this,o);if(p?.set===void 0){let g=!1;Object.defineProperty(this,o,{set:function(y){var f;const v=this[d];if(this[d]=y,g){(F()||Lo)&&console.warn("Recursive call detected",o);return}g=!0;try{const b=CT(y,v);Lo&&console.log("SyncField assignment",o,"changed?",b,y,l),b&&l?.call(this,y,v)!==!1&&((f=OT(this))==null||f.notifyChanged(o,y))}finally{g=!1}},get:function(){return this[d]},configurable:!0,enumerable:!0})}r?.init(this),h.call(this)};const u=c.__internalDestroy;c.__internalDestroy=function(){PT(this),u.call(this)}}};var kT=Object.defineProperty,MT=Object.getOwnPropertyDescriptor,ap=(n,t,i,s)=>{for(var o=s>1?void 0:s?MT(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&kT(t,i,o),o};const ti=C("debugplayersync"),Wx=class extends A{constructor(){super(...arguments),a(this,"autoSync",!0),a(this,"asset"),a(this,"onPlayerSpawned"),a(this,"_localInstance"),a(this,"onJoinedRoom",()=>{ti&&console.log("PlayerSync.joinedRoom. autoSync is set to "+this.autoSync),this.autoSync&&this.getInstance()}),a(this,"destroyInstance",()=>{var n;(n=this._localInstance)==null||n.then(t=>{ti&&console.log("PlayerSync.destroyInstance",t),wc(t,this.context.connection,!0,{saveInRoom:!1})}),this._localInstance=void 0})}static async setupFrom(n,t){const i=le.getOrCreateFromUrl(n);if(!i.asset){const r=await i.loadAssetAsync();r&&O.getOrAddComponent(r,ji)}const s=new Wx;s._internalInit(t),s.asset=i;const o=new j;return o.guid=n,O.addComponent(o,s),s}awake(){this.watchTabVisible(),this.onPlayerSpawned||(this.onPlayerSpawned=new Se)}onEnable(){this.context.connection.beginListen(ne.RoomStateSent,this.onJoinedRoom),this.context.connection.beginListen(ne.JoinedRoom,this.onJoinedRoom),this.context.connection.beginListen(ne.LeftRoom,this.destroyInstance),this.context.connection.isInRoom&&this.onJoinedRoom()}onDisable(){this.context.connection.stopListen(ne.RoomStateSent,this.onJoinedRoom),this.context.connection.stopListen(ne.JoinedRoom,this.onJoinedRoom),this.context.connection.stopListen(ne.LeftRoom,this.destroyInstance)}async getInstance(){var n,t,i,s,o,r;if(this._localInstance)return this._localInstance;if(ti&&console.log("PlayerSync.createInstance",(n=this.asset)==null?void 0:n.url),!((t=this.asset)!=null&&t.asset)&&!((i=this.asset)!=null&&i.url))return console.error('PlayerSync: can not create an instance because "asset" is not set and or has no URL!'),null;this.gameObject.guid||console.warn("PlayerSync: gameObject has no guid! This might cause issues with syncing the player state."),this._localInstance=(s=this.asset)==null?void 0:s.instantiateSynced({parent:this.gameObject,deleteOnDisconnect:!0},!0);const l=await this._localInstance;if(l){const c=O.getComponentsInChildren(l,ji);if(ti&&console.log(`PlayerSync.createInstance: found ${c?.length} PlayerState components. Owner: ${this.context.connection.connectionId}`),c!=null&&c.length){for(const h of c)h.owner=this.context.connection.connectionId;(o=this.onPlayerSpawned)==null||o.invoke(l)}else this._localInstance=void 0,console.error("<strong>Failed finding PlayerState on "+((r=this.asset)==null?void 0:r.url)+"</strong>: please make sure the asset has a PlayerState component!"),O.destroySynced(l)}else this._localInstance=void 0,console.warn("PlayerSync: failed instantiating asset!");return this._localInstance}watchTabVisible(){window.addEventListener("visibilitychange",n=>{if(document.visibilityState==="visible")for(let t=ji.all.length-1;t>=0;t--){const i=ji.all[t];(!i.owner||!this.context.connection.userIsInRoom(i.owner))&&i.doDestroy()}})}};let bl=Wx;ap([m()],bl.prototype,"autoSync",2),ap([m(le)],bl.prototype,"asset",2),ap([m(Se)],bl.prototype,"onPlayerSpawned",2);var Vx=(n=>(n.OwnerChanged="ownerChanged",n))(Vx||{}),hh;const Et=(hh=class extends A{constructor(){super(...arguments),a(this,"onOwnerChangeEvent",new Se),a(this,"onFirstOwnerChangeEvent",new Se),a(this,"hasOwner",!1),a(this,"owner"),a(this,"dontDestroy",!1),a(this,"onUserLeftRoom",n=>{if(n.userId===this.owner){ti&&console.log("PLAYERSYNC LEFT",this.owner),this.doDestroy();return}})}static get all(){return Et._all}static get local(){return Et._local}static getFor(n){if(n instanceof j)return O.getComponentInParent(n,Et);if(n instanceof A)return O.getComponentInParent(n.gameObject,Et)}static isLocalPlayer(n){const t=Et.getFor(n);return t?.isLocalPlayer??!1}static addEventListener(n,t){return this._callbacks[n]||(this._callbacks[n]=[]),this._callbacks[n].push(t),t}static removeEventListener(n,t){if(!this._callbacks[n])return;const i=this._callbacks[n].indexOf(t);i>=0&&this._callbacks[n].splice(i,1)}static dispatchEvent(n,t){if(this._callbacks[n])for(const i of this._callbacks[n])i(t)}get isLocalPlayer(){return this.owner===this.context.connection.connectionId}onOwnerChange(n,t){var i,s;ti&&console.log(`PlayerSync.onOwnerChange: ${t} \u2192 ${n} (me: ${this.context.connection.connectionId})`);const o=Et._local.indexOf(this);o>=0&&Et._local.splice(o,1);const r={playerState:this,oldValue:t,newValue:n};if(this.hasOwner||(this.hasOwner=!0,(i=this.onFirstOwnerChangeEvent)==null||i.invoke(r)),(s=this.onOwnerChangeEvent)==null||s.invoke(r),this.owner===this.context.connection.connectionId){Et._local.push(this);const c=new CustomEvent("local-owner-changed",{detail:r});this.dispatchEvent(c)}const l=new CustomEvent("owner-changed",{detail:r});this.dispatchEvent(l),Et.dispatchEvent("ownerChanged",l)}awake(){Et.all.push(this),ti&&console.log("Registered new PlayerState",this.guid,Et.all.length-1,Et.all),this.context.connection.beginListen(ne.UserLeftRoom,this.onUserLeftRoom)}async start(){ti&&console.log("PLAYERSTATE.START, owner: "+this.owner,this.context.connection.usersInRoom([])),this.owner?(this.context.connection.isInRoom||await yn(300),this.context.connection.userIsInRoom(this.owner)==!1&&(ti&&console.log(`PlayerSync.start \u2192 doDestroy "${this.name}" because user "${this.owner}" is not in room anymore...`,"Currently in room:",...this.context.connection.usersInRoom()),this.doDestroy())):this.owner||(ti&&console.warn("PlayerState.start \u2192 owner is undefined!",this.name),setTimeout(()=>{!this.destroyed&&!this.owner?this.dontDestroy?ti&&console.warn("PlayerState.start \u2192 owner is still undefined but dontDestroy is set to true",this.name):(ti&&console.warn(`PlayerState.start \u2192 owner is still undefined: destroying "${this.name}" instance now`),this.doDestroy()):ti&&console.log("PlayerState.start \u2192 owner is assigned",this.owner)},2e3))}doDestroy(){ti&&console.log("PlayerSync.doDestroy \u2192 syncDestroy",this.name),wc(this.gameObject,this.context.connection,!0,{saveInRoom:!1})}onDestroy(){if(ti&&console.warn("PlayerState.onDestroy",this.owner),this.context.connection.stopListen(ne.UserLeftRoom,this.onUserLeftRoom),Et.all.splice(Et.all.indexOf(this),1),this.isLocalPlayer){const n=Et._local.indexOf(this);n>=0&&Et._local.splice(n,1)}}},a(hh,"_all",[]),a(hh,"_local",[]),a(hh,"_callbacks",{}),hh);let ji=Et;ap([d0(ji.prototype.onOwnerChange)],ji.prototype,"owner",2);var RT=Object.defineProperty,TT=Object.getOwnPropertyDescriptor,_l=(n,t,i,s)=>{for(var o=s>1?void 0:s?TT(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&RT(t,i,o),o};class ss extends A{constructor(){super(...arguments),a(this,"position","bottom"),a(this,"showNeedleLogo",!0),a(this,"showSpatialMenu"),a(this,"createFullscreenButton"),a(this,"createMuteButton"),a(this,"createQRCodeButton")}onEnable(){this.applyOptions()}applyOptions(){this.context.menu.setPosition(this.position),this.context.menu.showNeedleLogo(this.showNeedleLogo),this.createFullscreenButton===!0&&this.context.menu.showFullscreenOption(!0),this.createMuteButton===!0&&this.context.menu.showAudioPlaybackOption(!0),this.showSpatialMenu===!0&&this.context.menu.showSpatialMenu(this.showSpatialMenu),this.createQRCodeButton===!0&&(Q.isMobileDevice()||this.context.menu.showQRCodeButton(!0))}}_l([m()],ss.prototype,"position",2),_l([m()],ss.prototype,"showNeedleLogo",2),_l([m()],ss.prototype,"showSpatialMenu",2),_l([m()],ss.prototype,"createFullscreenButton",2),_l([m()],ss.prototype,"createMuteButton",2),_l([m()],ss.prototype,"createQRCodeButton",2);var ET=Object.defineProperty,AT=Object.getOwnPropertyDescriptor,u0=(n,t,i,s)=>{for(var o=s>1?void 0:s?AT(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&ET(t,i,o),o};const dh=C("debugwebxr"),Hx=new V().setFromAxisAngle(new x(0,1,0),Math.PI);class Do extends A{constructor(){super(...arguments),a(this,"head"),a(this,"leftHand"),a(this,"rightHand"),a(this,"_leftHandMeshes"),a(this,"_rightHandMeshes"),a(this,"_syncTransforms")}async onEnterXR(t){if(!this.activeAndEnabled)return;dh&&console.warn("AVATAR ENTER XR",this.guid,this.sourceId,this,this.activeAndEnabled),this._syncTransforms&&(this._syncTransforms.length=0),await this.prepareAvatar();const i=ji.getFor(this);if(i!=null&&i.owner){const s=this.gameObject.addComponent(Rt);s.avatar=this.gameObject,s.connectionId=i.owner}else this.context.connection.isConnected?console.error("No player state found for avatar",this):i&&!this.context.connection.isConnected&&(i.dontDestroy=!0)}onLeaveXR(t){const i=this.gameObject.getComponent(Rt);i&&i.destroy()}onUpdateXR(t){var i,s;if(!this.activeAndEnabled)return;const o=ji.isLocalPlayer(this);if(!o)return;const r=t.xr;if(r.rig&&r.rig.gameObject!==this.gameObject.parent&&(this.gameObject.position.set(0,0,0),this.gameObject.rotation.set(0,0,0),this.gameObject.scale.set(1,1,1),r.rig.gameObject.add(this.gameObject)),this._syncTransforms&&o)for(const u of this._syncTransforms)u.fastMode=!0,u.isOwned()||u.requestOwnership();if(this.head&&this.context.mainCamera){const u=this.head.asset;if(u.position.copy(this.context.mainCamera.position),u.position.x*=-1,u.position.z*=-1,u.quaternion.copy(this.context.mainCamera.quaternion),u.quaternion.x*=-1,this.context.time.frameCount%10===0&&this.head.asset){const p=O.getComponentsInChildren(this.head.asset,Ii);for(const g of p)g.enabled=!1,g.gameObject.visible=!1}}const l=t.xr.leftController,c=(i=this.leftHand)==null?void 0:i.asset;l&&c?(c.position.copy(l.gripPosition),c.quaternion.copy(l.gripQuaternion),c.quaternion.multiply(Hx),c.visible=l.isTracking,this.updateHandVisibility(l,c,this._leftHandMeshes)):c&&c.visible&&(c.visible=!1);const h=t.xr.rightController,d=(s=this.rightHand)==null?void 0:s.asset;h&&d?(d.position.copy(h.gripPosition),d.quaternion.copy(h.gripQuaternion),d.quaternion.multiply(Hx),d.visible=h.isTracking,this.updateHandVisibility(h,d,this._rightHandMeshes)):d&&d.visible&&(d.visible=!1)}onBeforeRender(){this.context.xr&&this.context.time.frame%10===0&&this.updateRemoteAvatarVisibility()}updateHandVisibility(t,i,s){if(s){const o=t.model&&t.model.visible&&t.model!==i;s.forEach(r=>{Os(r,!o)})}}updateRemoteAvatarVisibility(){var t,i,s;if(this.context.connection.isConnected){const o=ji.getFor(this);if(o&&o.isLocalPlayer==!1){const r=J.getXRSync(this.context);if(r&&r.hasState(o.owner)){this.tryFindAvatarObjectsIfMissing();const l=(t=this.leftHand)==null?void 0:t.asset;l&&(l.visible=r?.isTracking(o.owner,"left")??!1);const c=(i=this.rightHand)==null?void 0:i.asset;c&&(c.visible=r?.isTracking(o.owner,"right")??!1)}if((s=this.head)!=null&&s.asset){const l=O.getComponentsInChildren(this.head.asset,Ii);for(const c of l)c.enabled=!1,c.gameObject.visible=!0}}}}tryFindAvatarObjectsIfMissing(){if(!this.head||!this.leftHand||!this.rightHand){const t={head:this.head,leftHand:this.leftHand,rightHand:this.rightHand};Fb.tryFindAvatarObjects(this.gameObject,this.sourceId||"",t),t.head&&(this.head=t.head),t.leftHand&&(this.leftHand=t.leftHand),t.rightHand&&(this.rightHand=t.rightHand)}}async prepareAvatar(){var t,i;if(this.tryFindAvatarObjectsIfMissing(),this.head)this.head instanceof j&&(this.head=new le("",this.sourceId,this.head));else{const s=new j;s.name="Head";const o=uo.createPrimitive(pr.Cube);s.add(o),this.gameObject.add(s),this.head=new le("",this.sourceId,s),dh&&console.log("Create head",s)}if(this.rightHand)this.rightHand instanceof j&&(this.rightHand=new le("",this.sourceId,this.rightHand));else{const s=new j;s.name="Right Hand",this.gameObject.add(s),this.rightHand=new le("",this.sourceId,s),dh&&console.log("Create right hand",s)}if(this.leftHand)this.leftHand instanceof j&&(this.leftHand=new le("",this.sourceId,this.leftHand));else{const s=new j;s.name="Left Hand",this.gameObject.add(s),this.leftHand=new le("",this.sourceId,s),dh&&console.log("Create left hand",s)}await this.loadAvatarObjects(this.head,this.leftHand,this.rightHand),this._leftHandMeshes=[],(t=this.leftHand.asset)==null||t.traverse(s=>{s!=null&&s.isMesh&&this._leftHandMeshes.push(s)}),this._rightHandMeshes=[],(i=this.rightHand.asset)==null||i.traverse(s=>{s!=null&&s.isMesh&&this._rightHandMeshes.push(s)}),ji.isLocalPlayer(this.gameObject)&&(this._syncTransforms=O.getComponentsInChildren(this.gameObject,qn))}async loadAvatarObjects(t,i,s){const o=t.loadAssetAsync(),r=i.loadAssetAsync(),l=s.loadAssetAsync(),c=new Array;o&&c.push(o),r&&c.push(r),l&&c.push(l);const h=await Mm(c);dh&&console.log("Avatar loaded results:",h)}}u0([m(le)],Do.prototype,"head",2),u0([m(le)],Do.prototype,"leftHand",2),u0([m(le)],Do.prototype,"rightHand",2);var IT=Object.defineProperty,jT=Object.getOwnPropertyDescriptor,lp=(n,t,i,s)=>{for(var o=s>1?void 0:s?jT(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&IT(t,i,o),o};const Ws=C("debugwebxr"),Bo=new Array;class os extends A{constructor(){super(...arguments),a(this,"createControllerModel",!0),a(this,"createHandModel",!0),a(this,"customLeftHand"),a(this,"customRightHand"),a(this,"_models",new Array)}supportsXR(t){return t==="immersive-vr"||t==="immersive-ar"}async onXRControllerAdded(t){var i;if(!(t.xr.isVR||t.xr.isPassThrough))return;const{controller:s}=t;if(Ws&&console.warn("Add Controller Model for",s.side,s.index),this.createControllerModel||this.createHandModel){if(s.hand){if(this.createHandModel){const o=await this.loadHandModel(this,s);if(!o||!s.connected||!s.isHand){o!=null&&o.handObject&&La(o.handObject,!1),(i=o?.handObject)==null||i.destroy();return}this._models.push({controller:s,model:o.handObject,handmesh:o.handmesh}),this._models.sort((r,l)=>r.controller.index-l.controller.index),this.scene.add(o.handObject),s.model=o.handObject}}else if(this.createControllerModel){const o=await s.getModelUrl();if(o){const r=await this.loadModel(s,o);if(!r||!s.connected||s.isHand)return;this._models.push({controller:s,model:r}),this._models.sort((l,c)=>l.controller.index-c.controller.index),this.scene.add(r),r.traverse(l=>{l.layers.set(2),l.matrixAutoUpdate=!1,l.updateMatrix()}),s.model=r}else s.targetRayMode!=="transient-pointer"&&console.warn("XRControllerModel: no model found for "+s.side)}}}onXRControllerRemoved(t){console.debug("XR Controller Removed",t.controller.side,t.controller.index);const i=this._models.findIndex(o=>o.controller===t.controller),s=this._models[i];s&&(this._models.splice(i,1),s.model&&(La(s.model,!1),s.model.destroy(),s.model=void 0))}onBeforeXR(t,i){this.createHandModel&&(this.customLeftHand||this.customRightHand)&&(i.optionalFeatures=i.optionalFeatures||[],i.optionalFeatures.includes("hand-tracking")||i.optionalFeatures.push("hand-tracking"))}onLeaveXR(t){for(const i of this._models)i&&(i.model&&(La(i.model,!1),i.model.destroy(),i.model=void 0),i.controller.model===i.model&&(i.controller.model=null));this._models.length=0}onBeforeRender(){if(J.active&&(Ws&&(Bo[0]=Date.now()),this.updateRendering(J.active),Ws)){const t=Date.now()-Bo[0];Bo.push(t),Bo.length>=30&&(Bo[0]=0,Bo.reduce((i,s)=>i+s,0)/Bo.length,Bo.length=0)}}updateRendering(t){var i,s,o,r,l;for(let c=0;c<this._models.length;c++){const h=this._models[c];if(!h)continue;const d=h.controller;if(!d.connected){Ws&&console.warn("XRControllerModel.onUpdateXR: controller is not connected anymore",d.side,d.hand);continue}if(h.model&&!h.handmesh)h.model.matrixAutoUpdate=!1,h.model.matrix.copy(d.gripMatrix),h.model.visible=d.isTracking,(i=t.rig)==null||i.gameObject.add(h.model);else if(d.inputSource.hand&&h.handmesh){const u=t.referenceSpace,p=this.context.renderer.xr.getHand(d.index);if(u&&t.frame.getJointPose){for(const g of d.inputSource.hand.values()){const y=p.joints[g.jointName];if(y){const f=d.getHandJointPose(g);if(f){const v=f.transform.position,b=f.transform.orientation;y.position.copy(v),y.quaternion.copy(b),y.matrixAutoUpdate=!1}y.visible=f!=null}}h.model&&(h.model.visible=d.isTracking,h.model.visible&&h.model.parent!==((s=t.rig)==null?void 0:s.gameObject)&&((o=t.rig)==null||o.gameObject.add(h.model))),(r=h.model)!=null&&r.visible&&((l=h.handmesh)==null||l.updateMesh(),h.model.matrixAutoUpdate=!1,h.model.matrix.identity(),h.model.applyMatrix4(Oa))}}}}async loadModel(t,i){var s;if(!t.connected)return console.warn("XRControllerModel.onXRControllerAdded: controller is not connected anymore",t.side),null;const o=await le.getOrCreate("",i).instantiate();return La(o),(s=J.active)!=null&&s.isPassThrough&&o.traverseVisible(r=>{this.makeOccluder(r)}),o}async loadHandModel(t,i){const s=this.context,o=s.renderer.xr.getHand(i.index);o||(Ws?G.DrawLabel(i.rayWorldPosition,"No hand found for index "+i.index,.05,5):console.warn("No hand found for index "+i.index));const r=new ar;gu(r,s),await Wu(r,s,this.sourceId??"");const l=Nu(r);let c="";const h=i.side==="left"?this.customLeftHand:this.customRightHand;h?(c=h.url.split(".").slice(0,-1).join("."),r.setPath("")):(c=i.inputSource.handedness==="left"?"left":"right",r.setPath("https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles/generic-hand/"));const d=new j;La(d);const u=new HC(d,o,r.path,c,r,p=>{var g;const y=l.gltf;((g=y?.scene.children)==null?void 0:g.length)===0&&(y.scene.children[0]=p),fn().createBuiltinComponents(t.context,t.sourceId||c,l.gltf,null,l),p.traverse(f=>{var v;f.layers.set(2),(v=J.active)!=null&&v.isPassThrough&&!h&&this.makeOccluder(f),f instanceof X&&it.assignMeshLOD(f,0)}),i.connected||(Ws&&G.DrawLabel(i.rayWorldPosition,"Hand is loaded but not connected anymore",.05,5),p.removeFromParent())});if(Ws&&d.add(new Si(.5)),i.inputSource.hand){Ws&&console.log(i.inputSource.hand);for(const p of i.inputSource.hand.values())if(o.joints[p.jointName]===void 0){const g=new so;g.matrixAutoUpdate=!1,g.visible=!0,o.joints[p.jointName]=g,o.add(g)}}else Ws&&G.DrawLabel(i.rayWorldPosition,"No inputSource.hand found for index "+i.index,.05,5);return{handObject:d,handmesh:u}}makeOccluder(t){if(t instanceof X){let i=t.material;i instanceof ke&&(i=t.material=i.clone(),i.depthWrite=!0,i.depthTest=!0,i.colorWrite=!1,t.receiveShadow=!1,t.renderOrder=-100)}}}a(os,"factory",new VC),lp([m()],os.prototype,"createControllerModel",2),lp([m()],os.prototype,"createHandModel",2),lp([m(le)],os.prototype,"customLeftHand",2),lp([m(le)],os.prototype,"customRightHand",2);class cp extends A{}var LT=Object.defineProperty,DT=Object.getOwnPropertyDescriptor,Fo=(n,t,i,s)=>{for(var o=s>1?void 0:s?DT(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&LT(t,i,o),o};const p0=C("debugwebxr");class Li extends A{constructor(){super(...arguments),a(this,"movementSpeed",1.5),a(this,"rotationStep",30),a(this,"useTeleport",!0),a(this,"usePinchToTeleport",!0),a(this,"useTeleportTarget",!1),a(this,"useTeleportFade",!1),a(this,"showRays",!0),a(this,"showHits",!0),a(this,"isXRMovementHandler",!0),a(this,"xrSessionMode","immersive-vr"),a(this,"_didApplyRotation",!1),a(this,"_didTeleport",!1),a(this,"_teleportBuffer",new Array),a(this,"_plane",null),a(this,"_lines",[]),a(this,"_hitDiscs",[]),a(this,"_hitDistances",[]),a(this,"_lastHitDistances",[]),a(this,"hitPointRaycastFilter",t=>t.type==="SkinnedMesh"?"continue in children":!0)}onUpdateXR(t){const i=t.xr.rig;if(!(i!=null&&i.gameObject)||t.xr.isPassThrough)return;const s=t.xr.leftController,o=t.xr.rightController;s&&this.onHandleMovement(s,i.gameObject),o&&(this.onHandleRotation(o,i.gameObject),this.useTeleport&&this.onHandleTeleport(o,i.gameObject))}onLeaveXR(t){for(const i of this._lines)i.removeFromParent();for(const i of this._hitDiscs)i?.removeFromParent()}onBeforeRender(){var t;(t=this.context.xr)!=null&&t.running&&(this.showRays&&this.renderRays(this.context.xr),this.showHits&&this.renderHits(this.context.xr))}onHandleMovement(t,i){const s=t.getStick("xr-standard-thumbstick");if(s.x!=0||s.y!=0){const o=q(s.x,0,s.y);o.multiplyScalar(this.context.time.deltaTimeUnscaled*this.movementSpeed);const r=Ye(i);o.multiplyScalar(r.x),o.applyQuaternion(t.xr.poseOrientation),o.y=0,o.applyQuaternion(i.worldQuaternion),i.position.add(o),i.updateWorldMatrix(!1,!1);for(const l of i.children)l.updateWorldMatrix(!1,!1)}}onHandleRotation(t,i){if(t._isMxInk)return;const s=t.getStick("xr-standard-thumbstick").x;if(this._didApplyRotation)Math.abs(s)<.3&&(this._didApplyRotation=!1);else if(Math.abs(s)>.5){this._didApplyRotation=!0;const o=s>0?1:-1,r=te(this.context.mainCamera).clone();i.rotateY(o*W.toRadians(this.rotationStep));const l=te(this.context.mainCamera).clone().sub(r);l.y=0,i.position.sub(l)}}onHandleTeleport(t,i){var s,o,r,l,c;let h=0;if(t.hand&&this.usePinchToTeleport&&t.isTeleportGesture){const d=t.getPointerId("primary");if(d!=null&&this.context.input.getIsPointerIdInUse(d))return;const u=t.getGesture("pinch");u&&(h=u.value)}else h=(s=t.getStick("xr-standard-thumbstick"))==null?void 0:s.y;if(this._didTeleport)h>=0&&h<.4?this._didTeleport=!1:h<0&&h>-.4&&(this._didTeleport=!1);else if(h>.8){this._didTeleport=!0;const d=this.context.physics.raycastFromRay(t.ray)[0];if(d&&d.object instanceof ba){const p=(o=d.normal)==null?void 0:o.dot(q(0,1,0));if(p!==void 0&&p<.4)return}let u=d?.point;if(!u&&!this.useTeleportTarget){this._plane||(this._plane=new or(new x(0,1,0),0));const p=i.worldPosition;this._plane.setFromNormalAndCoplanarPoint(new x(0,1,0),p);const g=t.ray;u=p.clone(),this._plane.intersectLine(new dC(g.origin,q(g.direction).multiplyScalar(1e4).add(g.origin)),u),u.distanceTo(p)>i.scale.x*10&&(u=null)}if(u){if(this.useTeleportTarget&&!O.getComponentInParent(d.object,cp))return;const p=u.clone();if(p0&&G.DrawSphere(u,.025,16711680,5),(r=this.context.mainCamera)==null?void 0:r.position){const g=(l=this.context.xr)==null?void 0:l.getUserOffsetInRig();g&&(g.y=0,p.sub(g),p0&&G.DrawWireSphere(g.add(p),.025,65280,5))}this._teleportBuffer.push(i.matrix.clone()),this._teleportBuffer.length>10&&this._teleportBuffer.shift(),this.useTeleportFade?(c=t.xr.fadeTransition())==null||c.then(()=>{i.worldPosition=p}):i.worldPosition=p}}else if(h<-.8&&(this._didTeleport=!0,this._teleportBuffer.length>0)){const d=this._teleportBuffer.pop();d&&d.decompose(i.position,i.quaternion,i.scale)}}renderRays(t){var i;for(let s=0;s<this._lines.length;s++){const o=this._lines[s];o&&(o.visible=!1)}for(let s=0;s<t.controllers.length;s++){const o=t.controllers[s];let r=this._lines[s];if(!o.connected||!o.isTracking||!o.ray||o.targetRayMode==="transient-pointer"||!o.hasSelectEvent){r&&(r.visible=!1);continue}r||(r=this.createRayLineObject(),r.scale.z=.5,this._lines[s]=r),o.updateRayWorldPosition(),o.updateRayWorldQuaternion();const l=o.rayWorldPosition,c=o.rayWorldQuaternion;r.position.copy(l),r.quaternion.copy(c);const h=t.rigScale,d=this.usePinchToTeleport&&o.isTeleportGesture,u=this._lastHitDistances[s],p=this._hitDistances[s]!=null,g=u??h;r.scale.set(h,h,g),r.visible=!0,r.layers.disableAll(),r.layers.enable(2);let y=r.material.opacity;d?y=1:this.showHits&&g<t.rigScale*.5?y=0:(i=o.getButton("primary"))!=null&&i.pressed?y=.5:y=p?.2:.1,r.material.opacity=W.lerp(r.material.opacity,y,this.context.time.deltaTimeUnscaled/.1),r.parent!==this.context.scene&&this.context.scene.add(r)}}renderHits(t){var i;for(const s of this._hitDiscs){if(!s)continue;const o=s.controller;if(!o||!o.connected||!o.isTracking){s.visible=!1;continue}}for(let s=0;s<t.controllers.length;s++){const o=t.controllers[s];if(!o.connected||!o.isTracking||!o.ray||!o.hasSelectEvent)continue;let r=this._hitDiscs[s],l=!0;const c=o.getPointerId("primary");c!=null&&this.context.input.getIsPointerIdInUse(c)&&(r&&(r.visible=!1),this._hitDistances[s]=null,this._lastHitDistances[s]=0,l=!1);const h=this.context.time.smoothedFps>=59?1:10;if((this.context.time.frame+o.index)%h!==0&&(l=!1),!l){const p=this._hitDiscs[s];p&&p.visible&&p.hit&&this.updateHitPointerPosition(o,p,p.hit.distance);continue}const d=this.context.physics.raycastFromRay(o.ray,{testObject:this.hitPointRaycastFilter,precise:!1});let u=d.find(p=>this.usePinchToTeleport&&o.isTeleportGesture?!0:this.isObjectWithInteractiveComponent(p.object));if(u||(u=d[0]),r&&(r.controller=o,r.hit=u),this._hitDistances[s]=u?.distance||null,u){this._lastHitDistances[s]=u.distance;const p=t.rigScale??1;p0&&(G.DrawWireSphere(u.point,.025*p,16711680),G.DrawLabel(q(0,.2,0).add(u.point),u.object.name,.02,0)),r||(r=this.createHitPointObject(),this._hitDiscs[s]=r),r.hit=u,r.visible=u.distance>p*.05;let g=.01*(p+u.distance);const y=(i=o.getButton("primary"))==null?void 0:i.pressed;y&&(g*=1.1),r.scale.set(g,g,g),r.layers.set(2);let f=r.material.opacity;if(y?f=1:f=u.distance<.15*p?.2:.6,r.material.opacity=W.lerp(r.material.opacity,f,this.context.time.deltaTimeUnscaled/.1),r.visible){if(u.normal){this.updateHitPointerPosition(o,r,u.distance);const v=u.normal.applyQuaternion(Ce(u.object));r.quaternion.setFromUnitVectors(BT,v)}else this.updateHitPointerPosition(o,r,u.distance);r.parent!==this.context.scene&&this.context.scene.add(r)}}else this._hitDiscs[s]&&(this._hitDiscs[s].visible=!1)}}isObjectWithInteractiveComponent(t,i=0){return Su(t)||t.isUI===!0?!0:t.isScene?!1:t.parent?this.isObjectWithInteractiveComponent(t.parent,i+1):!1}updateHitPointerPosition(t,i,s){const o=q(t.rayWorldPosition);o.add(q(0,0,s-.01).applyQuaternion(t.rayWorldQuaternion)),i.position.lerp(o,this.context.time.deltaTimeUnscaled/.05)}createHitPointObject(){const t=new X(new sd(.3,6,6),new Re({color:15658734,opacity:.7,transparent:!0,depthTest:!1,depthWrite:!1,side:Ci}));return t.layers.disableAll(),t.layers.enable(2),t}createRayLineObject(){const t=new $C;t.layers.disableAll(),t.layers.enable(2);const i=new GC;t.geometry=i;const s=new Float32Array(9);s.set([0,0,.02,0,0,.4,0,0,1]),i.setPositions(s);const o=new Float32Array(9);o.set([1,1,1,.1,.1,.1,0,0,0]),i.setColors(o);const r=new qC({color:16777215,vertexColors:!0,worldUnits:!0,linewidth:.004,transparent:!0,depthWrite:!1,blending:Ky,dashed:!1});return t.material=r,t}}Fo([m()],Li.prototype,"movementSpeed",2),Fo([m()],Li.prototype,"rotationStep",2),Fo([m()],Li.prototype,"useTeleport",2),Fo([m()],Li.prototype,"usePinchToTeleport",2),Fo([m()],Li.prototype,"useTeleportTarget",2),Fo([m()],Li.prototype,"useTeleportFade",2),Fo([m()],Li.prototype,"showRays",2),Fo([m()],Li.prototype,"showHits",2);const BT=new x(0,1,0);var FT=Object.defineProperty,zT=Object.getOwnPropertyDescriptor,St=(n,t,i,s)=>{for(var o=s>1?void 0:s?zT(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&FT(t,i,o),o};const uh=C("debugwebxr"),UT=C("debugusdz");var m0;const wl=(m0=class extends A{constructor(){super(...arguments),a(this,"createVRButton",!0),a(this,"createARButton",!0),a(this,"createSendToQuestButton",!0),a(this,"createQRCode",!0),a(this,"useDefaultControls",!0),a(this,"showControllerModels",!0),a(this,"showHandModels",!0),a(this,"usePlacementReticle",!0),a(this,"customARPlacementReticle"),a(this,"usePlacementAdjustment",!0),a(this,"arScale",1),a(this,"useXRAnchor",!1),a(this,"autoPlace",!1),a(this,"autoCenter",!1),a(this,"useQuicklookExport",!1),a(this,"useDepthSensing",!1),a(this,"useSpatialGrab",!0),a(this,"defaultAvatar"),a(this,"_playerSync"),a(this,"_createdComponentsInSession",[]),a(this,"_usdzExporter"),a(this,"_exitXRMenuButton"),a(this,"_previousXRState",0),a(this,"_spatialGrabRaycaster"),a(this,"_activeWebARSessionRoot",null),a(this,"onAvatarSpawned",n=>{uh&&console.log("WebXR.onAvatarSpawned",n),O.getComponentInChildren(n,Do)??(e=O.addComponent(n,Do))}),a(this,"_buttonFactory"),a(this,"_buttons",[])}awake(){J.getXRSync(this.context)}onEnable(){var n,t;window.location.protocol!=="https:"&&we('<a href="https://developer.mozilla.org/en-US/docs/Web/API/WebXR_Device_API" target="_blank">WebXR</a> only works on secure connections (https).'),this.useQuicklookExport&&(O.findObjectOfType($e)||(uh&&console.log("WebXR: Adding USDZExporter"),this._usdzExporter=O.addComponent(this.gameObject,$e),this._usdzExporter.objectToExport=this.context.scene,this._usdzExporter.autoExportAnimations=!0,this._usdzExporter.autoExportAudioSources=!0)),this.handleCreatingHTML(),this.handleOfferSession(),this.defaultAvatar===!0&&(uh&&console.warn("WebXR: No default avatar set, using static default avatar"),this.defaultAvatar=new le("https://cdn.needle.tools/static/avatars/DefaultAvatar.glb")),this.defaultAvatar&&(this._playerSync=this.gameObject.getOrAddComponent(bl),this._playerSync.autoSync=!1),this._playerSync&&typeof this.defaultAvatar!="boolean"&&(this._playerSync.asset=this.defaultAvatar,(n=this._playerSync.onPlayerSpawned)==null||n.removeEventListener(this.onAvatarSpawned),(t=this._playerSync.onPlayerSpawned)==null||t.addEventListener(this.onAvatarSpawned))}onDisable(){var n;(n=this._usdzExporter)==null||n.destroy(),this.removeButtons()}async handleOfferSession(){return this.createVRButton&&await J.isVRSupported()&&this.createVRButton?J.offerSession("immersive-vr","default",this.context):this.createARButton&&await J.isARSupported()&&this.createARButton?J.offerSession("immersive-ar","default",this.context):!1}get session(){return J.active??null}get sessionMode(){return J.activeMode??null}get arSessionRoot(){return this._activeWebARSessionRoot}async enterVR(n){return J.start("immersive-vr",n,this.context)}async enterAR(n){return J.start("immersive-ar",n,this.context)}exitXR(){J.stop()}get isActiveWebXR(){return!wl.activeWebXRComponent||wl.activeWebXRComponent===this}onBeforeXR(n,t){var i;if(!this.isActiveWebXR){console.warn(`WebXR: another WebXR component is already active (${(i=wl.activeWebXRComponent)==null?void 0:i.name}). This is ignored: ${this.name}`);return}wl.activeWebXRComponent=this,n=="immersive-ar"&&this.useDepthSensing&&(t.optionalFeatures=t.optionalFeatures||[],t.optionalFeatures.push("depth-sensing"))}async onEnterXR(n){if(!this.isActiveWebXR)return;uh&&console.log("WebXR onEnterXR"),this._previousXRState=ci.Global.Mask;const t=n.xr.isVR;if(ci.Global.Set(t?Zn.VR:Zn.AR),n.xr.isAR){let i=O.findObjectOfType(ns);if(!i)if(this.usePlacementReticle){const s=new j;for(const o of this.context.scene.children)s.add(o);this.context.scene.add(s),i=O.addComponent(s,ns),this._createdComponentsInSession.push(i)}else(uh||F())&&console.warn("WebXR: No WebARSessionRoot found in scene and usePlacementReticle is disabled in WebXR component.");this._activeWebARSessionRoot=i,i&&(i.customReticle=this.customARPlacementReticle,i.arScale=this.arScale,i.arTouchTransform=this.usePlacementAdjustment,i.autoPlace=this.autoPlace,i.autoCenter=this.autoCenter,i.useXRAnchor=this.useXRAnchor)}this.useDefaultControls&&this.setDefaultMovementEnabled(!0),(this.showControllerModels||this.showHandModels)&&this.setDefaultControllerRenderingEnabled(!0),this.useSpatialGrab&&(this._spatialGrabRaycaster=O.findObjectOfType(Ha)??void 0,this._spatialGrabRaycaster||(this._spatialGrabRaycaster=this.gameObject.addComponent(Ha))),this.createLocalAvatar(n.xr),n.xr.isScreenBasedAR||(this._exitXRMenuButton=this.context.menu.appendChild({label:"Quit XR",onClick:()=>this.exitXR(),icon:"exit_to_app",priority:2e4}))}onUpdateXR(n){this.isActiveWebXR&&this._spatialGrabRaycaster&&(this._spatialGrabRaycaster.enabled=this.useSpatialGrab)}onLeaveXR(n){var t,i;if((t=this._exitXRMenuButton)==null||t.remove(),!!this.isActiveWebXR){ci.Global.Set(this._previousXRState),(i=this._playerSync)==null||i.destroyInstance();for(const s of this._createdComponentsInSession)s.destroy();this._createdComponentsInSession.length=0,this._activeWebARSessionRoot=null,this.handleOfferSession(),Kl(1).then(()=>wl.activeWebXRComponent=null)}}setDefaultMovementEnabled(n){let t=this.gameObject.getComponent(Li);return!t&&n&&(t=this.gameObject.addComponent(Li),this._createdComponentsInSession.push(t)),t&&(t.enabled=n),t}setDefaultControllerRenderingEnabled(n){let t=this.gameObject.getComponent(os);return!t&&n&&(t=this.gameObject.addComponent(os),this._createdComponentsInSession.push(t),t.createControllerModel=this.showControllerModels,t.createHandModel==this.showHandModels),t&&(t.enabled=n),t}async createLocalAvatar(n){this._playerSync&&n.running&&typeof this.defaultAvatar!="boolean"&&(this._playerSync.asset=this.defaultAvatar,await this._playerSync.getInstance())}getButtonsContainer(){return this.getButtonsFactory()}getButtonsFactory(){return this._buttonFactory||(this._buttonFactory=Ur.getOrCreate()),this._buttonFactory}handleCreatingHTML(){if(this.createARButton||this.createVRButton||this.useQuicklookExport){if((Q.isiOS()&&Q.isSafari()||UT)&&this.useQuicklookExport){const n=O.findObjectOfType($e);if(!n||n&&n.allowCreateQuicklookButton){const t=this.getButtonsFactory().createQuicklookButton();this.addButton(t,50)}}if(this.createARButton){const n=this.getButtonsFactory().createARButton();this.addButton(n,50)}if(this.createVRButton){const n=this.getButtonsFactory().createVRButton();this.addButton(n,50)}}if(this.createSendToQuestButton&&!Q.isQuest()&&J.isVRSupported().then(n=>{if(!n){const t=this.getButtonsFactory().createSendToQuestButton();this.addButton(t,50)}}),this.createQRCode){const n=kc(ss);if(n&&n.createQRCodeButton===!1)F()&&console.warn("WebXR: QRCode button is disabled in the Needle Menu component");else if(!Q.isMobileDevice()){const t=ks.getOrCreate().createQRCode();this.addButton(t,50)}}}addButton(n,t){this._buttons.push(n),n.setAttribute("priority",t.toString()),this.context.menu.appendChild(n)}removeButtons(){for(const n of this._buttons)n.remove();this._buttons.length=0}},a(m0,"activeWebXRComponent",null),m0);let Je=wl;St([m()],Je.prototype,"createVRButton",2),St([m()],Je.prototype,"createARButton",2),St([m()],Je.prototype,"createSendToQuestButton",2),St([m()],Je.prototype,"createQRCode",2),St([m()],Je.prototype,"useDefaultControls",2),St([m()],Je.prototype,"showControllerModels",2),St([m()],Je.prototype,"showHandModels",2),St([m()],Je.prototype,"usePlacementReticle",2),St([m(le)],Je.prototype,"customARPlacementReticle",2),St([m()],Je.prototype,"usePlacementAdjustment",2),St([m()],Je.prototype,"arScale",2),St([m()],Je.prototype,"useXRAnchor",2),St([m()],Je.prototype,"autoPlace",2),St([m()],Je.prototype,"autoCenter",2),St([m()],Je.prototype,"useQuicklookExport",2),St([m()],Je.prototype,"useDepthSensing",2),St([m()],Je.prototype,"useSpatialGrab",2),St([m(le)],Je.prototype,"defaultAvatar",2);const hp=C("debugusdzbehaviours");class g0{constructor(){a(this,"behaviours",[]),a(this,"behaviourComponents",[]),a(this,"behaviourComponentsCopy",[]),a(this,"audioClips",[]),a(this,"audioClipsCopy",[]),a(this,"targetUuids",new Set)}get extensionName(){return"Behaviour"}addBehavior(t){this.behaviours.push(t)}addAudioClip(t){if(!t||typeof t!="string")return"";const i="audio/"+ua.getName(t);return this.audioClips.push({clipUrl:t,filesKey:i}),i}getAllTargetUuids(){return this.targetUuids}onBeforeBuildDocument(t){if(!t.root)return Promise.resolve();const i=[];return t.root.traverse(s=>{O.foreachComponent(s,o=>{var r;const l=o;if(typeof l.createBehaviours=="function"||typeof l.beforeCreateDocument=="function"||typeof l.afterCreateDocument=="function"||typeof l.afterSerialize=="function"){this.behaviourComponents.push(l);const c=(r=l.beforeCreateDocument)==null?void 0:r.call(l,this,t);c instanceof Promise&&i.push(c)}},!1)}),hp&&console.log("onBeforeBuildDocument: all components",this.behaviourComponents),Promise.all(i)}onExportObject(t,i,s){var o;for(const r of this.behaviourComponents)(o=r.createBehaviours)==null||o.call(r,this,i,s)}onAfterBuildDocument(t){for(const p of this.behaviourComponents)typeof p.afterCreateDocument=="function"&&p.afterCreateDocument(this,t);this.behaviourComponentsCopy=this.behaviourComponents.slice(),this.behaviourComponents.length=0,this.audioClipsCopy=this.audioClips.slice(),this.audioClips.length=0;const i=new Set,s=new Set,o=new Set,r=new Set,l=hp;let c=`graph LR
`,h="";function d(p){if(p instanceof Eo){l&&(c+=`subgraph Group_${p.id}
`);for(const g of p.actions)l&&(c+=`${p.id}[${p.id}] -- ${p.type},loops:${p.loops} --> ${g.id}[${g.id}]
`),d(g);l&&(c+=`end
`)}else if(p instanceof en){p.tokenId==="StartAnimation"&&r.add(p);let g=p.tokenId;p.type!==void 0&&(g+=":"+p.type);const y=p.affectedObjects;if(y)if(Array.isArray(y))for(const v of y)s.add(v),l&&(h+=`${p.id}[${p.id}
${g}] -- ${g} --> ${v.uuid}(("${v.displayName||v.name||v.uuid}"))
`);else typeof y=="object"?(s.add(y),l&&(h+=`${p.id}[${p.id}
${g}] -- ${g} --> ${y.uuid}(("${y.displayName||y.name||y.uuid}"))
`)):typeof y=="string"&&s.add({uuid:y});const f=p.xFormTarget;f&&(typeof f=="object"?(s.add(f),l&&(h+=`${p.id}[${p.id}
${g}] -- ${g} --> ${f.uuid}(("${f.displayName||f.name||f.uuid}"))
`)):typeof f=="string"&&s.add({uuid:f}))}}function u(p,g){if(Array.isArray(p))for(const y of p)u(y,g);else if(p instanceof Dr){let y=p.tokenId;p.type!==void 0&&(y+=":"+p.type),typeof p.targetId=="object"&&(i.add(p.targetId),l&&(h+=`${p.targetId.uuid}(("${p.targetId.displayName}")) --> ${p.id}[${p.id}
${y}]
`)),l&&(c+=`${p.id}((${p.id})) -- ${y} --> ${g.id}[${g.tokenId||g.id}]
`)}}for(const p of this.behaviours)l&&(c+=`subgraph ${p.id}
`),d(p.action),u(p.trigger,p.action),l&&(c+=`end
`);l&&(c+=`
`+h),l&&(console.log("All USDZ behaviours",this.behaviours),this.behaviours.length&&(console.warn("The Mermaid graph can be pasted into https://massive-mermaid.glitch.me/ or https://mermaid.live/edit. It should be in your clipboard already!"),console.log(c),navigator.clipboard.writeText(c)));{let p=`gantt
title Animations
dateFormat X
axisFormat %s
`;const g=Array.from(r),y=new Set;for(const w of g)if(w.affectedObjects&&typeof w.affectedObjects!="string"){if(Array.isArray(w.affectedObjects))for(const _ of w.affectedObjects)y.add(_);else y.add(w.affectedObjects);l&&(p+=`section ${w.animationName} (${w.id})
`,p+=`${w.id} : ${w.start}, ${w.duration}s
`)}l&&r.size&&console.log(p);const f=new Set;for(const w of y){w.getPath||console.error("USDZExporter: Animation target object has no getPath method. This is likely a bug",w);let _=w.getPath();_.startsWith("<")&&(_=_.substring(1)),_.endsWith(">")&&(_=_.substring(0,_.length-1)),f.add({path:_,obj:w})}const v=Array.from(f).sort((w,_)=>w.path.length-_.path.length),b=new Array;for(let w=0;w<v.length;w++)for(let _=w+1;_<v.length;_++)if(v[_].path.startsWith(v[w].path)){const S=v[_],R=v[w];b.push({child:S.obj.displayName+" ("+S.path+")",parent:R.obj.displayName+" ("+R.path+")"})}b.length&&console.warn("USDZExporter: There are overlapping PlayAnimation actions. This can lead to undefined runtime behaviour when playing multiple animations. Please restructure the hierarchy so that animations don't overlap.",{overlappingTargets:b,playAnimationActions:r})}for(const p of new Set([...i,...s]))if(Array.isArray(p))for(const g of p)o.add(g.uuid);else o.add(p.uuid);hp&&console.log("All Behavior trigger sources and action targets",i,s,o),this.targetUuids=new Set(o)}onAfterHierarchy(t,i){var s;if((s=this.behaviours)!=null&&s.length){i.beginBlock('def Scope "Behaviors"');for(const o of this.behaviours)o.writeTo(this,t.document,i);i.closeBlock()}}async onAfterSerialize(t){hp&&console.log("onAfterSerialize behaviours",this.behaviourComponentsCopy);for(const i of this.behaviourComponentsCopy)typeof i.afterSerialize=="function"&&(i.afterSerialize.constructor.name==="AsyncFunction"?await i.afterSerialize(this,t):i.afterSerialize(this,t));for(const{clipUrl:i,filesKey:s}of this.audioClipsCopy){if(t.files[s])return;const o=await(await(await fetch(i)).blob()).arrayBuffer(),r=new Uint8Array(o);t.files[s]=r}this.behaviourComponentsCopy.length=0,this.audioClipsCopy.length=0}}class f0{get extensionName(){return"Physics"}onExportObject(t,i,s){const o=O.getComponents(t,ye).filter(h=>h.enabled),r=O.getComponents(t,di).filter(h=>h.enabled&&!h.isTrigger);let l=o.length>0?o[0]:null;const c=r.length>0?r[0]:null;c&&!l&&(l=new ye,l.isKinematic=!0),l&&i.addEventListener("serialize",(h,d)=>{var u,p,g;if(l){if(h.appendLine(),h.beginBlock('def RealityKitComponent "RigidBody"',"{",!0),l.useGravity||h.appendLine("bool gravityEnabled = 0"),h.appendLine('uniform token info:id = "RealityKit.RigidBody"'),l.isKinematic&&h.appendLine('token motionType = "Kinematic"'),h.beginBlock('def RealityKitStruct "massFrame"',"{",!0),h.appendLine(`float m_mass = ${l.mass}`),h.beginBlock('def RealityKitStruct "m_pose"',"{",!0),h.appendLine(`float3 position = (${l.centerOfMass.x}, ${l.centerOfMass.y}, ${l.centerOfMass.z})`),h.closeBlock("}"),h.closeBlock("}"),r.length>0){const y=r[0];h.beginBlock('def RealityKitStruct "material"',"{",!0);const f=y.sharedMaterial;f&&f.dynamicFriction!==void 0&&h.appendLine(`double dynamicFriction = ${(u=y.sharedMaterial)==null?void 0:u.dynamicFriction}`),f&&f.bounciness!==void 0&&h.appendLine(`double restitution = ${(p=y.sharedMaterial)==null?void 0:p.bounciness}`),f&&f.staticFriction!==void 0&&h.appendLine(`double staticFriction = ${(g=y.sharedMaterial)==null?void 0:g.staticFriction}`),h.closeBlock("}")}h.closeBlock("}")}}),c&&(i.addEventListener("serialize",(h,d)=>{var u;h.beginBlock('def RealityKitComponent "Collider"',"{",!0),h.appendLine("uint group = 1"),h.appendLine('uniform token info:id = "RealityKit.Collider"'),h.appendLine("uint mask = 4294967295");const p=c.isTrigger?"Trigger":"Default";if(h.appendLine(`token type = "${p}"`),h.beginBlock('def RealityKitStruct "Shape"',"{",!0),c instanceof Qa){const g=c;h.appendLine('token shapeType = "Sphere"'),h.appendLine(`float radius = ${g.radius}`)}else if(c instanceof Ya){const g=c;h.appendLine('token shapeType = "Box"'),h.appendLine(`float3 extent = (${g.size.x}, ${g.size.y}, ${g.size.z})`)}else if(c instanceof Is){const g=c;h.appendLine('token shapeType = "Capsule"'),h.appendLine(`float radius = ${g.radius}`),h.appendLine(`float height = ${g.height}`)}else if(c instanceof Ro&&(u=c.sharedMesh)!=null&&u.geometry){const g=c.sharedMesh.geometry;g.boundingBox||g.computeBoundingBox();const y=c.sharedMesh.geometry.boundingBox;y&&(h.appendLine('token shapeType = "Box"'),h.appendLine(`float3 extent = (${y.max.x-y.min.x}, ${y.max.y-y.min.y}, ${y.max.z-y.min.z})`),console.log("[USDZ] Only Box, Sphere, and Capsule colliders are supported in visionOS/iOS. MeshCollider will be exported as Box",c))}else console.warn("[USDZ] Only Box, Sphere, and Capsule colliders are supported in visionOS/iOS. Ignoring collider:",c);h.beginBlock('def RealityKitStruct "pose"',"{",!0),h.closeBlock("}"),h.closeBlock("}"),h.closeBlock("}")}),r.length>1&&console.log("WARNING: Multiple colliders detected. visionOS / iOS can only support objects with a single collider, only exporting the first collider: ",c))}}var NT=Object.defineProperty,WT=Object.getOwnPropertyDescriptor,ph=(n,t,i,s)=>{for(var o=s>1?void 0:s?WT(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&NT(t,i,o),o};const y0=C("debugui"),v0=C("debuguilayout");class $x{constructor(){a(this,"width"),a(this,"height")}}class Gx{constructor(){a(this,"x"),a(this,"y"),a(this,"width"),a(this,"height")}}const En=new x,mh=new se,dp=new V,qx=class extends rn{constructor(){super(...arguments),a(this,"_anchoredPosition"),a(this,"sizeDelta",new re(100,100)),a(this,"pivot",new re(.5,.5)),a(this,"anchorMin",new re(0,0)),a(this,"anchorMax",new re(1,1)),a(this,"minWidth"),a(this,"minHeight"),a(this,"lastMatrix"),a(this,"rectBlock"),a(this,"_transformNeedsUpdate",!1),a(this,"_initialPosition"),a(this,"_parentRectTransform"),a(this,"_lastUpdateFrame",-1),a(this,"_lastAnchoring"),a(this,"_createdBlocks",[]),a(this,"_createdTextBlocks",[])}get parent(){return this._parentRectTransform}get translation(){return this.gameObject.position}get rotation(){return this.gameObject.quaternion}get scale(){return this.gameObject.scale}get anchoredPosition(){return this._anchoredPosition||(this._anchoredPosition=new re),this._anchoredPosition}set anchoredPosition(n){this._anchoredPosition=n}get width(){let n=this.sizeDelta.x;if(this.anchorMin.x!==this.anchorMax.x&&this._parentRectTransform){const t=this._parentRectTransform.width,i=this.anchorMax.x-this.anchorMin.x;n=t*i,n+=this.sizeDelta.x}return this.minWidth!==void 0&&n<this.minWidth?this.minWidth:n}get height(){let n=this.sizeDelta.y;if(this.anchorMin.y!==this.anchorMax.y&&this._parentRectTransform){const t=this._parentRectTransform.height,i=this.anchorMax.y-this.anchorMin.y;n=t*i,n+=this.sizeDelta.y}return this.minHeight!==void 0&&n<this.minHeight?this.minHeight:n}awake(){super.awake(),this._anchoredPosition||(this._anchoredPosition=new re),this.lastMatrix=new se,this.rectBlock=new j,this.rectBlock.name=this.name,this._initialPosition=this.gameObject.position.clone(),this._initialPosition.z=0,$a(this,"_anchoredPosition",()=>{this.markDirty()}),$a(this,"sizeDelta",()=>{this.markDirty()}),$a(this,"pivot",()=>{this.markDirty()}),$a(this,"anchorMin",()=>{this.markDirty()}),$a(this,"anchorMax",()=>{this.markDirty()})}onEnable(){var n;super.onEnable(),this.rectBlock||(this.rectBlock=new j),this.lastMatrix||(this.lastMatrix=new se),this._lastAnchoring||(this._lastAnchoring=new re),this._initialPosition||(this._initialPosition=new x),this._anchoredPosition||(this._anchoredPosition=new re),this.addShadowComponent(this.rectBlock),this._transformNeedsUpdate=!0,(n=this.canvas)==null||n.registerTransform(this)}onDisable(){var n;super.onDisable(),this.removeShadowComponent(),(n=this.canvas)==null||n.unregisterTransform(this)}onParentRectTransformChanged(n){this._transformNeedsUpdate||this.onApplyTransform(v0?`${n.name} changed`:void 0)}get isDirty(){return this._transformNeedsUpdate||(this._transformNeedsUpdate=!this.lastMatrix.equals(this.gameObject.matrix)),this._transformNeedsUpdate}markDirty(){this._transformNeedsUpdate||(v0&&console.warn("RectTransform markDirty()",this.name),this._transformNeedsUpdate=!0,this._lastUpdateFrame=-1)}updateTransform(){(this._transformNeedsUpdate||!this.lastMatrix.equals(this.gameObject.matrix))&&this.canUpdate()&&this.onApplyTransform(this._transformNeedsUpdate?"Marked dirty":"Matrix changed")}canUpdate(){return this._transformNeedsUpdate&&this.activeAndEnabled&&this._lastUpdateFrame!==this.context.time.frame}onApplyTransform(n){var t;if(this.context.time.frameCount===this._lastUpdateFrame)return;this._lastUpdateFrame=this.context.time.frameCount;const i=this.shadowComponent;if(!i)return;this.gameObject.parent?this._parentRectTransform=O.getComponentInParent(this.gameObject.parent,qx):this._parentRectTransform=void 0,this._transformNeedsUpdate=!1,v0&&console.warn("RectTransform \u2192 ApplyTransform",this.name+" because "+n),this.isRoot()?this.Root.screenspace||(i.rotation.y=Math.PI):(i.matrix.identity(),i.matrixAutoUpdate=!1,En.set(0,0,0),this.applyPivot(En),i.matrix.setPosition(En.x,En.y,0),(this.gameObject.quaternion.x||this.gameObject.quaternion.y||this.gameObject.quaternion.z)&&(dp.copy(this.gameObject.quaternion),dp.x*=-1,dp.z*=-1,mh.makeRotationFromQuaternion(dp),i.matrix.premultiply(mh)),En.set(0,0,0),this.applyAnchoring(En),(t=this.canvas)!=null&&t.screenspace?En.z+=.1:En.z+=.01,mh.identity(),mh.setPosition(En.x,En.y,En.z),i.matrix.premultiply(mh),i.matrix.scale(this.gameObject.scale)),this.lastMatrix.copy(this.gameObject.matrix);const s=!0;for(const o of Kd(this.gameObject,rn,s,1)){if(o===this||!o.activeAndEnabled)continue;const r=o;r.onParentRectTransformChanged&&r.onParentRectTransformChanged(this)}}applyAnchoring(n){this._lastAnchoring||(this._lastAnchoring=new re);const t=this._lastAnchoring.sub(this._anchoredPosition);this.gameObject.position.x+=t.x,this.gameObject.position.y+=t.y,this._lastAnchoring.copy(this._anchoredPosition),n.x+=this._initialPosition.x-this.gameObject.position.x,n.y+=this._initialPosition.y-this.gameObject.position.y,n.z+=this._initialPosition.z-this.gameObject.position.z;const i=this._parentRectTransform;if(i){let s=0;const o=1-this.anchorMax.y-this.anchorMin.y;s-=i.height*.5*o,n.y+=s;let r=0;const l=1-this.anchorMax.x-this.anchorMin.x;r-=i.width*.5*l,n.x+=r}}applyPivot(n){if(this.pivot&&!this.isRoot()){const t=this.pivot.x-.5;n.x-=t*this.sizeDelta.x*this.gameObject.scale.x;const i=this.pivot.y-.5;n.y-=i*this.sizeDelta.y*this.gameObject.scale.y}}getBasicOptions(){const n={width:this.sizeDelta.x,height:this.sizeDelta.y,offset:0,backgroundOpacity:0,borderWidth:0,borderRadius:0,borderOpacity:0,letterSpacing:-.03};return this.ensureValidSize(n),n}ensureValidSize(n,t=1e-4){return n.width<=0&&(n.width=t),n.height<=0&&(n.height=1e-4),n}createNewBlock(n){n={...this.getBasicOptions(),...n},y0&&console.log(this.name,n);const t=new pv(n);return this._createdBlocks.push(t),t}createNewText(n){y0&&console.log(n),n={...this.getBasicOptions(),...n},y0&&console.log(this.name,n);const t=new uv(n);return this._createdTextBlocks.push(t),t}};let Vt=qx;ph([m(re)],Vt.prototype,"anchoredPosition",1),ph([m(re)],Vt.prototype,"sizeDelta",2),ph([m(re)],Vt.prototype,"pivot",2),ph([m(re)],Vt.prototype,"anchorMin",2),ph([m(re)],Vt.prototype,"anchorMax",2);var VT=Object.defineProperty,HT=Object.getOwnPropertyDescriptor,Xx=(n,t,i,s)=>{for(var o=s>1?void 0:s?HT(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&VT(t,i,o),o};class xl extends A{constructor(){super(...arguments),a(this,"effectColor"),a(this,"effectDistance")}}Xx([m(xe)],xl.prototype,"effectColor",2),Xx([m(re)],xl.prototype,"effectDistance",2);var $T=Object.defineProperty,GT=Object.getOwnPropertyDescriptor,Qx=(n,t,i,s)=>{for(var o=s>1?void 0:s?GT(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&$T(t,i,o),o};const up={backgroundColor:new ae(1,1,1),backgroundOpacity:1,borderColor:new ae(1,1,1),borderOpacity:1};var b0;const gh=(b0=class extends rn{constructor(){super(...arguments),a(this,"_alphaFactor",1),a(this,"sRGBColor",new ae(1,0,1)),a(this,"raycastTarget",!0),a(this,"uiObject",null),a(this,"_color",null),a(this,"_rect",null),a(this,"_stateManager",null),a(this,"_currentlyCreatingPanel",!1)}get isGraphic(){return!0}get color(){return this._color||(this._color=new xe(1,1,1,1)),this._color}set color(n){(!this._color||this._color.r!==n.r||this._color.g!==n.g||this._color.b!==n.b||this._color.alpha!==n.alpha)&&(this._color||(this._color=new xe(1,1,1,1)),this._color.copy(n),this.onColorChanged())}setAlphaFactor(n){this._alphaFactor=n,this.onColorChanged()}get alphaFactor(){return this._alphaFactor}onColorChanged(){this.uiObject&&(this.sRGBColor.copy(this._color),this.sRGBColor.convertLinearToSRGB(),up.backgroundColor=this.sRGBColor,up.backgroundOpacity=this._color.alpha*this._alphaFactor,this.applyEffects(up,this._alphaFactor),this.uiObject.set(up),this.markDirty())}get m_Color(){return this._color}get rectTransform(){if(this._rect||(this._rect=O.getComponent(this.gameObject,Vt)),!this._rect)throw new Error("Not Supported: Make sure to add a RectTransform component before adding a UI Graphic component.");return this._rect}onParentRectTransformChanged(){var n;(n=this.uiObject)==null||n.set({width:this.rectTransform.width,height:this.rectTransform.height}),this.markDirty()}__internalNewInstanceCreated(n){return super.__internalNewInstanceCreated(n),this._rect=null,this.uiObject=null,this._color&&(this._color=this._color.clone()),this}setState(n){this.makePanel(),this.uiObject&&(this.uiObject.setState(n),this==null||this.markDirty())}setupState(n){this.makePanel(),this.uiObject&&(this._stateManager||(this._stateManager=new pO(this.uiObject)),this.uiObject.setupState(n.state,n.attributes))}setOptions(n){this.makePanel(),this.uiObject&&this.uiObject.set(n)}awake(){super.awake(),this.makePanel(),$a(this,"_color",()=>bM(this,this.onColorChanged))}onEnable(){var n;super.onEnable(),this.uiObject&&((n=this.rectTransform.shadowComponent)==null||n.add(this.uiObject),this.addShadowComponent(this.uiObject,this.rectTransform))}onDisable(){super.onDisable(),this.uiObject&&this.removeShadowComponent()}makePanel(){if(this.uiObject||this._currentlyCreatingPanel)return;this._currentlyCreatingPanel=!0;const n=.015,t={backgroundColor:this.color,backgroundOpacity:this.color.alpha,offset:n};this.onBeforeCreate(t),this.applyEffects(t),this.onCreate(t),this.controlsChildLayout=!1,this._currentlyCreatingPanel=!1,this.onAfterCreated(),this.onColorChanged()}onBeforeCreate(n){}onCreate(n){this.uiObject=this.rectTransform.createNewBlock(n),this.uiObject.name=this.name}onAfterCreated(){}applyEffects(n,t=1){var i;const s=(i=this.gameObject)==null?void 0:i.getComponent(xl);s&&(s.effectDistance&&(n.borderWidth=Math.max(Math.abs(s.effectDistance.x),Math.abs(s.effectDistance.y))),s.effectColor&&(n.borderColor=s.effectColor,n.borderOpacity=s.effectColor.alpha*t))}async setTexture(n){if(this.setOptions({backgroundOpacity:0}),n){if(gh.textureCache.has(n))n=gh.textureCache.get(n);else if(!n.isRenderTargetTexture){const t=n.clone();t.colorSpace=rr,gh.textureCache.set(n,t),n=t}this.setOptions({backgroundImage:n,borderRadius:0,backgroundOpacity:this.color.alpha,backgroundSize:"stretch"}),it.assignTextureLOD(n,0).then(t=>{t instanceof Le&&(n&&gh.textureCache.set(n,t),this.setOptions({backgroundImage:t}),this.markDirty())})}else this.setOptions({backgroundImage:void 0,borderRadius:0,backgroundOpacity:this.color.alpha});this.markDirty()}onAfterAddedToScene(){super.onAfterAddedToScene(),this.shadowComponent&&(this.shadowComponent.offset=this.shadowComponent.position.z)}},a(b0,"textureCache",new Map),b0);let Nr=gh;Qx([m(xe)],Nr.prototype,"color",1),Qx([m()],Nr.prototype,"raycastTarget",2);class fh extends Nr{constructor(){super(...arguments),a(this,"_flippedObject",!1)}onAfterCreated(){this.uiObject&&!this._flippedObject&&(this._flippedObject=!0,this.uiObject.scale.y*=-1)}}var qT=Object.defineProperty,XT=Object.getOwnPropertyDescriptor,Vs=(n,t,i,s)=>{for(var o=s>1?void 0:s?XT(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&qT(t,i,o),o};const Wr=C("debugtext");var mt=(n=>(n[n.UpperLeft=0]="UpperLeft",n[n.UpperCenter=1]="UpperCenter",n[n.UpperRight=2]="UpperRight",n[n.MiddleLeft=3]="MiddleLeft",n[n.MiddleCenter=4]="MiddleCenter",n[n.MiddleRight=5]="MiddleRight",n[n.LowerLeft=6]="LowerLeft",n[n.LowerCenter=7]="LowerCenter",n[n.LowerRight=8]="LowerRight",n))(mt||{}),Yx=(n=>(n[n.Normal=0]="Normal",n[n.Bold=1]="Bold",n[n.Italic=2]="Italic",n[n.BoldAndItalic=3]="BoldAndItalic",n))(Yx||{});class Ht extends Nr{constructor(){super(...arguments),a(this,"alignment",0),a(this,"verticalOverflow",0),a(this,"horizontalOverflow",0),a(this,"lineSpacing",1),a(this,"supportRichText",!1),a(this,"font"),a(this,"fontStyle",0),a(this,"sRGBTextColor",new ae(1,0,1)),a(this,"_text",""),a(this,"_fontSize",12),a(this,"_textMeshUi",null),a(this,"_didHandleTextRenderOnTop",!1)}setAlphaFactor(t){var i;super.setAlphaFactor(t),(i=this.uiObject)==null||i.set({fontOpacity:this.color.alpha*this.alphaFactor}),this.markDirty()}get text(){return this._text}set text(t){t!==this._text&&(this._text=t,this.feedText(this.text,this.supportRichText),this.markDirty())}set_text(t){this.text=t}get fontSize(){return this._fontSize}set fontSize(t){var i;this._fontSize=t,(i=this.uiObject)==null||i.set({fontSize:t})}onColorChanged(){var t;this.sRGBTextColor.copy(this.color),this.sRGBTextColor.convertLinearToSRGB(),(t=this.uiObject)==null||t.set({color:this.sRGBTextColor,fontOpacity:this.color.alpha})}onParentRectTransformChanged(){super.onParentRectTransformChanged(),this.uiObject&&this.updateOverflow()}onBeforeCanvasRender(t){this.updateOverflow()}updateOverflow(){var t;const i=(t=this.uiObject)==null?void 0:t._overflow;i&&(i._needsUpdate=!0)}onCreate(t){Wr&&console.log(this),this.horizontalOverflow==1&&(t.whiteSpace="pre"),this.verticalOverflow==0&&(this.context.renderer.localClippingEnabled=!0,t.overflow="hidden"),this.horizontalOverflow==1&&this.verticalOverflow==0,t.lineHeight=this.lineSpacing,delete t.backgroundOpacity,delete t.backgroundColor,Wr&&(t.backgroundColor=16750848,t.backgroundOpacity=.5);const i=this.rectTransform;t={...t,...this.getTextOpts()},this.getAlignment(t),Wr&&(t.backgroundColor=Math.random()*16777215,t.backgroundOpacity=.1),this.uiObject=i.createNewText(t),this.feedText(this.text,this.supportRichText)}onAfterAddedToScene(){super.onAfterAddedToScene(),this.handleTextRenderOnTop()}getTextOpts(){const t=this.fontSize,i={color:this.color,fontOpacity:this.color.alpha,fontSize:t,fontKerning:"normal"};return this.setFont(i,this.fontStyle),i}onEnable(){var t;super.onEnable(),this._didHandleTextRenderOnTop=!1,this.uiObject&&this.uiObject.addAfterUpdate(()=>{this.setShadowComponentOwner(this.uiObject),this.markDirty()}),setTimeout(()=>this.markDirty(),10),(t=this.canvas)==null||t.registerEventReceiver(this)}onDisable(){var t;super.onDisable(),(t=this.canvas)==null||t.unregisterEventReceiver(this)}getAlignment(t){switch(t.flexDirection="column",this.alignment){case 0:case 3:case 6:t.textAlign="left";break;case 1:case 4:case 7:t.textAlign="center";break;case 2:case 5:case 8:t.textAlign="right";break}switch(this.alignment){default:case 0:case 1:case 2:t.alignItems="start";break;case 3:case 4:case 5:t.alignItems="center";break;case 6:case 7:case 8:t.alignItems="end";break}return t}feedText(t,i){var s,o,r;if(Wr&&console.log("feedText",this.uiObject,t,i),!!this.uiObject)if(this._textMeshUi||(this._textMeshUi=[]),this.uiObject.children.length=0,!i||t.length===0)this.uiObject.textContent=t;else{let l=this.getNextTag(t);if(l){if(l.startIndex>0){for(let d=this.uiObject.children.length-1;d>=0;d--){const u=this.uiObject.children[d];u.isUI&&(this.uiObject.remove(u),u.clear())}const h=new _m({textContent:t.substring(0,l.startIndex),color:"inherit"});this.uiObject.add(h)}}else{this.uiObject.textContent="",this.setOptions({textContent:t});return}const c=[];for(;l;){const h=this.getNextTag(t,l.endIndex),d={fontFamily:(s=this.uiObject)==null?void 0:s.get("fontFamily"),color:"inherit",textContent:""};if(h){d.textContent=this.getText(t,l,h),this.handleTag(l,d,c);const u=new _m(d);(o=this.uiObject)==null||o.add(u)}else{d.textContent=t.substring(l.endIndex),this.handleTag(l,d,c);const u=new _m(d);(r=this.uiObject)==null||r.add(u)}l=h}}}handleTextRenderOnTop(){this._didHandleTextRenderOnTop||(this._didHandleTextRenderOnTop=!0,this.startCoroutine(this.renderOnTopCoroutine()))}*renderOnTopCoroutine(){if(!this.canvas)return;const t=[],i=this.canvas,s={renderOnTop:i.renderOnTop,depthWrite:i.depthWrite,doubleSided:i.doubleSided};for(;;){let o=!1;if(this._textMeshUi)for(let r=0;r<this._textMeshUi.length;r++){if(t[r]===!0)continue;o=!0;const l=this._textMeshUi[r];l.textContent&&(Mu(l,s),t[r]=!0)}if(!o)break;yield}}handleTag(t,i,s){if(!t.isEndTag){if(t.type.includes("color")){const o=new _0(t,{color:i.color});if(s.push(o),t.type.length>6){const r=parseInt("0x"+t.type.substring(7));i.color=r}else i.color=new ae(1,1,1)}else if(t.type=="b"){this.setFont(i,1);const o=new _0(t,{fontWeight:700});s.push(o)}else if(t.type=="i"){this.setFont(i,2);const o=new _0(t,{fontStyle:"italic"});s.push(o)}}}getText(t,i,s){return t.substring(i.endIndex,s.startIndex)}getNextTag(t,i=0){const s=t.indexOf("<",i),o=t.indexOf(">",s);if(s>=0&&o>=0){const r=t.substring(s+1,o);return{type:r,startIndex:s,endIndex:o+1,isEndTag:r.startsWith("/")}}return null}setFont(t,i){if(!this.font)return;const s=this.font,o=this.getFamilyNameWithCorrectSuffix(s,i);Wr&&console.log("Selected font family:"+o);let r=mv.getFontFamily(o);switch(r||(r=mv.addFontFamily(o)),t.fontFamily=r,i){default:case 0:t.fontWeight=400,t.fontStyle="normal";break;case 1:t.fontWeight=700,t.fontStyle="normal";break;case 2:t.fontWeight=400,t.fontStyle="italic";break;case 3:t.fontStyle="italic",t.fontWeight=400}let l=r.getVariant(t.fontWeight,t.fontStyle);if(!l){let c=o;c!=null&&c.endsWith("-msdf.json")||(c+="-msdf.json");let h=o;h!=null&&h.endsWith(".png")||(h+=".png"),l=r.addVariant(t.fontWeight,t.fontStyle,c,h),l?.addEventListener("ready",()=>{this.markDirty()})}}getFamilyNameWithCorrectSuffix(t,i){var s;const o=t.lastIndexOf("-");if(o<0)return t;const r=(s=t.substring(o+1))==null?void 0:s.toLowerCase();if(QT.includes(r))return Wr&&console.warn("Unsupported font style: "+r),t;const l=t.lastIndexOf("/");let c=t;l>=0&&(c=c.substring(l+1));const h=c[0]===c[0].toUpperCase(),d=t.substring(0,o);switch(Wr&&console.log("Select font: ",t,Yx[i],c,h,d),i){case 0:return h?d+"-Regular":d+"-regular";case 1:return h?d+"-Bold":d+"-bold";case 2:return h?d+"-Italic":d+"-italic";case 3:return h?d+"-BoldItalic":d+"-bolditalic";default:return t}}}Vs([m()],Ht.prototype,"alignment",2),Vs([m()],Ht.prototype,"verticalOverflow",2),Vs([m()],Ht.prototype,"horizontalOverflow",2),Vs([m()],Ht.prototype,"lineSpacing",2),Vs([m()],Ht.prototype,"supportRichText",2),Vs([m(URL)],Ht.prototype,"font",2),Vs([m()],Ht.prototype,"fontStyle",2),Vs([m()],Ht.prototype,"text",1),Vs([m()],Ht.prototype,"fontSize",1);class _0{constructor(t,i){a(this,"tag"),a(this,"previousValues"),this.tag=t,this.previousValues=i}}const QT=["medium","mediumitalic","black","blackitalic","thin","thinitalic","extrabold","light","lightitalic","semibold"];class Vr{constructor(t){a(this,"id"),a(this,"content",""),a(this,"font",[]),a(this,"pointSize",144),a(this,"width"),a(this,"height"),a(this,"depth"),a(this,"wrapMode"),a(this,"horizontalAlignment"),a(this,"verticalAlignment"),a(this,"material"),this.id=t}static getId(){return this.global_id++}setDepth(t){return this.depth=t,this}setPointSize(t){return this.pointSize=t,this}setHorizontalAlignment(t){return this.horizontalAlignment=t,this}setVerticalAlignment(t){return this.verticalAlignment=t,this}writeTo(t,i){var s;i.beginBlock(`def Preliminary_Text "${this.id}"`,"(",!1),i.appendLine('prepend apiSchemas = ["MaterialBindingAPI"]'),i.closeBlock(")"),i.beginBlock(),this.content&&i.appendLine(`string content = "${this.content}"`),(!this.font||this.font.length<=0)&&(this.font||(this.font=[]),(s=this.font)==null||s.push("sans-serif"));const o=this.font.map(r=>`"${r}"`).join(", ");i.appendLine(`string[] font = [ ${o} ]`),i.appendLine(`double pointSize = ${this.pointSize}`),typeof this.width=="number"&&i.appendLine(`double width = ${this.width}`),typeof this.height=="number"&&i.appendLine(`double height = ${this.height}`),typeof this.depth=="number"&&i.appendLine(`double depth = ${this.depth}`),this.wrapMode&&i.appendLine(`token wrapMode = "${this.wrapMode}"`),this.horizontalAlignment&&i.appendLine(`token horizontalAlignment = "${this.horizontalAlignment}"`),this.verticalAlignment&&i.appendLine(`token verticalAlignment = "${this.verticalAlignment}"`),this.material!==void 0&&i.appendLine(`rel material:binding = </StageRoot/Materials/${Yf(this.material)}>`),i.closeBlock()}}a(Vr,"global_id",0);class w0{static singleLine(t,i,s){const o=new Vr("text_"+Vr.getId());return o.content=t,i&&(o.pointSize=i),s&&(o.depth=s),o}static multiLine(t,i,s,o,r,l){const c=new Vr("text_"+Vr.getId());return c.content=t,c.width=i,c.height=s,c.horizontalAlignment=o,c.verticalAlignment=r,l!==void 0&&(c.wrapMode=l),c}}const YT=new se().makeRotationY(Math.PI),ZT=new se().makeScale(-1,1,-1);class pp{get extensionName(){return"text"}exportText(t,i,s){const o=O.getComponent(t,Ht);if(!o)return;const r=O.getComponent(t,Vt);let l=100,c=100;r&&(l=r.width,c=r.height);const h=YT.clone();r&&h.premultiply(ZT),i.setMatrix(h);const d=o.color.clone();i.material=new Ft({color:d,emissive:d}),i.addEventListener("serialize",(u,p)=>{let g=o.text;g=g.replace(/\r/g,""),g=g.replace(/\n/g,"\\n");const y=w0.multiLine(g,l,c,"center","bottom","flowing");this.setTextAlignment(y,o.alignment),this.setOverflow(y,o),i.material&&(y.material=i.material),y.pointSize=this.convertToTextSize(o.fontSize),y.depth=.001,y.writeTo(void 0,u)})}convertToTextSize(t){return 1/.0502*144*t}setOverflow(t,i){i.horizontalOverflow?t.wrapMode="singleLine":t.wrapMode="flowing"}setTextAlignment(t,i){switch(i){case mt.LowerLeft:case mt.MiddleLeft:case mt.UpperLeft:t.horizontalAlignment="left";break;case mt.LowerCenter:case mt.MiddleCenter:case mt.UpperCenter:t.horizontalAlignment="center";break;case mt.LowerRight:case mt.MiddleRight:case mt.UpperRight:t.horizontalAlignment="right";break}switch(i){case mt.LowerLeft:case mt.LowerCenter:case mt.LowerRight:t.verticalAlignment="bottom";break;case mt.MiddleLeft:case mt.MiddleCenter:case mt.MiddleRight:t.verticalAlignment="middle";break;case mt.UpperLeft:case mt.UpperCenter:case mt.UpperRight:t.verticalAlignment="top";break}}}var KT=Object.defineProperty,JT=Object.getOwnPropertyDescriptor,lt=(n,t,i,s)=>{for(var o=s>1?void 0:s?JT(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&KT(t,i,o),o};const Zx=C("debuguilayout");class Hr{constructor(){a(this,"left",0),a(this,"right",0),a(this,"top",0),a(this,"bottom",0)}get vertical(){return this.top+this.bottom}get horizontal(){return this.left+this.right}}lt([m()],Hr.prototype,"left",2),lt([m()],Hr.prototype,"right",2),lt([m()],Hr.prototype,"top",2),lt([m()],Hr.prototype,"bottom",2);class Di extends A{constructor(){super(...arguments),a(this,"_rectTransform",null),a(this,"_needsUpdate",!1),a(this,"childAlignment",0),a(this,"reverseArrangement",!1),a(this,"spacing",0),a(this,"padding"),a(this,"minWidth",0),a(this,"minHeight",0),a(this,"flexibleHeight",0),a(this,"flexibleWidth",0),a(this,"preferredHeight",0),a(this,"preferredWidth",0)}get rectTransform(){return this._rectTransform}onParentRectTransformChanged(t){this._needsUpdate=!0}get isDirty(){return this._needsUpdate}get isLayoutGroup(){return!0}updateLayout(){this._rectTransform&&(Zx&&console.warn("Layout Update",this.context.time.frame,this.name),this._needsUpdate=!1,this.onCalculateLayout(this._rectTransform))}start(){this._needsUpdate=!0}onEnable(){Zx&&console.log(this.name,this),this._rectTransform=this.gameObject.getComponent(Vt);const t=this.gameObject.getComponentInParent(At);t&&t.registerLayoutGroup(this),this._needsUpdate=!0}onDisable(){const t=this.gameObject.getComponentInParent(At);t&&t.unregisterLayoutGroup(this)}set m_Spacing(t){t!==this.spacing&&(this._needsUpdate=!0,this.spacing=t)}get m_Spacing(){return this.spacing}}lt([m()],Di.prototype,"childAlignment",2),lt([m()],Di.prototype,"reverseArrangement",2),lt([m()],Di.prototype,"spacing",2),lt([m(Hr)],Di.prototype,"padding",2),lt([m()],Di.prototype,"minWidth",2),lt([m()],Di.prototype,"minHeight",2),lt([m()],Di.prototype,"flexibleHeight",2),lt([m()],Di.prototype,"flexibleWidth",2),lt([m()],Di.prototype,"preferredHeight",2),lt([m()],Di.prototype,"preferredWidth",2);class zo extends Di{constructor(){super(...arguments),a(this,"childControlHeight",!0),a(this,"childControlWidth",!0),a(this,"childForceExpandHeight",!1),a(this,"childForceExpandWidth",!1),a(this,"childScaleHeight",!1),a(this,"childScaleWidth",!1)}onCalculateLayout(t){var i;const s=this.primaryAxis,o=t.width;let r=o;const l=t.height;let c=l;r-=this.padding.horizontal,c-=this.padding.vertical,s==="x"?this.padding.horizontal:this.padding.vertical;const h=s==="x",d=h?"y":"x",u=h?this.childControlWidth:this.childControlHeight,p=h?this.childControlHeight:this.childControlWidth,g=h?this.childForceExpandWidth:this.childForceExpandHeight,y=h?this.childForceExpandHeight:this.childForceExpandWidth,f=h?c:r,v=h?o:l,b=.5*(h?this.childAlignment%3:Math.floor(this.childAlignment/3));let w=0;h?w+=this.padding.left:w+=this.padding.top;let _=0,S=0;for(let D=0;D<this.gameObject.children.length;D++){const U=this.gameObject.children[D],B=O.getComponent(U,Vt);B!=null&&B.activeAndEnabled&&(S+=1,h?_+=B.width:_+=B.height)}let R=0;const M=this.spacing*(S-1);if(g||u){let D=0;h?D=r-=M:D=c-=M,S>0&&(R=D/S)}let T=0;T+=this.padding.left,T-=this.padding.right,b!==0&&(w=v-_,w*=b,w-=M*b,h?(w-=this.padding.right*b,w+=this.padding.left*(1-b),w<this.padding.left&&(w=this.padding.left)):(w-=this.padding.bottom*b,w+=this.padding.top*(1-b),w<this.padding.top&&(w=this.padding.top)));let L=1;for(let D=0;D<this.gameObject.children.length;D++){const U=this.gameObject.children[D],B=O.getComponent(U,Vt);if(B!=null&&B.activeAndEnabled){(i=B.pivot)==null||i.set(.5,.5),B.anchorMin.set(0,1),B.anchorMax.set(0,1);const Y=o*.5+T*.5;B.anchoredPosition.x!==Y&&(B.anchoredPosition.x=Y);const $=l*-.5;B.anchoredPosition.y!==$&&(B.anchoredPosition.y=$),y&&p&&B.sizeDelta[d]!==f&&(B.sizeDelta[d]=f),g&&u&&B.sizeDelta[s]!==R&&(B.sizeDelta[s]=R);const E=h?B.width:B.height,z=E*.5;if(w+=z,g){const ie=R*L-R*.5;ie>w&&(w=ie-R*.5+E+this.padding.left,w-=z)}let H=w;s==="y"&&(H=-H),B.anchoredPosition[s]!==H&&(B.anchoredPosition[s]=H),w+=z,w+=this.spacing,L+=1}}}}lt([m()],zo.prototype,"childControlHeight",2),lt([m()],zo.prototype,"childControlWidth",2),lt([m()],zo.prototype,"childForceExpandHeight",2),lt([m()],zo.prototype,"childForceExpandWidth",2),lt([m()],zo.prototype,"childScaleHeight",2),lt([m()],zo.prototype,"childScaleWidth",2);class x0 extends zo{get primaryAxis(){return"y"}}class S0 extends zo{get primaryAxis(){return"x"}}class C0 extends Di{onCalculateLayout(){}}var eE=Object.defineProperty,tE=Object.getOwnPropertyDescriptor,rs=(n,t,i,s)=>{for(var o=s>1?void 0:s?tE(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&eE(t,i,o),o},Kx=(n=>(n[n.ScreenSpaceOverlay=0]="ScreenSpaceOverlay",n[n.ScreenSpaceCamera=1]="ScreenSpaceCamera",n[n.WorldSpace=2]="WorldSpace",n[n.Undefined=-1]="Undefined",n))(Kx||{});const O0=C("debuguilayout"),Jx=class extends Nc{constructor(){super(...arguments),a(this,"_renderOnTop"),a(this,"_depthWrite",!1),a(this,"_doubleSided",!0),a(this,"_castShadows",!1),a(this,"_receiveShadows",!1),a(this,"_renderMode",-1),a(this,"_rootCanvas"),a(this,"_scaleFactor",1),a(this,"worldCamera"),a(this,"planeDistance",-1),a(this,"_boundRenderSettingsChanged",this.onRenderSettingsChanged.bind(this)),a(this,"previousParent",null),a(this,"_lastMatrixWorld",null),a(this,"_rectTransforms",[]),a(this,"_layoutGroups",new Map),a(this,"_receivers",[]),a(this,"onBeforeRenderRoutine",()=>{var n,t,i,s;if(this.previousParent=this.gameObject.parent,((n=this.context.xr)!=null&&n.isVR||(t=this.context.xr)!=null&&t.isPassThrough)&&this.screenspace){this.gameObject.visible=!1,this.gameObject.removeFromParent();return}this.renderOnTop||this.screenspace?this.gameObject.removeFromParent():(this.onUpdateRenderMode(),this.handleLayoutUpdates(),(i=this.shadowComponent)==null||i.updateMatrixWorld(!0),(s=this.shadowComponent)==null||s.updateWorldMatrix(!0,!0),this.invokeBeforeRenderEvents(),si.ensureUpdateMeshUI(gv,this.context))}),a(this,"onAfterRenderRoutine",()=>{var n,t,i,s,o;if(((n=this.context.xr)!=null&&n.isVR||(t=this.context.xr)!=null&&t.isPassThrough)&&this.screenspace){(i=this.previousParent)==null||i.add(this.gameObject);return}if((this.screenspace||this.renderOnTop)&&this.previousParent&&this.context.mainCamera){if(this.screenspace){const c=this.context.mainCamera;c?.add(this.gameObject)}else this.previousParent.add(this.gameObject);const r=this.context.renderer.autoClear,l=this.context.renderer.autoClearColor;this.context.renderer.autoClear=!1,this.context.renderer.autoClearColor=!1,this.context.renderer.clearDepth(),this.onUpdateRenderMode(!0),this.handleLayoutUpdates(),(s=this.shadowComponent)==null||s.updateMatrixWorld(!0),this.invokeBeforeRenderEvents(),si.ensureUpdateMeshUI(gv,this.context,!0),this.context.renderer.render(this.gameObject,this.context.mainCamera),this.context.renderer.autoClear=r,this.context.renderer.autoClearColor=l,this.previousParent.add(this.gameObject)}(o=this._lastMatrixWorld)==null||o.copy(this.gameObject.matrixWorld)}),a(this,"_updateRenderSettingsRoutine"),a(this,"_activeRenderMode",-1),a(this,"_lastWidth",-1),a(this,"_lastHeight",-1)}get isCanvas(){return!0}get screenspace(){return this.renderMode!==2}set renderOnTop(n){n!==this._renderOnTop&&(this._renderOnTop=n,this.onRenderSettingsChanged())}get renderOnTop(){return this._renderOnTop!==void 0?this._renderOnTop:!!(this.screenspace&&this._renderMode===0)}set depthWrite(n){this._depthWrite!==n&&(this._depthWrite=n,this.onRenderSettingsChanged())}get depthWrite(){return this._depthWrite}set doubleSided(n){this._doubleSided!==n&&(this._doubleSided=n,this.onRenderSettingsChanged())}get doubleSided(){return this._doubleSided}set castShadows(n){this._castShadows!==n&&(this._castShadows=n,this.onRenderSettingsChanged())}get castShadows(){return this._castShadows}set receiveShadows(n){this._receiveShadows!==n&&(this._receiveShadows=n,this.onRenderSettingsChanged())}get receiveShadows(){return this._receiveShadows}get renderMode(){return this._renderMode}set renderMode(n){this._renderMode!==n&&(this._renderMode=n,this.onRenderSettingsChanged())}set rootCanvas(n){this._rootCanvas instanceof Jx||(this._rootCanvas=n)}get rootCanvas(){return this._rootCanvas}get scaleFactor(){return this._scaleFactor}set scaleFactor(n){this._scaleFactor=n}awake(){var n;this.shadowComponent=this.gameObject,this.previousParent=this.gameObject.parent,O0&&console.log("Canvas.Awake()",((n=this.previousParent)==null?void 0:n.name)+"/"+this.gameObject.name),super.awake()}start(){this.applyRenderSettings()}onEnable(){super.onEnable(),this._updateRenderSettingsRoutine=void 0,this._lastMatrixWorld=new se,this.applyRenderSettings(),document.addEventListener("resize",this._boundRenderSettingsChanged),this.context.pre_render_callbacks.push(this.onBeforeRenderRoutine),this.context.post_render_callbacks.push(this.onAfterRenderRoutine)}onDisable(){super.onDisable(),document.removeEventListener("resize",this._boundRenderSettingsChanged);const n=this.context.pre_render_callbacks.indexOf(this.onBeforeRenderRoutine);n!==-1&&this.context.pre_render_callbacks.splice(n,1);const t=this.context.post_render_callbacks.indexOf(this.onAfterRenderRoutine);t!==-1&&this.context.post_render_callbacks.splice(t,1)}registerTransform(n){this._rectTransforms.push(n)}unregisterTransform(n){const t=this._rectTransforms.indexOf(n);t!==-1&&this._rectTransforms.splice(t,1)}registerLayoutGroup(n){const t=n.gameObject;this._layoutGroups.set(t,n)}unregisterLayoutGroup(n){const t=n.gameObject;this._layoutGroups.delete(t)}registerEventReceiver(n){this._receivers.push(n)}unregisterEventReceiver(n){const t=this._receivers.indexOf(n);t!==-1&&this._receivers.splice(t,1)}async onEnterXR(n){this.screenspace?(n.xr.isVR||n.xr.isPassThrough)&&(this.gameObject.visible=!1):(this.gameObject.visible=!1,await Kl(1).then(()=>{this.gameObject.visible=!0}))}onLeaveXR(n){this.screenspace&&(n.xr.isVR||n.xr.isPassThrough)&&(this.gameObject.visible=!0)}invokeBeforeRenderEvents(){var n;for(const t of this._receivers)(n=t.onBeforeCanvasRender)==null||n.call(t,this)}handleLayoutUpdates(){this._lastMatrixWorld===null&&(this._lastMatrixWorld=new se);const n=!this._lastMatrixWorld.equals(this.gameObject.matrixWorld);O0&&n&&console.log("Canvas Layout changed",this.context.time.frameCount,this.name);const t=!1;for(const i of this._rectTransforms){n&&i.markDirty();let s=this._layoutGroups.get(i.gameObject);i.isDirty&&!s&&(s=i.gameObject.getComponentInParent(Di)),(i.isDirty||s!=null&&s.isDirty)&&(O0&&!t&&console.log("CANVAS UPDATE ### "+i.name+" ##################################### "+this.context.time.frame),s?.updateLayout(),i.updateTransform())}}applyRenderSettings(){this.onRenderSettingsChanged()}onRenderSettingsChanged(){this._updateRenderSettingsRoutine||(this._updateRenderSettingsRoutine=this.startCoroutine(this._updateRenderSettingsDelayed(),Me.OnBeforeRender))}*_updateRenderSettingsDelayed(){if(yield,this._updateRenderSettingsRoutine=void 0,this.shadowComponent){this.onUpdateRenderMode(),Mu(this.shadowComponent,this);for(const n of O.getComponentsInChildren(this.gameObject,rn))Mu(n.shadowComponent,this)}}onUpdateRenderMode(n=!1){if(!n&&this._renderMode===this._activeRenderMode&&this._lastWidth===this.context.domWidth&&this._lastHeight===this.context.domHeight)return;this._activeRenderMode=this._renderMode;let t=this.context.mainCameraComponent,i=10;switch(t&&t.nearClipPlane>0&&t.farClipPlane>0&&(i=W.lerp(t.nearClipPlane,t.farClipPlane,.01)),this._renderMode===1&&(this.worldCamera&&(t=this.worldCamera),this.planeDistance>0&&(i=this.planeDistance)),this._renderMode){case 0:case 1:if(this._lastWidth=this.context.domWidth,this._lastHeight=this.context.domHeight,!t)return;const s=i+.01;this.gameObject.position.x=0,this.gameObject.position.y=0,this.gameObject.position.z=-s,this.gameObject.quaternion.identity();const o=this.gameObject.getComponent(Vt);let r=!1;o.sizeDelta.x!==this.context.domWidth&&(r=!0),o.sizeDelta.y!==this.context.domHeight&&(r=!0);const l=t.fieldOfView*Math.PI/180,c=2*Math.tan(l/2)*Math.abs(s);this.gameObject.scale.x=c/this.context.domHeight,this.gameObject.scale.y=c/this.context.domHeight,this.gameObject.scale.z=.01,r&&(o.sizeDelta.x=this.context.domWidth,o.sizeDelta.y=this.context.domHeight,o?.markDirty());break;case 2:this._lastWidth=-1,this._lastHeight=-1;break}}};let At=Jx;rs([m()],At.prototype,"renderOnTop",1),rs([m()],At.prototype,"depthWrite",1),rs([m()],At.prototype,"doubleSided",1),rs([m()],At.prototype,"castShadows",1),rs([m()],At.prototype,"receiveShadows",1),rs([m()],At.prototype,"renderMode",1),rs([m(At)],At.prototype,"rootCanvas",1),rs([m()],At.prototype,"scaleFactor",1),rs([m(Oe)],At.prototype,"worldCamera",2),rs([m()],At.prototype,"planeDistance",2);var iE=Object.defineProperty,nE=Object.getOwnPropertyDescriptor,P0=(n,t,i,s)=>{for(var o=s>1?void 0:s?nE(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&iE(t,i,o),o};class Uo extends A{constructor(){super(...arguments),a(this,"_alpha",1),a(this,"interactable",!0),a(this,"blocksRaycasts",!0),a(this,"_isDirty",!1),a(this,"_buffer",[])}get alpha(){return this._alpha}set alpha(t){t!==this._alpha&&(this._alpha=t,this.markDirty())}get isCanvasGroup(){return!0}markDirty(){this._isDirty||(this._isDirty=!0,this.startCoroutine(this.applyChangesDelayed(),Me.OnBeforeRender))}*applyChangesDelayed(){this._isDirty=!1,this.applyChangesNow()}applyChangesNow(){this._buffer.length=0;for(const t of O.getComponentsInChildren(this.gameObject,rn,this._buffer)){const i=t;i.setAlphaFactor&&i.setAlphaFactor(this._alpha)}}}P0([m()],Uo.prototype,"alpha",1),P0([m()],Uo.prototype,"interactable",2),P0([m()],Uo.prototype,"blocksRaycasts",2);class k0{get extensionName(){return"tmui"}onExportObject(t,i,s){const o=O.getComponent(t,At);if(o&&o.enabled&&o.renderMode===Kx.WorldSpace){const r=new pp,l=O.getComponent(t,Vt),c=O.getComponent(t,Uo),h=new Array;if(l){if(!O.isActiveSelf(t)){const p=O.isActiveSelf(t);O.setActive(t,!0),l.onEnable(),l.updateTransform(),h.push(()=>{l.onDisable(),O.setActive(t,p)})}t.traverse(p=>{if(!O.isActiveInHierarchy(p)){const g=O.isActiveSelf(p);O.setActive(p,!0);const y=O.getComponent(p,rn);y&&(y.onEnable(),h.push(()=>{y.onDisable()}));const f=O.getComponent(p,Vt);f&&(f.onEnable(),f.updateTransform(),f.onApplyTransform(),h.push(()=>{f.onDisable()}));const v=O.getComponent(p,Ht);v&&(v.onEnable(),h.push(()=>{v.onDisable()})),h.push(()=>{O.setActive(p,g)})}}),l.width,l.height;const d=Zt.createEmpty(),u=l.shadowComponent;if(i.add(d),u){const p=u.matrix;d.setMatrix(p);const g=new Map,y=new Map;g.set(u,d),y.set(u,c?c.alpha:1),u.traverse(f=>{if(f===u)return;const v=Zt.createEmpty();v.setMatrix(f.matrix);const b=f.parent,w=!!b&&typeof b.textContent=="string"&&b.textContent.length>0;let _=y.get(b)||1;const S=O.getComponent(f,Uo);if(S&&(_*=S.alpha),f instanceof X&&w){const M=f[Zi];M?r.exportText(M.gameObject,v,s):console.error("Error when exporting UI: shadow component owner not found. This is likely a bug.",f)}if(f instanceof X&&!w){const M=f.geometry.clone();M.scale(1,1,-1),this.flipWindingOrder(M),v.geometry=M;const T=new ae,L=f.material.opacity;T.copy(f.material.color),v.material=new Re({color:T,opacity:L*_,map:f.material.map,transparent:!0})}g.set(f,v),y.set(f,_);const R=g.get(b);if(!R){console.error("Error when exporting UI: shadow component parent not found!",f,f.parent);return}R.add(v)})}}for(const d of h)d()}}flipWindingOrder(t){const i=t.index.array;for(let s=0,o=i.length/3;s<o;s++){const r=i[s*3];i[s*3]=i[s*3+2],i[s*3+2]=r}t.index.needsUpdate=!0}}const yh=C("debugusdz");function sE(n,t){var i;const s=[],o=O.getComponentsInChildren(n,kt),r=O.getComponentsInChildren(n,Ut),l=new Array,c=new Array;if(t.injectImplicitBehaviours)for(const h of o){if(!h||!h.runtimeAnimatorController||!h.enabled)continue;const d=h.runtimeAnimatorController.activeState;if(!d||!d.motion||!d.motion.clip||((i=d.motion.clip.tracks)==null?void 0:i.length)<1||l.includes(h))continue;const u=new zr;u.animator=h,u.stateName=d.name,u.trigger="start",u.name="PlayAnimationOnClick_implicitAtStart_"+u.stateName;const p=new j;O.addComponent(p,u),c.push(p),l.push(h),n.add(p)}else for(const h of o){if(!h||!h.runtimeAnimatorController||!h.enabled)continue;yh&&console.log(h);const d=[];for(const u of h.runtimeAnimatorController.enumerateActions()){yh&&console.log(u);const p=u.getClip();d.includes(p)||d.push(p)}s.push({root:h.gameObject,clips:d})}if(t.injectImplicitBehaviours)for(const h of r){if(!h||!h.clip||!h.enabled||!h.playAutomatically||l.includes(h))continue;const d=new zr;d.animation=h,d.stateName=h.clip.name,d.trigger="start",d.name="PlayAnimationOnClick_implicitAtStart_"+d.stateName;const u=new j;O.addComponent(u,d),c.push(u),l.push(h),n.add(u)}else for(const h of r){yh&&console.log(h);const d=[];for(const u of h.animations)d.includes(u)||d.push(u);s.push({root:h.gameObject,clips:d})}yh&&s?.length>0&&console.log("USDZ Animation Clips without behaviours",s);for(const h of s)for(const d of h.clips)t.registerAnimation(h.root,d);return c}function oE(n,t){const i=O.getComponentsInChildren(n,Ne),s=O.getComponentsInChildren(n,Io),o=new Array,r=new Array;yh&&console.log({audioSources:i,playAudioOnClicks:s});for(const l of s){if(!l.target)continue;const c=i.indexOf(l.target);c>-1&&i.splice(c,1)}for(const l of i){if(!l||!l.clip||l.volume<=0||o.includes(l))continue;const c=new Io;c.target=l,c.name="PlayAudioOnClick_implicitAtStart_",c.trigger="start";const h=new j;O.addComponent(h,c),console.log("implicit PlayAudioOnStart",h,c),r.push(h),o.push(l),n.add(h)}return r}function rE(n){return new Wt("DisableAtStart",Tt.sceneStartTrigger(),ve.fadeAction(n,0,!1))}function e1(n,t){const i=n.domElement.shadowRoot.querySelector("link[rel='ar']");if(i)return i;const s=document.createElement("div");s.classList.add("menu"),s.classList.add("quicklook-menu"),s.style.display="none",s.style.visibility="hidden";const o=document.createElement("button");o.id="open-in-ar",t?(o.innerText="View in AR",o.title="View this scene in AR. The scene will be exported to USDZ and opened with Apple's QuickLook."):(o.innerText="View in AR",o.title="Download this scene for AR. Open the downloaded USDZ file to view it in AR using Apple's QuickLook."),s.appendChild(o);const r=document.createElement("a");r.id="needle-usdz-link",r.style.display="none",r.rel="ar",r.href="",r.target="_blank",s.appendChild(r);const l=document.createElement("img");return l.id="button",r.appendChild(l),n.domElement.shadowRoot.appendChild(s),r}var aE=Object.defineProperty,lE=Object.getOwnPropertyDescriptor,It=(n,t,i,s)=>{for(var o=s>1?void 0:s?lE(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&aE(t,i,o),o};const Bi=C("debugusdz"),cE=C("debugusdzpruning");class $r{constructor(){a(this,"callToAction"),a(this,"checkoutTitle"),a(this,"checkoutSubtitle"),a(this,"callToActionURL")}}It([m()],$r.prototype,"callToAction",2),It([m()],$r.prototype,"checkoutTitle",2),It([m()],$r.prototype,"checkoutSubtitle",2),It([m()],$r.prototype,"callToActionURL",2);var mp;const M0=(mp=class extends A{constructor(){super(...arguments),a(this,"objectToExport"),a(this,"autoExportAnimations",!0),a(this,"autoExportAudioSources",!0),a(this,"exportFileName"),a(this,"customUsdzFile"),a(this,"customBranding"),a(this,"anchoringType","plane"),a(this,"maxTextureSize",2048),a(this,"planeAnchoringAlignment","horizontal"),a(this,"interactive",!0),a(this,"physics",!0),a(this,"allowCreateQuicklookButton",!0),a(this,"quickLookCompatible",!0),a(this,"extensions",[]),a(this,"link"),a(this,"button"),a(this,"onClickedOpenInARElement",n=>{n.preventDefault(),this.exportAndOpen()}),a(this,"_currentExportTasks",new Map),a(this,"_previousTimeScale",1),a(this,"lastCallback"),a(this,"_rootSessionRootWasAppliedTo",null),a(this,"_rootPositionBeforeExport",new x),a(this,"_rootRotationBeforeExport",new V),a(this,"_rootScaleBeforeExport",new x)}start(){var n,t,i;Bi&&(console.log("USDZExporter",this),console.log("Debug USDZ Mode. Press 'T' to export"),window.addEventListener("keydown",s=>{switch(s.key){case"t":this.exportAndOpen();break}})),this.objectToExport||(this.objectToExport=this.gameObject),!((t=(n=this.objectToExport)==null?void 0:n.children)!=null&&t.length)&&!((i=this.objectToExport)!=null&&i.isMesh)&&(this.objectToExport=this.context.scene)}onEnable(){var n;const t=Q.supportsQuickLookAR(),i=Q.isiOS()||Q.isiPad();!this.button&&(Bi||t||i)&&(this.allowCreateQuicklookButton&&(this.button=this.createQuicklookButton()),this.lastCallback=this.quicklookCallback.bind(this),this.link=e1(this.context,t),this.link.addEventListener("message",this.lastCallback)),Bi&&De("USDZ Exporter enabled: "+this.name),(n=document.getElementById("open-in-ar"))==null||n.addEventListener("click",this.onClickedOpenInARElement),mc.registerExporter(this)}onDisable(){var n,t,i;(n=this.button)==null||n.remove(),(t=this.link)==null||t.removeEventListener("message",this.lastCallback),Bi&&De("USDZ Exporter disabled: "+this.name),(i=document.getElementById("open-in-ar"))==null||i.removeEventListener("click",this.onClickedOpenInARElement),mc.unregisterExporter(this)}async exportAsync(){return this.exportAndOpen()}async exportAndOpen(){var n;let t=this.exportFileName??((n=this.objectToExport)==null?void 0:n.name)??this.name;if(t+="-"+mx(),yo()||(t!==""&&(t+="-"),t+="MadeWithNeedle"),this.link||(this.link=e1(this.context,Q.supportsQuickLookAR())),this.customUsdzFile)return Bi&&console.log("Exporting custom usdz",this.customUsdzFile),this.openInQuickLook(this.customUsdzFile,t),null;if(!this.objectToExport)return console.warn("No object to export",this),null;const i=await this.export(this.objectToExport);return i?(Bi&&console.log("USDZ generation done. Downloading as "+t),this.openInQuickLook(i,t),i):(console.error("USDZ generation failed. Please report a bug",this),null)}async export(n){if(!n)return console.warn("No object to export"),null;const t=this._currentExportTasks.get(n);if(t)return t;const i=this.internalExport(n);return i instanceof Promise?(this._currentExportTasks.set(n,i),i.then(s=>(this._currentExportTasks.delete(n),s)).catch(s=>(this._currentExportTasks.delete(n),console.error("Error during USDZ export \u2013 please report a bug!",s),null))):i}async internalExport(n){ce.start("export-usdz",{onProgress:S=>{this.dispatchEvent(new CustomEvent("export-progress",{detail:{progress:S}}))}}),ce.report("export-usdz",{message:"Starting export",totalSteps:40,currentStep:0}),ce.report("export-usdz",{message:"Load progressive textures",autoStep:5}),ce.start("export-usdz-textures","export-usdz");const t=O.getComponentsInChildren(n,mi);for(const S of t)S&&S.enabled&&S.updateSprite(!0);const i=O.getComponentsInChildren(n,Ze),s=new Array;let o=0;for(const S of i){for(const R of S.sharedMeshes)if(R){const M=it.assignMeshLOD(R,0);M instanceof Promise&&s.push(new Promise((T,L)=>{M.then(()=>{o++,ce.report("export-usdz-textures",{message:"Loaded progressive mesh",currentStep:o,totalSteps:s.length}),T()}).catch(D=>L(D))}))}for(const R of S.sharedMaterials)if(R){const M=it.assignTextureLOD(R,0);M instanceof Promise&&s.push(new Promise((T,L)=>{M.then(()=>{o++,ce.report("export-usdz-textures",{message:"Loaded progressive texture",currentStep:o,totalSteps:s.length}),T()}).catch(D=>L(D))}))}}Bi&&De("Progressive Loading: "+s.length),await Promise.all(s),Bi&&De("Progressive Loading: done"),ce.end("export-usdz-textures");const r=ci.Global.Mask;ci.Global.Set(Zn.AR);const l=new bx,c=new np(this.quickLookCompatible);let h;const d=[];this.interactive&&(d.push(new g0),d.push(new ua),globalThis.true&&O.getComponentsInChildren(n,ye).length>0&&(this.physics?(h=new f0,d.push(h)):F()&&console.warn("USDZExporter: Physics export is disabled, but there are active Rigidbody components in the scene. They will not be exported.")),d.push(new pp),d.push(new k0));const u=[c,...d,...this.extensions],p={self:this,exporter:l,extensions:u,object:n};ce.report("export-usdz","Invoking before-export"),this.dispatchEvent(new CustomEvent("before-export",{detail:p})),this.applyWebARSessionRoot(),this._previousTimeScale=this.context.time.timeScale,this.context.time.timeScale=0,ce.report("export-usdz","auto export animations and audio sources");const g=new Array;this.autoExportAnimations&&g.push(...sE(n,c)),u.find(S=>S.extensionName==="Audio")&&this.autoExportAudioSources&&g.push(...oE(n)),l.debug=Bi,l.pruneUnusedNodes=!cE;const y=sl.instance.objs.map(S=>S.batchedMesh);l.keepObject=S=>{let R=!0;const M=O.getComponent(S,Ze);return M&&!M.enabled&&(R=!1),R&&y.includes(S)&&(R=!1),R&&O.getComponentInParent(S,kn)&&(R=!1),R&&O.getComponentInParent(S,$n)&&(R=!1),Bi&&!R&&console.log("USDZExporter: Discarding object",S),R},l.beforeWritingDocument=()=>{if(F()&&c&&h){const S=c.animatedRoots;for(const R of S){const M=O.getComponentsInChildren(R,ye).filter(L=>L.enabled),T=O.getComponents(R,di).filter(L=>L.enabled&&!L.isTrigger);(M.length>0||T.length>0)&&console.error("An animated object has physics components in its child hierarchy. This can lead to undefined behaviour due to a bug in Apple's QuickLook (FB15925487). Remove the physics components from child objects or verify that you get the expected results.",R)}}};const f=new Array;this.objectToExport&&this.quickLookCompatible&&this.interactive&&this.objectToExport.traverse(S=>{S.visible||f.push(S)});const v=u.find(S=>S.extensionName==="Behaviour");this.interactive&&v&&f.length>0&&v.addBehavior(rE(f));let b=!0;this.quickLookCompatible&&!this.interactive&&(b=!1),this.anchoringType!=="plane"&&this.anchoringType!=="none"&&this.anchoringType!=="image"&&this.anchoringType!=="face"&&(this.anchoringType="plane"),this.planeAnchoringAlignment!=="horizontal"&&this.planeAnchoringAlignment!=="vertical"&&this.planeAnchoringAlignment!=="any"&&(this.planeAnchoringAlignment="horizontal"),ce.report("export-usdz","Invoking exporter.parse");const w=await l.parse(this.objectToExport,{ar:{anchoring:{type:this.anchoringType},planeAnchoring:{alignment:this.planeAnchoringAlignment}},extensions:u,quickLookCompatible:this.quickLookCompatible,maxTextureSize:this.maxTextureSize,exportInvisible:b}),_=new Blob([w],{type:"model/vnd.usdz+zip"});this.revertWebARSessionRoot(),this.context.time.timeScale=this._previousTimeScale,ce.report("export-usdz","Invoking after-export"),this.dispatchEvent(new CustomEvent("after-export",{detail:p}));for(const S of g)O.destroy(S);return ci.Global.Set(r),ce.end("export-usdz"),_}openInQuickLook(n,t){const i=n instanceof Blob?URL.createObjectURL(n):n,s=this.buildQuicklookOverlay();Bi&&console.log("QuickLook Overlay",s);const o=s.callToAction?encodeURIComponent(s.callToAction):"",r=s.checkoutTitle?encodeURIComponent(s.checkoutTitle):"",l=s.checkoutSubtitle?encodeURIComponent(s.checkoutSubtitle):"";this.link.href=i+`#callToAction=${o}&checkoutTitle=${r}&checkoutSubtitle=${l}&callToActionURL=${s.callToActionURL}`,this.lastCallback||(this.lastCallback=this.quicklookCallback.bind(this),this.link.addEventListener("message",this.lastCallback)),this.link.download=t+".usdz",this.link.click()}download(n,t){M0.save(n,t)}static save(n,t){const i=document.createElement("a");i.style.display="none",document.body.appendChild(i),typeof n=="string"?i.href=n:i.href=URL.createObjectURL(n),i.download=t,i.click(),i.remove()}quicklookCallback(n){if(n?.data=="_apple_ar_quicklook_button_tapped"){Bi&&we("Quicklook closed via call to action button");var t=new CustomEvent("quicklook-button-tapped",{detail:this});if(this.dispatchEvent(t),!t.defaultPrevented){const i=new URLSearchParams(this.link.href);if(i){const s=i.get("callToActionURL");Bi&&De("Quicklook url: "+s),s&&(yo()?globalThis.open(s,"_blank"):console.warn("Quicklook closed: custom redirects require a Needle Engine Pro license: https://needle.tools/pricing",s))}}}}buildQuicklookOverlay(){var n,t,i,s,o,r;const l={};return this.customBranding&&Object.assign(l,this.customBranding),yo()||(console.log("Custom Quicklook banner text requires pro license: https://needle.tools/pricing"),l.callToAction="Close",l.checkoutTitle="\u{1F335} Made with Needle",l.checkoutSubtitle="_"),(((n=l.callToAction)==null?void 0:n.length)||((t=l.checkoutTitle)==null?void 0:t.length)||((i=l.checkoutSubtitle)==null?void 0:i.length))&&((s=l.callToAction)!=null&&s.length||(l.callToAction="\0"),(o=l.checkoutTitle)!=null&&o.length||(l.checkoutTitle="\0"),(r=l.checkoutSubtitle)!=null&&r.length||(l.checkoutSubtitle="\0")),this.dispatchEvent(new CustomEvent("quicklook-overlay",{detail:l})),l}getARScaleAndTarget(){if(!this.objectToExport)return{scale:1,_invertForward:!1,target:this.gameObject,sessionRoot:null};const n=O.findObjectOfType(Je);let t=O.getComponentInParent(this.objectToExport,ns);t||(t=O.getComponentInChildren(this.objectToExport,ns));let i=1,s=!1;const o=this.objectToExport;return n?i=n.arScale:t&&(i=t.arScale,s=t.invertForward),{scale:1/i,_invertForward:s,target:o,sessionRoot:t?.gameObject??null}}applyWebARSessionRoot(){if(!this.objectToExport)return;const{scale:n,_invertForward:t,target:i,sessionRoot:s}=this.getARScaleAndTarget(),o=s?.matrixWorld.clone().invert();this._rootSessionRootWasAppliedTo=i,this._rootPositionBeforeExport.copy(i.position),this._rootRotationBeforeExport.copy(i.quaternion),this._rootScaleBeforeExport.copy(i.scale),i.scale.multiplyScalar(n),t&&i.quaternion.multiply(M0.invertForwardQuaternion),i.updateMatrix(),i.updateMatrixWorld(!0),s&&o&&i.matrix.premultiply(o)}revertWebARSessionRoot(){if(!this.objectToExport||!this._rootSessionRootWasAppliedTo)return;const n=this._rootSessionRootWasAppliedTo;n.position.copy(this._rootPositionBeforeExport),n.quaternion.copy(this._rootRotationBeforeExport),n.scale.copy(this._rootScaleBeforeExport),n.updateMatrix(),n.updateMatrixWorld(!0),this._rootSessionRootWasAppliedTo=null}createQuicklookButton(){const n=Ur.getOrCreate().createQuicklookButton();return n.parentNode||this.context.menu.appendChild(n),n}},a(mp,"invertForwardMatrix",new se().makeRotationY(Math.PI)),a(mp,"invertForwardQuaternion",new V().setFromEuler(new Bt(0,Math.PI,0))),mp);let $e=M0;It([m(j)],$e.prototype,"objectToExport",2),It([m()],$e.prototype,"autoExportAnimations",2),It([m()],$e.prototype,"autoExportAudioSources",2),It([m()],$e.prototype,"exportFileName",2),It([m(URL)],$e.prototype,"customUsdzFile",2),It([m($r)],$e.prototype,"customBranding",2),It([m()],$e.prototype,"anchoringType",2),It([m()],$e.prototype,"maxTextureSize",2),It([m()],$e.prototype,"planeAnchoringAlignment",2),It([m()],$e.prototype,"interactive",2),It([m()],$e.prototype,"physics",2),It([m()],$e.prototype,"allowCreateQuicklookButton",2),It([m()],$e.prototype,"quickLookCompatible",2);var hE=Object.defineProperty,dE=Object.getOwnPropertyDescriptor,R0=(n,t,i,s)=>{for(var o=s>1?void 0:s?dE(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&hE(t,i,o),o};class Sl extends A{constructor(){super(...arguments),a(this,"_fog")}get fog(){return this._fog||(this._fog=new Wy(0,0,50)),this._fog}get mode(){return 1}set near(t){this.fog.near=t}get near(){return this.fog.near}set far(t){this.fog.far=t}get far(){return this.fog.far}set color(t){this.fog.color.copy(t)}get color(){return this.fog.color}onEnable(){this.scene.fog=this.fog}onDisable(){this.scene.fog===this._fog&&(this.scene.fog=null)}}R0([m()],Sl.prototype,"near",1),R0([m()],Sl.prototype,"far",1),R0([m(ae)],Sl.prototype,"color",1);var uE=Object.defineProperty,pE=Object.getOwnPropertyDescriptor,T0=(n,t,i,s)=>{for(var o=s>1?void 0:s?pE(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&uE(t,i,o),o};class Gr extends A{constructor(){super(...arguments),a(this,"objectBounds",!1),a(this,"color"),a(this,"isGizmo",!0),a(this,"_gizmoObject",null),a(this,"_boxHelper",null)}onEnable(){this.isGizmo&&!xc||(this._gizmoObject||(this.objectBounds?this._gizmoObject=new uC(this.gameObject,this.color??16776960):(this.objectBounds=!1,this._gizmoObject=gg(this.color??16776960))),this.objectBounds?(this.scene.add(this._gizmoObject),this._boxHelper=this._gizmoObject,this.startCoroutine(this.syncObjectBounds(),Me.OnBeforeRender)):this.gameObject.add(this._gizmoObject))}onDisable(){this._gizmoObject&&this.gameObject.remove(this._gizmoObject)}*syncObjectBounds(){for(var t;this._boxHelper;)(t=this._boxHelper)==null||t.update(),yield}}T0([m()],Gr.prototype,"objectBounds",2),T0([m(ae)],Gr.prototype,"color",2),T0([m()],Gr.prototype,"isGizmo",2);var mE=Object.defineProperty,gE=Object.getOwnPropertyDescriptor,E0=(n,t,i,s)=>{for(var o=s>1?void 0:s?gE(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&mE(t,i,o),o};class Cl extends A{constructor(){super(...arguments),a(this,"isGizmo",!1),a(this,"color0"),a(this,"color1"),a(this,"gridHelper"),a(this,"size"),a(this,"divisions"),a(this,"offset")}onEnable(){if(this.isGizmo&&!xc)return;const t=this.size,i=this.divisions;this.gridHelper||(this.gridHelper=new nm(t,i,this.color0??new ae(.4,.4,.4),this.color1??new ae(.6,.6,.6)),this.offset!==void 0&&(this.gridHelper.position.y+=this.offset)),this.gridHelper&&this.gameObject.add(this.gridHelper)}onDisable(){this.gridHelper&&(this.gameObject.remove(this.gridHelper),this.gridHelper=null)}}E0([m()],Cl.prototype,"isGizmo",2),E0([m(ae)],Cl.prototype,"color0",2),E0([m(ae)],Cl.prototype,"color1",2);var fE=Object.defineProperty,yE=Object.getOwnPropertyDescriptor,A0=(n,t,i,s)=>{for(var o=s>1?void 0:s?yE(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&fE(t,i,o),o};class I0 extends A{constructor(){super(...arguments),a(this,"connectedBody"),a(this,"_rigidBody",null)}get rigidBody(){return this._rigidBody}onEnable(){this._rigidBody||(this._rigidBody=this.gameObject.getComponent(ye)),this.rigidBody&&this.connectedBody&&this.startCoroutine(this.create())}*create(){yield,this.rigidBody&&this.connectedBody&&this.activeAndEnabled&&this.createJoint(this.rigidBody,this.connectedBody)}}A0([m(ye)],I0.prototype,"connectedBody",2);class j0 extends I0{createJoint(t,i){var s;(s=this.context.physics.engine)==null||s.addFixedJoint(t,i)}}class vh extends I0{constructor(){super(...arguments),a(this,"anchor"),a(this,"axis")}createJoint(t,i){var s;this.axis&&this.anchor&&((s=this.context.physics.engine)==null||s.addHingeJoint(t,i,this.anchor,this.axis))}}A0([m(x)],vh.prototype,"anchor",2),A0([m(x)],vh.prototype,"axis",2);var vE=Object.defineProperty,bE=Object.getOwnPropertyDescriptor,as=(n,t,i,s)=>{for(var o=s>1?void 0:s?bE(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&vE(t,i,o),o};function L0(n){return n*Math.PI/180}const t1=300,No=C("debuglights");class gi extends A{constructor(){super(...arguments),a(this,"type",0),a(this,"range",1),a(this,"spotAngle",1),a(this,"innerSpotAngle",1),a(this,"_color",new ae(16777215)),a(this,"_shadowNearPlane",.1),a(this,"_shadowBias",0),a(this,"_shadowNormalBias",0),a(this,"_overrideShadowBiasSettings",!1),a(this,"_shadows",1),a(this,"lightmapBakeType",4),a(this,"_intensity",-1),a(this,"_shadowDistance"),a(this,"shadowWidth"),a(this,"shadowHeight"),a(this,"_shadowResolution"),a(this,"light"),a(this,"_webXRStartedListener"),a(this,"_webXREndedListener"),a(this,"_webARRoot")}set color(t){this._color=t,this.light!==void 0&&(this.light.color=t)}get color(){return this.light?this.light.color:this._color}set shadowNearPlane(t){var i,s;if(t!==this._shadowNearPlane&&(this._shadowNearPlane=t,((s=(i=this.light)==null?void 0:i.shadow)==null?void 0:s.camera)!==void 0)){const o=this.light.shadow.camera;o.near=t}}get shadowNearPlane(){return this._shadowNearPlane}set shadowBias(t){var i,s;t!==this._shadowBias&&(this._shadowBias=t,((s=(i=this.light)==null?void 0:i.shadow)==null?void 0:s.bias)!==void 0&&(this.light.shadow.bias=t,this.light.shadow.needsUpdate=!0))}get shadowBias(){return this._shadowBias}set shadowNormalBias(t){var i,s;t!==this._shadowNormalBias&&(this._shadowNormalBias=t,((s=(i=this.light)==null?void 0:i.shadow)==null?void 0:s.normalBias)!==void 0&&(this.light.shadow.normalBias=t,this.light.shadow.needsUpdate=!0))}get shadowNormalBias(){return this._shadowNormalBias}set shadows(t){this._shadows=t,this.light&&(this.light.castShadow=t!==0,this.updateShadowSoftHard())}get shadows(){return this._shadows}set intensity(t){var i;if(this._intensity=t,this.light){let s=1;if(this.context.isInXR&&this._webARRoot){const o=(i=this._webARRoot)==null?void 0:i.arScale;typeof o=="number"&&o>0&&(s/=o)}this.light.intensity=t*s}No&&console.log("Set light intensity to "+this._intensity,t,this)}get intensity(){return this._intensity}get shadowDistance(){const t=this.light;return t!=null&&t.shadow?t.shadow.camera.far:-1}set shadowDistance(t){this._shadowDistance=t;const i=this.light;if(i!=null&&i.shadow){const s=i.shadow.camera;s.far=t,s.updateProjectionMatrix()}}get shadowResolution(){const t=this.light;return t!=null&&t.shadow?t.shadow.mapSize.x:-1}set shadowResolution(t){if(t===this._shadowResolution)return;this._shadowResolution=t;const i=this.light;i!=null&&i.shadow&&(i.shadow.mapSize.set(t,t),i.shadow.needsUpdate=!0)}get isBaked(){return this.lightmapBakeType===2}get selfIsLight(){if(this.gameObject.isLight===!0)return!0;switch(this.gameObject.type){case"SpotLight":case"PointLight":case"DirectionalLight":return!0}return!1}getWorldPosition(t){return this.light?this.type===1?this.light.getWorldPosition(t).multiplyScalar(1):this.light.getWorldPosition(t):t}awake(){this.color=new ae(this.color??16777215),No&&console.log(this.name,this)}onEnable(){No&&console.log("ENABLE LIGHT",this.name),this.createLight(),!this.isBaked&&(this.light&&(this.light.visible=!0,this.light.intensity=this._intensity,No&&console.log("Set light intensity to "+this.light.intensity,this.name),this.selfIsLight||this.light.parent!==this.gameObject&&this.gameObject.add(this.light)),this.type===1&&this.startCoroutine(this.updateMainLightRoutine(),Me.LateUpdate))}onDisable(){No&&console.log("DISABLE LIGHT",this.name),this.light&&(this.selfIsLight?this.light.intensity=0:this.light.visible=!1)}onEnterXR(t){this._webARRoot=O.getComponentInParent(this.gameObject,ns)??void 0}onLeaveXR(t){}createLight(){const t=this.selfIsLight;if(t&&!this.light)switch(this.light=this.gameObject,this.light.name=this.name,this._intensity=this.light.intensity,this.type){case 1:this.setDirectionalLight(this.light);break}else if(!this.light)switch(this.type){case 1:const i=new sm(this.color,this.intensity*Math.PI);if(i.position.set(0,0,-t1*.5).applyQuaternion(this.gameObject.quaternion),this.gameObject.add(i.target),cr(i.target,0,0,0),this.light=i,this.gameObject.position.set(0,0,0),this.gameObject.rotation.set(0,0,0),No){const l=new mC(this.light,.2,this.color);this.context.scene.add(l)}break;case 0:const s=new pC(this.color,this.intensity*Math.PI,this.range,L0(this.spotAngle/2),1-L0(this.innerSpotAngle/2)/L0(this.spotAngle/2),2);s.position.set(0,0,0),s.rotation.set(0,0,0),this.light=s;const o=s.target;s.add(o),o.position.set(0,0,this.range),o.rotation.set(0,0,0);break;case 2:const r=new om(this.color,this.intensity*Math.PI,this.range);this.light=r;break}if(this.light){if(this._intensity>=0?this.light.intensity=this._intensity:this._intensity=this.light.intensity,this.shadows!==0?this.light.castShadow=!0:this.light.castShadow=!1,this.light.shadow){this._shadowResolution!==void 0&&this._shadowResolution>4?(this.light.shadow.mapSize.width=this._shadowResolution,this.light.shadow.mapSize.height=this._shadowResolution):(this.light.shadow.mapSize.width=2048,this.light.shadow.mapSize.height=2048),No&&console.log("Override shadow bias?",this._overrideShadowBiasSettings,this.shadowBias,this.shadowNormalBias),this.light.shadow.bias=this.shadowBias,this.light.shadow.normalBias=this.shadowNormalBias,this.updateShadowSoftHard();const i=this.light.shadow.camera;if(i.near=this.shadowNearPlane,this._shadowDistance!==void 0&&typeof this._shadowDistance=="number"?i.far=this._shadowDistance:i.far=t1*Math.abs(this.gameObject.scale.z),this.gameObject.scale.set(1,1,1),this.shadowWidth!==void 0)i.left=-this.shadowWidth/2,i.right=this.shadowWidth/2;else{const s=this.gameObject.scale.x;i.left*=s,i.right*=s}if(this.shadowHeight!==void 0)i.top=this.shadowHeight/2,i.bottom=-this.shadowHeight/2;else{const s=this.gameObject.scale.y;i.top*=s,i.bottom*=s}this.light.shadow.needsUpdate=!0,No&&this.context.scene.add(new gC(i))}this.isBaked?this.light.removeFromParent():t||this.gameObject.add(this.light)}}*updateMainLightRoutine(){for(;;){this.type===1&&((!this.context.mainLight||this.intensity>this.context.mainLight.intensity)&&(this.context.mainLight=this),yield);break}}updateShadowSoftHard(){this.light&&this.light.shadow&&(this.shadows===2||(this.light.shadow.radius=1,this.light.shadow.blurSamples=1))}setDirectionalLight(t){t.add(t.target),t.target.position.set(0,0,-1)}}a(gi,"allowChangingRendererShadowMapType",!0),as([m()],gi.prototype,"type",2),as([m(ae)],gi.prototype,"color",1),as([m()],gi.prototype,"shadowNearPlane",1),as([m()],gi.prototype,"shadowBias",1),as([m()],gi.prototype,"shadowNormalBias",1),as([m()],gi.prototype,"shadows",1),as([m()],gi.prototype,"lightmapBakeType",2),as([m()],gi.prototype,"intensity",1),as([m()],gi.prototype,"shadowDistance",1),as([m()],gi.prototype,"shadowResolution",1),new x(0,0,0);var _E=Object.defineProperty,wE=Object.getOwnPropertyDescriptor,bh=(n,t,i,s)=>{for(var o=s>1?void 0:s?wE(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&_E(t,i,o),o};const D0=C("debuglods"),xE=C("nolods");class Ol{constructor(){a(this,"screenRelativeTransitionHeight"),a(this,"distance"),a(this,"renderers")}}bh([m()],Ol.prototype,"screenRelativeTransitionHeight",2),bh([m()],Ol.prototype,"distance",2),bh([m(Ze)],Ol.prototype,"renderers",2);class SE{constructor(t){a(this,"model"),this.model=t}get renderers(){return this.model.renderers}}class _h extends A{constructor(){super(...arguments),a(this,"fadeMode",0),a(this,"localReferencePoint"),a(this,"lodCount",0),a(this,"size",0),a(this,"animateCrossFading",!1),a(this,"lodModels"),a(this,"_lods",[]),a(this,"_settings",[]),a(this,"_lodsHandler"),a(this,"_distanceFactor",1)}start(){if(D0&&console.log("LODGROUP",this.name,this.lodModels,this),!xE&&!this._lodsHandler&&this.gameObject&&this.lodModels&&Array.isArray(this.lodModels)){const t=[];for(const s of this.lodModels){const o=new SE(s);this._lods.push(o);for(const r of o.renderers)t.includes(r)||t.push(r)}this._lodsHandler=new Array;for(let s=0;s<t.length;s++){const o=new fC;this._lodsHandler.push(o),this.gameObject.add(o)}const i=new j;i.name="Cull "+this.name;for(let s=0;s<t.length;s++){const o=t[s],r=this._lodsHandler[s],l=o.gameObject;D0&&console.log(s,l.name);for(const c of this._lods){const h=c.model.distance;let d=null;if(c.renderers.includes(o)?d=l:d=i,d.type==="Group"){console.warn(`LODGroup ${this.name}: Group or MultiMaterial object's are not supported as LOD object: ${d.name}`);continue}D0&&console.log("LEVEL",d.name,h),r.autoUpdate=!1,this.onAddLodLevel(r,d,c.model.distance)}}}}onAfterRender(){if(!this.gameObject||!this._lodsHandler)return;const t=this.context.mainCamera;if(t)for(const i of this._lodsHandler){i.update(t);const s=i.getCurrentLevel(),o=i.levels[s];i.layers.mask=o.object.layers.mask}}onAddLodLevel(t,i,s){if(i===this.gameObject){console.warn("LODGroup component must be on parent object and not mesh directly at the moment",i.name,i);return}t.addLevel(i,s*this._distanceFactor,.01);const o={lod:t,levelIndex:t.levels.length-1,distance:s};this._settings.push(o)}distanceFactor(t){if(t!==this._distanceFactor){this._distanceFactor=t;for(const i of this._settings){const s=i.lod.levels[i.levelIndex];s.distance=i.distance*t}}}}bh([m(x)],_h.prototype,"localReferencePoint",2),bh([m(Ol)],_h.prototype,"lodModels",2);var CE=Object.defineProperty,OE=Object.getOwnPropertyDescriptor,PE=(n,t,i,s)=>{for(var o=s>1?void 0:s?OE(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&CE(t,i,o),o};const gp=C("debugnestedgltf");class fp extends A{constructor(){super(...arguments),a(this,"filePath"),a(this,"loadAssetInParent",!0),a(this,"_isLoadingOrDoneLoading",!1)}listenToProgress(t){var i;(i=this.filePath)==null||i.beginListenDownload(t)}preload(){var t;(t=this.filePath)==null||t.preload()}async start(){var t,i,s,o,r;if(this._isLoadingOrDoneLoading)return;gp&&console.log(this,this.guid);const l=this.gameObject.parent;if(l){this._isLoadingOrDoneLoading=!0;const c=new Bn;c.idProvider=new Dt(this.hash(this.guid)),c.parent=this.loadAssetInParent!==!1?l:this.gameObject,this.gameObject.updateMatrix();const h=this.gameObject.matrix;gp&&console.log("Load nested:",((t=this.filePath)==null?void 0:t.url)??this.filePath,this.gameObject.position);const d=await((s=(i=this.filePath)==null?void 0:i.instantiate)==null?void 0:s.call(this.filePath,c));gp&&console.log("Nested loaded:",((o=this.filePath)==null?void 0:o.url)??this.filePath,d),d&&this.loadAssetInParent!==!1&&(d.matrixAutoUpdate=!1,d.matrix.identity(),d.applyMatrix4(h),d.matrixAutoUpdate=!0,d.layers.disableAll(),d.layers.set(this.layer),this.dispatchEvent(new CustomEvent("loaded",{detail:{instance:d,assetReference:this.filePath}}))),gp&&console.log("Nested loading done:",((r=this.filePath)==null?void 0:r.url)??this.filePath,d)}}onDestroy(){var t;(t=this.filePath)==null||t.unload()}hash(t){let i=0;for(let s=0;s<t.length;s++)i=t.charCodeAt(s)+((i<<5)-i);return i}}PE([m(le)],fp.prototype,"filePath",2);var kE=Object.defineProperty,ME=Object.getOwnPropertyDescriptor,B0=(n,t,i,s)=>{for(var o=s>1?void 0:s?ME(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&kE(t,i,o),o};const RE=C("debugnet"),F0=class extends A{constructor(){super(...arguments),a(this,"url",null),a(this,"urlParameterName",null),a(this,"localhost",null)}awake(){RE&&console.log(this),this.context.connection.registerProvider(this)}getWebsocketUrl(){let n=this.url?F0.GetUrl(this.url,this.localhost):null;if(this.urlParameterName){const i=C(this.urlParameterName);i&&typeof i=="string"&&(n=i)}if(!n)return null;const t=new RegExp("(((https?)|(?<socket_prefix>wss?))://)?(www.)?(?<url>.+)","gm").exec(n);return t!=null&&t.groups?t?.groups.socket_prefix?n:"wss://"+t?.groups.url:null}static GetUrl(n,t){let i=n;const s=F0.IsLocalNetwork()&&t;if(s&&(i=t),n!=null&&n.startsWith("/")){const o=s?i:window.location.origin;o!=null&&o.endsWith("/")&&n.startsWith("/")&&(n=n.substring(1)),i=o+n}return i}static IsLocalNetwork(n=window.location.hostname){return Xt(n)}};let Pl=F0;B0([m()],Pl.prototype,"url",2),B0([m()],Pl.prototype,"urlParameterName",2),B0([m()],Pl.prototype,"localhost",2);var TE=Object.defineProperty,EE=Object.getOwnPropertyDescriptor,yp=(n,t,i,s)=>{for(var o=s>1?void 0:s?EE(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&TE(t,i,o),o};class qr extends A{constructor(){super(...arguments),a(this,"referenceSpace"),a(this,"from"),a(this,"affectPosition",!1),a(this,"affectRotation",!1),a(this,"alignLookDirection",!1),a(this,"levelLookDirection",!1),a(this,"levelPosition",!1),a(this,"positionOffset",new x(0,0,0)),a(this,"rotationOffset",new x(0,0,0)),a(this,"offset",new x(0,0,0))}update(){if(!this.from)return;var t=te(this.from),i=Ce(this.from);this.offset.copy(this.positionOffset);const s=this.offset.length();if(this.referenceSpace&&this.offset.transformDirection(this.referenceSpace.matrixWorld).multiplyScalar(s),t.add(this.offset),this.levelPosition&&this.referenceSpace){const c=new or(this.gameObject.up,0),h=te(this.referenceSpace);c.setFromNormalAndCoplanarPoint(this.gameObject.up,h);const d=new x(0,0,0);c.projectPoint(t,d),t.copy(d)}this.affectPosition&&dt(this.gameObject,t);const o=new Bt(this.rotationOffset.x,this.rotationOffset.y,this.rotationOffset.z),r=new V().setFromEuler(o);this.affectRotation&&Vi(this.gameObject,i.multiply(r));const l=new x;this.from.getWorldDirection(l).multiplyScalar(50),this.levelLookDirection&&(l.y=0),this.alignLookDirection&&this.gameObject.lookAt(l)}}yp([m(O)],qr.prototype,"referenceSpace",2),yp([m(O)],qr.prototype,"from",2),yp([m(x)],qr.prototype,"positionOffset",2),yp([m(x)],qr.prototype,"rotationOffset",2);var AE=Object.defineProperty,IE=Object.getOwnPropertyDescriptor,Wo=(n,t,i,s)=>{for(var o=s>1?void 0:s?IE(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&AE(t,i,o),o};class fi{constructor(t=0,i=0){a(this,"time",0),a(this,"value",0),a(this,"inTangent",1/0),a(this,"inWeight"),a(this,"outTangent",1/0),a(this,"outWeight"),a(this,"weightedMode"),this.time=t,this.value=i}}Wo([m()],fi.prototype,"time",2),Wo([m()],fi.prototype,"value",2),Wo([m()],fi.prototype,"inTangent",2),Wo([m()],fi.prototype,"inWeight",2),Wo([m()],fi.prototype,"outTangent",2),Wo([m()],fi.prototype,"outWeight",2),Wo([m()],fi.prototype,"weightedMode",2);const wh=class{constructor(){a(this,"keys",[])}static linearFromTo(n,t,i){const s=new wh,o=new fi;o.time=0,o.value=n;const r=new fi;return r.time=i,r.value=t,s.keys.push(o,r),s}static constant(n){const t=new wh,i=new fi;return i.time=0,i.value=n,t.keys.push(i),t}clone(){var n;const t=new wh;return t.keys=((n=this.keys)==null?void 0:n.map(i=>{const s=new fi;return s.time=i.time,s.value=i.value,s.inTangent=i.inTangent,s.inWeight=i.inWeight,s.outTangent=i.outTangent,s.outWeight=i.outWeight,s.weightedMode=i.weightedMode,s}))||[],t}get duration(){return!this.keys||this.keys.length==0?0:this.keys[this.keys.length-1].time}evaluate(n){if(!this.keys||this.keys.length==0)return 0;if(this.keys.length===1)return this.keys[0].value;if(this.keys[0].time>=n)return this.keys[0].value;for(let t=0;t<this.keys.length;t++){const i=this.keys[t];if(i.time<=n)if(t+1<this.keys.length){const s=this.keys[t+1];if(s.time<n)continue;return!isFinite(i.outTangent)||!isFinite(s.inTangent)?i.value:wh.interpolateValue(n,i,s)}else return i.value}return this.keys[this.keys.length-1].value}static interpolateValue(n,t,i){const s=t.time,o=t.value,r=t.outTangent,l=i.time,c=i.value,h=i.inTangent,d=l-s,u=d*d,p=u*d,g=((r+h)*d-2*(c-o))/p,y=(3*(c-o)-(h+2*r)*d)/u,f=r,v=o,b=n-s,w=b*b,_=w*b;return g*_+y*w+f*b+v}};let kl=wh;Wo([m(fi)],kl.prototype,"keys",2);var jE=Object.defineProperty,LE=Object.getOwnPropertyDescriptor,P=(n,t,i,s)=>{for(var o=s>1?void 0:s?LE(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&jE(t,i,o),o};const vp=C("debugparticles");var Hs=(n=>(n[n.Billboard=0]="Billboard",n[n.Stretch=1]="Stretch",n[n.HorizontalBillboard=2]="HorizontalBillboard",n[n.VerticalBillboard=3]="VerticalBillboard",n[n.Mesh=4]="Mesh",n))(Hs||{});class Xr{constructor(){a(this,"alphaKeys",[]),a(this,"colorKeys",[])}get duration(){return 1}evaluate(t,i){let s,o=0,r=null,l=0;for(let c=0;c<this.alphaKeys.length;c++){const h=this.alphaKeys[c];(h.time<t||!s)&&(s=h,o=c)}for(let c=0;c<this.colorKeys.length;c++){const h=this.colorKeys[c];(h.time<t||!r)&&(r=h,l=c)}if(r)if(l+1<this.colorKeys.length){const c=this.colorKeys[l+1],h=W.remap(t,r.time,c.time,0,1);i.r=W.lerp(r.color.r,c.color.r,h),i.g=W.lerp(r.color.g,c.color.g,h),i.b=W.lerp(r.color.b,c.color.b,h)}else i.r=r.color.r,i.g=r.color.g,i.b=r.color.b;if(s)if(o+1<this.alphaKeys.length){const c=this.alphaKeys[o+1],h=W.remap(t,s.time,c.time,0,1);i.alpha=W.lerp(s.alpha,c.alpha,h)}else i.alpha=s.alpha;return i}}P([m()],Xr.prototype,"alphaKeys",2),P([m()],Xr.prototype,"colorKeys",2);var xh=(n=>(n[n.Local=0]="Local",n[n.World=1]="World",n[n.Custom=2]="Custom",n))(xh||{}),bp=(n=>(n[n.Sphere=0]="Sphere",n[n.SphereShell=1]="SphereShell",n[n.Hemisphere=2]="Hemisphere",n[n.HemisphereShell=3]="HemisphereShell",n[n.Cone=4]="Cone",n[n.Box=5]="Box",n[n.Mesh=6]="Mesh",n[n.ConeShell=7]="ConeShell",n[n.ConeVolume=8]="ConeVolume",n[n.ConeVolumeShell=9]="ConeVolumeShell",n[n.Circle=10]="Circle",n[n.CircleEdge=11]="CircleEdge",n[n.SingleSidedEdge=12]="SingleSidedEdge",n[n.MeshRenderer=13]="MeshRenderer",n[n.SkinnedMeshRenderer=14]="SkinnedMeshRenderer",n[n.BoxShell=15]="BoxShell",n[n.BoxEdge=16]="BoxEdge",n[n.Donut=17]="Donut",n[n.Rectangle=18]="Rectangle",n[n.Sprite=19]="Sprite",n[n.SpriteRenderer=20]="SpriteRenderer",n))(bp||{});const Sh=class{constructor(){a(this,"mode","Constant"),a(this,"constant"),a(this,"constantMin"),a(this,"constantMax"),a(this,"curve"),a(this,"curveMin"),a(this,"curveMax"),a(this,"curveMultiplier")}static constant(n){const t=new Sh;return t.setConstant(n),t}static betweenTwoConstants(n,t){const i=new Sh;return i.setMinMaxConstant(n,t),i}static curve(n,t=1){const i=new Sh;return i.setCurve(n,t),i}setConstant(n){this.mode=0,this.constant=n}setMinMaxConstant(n,t){this.mode=3,this.constantMin=n,this.constantMax=t}setCurve(n,t=1){this.mode=1,this.curve=n,this.curveMultiplier=t}clone(){var n,t,i;const s=new Sh;return s.mode=this.mode,s.constant=this.constant,s.constantMin=this.constantMin,s.constantMax=this.constantMax,s.curve=(n=this.curve)==null?void 0:n.clone(),s.curveMin=(t=this.curveMin)==null?void 0:t.clone(),s.curveMax=(i=this.curveMax)==null?void 0:i.clone(),s.curveMultiplier=this.curveMultiplier,s}evaluate(n,t){const i=t===void 0?Math.random():t;switch(this.mode){case 0:case"Constant":return this.constant;case 1:case"Curve":return n=W.clamp01(n),this.curve.evaluate(n)*this.curveMultiplier;case 2:case"TwoCurves":const s=n*this.curveMin.duration,o=n*this.curveMax.duration;return W.lerp(this.curveMin.evaluate(s),this.curveMax.evaluate(o),i%1)*this.curveMultiplier;case 3:case"TwoConstants":return W.lerp(this.constantMin,this.constantMax,i%1);default:this.curveMax.evaluate(n)*this.curveMultiplier;break}return 0}getMax(){switch(this.mode){case 0:case"Constant":return this.constant;case 1:case"Curve":return this.getMaxFromCurve(this.curve)*this.curveMultiplier;case 2:case"TwoCurves":return Math.max(this.getMaxFromCurve(this.curveMin),this.getMaxFromCurve(this.curveMax))*this.curveMultiplier;case 3:case"TwoConstants":return Math.max(this.constantMin,this.constantMax);default:return 0}}getMaxFromCurve(n){if(!n)return 0;let t=Number.MIN_VALUE;for(let i=0;i<n.keys.length;i++){const s=n.keys[i];s.value>t&&(t=s.value)}return t}};let Z=Sh;P([m()],Z.prototype,"mode",2),P([m()],Z.prototype,"constant",2),P([m()],Z.prototype,"constantMin",2),P([m()],Z.prototype,"constantMax",2),P([m(kl)],Z.prototype,"curve",2),P([m(kl)],Z.prototype,"curveMin",2),P([m(kl)],Z.prototype,"curveMax",2),P([m()],Z.prototype,"curveMultiplier",2);var _p;const jt=(_p=class{constructor(){a(this,"mode",0),a(this,"color"),a(this,"colorMin"),a(this,"colorMax"),a(this,"gradient"),a(this,"gradientMin"),a(this,"gradientMax")}static constant(n){const t=new jt;return t.constant(n),t}static betweenTwoColors(n,t){const i=new jt;return i.betweenTwoColors(n,t),i}constant(n){return this.mode=0,this.color=n,this}betweenTwoColors(n,t){return this.mode=2,this.colorMin=n,this.colorMax=t,this}evaluate(n,t){const i=t===void 0?Math.random():t;switch(this.mode){case 0:case"Color":return this.color;case 1:case"Gradient":return this.gradient.evaluate(n,jt._temp),jt._temp;case 2:case"TwoColors":return jt._temp.lerpColors(this.colorMin,this.colorMax,i);case 3:case"TwoGradients":return this.gradientMin.evaluate(n,jt._temp),this.gradientMax.evaluate(n,jt._temp2),jt._temp.lerp(jt._temp2,i);case 4:case"RandomColor":const s=Math.random();return this.gradientMin.evaluate(n,jt._temp),this.gradientMax.evaluate(n,jt._temp2),jt._temp.lerp(jt._temp2,s)}return jt._temp.set(16777215),jt._temp.alpha=1,jt._temp}},a(_p,"_temp",new xe(0,0,0,1)),a(_p,"_temp2",new xe(0,0,0,1)),_p);let yi=jt;P([m()],yi.prototype,"mode",2),P([m(xe)],yi.prototype,"color",2),P([m(xe)],yi.prototype,"colorMin",2),P([m(xe)],yi.prototype,"colorMax",2),P([m(Xr)],yi.prototype,"gradient",2),P([m(Xr)],yi.prototype,"gradientMin",2),P([m(Xr)],yi.prototype,"gradientMax",2);var z0=(n=>(n[n.Hierarchy=0]="Hierarchy",n[n.Local=1]="Local",n[n.Shape=2]="Shape",n))(z0||{});class $t{constructor(){a(this,"cullingMode"),a(this,"duration"),a(this,"emitterVelocityMode"),a(this,"flipRotation"),a(this,"gravityModifier"),a(this,"gravityModifierMultiplier"),a(this,"loop"),a(this,"maxParticles"),a(this,"playOnAwake"),a(this,"prewarm"),a(this,"ringBufferLoopRange"),a(this,"ringBufferMode"),a(this,"scalingMode"),a(this,"simulationSpace"),a(this,"simulationSpeed"),a(this,"startColor"),a(this,"startDelay"),a(this,"startDelayMultiplier"),a(this,"startLifetime"),a(this,"startLifetimeMultiplier"),a(this,"startRotation"),a(this,"startRotationMultiplier"),a(this,"startRotation3D"),a(this,"startRotationX"),a(this,"startRotationXMultiplier"),a(this,"startRotationY"),a(this,"startRotationYMultiplier"),a(this,"startRotationZ"),a(this,"startRotationZMultiplier"),a(this,"startSize"),a(this,"startSize3D"),a(this,"startSizeMultiplier"),a(this,"startSizeX"),a(this,"startSizeXMultiplier"),a(this,"startSizeY"),a(this,"startSizeYMultiplier"),a(this,"startSizeZ"),a(this,"startSizeZMultiplier"),a(this,"startSpeed"),a(this,"startSpeedMultiplier"),a(this,"stopAction"),a(this,"useUnscaledTime")}}P([m(Z)],$t.prototype,"gravityModifier",2),P([m(yi)],$t.prototype,"startColor",2),P([m(Z)],$t.prototype,"startDelay",2),P([m(Z)],$t.prototype,"startLifetime",2),P([m(Z)],$t.prototype,"startRotation",2),P([m(Z)],$t.prototype,"startRotationX",2),P([m(Z)],$t.prototype,"startRotationY",2),P([m(Z)],$t.prototype,"startRotationZ",2),P([m(Z)],$t.prototype,"startSize",2),P([m(Z)],$t.prototype,"startSizeX",2),P([m(Z)],$t.prototype,"startSizeY",2),P([m(Z)],$t.prototype,"startSizeZ",2),P([m(Z)],$t.prototype,"startSpeed",2);class wp{constructor(){a(this,"cycleCount"),a(this,"maxCount"),a(this,"minCount"),a(this,"probability"),a(this,"repeatInterval"),a(this,"time"),a(this,"count"),a(this,"_performed",0)}reset(){this._performed=0}run(t){if(t<=this.time)return 0;let i=0;if(this.cycleCount===0||this._performed<this.cycleCount){const s=this.time+this.repeatInterval*this._performed;if(t>=s&&(this._performed+=1,Math.random()<this.probability))switch(this.count.mode){case 0:i=this.count.constant;break;case 3:i=W.lerp(this.count.constantMin,this.count.constantMax,Math.random());break;case 1:i=this.count.curve.evaluate(Math.random());break;case 2:const o=Math.random();i=W.lerp(this.count.curveMin.evaluate(o),this.count.curveMax.evaluate(o),Math.random());break}}return i}}class $s{constructor(){a(this,"enabled"),a(this,"bursts"),a(this,"rateOverTime"),a(this,"rateOverTimeMultiplier"),a(this,"rateOverDistance"),a(this,"rateOverDistanceMultiplier"),a(this,"system")}get burstCount(){var t;return((t=this.bursts)==null?void 0:t.length)??0}reset(){var t;(t=this.bursts)==null||t.forEach(i=>i.reset())}getBurst(){let t=0;if(this.burstCount>0)for(let i=0;i<this.burstCount;i++){const s=this.bursts[i];this.system.main.loop&&s.time>=this.system.time&&s.reset(),t+=Math.round(s.run(this.system.time))}return t}}P([m()],$s.prototype,"enabled",2),P([m()],$s.prototype,"bursts",2),P([m(Z)],$s.prototype,"rateOverTime",2),P([m()],$s.prototype,"rateOverTimeMultiplier",2),P([m(Z)],$s.prototype,"rateOverDistance",2),P([m()],$s.prototype,"rateOverDistanceMultiplier",2);class xp{constructor(){a(this,"enabled"),a(this,"color")}}P([m(yi)],xp.prototype,"color",2);class Qr{constructor(){a(this,"enabled"),a(this,"separateAxes"),a(this,"size"),a(this,"sizeMultiplier"),a(this,"x"),a(this,"xMultiplier"),a(this,"y"),a(this,"yMultiplier"),a(this,"z"),a(this,"zMultiplier"),a(this,"_time",0),a(this,"_temp",new x)}evaluate(t,i,s){if(i||(i=this._temp),!this.enabled)return i.x=i.y=i.z=1,i;if(this.separateAxes)i.x=this.x.evaluate(t,s)*this.xMultiplier,i.y=this.y.evaluate(t,s)*this.yMultiplier,i.z=this.z.evaluate(t,s)*this.zMultiplier;else{const o=this.size.evaluate(t,s)*this.sizeMultiplier;i.x=o}return i}}P([m(Z)],Qr.prototype,"size",2),P([m(Z)],Qr.prototype,"x",2),P([m(Z)],Qr.prototype,"y",2),P([m(Z)],Qr.prototype,"z",2);var Sp;const Ch=(Sp=class{constructor(){a(this,"shapeType",5),a(this,"enabled",!0),a(this,"alignToDirection",!1),a(this,"angle",0),a(this,"arc",360),a(this,"arcSpread"),a(this,"arcSpeedMultiplier"),a(this,"arcMode"),a(this,"boxThickness"),a(this,"position"),a(this,"rotation"),a(this,"_rotation",new Bt),a(this,"scale"),a(this,"radius"),a(this,"radiusThickness"),a(this,"sphericalDirectionAmount"),a(this,"randomDirectionAmount"),a(this,"randomPositionAmount"),a(this,"meshShapeType"),a(this,"meshRenderer"),a(this,"_meshObj"),a(this,"_meshGeometry"),a(this,"system"),a(this,"_space"),a(this,"_worldSpaceMatrix",new se),a(this,"_worldSpaceMatrixInverse",new se),a(this,"_vector",new x(0,0,0)),a(this,"_temp",new x(0,0,0)),a(this,"_triangle",new yC),a(this,"_dir",new x),a(this,"_loopTime",0),a(this,"_loopDirection",1),vp&&console.log(this)}get type(){return bp[this.shapeType]}initialize(n){this.onInitialize(n),n.position.x=this._vector.x,n.position.y=this._vector.y,n.position.z=this._vector.z}toJSON(){return this}clone(){return new Ch}setMesh(n){this.meshRenderer=n,n?(this._meshObj=n.sharedMeshes[Math.floor(Math.random()*n.sharedMeshes.length)],this._meshGeometry=this._meshObj.geometry):(this._meshObj=void 0,this._meshGeometry=void 0)}update(n,t){}onUpdate(n,t,i,s){this.system=n,this._space=i,i===1&&(this._worldSpaceMatrix.copy(s.matrixWorld),this._worldSpaceMatrix.elements[0]=1,this._worldSpaceMatrix.elements[5]=1,this._worldSpaceMatrix.elements[10]=1,this._worldSpaceMatrixInverse.copy(this._worldSpaceMatrix).invert())}applyRotation(n){const t=this.rotation.x!==0||this.rotation.y!==0||this.rotation.z!==0;return t&&(this._rotation.x=W.toRadians(this.rotation.x),this._rotation.y=W.toRadians(this.rotation.y),this._rotation.z=W.toRadians(this.rotation.z),this._rotation.order="ZYX",n.applyEuler(this._rotation)),t}onInitialize(n){this._vector.set(0,0,0),n.mesh=void 0,n.mesh_geometry=void 0;const t=this._temp.copy(this.position),i=this._space===1;i&&t.applyQuaternion(this.system.worldQuaternion);let s=this.radius;if(i&&(s*=this.system.worldScale.x),this.enabled){switch(this.shapeType){case 5:vp&&G.DrawWireBox(this.position,this.scale,14540253,1),this._vector.x=Math.random()*this.scale.x-this.scale.x/2,this._vector.y=Math.random()*this.scale.y-this.scale.y/2,this._vector.z=Math.random()*this.scale.z-this.scale.z/2,this._vector.add(t);break;case 4:this.randomConePoint(this.position,this.angle,s,this.radiusThickness,this.arc,this.arcMode,this._vector);break;case 0:this.randomSpherePoint(this.position,s,this.radiusThickness,this.arc,this._vector);break;case 10:this.randomCirclePoint(this.position,s,this.radiusThickness,this.arc,this._vector);break;case 13:const o=this.meshRenderer;o?.destroyed==!1&&this.setMesh(o);const r=n.mesh=this._meshObj,l=n.mesh_geometry=this._meshGeometry;if(r&&l)switch(this.meshShapeType){case 0:{const c=l.getAttribute("position"),h=Math.floor(Math.random()*c.count);this._vector.fromBufferAttribute(c,h),this._vector.applyMatrix4(r.matrixWorld),n.mesh_normal=h}break;case 1:break;case 2:{const c=l.index;if(c){let h=Math.random(),d=Math.random();h+d>1&&(h=1-h,d=1-d);const u=Math.floor(Math.random()*(c.count/3));let p=u*3,g=u*3+1,y=u*3+2;p=c.getX(p),g=c.getX(g),y=c.getX(y);const f=l.getAttribute("position");this._triangle.a.fromBufferAttribute(f,p),this._triangle.b.fromBufferAttribute(f,g),this._triangle.c.fromBufferAttribute(f,y),this._vector.set(0,0,0).addScaledVector(this._triangle.a,h).addScaledVector(this._triangle.b,d).addScaledVector(this._triangle.c,1-(h+d)),this._vector.applyMatrix4(r.matrixWorld),n.mesh_normal=u}}break}break;default:this._vector.set(0,0,0),F()&&!globalThis.__particlesystem_shapetype_unsupported&&(console.warn("ParticleSystem ShapeType is not supported:",bp[this.shapeType]),globalThis.__particlesystem_shapetype_unsupported=!0);break}this.randomizePosition(this._vector,this.randomPositionAmount)}this.applyRotation(this._vector),i&&(this._vector.applyQuaternion(this.system.worldQuaternion),this._vector.add(this.system.worldPos)),vp&&G.DrawSphere(this._vector,.03,16711680,.5,!0)}getDirection(n,t){var i;if(!this.enabled)return this._dir.set(0,0,1),this._dir;switch(this.shapeType){case 5:this._dir.set(0,0,1);break;case 4:this._dir.set(0,0,1);break;case 10:case 0:const s=t.x,o=t.y,r=t.z;this._dir.set(s,o,r),(i=this.system)!=null&&i.worldspace?this._dir.sub(this.system.worldPos):this._dir.sub(this.position);break;case 13:const l=n.mesh,c=n.mesh_geometry;if(l&&c)switch(this.meshShapeType){case 0:{const h=c.getAttribute("normal"),d=n.mesh_normal;this._dir.fromBufferAttribute(h,d)}break;case 1:break;case 2:{const h=c.index;if(h){const d=n.mesh_normal,u=h.getX(d*3),p=h.getX(d*3+1),g=h.getX(d*3+2),y=c.getAttribute("position"),f=q(),v=q(),b=q();f.fromBufferAttribute(y,u),v.fromBufferAttribute(y,p),b.fromBufferAttribute(y,g),f.sub(v),b.sub(v),f.cross(b),this._dir.copy(f).multiplyScalar(-1);const w=Ce(l);this._dir.applyQuaternion(w)}}break}break;default:this._dir.set(0,0,1);break}return this._space===1&&this._dir.applyQuaternion(this.system.worldQuaternion),this.applyRotation(this._dir),this._dir.normalize(),this.spherizeDirection(this._dir,this.sphericalDirectionAmount),this.randomizeDirection(this._dir,this.randomDirectionAmount),vp&&(G.DrawSphere(t,.01,8925952,.5,!0),G.DrawDirection(t,this._dir,8925952,.5,!0)),this._dir}randomizePosition(n,t){if(t<=0)return;const i=Ch._tempVec;i.set(Math.random()*2-1,Math.random()*2-1,Math.random()*2-1),i.x*=t*this.scale.x,i.y*=t*this.scale.y,i.z*=t*this.scale.z,n.add(i)}randomizeDirection(n,t){if(t===0)return;const i=Ch._randomQuat,s=Ch._tempVec;s.set(Math.random()-.5,Math.random()-.5,Math.random()-.5).normalize(),i.setFromAxisAngle(s,t*Math.random()*Math.PI),n.applyQuaternion(i)}spherizeDirection(n,t){if(t===0)return;const i=Math.random()*Math.PI*2,s=Math.acos(1-Math.random()*2),o=Math.sin(s)*Math.cos(i),r=Math.sin(s)*Math.sin(i),l=Math.cos(s),c=new x(o,r,l);n.lerp(c,t)}randomSpherePoint(n,t,i,s,o){const r=Math.random(),l=Math.random(),c=2*Math.PI*r*(s/360),h=Math.acos(2*l-1),d=W.lerp(1,1-Math.pow(1-Math.random(),Math.PI),i)*t,u=n.x+this.scale.x*(-d*Math.sin(h)*Math.cos(c)),p=n.y+this.scale.y*(d*Math.sin(h)*Math.sin(c)),g=n.z+this.scale.z*(d*Math.cos(h));o.x=u,o.y=p,o.z=g}randomCirclePoint(n,t,i,s,o){const r=Math.random(),l=2*Math.PI*r*(s/360),c=W.lerp(1,1-Math.pow(1-Math.random(),Math.PI),i)*t,h=n.x+this.scale.x*c*Math.cos(l),d=n.y+this.scale.y*c*Math.sin(l),u=n.z;o.x=h,o.y=d,o.z=u}randomConePoint(n,t,i,s,o,r,l){let c=0,h=0;switch(r){case 0:c=Math.random(),h=Math.random();break;case 2:this._loopTime>1&&(this._loopDirection=-1),this._loopTime<0&&(this._loopDirection=1);case 1:c=.5,h=Math.random(),this._loopTime+=this.system.deltaTime*this._loopDirection;break}let d=2*Math.PI*c*(o/360);switch(r){case 2:case 1:d+=Math.PI+.5,d+=this._loopTime*Math.PI*2,d%=W.toRadians(o);break}const u=Math.acos(2*h-1),p=W.lerp(1,1-Math.pow(1-Math.random(),Math.PI),s)*i,g=n.x+-p*Math.sin(u)*Math.cos(d),y=n.y+p*Math.sin(u)*Math.sin(d),f=n.z;l.x=g*this.scale.x,l.y=y*this.scale.y,l.z=f*this.scale.z}},a(Sp,"_randomQuat",new V),a(Sp,"_tempVec",new x),Sp);let et=Ch;P([m()],et.prototype,"shapeType",2),P([m()],et.prototype,"enabled",2),P([m()],et.prototype,"alignToDirection",2),P([m()],et.prototype,"angle",2),P([m()],et.prototype,"arc",2),P([m()],et.prototype,"arcSpread",2),P([m()],et.prototype,"arcSpeedMultiplier",2),P([m()],et.prototype,"arcMode",2),P([m(x)],et.prototype,"boxThickness",2),P([m(x)],et.prototype,"position",2),P([m(x)],et.prototype,"rotation",2),P([m(x)],et.prototype,"scale",2),P([m()],et.prototype,"radius",2),P([m()],et.prototype,"radiusThickness",2),P([m()],et.prototype,"sphericalDirectionAmount",2),P([m()],et.prototype,"randomDirectionAmount",2),P([m()],et.prototype,"randomPositionAmount",2),P([m()],et.prototype,"meshShapeType",2),P([m(th)],et.prototype,"meshRenderer",2);class Pe{constructor(){a(this,"damping"),a(this,"enabled"),a(this,"frequency"),a(this,"octaveCount"),a(this,"octaveMultiplier"),a(this,"octaveScale"),a(this,"positionAmount"),a(this,"quality"),a(this,"remap"),a(this,"remapEnabled"),a(this,"remapMultiplier"),a(this,"remapX"),a(this,"remapXMultiplier"),a(this,"remapY"),a(this,"remapYMultiplier"),a(this,"remapZ"),a(this,"remapZMultiplier"),a(this,"scrollSpeedMultiplier"),a(this,"separateAxes"),a(this,"strengthMultiplier"),a(this,"strengthX"),a(this,"strengthXMultiplier"),a(this,"strengthY"),a(this,"strengthYMultiplier"),a(this,"strengthZ"),a(this,"strengthZMultiplier"),a(this,"_noise"),a(this,"_time",0),a(this,"_temp",new x)}update(t){this._time+=t.time.deltaTime*this.scrollSpeedMultiplier}apply(t,i,s,o,r,l){if(!this.enabled)return;this._noise||(this._noise=nO(()=>0));const c=this._temp.set(i.x,i.y,i.z).multiplyScalar(this.frequency),h=this._noise(c.x,c.y,c.z,this._time),d=this._noise(c.x,c.y,c.z,this._time+1e3*this.frequency),u=this._noise(c.x,c.y,c.z,this._time+2e3*this.frequency);this._temp.set(h,d,u).normalize();const p=r/l;let g=this.positionAmount.evaluate(p);this.separateAxes?(this._temp.x*=g*this.strengthXMultiplier,this._temp.y*=g*this.strengthYMultiplier,this._temp.z*=g*this.strengthZMultiplier):(this.strengthX&&(g*=this.strengthX.evaluate(p)*1.5),this._temp.multiplyScalar(g)),s.x+=this._temp.x,s.y+=this._temp.y,s.z+=this._temp.z}}P([m()],Pe.prototype,"damping",2),P([m()],Pe.prototype,"enabled",2),P([m()],Pe.prototype,"frequency",2),P([m()],Pe.prototype,"octaveCount",2),P([m()],Pe.prototype,"octaveMultiplier",2),P([m()],Pe.prototype,"octaveScale",2),P([m(Z)],Pe.prototype,"positionAmount",2),P([m()],Pe.prototype,"quality",2),P([m(Z)],Pe.prototype,"remap",2),P([m()],Pe.prototype,"remapEnabled",2),P([m()],Pe.prototype,"remapMultiplier",2),P([m(Z)],Pe.prototype,"remapX",2),P([m()],Pe.prototype,"remapXMultiplier",2),P([m(Z)],Pe.prototype,"remapY",2),P([m()],Pe.prototype,"remapYMultiplier",2),P([m(Z)],Pe.prototype,"remapZ",2),P([m()],Pe.prototype,"remapZMultiplier",2),P([m()],Pe.prototype,"scrollSpeedMultiplier",2),P([m()],Pe.prototype,"separateAxes",2),P([m()],Pe.prototype,"strengthMultiplier",2),P([m(Z)],Pe.prototype,"strengthX",2),P([m()],Pe.prototype,"strengthXMultiplier",2),P([m(Z)],Pe.prototype,"strengthY",2),P([m()],Pe.prototype,"strengthYMultiplier",2),P([m(Z)],Pe.prototype,"strengthZ",2),P([m()],Pe.prototype,"strengthZMultiplier",2);class Ge{constructor(){a(this,"enabled"),a(this,"attachRibbonToTransform",!1),a(this,"colorOverLifetime"),a(this,"colorOverTrail"),a(this,"dieWithParticles",!0),a(this,"inheritParticleColor",!0),a(this,"lifetime"),a(this,"lifetimeMultiplier"),a(this,"minVertexDistance",.2),a(this,"mode",0),a(this,"ratio",1),a(this,"ribbonCount",1),a(this,"shadowBias",0),a(this,"sizeAffectsLifetime",!1),a(this,"sizeAffectsWidth",!1),a(this,"splitSubEmitterRibbons",!1),a(this,"textureMode",0),a(this,"widthOverTrail"),a(this,"widthOverTrailMultiplier"),a(this,"worldSpace",!1)}getWidth(t,i,s,o){const r=this.widthOverTrail.evaluate(s,o);return t*=r,t}getColor(t,i,s){const o=this.colorOverTrail.evaluate(s),r=this.colorOverLifetime.evaluate(i);t.x*=o.r*r.r,t.y*=o.g*r.g,t.z*=o.b*r.b,"alpha"in o&&"alpha"in r&&(t.w*=o.alpha*r.alpha)}}P([m()],Ge.prototype,"enabled",2),P([m()],Ge.prototype,"attachRibbonToTransform",2),P([m(yi)],Ge.prototype,"colorOverLifetime",2),P([m(yi)],Ge.prototype,"colorOverTrail",2),P([m()],Ge.prototype,"dieWithParticles",2),P([m()],Ge.prototype,"inheritParticleColor",2),P([m(Z)],Ge.prototype,"lifetime",2),P([m()],Ge.prototype,"lifetimeMultiplier",2),P([m()],Ge.prototype,"minVertexDistance",2),P([m()],Ge.prototype,"mode",2),P([m()],Ge.prototype,"ratio",2),P([m()],Ge.prototype,"ribbonCount",2),P([m()],Ge.prototype,"shadowBias",2),P([m()],Ge.prototype,"sizeAffectsLifetime",2),P([m()],Ge.prototype,"sizeAffectsWidth",2),P([m()],Ge.prototype,"splitSubEmitterRibbons",2),P([m()],Ge.prototype,"textureMode",2),P([m(Z)],Ge.prototype,"widthOverTrail",2),P([m()],Ge.prototype,"widthOverTrailMultiplier",2),P([m()],Ge.prototype,"worldSpace",2);class tt{constructor(){a(this,"enabled"),a(this,"space",0),a(this,"orbitalX"),a(this,"orbitalY"),a(this,"orbitalZ"),a(this,"orbitalXMultiplier"),a(this,"orbitalYMultiplier"),a(this,"orbitalZMultiplier"),a(this,"orbitalOffsetX"),a(this,"orbitalOffsetY"),a(this,"orbitalOffsetZ"),a(this,"speedModifier"),a(this,"speedModifierMultiplier"),a(this,"x"),a(this,"xMultiplier"),a(this,"y"),a(this,"yMultiplier"),a(this,"z"),a(this,"zMultiplier"),a(this,"_system"),a(this,"_temp",new x),a(this,"_temp2",new x),a(this,"_temp3",new x),a(this,"_hasOrbital",!1),a(this,"_index",0),a(this,"_orbitalMatrix",new se)}update(t){this._system=t}init(t){this._index==0&&(t.debug=!0),this._index+=1,t.orbitx=this.orbitalX.evaluate(Math.random()),t.orbity=this.orbitalY.evaluate(Math.random()),t.orbitz=this.orbitalZ.evaluate(Math.random()),this._hasOrbital=t.orbitx!=0||t.orbity!=0||t.orbitz!=0}apply(t,i,s,o,r,l,c){var h;if(!this.enabled)return;const d=l/c,u=this.speedModifier.evaluate(d)*this.speedModifierMultiplier,p=this.x.evaluate(d),g=this.y.evaluate(d),y=this.z.evaluate(d);if(this._temp.set(-p,g,y),this._system&&this._system.main.simulationSpace===1&&this._temp.applyQuaternion(this._system.worldQuaternion),this._hasOrbital&&((h=this._system)==null?void 0:h.worldPos)){const f=this._temp2.set(s.x,s.y,s.z),v=this.orbitalXMultiplier,b=this.orbitalYMultiplier,w=this.orbitalZMultiplier,_=u*Math.PI*2*10,S=Math.cos(_*v),R=Math.sin(_*v),M=Math.cos(_*b),T=Math.sin(_*b),L=Math.cos(_*w),D=Math.sin(_*w),U=f.x*(M*L)+f.y*(M*D)+f.z*-T,B=f.x*(R*T*L-S*D)+f.y*(R*T*D+S*L)+f.z*(R*M),Y=f.x*(S*T*L+R*D)+f.y*(S*T*D-R*L)+f.z*(S*M),$=this._temp3.set(f.x-U,f.y-B,f.z-Y);$.normalize(),$.multiplyScalar(.2/r*Math.max(this.orbitalXMultiplier,this.orbitalYMultiplier,this.orbitalZMultiplier)),o.x+=$.x,o.y+=$.y,o.z+=$.z}o.x+=this._temp.x,o.y+=this._temp.y,o.z+=this._temp.z,o.x*=u,o.y*=u,o.z*=u}}P([m()],tt.prototype,"enabled",2),P([m()],tt.prototype,"space",2),P([m(Z)],tt.prototype,"orbitalX",2),P([m(Z)],tt.prototype,"orbitalY",2),P([m(Z)],tt.prototype,"orbitalZ",2),P([m()],tt.prototype,"orbitalXMultiplier",2),P([m()],tt.prototype,"orbitalYMultiplier",2),P([m()],tt.prototype,"orbitalZMultiplier",2),P([m()],tt.prototype,"orbitalOffsetX",2),P([m()],tt.prototype,"orbitalOffsetY",2),P([m()],tt.prototype,"orbitalOffsetZ",2),P([m(Z)],tt.prototype,"speedModifier",2),P([m()],tt.prototype,"speedModifierMultiplier",2),P([m(Z)],tt.prototype,"x",2),P([m()],tt.prototype,"xMultiplier",2),P([m(Z)],tt.prototype,"y",2),P([m()],tt.prototype,"yMultiplier",2),P([m(Z)],tt.prototype,"z",2),P([m()],tt.prototype,"zMultiplier",2);class Gt{constructor(){a(this,"animation"),a(this,"enabled"),a(this,"cycleCount"),a(this,"frameOverTime"),a(this,"frameOverTimeMultiplier"),a(this,"numTilesX"),a(this,"numTilesY"),a(this,"startFrame"),a(this,"startFrameMultiplier"),a(this,"rowMode"),a(this,"rowIndex"),a(this,"spriteCount"),a(this,"timeMode")}sampleOnceAtStart(){if(this.timeMode===0)switch(this.frameOverTime.mode){case 0:case 3:case 2:case 1:return!0}return!1}getStartIndex(){return this.sampleOnceAtStart()?Math.random()*(this.numTilesX*this.numTilesY):0}evaluate(t){if(!this.sampleOnceAtStart())return this.getIndex(t)}getIndex(t){const i=this.numTilesX*this.numTilesY;t=t*this.cycleCount;let s=this.frameOverTime.evaluate(t%1);return s*=this.frameOverTimeMultiplier,s*=i,s=s%i,s=Math.floor(s),s}}P([m()],Gt.prototype,"animation",2),P([m()],Gt.prototype,"enabled",2),P([m()],Gt.prototype,"cycleCount",2),P([m(Z)],Gt.prototype,"frameOverTime",2),P([m()],Gt.prototype,"frameOverTimeMultiplier",2),P([m()],Gt.prototype,"numTilesX",2),P([m()],Gt.prototype,"numTilesY",2),P([m(Z)],Gt.prototype,"startFrame",2),P([m()],Gt.prototype,"startFrameMultiplier",2),P([m()],Gt.prototype,"rowMode",2),P([m()],Gt.prototype,"rowIndex",2),P([m()],Gt.prototype,"spriteCount",2),P([m()],Gt.prototype,"timeMode",2);class An{constructor(){a(this,"enabled"),a(this,"separateAxes"),a(this,"x"),a(this,"xMultiplier"),a(this,"y"),a(this,"yMultiplier"),a(this,"z"),a(this,"zMultiplier")}evaluate(t,i){return this.enabled?this.separateAxes?0:this.z.evaluate(t,i)*-1:0}}P([m()],An.prototype,"enabled",2),P([m()],An.prototype,"separateAxes",2),P([m(Z)],An.prototype,"x",2),P([m()],An.prototype,"xMultiplier",2),P([m(Z)],An.prototype,"y",2),P([m()],An.prototype,"yMultiplier",2),P([m(Z)],An.prototype,"z",2),P([m()],An.prototype,"zMultiplier",2);class tn{constructor(){a(this,"enabled"),a(this,"range"),a(this,"separateAxes"),a(this,"x"),a(this,"xMultiplier"),a(this,"y"),a(this,"yMultiplier"),a(this,"z"),a(this,"zMultiplier")}evaluate(t,i){if(!this.enabled)return 0;if(!this.separateAxes){const s=W.lerp(this.range.x,this.range.y,i);return this.z.evaluate(s)*-1}return 0}}P([m()],tn.prototype,"enabled",2),P([m()],tn.prototype,"range",2),P([m()],tn.prototype,"separateAxes",2),P([m(Z)],tn.prototype,"x",2),P([m()],tn.prototype,"xMultiplier",2),P([m(Z)],tn.prototype,"y",2),P([m()],tn.prototype,"yMultiplier",2),P([m(Z)],tn.prototype,"z",2),P([m()],tn.prototype,"zMultiplier",2);class gt{constructor(){a(this,"enabled"),a(this,"dampen"),a(this,"drag"),a(this,"dragMultiplier"),a(this,"limit"),a(this,"limitMultiplier"),a(this,"separateAxes"),a(this,"limitX"),a(this,"limitXMultiplier"),a(this,"limitY"),a(this,"limitYMultiplier"),a(this,"limitZ"),a(this,"limitZMultiplier"),a(this,"multiplyDragByParticleSize",!1),a(this,"multiplyDragByParticleVelocity",!1),a(this,"space"),a(this,"_temp",new x),a(this,"_temp2",new x)}apply(t,i,s,o,r,l,c){if(this.enabled){const h=this.limit.evaluate(r)*this.limitMultiplier;if(i.length()>h){this._temp.copy(i).normalize().multiplyScalar(h);const d=this.dampen*.5;i.x=W.lerp(i.x,this._temp.x,d),i.y=W.lerp(i.y,this._temp.y,d),i.z=W.lerp(i.z,this._temp.z,d),s.x=W.lerp(s.x,this._temp.x,d),s.y=W.lerp(s.y,this._temp.y,d),s.z=W.lerp(s.z,this._temp.z,d)}}}}P([m()],gt.prototype,"enabled",2),P([m()],gt.prototype,"dampen",2),P([m(Z)],gt.prototype,"drag",2),P([m()],gt.prototype,"dragMultiplier",2),P([m(Z)],gt.prototype,"limit",2),P([m()],gt.prototype,"limitMultiplier",2),P([m()],gt.prototype,"separateAxes",2),P([m(Z)],gt.prototype,"limitX",2),P([m()],gt.prototype,"limitXMultiplier",2),P([m(Z)],gt.prototype,"limitY",2),P([m()],gt.prototype,"limitYMultiplier",2),P([m(Z)],gt.prototype,"limitZ",2),P([m()],gt.prototype,"limitZMultiplier",2),P([m()],gt.prototype,"multiplyDragByParticleSize",2),P([m()],gt.prototype,"multiplyDragByParticleVelocity",2),P([m()],gt.prototype,"space",2);const i1=class{constructor(){a(this,"enabled"),a(this,"curve"),a(this,"curveMultiplier"),a(this,"mode"),a(this,"system"),a(this,"_temp",new x),a(this,"_firstUpdate",!0),a(this,"_frames",0)}clone(){var n;const t=new i1;return t.enabled=this.enabled,t.curve=(n=this.curve)==null?void 0:n.clone(),t.curveMultiplier=this.curveMultiplier,t.mode=this.mode,t}get _lastWorldPosition(){return this.system._iv_lastWorldPosition||(this.system._iv_lastWorldPosition=new x),this.system._iv_lastWorldPosition}get _velocity(){return this.system._iv_velocity||(this.system._iv_velocity=new x),this.system._iv_velocity}awake(n){this.system=n,this.reset()}reset(){this._firstUpdate=!0}update(n){this.enabled&&this.system.worldspace!==!1&&(this._firstUpdate?(this._firstUpdate=!1,this._velocity.set(0,0,0),this._lastWorldPosition.copy(this.system.worldPos)):this._lastWorldPosition&&(this._velocity.copy(this.system.worldPos).sub(this._lastWorldPosition).multiplyScalar(1/this.system.deltaTime),this._lastWorldPosition.copy(this.system.worldPos)))}applyInitial(n){if(this.enabled&&this.system.worldspace!==!1&&this.mode===0){const t=this.curve.evaluate(Math.random(),Math.random());this._temp.copy(this._velocity).multiplyScalar(t),n.x+=this._temp.x,n.y+=this._temp.y,n.z+=this._temp.z}}applyCurrent(n,t,i){if(this.enabled&&this.system&&this.system.worldspace!==!1&&this.mode===1){const s=this.curve.evaluate(t,i);this._temp.copy(this._velocity).multiplyScalar(s),n.x+=this._temp.x,n.y+=this._temp.y,n.z+=this._temp.z}}};let Yr=i1;P([m()],Yr.prototype,"enabled",2),P([m(Z)],Yr.prototype,"curve",2),P([m()],Yr.prototype,"curveMultiplier",2),P([m()],Yr.prototype,"mode",2);class vi{constructor(){a(this,"enabled"),a(this,"range"),a(this,"separateAxes"),a(this,"size"),a(this,"sizeMultiplier"),a(this,"x"),a(this,"xMultiplier"),a(this,"y"),a(this,"yMultiplier"),a(this,"z"),a(this,"zMultiplier")}evaluate(t,i,s,o){const r=t.length(),l=W.remap(r,this.range.x,this.range.y,0,1),c=this.size.evaluate(l,s);return o.x*=c,o.y*=c,o.z*=c,o}}P([m()],vi.prototype,"enabled",2),P([m(re)],vi.prototype,"range",2),P([m()],vi.prototype,"separateAxes",2),P([m(Z)],vi.prototype,"size",2),P([m()],vi.prototype,"sizeMultiplier",2),P([m(Z)],vi.prototype,"x",2),P([m()],vi.prototype,"xMultiplier",2),P([m(Z)],vi.prototype,"y",2),P([m()],vi.prototype,"yMultiplier",2),P([m(Z)],vi.prototype,"z",2),P([m()],vi.prototype,"zMultiplier",2);class Ml{constructor(){a(this,"enabled"),a(this,"range"),a(this,"color")}evaluate(t,i,s){const o=t.length(),r=W.remap(o,this.range.x,this.range.y,0,1),l=this.color.evaluate(r,i);s.x*=l.r,s.y*=l.g,s.z*=l.b,"alpha"in l&&(s.w*=l.alpha)}}P([m()],Ml.prototype,"enabled",2),P([m(re)],Ml.prototype,"range",2),P([m(yi)],Ml.prototype,"color",2),new x(1,1,1),new x(0,0,1);class U0{constructor(t,i,s,o){a(this,"type","NeedleParticleSubEmitter"),a(this,"emitterType"),a(this,"emitterProbability"),a(this,"q_",new V),a(this,"v_",new x),a(this,"v2_",new x),a(this,"_emitterMatrix",new bm),a(this,"_circularBuffer"),this.system=t,this.particleSystem=i,this.subSystem=s,this.subParticleSystem=o,this.subParticleSystem&&this.subParticleSystem&&(this.subParticleSystem.onlyUsedByOther=!0);const r=1e3;this._circularBuffer=new Oi(()=>new bm,r)}clone(){throw new Error("Method not implemented.")}initialize(t){t.emissionState={burstIndex:0,burstWaveIndex:0,time:0,waitEmiting:0},this._emitterMatrix.copy(this.subSystem.matrixWorld).invert().premultiply(this.system.matrixWorld),this._emitterMatrix.setPosition(0,0,0),this.emitterType===N0.Birth&&this.run(t)}update(t,i){this.run(t)}frameUpdate(t){}toJSON(){}reset(){}run(t){if(this.subSystem.currentParticles>=this.subSystem.main.maxParticles||!this.subParticleSystem||!t.emissionState||this.emitterProbability&&Math.random()>this.emitterProbability)return;const i=this.system.deltaTime;if(this.emitterType===N0.Death){let o=t.life;if(t[Rl]!==void 0&&(o=t[Rl]),!(t.age+i*1.2>=o))return;const r=this.subSystem.main.maxParticles-this.subSystem.currentParticles;t.emissionState.waitEmiting=r}const s=new bm;s.set(1,0,0,t.position.x,0,1,0,t.position.y,0,0,1,t.position.z,0,0,0,1),this.particleSystem.worldSpace||s.multiplyMatrices(this._emitterMatrix,s),this.subParticleSystem.emit(i,t.emissionState,s)}}var DE=Object.defineProperty,BE=Object.getOwnPropertyDescriptor,qe=(n,t,i,s)=>{for(var o=s>1?void 0:s?BE(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&DE(t,i,o),o};const Vo=C("debugparticles"),FE=C("noprogressive"),zE=C("debugprogressive");var N0=(n=>(n[n.Birth=0]="Birth",n[n.Collision=1]="Collision",n[n.Death=2]="Death",n[n.Trigger=3]="Trigger",n[n.Manual=4]="Manual",n))(N0||{});class nn extends A{constructor(){super(...arguments),a(this,"renderMode"),a(this,"particleMaterial"),a(this,"trailMaterial"),a(this,"particleMesh"),a(this,"maxParticleSize"),a(this,"minParticleSize"),a(this,"velocityScale"),a(this,"cameraVelocityScale"),a(this,"lengthScale")}start(){if(this.maxParticleSize!==.5&&this.minParticleSize!==0&&F()){const t=`ParticleSystem "${this.name}" has non-default min/max particle size. This may not render correctly. Please set min size to 0 and the max size to 0.5 and use the "StartSize" setting instead`;console.warn(t)}}get transparent(){var t;return((t=this.particleMaterial)==null?void 0:t.transparent)??!1}getMaterial(t=!1){let i=t===!0&&this.trailMaterial?this.trailMaterial:this.particleMaterial;if(i){if(i.type==="MeshStandardMaterial"){Vo&&console.debug("ParticleSystemRenderer.getMaterial: MeshStandardMaterial detected, converting to MeshBasicMaterial. See https://github.com/Alchemist0823/three.quarks/issues/101"),"map"in i&&i.map&&(i.map.colorSpace=rr,i.map.premultiplyAlpha=!1);const s=new Re;s.copy(i),t?this.trailMaterial=s:this.particleMaterial=s}i.map&&(i.map.colorSpace=rr,i.map.premultiplyAlpha=!1),t&&i.side===ro&&(i=i.clone(),i.side=cd,t?this.trailMaterial=i:this.particleMaterial=i)}return i&&!FE&&i._didRequestTextureLOD===void 0&&(i._didRequestTextureLOD=0,zE&&console.log("Load material LOD",i.name),it.assignTextureLOD(i,0)),i}getMesh(t){let i=null;if(!i&&(this.particleMesh instanceof X&&(i=this.particleMesh.geometry),i===null)){i=new zn(1,1);const s=i.attributes.uv;for(let o=0;o<s.count;o++)s.setX(o,1-s.getX(o))}return new X(i,this.getMaterial())}}qe([m()],nn.prototype,"renderMode",2),qe([m(ke)],nn.prototype,"particleMaterial",2),qe([m(ke)],nn.prototype,"trailMaterial",2),qe([m()],nn.prototype,"maxParticleSize",2),qe([m()],nn.prototype,"minParticleSize",2),qe([m()],nn.prototype,"velocityScale",2),qe([m()],nn.prototype,"cameraVelocityScale",2),qe([m()],nn.prototype,"lengthScale",2);class Cp{constructor(t,i=1){a(this,"_curve"),a(this,"_factor"),a(this,"type","function"),this._curve=t,this._factor=i}startGen(t){}genValue(t,i){return this._curve.evaluate(i,Math.random())*this._factor}toJSON(){throw new Error("Method not implemented.")}clone(){throw new Error("Method not implemented.")}}class W0{constructor(t){a(this,"type","value"),a(this,"system"),this.system=t}toJSON(){throw new Error("Method not implemented.")}clone(){throw new Error("Method not implemented.")}startGen(t){}}class UE extends W0{genValue(){return this.system.textureSheetAnimation.getStartIndex()}}class NE extends W0{constructor(){super(...arguments),a(this,"_lastPosition",new x),a(this,"_lastDistance",0)}update(){const t=te(this.system.gameObject);this._lastDistance=this._lastPosition.distanceTo(t),this._lastPosition.copy(t)}genValue(){if(!this.system.isPlaying||!this.system.emission.enabled||this.system.currentParticles>=this.system.maxParticles)return 0;let t=this.system.emission.rateOverTime.evaluate(this.system.time/this.system.duration,Math.random());if(this.system.deltaTime>0){const o=this.system.emission.rateOverDistance.evaluate(this.system.time/this.system.duration,Math.random());let r=this._lastDistance/this.system.deltaTime*o;Number.isFinite(r)||(r=0),t+=r}const i=this.system.emission.getBurst();i>0&&(t+=i/this.system.deltaTime);const s=this.system.maxParticles-this.system.currentParticles;return W.clamp(t,0,s/this.system.deltaTime)}}class WE extends W0{genValue(){return this.system.isPlaying,0}}class Ho{constructor(t){a(this,"system"),a(this,"type"),this.type=Object.getPrototypeOf(this).constructor.name||"ParticleSystemBaseBehaviour",t&&(this.system=t)}get context(){return this.system.context}initialize(t){}update(t,i){}frameUpdate(t){}toJSON(){throw new Error("Method not implemented.")}clone(){throw new Error("Method not implemented.")}reset(){}}class VE extends Ho{constructor(){super(...arguments),a(this,"type","NeedleTextureSheet")}update(t,i){const s=this.system.textureSheetAnimation;if(s.enabled){const o=t.age/t.life,r=s.evaluate(o);r!==void 0&&(t.uvTile=r)}}}const n1=Symbol("particleRotation");class HE extends Ho{constructor(){super(...arguments),a(this,"type","NeedleRotation")}initialize(t){t[n1]=Math.random()}update(t,i){if(t.rotation===void 0)return;const s=t.age/t.life;if(typeof t.rotation=="number"&&(this.system.rotationOverLifetime.enabled?t.rotation+=this.system.rotationOverLifetime.evaluate(s,t[n1])*i:this.system.renderer.renderMode===Hs.Billboard&&(t.rotation=Math.PI),this.system.rotationBySpeed.enabled)){const o=t.velocity.length();t.rotation+=this.system.rotationBySpeed.evaluate(s,o)*i}}}const s1=Symbol("sizeLerpFactor"),$E=new x;class GE extends Ho{constructor(){super(...arguments),a(this,"type","NeedleSize"),a(this,"_minSize",0),a(this,"_maxSize",1)}initialize(t){t[s1]=Math.random(),this._minSize=this.system.renderer.minParticleSize,this._maxSize=this.system.renderer.maxParticleSize}update(t,i){const s=t.age/t.life;let o=1;this.system.sizeOverLifetime.enabled&&(o*=this.system.sizeOverLifetime.evaluate(s,void 0,t[s1]).x);let r=1;this.system.renderer.renderMode!==Hs.Mesh&&(r=this.system.worldScale.x/this.system.cameraScale);const l=q(t.startSize).multiplyScalar(o*r);if(t.size.set(l.x,l.y,l.z),this.system.localspace){const c=c1(this.system,$E);t.size.x*=c.x,t.size.y*=c.y,t.size.z*=c.z}}}const Rl=Symbol("particleLife"),V0=Symbol("trailLifetime"),o1=Symbol("trailStartLength"),H0=Symbol("trailWidthRandom");class qE extends Ho{constructor(){super(...arguments),a(this,"type","NeedleTrail")}initialize(t){t instanceof dv&&(t[Rl]=t.life,this.system.trails.enabled&&this.system.trails.dieWithParticles===!1&&(t[V0]=this.system.trails.lifetime.evaluate(Math.random(),Math.random()),t.life+=t[V0]),t[o1]=t.length,t[H0]=Math.random())}update(t){var i;if((i=this.system.trails)!=null&&i.enabled&&t instanceof dv){const s=t,o=t.age/t[Rl],r=t.previous.values(),l=t.previous.length;for(let c=0;c<l;c++){const h=r.next().value,d=1-c/(l-1),u=t.size;if(u.x<=0&&!this.system.trails.sizeAffectsWidth){const p=20*this.system.trails.widthOverTrail.evaluate(.5,s[H0]);u.x=p,u.y=p,u.z=p}h.size=this.system.trails.getWidth(u.x,o,d,s[H0]),h.color.copy(t.color),this.system.trails.getColor(h.color,o,d)}if(t.age>t[Rl]){t.velocity.set(0,0,0);const c=(t.age-t[Rl])/t[V0];s.length=W.lerp(t[o1],0,c)}}}}const Op=Symbol("startVelocity"),r1=Symbol("gravityModifier"),$0=Symbol("gravitySpeed"),Pp=Symbol("velocity lerp factor"),G0=new x;class XE extends Ho{constructor(){super(...arguments),a(this,"type","NeedleVelocity"),a(this,"_gravityDirection",new x)}initialize(t){var i,s;const o=this.system.main.simulationSpeed;t.startSpeed=this.system.main.startSpeed.evaluate(Math.random(),Math.random());const r=this.system.shape.getDirection(t,t.position);t.velocity.x=r.x*t.startSpeed,t.velocity.y=r.y*t.startSpeed,t.velocity.z=r.z*t.startSpeed,(i=this.system.inheritVelocity)!=null&&i.enabled&&this.system.inheritVelocity.applyInitial(t.velocity),t[Op]?t[Op].copy(t.velocity):t[Op]=t.velocity.clone();const l=this.system.main.gravityModifier.evaluate(Math.random(),Math.random());t[r1]=l*o,t[$0]=l*o*.5,t[Pp]=Math.random(),(s=this.system.velocityOverLifetime)==null||s.init(t),this._gravityDirection.set(0,-1,0),this.system.main.simulationSpace===xh.Local&&this._gravityDirection.applyQuaternion(this.system.worldQuaternionInverted).normalize()}update(t,i){var s;const o=t[Op],r=t[r1];if(r!==0){const g=r*t[$0];G0.copy(this._gravityDirection).multiplyScalar(g),t[$0]+=i*.05,o.add(G0)}t.velocity.copy(o);const l=t.age/t.life;(s=this.system.inheritVelocity)!=null&&s.enabled&&this.system.inheritVelocity.applyCurrent(t.velocity,l,t[Pp]);const c=this.system.noise;c.enabled&&c.apply(0,t.position,t.velocity,i,t.age,t.life);const h=this.system.sizeBySpeed;h!=null&&h.enabled&&(t.size=h.evaluate(t.velocity,l,t[Pp],t.size));const d=this.system.colorBySpeed;d!=null&&d.enabled&&d.evaluate(t.velocity,t[Pp],t.color);const u=this.system.velocityOverLifetime;u.enabled&&u.apply(t,0,t.position,t.velocity,i,t.age,t.life);const p=this.system.limitVelocityOverLifetime;if(p.enabled&&p.apply(t.position,o,t.velocity,t.size,l,i,1),this.system.worldspace){const g=this.system.worldScale;t.velocity.x*=g.x,t.velocity.y*=g.y,t.velocity.z*=g.z}}}const a1=Symbol("colorLerpFactor"),l1=new xe(1,1,1,1),Zr=new xe(1,1,1,1);class QE extends Ho{constructor(){super(...arguments),a(this,"type","NeedleColor")}initialize(t){}_init(t){const i=this.system.renderer.particleMaterial;Zr.copy(this.system.main.startColor.evaluate(Math.random())),i!=null&&i.color&&(l1.copy(i.color),Zr.multiply(l1)),Zr.convertLinearToSRGB(),t.startColor.set(Zr.r,Zr.g,Zr.b,Zr.alpha),t.color.copy(t.startColor),t[a1]=Math.random()}update(t,i){if(t.age===0&&this._init(t),this.system.colorOverLifetime.enabled){const s=t.age/t.life,o=this.system.colorOverLifetime.color.evaluate(s,t[a1]);t.color.set(o.r,o.g,o.b,"alpha"in o?o.alpha:1).multiply(t.startColor)}else t.color.copy(t.startColor)}}class YE{constructor(t){a(this,"system"),a(this,"emission"),a(this,"autoDestroy"),a(this,"startLength"),a(this,"emissionBursts"),a(this,"onlyUsedByOther"),a(this,"behaviors",[]),a(this,"rendererEmitterSettings",{startLength:new lO(220),followLocalOrigin:!1}),a(this,"flatWhiteTexture"),a(this,"clonedTexture",{original:void 0,clone:void 0}),this.system=t,this.emission=new NE(this.system)}get anim(){return this.system.textureSheetAnimation}get prewarm(){return!1}get material(){return this.system.renderer.getMaterial(this.system.trails.enabled)}get layers(){return this.system.gameObject.layers}update(){this.emission.update()}get looping(){return this.system.main.loop}get duration(){return this.system.duration}get shape(){return this.system.shape}get startLife(){return new Cp(this.system.main.startLifetime)}get startSpeed(){return new Cp(this.system.main.startSpeed)}get startRotation(){return new Cp(this.system.main.startRotation)}get startSize(){return new Cp(this.system.main.startSize)}get startColor(){return new rO(new aO(1,1,1,1))}get emissionOverTime(){return this.emission}get emissionOverDistance(){return new WE(this.system)}get instancingGeometry(){return this.system.renderer.getMesh(this.system.renderer.renderMode).geometry}get renderMode(){if(this.system.trails.enabled===!0)return bs.Trail;switch(this.system.renderer.renderMode){case Hs.Billboard:return bs.BillBoard;case Hs.Stretch:return bs.StretchedBillBoard;case Hs.HorizontalBillboard:return bs.HorizontalBillBoard;case Hs.VerticalBillboard:return bs.VerticalBillBoard;case Hs.Mesh:return bs.Mesh}return bs.BillBoard}get speedFactor(){var t;let i=this.system.main.simulationSpeed;return((t=this.system.renderer)==null?void 0:t.renderMode)===Hs.Stretch&&(i*=this.system.renderer.velocityScale??1),i}get texture(){const t=this.material;if(t&&t.map){const i=t.map;if(this.clonedTexture.original!==i||!this.clonedTexture.clone){const s=i.clone();s.premultiplyAlpha=!1,s.colorSpace=rr,this.clonedTexture.original=i,this.clonedTexture.clone=s}return this.clonedTexture.clone}return this.flatWhiteTexture||(this.flatWhiteTexture=qg(new xe(1,1,1,1),1)),this.flatWhiteTexture}get startTileIndex(){return new UE(this.system)}get uTileCount(){var t;return this.anim.enabled?(t=this.anim)==null?void 0:t.numTilesX:void 0}get vTileCount(){var t;return this.anim.enabled?(t=this.anim)==null?void 0:t.numTilesY:void 0}get renderOrder(){return 1}get blending(){var t;return((t=this.system.renderer.particleMaterial)==null?void 0:t.blending)??vC}get transparent(){return this.system.renderer.transparent}get worldSpace(){return this.system.main.simulationSpace===xh.World}}class ZE{constructor(){a(this,"burstParticleIndex",0),a(this,"burstParticleCount",0),a(this,"isBursting",!1),a(this,"travelDistance",0),a(this,"previousWorldPos"),a(this,"burstIndex",0),a(this,"burstWaveIndex",0),a(this,"time",0),a(this,"waitEmiting",0)}}const kp=class extends A{constructor(){super(...arguments),a(this,"_state"),a(this,"colorOverLifetime"),a(this,"main"),a(this,"emission"),a(this,"sizeOverLifetime"),a(this,"shape"),a(this,"noise"),a(this,"trails"),a(this,"velocityOverLifetime"),a(this,"limitVelocityOverLifetime"),a(this,"inheritVelocity"),a(this,"colorBySpeed"),a(this,"textureSheetAnimation"),a(this,"rotationOverLifetime"),a(this,"rotationBySpeed"),a(this,"sizeBySpeed"),a(this,"_cameraScale",1),a(this,"__worldQuaternion",new V),a(this,"_worldQuaternionInverted",new V),a(this,"_worldScale",new x),a(this,"_worldPositionFrame",-1),a(this,"_worldPos",new x),a(this,"_renderer"),a(this,"_batchSystem"),a(this,"_particleSystem"),a(this,"_interface"),a(this,"_container"),a(this,"_time",0),a(this,"_isPlaying",!0),a(this,"_isUsedAsSubsystem",!1),a(this,"_didPreWarm",!1),a(this,"_bursts"),a(this,"_subEmitterSystems"),a(this,"_lastBatchesCount",-1)}play(n=!1){var t;n&&O.foreachComponent(this.gameObject,i=>{i instanceof kp&&i!==this&&i.play(!1)},!0),this._isPlaying=!0,this._particleSystem&&(this._particleSystem.emissionState.time=0,this._particleSystem.emitEnded=!1),(t=this.emission)==null||t.reset()}pause(n=!0){n&&O.foreachComponent(this.gameObject,t=>{t instanceof kp&&t!==this&&t.pause(!1)},!0),this._isPlaying=!1}stop(n=!0,t=!1){n&&O.foreachComponent(this.gameObject,i=>{i instanceof kp&&i!==this&&i.stop(!1,t)},!0),this._isPlaying=!1,this._time=0,t&&this.reset()}reset(){var n;this._time=0,this._particleSystem&&(this._particleSystem.particleNum=0,this._particleSystem.emissionState.time=0,this._particleSystem.emitEnded=!1,(n=this.emission)==null||n.reset())}emit(n){if(this._particleSystem){this.onUpdate(),n=Math.min(n,this.maxParticles-this.currentParticles),this._state||(this._state=new ZE),this._state.waitEmiting=n,this._state.time=0;const t=this._particleSystem.emitEnded;this._particleSystem.emitEnded=!1,this._particleSystem.emit(this.deltaTime,this._state,this._particleSystem.emitter.matrixWorld),this._particleSystem.emitEnded=t}}get playOnAwake(){return this.main.playOnAwake}set playOnAwake(n){this.main.playOnAwake=n}get renderer(){return this._renderer}get isPlaying(){return this._isPlaying}get currentParticles(){var n;return((n=this._particleSystem)==null?void 0:n.particleNum)??0}get maxParticles(){return this.main.maxParticles}get time(){return this._time}get duration(){return this.main.duration}get deltaTime(){return this.context.time.deltaTime*this.main.simulationSpeed}get scale(){return this.gameObject.scale.x}get cameraScale(){return this._cameraScale}get container(){return this._container}get worldspace(){return this.main.simulationSpace===xh.World}get localspace(){return this.main.simulationSpace===xh.Local}get worldQuaternion(){return this.__worldQuaternion}get worldQuaternionInverted(){return this._worldQuaternionInverted}get worldScale(){return this._worldScale}get worldPos(){return this._worldPositionFrame!==this.context.time.frame&&(this._worldPositionFrame=this.context.time.frame,te(this.gameObject,this._worldPos)),this._worldPos}get matrixWorld(){return this._container.matrixWorld}get isSubsystem(){return this._isUsedAsSubsystem}addBehaviour(n){return this._particleSystem?(n instanceof Ho&&(n.system=this),Vo&&console.debug("Add custom ParticleSystem Behaviour",n),this._particleSystem.addBehavior(n),!0):!1}removeBehaviour(n){if(!this._particleSystem)return!1;const t=this._particleSystem.behaviors,i=t.indexOf(n);return i!==-1&&((F()||Vo)&&console.debug("Remove custom ParticleSystem Behaviour",i,n),t.splice(i,1)),!0}removeAllBehaviours(){return this._particleSystem?(this._particleSystem.behaviors.length=0,!0):!1}get behaviours(){return this._particleSystem?this._particleSystem.behaviors:null}get particleSystem(){return this._particleSystem??null}set bursts(n){for(let t=0;t<n.length;t++){const i=n[t];if(!(i instanceof wp)){const s=new wp;Aa(s,i),n[t]=s}}this._bursts=n}set subEmitterSystems(n){for(let t=0;t<n.length;t++){const i=n[t];if(!(i instanceof Mp)){const s=new Mp;Aa(s,i),n[t]=s}}Vo&&n.length>0&&console.log("SubEmitters: ",n,this),this._subEmitterSystems=n}onAfterDeserialize(n){if(this._subEmitterSystems&&Array.isArray(this._subEmitterSystems))for(const t of this._subEmitterSystems)t._deserialize(this.context,this.gameObject)}awake(){if(this._worldPositionFrame=-1,this._renderer=this.gameObject.getComponent(nn),!this.main)throw new Error("Not Supported: ParticleSystem needs a serialized MainModule. Creating new particle systems at runtime is currently not supported.");this._container=new j,this._container.matrixAutoUpdate=!1,this.context.scene.add(this._container),this._batchSystem=new sO,this._batchSystem.name=this.gameObject.name,this._container.add(this._batchSystem),this._interface=new YE(this),this._particleSystem=new oO(this._interface),this._particleSystem.addBehavior(new GE(this)),this._particleSystem.addBehavior(new QE(this)),this._particleSystem.addBehavior(new VE(this)),this._particleSystem.addBehavior(new HE(this)),this._particleSystem.addBehavior(new XE(this)),this._particleSystem.addBehavior(new qE(this)),this._batchSystem.addSystem(this._particleSystem);const n=this._particleSystem.emitter;this.context.scene.add(n),this.inheritVelocity.system&&this.inheritVelocity.system!==this&&(this.inheritVelocity=this.inheritVelocity.clone()),this.inheritVelocity.awake(this),Vo&&(console.log(this),this.gameObject.add(new Si(1)))}start(){this.addSubParticleSystems(),this.updateLayers(),this.renderer.particleMesh instanceof X&&this._interface.renderMode==bs.Mesh&&it.assignMeshLOD(this.renderer.particleMesh,0).then(n=>{n&&this.particleSystem&&this._interface.renderMode==bs.Mesh&&(this.particleSystem.instancingGeometry=n)})}onDestroy(){var n,t,i,s;(n=this._container)==null||n.removeFromParent(),(t=this._batchSystem)==null||t.removeFromParent(),(i=this._particleSystem)==null||i.emitter.removeFromParent(),(s=this._particleSystem)==null||s.dispose()}onEnable(){this.main&&(this.inheritVelocity&&(this.inheritVelocity.system=this),this._batchSystem&&(this._batchSystem.visible=!0),this.playOnAwake&&this.play(),this._isPlaying=this.playOnAwake)}onDisable(){this._batchSystem&&(this._batchSystem.visible=!1)}onBeforeRender(){var n;this.main&&(this._didPreWarm===!1&&((n=this.main)==null?void 0:n.prewarm)===!0&&(this._didPreWarm=!0,this.preWarm()),this.onUpdate(),this.onSimulate(this.deltaTime))}preWarm(){var n;if(!((n=this.emission)!=null&&n.enabled)||this.emission.rateOverTime.getMax()<=0)return;const t=1/60,i=this.main.duration,s=this.main.startLifetime.getMax(),o=1e3,r=Math.min(Math.max(i,s)/Math.max(.01,this.main.simulationSpeed),o),l=Math.ceil(r/t),c=Date.now();Vo&&console.log(`Particles ${this.name} - Prewarm for ${l} frames (${r} sec). Duration: ${i}, Lifetime: ${s}`);for(let h=0;h<l&&!(this.currentParticles>=this.maxParticles);h++){const d=Date.now()-c;if(d>2e3){console.warn(`Particles ${this.name} - Prewarm took too long. Aborting: ${d}`);break}this.onUpdate(),this.onSimulate(t)}}onSimulate(n){if(this._batchSystem){let t=this.context.time.frameCount%60===0;this._lastBatchesCount!==this._batchSystem.batches.length&&(this._lastBatchesCount=this._batchSystem.batches.length,t=!0),t&&this.updateLayers(),this._batchSystem.update(n)}this._time+=n,this._time>this.duration&&(this._time=0)}updateLayers(){if(this._batchSystem)for(let n=0;n<this._batchSystem.batches.length;n++){const t=this._batchSystem.batches[n];t.layers.disableAll();const i=this.layer;t.layers.mask=1<<i}}onUpdate(){var n,t;if(this._bursts&&(this.emission.bursts=this._bursts,delete this._bursts),!this._isPlaying)return;const i=this.context.mainCamera;if(i){const r=Ye(i);this._cameraScale=r.x}const s=!this.worldspace,o=this.gameObject;if(Ce(o,this.__worldQuaternion),this._worldQuaternionInverted.copy(this.__worldQuaternion).invert(),Ye(this.gameObject,this._worldScale),s&&this._container&&(n=this.gameObject)!=null&&n.parent){const r=c1(this,G0);this._container.matrix.makeScale(r.x,r.y,r.z),this._container.matrix.makeRotationFromQuaternion(this.__worldQuaternion),this._container.matrix.setPosition(this.worldPos),this._container.matrix.scale(this.gameObject.scale)}this.emission.system=this,this._interface.update(),this.shape.onUpdate(this,this.context,this.main.simulationSpace,this.gameObject),this.noise.update(this.context),(t=this.inheritVelocity)==null||t.update(this.context),this.velocityOverLifetime.update(this)}addSubParticleSystems(){var n;if(this._subEmitterSystems&&this._particleSystem)for(const t of this._subEmitterSystems){t.particleSystem&&(t.particleSystem.__internalAwake?t.particleSystem.__internalAwake():F()&&console.warn("SubParticleSystem serialization issue(?)",t.particleSystem,t));const i=(n=t.particleSystem)==null?void 0:n._particleSystem;if(i){t.particleSystem._isUsedAsSubsystem=!0;const s=new U0(this,this._particleSystem,t.particleSystem,i);s.emitterType=t.type,s.emitterProbability=t.emitProbability,this._particleSystem.addBehavior(s)}else Vo&&console.warn("Could not add SubParticleSystem",t,this)}}};let ct=kp;qe([m(xp)],ct.prototype,"colorOverLifetime",2),qe([m($t)],ct.prototype,"main",2),qe([m($s)],ct.prototype,"emission",2),qe([m(Qr)],ct.prototype,"sizeOverLifetime",2),qe([m(et)],ct.prototype,"shape",2),qe([m(Pe)],ct.prototype,"noise",2),qe([m(Ge)],ct.prototype,"trails",2),qe([m(tt)],ct.prototype,"velocityOverLifetime",2),qe([m(gt)],ct.prototype,"limitVelocityOverLifetime",2),qe([m(Yr)],ct.prototype,"inheritVelocity",2),qe([m(Ml)],ct.prototype,"colorBySpeed",2),qe([m(Gt)],ct.prototype,"textureSheetAnimation",2),qe([m(An)],ct.prototype,"rotationOverLifetime",2),qe([m(tn)],ct.prototype,"rotationBySpeed",2),qe([m(vi)],ct.prototype,"sizeBySpeed",2);class Mp{constructor(){a(this,"particleSystem"),a(this,"emitProbability",1),a(this,"properties"),a(this,"type")}_deserialize(t,i){const s=this.particleSystem;if(s instanceof ct)return;let o="";s&&typeof s.guid=="string"&&(o=s.guid,this.particleSystem=O.findByGuid(o,i)),Vo&&!(this.particleSystem instanceof ct)&&console.warn("Could not find particle system for sub emitter",o,i,this)}}function c1(n,t){if(t.set(1,1,1),n.gameObject.parent&&n.localspace)switch(n.main.scalingMode){case z0.Local:t=Ye(n.gameObject.parent,t),t.x=1/t.x,t.y=1/t.y,t.z=1/t.z;break;default:if(!n.unsupported_scaling_mode){n.unsupported_scaling_mode=!0;const i="ParticleSystem scale mode "+z0[n.main.scalingMode]+" is not supported";F()&&we(i),console.warn(i,n.name,n)}t=Ye(n.gameObject,t);break}return t}class Vl extends A{constructor(){super(...arguments),a(this,"_didAssignPlayerColor",!1),a(this,"tryAssignColor",()=>{const t=O.getComponentInParent(this.gameObject,ji);if(t&&t.owner)return this._didAssignPlayerColor=!0,this.assignUserColor(t.owner),!0;const i=O.getComponentInParent(this.gameObject,Rt);return i!=null&&i.connectionId?(this._didAssignPlayerColor=!0,this.assignUserColor(i.connectionId),!0):!1})}onEnable(){this.context.connection.beginListen(ne.JoinedRoom,this.tryAssignColor),this._didAssignPlayerColor||this.startCoroutine(this.waitForConnection())}onDisable(){this.context.connection.stopListen(ne.JoinedRoom,this.tryAssignColor)}*waitForConnection(){for(;!this.destroyed&&this.activeAndEnabled&&(yield $g(.2),!this.tryAssignColor()););}assignUserColor(t){const i=Vl.hashCode(t),s=Vl.colorFromHashCode(i);if(this.gameObject.type==="Mesh"){const o=this.gameObject;this.assignColor(s,t,o)}else if(this.gameObject.children)for(const o of this.gameObject.children){const r=o;r.material&&r.material.color&&this.assignColor(s,t,r)}}assignColor(t,i,s){let o=s.material;o&&(o._playerMaterial!==i&&(o=o.clone(),o._playerMaterial=i,s.material=o),o.color=t)}static hashCode(t){var i=0,s,o;if(t.length===0)return i;for(s=0;s<t.length;s++)o=t.charCodeAt(s),i=(i<<5)-i+o,i|=0;return i}static colorFromHashCode(t){const i=(t&16711680)>>16,s=(t&65280)>>8,o=t&255;return new ae(i/255,s/255,o/255)}}const KE=C("debugpost");let q0=null;function JE(n){q0=n}function h1(n){let t=n.gameObject;for(;t;){for(const i of Kd(t))if(i.isPostProcessingManager===!0)return i;t=t.parent}return null}function eA(n){let t=h1(n);if(!t)if(q0){KE&&console.warn("Adding postprocessing manager to the scene.");const i=n.scene;t=Ri(i,q0)}else F()&&console.warn("No post processing manager found");return t}var tA=Object.defineProperty,iA=Object.getOwnPropertyDescriptor,d1=(n,t,i,s)=>{for(var o=s>1?void 0:s?iA(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&tA(t,i,o),o};const nA=C("debugpost");class N{constructor(t){a(this,"isVolumeParameter",!0),a(this,"_isInitialized",!1),a(this,"_active",!0),a(this,"_value"),a(this,"_valueRaw"),a(this,"_defaultValue"),a(this,"valueProcessor"),a(this,"onValueChanged"),t!==void 0&&this.initialize(t)}get isInitialized(){return this._isInitialized}initialize(t){t!==void 0&&(this._value=t,this._defaultValue=t,this._valueRaw=t,this._isInitialized=!0)}get overrideState(){return this._active}set overrideState(t){if(this._active===t)return;this._active=t;const i=t?this._valueRaw:this._defaultValue;this.processValue(i,!0)}get value(){return this._valueRaw}set value(t){this.isInitialized||this.initialize(t),this.processValue(t,!1)}set defaultValue(t){this._defaultValue=t}__init(){this.processValue(this._valueRaw,!0)}processValue(t,i){if(t==null||!i&&this.testIfValueChanged(t)===!1)return;const s=this._value;nA&&typeof s=="number"&&typeof t=="number"&&(s?.toFixed(4),t?.toFixed(4)),!this._active&&this._defaultValue!==void 0?(this._value=this._defaultValue,t=this._defaultValue,this._valueRaw=t):(this._valueRaw=t,this._active&&this.valueProcessor&&(t=this.valueProcessor(t)),this._value=t),this.onValueChanged&&this.onValueChanged(t,s,this)}testIfValueChanged(t){return this._valueRaw!==t}}d1([m()],N.prototype,"overrideState",1),d1([m()],N.prototype,"value",1);class sA extends Xi{constructor(){super([N])}onSerialize(t,i){}onDeserialize(t,i){const s=i.target,o=i.path;let r;if(s&&o&&(r=s[o]),(typeof r!="object"||typeof r=="object"&&r.isVolumeParameter!==!0)&&(r=new N),typeof t=="object"&&"value"in t){const l=t.value;r.initialize(l),r.overrideState=t.overrideState}else r.value=t;return r}}new sA;var oA=Object.defineProperty,rA=Object.getOwnPropertyDescriptor,aA=(n,t,i,s)=>{for(var o=s>1?void 0:s?rA(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&oA(t,i,o),o};const X0=C("debugpost");class ht extends A{constructor(t=void 0){if(super(),a(this,"active",!0),a(this,"_manager",null),a(this,"_result"),a(this,"_postprocessingContext",null),t)for(const i of Object.keys(t)){const s=t[i],o=this[i];o instanceof N?o.initialize(s):o!==void 0&&(this[i]=s)}}get isPostProcessingEffect(){return!0}onEnable(){super.onEnable(),X0&&console.warn("onEnable effect",this,this.__internalDidAwakeAndStart),this.__internalDidAwakeAndStart&&(this.active=!0),this.onEffectEnabled()}onDisable(){var t;super.onDisable(),X0&&console.warn("onDisable effect",this),(t=this._manager)==null||t.removeEffect(this),this.active=!1}onEffectEnabled(t){var i;t&&t.isPostProcessingManager===!0?this._manager=t:this._manager||(this._manager=eA(this)),(i=this._manager)==null||i.addEffect(this)}init(){}get postprocessingContext(){return this._postprocessingContext}apply(t){var i;return this._postprocessingContext=t,this._result||(this.initParameters(),this._result=(i=this.onCreateEffect)==null?void 0:i.call(this)),this._result&&this.initParameters(),this._result}unapply(){}dispose(){X0&&console.warn("DISPOSE",this),this._result&&(Array.isArray(this._result)?this._result.forEach(t=>t.dispose()):this._result.dispose()),this._result=void 0}initParameters(){const t=Object.keys(this);for(const i of t){const s=this[i];s instanceof N&&s.__init()}}onEditorModification(t){const i=t.propertyName;if(this[i]instanceof N){const s=t.value;return this[i].value=s,!0}}}aA([m()],ht.prototype,"active",2);var lA=Object.defineProperty,cA=Object.getOwnPropertyDescriptor,hA=(n,t,i,s)=>{for(var o=s>1?void 0:s?cA(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&lA(t,i,o),o};const dA=C("debugpost"),Q0={};function sn(n,t){Q0[n]=t}function uA(n){return n.__type in Q0?Q0[n.__type]:(dA&&n.__type&&console.warn("Unknown postprocessing type",n.__type,n),ht)}class Rp{constructor(){a(this,"components",[])}__init(t){var i;(i=this.components)==null||i.forEach(s=>{s.gameObject===void 0&&t.gameObject.addComponent(s),s.init()})}addEffect(t){this.components.push(t)}removeEffect(t){const i=this.components.indexOf(t);i>=0&&this.components.splice(i,1)}}hA([kr([n=>uA(n),ht])],Rp.prototype,"components",2);var pA=Object.defineProperty,mA=Object.getOwnPropertyDescriptor,gA=(n,t,i,s)=>{for(var o=s>1?void 0:s?mA(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&pA(t,i,o),o};class Oh extends ht{constructor(){super(...arguments),a(this,"preset",new N(2))}get typeName(){return"Antialiasing"}onCreateEffect(){const t=new I.POSTPROCESSING.MODULE.SMAAEffect({preset:I.POSTPROCESSING.MODULE.SMAAPreset.HIGH,edgeDetectionMode:I.POSTPROCESSING.MODULE.EdgeDetectionMode.DEPTH});return this.preset.onValueChanged=i=>{t.applyPreset(i)},t}}gA([m(N)],Oh.prototype,"preset",2),sn("Antialiasing",Oh);var fA=Object.defineProperty,yA=Object.getOwnPropertyDescriptor,Y0=(n,t,i,s)=>{for(var o=s>1?void 0:s?yA(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&fA(t,i,o),o},Z0;const u1=(Z0=class extends ht{constructor(){super(...arguments),a(this,"threshold",new N(.9)),a(this,"intensity",new N(1)),a(this,"scatter",new N(.3)),a(this,"selectiveBloom")}get typeName(){return"Bloom"}init(){this.threshold.valueProcessor=n=>n,this.intensity.valueProcessor=n=>n,this.scatter.valueProcessor=n=>n}onCreateEffect(){let n;if(this.selectiveBloom==null&&(this.selectiveBloom=u1.useSelectiveBloom),this.selectiveBloom){const t=n=new I.POSTPROCESSING.MODULE.SelectiveBloomEffect(this.context.scene,this.context.mainCamera,{blendFunction:I.POSTPROCESSING.MODULE.BlendFunction.ADD,mipmapBlur:!0,luminanceThreshold:this.threshold.value,luminanceSmoothing:this.scatter.value,radius:.85,intensity:this.intensity.value});t.inverted=!0}else n=new I.POSTPROCESSING.MODULE.BloomEffect({blendFunction:I.POSTPROCESSING.MODULE.BlendFunction.ADD,mipmapBlur:!0,luminanceThreshold:this.threshold.value,luminanceSmoothing:this.scatter.value,radius:.85,intensity:this.intensity.value});return this.intensity.onValueChanged=t=>{n.intensity=t},this.threshold.onValueChanged=t=>{n.luminanceMaterial.threshold=Math.pow(t,2.2)},this.scatter.onValueChanged=t=>{n.luminancePass.enabled=!0,n.luminanceMaterial.smoothing=t,n.mipmapBlurPass&&(n.mipmapBlurPass.radius=ms.lerp(.1,.9,t))},n}},a(Z0,"useSelectiveBloom",!1),Z0);let Kr=u1;Y0([m(N)],Kr.prototype,"threshold",2),Y0([m(N)],Kr.prototype,"intensity",2),Y0([m(N)],Kr.prototype,"scatter",2),sn("Bloom",Kr);var vA=Object.defineProperty,bA=Object.getOwnPropertyDescriptor,_A=(n,t,i,s)=>{for(var o=s>1?void 0:s?bA(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&vA(t,i,o),o};class Ph extends ht{constructor(){super(...arguments),a(this,"intensity",new N(0))}get typeName(){return"ChromaticAberration"}onCreateEffect(){const t=new I.POSTPROCESSING.MODULE.ChromaticAberrationEffect;return t.offset=new re(0,0),t.radialModulation=!0,t.modulationOffset=.15,this.intensity.valueProcessor=i=>i*.02,this.intensity.onValueChanged=i=>{t.offset.x=-i,t.offset.y=i},t}}_A([m(N)],Ph.prototype,"intensity",2),sn("ChromaticAberration",Ph);var wA=Object.defineProperty,xA=Object.getOwnPropertyDescriptor,p1=(n,t,i,s)=>{for(var o=s>1?void 0:s?xA(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&wA(t,i,o),o};const m1=C("debugpost");var Tp=(n=>(n[n.None=0]="None",n[n.Neutral=1]="Neutral",n[n.ACES=2]="ACES",n[n.AgX=3]="AgX",n[n.KhronosNeutral=4]="KhronosNeutral",n))(Tp||{});function K0(n){switch(n){case 0:return dd;case 1:return mm;case 2:return pm;case 3:return hd;case 4:return Xl;default:return Xl}}function SA(n){switch(n){case dd:return 0;case pm:return 2;case hd:return 3;case Xl:return 1;case mm:return 1;default:return 0}}function g1(n){switch(n){case dd:return I.POSTPROCESSING.MODULE.ToneMappingMode.LINEAR;case pm:return I.POSTPROCESSING.MODULE.ToneMappingMode.ACES_FILMIC;case hd:return I.POSTPROCESSING.MODULE.ToneMappingMode.AGX;case Xl:return I.POSTPROCESSING.MODULE.ToneMappingMode.NEUTRAL;case mm:return I.POSTPROCESSING.MODULE.ToneMappingMode.REINHARD;default:return I.POSTPROCESSING.MODULE.ToneMappingMode.LINEAR}}const f1=class extends ht{constructor(){super(...arguments),a(this,"mode",new N(void 0)),a(this,"exposure",new N(1))}get typeName(){return"ToneMapping"}setMode(n){const t=Tp[n];return t===void 0?(console.error("Invalid ToneMapping mode",n),this):(this.mode.value=t,this)}get isToneMapping(){return!0}onEffectEnabled(){const n=h1(this);n&&super.onEffectEnabled(n)}onCreateEffect(){if(this.postprocessingContext)for(const i of this.postprocessingContext.components){if(i===this)break;if(i!=this&&i instanceof f1){console.warn("Multiple tonemapping effects found in the same postprocessing stack: Please check your scene setup.",{activeEffect:i,ignoredEffect:this});return}}if(this.mode.isInitialized==!1){const i=SA(this.context.renderer.toneMapping);this.mode.initialize(i)}const n=K0(this.mode.value),t=new I.POSTPROCESSING.MODULE.ToneMappingEffect({mode:g1(n)});return this.mode.onValueChanged=i=>{const s=K0(i);t.mode=g1(s),m1&&console.log("ToneMapping mode changed to",Tp[i],s,t.mode)},m1&&console.log("Use ToneMapping",Tp[this.mode.value],n,t.mode,"renderer.tonemapping: "+this.context.renderer.toneMapping),this.exposure.onValueChanged=i=>{this.context.renderer.toneMappingExposure=i},t}onBeforeRender(){this.mode.overrideState&&(this.context.renderer.toneMapping=K0(this.mode.value)),this.exposure.overrideState&&this.exposure.value!==void 0&&(this.context.renderer.toneMappingExposure=this.exposure.value)}};let $o=f1;p1([m(N)],$o.prototype,"mode",2),p1([m(N)],$o.prototype,"exposure",2),sn("Tonemapping",$o);var CA=Object.defineProperty,OA=Object.getOwnPropertyDescriptor,Ep=(n,t,i,s)=>{for(var o=s>1?void 0:s?OA(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&CA(t,i,o),o};class Go extends ht{constructor(){super(...arguments),a(this,"postExposure",new N(0)),a(this,"contrast",new N(0)),a(this,"hueShift",new N(0)),a(this,"saturation",new N(0))}get typeName(){return"ColorAdjustments"}init(){this.postExposure.valueProcessor=t=>(t=Math.pow(2,t),t),this.contrast.valueProcessor=t=>{let i=1;return t>0?i=200:t<0&&(i=100),t/i},this.contrast.defaultValue=0,this.hueShift.valueProcessor=t=>Math.PI*t/180,this.hueShift.defaultValue=0,this.saturation.valueProcessor=t=>t<0?t/100:t/(100*Math.PI),this.saturation.defaultValue=0}onCreateEffect(){var t,i;const s=[];this.context.renderer.toneMapping!==ya&&this.postExposure.overrideState&&(this.context.renderer.toneMapping=ya);let o=(t=this.postprocessingContext)==null?void 0:t.components.find(c=>c instanceof $o);o||(o=new $o,(i=this.postprocessingContext)==null||i.components.push(o)),this.postExposure.onValueChanged=c=>{this.postExposure.overrideState&&(o.exposure.value=c)};const r=new I.POSTPROCESSING.MODULE.BrightnessContrastEffect;this.contrast.onValueChanged=c=>r.contrast=c;const l=new I.POSTPROCESSING.MODULE.HueSaturationEffect;return s.push(r),s.push(l),this.hueShift.onValueChanged=c=>l.hue=c,this.saturation.onValueChanged=c=>l.saturation=c,s}}Ep([m(N)],Go.prototype,"postExposure",2),Ep([m(N)],Go.prototype,"contrast",2),Ep([m(N)],Go.prototype,"hueShift",2),Ep([m(N)],Go.prototype,"saturation",2),sn("ColorAdjustments",Go);var PA=Object.defineProperty,kA=Object.getOwnPropertyDescriptor,Jr=(n,t,i,s)=>{for(var o=s>1?void 0:s?kA(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&PA(t,i,o),o};const MA=C("debugpost");class In extends ht{constructor(){super(...arguments),a(this,"mode"),a(this,"focusDistance",new N(1)),a(this,"focalLength",new N(.2)),a(this,"aperture",new N(20)),a(this,"gaussianMaxRadius",new N),a(this,"resolutionScale",new N(1*1/window.devicePixelRatio)),a(this,"bokehScale",new N)}get typeName(){return"DepthOfField"}init(){this.focalLength.valueProcessor=i=>{const s=i/300,o=2;return W.lerp(o,.01,s)};const t=20;this.aperture.valueProcessor=i=>{const s=1-i/32;return W.lerp(1,t,s)}}onCreateEffect(){if(this.mode===0){MA&&console.warn("DepthOfField: Mode is set to Off");return}const t=new I.POSTPROCESSING.MODULE.DepthOfFieldEffect(this.context.mainCamera,{worldFocusRange:.2,focalLength:1,bokehScale:20,resolutionScale:this.resolutionScale.value});return this.focusDistance.onValueChanged=i=>{t.cocMaterial.worldFocusDistance=i},this.focalLength.onValueChanged=i=>t.cocMaterial.worldFocusRange=i,this.aperture.onValueChanged=i=>t.bokehScale=i,this.resolutionScale&&(this.resolutionScale.onValueChanged=i=>t.resolution.scale=i),[t]}unapply(){}}Jr([m()],In.prototype,"mode",2),Jr([m(N)],In.prototype,"focusDistance",2),Jr([m(N)],In.prototype,"focalLength",2),Jr([m(N)],In.prototype,"aperture",2),Jr([m(N)],In.prototype,"gaussianMaxRadius",2),Jr([m(N)],In.prototype,"resolutionScale",2),Jr([m(N)],In.prototype,"bokehScale",2),sn("DepthOfField",In);class kh extends ht{constructor(t){super(),a(this,"effect"),this.effect=t}get typeName(){return this.effect.constructor.name}onCreateEffect(){return this.effect}}var RA=Object.defineProperty,TA=Object.getOwnPropertyDescriptor,EA=(n,t,i,s)=>{for(var o=s>1?void 0:s?TA(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&RA(t,i,o),o};class Mh extends ht{constructor(){super(...arguments),a(this,"granularity",new N(10))}get typeName(){return"PixelationEffect"}onCreateEffect(){const t=new I.POSTPROCESSING.MODULE.PixelationEffect;return this.granularity.onValueChanged=i=>{t.granularity=i},t}}EA([m(N)],Mh.prototype,"granularity",2),sn("PixelationEffect",Mh);var AA=Object.defineProperty,IA=Object.getOwnPropertyDescriptor,Rh=(n,t,i,s)=>{for(var o=s>1?void 0:s?IA(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&AA(t,i,o),o};class Gs extends ht{constructor(){super(...arguments),a(this,"intensity",new N(2)),a(this,"falloff",new N(1)),a(this,"samples",new N(9)),a(this,"color",new N(new ae(0,0,0))),a(this,"luminanceInfluence",new N(.7)),a(this,"_ssao")}get typeName(){return"ScreenSpaceAmbientOcclusion"}onBeforeRender(){if(this._ssao&&this.context.mainCamera instanceof _e){const t=this.context.mainCamera.far-this.context.mainCamera.near;this._ssao.ssaoMaterial.worldDistanceFalloff=t*.01,this._ssao.ssaoMaterial.worldDistanceThreshold=this.context.mainCamera.far}}onCreateEffect(){const t=this.context.mainCamera,i=new I.POSTPROCESSING.MODULE.NormalPass(this.context.scene,t),s=new I.POSTPROCESSING.MODULE.DepthDownsamplingPass({normalBuffer:i.texture,resolutionScale:.5}),o=this._ssao=new I.POSTPROCESSING.MODULE.SSAOEffect(t,i.texture,{normalDepthBuffer:s.texture,worldDistanceThreshold:1,worldDistanceFalloff:1,worldProximityThreshold:.1,worldProximityFalloff:2,intensity:1,blendFunction:I.POSTPROCESSING.MODULE.BlendFunction.MULTIPLY,luminanceInfluence:.5});this.intensity.onValueChanged=l=>{o.intensity=l},this.falloff.onValueChanged=l=>{o.ssaoMaterial.radius=l*.1},this.samples.onValueChanged=l=>{o.ssaoMaterial.samples=l},this.color.onValueChanged=l=>{o.color||(o.color=new ae),o.color.copy(l)},this.luminanceInfluence.onValueChanged=l=>{o.luminanceInfluence=l};const r=new Array;return r.push(i),r.push(s),r.push(o),r}}Rh([m(N)],Gs.prototype,"intensity",2),Rh([m(N)],Gs.prototype,"falloff",2),Rh([m(N)],Gs.prototype,"samples",2),Rh([m(N)],Gs.prototype,"color",2),Rh([m(N)],Gs.prototype,"luminanceInfluence",2),sn("ScreenSpaceAmbientOcclusion",Gs);var jA=Object.defineProperty,LA=Object.getOwnPropertyDescriptor,ea=(n,t,i,s)=>{for(var o=s>1?void 0:s?LA(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&jA(t,i,o),o};const DA=C("debugN8AO");var J0=(n=>(n[n.Performance=0]="Performance",n[n.Low=1]="Low",n[n.Medium=2]="Medium",n[n.High=3]="High",n[n.Ultra=4]="Ultra",n))(J0||{});class jn extends ht{constructor(){super(...arguments),a(this,"gammaCorrection",!0),a(this,"aoRadius",new N(1)),a(this,"falloff",new N(1)),a(this,"intensity",new N(1)),a(this,"color",new N(new ae(0,0,0))),a(this,"screenspaceRadius",!1),a(this,"quality",2),a(this,"_ssao")}get typeName(){return"ScreenSpaceAmbientOcclusionN8"}get pass(){return this._ssao}onValidate(){this._ssao&&(this._ssao.setQualityMode(J0[this.quality]),this._ssao.configuration.gammaCorrection=this.gammaCorrection,this._ssao.configuration.screenSpaceRadius=this.screenspaceRadius)}onCreateEffect(){const t=this.context.mainCamera,i=this.context.domWidth,s=this.context.domHeight,o=this._ssao=new I.POSTPROCESSING_AO.MODULE.N8AOPostPass(this.context.scene,t,i,s),r=J0[this.quality];o.setQualityMode(r),o.configuration.transparencyAware=!1;const l=new vs(i,s);return o.configuration.beautyRenderTarget=l,o.configuration.autoRenderBeauty=!1,o.configuration.gammaCorrection=this.gammaCorrection,o.configuration.screenSpaceRadius=this.screenspaceRadius,DA&&(o.enableDebugMode(),console.log(o),setInterval(()=>{console.log("SSAO",o.lastTime)},1e3),setInterval(()=>{console.log("SSAO",o.enabled,{ssao:o,autoRenderBeauty:o.configuration.autoRenderBeauty})},4e3)),this.intensity.onValueChanged=c=>{o.configuration.intensity=c},this.falloff.onValueChanged=c=>{o.configuration.distanceFalloff=c},this.aoRadius.onValueChanged=c=>{o.configuration.aoRadius=c},this.color.onValueChanged=c=>{o.color||(o.color=new ae),o.configuration.color.copy(c)},o}}ea([Mt(),m()],jn.prototype,"gammaCorrection",2),ea([m(N)],jn.prototype,"aoRadius",2),ea([m(N)],jn.prototype,"falloff",2),ea([m(N)],jn.prototype,"intensity",2),ea([m(N)],jn.prototype,"color",2),ea([Mt(),m()],jn.prototype,"screenspaceRadius",2),ea([Mt(),m()],jn.prototype,"quality",2),sn("ScreenSpaceAmbientOcclusionN8",jn);var BA=Object.defineProperty,FA=Object.getOwnPropertyDescriptor,y1=(n,t,i,s)=>{for(var o=s>1?void 0:s?FA(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&BA(t,i,o),o};class Th extends ht{constructor(){super(...arguments),a(this,"_effect"),a(this,"_amount",1),a(this,"_radius",1)}get typeName(){return"Sharpening"}onCreateEffect(){return this._effect??(this._effect=new(zA())),this.effect}get effect(){return this._effect}set amount(t){this._amount=t,this._effect&&(this._effect.uniforms.get("amount").value=t)}get amount(){return this._effect?this._effect.uniforms.get("amount").value:this._amount}set radius(t){this._radius=t,this._effect&&(this._effect.uniforms.get("radius").value=t)}get radius(){return this._effect?this._effect.uniforms.get("radius").value:this._radius}}y1([m()],Th.prototype,"amount",1),y1([m()],Th.prototype,"radius",1);function zA(){const n=`
      void mainSupport() {
        vUv = uv;
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
      }
    `,t=`
    uniform sampler2D tDiffuse;
    uniform float amount;
    uniform float radius;
    
    void mainImage(const in vec4 inputColor, const in vec2 uv, out vec4 outputColor) {
        float tx = 1.0 / resolution.x;
        float ty = 1.0 / resolution.y;
        vec2 texelSize = vec2(tx, ty);
    
        vec4 blurred = vec4(0.0);
        float total = 0.0;
    
        for (float x = -radius; x <= radius; x++) {
            for (float y = -radius; y <= radius; y++) {
                vec2 offset = vec2(x, y) * texelSize;
                vec4 diffuse = texture2D(tDiffuse, uv + offset);
                float weight = exp(-length(offset) * amount);
                blurred += diffuse * weight;
                total += weight;
            }
        }
    
        if (total > 0.0) {
            blurred /= total;
        }
    
        // Calculate the sharpened color using inputColor
        vec4 sharp = inputColor + clamp(inputColor - blurred, 0.0, 1.0) * amount;
        // Keep original alpha
        sharp.a = inputColor.a;
    
        // Ensure the sharp color does not go below 0 or above 1
        // This means: sharpening must happen AFTER tonemapping.
        sharp = clamp(sharp, 0.0, 1.0);
    
        outputColor = sharp;
    }
    
    `;class i extends I.POSTPROCESSING.MODULE.Effect{constructor(){super("Sharpening",t,{vertexShader:n,blendFunction:I.POSTPROCESSING.MODULE.BlendFunction.NORMAL,uniforms:new Map([["amount",new to(1)],["radius",new to(1)]])})}}return i}var UA=Object.defineProperty,NA=Object.getOwnPropertyDescriptor,Tl=(n,t,i,s)=>{for(var o=s>1?void 0:s?NA(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&UA(t,i,o),o};class ls extends ht{constructor(){super(...arguments),a(this,"offset",new N(0)),a(this,"rotation",new N(0)),a(this,"focusArea",new N(.4)),a(this,"feather",new N(.3)),a(this,"kernelSize",new N(2)),a(this,"resolutionScale",new N(1/window.devicePixelRatio))}get typeName(){return"TiltShiftEffect"}init(){this.offset.defaultValue=0,this.rotation.defaultValue=0,this.focusArea.defaultValue=.4,this.feather.defaultValue=.3,this.kernelSize.defaultValue=I.POSTPROCESSING.MODULE.KernelSize.MEDIUM,this.resolutionScale.defaultValue=1/window.devicePixelRatio}onCreateEffect(){const t=new I.POSTPROCESSING.MODULE.TiltShiftEffect({kernelSize:I.POSTPROCESSING.MODULE.KernelSize.VERY_LARGE,offset:this.offset.value,rotation:this.rotation.value,focusArea:this.focusArea.value,feather:this.feather.value});return this.offset.onValueChanged=i=>t.offset=i,this.rotation.onValueChanged=i=>t.rotation=i,this.focusArea.onValueChanged=i=>t.focusArea=i,this.feather.onValueChanged=i=>t.feather=i,this.kernelSize.onValueChanged=i=>t.blurPass.kernelSize=i,this.resolutionScale.onValueChanged=i=>t.resolution.scale=i/window.devicePixelRatio,t}}Tl([m(N)],ls.prototype,"offset",2),Tl([m(N)],ls.prototype,"rotation",2),Tl([m(N)],ls.prototype,"focusArea",2),Tl([m(N)],ls.prototype,"feather",2),Tl([m(N)],ls.prototype,"kernelSize",2),Tl([m(N)],ls.prototype,"resolutionScale",2),sn("TiltShiftEffect",ls);var WA=Object.defineProperty,VA=Object.getOwnPropertyDescriptor,ey=(n,t,i,s)=>{for(var o=s>1?void 0:s?VA(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&WA(t,i,o),o};class ta extends ht{constructor(){super(...arguments),a(this,"color",new N({r:0,g:0,b:0,a:1})),a(this,"intensity",new N(0)),a(this,"center",new N({x:.5,y:.5}))}get typeName(){return"Vignette"}init(){this.color.defaultValue={r:0,g:0,b:0,a:1},this.intensity.defaultValue=0,this.center.defaultValue={x:.5,y:.5}}onCreateEffect(){const t=new I.POSTPROCESSING.MODULE.VignetteEffect;return this.intensity.onValueChanged=i=>{t.offset=i,this.updateDarkness(t)},this.color.onValueChanged=i=>{this.updateDarkness(t)},t}updateDarkness(t){const i=this.intensity.value;t.darkness=i}}ey([m(N)],ta.prototype,"color",2),ey([m(N)],ta.prototype,"intensity",2),ey([m(N)],ta.prototype,"center",2),sn("Vignette",ta),globalThis.true=globalThis.true!==void 0?globalThis.true:!0;const qo=C("debugpost"),HA=C("debugpostpasses"),ty=Symbol("needle:postprocessing-handler"),iy=Symbol("needle:previous-autoclear-state");class ny{constructor(t){a(this,"_composer",null),a(this,"_lastVolumeComponents"),a(this,"_effects",[]),a(this,"_isActive",!1),a(this,"context"),a(this,"_menuEntry",null),a(this,"_passIndices",null),this.context=t}get isActive(){return this._isActive}get composer(){return this._composer}apply(t){return"env"in import.meta&&{}.VITE_NEEDLE_USE_POSTPROCESSING==="false"?(qo?console.warn("Postprocessing is disabled via vite env setting"):console.debug("Postprocessing is disabled via vite env setting"),Promise.resolve()):(this._isActive=!0,this.onApply(this.context,t))}unapply(){var t;if(qo&&console.log("Unapplying postprocessing effects"),this._isActive=!1,this._lastVolumeComponents){for(const s of this._lastVolumeComponents)s.unapply();this._lastVolumeComponents.length=0}const i=this.context;i[ty]===this&&delete i[ty],i.composer===this._composer&&((t=i.composer)==null||t.dispose(),i.composer=null),typeof i.renderer[iy]=="boolean"&&(i.renderer.autoClear=i.renderer[iy])}dispose(){this.unapply();for(const t of this._effects)t.dispose();this._effects.length=0,this._composer=null}async onApply(t,i){if(!i)return;await Promise.all([I.POSTPROCESSING.load(),I.POSTPROCESSING_AO.load()]),t[ty]=this,qo&&console.log("Apply Postprocessing Effects",i),this._lastVolumeComponents=[...i],this._effects.length=0;const s={handler:this,components:this._lastVolumeComponents};for(let o=0;o<this._lastVolumeComponents.length;o++){const r=this._lastVolumeComponents[o];if(r.context=t,r.apply){if(r.active){if(!t.mainCameraComponent){console.error("No camera in scene found or available yet - can not create postprocessing effects");return}const l=r.apply(s);if(!l)continue;Array.isArray(l)?this._effects.push(...l):this._effects.push(l)}}else r.active&&we("Volume component is not a VolumeComponent: "+r.__type)}if(this.context.renderer.toneMapping!=ya&&!this._effects.find(o=>o instanceof I.POSTPROCESSING.MODULE.ToneMappingEffect)){const o=new I.POSTPROCESSING.MODULE.ToneMappingEffect;this._effects.push(o)}this.applyEffects(t)}applyEffects(t){const i=this._effects;if(i.length<=0)return;const s=t.mainCameraComponent,o=t.renderer,r=t.scene,l=s.threeCamera;o[iy]=o.autoClear,this._composer||(this._composer=new I.POSTPROCESSING.MODULE.EffectComposer(o,{frameBufferType:bC,stencilBuffer:!0})),t.composer&&t.composer!==this._composer&&console.warn("There's already an active EffectComposer in your scene: replacing it with a new one. This might cause unexpected behaviour. Make sure to only use one PostprocessingManager/Volume in your scene."),t.composer=this._composer;const c=t.composer;c.setMainCamera(l),c.setRenderer(o),c.setMainScene(r);for(const d of c.passes)d.dispose();c.removeAllPasses();const h=new I.POSTPROCESSING.MODULE.RenderPass(r,l);if(h.name="Render To Screen",h.mainScene=r,c.addPass(h),HA){this.orderEffects();for(const d of i)if(d instanceof I.POSTPROCESSING.MODULE.Effect){const u=new I.POSTPROCESSING.MODULE.EffectPass(l,d);u.name=d.name,c.addPass(u)}else d instanceof I.POSTPROCESSING.MODULE.Pass,c.addPass(d)}else try{this.orderEffects();const d=[];for(const u of i)u instanceof I.POSTPROCESSING.MODULE.Effect?d.push(u):(u instanceof I.POSTPROCESSING.MODULE.Pass,c.addPass(u));if(d.length>0){const u=new I.POSTPROCESSING.MODULE.EffectPass(l,...d);u.name=d.map(p=>p.name).join(" "),u.mainScene=r,u.enabled=!0,c.addPass(u)}}catch(d){console.error("Error while applying postprocessing effects",d),c.removeAllPasses()}if(qo){console.log("[PostProcessing] Passes \u2192",c.passes);const d=new I.POSTPROCESSING.MODULE.DepthEffect({blendFunction:I.POSTPROCESSING.MODULE.BlendFunction.NORMAL,inverted:!0});d.name="Depth Effect";const u=new I.POSTPROCESSING.MODULE.EffectPass(l,d);if(u.name="Depth Effect Pass",u.enabled=!1,c.passes.push(u),this._passIndices!==null){const g=[c.passes[0]];this._passIndices.length>0&&g.push(...this._passIndices.filter(y=>y!==0).map(y=>c.passes[y]).filter(y=>y)),g.length>0&&console.log("[PostProcessing] Passes (selected) \u2192",g),c.passes.length=0;for(const y of g)y.enabled=!0,y.renderToScreen=!1,c.addPass(y)}const p=this.context.menu;if(p&&this._passIndices===null){this._menuEntry&&this._menuEntry.remove();const g=document.createElement("select");g.multiple=!0;const y=document.createElement("option");y.innerText="Final Output",y.value="-1",g.appendChild(y);for(const f of c.passes){const v=document.createElement("option");v.innerText=f.name,v.value=`${c.passes.indexOf(f)}`,v.title=f.name,g.appendChild(v)}p.appendChild(g),this._menuEntry=g,g.addEventListener("change",()=>{const f=Array.from(g.selectedOptions).map(v=>parseInt(v.value));f.length===1&&f[0]===-1?this._passIndices=null:this._passIndices=f,this.applyEffects(t)})}}}orderEffects(){var t;qo&&console.log("Before ordering effects",[...this._effects]),Ap??(Ap=[I.POSTPROCESSING.MODULE.NormalPass,I.POSTPROCESSING.MODULE.DepthDownsamplingPass,I.POSTPROCESSING.MODULE.SMAAEffect,I.POSTPROCESSING.MODULE.SSAOEffect,I.POSTPROCESSING_AO.MODULE.N8AOPostPass,I.POSTPROCESSING.MODULE.TiltShiftEffect,I.POSTPROCESSING.MODULE.DepthOfFieldEffect,I.POSTPROCESSING.MODULE.ChromaticAberrationEffect,I.POSTPROCESSING.MODULE.BloomEffect,I.POSTPROCESSING.MODULE.SelectiveBloomEffect,I.POSTPROCESSING.MODULE.VignetteEffect,I.POSTPROCESSING.MODULE.PixelationEffect,I.POSTPROCESSING.MODULE.ToneMappingEffect,I.POSTPROCESSING.MODULE.HueSaturationEffect,I.POSTPROCESSING.MODULE.BrightnessContrastEffect]);const i=this._effects;i.sort((s,o)=>{const r=Ap.findIndex(c=>s.constructor.name.endsWith(c.name)),l=Ap.findIndex(c=>o.constructor.name.endsWith(c.name));return r<0?(qo&&console.warn("Unknown effect found: ",s.constructor.name),-1):l<0?(qo&&console.warn("Unknown effect found: ",o.constructor.name),1):r<0?1:l<0?-1:r-l}),qo&&console.log("After ordering effects",[...this._effects]);for(let s=0;s<i.length;s++){const o=i[s];if(((t=o?.configuration)==null?void 0:t.gammaCorrection)!==void 0){const r=s===i.length-1;o.configuration.gammaCorrection=r}}}}let Ap=null;var $A=Object.defineProperty,GA=Object.getOwnPropertyDescriptor,v1=(n,t,i,s)=>{for(var o=s>1?void 0:s?GA(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&$A(t,i,o),o};const El=C("debugpost");class Al extends A{constructor(){super(...arguments),a(this,"sharedProfile"),a(this,"multisampling","auto"),a(this,"_postprocessing"),a(this,"_activeEffects",[]),a(this,"_effects",[]),a(this,"_componentEnabledTime",-1),a(this,"_multisampleAutoChangeTime",0),a(this,"_multisampleAutoDecreaseTime",0),a(this,"_lastApplyTime"),a(this,"_rapidApplyCount",0),a(this,"_isDirty",!1),a(this,"_modificationQueue"),a(this,"_recreateId",-1)}get isPostProcessingManager(){return!0}get effects(){return this._activeEffects}addEffect(t){let i=t;return i instanceof ht||(i=new kh(i)),i.gameObject===void 0&&this.gameObject.addComponent(i),this._effects.includes(i)||(this._effects.push(i),this._isDirty=!0),t}removeEffect(t){var i,s,o,r;let l=-1;if(t instanceof ht?l=this._effects.indexOf(t):l=this._effects.findIndex(c=>c instanceof kh&&c.effect===t),l!==-1)return this._effects.splice(l,1),this._isDirty=!0,t;if(t instanceof ht){const c=(s=(i=this.sharedProfile)==null?void 0:i.components)==null?void 0:s.indexOf(t);c!==void 0&&c!==-1&&(this._isDirty=!0,(r=(o=this.sharedProfile)==null?void 0:o.components)==null||r.splice(c,1))}return t}markDirty(){this._isDirty=!0}awake(){var t;El&&(console.log("PostprocessingManager Awake",this),console.log("Press P to toggle post processing"),window.addEventListener("keydown",i=>{i.key==="p"&&(this.enabled=!this.enabled,De("Toggle PostProcessing "+this.name+": Enabled="+this.enabled),this.markDirty())})),(t=this.sharedProfile)==null||t.__init(this)}onEnable(){this._componentEnabledTime=this.context.time.realtimeSinceStartup,this._isDirty=!0}onDisable(){var t;(t=this._postprocessing)==null||t.unapply(),this._isDirty=!1}onBeforeRender(){if(!this.context.isInXR&&(this.context.mainCamera&&this._isDirty&&this.apply(),this.context.composer&&this._postprocessing&&this._postprocessing.composer===this.context.composer)){this.context.renderer.getContext().isContextLost()&&this.context.renderer.forceContextRestore(),this.context.composer.getRenderer()!==this.context.renderer&&this.context.composer.setRenderer(this.context.renderer),this.context.composer.setMainScene(this.context.scene);const t=this.context.composer;if(this.multisampling==="auto"){const i=this.context.time.realtimeSinceStartup-this._multisampleAutoChangeTime;if(this.context.time.realtimeSinceStartup-this._componentEnabledTime>2&&i>.5){const s=t.multisampling;t.multisampling>0&&this.context.time.smoothedFps<=50?(this._multisampleAutoChangeTime=this.context.time.realtimeSinceStartup,this._multisampleAutoDecreaseTime=this.context.time.realtimeSinceStartup,t.multisampling*=.5,t.multisampling=Math.floor(t.multisampling),El&&console.debug(`[PostProcessing] Reduced multisampling from ${s} to ${t.multisampling}`)):i>1&&this.context.time.smoothedFps>=59&&t.multisampling<this.context.renderer.capabilities.maxSamples&&this.context.time.realtimeSinceStartup-this._multisampleAutoDecreaseTime>10&&(this._multisampleAutoChangeTime=this.context.time.realtimeSinceStartup,t.multisampling=t.multisampling<=0?1:t.multisampling*2,t.multisampling=Math.floor(t.multisampling),El&&console.debug(`[PostProcessing] Increased multisampling from ${s} to ${t.multisampling}`))}}else t.multisampling=Math.max(0,Math.min(this.multisampling,this.context.renderer.capabilities.maxSamples));if(this.context.mainCamera){const i=this.context.composer.passes;for(const s of i)if(s.mainCamera&&s.mainCamera!==this.context.mainCamera){this.context.composer.setMainCamera(this.context.mainCamera);break}}}}onDestroy(){var t;(t=this._postprocessing)==null||t.dispose()}apply(){var t,i;if(El&&console.log(`Apply PostProcessing "${this.name}"`),F()&&(this._lastApplyTime!==void 0&&Date.now()-this._lastApplyTime<100&&(this._rapidApplyCount++,this._rapidApplyCount===5&&console.warn("Detected rapid post processing modifications - this might be a bug",this)),this._lastApplyTime=Date.now()),this._isDirty=!1,this.unapply(),this._activeEffects.length=0,(t=this.sharedProfile)!=null&&t.components){const s=this.sharedProfile.components;for(const o of s)o.active&&o.enabled&&!this._activeEffects.includes(o)&&this._activeEffects.push(o)}for(const s of this._effects)s.active&&s.enabled&&!this._activeEffects.includes(s)&&this._activeEffects.push(s);this._activeEffects.length>0&&(this._postprocessing||(this._postprocessing=new ny(this.context)),(i=this._postprocessing.apply(this._activeEffects))==null||i.then(()=>{var s;if(!this.activeAndEnabled)return;this._applyPostQueue();const o=(s=this._postprocessing)==null?void 0:s.composer;o?(this.multisampling==="auto"?o.multisampling=Q.isMobileDevice()?2:4:o.multisampling=Math.max(0,Math.min(this.multisampling,this.context.renderer.capabilities.maxSamples)),El&&console.debug(`[PostProcessing] Set multisampling to ${o.multisampling} (Is Mobile: ${Q.isMobileDevice()})`)):El&&console.warn("[PostProcessing] No composer found")}))}unapply(){var t;(t=this._postprocessing)==null||t.unapply()}_applyPostQueue(){if(this._modificationQueue){for(const t of this._modificationQueue.values())this.onEditorModification(t);this._modificationQueue.clear()}}onEditorModification(t){var i,s;if(t.propertyName.startsWith("postprocessing.")){if(!this._postprocessing)return this._modificationQueue||(this._modificationQueue=new Map),this._modificationQueue.set(t.propertyName,t),!0;if(!((i=this._activeEffects)!=null&&i.length))return;const o=t.propertyName.split(".");if(o.length===3||o.length===4){const r=o[1],l=o[2];for(const c of this._activeEffects)if(((s=c.typeName)==null?void 0:s.toLowerCase())===r.toLowerCase()){if(l==="active"){c.active=t.value,this.scheduleRecreate();return}if(!Ip.has(r)){const h=new Array;Ip.set(r,h);const d=Object.keys(c);for(const u of d)c[u]instanceof N&&h.push(u)}if(Ip.has(r)){const h=l.toLowerCase(),d=Ip.get(r);for(const u of d)if(u.toLowerCase()===h){const p=c[u];p instanceof N&&(o.length===4&&o[3]==="active"?(p.overrideState=t.value,this.scheduleRecreate()):p&&p.value!==void 0&&(p.value=t.value));return}}console.warn("Unknown modification",l);return}}return!0}return!1}scheduleRecreate(){const t=++this._recreateId;setTimeout(()=>{t===this._recreateId&&(this.onDisable(),this.onEnable())},200)}}v1([kr(Rp)],Al.prototype,"sharedProfile",2),v1([kr()],Al.prototype,"multisampling",2);const Ip=new Map;JE(Al);async function sy(n){const{NeedleEngineHTMLElement:t}=await Promise.resolve().then(()=>jj);t.observedAttributes.includes(n)||t.observedAttributes.push(n)}var qA=Object.defineProperty,XA=Object.getOwnPropertyDescriptor,Ct=(n,t,i,s)=>{for(var o=s>1?void 0:s?XA(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&qA(t,i,o),o};const ii=C("debugsceneswitcher"),QA=C("sceneswitcher:clearscene"),jp="scene";sy(jp);const Xo=Promise.resolve(!1);class ot extends A{constructor(){super(...arguments),a(this,"autoLoadFirstScene",!0),a(this,"scenes",[]),a(this,"loadingScene"),a(this,"queryParameterName","scene"),a(this,"useSceneName",!0),a(this,"clamp",!0),a(this,"useHistory",!0),a(this,"useKeyboard",!0),a(this,"useSwipe",!0),a(this,"useSceneLighting",!0),a(this,"useSceneBackground",!0),a(this,"preloadNext",1),a(this,"preloadPrevious",1),a(this,"preloadConcurrent",2),a(this,"createMenuButtons",!1),a(this,"sceneLoadingStart",new Se),a(this,"sceneLoadingProgress",new Se),a(this,"sceneLoaded",new Se),a(this,"_currentIndex",-1),a(this,"_currentScene"),a(this,"_engineElementOverserver"),a(this,"_preloadScheduler"),a(this,"_menuButtons"),a(this,"onPopState",async t=>{if(!this.useHistory)return;const i=this.useHistory;try{this.useHistory=!1;let s=!1;if(this.queryParameterName&&(s=await this.tryLoadFromQueryParam()),!s){const o=t?.state;if(o&&o.startsWith(this.guid)){const r=o.substr(this.guid.length+2);ii&&console.log("PopState",r),await this.trySelectSceneFromValue(r)}}}finally{this.useHistory=i}}),a(this,"normalizedSwipeThresholdX",.1),a(this,"_didSwipe",!1),a(this,"onInputPointerMove",t=>{if(this.useSwipe&&!this._didSwipe&&t.button===0&&t.pointerType==="touch"&&this.context.input.getPointerPressedCount()===1){const i=this.context.input.getPointerPositionDelta(t.button);if(i){const s=i.x/this.context.domWidth;s>=this.normalizedSwipeThresholdX?(this._didSwipe=!0,this.selectPrev()):s<=-this.normalizedSwipeThresholdX&&(this._didSwipe=!0,this.selectNext())}}}),a(this,"onInputPointerUp",t=>{t.button===0&&(this._didSwipe=!1)}),a(this,"onInputKeyDown",t=>{if(!this.useKeyboard||!this.scenes)return;const i=t.key.toLowerCase();if(!i)return;const s=parseInt(i)-1;if(s>=0){this.trySelectSceneFromValue(s);return}switch(i){case"arrowright":case"d":this.selectNext();break;case"arrowleft":case"a":this.selectPrev();break}}),a(this,"__lastSwitchScene"),a(this,"__lastSwitchScenePromise"),a(this,"_currentlyLoadingScene"),a(this,"_lastLoadingScene"),a(this,"_loadingScenePromise"),a(this,"_isCurrentlyLoading",!1),a(this,"_currentLoadingProgress")}get currentIndex(){return this._currentIndex}get currentLoadingProgress(){return this._currentLoadingProgress}get currentlyLoadingScene(){return this._currentlyLoadingScene}get currentlyLoadedScene(){return this._currentScene}awake(){this.scenes===void 0&&(this.scenes=[]);for(const t of this.scenes)t&&!t.hasUrl&&t.asset instanceof j&&t.asset.removeFromParent();ii&&console.log("SceneSwitcher",this)}async onEnable(){if(globalThis.addEventListener("popstate",this.onPopState),this.context.input.addEventListener(Be.KeyDown,this.onInputKeyDown),this.context.input.addEventListener(Be.PointerMove,this.onInputPointerMove),this.context.input.addEventListener(Be.PointerUp,this.onInputPointerUp),this._engineElementOverserver||(this._engineElementOverserver=new MutationObserver(t=>{for(const i of t)if(i.type==="attributes"&&i.attributeName===jp){const s=this.context.domElement.getAttribute(jp);s!==null&&this.trySelectSceneFromValue(s)}})),this._engineElementOverserver.observe(this.context.domElement,{attributes:!0}),this._preloadScheduler||(this._preloadScheduler=new YA(this)),this._preloadScheduler.maxLoadAhead=this.preloadNext,this._preloadScheduler.maxLoadBehind=this.preloadPrevious,this._preloadScheduler.maxConcurrent=this.preloadConcurrent,this._preloadScheduler.begin(2e3),this.autoLoadFirstScene&&this._currentIndex===-1&&!await this.tryLoadFromQueryParam()){const t=this.context.domElement.getAttribute(jp);try{(t===null||!await this.trySelectSceneFromValue(t))&&this._currentIndex===-1&&this.select(0)}finally{}}this.createMenuButtons&&(this._menuButtons??(this._menuButtons=[]),this._menuButtons.push(this.context.menu.appendChild({label:"Previous",icon:"arrow_back_ios",onClick:()=>this.selectPrev(),priority:-1005,class:"row2"})),this._menuButtons.push(this.context.menu.appendChild({label:"Next",icon:"arrow_forward_ios",iconSide:"right",onClick:()=>this.selectNext(),priority:-1e3,class:"row2"})))}onDisable(){var t;if(globalThis.removeEventListener("popstate",this.onPopState),this.context.input.removeEventListener(Be.KeyDown,this.onInputKeyDown),this.context.input.removeEventListener(Be.PointerMove,this.onInputPointerMove),this.context.input.removeEventListener(Be.PointerUp,this.onInputPointerUp),(t=this._preloadScheduler)==null||t.stop(),this._menuButtons){for(const i of this._menuButtons)i.remove();this._menuButtons=void 0}}addScene(t){if(typeof t=="string"){let i=this.context.addressables.findAssetReference(t);return i||(i=new le(t),this.context.addressables.registerAssetReference(i)),this.scenes.push(i),i}return this.scenes.push(t),t}selectNext(){return this.select(this._currentIndex+1)}selectPrev(){return this.select(this._currentIndex-1)}select(t){var i,s,o;if(ii&&console.log("select",t),typeof t=="object"&&console.warn('Switching to "'+t+'" might not work. Please either use an index or a AssetReference (not a scene reference)'),typeof t=="string"){const l=(i=this.scenes)==null?void 0:i.find(c=>c.url===t);if(!l){const c=le.getOrCreate(this.sourceId??"",t,this.context);return this.switchScene(c)}if(l)t=(s=this.scenes)==null?void 0:s.indexOf(l);else return Xo}if(!((o=this.scenes)!=null&&o.length))return Xo;if(t<0){if(this.clamp)return Xo;t=this.scenes.length-1}else if(t>=this.scenes.length){if(this.clamp)return Xo;t=0}const r=this.scenes[t];return this.switchScene(r)}unload(){return this.__lastSwitchScene=void 0,this.__lastSwitchScenePromise=void 0,this.__unloadCurrentScene()}async reload(){if(this.__lastSwitchScene){const t=this.__lastSwitchScene;return this.__lastSwitchScene=void 0,this.switchScene(t)}return!1}async switchScene(t){if(!(t instanceof le)){const i=typeof t;return i==="string"?this.select(t):i==="number"?this.select(t):(console.warn("SceneSwitcher: Can't switch to scene",t,"of type",i),!1)}return t.url===this.sourceId?(console.warn("SceneSwitcher: can't load own scene - prevent recursive loading",this.sourceId),!1):this.__lastSwitchScene===t&&this.__lastSwitchScenePromise?this.__lastSwitchScenePromise:(this.__lastSwitchScene=t,this.__lastSwitchScenePromise=this.__internalSwitchScene(t),await this.__lastSwitchScenePromise)}async __unloadCurrentScene(){const t=this._currentScene;if(this._currentScene=void 0,t){ii&&console.log("UNLOAD",t.url,"HasURL?: "+t.hasUrl);const i=this.tryGetSceneEventListener(t.asset);if(i!=null&&i.sceneClosing){const s=i.sceneClosing();s instanceof Promise&&await s}t.hasUrl?t.unload():t.asset instanceof j&&t.asset.removeFromParent()}}async __internalSwitchScene(t){var i,s,o,r,l;await this.__unloadCurrentScene();const c=this._currentIndex=((i=this.scenes)==null?void 0:i.indexOf(t))??-1;try{this._currentlyLoadingScene=t,this._currentLoadingProgress=new ProgressEvent("progress",{loaded:0,total:1});const h=new CustomEvent("loadscene-start",{detail:{scene:t,switcher:this,index:c}});this.dispatchEvent(h),(s=this.sceneLoadingStart)==null||s.invoke(h.detail),await this.onStartLoading(),await t.loadAssetAsync((u,p)=>{var g;this._currentLoadingProgress=p,this.dispatchEvent(p),(g=this.sceneLoadingProgress)==null||g.invoke(p)}).catch(console.error),await this.onEndLoading();const d=new CustomEvent("loadscene-finished",{detail:{scene:t,switcher:this,index:c}});if(this.dispatchEvent(d),this._currentLoadingProgress=void 0,this._currentlyLoadingScene=void 0,d.defaultPrevented)return ii&&console.warn("Adding loaded scene prevented:",t,d),!1;if(!t.asset)return ii&&console.warn("Failed loading scene:",t),!1;if(this._currentIndex===c){if(ii&&console.log("ADD",t.url),this._currentScene=t,QA){const g=((o=this.context.mainCameraComponent)==null?void 0:o.gameObject)||this.context.mainCamera;g?.removeFromParent();const y=this.gameObject.removeFromParent();Ti(this.context.scene,!0,!0),this.context.scene=new wi,this.context.scene.add(y),g&&this.context.scene.add(g)}if(O.add(t.asset,this.gameObject),this.useSceneLighting&&this.context.sceneLighting.enable(t),this.useSceneBackground){const g=this.context.lightmaps.tryGetSkybox(t.url);g?(g.mapping=ys,this.context.scene.background=g):ii&&console.warn("SceneSwitcher: Can't find skybox for scene "+t.url)}if(this.useHistory&&c>=0){let g=c.toString();if(this.useSceneName&&(g=b1(t.url)),(r=this.queryParameterName)!=null&&r.length)Yl(this.queryParameterName,g,this.useHistory);else{const y=history.state,f=this.guid+"::"+c;y!==f&&history.pushState(f,"unused",location.href)}}const u=this.tryGetSceneEventListener(t.asset);if(u!=null&&u.sceneOpened){const g=u.sceneOpened(this);g instanceof Promise&&await g}const p=new CustomEvent("scene-opened",{detail:{scene:t,switcher:this,index:c}});return this.dispatchEvent(p),(l=this.sceneLoaded)==null||l.invoke(this),!0}}catch(h){console.error(h)}return!1}preload(t){if(t>=0&&t<this.scenes.length){const i=this.scenes[t];if(i instanceof le)return i.preload()}return Xo}tryLoadFromQueryParam(){var t;if(!((t=this.queryParameterName)!=null&&t.length))return Xo;const i=C(this.queryParameterName);return typeof i=="boolean"?Xo:this.trySelectSceneFromValue(i)}trySelectSceneFromValue(t){if(typeof t=="string"){const i=parseInt(t);if(i>=0&&i<this.scenes.length)return this.select(i);{const s=t.toLowerCase();for(let o=0;o<this.scenes.length;o++){const r=this.scenes[o];if(r&&b1(r.url).toLowerCase().includes(s))return this.select(o)}}}else if(typeof t=="number"&&t>=0&&t<this.scenes.length)return this.select(t);return Xt()&&console.warn('Can not find scene: "'+t+'"',this),Xo}async onStartLoading(){var t,i;if(this._isCurrentlyLoading=!0,this.loadingScene&&(this._lastLoadingScene!==this.loadingScene&&(this._loadingScenePromise=void 0),this._lastLoadingScene=this.loadingScene,this._loadingScenePromise||(this._loadingScenePromise=(t=this.loadingScene)==null?void 0:t.loadAssetAsync().then(s=>s!=null)),await this._loadingScenePromise,this._isCurrentlyLoading&&(i=this.loadingScene)!=null&&i.asset)){ii&&console.log("Add loading scene",this.loadingScene.url,this.loadingScene.asset);const s=this.loadingScene.asset;O.add(s,this.gameObject);const o=this.tryGetSceneEventListener(s);if(o!=null&&o.sceneOpened){const r=o.sceneOpened(this);r instanceof Promise&&await r}}if(this._isCurrentlyLoading){const s=this.tryGetSceneEventListener(this.gameObject);if(s&&s.sceneOpened){const o=s.sceneOpened(this);o instanceof Promise&&await o}}}async onEndLoading(){var t;if(this._isCurrentlyLoading=!1,(t=this.loadingScene)!=null&&t.asset){ii&&console.log("Remove loading scene",this.loadingScene.url);const i=this.loadingScene.asset,s=this.tryGetSceneEventListener(i);if(typeof s?.sceneClosing=="function"){const o=s.sceneClosing();o instanceof Promise&&await o}O.remove(i)}if(!this._isCurrentlyLoading){const i=this.tryGetSceneEventListener(this.gameObject);if(i&&i.sceneClosing){const s=i.sceneClosing();s instanceof Promise&&await s}}}tryGetSceneEventListener(t,i=0){if(!t)return null;const s=O.foreachComponent(t,o=>{const r=o;if(r.sceneClosing||r.sceneOpened)return r});if(i===0&&!s&&t.children.length)for(const o of t.children){const r=this.tryGetSceneEventListener(o,i+1);if(r)return r}return s||null}}Ct([m()],ot.prototype,"autoLoadFirstScene",2),Ct([m(le)],ot.prototype,"scenes",2),Ct([m(le)],ot.prototype,"loadingScene",2),Ct([m()],ot.prototype,"queryParameterName",2),Ct([m()],ot.prototype,"useSceneName",2),Ct([m()],ot.prototype,"clamp",2),Ct([m()],ot.prototype,"useHistory",2),Ct([m()],ot.prototype,"useKeyboard",2),Ct([m()],ot.prototype,"useSwipe",2),Ct([m()],ot.prototype,"useSceneLighting",2),Ct([m()],ot.prototype,"useSceneBackground",2),Ct([m()],ot.prototype,"preloadNext",2),Ct([m()],ot.prototype,"preloadPrevious",2),Ct([m()],ot.prototype,"preloadConcurrent",2),Ct([m()],ot.prototype,"createMenuButtons",2),Ct([m(Se)],ot.prototype,"sceneLoadingStart",2),Ct([m(Se)],ot.prototype,"sceneLoadingProgress",2),Ct([m(Se)],ot.prototype,"sceneLoaded",2);function b1(n){const t=n.split("/").pop(),i=t?.split(".").shift();return i!=null&&i.length?i:n}class YA{constructor(t,i=1,s=1,o=2){a(this,"maxLoadAhead"),a(this,"maxLoadBehind"),a(this,"maxConcurrent"),a(this,"_isRunning",!1),a(this,"_switcher"),a(this,"_loadTasks",[]),a(this,"_maxConcurrentLoads",1),this._switcher=t,this.maxLoadAhead=i,this.maxLoadBehind=s,this.maxConcurrent=o}begin(t){if(this._isRunning)return;ii&&console.log("Preload begin",{delay:t}),this._isRunning=!0;let i=-10,s,o;const r=this._switcher.scenes,l=Date.now()+t,c=setInterval(()=>{if(this.allLoaded()&&(ii&&console.log("All scenes (pre-)loaded"),this.stop()),!this._isRunning){clearInterval(c);return}if(Date.now()<l||this.canLoadNewScene()===!1)return;(i===-10||i!==this._switcher.currentIndex)&&(i=this._switcher.currentIndex,o=0,s=0);const h=o%2===0;h&&(s+=1),o+=1;const d=h?this.maxLoadAhead:this.maxLoadBehind;if(s>d)return;const u=h?i+s:i-s;if(!(u<0)&&!(u<0||u>=r.length)&&!this._loadTasks.some(p=>p.index===u)){const p=r[u];ii&&console.log("Preload scene",{roomIndex:u,searchForward:h,lastRoom:i,currentIndex:this._switcher.currentIndex,tasks:this._loadTasks.length},p?.url),new ZA(u,p,this._loadTasks)}},200)}stop(){this._isRunning=!1}canLoadNewScene(){return this._loadTasks.length<this._maxConcurrentLoads}allLoaded(){if(this._switcher.scenes){for(const t of this._switcher.scenes)if(t?.isLoaded()===!1)return!1}return!0}}class ZA{constructor(t,i,s){a(this,"index"),a(this,"asset"),a(this,"tasks"),this.index=t,this.asset=i,this.tasks=s,s.push(this),this.awaitLoading()}async awaitLoading(){this.asset&&!this.asset.isLoaded()&&(ii&&console.log("Preload start: "+this.asset.url,this.index),await this.asset.preload(),ii&&console.log("Preload finished: "+this.asset.url,this.index));const t=this.tasks.indexOf(this);t>=0&&this.tasks.splice(t,1)}}function KA(){return new Promise((n,t)=>{const i=()=>{i!=null&&(document.removeEventListener("pointerdown",i),document.removeEventListener("click",i),document.removeEventListener("dragstart",i),document.removeEventListener("touchstart",i),n())};document.addEventListener("pointerdown",i),document.addEventListener("click",i),document.addEventListener("dragstart",i),document.addEventListener("touchstart",i)})}async function JA(n){await KA(),n()}var eI=Object.defineProperty,tI=Object.getOwnPropertyDescriptor,Fi=(n,t,i,s)=>{for(var o=s>1?void 0:s?tI(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&eI(t,i,o),o};const Ot=C("debugvideo");var _1=(n=>(n[n.None=0]="None",n[n.AdjustHeight=1]="AdjustHeight",n[n.AdjustWidth=2]="AdjustWidth",n))(_1||{}),w1=(n=>(n[n.VideoClip=0]="VideoClip",n[n.Url=1]="Url",n))(w1||{}),x1=(n=>(n[n.CameraFarPlane=0]="CameraFarPlane",n[n.CameraNearPlane=1]="CameraNearPlane",n[n.RenderTexture=2]="RenderTexture",n[n.MaterialOverride=3]="MaterialOverride",n))(x1||{});class ft extends A{constructor(){super(),a(this,"playOnAwake",!0),a(this,"aspectMode",0),a(this,"clip",null),a(this,"source",1),a(this,"_url",null),a(this,"renderMode"),a(this,"targetMaterialProperty"),a(this,"targetMaterialRenderer"),a(this,"targetTexture"),a(this,"time",0),a(this,"_playbackSpeed",1),a(this,"_isLooping",!1),a(this,"_muted",!1),a(this,"_audioOutputMode",2),a(this,"playInBackground",!0),a(this,"_crossOrigin","anonymous"),a(this,"_videoElement",null),a(this,"_videoTexture",null),a(this,"_videoMaterial",null),a(this,"_isPlaying",!1),a(this,"wasPlaying",!1),a(this,"visibilityChanged",t=>{switch(document.visibilityState){case"hidden":this.playInBackground||(this.wasPlaying=this._isPlaying,this.pause());break;case"visible":this.wasPlaying&&!this._isPlaying&&this.play();break}}),a(this,"_receivedInput",!1),a(this,"_overlay",null),a(this,"_targetObjects"),a(this,"_updateAspectRoutineId",-1),a(this,"_hls"),a(this,"onHlsAvailable",()=>{var t;Ot&&console.log("HLS: available",this.clip),!(!this.shouldUseM3U||!this.url)&&(this._hls||(this._hls=new Hls),this.videoElement.autoplay=!0,this._hls.loadSource(this.url),this._hls.attachMedia(this.videoElement),(t=this._videoElement)==null||t.play(),Ot&&console.log("HLS: loaded",this.clip))}),JA(()=>{this._receivedInput=!0,this.updateVideoElementSettings()}),this._targetObjects=[],C("videoscreenspace")&&window.addEventListener("keydown",t=>{t.key==="f"&&(this.screenspace=!this.screenspace)})}get url(){return this._url}set url(t){const i=this._url!==t;this.__didAwake?i&&this.setClipURL(t??""):this._url=t}get playbackSpeed(){var t;return((t=this._videoElement)==null?void 0:t.playbackRate)??this._playbackSpeed}set playbackSpeed(t){this._playbackSpeed=t,this._videoElement&&(this._videoElement.playbackRate=t)}get isLooping(){var t;return((t=this._videoElement)==null?void 0:t.loop)??this._isLooping}set isLooping(t){this._isLooping=t,this._videoElement&&(this._videoElement.loop=t)}get currentTime(){var t;return((t=this._videoElement)==null?void 0:t.currentTime)??this.time}set currentTime(t){this._videoElement?this._videoElement.currentTime=t:this.time=t}get isPlaying(){const t=this._videoElement;return!!(t&&(t.currentTime>0&&!t.paused&&!t.ended&&t.readyState>t.HAVE_CURRENT_DATA||t.srcObject&&t.srcObject.active))}get crossOrigin(){var t;return((t=this._videoElement)==null?void 0:t.crossOrigin)??this._crossOrigin}set crossOrigin(t){this._crossOrigin=t,this._videoElement&&(t!==null?this._videoElement.setAttribute("crossorigin",t):this._videoElement.removeAttribute("crossorigin"))}get videoMaterial(){return!this._videoMaterial&&!this.create(!1)?null:this._videoMaterial}get videoTexture(){return!this._videoTexture&&!this.create(!1)?null:this._videoTexture}get videoElement(){return!this._videoElement&&!this.create(!1)?null:this._videoElement}requestPictureInPicture(){return this._videoElement?this._videoElement.requestPictureInPicture():null}get muted(){var t;return((t=this._videoElement)==null?void 0:t.muted)??this._muted}set muted(t){this._muted=t,this._videoElement&&(this._videoElement.muted=t)}get currentVideo(){return this.clip}set audioOutputMode(t){t!==this._audioOutputMode&&(t===1&&F()&&console.warn("VideoAudioOutputMode.AudioSource is not yet implemented"),this._audioOutputMode=t,this.updateVideoElementSettings())}get audioOutputMode(){return this._audioOutputMode}preloadVideo(){Ot&&console.log("Video Preload: "+this.name,this.clip),this.create(!1)}preload(){this.preloadVideo()}setVideo(t){this.clip=t,this.source=0,this._videoElement?(this._videoElement.srcObject=t,this._isPlaying&&this.play(),this.updateAspect()):this.create(this.playOnAwake)}setClipURL(t){this._url!==t&&(this._url=t,this.source=1,Ot&&console.log("set url",t),this._videoElement?t.endsWith(".m3u8")||t.includes(".m3u")?this.ensureM3UCanBePlayed():(this._videoElement.src=t,this._isPlaying&&(this.stop(),this.play())):this.create(this.playOnAwake))}onEnable(){var t,i;Ot&&console.log("VideoPlayer.onEnable",w1[this.source],this.clip,this.url,this),window.addEventListener("visibilitychange",this.visibilityChanged),this.playOnAwake===!0?this.create(!0):this.preloadVideo(),this.screenspace?(t=this._overlay)==null||t.start():(i=this._overlay)==null||i.stop()}onDisable(){var t;window.removeEventListener("visibilitychange",this.visibilityChanged),(t=this._overlay)==null||t.stop(),this.pause()}onDestroy(){var t;this._videoElement&&((t=this.videoElement)==null||t.remove(),this._videoElement=null),this._videoTexture&&(this._videoTexture.dispose(),this._videoTexture=null)}play(){var t,i;if(this._videoElement||this.create(!1),!this._videoElement){Ot&&console.warn("Can not play: no video element found",this);return}if(!(this._isPlaying&&!((t=this._videoElement)!=null&&t.ended)&&!((i=this._videoElement)!=null&&i.paused))){if(this._isPlaying=!0,this._receivedInput||(this._videoElement.muted=!0),this.handleBeginPlaying(!1),this.shouldUseM3U){this.ensureM3UCanBePlayed();return}Ot&&console.log("Video Play()",this.clip,this._videoElement,this.time),this._videoElement.currentTime=this.time,this._videoElement.play().catch(s=>{var o;console.log(s),Ot&&console.error("Error playing video",s,"CODE="+s.code,(o=this.videoElement)==null?void 0:o.src,this),setTimeout(()=>{this._isPlaying&&!this.destroyed&&this.activeAndEnabled&&this.play()},1e3)}),Ot&&console.log("play",this._videoElement,this.time)}}stop(){this._isPlaying=!1,this.time=0,this._videoElement&&(this._videoElement.currentTime=0,this._videoElement.pause(),Ot&&console.log("STOP",this))}pause(){var t,i;this.time=((t=this._videoElement)==null?void 0:t.currentTime)??0,this._isPlaying=!1,(i=this._videoElement)==null||i.pause(),Ot&&console.log("PAUSE",this,this.currentTime)}create(t){let i;switch(this.source){case 0:i=this.clip;break;case 1:i=this.url,!(i!=null&&i.length)&&typeof this.clip=="string"&&(i=this.clip);break}return i?(this._videoElement||(Ot&&console.warn("Create VideoElement",this),this._videoElement=this.createVideoElement(),this.context.domElement.shadowRoot.prepend(this._videoElement),this.updateVideoElementStyles()),typeof i=="string"?(Ot&&console.log("Set Video src",i),this._videoElement.src=i):(Ot&&console.log("Set Video srcObject",i),this._videoElement.srcObject=i),this._videoTexture||(this._videoTexture=new _C(this._videoElement)),this._videoTexture.flipY=!1,this._videoTexture.colorSpace=gn,t&&this.handleBeginPlaying(t),Ot&&console.log("Video: handle playing done...",i,t),!0):(Ot&&console.warn("No video source set",this),!1)}updateAspect(){this.aspectMode!==0&&this.startCoroutine(this.updateAspectImpl())}get screenspace(){var t;return((t=this._overlay)==null?void 0:t.enabled)??!1}set screenspace(t){var i;if(t){if(!this._videoTexture)return;this._overlay||(this._overlay=new iI(this.context)),this._overlay.add(this._videoTexture)}else(i=this._overlay)==null||i.remove(this._videoTexture);this._overlay&&(this._overlay.enabled=t)}createVideoElement(){const t=document.createElement("video");return this._crossOrigin&&t.setAttribute("crossorigin",this._crossOrigin),Ot&&console.log("created video element",t),t}handleBeginPlaying(t){var i,s;if(!this.activeAndEnabled||!this._videoElement)return;this._targetObjects.length=0;let o=this.gameObject;switch(this.renderMode){case 3:o=(i=this.targetMaterialRenderer)==null?void 0:i.gameObject,o||(o=(s=O.getComponent(this.gameObject,Ze))==null?void 0:s.gameObject);break;case 2:console.error("VideoPlayer renderTexture not implemented yet. Please use material override instead");return}if(!o){console.error("Missing target for video material renderer",this.name,x1[this.renderMode],this);return}const r=o.material;if(r){this._targetObjects.push(o),r!==this._videoMaterial&&(this._videoMaterial=r.clone(),o.material=this._videoMaterial);const l="map",c=this._videoMaterial;if(!this.targetMaterialProperty)c[l]=this._videoTexture;else switch(this.targetMaterialProperty){default:c[l]=this._videoTexture;break}}else{console.warn("Can not play video, no material found, this might be a multimaterial case which is not supported yet");return}this.updateVideoElementSettings(),this.updateVideoElementStyles(),t&&(this.shouldUseM3U&&this.ensureM3UCanBePlayed(),this.play())}updateVideoElementSettings(){if(!this._videoElement)return;this._videoElement.loop=this._isLooping,this._videoElement.currentTime=this.currentTime,this._videoElement.playbackRate=this._playbackSpeed,this._videoElement.playsInline=!0;let t=!this._receivedInput||this.audioOutputMode===0;!t&&this._muted&&(t=!0),this._videoElement.muted=t,this.playOnAwake&&(this._videoElement.autoplay=!0)}updateVideoElementStyles(){this._videoElement&&(this._videoElement.style.userSelect="none",this._videoElement.style.visibility="hidden",this._videoElement.style.display="none",this.updateAspect())}*updateAspectImpl(){const t=++this._updateAspectRoutineId,i=void 0,s=this.clip;for(;t===this._updateAspectRoutineId&&this.aspectMode!==0&&this.clip&&s===this.clip&&this._isPlaying;){if(!s||typeof s=="string")return;let o;for(const r of s.getVideoTracks()){const l=r.getSettings();if(l&&l.width&&l.height){o=l.width/l.height;break}else o=this.context.renderer.domElement.clientWidth/this.context.renderer.domElement.clientHeight}if(o===void 0){for(let r=0;r<10;r++)yield;if(!this.isPlaying)break;continue}if(i===o){yield;continue}for(const r of this._targetObjects){let l=1;if(r.parent){const c=Ye(r.parent);l=c.x/c.y}switch(this.aspectMode){case 1:r.scale.y=1/o*r.scale.x*l;break;case 2:r.scale.x=o*r.scale.y*l;break}}for(let r=0;r<3;r++)yield}}get shouldUseM3U(){return this.url!=null&&(this.url.endsWith(".m3u8")||this.url.endsWith(".m3u"))&&this.source===1}ensureM3UCanBePlayed(){if(!this.shouldUseM3U)return;let t=document.head.querySelector("script[data-hls_library]");t?globalThis.Hls?this.onHlsAvailable():t.addEventListener("load",this.onHlsAvailable):(Ot&&console.log("HLS: load script"),t=document.createElement("script"),t.dataset.hls_library="hls.js",t.src="https://cdn.jsdelivr.net/npm/hls.js@1",t.addEventListener("load",this.onHlsAvailable),document.head.append(t))}}Fi([m()],ft.prototype,"playOnAwake",2),Fi([m()],ft.prototype,"aspectMode",2),Fi([m(URL)],ft.prototype,"clip",2),Fi([m()],ft.prototype,"source",2),Fi([m(URL)],ft.prototype,"url",1),Fi([m()],ft.prototype,"renderMode",2),Fi([m()],ft.prototype,"targetMaterialProperty",2),Fi([m(Ze)],ft.prototype,"targetMaterialRenderer",2),Fi([m(Le)],ft.prototype,"targetTexture",2),Fi([m()],ft.prototype,"time",2),Fi([m()],ft.prototype,"playbackSpeed",1),Fi([m()],ft.prototype,"isLooping",1),Fi([m()],ft.prototype,"audioOutputMode",1);class iI{constructor(t){a(this,"context"),a(this,"_videos",[]),a(this,"_screenspaceModeQuad"),a(this,"_isInScreenspaceMode",!1),a(this,"_input"),this.context=t,this._input=new nI(this)}get enabled(){return this._isInScreenspaceMode}set enabled(t){t?this.start():this.stop()}add(t){this._videos.indexOf(t)===-1&&this._videos.push(t)}remove(t){if(!t)return;const i=this._videos.indexOf(t);i>=0&&this._videos.splice(i,1)}start(){var t;if(this._isInScreenspaceMode||this._videos.length<0)return;const i=this._videos[this._videos.length-1];if(!i)return;if(this._isInScreenspaceMode=!0,!this._screenspaceModeQuad){if(this._screenspaceModeQuad=uo.createPrimitive(pr.Quad,{material:new sI(i)}),!this._screenspaceModeQuad)return;this._screenspaceModeQuad.geometry.scale(2,2,2)}const s=this._screenspaceModeQuad;this.context.scene.add(s),this.updateScreenspaceMaterialUniforms();const o=s.material;o?.reset(),(t=this._input)==null||t.enable(o)}stop(){var t;this._isInScreenspaceMode=!1,this._screenspaceModeQuad&&((t=this._input)==null||t.disable(),this._screenspaceModeQuad.removeFromParent())}updateScreenspaceMaterialUniforms(){var t;const i=(t=this._screenspaceModeQuad)==null?void 0:t.material;i&&(i.screenAspect=this.context.domElement.clientWidth/this.context.domElement.clientHeight)}}class nI{constructor(t){a(this,"_onResizeScreenFn"),a(this,"_onKeyUpFn"),a(this,"_onMouseWheelFn"),a(this,"context"),a(this,"overlay"),a(this,"_material"),a(this,"_isPinching",!1),a(this,"_lastPinch",0),this.overlay=t,this.context=t.context}enable(t){this._material=t,window.addEventListener("resize",this._onResizeScreenFn=()=>{this.overlay.updateScreenspaceMaterialUniforms()}),window.addEventListener("keyup",this._onKeyUpFn=o=>{o.key==="Escape"&&this.overlay.stop()}),window.addEventListener("wheel",this._onMouseWheelFn=o=>{this.overlay.enabled&&(t.zoom+=o.deltaY*5e-4,o.preventDefault())},{passive:!1});const i=new re;window.addEventListener("mousemove",o=>{if(this.overlay.enabled&&this.context.input.getPointerPressed(0)){const r=new re(o.movementX,o.movementY);r.x/=this.context.domElement.clientWidth,r.y/=this.context.domElement.clientHeight,i.set(r.x,r.y),i.multiplyScalar(t.zoom/-this.context.time.deltaTime*.01),t.offset=t.offset.add(i)}}),window.addEventListener("pointermove",o=>{this.overlay.enabled&&this.context.input.getPointerPressed(0)&&this.context.input.getTouchesPressedCount()===1&&(i.set(o.movementX,o.movementY),i.multiplyScalar(t.zoom*-this.context.time.deltaTime*.05),t.offset=t.offset.add(i))});let s=0;window.addEventListener("touchstart",o=>{if(o.touches.length<2){this.context.time.time-s<.3&&this.overlay.stop(),s=this.context.time.time;return}this._isPinching=!0,this._lastPinch=0}),window.addEventListener("touchmove",o=>{if(!this._isPinching||!this._material)return;const r=o.touches[0],l=o.touches[1],c=r.clientX-l.clientX,h=r.clientY-l.clientY,d=Math.sqrt(c*c+h*h);if(this._lastPinch!==0){const u=d-this._lastPinch;this._material.zoom-=u*.004}this._lastPinch=d}),window.addEventListener("touchend",()=>{this._isPinching=!1})}disable(){this._onResizeScreenFn&&(window.removeEventListener("resize",this._onResizeScreenFn),this._onResizeScreenFn=void 0),this._onKeyUpFn&&(window.removeEventListener("keyup",this._onKeyUpFn),this._onKeyUpFn=void 0),this._onMouseWheelFn&&(window.removeEventListener("wheel",this._onMouseWheelFn),this._onMouseWheelFn=void 0)}}class sI extends mn{constructor(t){super(),a(this,"_offset",new re),this.uniforms={map:{value:t},screenAspect:{value:1},offsetScale:{value:new fe(0,0,1,1)}},this.vertexShader=`
        uniform sampler2D map;
        uniform float screenAspect;
        uniform vec4 offsetScale;
        varying vec2 vUv;

        void main() {

            gl_Position = vec4( position , 1.0 );
            vUv = uv;
            vUv.y = 1. - vUv.y;

            // fit into screen
            ivec2 res = textureSize(map, 0);
            float videoAspect = float(res.x) / float(res.y);
            float aspect = videoAspect / screenAspect;
            if(aspect >= 1.0) 
            {
                vUv.y = vUv.y * aspect;
                float offset = (1. - aspect) * .5;
                vUv.y = vUv.y + offset;
            }
            else
            {
                vUv.x = vUv.x / aspect;
                float offset = (1. - 1. / aspect) * .5;
                vUv.x = vUv.x + offset;
            }

            vUv.x -= .5;
            vUv.y -= .5;

            vUv.x *= offsetScale.z;
            vUv.y *= offsetScale.z;
            vUv.x += offsetScale.x;
            vUv.y += offsetScale.y;

            vUv.x += .5;
            vUv.y += .5;
        }

        `,this.fragmentShader=`
        uniform sampler2D map;
        varying vec2 vUv;
        void main() {
            if(vUv.x < 0. || vUv.x > 1. || vUv.y < 0. || vUv.y > 1.)
                gl_FragColor = vec4(0., 0., 0., 1.);
            else
            {
                vec4 texcolor = texture2D(map, vUv);
                gl_FragColor = texcolor;
            }
        }
        `}set screenAspect(t){this.uniforms.screenAspect.value=t,this.needsUpdate=!0}set offset(t){const i=this.uniforms.offsetScale.value;i.x=t.x,i.y=t.y,this.uniforms.offsetScale.value=i,this.needsUpdate=!0}get offset(){const t=this.uniforms.offsetScale.value;return this._offset.set(t.x,t.y),this._offset}set zoom(t){const i=this.uniforms.offsetScale.value;t<.001&&(t=.001),i.z=t,this.needsUpdate=!0}get zoom(){return this.uniforms.offsetScale.value.z}reset(){this.offset=this.offset.set(0,0),this.zoom=1,this.needsUpdate=!0}}var oI=Object.defineProperty,rI=Object.getOwnPropertyDescriptor,Eh=(n,t,i,s)=>{for(var o=s>1?void 0:s?rI(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&oI(t,i,o),o};const Lt=C("debugscreensharing");var S1=(n=>(n[n.Screen=0]="Screen",n[n.Camera=1]="Camera",n[n.Canvas=2]="Canvas",n[n.Microphone=3]="Microphone",n))(S1||{});class Qo extends A{constructor(){super(...arguments),a(this,"allowStartOnClick",!0),a(this,"autoConnect",!1),a(this,"_videoPlayer"),a(this,"_audioSource"),a(this,"device","Screen"),a(this,"deviceName"),a(this,"deviceFilter"),a(this,"_net"),a(this,"_requestOpen",!1),a(this,"_currentStream",null),a(this,"_currentMode",0),a(this,"onJoinedRoom",async()=>{await yn(1e3),this.autoConnect&&!this.isSending&&!this.isReceiving&&this.context.connection.isInRoom&&this.share()}),a(this,"_activeShareRequest",null),a(this,"onReceiveStream",t=>{var i;((i=t.stream)==null?void 0:i.active)===!0&&this.setStream(t.stream,2)}),a(this,"onCallEnded",t=>{Lt&&console.log("CALL ENDED",this.isReceiving,this==null?void 0:this.screenspace),this.isReceiving&&(this.screenspace=!1)})}onPointerEnter(){this.context.connection.allowEditing!=!1&&this.allowStartOnClick&&this.context.input.setCursor("pointer")}onPointerExit(){this.context.connection.allowEditing!=!1&&this.allowStartOnClick&&this.context.input.unsetCursor("pointer")}onPointerClick(t){var i;if(this.context.connection.allowEditing!=!1&&this.allowStartOnClick&&!(t&&t.pointerId!==0)){if(this.isReceiving&&(i=this.videoPlayer)!=null&&i.isPlaying){this.videoPlayer&&(this.videoPlayer.screenspace=!this.videoPlayer.screenspace);return}if(this.isSending){this.close();return}this.share()}}set videoPlayer(t){this._videoPlayer&&(this.isSending||this.isReceiving)&&this._videoPlayer.stop(),this._videoPlayer=t,this._videoPlayer&&this._currentStream&&(this.isSending||this.isReceiving)&&this._videoPlayer.setVideo(this._currentStream)}get videoPlayer(){return this._videoPlayer}get screenspace(){var t;return((t=this.videoPlayer)==null?void 0:t.screenspace)??!1}set screenspace(t){this.videoPlayer&&(this.videoPlayer.screenspace=t)}get currentScream(){return this._currentStream}get currentMode(){return this._currentMode}get isSending(){var t;return((t=this._currentStream)==null?void 0:t.active)&&this._currentMode===1}get isReceiving(){if(this._currentMode===2){if(!this._currentStream||this._currentStream.active===!1)return!1;const t=this._currentStream.getTracks();for(const i of t)if(i.readyState==="live")return!0}return!1}get requiresVideoPlayer(){return this.device!=="Microphone"}awake(){typeof this.device=="number"&&(this.device=S1[this.device]),Lt&&console.log("Screensharing",this.name,this),Ne.registerWaitForAllowAudio(()=>{this._videoPlayer&&this._currentStream&&this._currentMode===2&&(this._videoPlayer.playInBackground=!0,this._videoPlayer.setVideo(this._currentStream))}),this._net=new id(this)}onEnable(){var t,i,s;(t=this._net)==null||t.enable(),(i=this._net)==null||i.addEventListener(Qn.StreamReceived,this.onReceiveStream),(s=this._net)==null||s.addEventListener(Qn.StreamEnded,this.onCallEnded),this.context.connection.beginListen(ne.JoinedRoom,this.onJoinedRoom),this.autoConnect&&yn(1e3).then(()=>(this.enabled&&this.autoConnect&&!this.isReceiving&&!this.isSending&&this.context.connection.isInRoom&&this.share(),0))}onDisable(){var t,i,s;(t=this._net)==null||t.removeEventListener(Qn.StreamReceived,this.onReceiveStream),(i=this._net)==null||i.removeEventListener(Qn.StreamEnded,this.onCallEnded),this.context.connection.stopListen(ne.JoinedRoom,this.onJoinedRoom),(s=this._net)==null||s.disable(),this.close()}_ensureVideoPlayer(){const t=new ft;t.aspectMode=_1.AdjustWidth,O.addComponent(this.gameObject,t),this._videoPlayer=t}async share(t){return this._activeShareRequest?this._activeShareRequest:(this._activeShareRequest=this.internalShare(t),this._activeShareRequest.then(()=>this._activeShareRequest=null))}async internalShare(t){if(this.context.connection.isInRoom===!1){console.warn("Can not start screensharing: requires network connection"),F()&&we("Can not start screensharing: requires network connection. Add a SyncedRoom component or join a room first.");return}if(t!=null&&t.device&&(this.device=t.device),!this.videoPlayer&&this.requiresVideoPlayer&&(this._videoPlayer||(this._videoPlayer=O.getComponent(this.gameObject,ft)??void 0),this.videoPlayer||this._ensureVideoPlayer(),!this.videoPlayer)){console.warn("Can not share video without a videoPlayer assigned");return}this._requestOpen=!0;try{const i=t?.constraints??{echoCancellation:!0,autoGainControl:!1},s={video:i,audio:i},o=s.video;switch(o!==void 0&&typeof o!="boolean"&&(o.width||(o.width={max:1920}),o.height||(o.height={max:1920}),o.aspectRatio||(o.aspectRatio={ideal:1.7777777778}),o.frameRate||(o.frameRate={ideal:24}),o.facingMode||(o.facingMode={ideal:"user"})),this.device){case"Camera":this.tryShareUserCamera(s,t);break;case"Screen":{if(!navigator.mediaDevices.getDisplayMedia){console.error("No getDisplayMedia support");return}const c=await navigator.mediaDevices.getDisplayMedia(s);this._requestOpen?this.setStream(c,1):Yn(c)}break;case"Canvas":const r=0,l=this.context.renderer.domElement.captureStream(r);this.setStream(l,1);break;case"Microphone":{if(!navigator.mediaDevices.getUserMedia){console.error("No getDisplayMedia support");return}s.video=!1;const c=await navigator.mediaDevices.getUserMedia(s);this._requestOpen?this.setStream(c,1):Yn(c)}break;default:console.error("Can not start screen sharing: Unknown device type",this.device)}}catch(i){if(i.name==="NotAllowedError"){console.log("Selection cancelled"),this._requestOpen=!1;return}console.error("Error opening video",i)}}close(){var t;this._requestOpen=!1,this._currentStream&&(Lt&&console.warn("Close current stream / disposing resources, stream was active?",this._currentStream.active),(t=this._net)==null||t.stopSendingStream(this._currentStream),Yn(this._currentStream),this._currentMode=0,this._currentStream=null)}setStream(t,i){var s,o,r;if(t===this._currentStream||(this.close(),!t))return;this._currentStream=t,this._requestOpen=!0,this._currentMode=i;const l=this.device!=="Microphone",c=i===1;l?(this._videoPlayer||this._ensureVideoPlayer(),this._videoPlayer?this._videoPlayer.setVideo(t):console.error("No video player assigned for video stream")):(this._audioSource||(this._audioSource=new Ne,this._audioSource.spatialBlend=0,this._audioSource.volume=1,this.gameObject.addComponent(this._audioSource)),c||(Lt&&console.log("PLAY",t.getAudioTracks()),this._audioSource.volume=1,(s=this._audioSource)==null||s.play(t))),c&&((o=this._net)==null||o.startSendingStream(t)),c&&(this._videoPlayer&&(this._videoPlayer.muted=!0),(r=this._audioSource)==null||r.stop());for(const h of t.getTracks())h.addEventListener("ended",()=>{Lt&&console.log("Track ended",h),this.close()}),Lt&&h.kind==="video"&&console.log(c?"Video \u2192":"Video \u2190",h.getSettings())}async tryShareUserCamera(t,i){const s=(await navigator.mediaDevices.enumerateDevices()).filter(r=>r.kind==="videoinput");Lt&&console.log(`Request camera. These are your kind:videoinput devices:
`,s);let o=!1;for(const r of s)try{if(!this._requestOpen){Lt&&console.log("Camera selection cancelled");break}if(r.kind!=="videoinput"){Lt&&console.log("Skipping non-video device",r);continue}const l=r.deviceId;if(i?.deviceId!=null||i?.deviceFilter!=null){if(i?.deviceId!==void 0&&l!==i.deviceId){Lt&&console.log("Skipping device due to options.deviceId: "+r.label+"; "+r.deviceId);continue}if(i!=null&&i.deviceFilter&&i.deviceFilter(r)===!1){Lt&&console.log("Skipping device due to options.deviceFilter: "+r.label+"; "+r.deviceId);continue}}else if(this.deviceFilter)if(this.deviceFilter(r)===!1){Lt&&console.log("Skipping device due to ScreenShare.deviceFilter: "+r.label+"; "+r.deviceId);continue}else Lt&&console.log("Selected device by filter",r);else if(this.deviceName){const h=r.label.toLowerCase(),d=this.deviceName.toLowerCase(),u=h.includes(d),p=r.deviceId===this.deviceName;if(!u&&!p){Lt&&console.log("Skipping device due to ScreenShare.deviceName: "+r.label+"; "+r.deviceId);continue}else Lt&&console.log("Selected device by name",r)}t.video!==!1&&((typeof t.video>"u"||typeof t.video=="boolean")&&(t.video={}),t.video.deviceId=l),o=!0;const c=await navigator.mediaDevices.getUserMedia(t).catch(h=>(console.error("Failed to get user media",h),null));if(c===null)continue;this._requestOpen?(this.setStream(c,1),Lt&&console.log("Selected camera",r)):(Yn(c),Lt&&console.log("Camera selection cancelled"));break}catch(l){if(l.message==="Failed to allocate videosource"||l.message==="Could not start video source"){we("Failed to start video: Try another camera (Code "+l.code+")"),console.warn(l);continue}else console.error("Failed to get user media",l.message,l.code,l)}!o&&F()&&(we("No camera found for sharing. Please connect a camera (see console for more information)"),console.warn("No camera found for sharing. Please connect a camera",s,this.deviceName,"Using deviceFilter? "+this.deviceFilter!=null,"Using options? "+i!=null,"Using deviceName? "+this.deviceName!=null,"Using options.deviceId? "+i?.deviceId!=null,"Using options.deviceFilter? "+i?.deviceFilter!=null))}}Eh([m()],Qo.prototype,"allowStartOnClick",2),Eh([m()],Qo.prototype,"autoConnect",2),Eh([m(ft)],Qo.prototype,"videoPlayer",1),Eh([m()],Qo.prototype,"device",2),Eh([m()],Qo.prototype,"deviceName",2);var aI=Object.defineProperty,lI=Object.getOwnPropertyDescriptor,C1=(n,t,i,s)=>{for(var o=s>1?void 0:s?lI(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&aI(t,i,o),o};class Ah extends A{constructor(){super(...arguments),a(this,"mode",0),a(this,"shadowColor",new xe(0,0,0,1)),a(this,"targetMesh")}start(){if(this.gameObject instanceof X)this.gameObject instanceof X&&this.gameObject.material&&(this.gameObject.material=this.gameObject.material.clone(),this.targetMesh=this.gameObject,this.targetMesh.receiveShadow=!0);else{const t=uo.createPrimitive(pr.Quad,{name:"ShadowCatcher",material:new Ft({color:10066329,roughness:1,metalness:0,transparent:!0})});t.receiveShadow=!0,t.geometry.rotateX(-Math.PI/2),this.gameObject.add(t),this.targetMesh=t}if(!this.targetMesh){console.warn("ShadowCatcher: no mesh to apply shadow catching to. Groups are currently not supported.");return}switch(this.targetMesh.layers.set(2),this.mode){case 0:this.applyShadowMaterial();break;case 1:this.applyLightBlendMaterial();break;case 2:this.applyOccluderMaterial();break}}applyLightBlendMaterial(){if(!this.targetMesh)return;const t=this.targetMesh.material;t.blending=Ky,this.applyMaterialOptions(t),t.onBeforeCompile=i=>{i.fragmentShader=i.fragmentShader.replace("vec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;",`vec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;
            // diffuse-only lighting with overdrive to somewhat compensate
            // for the loss of indirect lighting and to make it more visible.
            vec3 direct = (reflectedLight.directDiffuse + reflectedLight.directSpecular) * 6.6;
            float max = max(direct.r, max(direct.g, direct.b));
            
            // early out - we're simply returning direct lighting and some alpha based on it so it can 
            // be blended onto the scene.
            gl_FragColor = vec4(direct, max);
            return;
            `)},t.userData.isLightBlendMaterial=!0}applyShadowMaterial(){if(this.targetMesh)if(this.targetMesh.material.type!=="ShadowMaterial"){const t=new zy;t.color=this.shadowColor,t.opacity=this.shadowColor.alpha,this.applyMaterialOptions(t),this.targetMesh.material=t,t.userData.isShadowCatcherMaterial=!0}else{const t=this.targetMesh.material;t.color=this.shadowColor,t.opacity=this.shadowColor.alpha,this.applyMaterialOptions(t),t.userData.isShadowCatcherMaterial=!0}}applyOccluderMaterial(){if(this.targetMesh){let t=this.targetMesh.material;if(!t){const i=new Re;this.targetMesh.material=i,t=i}t.depthWrite=!0,t.stencilWrite=!0,t.colorWrite=!1,this.gameObject.renderOrder=-100}}applyMaterialOptions(t){t&&(t.depthWrite=!1,t.stencilWrite=!1)}}C1([m()],Ah.prototype,"mode",2),C1([m(xe)],Ah.prototype,"shadowColor",2);var cI=Object.defineProperty,hI=Object.getOwnPropertyDescriptor,Ih=(n,t,i,s)=>{for(var o=s>1?void 0:s?hI(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&cI(t,i,o),o};const on=C("debugskybox");sy("skybox-image"),sy("environment-image");function O1(n,t,i,s,o){const r=new cs;r.allowDrop=!1,r.allowNetworking=!1,r.background=i,r.environment=s,O.addComponent(n.scene,r);const l=c=>{typeof c=="string"&&(on&&console.log(o,"CHANGED TO",c),r.setSkybox(c))};return kv(n.domElement,o,l),r.addEventListener("destroy",()=>{on&&console.log("Destroyed attribute remote skybox",o),Mv(n.domElement,o,l)}),r.setSkybox(t)}const Lp=new Array;ue.registerCallback(pe.ContextCreationStart,n=>{var t;const i=n.context,s=i.domElement.getAttribute("skybox-image")||i.domElement.getAttribute("background-image"),o=i.domElement.getAttribute("environment-image");if(s){on&&console.log("Creating remote skybox to load "+s),((t=i.mainCameraComponent)==null?void 0:t.clearFlags)!==Oo.Skybox&&console.warn('"skybox-image"/"background-image" attribute has no effect: camera clearflags are not set to "Skybox"');const r=O1(i,s,!0,!1,"skybox-image");Lp.push(r)}if(o){on&&console.log("Creating remote environment to load "+o);const r=O1(i,o,!1,!0,"environment-image");Lp.push(r)}}),ue.registerCallback(pe.ContextCreationStart,()=>Promise.all(Lp).finally(()=>{Lp.length=0}));function P1(){return globalThis.NEEDLE_ENGINE_SKYBOX_TEXTURES||(globalThis.NEEDLE_ENGINE_SKYBOX_TEXTURES=new Array),globalThis.NEEDLE_ENGINE_SKYBOX_TEXTURES}function k1(n){const t=P1().find(i=>i.src===n);return t?(on&&console.log("Skybox: Found previously loaded texture for "+n),t.texture):null}async function dI(n){const t=await n;_g(t,!0),Ee(t)}function uI(n,t){const i=P1();for(;i.length>5;){const s=i.shift();s&&dI(s.texture)}t.then(s=>_g(s,!1)),i.push({src:n,texture:t})}class cs extends A{constructor(){super(...arguments),a(this,"url"),a(this,"allowDrop",!0),a(this,"background",!0),a(this,"environment",!0),a(this,"allowNetworking",!0),a(this,"_loader"),a(this,"_prevUrl"),a(this,"_prevLoadedEnvironment"),a(this,"_prevEnvironment",null),a(this,"_prevBackground",null),a(this,"validTextureTypes",[".ktx2",".hdr",".exr",".jpg",".jpeg",".png"]),a(this,"onDragOverEvent",t=>{if(this.allowDrop&&t.dataTransfer)for(const i of t.dataTransfer.types)(i==="text/uri-list"||i==="Files")&&t.preventDefault()}),a(this,"onDrop",t=>{var i,s,o,r;if(this.allowDrop&&t.dataTransfer){for(const l of t.dataTransfer.types)if(on&&console.log(l),l==="text/uri-list"){const c=t.dataTransfer.getData(l);on&&console.log(l,c);let h=(s=(i=new RegExp(/polyhaven.com\/asset_img\/.+?\/(?<name>.+)\.png/).exec(c))==null?void 0:i.groups)==null?void 0:s.name;if(h||(h=(r=(o=new RegExp(/polyhaven\.com\/a\/(?<name>.+)/).exec(c))==null?void 0:o.groups)==null?void 0:r.name),on&&console.log(h),h){const d="https://dl.polyhaven.org/file/ph-assets/HDRIs/exr/1k/"+h+"_1k.exr";console.log(`[Remote Skybox] Setting skybox from url: ${d}`),t.preventDefault(),this.setSkybox(d);break}else if(this.isValidTextureType(c)){console.log("[Remote Skybox] Setting skybox from url: "+c),t.preventDefault(),this.setSkybox(c);break}else{console.warn(`[RemoteSkybox] Unknown url ${c}. If you want to load a skybox from a url, make sure it is a valid image url. Url must end with${this.validTextureTypes.join(", ")}.`);const d=new CustomEvent("dropped-unknown-url",{detail:{sender:this,event:t,url:c,apply:u=>{t.preventDefault(),this.setSkybox(u)}}});this.dispatchEvent(d)}}else if(l=="Files"){const c=t.dataTransfer.files.item(0);if(on&&console.log(l,c),!c)continue;if(!this.isValidTextureType(c.name)){console.warn(`[RemoteSkybox]: File "${c.name}" is not supported. Supported files are ${this.validTextureTypes.join(", ")}`);return}if(k1(c.name)===null){const h=new Blob([c]),d=URL.createObjectURL(h);t.preventDefault(),this.setSkybox(d,c.name)}else t.preventDefault(),this.setSkybox(c.name);break}}})}onEnable(){this.setSkybox(this.url),this.registerDropEvents()}onDisable(){var t;this.context.scene.environment===this._prevLoadedEnvironment&&(this.context.scene.environment=this._prevEnvironment,Oe.backgroundShouldBeTransparent(this.context)||(this.context.scene.background=this._prevBackground),this._prevLoadedEnvironment=void 0),this.unregisterDropEvents(),(t=this.context.mainCameraComponent)==null||t.applyClearFlags()}urlChangedSyncField(){this.allowNetworking&&this.url&&this.isRemoteTexture(this.url)&&this.setSkybox(this.url)}async setSkybox(t,i){var s;if(!this.activeAndEnabled||(t=pI(t,this.environment,this.background),!t))return!1;if(i??(i=t),this.isValidTextureType(i)||console.warn("Potentially invalid skybox url",i,"on",this.name),on&&console.log("Set remote skybox url: "+t),this._prevUrl===t&&this._prevLoadedEnvironment)return this.applySkybox(),!0;(s=this._prevLoadedEnvironment)==null||s.dispose(),this._prevLoadedEnvironment=void 0,this._prevUrl=t;const o=await this.loadTexture(t,i);if(!o||!this.enabled)return!1;this.url=t;const r=t.lastIndexOf("/");return o.name=t.substring(r>=0?r+1:0),this._loader instanceof ga&&(o.colorSpace=gn),this._prevLoadedEnvironment=o,this.applySkybox(),!0}async loadTexture(t,i){var s,o,r,l,c;if(!t)return Promise.resolve(null);i??(i=t);const h=k1(i);if(h){const y=await h;if(((o=(s=y.source)==null?void 0:s.data)==null?void 0:o.length)>0||(c=(l=(r=y.source)==null?void 0:r.data)==null?void 0:l.data)!=null&&c.length)return y}const d=i.endsWith(".exr"),u=i.endsWith(".hdr"),p=i.endsWith(".ktx2");if(d)this._loader instanceof pd||(this._loader=new pd);else if(u)this._loader instanceof fm||(this._loader=new fm);else if(p){if(!(this._loader instanceof XC)){const{ktx2Loader:y}=gm(this.context.renderer);this._loader=y}}else this._loader instanceof ga||(this._loader=new ga);on&&console.log("Loading skybox: "+t);const g=this._loader.loadAsync(t);return uI(i,g),await g}applySkybox(){var t;const i=this._prevLoadedEnvironment;i&&(i instanceof wC||i instanceof xC||(i.mapping=SC,i.needsUpdate=!0),this.context.scene.background!==i&&(this._prevBackground=this.context.scene.background),this.context.scene.environment!==i&&(this._prevEnvironment=this.context.scene.environment),on&&console.log("Set remote skybox",this.url,!Oe.backgroundShouldBeTransparent(this.context)),this.environment&&(this.context.scene.environment=i),this.background&&!Oe.backgroundShouldBeTransparent(this.context)&&(this.context.scene.background=i),((t=this.context.mainCameraComponent)==null?void 0:t.backgroundBlurriness)!==void 0&&(this.context.scene.backgroundBlurriness=this.context.mainCameraComponent.backgroundBlurriness))}isRemoteTexture(t){return t.startsWith("http://")||t.startsWith("https://")}isValidTextureType(t){for(const i of this.validTextureTypes)if(t.endsWith(i))return!0;return!1}registerDropEvents(){this.unregisterDropEvents(),this.context.domElement.addEventListener("dragover",this.onDragOverEvent),this.context.domElement.addEventListener("drop",this.onDrop)}unregisterDropEvents(){this.context.domElement.removeEventListener("dragover",this.onDragOverEvent),this.context.domElement.removeEventListener("drop",this.onDrop)}}Ih([d0(cs.prototype.urlChangedSyncField),m(URL)],cs.prototype,"url",2),Ih([m()],cs.prototype,"allowDrop",2),Ih([m()],cs.prototype,"background",2),Ih([m()],cs.prototype,"environment",2),Ih([m()],cs.prototype,"allowNetworking",2);function pI(n,t,i){const s=t&&!i;switch(n?.toLowerCase()){case"studio":return s?"https://cdn.needle.tools/static/skybox/modelviewer-Neutral-small.hdr":"https://cdn.needle.tools/static/skybox/modelviewer-Neutral.hdr";case"blurred-skybox":return s?"https://cdn.needle.tools/static/skybox/blurred-skybox-small.exr":"https://cdn.needle.tools/static/skybox/blurred-skybox.exr";case"quicklook-ar":return s?"https://cdn.needle.tools/static/skybox/QuickLook-ARMode-small.exr":"https://cdn.needle.tools/static/skybox/QuickLook-ARMode.exr";case"quicklook":return s?"https://cdn.needle.tools/static/skybox/QuickLook-ObjectMode-small.exr":"https://cdn.needle.tools/static/skybox/QuickLook-ObjectMode.exr"}return n===void 0?null:n}var mI=Object.defineProperty,gI=Object.getOwnPropertyDescriptor,Dp=(n,t,i,s)=>{for(var o=s>1?void 0:s?gI(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&mI(t,i,o),o},oy;const M1=(oy=class extends A{constructor(){super(...arguments),a(this,"target",null),a(this,"followFactor",.1),a(this,"rotateFactor",.1),a(this,"positionAxes",Wa.All),a(this,"flipForward",!1),a(this,"_firstUpdate",!0)}onBeforeRender(){this.updateNow(!1)}updateNow(n){if(!(!this.target||this.target===this.gameObject)){if(this.followFactor>0){const t=te(this.target),i=this._firstUpdate||n?1:W.clamp01(this.context.time.deltaTime*this.followFactor),s=this.worldPosition;this.positionAxes&Wa.X&&(s.x=W.lerp(s.x,t.x,i)),this.positionAxes&Wa.Y&&(s.y=W.lerp(s.y,t.y,i)),this.positionAxes&Wa.Z&&(s.z=W.lerp(s.z,t.z,i)),this.worldPosition=s}if(this.rotateFactor>0){const t=Ce(this.target);this.flipForward&&t.premultiply(M1._invertForward);const i=this._firstUpdate||n?1:W.clamp01(this.context.time.deltaTime*this.rotateFactor);this.worldQuaternion=this.worldQuaternion.slerp(t,i)}this._firstUpdate=!1}}},a(oy,"_invertForward",new V().setFromAxisAngle(new x(0,1,0),Math.PI)),oy);let Yo=M1;Dp([m(j)],Yo.prototype,"target",2),Dp([m()],Yo.prototype,"followFactor",2),Dp([m()],Yo.prototype,"rotateFactor",2),Dp([m()],Yo.prototype,"positionAxes",2);var fI=Object.defineProperty,yI=Object.getOwnPropertyDescriptor,jh=(n,t,i,s)=>{for(var o=s>1?void 0:s?yI(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&fI(t,i,o),o};const Lh=C("debugspatialtrigger"),R1=new io,T1=new io;function vI(n,t){return R1.mask=n,T1.mask=t,R1.test(T1)}class hs extends A{constructor(){super(...arguments),a(this,"triggerMask",0),a(this,"onEnter"),a(this,"onStay"),a(this,"onExit"),a(this,"currentIntersected",[]),a(this,"lastIntersected",[])}start(){Lh&&console.log(this.name,this.triggerMask,this)}update(){this.currentIntersected.length=0;for(const t of Dh.triggers)vI(t.triggerMask,this.triggerMask)&&t.test(this.gameObject)&&this.currentIntersected.push(t);for(let t=this.lastIntersected.length-1;t>=0;t--){const i=this.lastIntersected[t];this.currentIntersected.indexOf(i)<0&&(this.onExitTrigger(i),this.lastIntersected.splice(t,1))}for(const t of this.currentIntersected)this.lastIntersected.indexOf(t)<0&&this.onEnterTrigger(t),this.onStayTrigger(t);this.lastIntersected.length=0,this.lastIntersected.push(...this.currentIntersected)}onEnterTrigger(t){var i;Lh&&console.log("ENTER TRIGGER",this.name,t.name,this,t),t.raiseOnEnterEvent(this),(i=this.onEnter)==null||i.invoke()}onExitTrigger(t){var i;Lh&&console.log("EXIT TRIGGER",this.name,t.name),t.raiseOnExitEvent(this),(i=this.onExit)==null||i.invoke()}onStayTrigger(t){var i;t.raiseOnStayEvent(this),(i=this.onStay)==null||i.invoke()}}jh([m()],hs.prototype,"triggerMask",2),jh([m(Se)],hs.prototype,"onEnter",2),jh([m(Se)],hs.prototype,"onStay",2),jh([m(Se)],hs.prototype,"onExit",2);var ry;const Bp=(ry=class extends A{constructor(){super(...arguments),a(this,"triggerMask"),a(this,"boxHelper")}start(){Lh&&console.log(this.name,this.triggerMask,this)}onEnable(){var n;Bp.triggers.push(this),this.boxHelper||(this.boxHelper=O.addComponent(this.gameObject,Ki),(n=this.boxHelper)==null||n.showHelper(null,Lh))}onDisable(){Bp.triggers.splice(Bp.triggers.indexOf(this),1)}test(n){return this.boxHelper?this.boxHelper.isInBox(n)??!1:!1}raiseOnEnterEvent(n){O.foreachComponent(this.gameObject,t=>{t!==n&&t instanceof hs&&t.onEnterTrigger(this)},!1)}raiseOnStayEvent(n){O.foreachComponent(this.gameObject,t=>{t!==n&&t instanceof hs&&t.onStayTrigger(this)},!1)}raiseOnExitEvent(n){O.foreachComponent(this.gameObject,t=>{t!==n&&t instanceof hs&&t.onExitTrigger(this)},!1)}},a(ry,"triggers",[]),ry);let Dh=Bp;jh([m()],Dh.prototype,"triggerMask",2);var bI=Object.defineProperty,_I=Object.getOwnPropertyDescriptor,wI=(n,t,i,s)=>{for(var o=s>1?void 0:s?_I(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&bI(t,i,o),o};const zi=C("debugspectator");class Fp extends A{constructor(){super(...arguments),a(this,"cam",null),a(this,"useKeys",!0),a(this,"_mode",0),a(this,"orbit",null),a(this,"_handler"),a(this,"eventSub_WebXRRequestStartEvent",null),a(this,"eventSub_WebXRStartEvent",null),a(this,"eventSub_WebXREndEvent",null),a(this,"_debug"),a(this,"_networking")}get mode(){return this._mode}set mode(t){this._mode=t}get isSpectating(){var t;return((t=this._handler)==null?void 0:t.currentTarget)!==void 0}isSpectatingUser(t){var i;return((i=this.target)==null?void 0:i.userId)===t}isFollowedBy(t){var i;return(i=this.followers)==null?void 0:i.includes(t)}get followers(){return this._networking.followers}stopSpectating(){if(this.context.isInXR){this.followSelf();return}this.target=void 0}get localId(){return this.context.connection.connectionId??"local"}set target(t){var i;if(this._handler){const s=(i=this._handler.currentTarget)==null?void 0:i.userId,o=this.context.players.getPlayerView(this.localId);t===void 0||this.context.isInXR===!1&&o?.currentObject===t.currentObject?this._handler.currentTarget!==void 0&&(this._handler.disable(),O.setActive(this.gameObject,!1),this.orbit&&(this.orbit.enabled=!0),this._networking.onSpectatedObjectChanged(t,s)):this._handler.currentTarget!==t&&(this._handler.set(t),O.setActive(this.gameObject,!0),this.orbit&&(this.orbit.enabled=!1),this._networking.onSpectatedObjectChanged(t,s))}}get target(){var t;return(t=this._handler)==null?void 0:t.currentTarget}requestAllFollowMe(){this._networking.onRequestFollowMe()}get isSpectatingSelf(){var t,i;return this.isSpectating&&((t=this.target)==null?void 0:t.currentObject)===((i=this.context.players.getPlayerView(this.localId))==null?void 0:i.currentObject)}awake(){if(this._debug=new CI(this.context,this),this._networking=new kI(this.context,this),this._networking.awake(),O.setActive(this.gameObject,!1),this.cam=O.getComponent(this.gameObject,Oe),!this.cam){console.warn("SpectatorCamera: Spectator camera needs camera component on the same object.",this);return}!this._handler&&this.cam&&(this._handler=new xI(this.context,this.cam,this)),this.orbit=O.getComponent(this.context.mainCamera,be)}onDestroy(){var t,i;this.stopSpectating(),(t=this._handler)==null||t.destroy(),(i=this._networking)==null||i.destroy()}isSupportedPlatform(){const t=window.navigator.userAgent,i=/Windows|MacOS/.test(t),s=/Windows NT/.test(t)&&/Edg/.test(t)&&!/Win64/.test(t);return i&&!s}onBeforeXR(t){this.isSupportedPlatform()&&O.setActive(this.gameObject,!0)}onEnterXR(t){this.isSupportedPlatform()&&(zi&&console.log(this.context.mainCamera),this.context.mainCamera&&this.followSelf())}onLeaveXR(t){var i,s;this.context.removeCamera(this.cam),O.setActive(this.gameObject,!1),this.orbit&&(this.orbit.enabled=!0),(i=this._handler)==null||i.set(void 0),(s=this._handler)==null||s.disable(),this.isSpectatingSelf&&this.stopSpectating()}followSelf(){this.target=this.context.players.getPlayerView(this.context.connection.connectionId),this.target||(this.context.players.setPlayerView(this.localId,this.context.mainCamera,fo.Headset),this.target=this.context.players.getPlayerView(this.localId)),zi&&console.log("Follow self",this.target)}onAfterRender(){var t,i,s;if(!this.cam)return;const o=this.context.renderer,r=o.xr.enabled;if(!o.xr.isPresenting&&!((t=this._handler)!=null&&t.currentTarget))return;(i=this._handler)==null||i.update(this._mode);const l=o.getRenderTarget();let c=null;const h=o.state;if(!l){if(!o.state.bindFramebuffer||!h.bindXRFramebuffer)return;c=o._framebuffer,h.bindXRFramebuffer(null)}this.setAvatarFlagsBeforeRender();const d=this.context.mainCameraComponent;if(d){const g=d.backgroundColor;g&&o.setClearColor(g,g.alpha),this.cam.backgroundColor=g,this.cam.clearFlags=d.clearFlags,this.cam.nearClipPlane=d.nearClipPlane,this.cam.farClipPlane=d.farClipPlane}else o.setClearColor(new ae(1,1,1));o.setRenderTarget(null),o.xr.enabled=!1;const u=(s=this.cam)==null?void 0:s.threeCamera;this.context.updateAspect(u);const p=o.xr.isPresenting;o.xr.isPresenting=!1,o.setSize(this.context.domWidth,this.context.domHeight),o.render(this.context.scene,u),o.xr.isPresenting=p,o.xr.enabled=r,l?o.setRenderTarget(l):h.bindXRFramebuffer&&h.bindXRFramebuffer(c),this.resetAvatarFlags()}setAvatarFlagsBeforeRender(){const t=this._mode===0;for(const i of Rt.instances)if(i.avatar&&"isLocalAvatar"in i.avatar&&"flags"in i.avatar){let s=Zn.All;this.isSpectatingSelf&&(s=t&&i.avatar.isLocalAvatar?Zn.FirstPerson:Zn.ThirdPerson);const o=i.avatar.flags;if(!o)continue;for(const r of o)r.UpdateVisible(s)}}resetAvatarFlags(){var t;for(const i of Rt.instances)if(i.avatar&&"flags"in i.avatar){const s=i.avatar.flags;if(!s)continue;for(const o of s)"isLocalAvatar"in i.avatar&&(t=i.avatar)!=null&&t.isLocalAvatar?o.UpdateVisible(Zn.FirstPerson):o.UpdateVisible(Zn.ThirdPerson)}}}wI([m()],Fp.prototype,"useKeys",2);class xI{constructor(t,i,s){a(this,"context"),a(this,"cam"),a(this,"spectator"),a(this,"follow"),a(this,"target"),a(this,"view"),a(this,"currentObject"),this.context=t,this.cam=i,this.spectator=s}get currentTarget(){return this.view}set(t){const i=t?.currentObject;if(!i){this.spectator.stopSpectating();return}i!==this.currentObject&&(this.currentObject=i,this.view=t,this.follow||(this.follow=O.addComponent(this.cam.gameObject,Yo)),this.target||(this.target=new j),i.add(this.target),this.follow.enabled=!0,this.follow.target=this.target,zi&&console.log("FOLLOW",i),this.context.isInXR?this.context.removeCamera(this.cam):this.context.setCurrentCamera(this.cam))}disable(){zi&&console.log("STOP FOLLOW",this.currentObject),this.view=void 0,this.currentObject=void 0,this.context.removeCamera(this.cam),this.follow&&(this.follow.enabled=!1)}destroy(){var t;(t=this.target)==null||t.removeFromParent(),this.follow&&O.destroy(this.follow)}update(t){var i,s,o,r,l,c;if(((i=this.currentTarget)==null?void 0:i.isConnected)===!1||((s=this.currentTarget)==null?void 0:s.removed)===!0){zi&&console.log("Target disconnected or timeout",this.currentTarget),this.spectator.stopSpectating();return}this.currentTarget&&((o=this.currentTarget)==null?void 0:o.currentObject)!==this.currentObject&&(zi&&console.log("Target changed",this.currentObject,"to",this.currentTarget.currentObject),this.set(this.currentTarget));const h=this.context.mainCamera;if(h){const u=this.cam.threeCamera;(u.near!==h.near||u.far!==h.far)&&(u.near=h.near,u.far=h.far,u.updateProjectionMatrix())}const d=(r=this.follow)==null?void 0:r.target;if(!(!d||!this.follow)){switch(t){case 0:((l=this.view)==null?void 0:l.viewDevice)!==fo.Browser?(this.follow.followFactor=5,this.follow.rotateFactor=5):(this.follow.followFactor=50,this.follow.rotateFactor=50),d.position.set(0,0,0);break;case 1:this.follow.followFactor=3,this.follow.rotateFactor=2,d.position.set(0,.5,1.5);break}this.follow.flipForward=!1,((c=this.view)==null?void 0:c.viewDevice)!==fo.Browser?d.quaternion.copy(SI):d.quaternion.identity()}}}const SI=new V().setFromAxisAngle(new x(0,1,0),Math.PI);class CI{constructor(t,i){a(this,"context"),a(this,"spectator"),this.context=t,this.spectator=i,console.log("[Spectator Camera] Click other avatars or cameras to follow them. Press ESC to exit spectator mode."),this.context.domElement.addEventListener("keydown",o=>{!this.spectator.useKeys||o.key==="Escape"&&this.spectator.stopSpectating()});let s=0;this.context.input.addEventListener(Be.PointerDown,o=>{s=this.context.time.time}),this.context.input.addEventListener(Be.PointerUp,o=>{const r=this.context.time.time-s;r>1?this.spectator.stopSpectating():this.context.input.getPointerClicked(0)&&r<.3&&this.trySelectObject()})}trySelectObject(){const t=new Vn;t.setMask(16777215);const i=this.context.physics.raycast(t);if(zi&&console.log(...i),i!=null&&i.length)for(const s of i){if(s.distance<.2)continue;const o=s.object,r=O.getComponentInParent(o,Rt),l=r?.connectionId;if(l){const c=this.context.players.getPlayerView(l);this.spectator.target=c,zi&&console.log("spectate",l,r);break}}}}class OI{constructor(t,i,s){a(this,"guid"),a(this,"dontSave",!0),a(this,"targetUserId"),a(this,"stoppedFollowing"),this.guid=t,this.targetUserId=i,this.stoppedFollowing=s}}class PI{constructor(t,i){a(this,"guid"),a(this,"userId"),this.guid=t.guid,this.userId=i}}class kI{constructor(t,i){a(this,"followers",[]),a(this,"context"),a(this,"spectator"),a(this,"_followerEventMethod"),a(this,"_requestFollowMethod"),a(this,"_joinedRoomMethod"),a(this,"_lastRequestFollowUser"),a(this,"_enforceFollowInterval"),this.context=t,this.spectator=i,this._followerEventMethod=this.onFollowerEvent.bind(this),this._requestFollowMethod=this.onRequestFollowEvent.bind(this),this._joinedRoomMethod=this.onUserJoinedRoom.bind(this)}awake(){this.context.connection.beginListen("spectator-follower-changed",this._followerEventMethod),this.context.connection.beginListen("spectator-request-follow",this._requestFollowMethod),this.context.connection.beginListen(ne.JoinedRoom,this._joinedRoomMethod),this.context.domElement.addEventListener("keydown",t=>{this.spectator.useKeys&&(t.key==="f"?this.onRequestFollowMe():t.key==="Escape"&&this.onRequestFollowMe(!0))})}destroy(){this.context.connection.stopListen("spectator-follower-changed",this._followerEventMethod),this.context.connection.stopListen("spectator-request-follow",this._requestFollowMethod),this.context.connection.stopListen(ne.JoinedRoom,this._joinedRoomMethod)}onSpectatedObjectChanged(t,i){if(zi&&console.log(this.context.connection.connectionId,"onSpectatedObjectChanged",t,i),this.context.connection.connectionId){const s=t?.userId===void 0,o=s?i:t?.userId,r=new OI(this.context.connection.connectionId,o,s);this.context.connection.send("spectator-follower-changed",r)}}onRequestFollowMe(t=!1){if(zi&&console.log("Request follow",this.context.connection.connectionId),this.context.connection.connectionId){this.spectator.stopSpectating();const i=t?void 0:this.context.connection.connectionId,s=new PI(this.spectator,i);this.context.connection.send("spectator-request-follow",s)}}onUserJoinedRoom(){C("followme")&&this.onRequestFollowMe()}onFollowerEvent(t){const i=t.targetUserId,s=t.guid;if(zi&&console.log(t),i===this.context.connection.connectionId)if(t.stoppedFollowing){const o=this.followers.indexOf(s);o!==-1&&(this.followers.splice(o,1),this.removeDisconnectedFollowers(),console.log(s,"unfollows you",this.followers.length))}else this.followers.includes(s)||(this.followers.push(s),this.removeDisconnectedFollowers(),console.log(s,"follows you",this.followers.length))}removeDisconnectedFollowers(){for(let t=this.followers.length-1;t>=0;t--){const i=this.followers[t];this.context.connection.userIsInRoom(i)===!1&&this.followers.splice(t,1)}}onRequestFollowEvent(t){if(this._lastRequestFollowUser=t,t.userId===this.context.connection.connectionId)this.spectator.stopSpectating();else if(t.userId===void 0)this.spectator.stopSpectating();else{const i=this.context.players.getPlayerView(t.userId);if(i)this.spectator.target=i;else return zi&&console.warn("Could not find view",t.userId),this.enforceFollow(),!1}return!0}enforceFollow(){this._enforceFollowInterval||(this._enforceFollowInterval=setInterval(()=>{this._lastRequestFollowUser===void 0||this._lastRequestFollowUser.userId&&this.spectator.isFollowedBy(this._lastRequestFollowUser.userId)?(clearInterval(this._enforceFollowInterval),this._enforceFollowInterval=void 0):(zi&&console.log("REQUEST FOLLOW AGAIN",this._lastRequestFollowUser.userId),this.onRequestFollowEvent(this._lastRequestFollowUser))},1e3))}}class ps{constructor(){a(this,"bb",null),a(this,"bb_pos",0)}__init(t,i){return this.bb_pos=t,this.bb=i,this}static getRootAsSyncedCameraModel(t,i){return(i||new ps).__init(t.readInt32(t.position())+t.position(),t)}static getSizePrefixedRootAsSyncedCameraModel(t,i){return t.setPosition(t.position()+hv),(i||new ps).__init(t.readInt32(t.position())+t.position(),t)}userId(t){const i=this.bb.__offset(this.bb_pos,4);return i?this.bb.__string(this.bb_pos+i,t):null}guid(t){const i=this.bb.__offset(this.bb_pos,6);return i?this.bb.__string(this.bb_pos+i,t):null}dontSave(){const t=this.bb.__offset(this.bb_pos,8);return t?!!this.bb.readInt8(this.bb_pos+t):!1}pos(t){const i=this.bb.__offset(this.bb_pos,10);return i?(t||new Tr).__init(this.bb_pos+i,this.bb):null}rot(t){const i=this.bb.__offset(this.bb_pos,12);return i?(t||new Tr).__init(this.bb_pos+i,this.bb):null}static startSyncedCameraModel(t){t.startObject(5)}static addUserId(t,i){t.addFieldOffset(0,i,0)}static addGuid(t,i){t.addFieldOffset(1,i,0)}static addDontSave(t,i){t.addFieldInt8(2,+i,0)}static addPos(t,i){t.addFieldStruct(3,i,0)}static addRot(t,i){t.addFieldStruct(4,i,0)}static endSyncedCameraModel(t){return t.endObject()}static finishSyncedCameraModelBuffer(t,i){t.finish(i)}static finishSizePrefixedSyncedCameraModelBuffer(t,i){t.finish(i,void 0,!0)}}var MI=Object.defineProperty,RI=Object.getOwnPropertyDescriptor,TI=(n,t,i,s)=>{for(var o=s>1?void 0:s?RI(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&MI(t,i,o),o};const zp="SCAM";ng(zp,ps.getRootAsSyncedCameraModel);const Ui=new vm;class EI{constructor(t,i){a(this,"userId"),a(this,"guid"),this.guid=i,this.userId=t}send(t,i){if(t){Ui.clear();const s=Ui.createString(this.guid),o=Ui.createString(this.userId);ps.startSyncedCameraModel(Ui),ps.addGuid(Ui,s),ps.addUserId(Ui,o);const r=te(t),l=ic(t);ps.addPos(Ui,Tr.createVec3(Ui,r.x,r.y,r.z)),ps.addRot(Ui,Tr.createVec3(Ui,l.x,l.y,l.z));const c=ps.endSyncedCameraModel(Ui);Ui.finish(c,zp),i.sendBinary(Ui.asUint8Array())}}}var ay;const ly=(ay=class extends A{constructor(){super(...arguments),a(this,"cameraPrefab",null),a(this,"_lastWorldPosition"),a(this,"_lastWorldQuaternion"),a(this,"_model",null),a(this,"_needsUpdate",!0),a(this,"_lastUpdateTime",0),a(this,"remoteCams",{}),a(this,"userToCamMap",{}),a(this,"_camTimeoutInSeconds",10),a(this,"_receiveCallback",null)}getCameraObject(n){const t=this.userToCamMap[n];return t?this.remoteCams[t].obj:null}async awake(){this._lastWorldPosition=this.worldPosition.clone(),this._lastWorldQuaternion=this.worldQuaternion.clone(),this.cameraPrefab&&("uri"in this.cameraPrefab&&(this.cameraPrefab=await this.cameraPrefab.instantiate(this.gameObject)),this.cameraPrefab&&"isObject3D"in this.cameraPrefab&&(this.cameraPrefab.visible=!1))}onEnable(){this._receiveCallback=this.context.connection.beginListenBinary(zp,this.onReceivedRemoteCameraInfoBin.bind(this))}onDisable(){this.context.connection.stopListenBinary(zp,this._receiveCallback)}update(){for(const s in this.remoteCams){const o=this.remoteCams[s],r=this.context.time.realtimeSinceStartup-o.lastUpdate;if(!o||r>this._camTimeoutInSeconds){F()&&console.log("Remote cam timeout",s),o!=null&&o.obj&&O.destroy(o.obj),delete this.remoteCams[s],o&&delete this.userToCamMap[o.userId],ly.instances.push(o),this.context.players.removePlayerView(o.userId,fo.Browser);continue}}if(this.context.isInXR)return;const n=this.context.mainCamera;if(n===null){this.enabled=!1;return}if(!this.context.connection.isConnected||this.context.connection.connectionId===null)return;this._model===null&&(this._model=new EI(this.context.connection.connectionId,this.context.connection.connectionId+"_camera"));const t=te(n),i=Ce(n);(t.distanceTo(this._lastWorldPosition)>.001||i.angleTo(this._lastWorldQuaternion)>.01)&&(this._needsUpdate=!0),this._lastWorldPosition.copy(t),this._lastWorldQuaternion.copy(i),!((!this._needsUpdate||this.context.time.frameCount%2!==0)&&!(this.context.time.realtimeSinceStartup-this._lastUpdateTime>this._camTimeoutInSeconds*.5))&&(this._lastUpdateTime=this.context.time.realtimeSinceStartup,this._needsUpdate=!1,this._model.send(n,this.context.connection),this.context.isInXR||this.context.players.setPlayerView(this.context.connection.connectionId,n,fo.Browser))}onReceivedRemoteCameraInfoBin(n){const t=n.guid();if(!t)return;const i=n.userId();if(!i||!this.context.connection.userIsInRoom(i)||!this.cameraPrefab)return;let s=this.remoteCams[t];if(!s)if("isObject3D"in this.cameraPrefab){const c=new Bn;c.context=this.context;const h=O.instantiate(this.cameraPrefab,c);s=this.remoteCams[t]={obj:h,lastUpdate:this.context.time.realtimeSinceStartup,userId:i},s.obj.visible=!0,this.gameObject.add(h),this.userToCamMap[i]=t,ly.instances.push(s);const d=O.getOrAddComponent(h,Rt);d.connectionId=i,d.avatar=h}else return;const o=s.obj;this.context.players.setPlayerView(i,o,fo.Browser),s.lastUpdate=this.context.time.realtimeSinceStartup,an.markDirty(o);const r=n.pos();r&&cr(o,r.x(),r.y(),r.z());const l=n.rot();l&&nc(o,l.x(),l.y(),l.z())}},a(ay,"instances",[]),ay);let Up=ly;TI([m([j,le])],Up.prototype,"cameraPrefab",2);var AI=Object.defineProperty,II=Object.getOwnPropertyDescriptor,Zo=(n,t,i,s)=>{for(var o=s>1?void 0:s?II(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&AI(t,i,o),o};const cy="view",hy=C("debugsyncedroom");class Ln extends A{constructor(){super(...arguments),a(this,"roomName",""),a(this,"urlParameterName","room"),a(this,"joinRandomRoom"),a(this,"requireRoomParameter",!1),a(this,"autoRejoin",!0),a(this,"createJoinButton",!0),a(this,"createViewOnlyButton",!1),a(this,"_lastJoinedRoom"),a(this,"_roomPrefix",""),a(this,"_lastPingTime",0),a(this,"_lastRoomTime",-1),a(this,"_userWantsToBeInARoom",!1),a(this,"_roomButton"),a(this,"_roomButtonIconJoin"),a(this,"_roomButtonIconLeave"),a(this,"updateRoomButtonState",()=>{var t,i;this._roomButton&&(this.context.connection.isInRoom?(this._roomButton.title="Leave the networked room",this._roomButton.textContent="Leave Room",(t=this._roomButtonIconJoin)==null||t.remove(),this._roomButton.prepend(this._roomButtonIconLeave)):(this._roomButton.title="Create or join a networked room",this._roomButton.textContent="Join Room",(i=this._roomButtonIconLeave)==null||i.remove(),this._roomButton.prepend(this._roomButtonIconJoin)))}),a(this,"_viewOnlyButton"),a(this,"onCreateViewOnlyButton",()=>{if(!this._viewOnlyButton){const t=document.createElement("button");this._viewOnlyButton=t,t.classList.add("view-only-button"),t.setAttribute("priority","90"),t.onclick=()=>{var i;const s=this.getViewOnlyUrl();s!=null&&s.length?navigator.canShare({url:s})?(i=navigator.share({url:s}))==null||i.catch(o=>{console.warn(o)}):(navigator.clipboard.writeText(s),De("View only URL copied to clipboard")):we("Could not create view only URL")},t.title="Copy the view only URL: A page accessed by the view only URL can not be modified by visiting users.",t.textContent="Share View URL",t.prepend(Pt("visibility"))}this.context.menu.appendChild(this._viewOnlyButton)})}get currentRoomName(){return C(cy)||C(this.urlParameterName)}set roomPrefix(t){this._roomPrefix=t}get roomPrefix(){return this._roomPrefix}awake(){var t;this.joinRandomRoom===void 0&&((t=this.roomName)==null?void 0:t.length)<=0&&(this.joinRandomRoom=!0),hy&&console.log(`SyncedRoom roomName:${this.roomName}, urlParamName:${this.urlParameterName}, joinRandomRoom:${this.joinRandomRoom}`)}onEnable(){const t=C(cy);if(t&&typeof t=="string"&&t.length>0){console.log("Join as viewer"),this.context.connection.joinRoom(t,!0);return}if(this.tryJoinRoom(),this.createJoinButton){const i=this.createRoomButton();this.context.menu.appendChild(i)}this.createViewOnlyButton&&this.onEnableViewOnlyButton()}onDisable(){var t;(t=this._roomButton)==null||t.remove(),this.onDisableViewOnlyButton(),this.roomName&&this.roomName.length>0&&this.context.connection.leaveRoom(this.roomName)}onDestroy(){this.destroyRoomButton()}tryJoinRandomRoom(){this.setRandomRoomUrlParameter(),this.tryJoinRoom()}tryJoinRoom(t=0){var i;t===void 0&&(t=0);let s=!1;if(((i=this.urlParameterName)==null?void 0:i.length)>0){const o=C(this.urlParameterName);if(o&&(typeof o=="string"||typeof o=="number")){s=!0;const r=Ov(o.toString());this.roomName=r}else if(this.joinRandomRoom&&(console.log("No room name found in url, generating random one"),this.setRandomRoomUrlParameter(),t<1))return this.tryJoinRoom(t+1)}else this.joinRandomRoom&&(this.roomName===null||this.roomName===void 0||this.roomName.length<=0)&&(this.roomName=this.generateRoomName());return this.requireRoomParameter&&!s?((hy||F())&&console.warn('[SyncedRoom] Missing required room parameter "'+this.urlParameterName+`" in url - will not connect.
To allow joining a room without a query parameter you can set "requireRoomParameter" to false.`),!1):(this.context.connection.isConnected||this.context.connection.connect(),this._lastJoinedRoom=this.roomName,this._roomPrefix&&(this.roomName=this._roomPrefix+this.roomName),this.roomName.length<=0?(console.warn(`[SyncedRoom] Room name is not set so we can not join a networked room.
Please choose one of the following options to fix this:
A) Set a room name in the SyncedRoom component
B) Set a room name in the URL parameter "?`+this.urlParameterName+`=my_room"
C) Set "joinRandomRoom" to true`),!1):(hy&&console.log("Join "+this.roomName),this._userWantsToBeInARoom=!0,this.context.connection.joinRoom(this.roomName),!0))}update(){this.context.connection.isConnected&&(this.context.time.time-this._lastPingTime>3&&(this._lastPingTime=this.context.time.time,this.context.connection.sendPing()),this.context.connection.isInRoom&&(this._lastRoomTime=this.context.time.time)),this._lastRoomTime>0&&this.context.time.time-this._lastRoomTime>.3&&(this._lastRoomTime=-1,this.autoRejoin?this._userWantsToBeInARoom&&(console.log("Disconnected from networking backend - attempt reconnecting now"),this.tryJoinRoom()):F()&&console.warn("You are not connected to a room anymore (possibly because the tab was inactive for too long and the server kicked you?)"))}getViewOnlyUrl(){if(this.context.connection.isConnected&&this.context.connection.currentRoomViewId){const t=window.location.search,i=new URLSearchParams(t);return i.has(this.urlParameterName)&&i.delete(this.urlParameterName),i.set(cy,this.context.connection.currentRoomViewId),window.location.origin+window.location.pathname+"?"+i.toString()}return null}setRandomRoomUrlParameter(){const t=Ql(),i=this.generateRoomName();C(this.urlParameterName)?t.set(this.urlParameterName,i):t.append(this.urlParameterName,i),Om(i,t)}generateRoomName(){let t="";for(let i=0;i<6;i++)t+=Math.floor(Math.random()*10).toFixed(0);return t}createRoomButton(){if(this._roomButton)return this._roomButton;const t=document.createElement("button");return this._roomButton=t,t.classList.add("create-room-button"),t.setAttribute("priority","90"),t.onclick=()=>{if(this.context.connection.isInRoom)this.urlParameterName&&Yl(this.urlParameterName,null),this.context.connection.leaveRoom(),this._userWantsToBeInARoom=!1;else{if(this.urlParameterName){const i=C(this.urlParameterName);(!i||i===!0)&&(this._lastJoinedRoom?Yl(this.urlParameterName,this._lastJoinedRoom):this.setRandomRoomUrlParameter())}this.tryJoinRoom()}},this._roomButtonIconJoin=Pt("group"),this._roomButtonIconLeave=Pt("group_off"),this.updateRoomButtonState(),this.context.connection.beginListen(ne.JoinedRoom,this.updateRoomButtonState),this.context.connection.beginListen(ne.LeftRoom,this.updateRoomButtonState),t}destroyRoomButton(){this.context.connection.stopListen(ne.JoinedRoom,this.updateRoomButtonState),this.context.connection.stopListen(ne.LeftRoom,this.updateRoomButtonState)}onEnableViewOnlyButton(){this.context.connection.isConnected?this.onCreateViewOnlyButton():(this.context.connection.stopListen(ne.JoinedRoom,this.onCreateViewOnlyButton),this.context.connection.beginListen(ne.JoinedRoom,this.onCreateViewOnlyButton))}onDisableViewOnlyButton(){var t;this.context.connection.stopListen(ne.JoinedRoom,this.onCreateViewOnlyButton),(t=this._viewOnlyButton)==null||t.remove()}}Zo([m()],Ln.prototype,"roomName",2),Zo([m()],Ln.prototype,"urlParameterName",2),Zo([m()],Ln.prototype,"joinRandomRoom",2),Zo([m()],Ln.prototype,"requireRoomParameter",2),Zo([m()],Ln.prototype,"autoRejoin",2),Zo([m()],Ln.prototype,"createJoinButton",2),Zo([m()],Ln.prototype,"createViewOnlyButton",2),Zo([m()],Ln.prototype,"roomPrefix",1);function jI(){const n=C("testwindowcount")||0;n&&n>0&&LI(n)}function LI(n){if(C("testwindow"))return null;const t=new URL(window.location.href);Cm(t.searchParams,DM,1),Cm(t.searchParams,"testwindow",1);const i=t.toString(),s=[];window.onbeforeunload=()=>{for(const h of s)h.close()};const o=.05,r=128;let l=0,c=0;for(let h=0;h<n;h++){l*r+r*.01>=window.innerWidth&&(c+=1,l=0);const d=l*(r*(1+o))+window.screenLeft,u=c*(r*(1+o))+window.screenTop+90+60*c;l+=1;const p=window.open(i,"test window "+h,`popup=yes width=${r} height=${r} top=${u} left=${d}`);if(!p){console.warn("Failed to open window");continue}s.push(p),p.onload=()=>{p.onbeforeunload=()=>{for(let g=0;g<s.length;g++){const y=s[g];y!==p&&y.close()}s.length=0}}}return s}class dy extends A{awake(){jI()}}class uy extends A{constructor(){super(...arguments),a(this,"transformsPerFrame",10),a(this,"interval",0),a(this,"useFlatbuffers",!0),a(this,"builder",null),a(this,"models",null)}awake(){if(this.useFlatbuffers)this.context.connection.beginListenBinary(zc,t=>{});else{this.models=[];for(let t=0;t<this.transformsPerFrame;t++)this.models.push(new E1(this.context.connection.connectionId+"_simulatedTransform_"+t,this))}}update(){if(this.context.connection.isConnected){if(this.useFlatbuffers){if(!this.context.connection.connectionId||this.context.time.frameCount%this.interval!==0)return;this.builder===null&&(this.builder=new vm(1024));const t=this.builder;for(let i=0;i<this.transformsPerFrame;i++){t.clear();const s=Pw(this.context.connection.connectionId,this);this.context.connection.sendBinary(s)}}else if(this.models)for(let t=0;t<this.models.length;t++){const i=this.models[t];i.dontSave=!0,i.update(this,null),this.context.connection.send("TestSimulateUserData-"+t,i)}}}}class E1{constructor(t,i){a(this,"guid"),a(this,"fast",!1),a(this,"position"),a(this,"rotation"),a(this,"velocity"),a(this,"dontSave"),this.guid=t,this.position={x:0,y:0,z:0},this.rotation={x:0,y:0,z:0,w:0},this.update(i,null)}isValid(){return this.fast!==void 0||this.position!==void 0||this.rotation!==void 0||this.velocity!==void 0}update(t,i){const s=t.worldPosition;this.position.x=s.x,this.position.y=s.y,this.position.z=s.z;const o=t.worldQuaternion;if(this.rotation.x=o.x,this.rotation.y=o.y,this.rotation.z=o.z,this.rotation.w=o.w,this.fast=!1,i){const r=i.getVelocity();this.velocity===void 0&&(this.velocity={x:0,y:0,z:0}),this.velocity.x=r.x,this.velocity.y=r.y,this.velocity.z=r.z}}}a(E1,"temp",new x);var DI=Object.defineProperty,BI=Object.getOwnPropertyDescriptor,Np=(n,t,i,s)=>{for(var o=s>1?void 0:s?BI(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&DI(t,i,o),o};const FI=C("debugsignals");class Wp{constructor(){a(this,"guid")}}Np([m()],Wp.prototype,"guid",2);class Bh{constructor(){a(this,"signal"),a(this,"reaction")}}Np([m(Wp)],Bh.prototype,"signal",2),Np([m(Se)],Bh.prototype,"reaction",2);var py;const qs=(py=class extends A{constructor(){super(...arguments),a(this,"events")}static invoke(n){if(qs.receivers[n]){const t=qs.receivers[n];if(!t)return;for(const i of t)i.invoke(n)}}awake(){FI&&console.log("SignalReceiver awake",this)}onEnable(){if(this.events)for(const n of this.events)qs.receivers[n.signal.guid]||(qs.receivers[n.signal.guid]=[]),qs.receivers[n.signal.guid].push(this)}onDisable(){if(this.events){for(const n of this.events)if(qs.receivers[n.signal.guid]){const t=qs.receivers[n.signal.guid].indexOf(this);t>=0&&qs.receivers[n.signal.guid].splice(t,1)}}}invoke(n){if(!this.events||!Array.isArray(this.events))return;const t=typeof n=="object"?n.guid:n;for(const i of this.events)if(i.signal.guid===t)try{if(i.reaction){if(!i.reaction.invoke){console.warn("Missing invoke - possibly a serialization error",i,this);continue}}else{console.warn("Missing reaction for signal",i,this);continue}i.reaction.invoke()}catch(s){console.error(s)}}},a(py,"receivers",{}),py);let Il=qs;Np([m(Bh)],Il.prototype,"events",2);var Ni=(n=>(n.Activation="ActivationTrack",n.Animation="AnimationTrack",n.Audio="AudioTrack",n.Control="ControlTrack",n.Marker="MarkerTrack",n.Signal="SignalTrack",n))(Ni||{}),ds=(n=>(n[n.None=0]="None",n[n.Hold=1]="Hold",n[n.Loop=2]="Loop",n[n.PingPong=3]="PingPong",n[n.Continue=4]="Continue",n))(ds||{}),my=(n=>(n.Signal="SignalEmitter",n))(my||{});const us=C("debugtimeline");class Fh{constructor(){a(this,"director"),a(this,"track")}get muted(){return this.track.muted}set muted(t){var i;t!==this.track.muted&&(this.track.muted=t,(i=this.onMuteChanged)==null||i.call(this))}*forEachClip(t=!1){var i;if((i=this.track)!=null&&i.clips)if(t)for(let s=this.track.clips.length-1;s>=0;s--)yield this.track.clips[s];else for(const s of this.track.clips)yield s}getClipTime(t,i){return i.clipIn+(t-i.start)*i.timeScale}getClipTimeNormalized(t,i){return(t-i.start)/i.duration}evaluateWeight(t,i,s,o=!0){if(i<0||i>=s.length)return 0;const r=s[i];if(o||t>=r.start&&t<=r.end){let l=1;const c=!1;if(r.easeInDuration>0){const h=Math.min((t-r.start)/r.easeInDuration,1);l*=h}if(r.easeOutDuration>0&&!c){const h=Math.min((r.end-t)/r.easeOutDuration,1);l*=h}return l}return 0}}class zI{constructor(t){a(this,"clip"),a(this,"rootPositionOffset"),a(this,"rootQuaternionOffset"),a(this,"rootStartPosition"),a(this,"rootEndPosition"),a(this,"rootStartQuaternion"),a(this,"rootEndQuaternion");const i=t.getClip();this.clip=i;const s=t.getRoot(),o=s.name+".position",r=s.name+".quaternion";us&&console.log(i.name,i.tracks,o);for(const l of i.tracks)if(!(l.times.length<=0)){if(l.name.endsWith(o))this.rootStartPosition=new x().fromArray(l.values,0),this.rootEndPosition=new x().fromArray(l.values,l.values.length-3),this.rootPositionOffset=this.rootEndPosition.clone().sub(this.rootStartPosition),us&&console.log(this.rootPositionOffset);else if(l.name.endsWith(r)&&(this.rootStartQuaternion=new V().fromArray(l.values,0),this.rootEndQuaternion=new V().fromArray(l.values,l.values.length-4),this.rootQuaternionOffset=this.rootEndQuaternion.clone().multiply(this.rootStartQuaternion),us)){const c=new Bt().setFromQuaternion(this.rootQuaternionOffset);console.log("ROT",c)}}}get hasOffsets(){return this.rootPositionOffset!==void 0||this.rootQuaternionOffset!==void 0}}class Vp extends Fh{constructor(){super(...arguments),a(this,"models",[]),a(this,"trackOffset"),a(this,"target"),a(this,"mixer"),a(this,"clips",[]),a(this,"actions",[]),a(this,"weight",1),a(this,"_actionOffsets",[]),a(this,"_didBind",!1),a(this,"_animator",null),a(this,"_useclipOffsets",!0),a(this,"_totalOffsetPosition",new x),a(this,"_totalOffsetRotation",new V),a(this,"_totalOffsetPosition2",new x),a(this,"_totalOffsetRotation2",new V),a(this,"_summedPos",new x),a(this,"_tempPos",new x),a(this,"_summedRot",new V),a(this,"_tempRot",new V),a(this,"_clipRotQuat",new V)}onDisable(){var t;(t=this.mixer)==null||t.stopAllAction()}onDestroy(){this.director.context.animations.unregisterAnimationMixer(this.mixer)}onStateChanged(){this._animator&&vw(this._animator.gameObject,this,this.director.isPlaying)}createHooks(t,i){var s,o;if(((s=i.tracks)==null?void 0:s.length)<=0){console.warn("No tracks in AnimationClip",i);return}const r=i.tracks[0].name.split("."),l=r[r.length-2],c=l+".position",h=l+".quaternion";let d=!1,u=!1;for(const p of i.tracks)p.name.endsWith(c)?(d=!0,this.createPositionInterpolant(i,t,p)):p.name.endsWith(h)&&(u=!0,this.createRotationInterpolant(i,t,p));if(!d||!u){const p=(o=this.mixer)==null?void 0:o.getRoot(),g=i.tracks[0],y=g.name.lastIndexOf("."),f=g.name.substring(0,y),v=f.substring(f.lastIndexOf(".")+1),b=p.getObjectByName(v);if(b)if(d){if(!u){const w=i.tracks[0].name.substring(0,y)+".quaternion";us&&console.warn("Create quaternion track",v,b);const _=b.quaternion,S=new OC(w,[0,i.duration],[_.x,_.y,_.z,_.w,_.x,_.y,_.z,_.w]);i.tracks.push(S),this.createRotationInterpolant(i,t,S)}}else{const w=f+".position";us&&console.warn("Create position track",v,b);const _=b.position,S=new CC(w,[0,i.duration],[_.x,_.y,_.z,_.x,_.y,_.z]);i.tracks.push(S),this.createPositionInterpolant(i,t,S)}}}bind(){if(!this._didBind){this._didBind=!0,us&&console.log(this.models),this.mixer?this.target=this.mixer.getRoot():console.warn("No mixer was assigned to animation track");for(const t of this.actions){const i=new zI(t);this._actionOffsets.push(i)}this.target&&(this._animator=O.getComponent(this.target,kt)??null,this._animator&&vw(this._animator.gameObject,this,!0));for(const t of this.models){const i=t.asset,s=i.position,o=i.rotation;s&&s.x!==void 0&&(s.isVector3||(i.position=new x(s.x,s.y,s.z)),o.isQuaternion||(i.rotation=new V(o.x,o.y,o.z,o.w)))}this.ensureTrackOffsets()}}ensureTrackOffsets(){if(this.trackOffset){const t=this.trackOffset.position;t&&(t.isVector3||(this.trackOffset.position=new x(t.x,t.y,t.z)));const i=this.trackOffset.rotation;i&&(i.isQuaternion||(this.trackOffset.rotation=new V(i.x,i.y,i.z,i.w)))}}evaluate(t){var i,s,o,r,l,c,h;if(this.track.muted||!this.mixer)return;this.bind(),this._totalOffsetPosition.set(0,0,0),this._totalOffsetRotation.set(0,0,0,1),this._totalOffsetPosition2.set(0,0,0),this._totalOffsetRotation2.set(0,0,0,1);let d=0,u=0,p=!1,g=!1,y=0;for(let f=0;f<this.clips.length;f++){const v=this.models[f],b=this.actions[f],w=v.asset;b.weight=0;const _=t>=v.start&&t<=v.end,S=v.preExtrapolationMode,R=v.postExtrapolationMode,M=f<this.clips.length-1?this.models[f+1]:null;let T=_,L=!1;if(!T&&!p&&v.end<t&&R!==ds.None?(!M||M.start>t)&&(T=!0,p=!0):f==0&&!T&&!g&&v.start>t&&S!==ds.None&&(!M||M.start<t)&&(T=!0,L=!0,g=!0),T){let D=this.weight;D*=this.evaluateWeight(t,f,this.models,T),D*=this.director.weight;let U=_;if(L)switch(S){case ds.Hold:break;case ds.Loop:t+=v.start,U=!0;break;default:t+=v.start,U=!0;break}let B=this.getClipTime(t,v),Y=0;const $=w.duration;if(L&&S===ds.Hold&&(B=0),U){if(w.loop)for(Y+=Math.floor(B/($+1e-6));B>$;)B-=$}else if(!_&&p)switch(R){case ds.Hold:B=this.getClipTime(v.end,v);break;case ds.Loop:B%=$;break;case ds.PingPong:const z=Math.floor(B/$)%2!==0;B%=$,z&&(B=$-B);break}v.reversed===!0?b.time=b.getClip().duration-B:b.time=B,b.timeScale=0;const E=Math.max(0,D);if(b.weight=E,y+=E,b.clampWhenFinished=!1,b.isRunning()||b.play(),this._useclipOffsets){const z=d==0?this._totalOffsetPosition:this._totalOffsetPosition2,H=d==0?this._totalOffsetRotation:this._totalOffsetRotation2;d<1&&(u=1-D),d+=1;const ie=this._summedPos.set(0,0,0),oe=this._tempPos.set(0,0,0),de=this._summedRot.identity(),me=this._tempRot.identity(),Xe=w.rotation;Xe&&(this._clipRotQuat.identity(),this._clipRotQuat.slerp(Xe,D));const Qe=this._actionOffsets[f];if(Qe.hasOffsets)for(let hn=0;hn<Y;hn++)Qe.rootPositionOffset?oe.copy(Qe.rootPositionOffset):oe.set(0,0,0),oe.applyQuaternion(de),this._clipRotQuat&&oe.applyQuaternion(this._clipRotQuat),Qe.rootQuaternionOffset&&(me.copy(Qe.rootQuaternionOffset),de.multiply(me)),ie.add(oe);this._clipRotQuat&&H.multiply(this._clipRotQuat),H.multiply(de),w.position&&ie.add(w.position),z.add(ie)}}}if(this._useclipOffsets&&(this._totalOffsetPosition.lerp(this._totalOffsetPosition2,u),this._totalOffsetRotation.slerp(this._totalOffsetRotation2,u)),this.__mixerError===void 0&&(us||F())&&(s=(i=this._animator)==null?void 0:i.runtimeAnimatorController)!=null&&s.mixer&&this.mixer!==((r=(o=this._animator)==null?void 0:o.runtimeAnimatorController)==null?void 0:r.mixer)&&(this.__mixerError=!0,console.error("AnimationTrack mixer is not shared with the animator controller - this might result in the timeline to not animate properly. Please report a bug to the Needle Engine team!",this)),(l=this._animator)!=null&&l.runtimeAnimatorController){const f=Math.max(0,1-y);(h=(c=this._animator)==null?void 0:c.runtimeAnimatorController)==null||h.update(f)}else this.mixer.update(t)}createRotationInterpolant(t,i,s){var o;const r=s.createInterpolant.bind(s),l=new V;this.ensureTrackOffsets();const c=(o=this.trackOffset)==null?void 0:o.rotation;s.createInterpolant=()=>{const h=r(),d=h.evaluate.bind(h);return h.evaluate=u=>{var p;const g=d(u);if(l.set(g[0],g[1],g[2],g[3]),l.premultiply(this._totalOffsetRotation),c&&l.premultiply(c),this.director.animationCallbackReceivers)for(const y of this.director.animationCallbackReceivers)(p=y?.onTimelineRotation)==null||p.call(y,this.director,this.target,u,l);return g[0]=l.x,g[1]=l.y,g[2]=l.z,g[3]=l.w,g},h}}createPositionInterpolant(t,i,s){var o,r;const l=s.createInterpolant.bind(s),c=new x;this.ensureTrackOffsets();const h=(o=this.trackOffset)==null?void 0:o.rotation,d=(r=this.trackOffset)==null?void 0:r.position;let u;s.createInterpolant=()=>{const p=l(),g=p.evaluate.bind(p);return p.evaluate=y=>{var f,v,b;const w=g(y);if(c.set(w[0],w[1],w[2]),i.removeStartOffset&&(u===void 0?(u=null,u=(v=(f=this._actionOffsets.find(_=>_.clip===t))==null?void 0:f.rootStartPosition)==null?void 0:v.clone()):u!=null&&u.isVector3&&c.sub(u)),c.applyQuaternion(this._totalOffsetRotation),c.add(this._totalOffsetPosition),h&&c.applyQuaternion(h),d&&(c.x-=d.x,c.y+=d.y,c.z+=d.z),this.director.animationCallbackReceivers)for(const _ of this.director.animationCallbackReceivers)(b=_?.onTimelinePosition)==null||b.call(_,this.director,this.target,y,c);return w[0]=c.x,w[1]=c.y,w[2]=c.z,w},p}}}const UI=C("mutetimeline"),zh=class extends Fh{constructor(){super(...arguments),a(this,"models",[]),a(this,"listener"),a(this,"audio",[]),a(this,"audioContextTimeOffset",[]),a(this,"lastTime",0),a(this,"audioSource"),a(this,"_audioLoader",null),a(this,"_playableDirectorResumed",!1)}getAudioFilePath(n){const t=this.director.sourceId;return ao(t,n)}onAllowAudioChanged(n){for(let t=0;t<this.models.length;t++){const i=this.models[t];this.audio[t].setVolume(n?i.asset.volume:0)}}addModel(n){const t=new PC(this.listener);this.audio.push(t);const i=n;i._didTriggerPlay=!1,this.models.push(i)}onDisable(){for(const n of this.audio)n.isPlaying&&n.stop();for(const n of this.models)n._didTriggerPlay=!1}onDestroy(){for(const n of this.audio)n.source&&n?.disconnect();this.audio.length=0}onMuteChanged(){if(this.muted)for(let n=0;n<this.audio.length;n++){const t=this.audio[n];t!=null&&t.isPlaying&&t.stop()}}stop(){for(let n=0;n<this.audio.length;n++){const t=this.audio[n];t!=null&&t.isPlaying&&t.stop()}for(const n of this.models)n._didTriggerPlay=!1}onPauseChanged(){for(let n=0;n<this.audio.length;n++){const t=this.audio[n];t!=null&&t.isPlaying&&t.stop()}this._playableDirectorResumed=this.director.isPlaying}evaluate(n){if(UI||this.track.muted||this.director.speed<0)return;const t=this.director.context.application.muted,i=this._playableDirectorResumed;this._playableDirectorResumed=!1;const s=t?.1:0;for(let o=0;o<this.models.length;o++){const r=this.models[o],l=this.audio[o],c=r.asset;if((!l||!l.buffer)&&this.isInTimeRange(r,n-1,n+1)&&this.handleAudioLoading(r,l),Ne.userInteractionRegistered!==!1&&!(l===null||!l.buffer))if(l.playbackRate=this.director.context.time.timeScale*this.director.speed,l.loop=c.loop,n>=r.start&&n<=r.end&&n<this.director.duration){if(!l.isPlaying||!this.director.isPlaying)(i||!r._didTriggerPlay&&this.lastTime<n)&&(r.duration*r.timeScale>.3?l.offset=r.clipIn+(n-r.start)*r.timeScale:l.offset=0,us&&console.log("Timeline Audio ("+this.track.name+") play with offset "+l.offset+" - "+r.asset.clip),l.play(s),r._didTriggerPlay=!0);else{const d=r.clipIn+(n-r.start)*r.timeScale,u=l.context.currentTime-l._startedAt+l.offset;Math.abs(d-u)>.3&&(l.offset=d,l.stop(),l.play(s))}let h=c.volume;if(this.track.volume!==void 0&&(h*=this.track.volume),t&&(h=0),r.easeInDuration>0){const d=Math.min((n-r.start)/r.easeInDuration,1);h*=d}if(r.easeOutDuration>0){const d=Math.min((r.end-n)/r.easeOutDuration,1);h*=d}l.setVolume(h*this.director.weight)}else r._didTriggerPlay=!1,this.director.isPlaying&&l.isPlaying&&l.stop()}this.lastTime=n}loadAudio(n,t=0,i=0){let s=null;const o=n-i,r=n+t;for(const l of this.models)if(this.isInTimeRange(l,o,r)){const c=this.audio[this.models.indexOf(l)],h=this.handleAudioLoading(l,c);h!==null&&(s===null&&(s=[]),s.push(h))}return s!==null?Promise.all(s):null}isInTimeRange(n,t,i){return t<=n.start&&i>=n.end||t>=n.start&&t<=n.end||i>=n.start&&i<=n.end}static dispose(){zh._audioBuffers.clear()}handleAudioLoading(n,t){this._audioLoader||(this._audioLoader=new hm);const i=this.getAudioFilePath(n.asset.clip);if(zh._audioBuffers.get(i)){const o=zh._audioBuffers.get(i);return o.then(r=>{r&&t.setBuffer(r)}),o}us&&console.warn("LOAD audio track",i,this.director.sourceId);const s=new Promise((o,r)=>{this._audioLoader.load(i,l=>{t.setBuffer(l),o(l)},void 0,l=>{console.error("Error loading audio",l),o(null)})});return zh._audioBuffers.set(i,s),s}};let Uh=zh;a(Uh,"_audioBuffers",new Map);class Nh extends Fh{constructor(){super(...arguments),a(this,"models",[]),a(this,"didTrigger",[]),a(this,"receivers",[])}evaluate(t){var i;if(this.track.muted)return;const s=this.director.context.time.deltaTime*1.5;for(let o=0;o<this.models.length;o++){const r=this.models[o],l=this.didTrigger[o],c=r.time-t;let h=!1;if(r.retroActive)h=c<=1e-6;else{const d=Math.abs(c);(d===0||d>=1e-5&&d<s)&&(h=!0)}if(h){if(!l)if(us&&console.log("Trigger signal",t,r.time,r),this.didTrigger[o]=!0,((i=this.receivers)==null?void 0:i.length)<=0)Il.invoke(r.asset);else for(const d of this.receivers)d&&d.invoke(r.asset)}else r.emitOnce||(this.didTrigger[o]=!1)}}}class Hp extends Fh{constructor(){super(...arguments),a(this,"models",[]),a(this,"timelines",[]),a(this,"_previousActiveModel",null)}resolveSourceObjects(t){for(let i=this.models.length-1;i>=0;i--){const s=this.models[i].asset;if(!s.sourceObject||typeof s.sourceObject!="object"){console.log("no source object, removing model",i,s),this.models.splice(i,1);continue}else{const o=O.getComponent(s.sourceObject,Ko);this.timelines.push(o),o&&s.updateDirector&&(o.playOnAwake=!1)}}}evaluate(t){var i;this._previousActiveModel=null;for(let s=0;s<this.models.length;s++){const o=this.models[s],r=o.asset;if(t>=o.start&&t<=o.end){this._previousActiveModel=o;const l=this.getClipTime(t,o);if(r.controlActivation){const c=r.sourceObject;c.visible=!0}if(r.updateDirector){const c=this.timelines[s];c&&(c.isPlaying&&c.pause(),c.time=l,c.evaluate())}}else{const l=(i=this._previousActiveModel)==null?void 0:i.asset;if(r.controlActivation){const c=r.sourceObject;l?.sourceObject!==c&&(c.visible=!1)}}}}}var NI=Object.defineProperty,WI=Object.getOwnPropertyDescriptor,A1=(n,t,i,s)=>{for(var o=s>1?void 0:s?WI(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&NI(t,i,o),o};const Xs=C("debugtimeline");var gy;const fy=(gy=class extends A{constructor(){super(...arguments),a(this,"playableAsset"),a(this,"playOnAwake"),a(this,"extrapolationMode",1),a(this,"waitForAudio",!0),a(this,"_visibilityChangeEvt"),a(this,"_clonedPlayableAsset",!1),a(this,"_speed",1),a(this,"_guidsMap"),a(this,"_isPlaying",!1),a(this,"_internalUpdateRoutine"),a(this,"_isPaused",!1),a(this,"_isStopping",!1),a(this,"_time",0),a(this,"_duration",0),a(this,"_weight",1),a(this,"_animationTracks",[]),a(this,"_audioTracks",[]),a(this,"_signalTracks",[]),a(this,"_controlTracks",[]),a(this,"_customTracks",[]),a(this,"_allTracks",[this._animationTracks,this._audioTracks,this._signalTracks,this._controlTracks,this._customTracks]),a(this,"animationCallbackReceivers",[])}static registerCreateTrack(n,t){this.createTrackFunctions[n]=t}get isPlaying(){return this._isPlaying}get isPaused(){return this._isPaused}get time(){return this._time}set time(n){typeof n=="number"&&!Number.isNaN(n)?this._time=n:(Xs||Xt())&&console.error("INVALID TIMELINE.TIME VALUE",n,this.name)}get duration(){return this._duration}set duration(n){this._duration=n}get weight(){return this._weight}set weight(n){this._weight=n}get speed(){return this._speed}set speed(n){this._speed=n}awake(){var n,t,i,s,o;Xs&&console.log(this,(n=this.playableAsset)==null?void 0:n.tracks),this.rebuildGraph(),!this.isValid()&&(Xs||F())&&(Xs?console.warn("PlayableDirector is not valid","Asset?",this.playableAsset,"Tracks:",(t=this.playableAsset)==null?void 0:t.tracks,"IsArray?",Array.isArray((i=this.playableAsset)==null?void 0:i.tracks),this):(o=(s=this.playableAsset)==null?void 0:s.tracks)!=null&&o.length?console.warn("PlayableDirector is not valid"):console.warn("PlayableDirector has no tracks"))}onEnable(){var n,t,i;for(const s of this._audioTracks)(n=s.onEnable)==null||n.call(s);for(const s of this._customTracks)(t=s.onEnable)==null||t.call(s);for(const s of this._animationTracks)(i=s.onEnable)==null||i.call(s);this.playOnAwake&&this.play(),this._visibilityChangeEvt||(this._visibilityChangeEvt=()=>{switch(document.visibilityState){case"hidden":this.setAudioTracksAllowPlaying(!1);break;case"visible":this.setAudioTracksAllowPlaying(!0);break}}),window.addEventListener("visibilitychange",this._visibilityChangeEvt)}onDisable(){var n,t,i;this.stop();for(const s of this._audioTracks)(n=s.onDisable)==null||n.call(s);for(const s of this._customTracks)(t=s.onDisable)==null||t.call(s);for(const s of this._animationTracks)(i=s.onDisable)==null||i.call(s);this._visibilityChangeEvt&&window.removeEventListener("visibilitychange",this._visibilityChangeEvt)}onDestroy(){var n;for(const t of this._allTracks)for(const i of t)(n=i.onDestroy)==null||n.call(i)}rebuildGraph(){this.isValid()&&(this.resolveBindings(),this.updateTimelineDuration(),this.setupAndCreateTrackHandlers())}async play(){if(!this.isValid())return;const n=this._isPaused==!0;if(this._isPaused=!1,!this._isPlaying){if(this._isPlaying=!0,n&&this.invokePauseChangedMethodsOnTracks(),this.waitForAudio){const t=[];for(const i of this._audioTracks){const s=i.loadAudio(this._time,1,0);s&&t.push(s)}if(t.length>0&&(await Promise.all(t),!this._isPlaying))return;for(;this._audioTracks.length>0&&this._isPlaying&&!Ne.userInteractionRegistered&&this.waitForAudio;)await yn(200)}this.invokeStateChangedMethodsOnTracks(),this._internalUpdateRoutine=this.startCoroutine(this.internalUpdate(),Me.LateUpdate)}}pause(){this.isValid()&&(this._isPlaying=!1,!this._isPaused&&(this._isPaused=!0,this.internalEvaluate(),this.invokePauseChangedMethodsOnTracks(),this.invokeStateChangedMethodsOnTracks()))}stop(){this._isStopping=!0;for(const i of this._audioTracks)i.stop();const n=this._isPaused==!0,t=this._isPlaying;this._isPlaying&&(this._time=0,this._isPlaying=!1,this._isPaused=!1,this.internalEvaluate(),n&&this.invokePauseChangedMethodsOnTracks()),this._isPlaying=!1,this._isPaused=!1,n&&!t&&this.invokePauseChangedMethodsOnTracks(),t&&this.invokeStateChangedMethodsOnTracks(),this._internalUpdateRoutine&&this.stopCoroutine(this._internalUpdateRoutine),this._internalUpdateRoutine=null,this._isStopping=!1}evaluate(){this.internalEvaluate(!0)}isValid(){return this.playableAsset&&this.playableAsset.tracks&&Array.isArray(this.playableAsset.tracks)}*forEachTrack(){for(const n of this._allTracks)for(const t of n)yield t}get animationTracks(){return this._animationTracks}get audioTracks(){return this._audioTracks}resolveGuids(n){this._guidsMap=n}invokePauseChangedMethodsOnTracks(){var n;for(const t of this.forEachTrack())(n=t.onPauseChanged)==null||n.call(t)}invokeStateChangedMethodsOnTracks(){var n;for(const t of this.forEachTrack())(n=t.onStateChanged)==null||n.call(t,this._isPlaying)}*internalUpdate(){for(;this._isPlaying&&this.activeAndEnabled;)!this._isPaused&&this._isPlaying&&(this._time+=this.context.time.deltaTime*this.speed,this.internalEvaluate()),yield}internalEvaluate(n=!1){if(!this.isValid())return;let t=this._time;switch(this.extrapolationMode){case 0:this._speed>0?t=Math.min(t,this._duration):this._speed<0&&(t=Math.max(t,0)),this._time=t;break;case 1:t%=this._duration,this._time=t;break;case 2:if(t>this._duration){this.stop();return}break}const i=this._time;for(const s of this.playableAsset.tracks)if(!s.muted)switch(s.type){case Ni.Activation:if(!n&&!this._isPlaying)continue;for(let o=0;o<s.outputs.length;o++){const r=s.outputs[o];if(typeof r=="object"){let l=!1;if(s.clips)for(const h of s.clips)h.start<=i&&i<=h.end&&(l=!0);const c=r;c.visible!==void 0&&c.visible!==l&&(c.visible=l,Xs&&console.warn(this.name,"set ActivationTrack-"+o,c.name,l,i))}}break}if(!this._isStopping)for(const s of this._animationTracks)s.evaluate(i);for(const s of this._audioTracks)s.evaluate(i);for(const s of this._signalTracks)s.evaluate(i);for(const s of this._controlTracks)s.evaluate(i);for(const s of this._customTracks)s.evaluate(i)}resolveBindings(){if(this._clonedPlayableAsset||(this._clonedPlayableAsset=!0,this.playableAsset=Zl(this.playableAsset)),!this.playableAsset||!this.playableAsset.tracks)return;const n=this.findRoot(this.gameObject);for(const t of this.playableAsset.tracks){for(let i=t.outputs.length-1;i>=0;i--){let s=t.outputs[i];if(typeof s=="string"){this._guidsMap&&this._guidsMap[s]&&(s=this._guidsMap[s]);const o=O.findByGuid(s,n);o===null||typeof o!="object"?(t.outputs.splice(i,1),console.warn("Failed to resolve binding",s,t.name,t.type)):(Xs&&console.log("Resolved binding",s,"to",o),t.outputs[i]=o)}else if(s===null){if(t.outputs.splice(i,1),fy.createTrackFunctions[t.type])continue;t.type!==Ni.Audio&&t.type!==Ni.Control&&t.type!==Ni.Marker&&t.type!==Ni.Signal&&console.warn("Missing binding",s,t.name,t.type,this.name,this.playableAsset.name)}}if(t.type===Ni.Control&&t.clips)for(let i=0;i<t.clips.length;i++){const s=t.clips[i];let o=s.asset.sourceObject;if(typeof o=="string"){this._guidsMap&&this._guidsMap[o]&&(o=this._guidsMap[o]);const r=O.findByGuid(o,n);r===null||typeof r!="object"?console.warn("Failed to resolve sourceObject binding",o,t.name,s):(Xs&&console.log("Resolved binding",o,"to",r),s.asset.sourceObject=r)}}}}findRoot(n){return n.parent?this.findRoot(n.parent):n}updateTimelineDuration(){if(this._duration=0,!(!this.playableAsset||!this.playableAsset.tracks)){for(const n of this.playableAsset.tracks)if(n.muted!==!0){if(n.clips)for(const t of n.clips)t.end>this._duration&&(this._duration=t.end);if(n.markers)for(const t of n.markers)t.time>this._duration&&(this._duration=t.time+.001)}}}setupAndCreateTrackHandlers(){var n,t,i;if(this._animationTracks.length=0,this._audioTracks.length=0,this._signalTracks.length=0,!this.playableAsset)return;let s=O.findObjectOfType(Ts,this.context);for(const o of this.playableAsset.tracks){const r=o.type,l=fy.createTrackFunctions[r];if(l!=null){const c=l(this,o);if(typeof c.evaluate=="function"){c.director=this,c.track=o,this._customTracks.push(c);continue}}if(o.type===Ni.Animation){if(!o.clips||o.clips.length<=0){Xs&&console.warn("Animation track has no clips",o);continue}for(let c=o.outputs.length-1;c>=0;c--){let h=o.outputs[c];if(h instanceof j){const u=O.getOrAddComponent(h,kt);u&&(h=u)}const d=(n=h?.gameObject)==null?void 0:n.animations;if(d){const u=new Vp;u.trackOffset=o.trackOffset,u.director=this,u.track=o;for(let p=0;p<o.clips.length;p++){const g=o.clips[p],y=g.asset;if(!y){console.error(`Timeline ${this.name}: clip #${p} on track "${o.name}" has no animation data`);continue}const f=y.clip;let v=f;if((typeof v=="string"||typeof v=="number")&&(v=d.find(w=>w.name===f)),Xs&&console.log(y,f,"\u2192",v),!v){console.warn("Could not find animationClip for model",g,o.name,this.name,(t=this.playableAsset)==null?void 0:t.name,d,h);continue}h instanceof kt&&h.runtimeAnimatorController&&(h.__internalDidAwakeAndStart||h.initializeRuntimeAnimatorController(),h.runtimeAnimatorController.mixer||h.runtimeAnimatorController.bind(h),u.mixer=h.runtimeAnimatorController.mixer),u.mixer||(u.mixer=new lm(h.gameObject),this.context.animations.registerAnimationMixer(u.mixer)),u.clips.push(v),u.mixer.uncacheAction(v),u.createHooks(g.asset,v);const b=u.mixer.clipAction(v);u.actions.push(b),u.models.push(g)}this._animationTracks.push(u)}}}else if(o.type===Ni.Audio){if(!o.clips||o.clips.length<=0)continue;const c=new Uh;c.director=this,c.track=o,c.audioSource=o.outputs.find(h=>h instanceof Ne),this._audioTracks.push(c),s||(s=(i=this.context.mainCameraComponent)==null?void 0:i.gameObject.addComponent(Ts)),c.listener=s.listener;for(let h=0;h<o.clips.length;h++){const d=o.clips[h];c.addModel(d)}}else if(o.type===Ni.Marker){const c=new Nh;if(c.director=this,c.track=o,o.markers)for(const h of o.markers)switch(h.type){case my.Signal:c.models.push(h),c.didTrigger.push(!1);break}if(c!==null&&c.models.length>0){const h=O.getComponent(this.gameObject,Il);h&&(c.receivers.push(h),this._signalTracks.push(c))}}else if(o.type===Ni.Signal){const c=new Nh;if(c.director=this,c.track=o,o.markers)for(const h of o.markers)c.models.push(h),c.didTrigger.push(!1);for(const h of o.outputs)c.receivers.push(h);this._signalTracks.push(c)}else if(o.type===Ni.Control){const c=new Hp;if(c.director=this,c.track=o,o.clips)for(const h of o.clips)c.models.push(h);c.resolveSourceObjects(this.context),this._controlTracks.push(c)}}}setAudioTracksAllowPlaying(n){for(const t of this._audioTracks)t.onAllowAudioChanged(n)}registerAnimationCallback(n){this.animationCallbackReceivers.push(n)}unregisterAnimationCallback(n){const t=this.animationCallbackReceivers.indexOf(n);t!==-1&&this.animationCallbackReceivers.splice(t,1)}},a(gy,"createTrackFunctions",{}),gy);let Ko=fy;A1([m()],Ko.prototype,"playOnAwake",2),A1([m()],Ko.prototype,"extrapolationMode",2);var VI=Object.defineProperty,HI=Object.getOwnPropertyDescriptor,$p=(n,t,i,s)=>{for(var o=s>1?void 0:s?HI(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&VI(t,i,o),o};class ia extends A{constructor(){super(...arguments),a(this,"isGizmo",!1),a(this,"translationSnap",1),a(this,"rotationSnapAngle",15),a(this,"scaleSnap",.25),a(this,"_control"),a(this,"orbit"),a(this,"onControlChangedEvent",t=>{const i=this.orbit;if(i&&(i.enabled=!t.value),t.value){const s=O.getComponentInParent(this.gameObject,qn);s&&s.requestOwnership()}}),a(this,"windowKeyDownListener",t=>{if(this.enabled&&this._control)switch(t.keyCode){case 81:this._control.setSpace(this._control.space==="local"?"world":"local");break;case 16:this.enableSnapping();break;case 87:this._control.setMode("translate");break;case 69:this._control.setMode("rotate");break;case 82:this._control.setMode("scale");break;case 187:case 107:this._control.setSize(this._control.size+.1);break;case 189:case 109:this._control.setSize(Math.max(this._control.size-.1,.1));break;case 88:this._control.showX=!this._control.showX;break;case 89:this._control.showY=!this._control.showY;break;case 90:this._control.showZ=!this._control.showZ;break;case 32:this._control.enabled=!this._control.enabled;break}}),a(this,"windowKeyUpListener",t=>{if(this.enabled)switch(t.keyCode){case 16:this.disableSnapping();break}})}get control(){return this._control}onEnable(){var t;if(!(this.isGizmo&&!xc)&&this.context.mainCamera&&(this._control||(this._control=new QC(this.context.mainCamera,this.context.renderer.domElement),this._control.enabled=!0,this._control.getRaycaster().layers.set(2),this._control.size=1,("_root"in this._control?this._control._root:this._control).traverse(i=>{const s=i;if(s.layers.set(2),s){const o=s.material;o&&(o.opacity=.3)}}),this.orbit=O.getComponentInParent(this.context.mainCamera,be)??void 0),this._control)){const i=this._control.getHelper();this.context.scene.add(i),this._control.attach(this.gameObject),(t=this._control)==null||t.addEventListener("dragging-changed",this.onControlChangedEvent),window.addEventListener("keydown",this.windowKeyDownListener),window.addEventListener("keyup",this.windowKeyUpListener)}}onDisable(){var t,i,s;(i=(t=this._control)==null?void 0:t.getHelper())==null||i.removeFromParent(),(s=this._control)==null||s.removeEventListener("dragging-changed",this.onControlChangedEvent),window.removeEventListener("keydown",this.windowKeyDownListener),window.removeEventListener("keyup",this.windowKeyUpListener)}enableSnapping(){this._control&&(this._control.setTranslationSnap(this.translationSnap),this._control.setRotationSnap(ms.degToRad(this.rotationSnapAngle)),this._control.setScaleSnap(this.scaleSnap))}disableSnapping(){this._control&&(this._control.setTranslationSnap(null),this._control.setRotationSnap(null),this._control.setScaleSnap(null))}}$p([m()],ia.prototype,"isGizmo",2),$p([m()],ia.prototype,"translationSnap",2),$p([m()],ia.prototype,"rotationSnapAngle",2),$p([m()],ia.prototype,"scaleSnap",2);var $I=Object.defineProperty,GI=Object.getOwnPropertyDescriptor,Gp=(n,t,i,s)=>{for(var o=s>1?void 0:s?GI(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&$I(t,i,o),o};class yy{constructor(){a(this,"texture",null),a(this,"rect")}}Gp([m(Le)],yy.prototype,"texture",2);let jl=class extends fh{constructor(){super(...arguments),a(this,"_sprite"),a(this,"pixelsPerUnitMultiplier",1)}set image(n){this.sprite||(this.sprite=new yy),this.sprite.texture=n,this.onAfterCreated()}get image(){return this.sprite?this.sprite.texture:null}get sprite(){return this._sprite}set sprite(n){this._sprite!==n&&(this._sprite=n,this.onAfterCreated())}isBuiltinSprite(){var n,t,i,s,o,r,l;const c=this.sprite;switch((n=c?.texture)==null?void 0:n.name){case"InputFieldBackground":case"UISprite":case"Background":case"Knob":return!0}return!((i=(t=c?.texture)==null?void 0:t.name)!=null&&i.length)&&((o=(s=c?.texture)==null?void 0:s.image)==null?void 0:o.width)===32&&((l=(r=c?.texture)==null?void 0:r.image)==null?void 0:l.height)===32}onBeforeCreate(n){var t,i;super.onBeforeCreate(n),this.isBuiltinSprite()&&(n.borderRadius=5/this.pixelsPerUnitMultiplier,((i=(t=this.sprite)==null?void 0:t.texture)==null?void 0:i.name)==="Knob"&&(n.borderRadius=999))}onAfterCreated(){var n;this.__didAwake&&(super.onAfterCreated(),!this.isBuiltinSprite()&&this.setTexture((n=this.sprite)==null?void 0:n.texture))}};Gp([m(yy)],jl.prototype,"sprite",1),Gp([m()],jl.prototype,"pixelsPerUnitMultiplier",2);class qp extends fh{constructor(){super(...arguments),a(this,"_mainTexture")}get mainTexture(){return this._mainTexture}set mainTexture(t){this._mainTexture!==t&&(this._mainTexture=t,this.onAfterCreated())}onAfterCreated(){this.__didAwake&&(super.onAfterCreated(),this.setTexture(this.mainTexture))}}Gp([m(Le)],qp.prototype,"mainTexture",1);var qI=Object.defineProperty,XI=Object.getOwnPropertyDescriptor,Wi=(n,t,i,s)=>{for(var o=s>1?void 0:s?XI(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&qI(t,i,o),o};const na=C("debugbutton");class Jo{constructor(){a(this,"colorMultiplier"),a(this,"disabledColor"),a(this,"fadeDuration"),a(this,"highlightedColor"),a(this,"normalColor"),a(this,"pressedColor"),a(this,"selectedColor")}}Wi([m()],Jo.prototype,"colorMultiplier",2),Wi([m(xe)],Jo.prototype,"disabledColor",2),Wi([m()],Jo.prototype,"fadeDuration",2),Wi([m(xe)],Jo.prototype,"highlightedColor",2),Wi([m(xe)],Jo.prototype,"normalColor",2),Wi([m(xe)],Jo.prototype,"pressedColor",2),Wi([m(xe)],Jo.prototype,"selectedColor",2);class QI{constructor(){a(this,"disabledTrigger"),a(this,"highlightedTrigger"),a(this,"normalTrigger"),a(this,"pressedTrigger"),a(this,"selectedTrigger")}}class Qs extends A{constructor(){super(...arguments),a(this,"onClick",new Se),a(this,"_isHovered",0),a(this,"colors"),a(this,"transition"),a(this,"animationTriggers"),a(this,"animator"),a(this,"_interactable",!0),a(this,"_requestedAnimatorTrigger"),a(this,"_isInit",!1),a(this,"_image")}click(){var t;(t=this.onClick)==null||t.invoke()}onPointerEnter(t){var i,s;const o=t.event.pointerType==="mouse"&&t.button===0;o&&(this._isHovered+=1),na&&console.warn("Button Enter",o,this._isHovered,(i=this.animationTriggers)==null?void 0:i.highlightedTrigger,this.animator),this.interactable&&(this.transition==3&&this.animationTriggers&&this.animator?this.animator.setTrigger(this.animationTriggers.highlightedTrigger):this.transition===1&&this.colors&&((s=this._image)==null||s.setState("hovered")),o&&this.context.input.setCursor("pointer"))}onPointerExit(){var t,i;this._isHovered-=1,this._isHovered<0&&(this._isHovered=0),na&&console.log("Button Exit",this._isHovered,(t=this.animationTriggers)==null?void 0:t.highlightedTrigger,this.animator),this.interactable&&(this._isHovered>0||(this._isHovered=0,this.transition==3&&this.animationTriggers&&this.animator?this.animator.setTrigger(this.animationTriggers.normalTrigger):this.transition===1&&this.colors&&((i=this._image)==null||i.setState("normal")),this.context.input.unsetCursor("pointer")))}onPointerDown(t){var i,s;na&&console.log("Button Down",(i=this.animationTriggers)==null?void 0:i.highlightedTrigger,this.animator),this.interactable&&(this.transition==3&&this.animationTriggers&&this.animator?this.animator.setTrigger(this.animationTriggers.pressedTrigger):this.transition===1&&this.colors&&((s=this._image)==null||s.setState("pressed")))}onPointerUp(t){var i,s;na&&console.warn("Button Up",(i=this.animationTriggers)==null?void 0:i.highlightedTrigger,this.animator,this._isHovered),this.interactable&&(this.transition==3&&this.animationTriggers&&this.animator?this.animator.setTrigger(this._isHovered?this.animationTriggers.highlightedTrigger:this.animationTriggers.normalTrigger):this.transition===1&&this.colors&&((s=this._image)==null||s.setState(this._isHovered?"hovered":"normal")))}onPointerClick(t){if(this.interactable&&!(t.button!==0&&t.event.pointerType===kd.Mouse)&&(na&&(console.warn("Button Click",this.onClick),De("CLICKED button "+this.name+" at "+this.context.time.frameCount)),this.onClick&&this.onClick.listenerCount>0&&(this.onClick.invoke(),t.use(),na))){const i=this.gameObject.worldPosition;i.add(this.gameObject.worldUp.multiplyScalar(1+Math.random()*.5)),G.DrawLabel(i,"CLICK:"+Date.now(),.1,1+Math.random()*.5)}}set interactable(t){this._interactable=t,this._image&&(this._image.setInteractable(t),t?this._image.setState("normal"):this._image.setState("disabled"))}get interactable(){return this._interactable}set_interactable(t){this.interactable=t}awake(){super.awake(),na&&console.log(this),this._isInit=!1,this.init()}start(){var t;(t=this._image)==null||t.setInteractable(this.interactable),this.gameObject.getComponentInParent(Va)||this.gameObject.addComponent(ku)}onEnable(){super.onEnable()}onDestroy(){this._isHovered&&this.context.input.unsetCursor("pointer")}*setAnimatorTriggerAtEndOfFrame(t){var i;this._requestedAnimatorTrigger=t,yield,yield,this._requestedAnimatorTrigger==t&&((i=this.animator)==null||i.setTrigger(t))}init(){this._isInit||(this._isInit=!0,this._image=O.getComponent(this.gameObject,jl),this._image&&(this.stateSetup(this._image),this.interactable?this._image.setState("normal"):this._image.setState("disabled")))}stateSetup(t){var i,s,o,r,l;t.setInteractable(this.interactable);const c=this.getFinalColor(t.color,(i=this.colors)==null?void 0:i.normalColor),h={state:"normal",attributes:{backgroundColor:c,backgroundOpacity:c.alpha}};t.setupState(h);const d=this.getFinalColor(t.color,(s=this.colors)==null?void 0:s.highlightedColor),u={state:"hovered",attributes:{backgroundColor:d,backgroundOpacity:d.alpha}};t.setupState(u);const p=this.getFinalColor(t.color,(o=this.colors)==null?void 0:o.pressedColor),g={state:"pressed",attributes:{backgroundColor:p,backgroundOpacity:p.alpha}};t.setupState(g);const y=this.getFinalColor(t.color,(r=this.colors)==null?void 0:r.selectedColor),f={state:"selected",attributes:{backgroundColor:y,backgroundOpacity:y.alpha}};t.setupState(f);const v=this.getFinalColor(t.color,(l=this.colors)==null?void 0:l.disabledColor),b={state:"disabled",attributes:{backgroundColor:v,backgroundOpacity:v.alpha}};t.setupState(b)}getFinalColor(t,i){return i?t.clone().multiply(i).convertLinearToSRGB():t.clone().convertLinearToSRGB()}}Wi([m(Se)],Qs.prototype,"onClick",2),Wi([m(Jo)],Qs.prototype,"colors",2),Wi([m()],Qs.prototype,"transition",2),Wi([m(QI)],Qs.prototype,"animationTriggers",2),Wi([m(kt)],Qs.prototype,"animator",2),Wi([m()],Qs.prototype,"interactable",1);var YI=Object.defineProperty,ZI=Object.getOwnPropertyDescriptor,Xp=(n,t,i,s)=>{for(var o=s>1?void 0:s?ZI(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&YI(t,i,o),o};const er=C("debuginputfield");var Ll;const K=(Ll=class extends A{constructor(){super(...arguments),a(this,"textComponent"),a(this,"placeholder"),a(this,"onValueChanged"),a(this,"onEndEdit"),a(this,"inputEventFn"),a(this,"_iosEventFn")}get text(){var n;return((n=this.textComponent)==null?void 0:n.text)??""}set text(n){this.textComponent&&(this.textComponent.text=n,this.placeholder&&(n.length>0?this.placeholder.gameObject.visible=!1:this.placeholder.gameObject.visible=!0))}get isFocused(){return K.active===this}start(){er&&console.log(this.name,this)}onEnable(){var n;K.htmlField||(K.htmlField=document.createElement("input"),K.htmlField.style.width="0px",K.htmlField.style.height="0px",K.htmlField.style.padding="0px",K.htmlField.style.border="none",K.htmlField.style.overflow="hidden",K.htmlField.style.caretColor="transparent",K.htmlField.style.outline="none",K.htmlField.classList.add("ar"),K.htmlField.onfocus=()=>K.htmlFieldFocused=!0,K.htmlField.onblur=()=>K.htmlFieldFocused=!1,document.body.append(K.htmlField)),this.inputEventFn||(this.inputEventFn=this.onInput.bind(this)),K.htmlField.addEventListener("keyup",this.inputEventFn),this.placeholder&&(n=this.textComponent)!=null&&n.text.length&&O.setActive(this.placeholder.gameObject,!1),Q.isiOS()&&(this._iosEventFn=this.processInputOniOS.bind(this),window.addEventListener("click",this._iosEventFn))}onDisable(){var n;(n=K.htmlField)==null||n.removeEventListener("keyup",this.inputEventFn),this.onDeselected(),this._iosEventFn&&window.removeEventListener("click",this._iosEventFn)}clear(){K.active===this&&K.htmlField?(K.htmlField.value="",this.setTextFromInputField()):(this.textComponent&&(this.textComponent.text=""),this.placeholder&&O.setActive(this.placeholder.gameObject,!0))}select(){this.onSelected()}deselect(){this.onDeselected()}onPointerEnter(n){n.event.pointerType==="mouse"&&n.button===0&&this.context.input.setCursor("text")}onPointerExit(n){this.context.input.unsetCursor("text")}onPointerClick(n){er&&console.log("CLICK",n,K.active),K.activeTime=this.context.time.time,K.active!==this&&this.startCoroutine(this.activeLoop(),Me.LateUpdate),this.selectInputField()}*activeLoop(){for(this.onSelected();K.active===this&&!(this.context.input.getPointerClicked(0)&&this.context.time.time-K.activeTime>.2);)this.setTextFromInputField(),yield;this.onDeselected()}onSelected(){var n,t,i,s;if(K.active!==this&&(er&&console.log("Select",this.name,this,K.htmlField,this.context.isInXR,this.context.arOverlayElement,(n=this.textComponent)==null?void 0:n.text,(t=K.htmlField)==null?void 0:t.value),(i=K.active)==null||i.onDeselected(),K.active=this,this.placeholder&&O.setActive(this.placeholder.gameObject,!1),K.htmlField)){if(K.htmlField.value=((s=this.textComponent)==null?void 0:s.text)||"",er&&console.log("set input field value",K.htmlField.value),this.context.isInXR){const o=this.context.arOverlayElement;o&&o.append(K.htmlField)}this.selectInputField()}}onDeselected(){var n;K.active===this&&(K.active=null,er&&console.log("Deselect",this.name,this),K.htmlField&&(K.htmlField.blur(),document.body.append(K.htmlField)),this.placeholder&&(!this.textComponent||this.textComponent.text.length<=0)&&O.setActive(this.placeholder.gameObject,!0),K.htmlField&&((n=this.onEndEdit)==null||n.invoke(K.htmlField.value)))}update(){var n;K.active===this&&((n=this.textComponent)==null||n.markDirty())}onInput(n){var t,i;if(K.active===this){if(er&&console.log(n.code,n,(t=K.htmlField)==null?void 0:t.value,(i=this.textComponent)==null?void 0:i.text),n.code==="Escape"||n.code==="Enter"){this.onDeselected();return}K.htmlField&&(this.textComponent&&(this.setTextFromInputField(),this.placeholder&&O.setActive(this.placeholder.gameObject,this.textComponent.text.length<=0)),this.selectInputField())}}setTextFromInputField(){var n;if(this.textComponent&&K.htmlField){const t=this.textComponent.text,i=K.htmlField.value,s=this.textComponent.text!==K.htmlField.value;this.textComponent.text=K.htmlField.value,s&&(er&&console.log("[InputField] value changed:",i,t),(n=this.onValueChanged)==null||n.invoke(i,t))}}selectInputField(){K.htmlField&&(er&&console.log("Focus Inputfield",K.htmlFieldFocused),K.htmlField.setSelectionRange(K.htmlField.value.length,K.htmlField.value.length),Q.isiOS()?K.htmlField.focus({preventScroll:!0}):setTimeout(()=>{var n;return(n=K.htmlField)==null?void 0:n.focus()},1))}processInputOniOS(){const n=this.context.physics.raycast();if(!n.length)return;const t=n[0].object,i=pf(t);(i?.gameObject===this.gameObject||i?.gameObject.parent===this.gameObject)&&this.selectInputField()}},a(Ll,"active",null),a(Ll,"activeTime",-1),a(Ll,"htmlField",null),a(Ll,"htmlFieldFocused",!1),Ll);let sa=K;Xp([m(Ht)],sa.prototype,"textComponent",2),Xp([m(Ht)],sa.prototype,"placeholder",2),Xp([m(Se)],sa.prototype,"onValueChanged",2),Xp([m(Se)],sa.prototype,"onEndEdit",2);var KI=Object.defineProperty,JI=Object.getOwnPropertyDescriptor,I1=(n,t,i,s)=>{for(var o=s>1?void 0:s?JI(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&KI(t,i,o),o};class Wh extends A{constructor(){super(...arguments),a(this,"id",null),a(this,"keepAspect",!1),a(this,"_object",null)}onEnable(){if(this._object){this.gameObject.add(this._object);return}if(!this.id||!this.context.mainCamera)return;const t=document.getElementById(this.id);if(!t){console.warn('Could not find element with id "'+this.id+'"');return}t.style.display="block",t.style.visibility="hidden";const i=new YC;i.listenToPointerEvents(this.context.renderer,this.context.mainCamera),this.gameObject.add(i);const s=new ZC(t);i.add(s),s.visible=!1;const o=s.material;o.transparent=!0,setTimeout(()=>{s.visible=!0;const r=ic(this.gameObject).clone();nc(this.gameObject,0,0,0),this.gameObject.updateMatrixWorld();const l=new xi;l.setFromObject(i),this.setWorldRotation(r.x,r.y,r.z);const c=l.max.x-l.min.x,h=l.max.y-l.min.y;if(this.keepAspect){const u=c/h;c>h?s.scale.set(1/c,1/h/u,1):s.scale.set(1/c*u,1/h,1)}else s.scale.set(1/c,1/h,1);const d=this.gameObject.scale;s.scale.multiply(d)},1)}onDisable(){var t;(t=this._object)==null||t.removeFromParent()}}I1([m()],Wh.prototype,"id",2),I1([m()],Wh.prototype,"keepAspect",2);var ej=Object.defineProperty,tj=Object.getOwnPropertyDescriptor,Qp=(n,t,i,s)=>{for(var o=s>1?void 0:s?tj(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&ej(t,i,o),o},vy;const j1=(vy=class extends A{constructor(){super(...arguments),a(this,"target"),a(this,"invertForward",!1),a(this,"keepUpDirection",!0),a(this,"copyTargetRotation",!1)}onBeforeRender(){let n=this.target;if(n||(n=this.context.mainCamera),!n)return;let t=this.copyTargetRotation;(this.context.isInVR||this.context.isInPassThrough)&&(t=!1),tc(this.gameObject,n,this.keepUpDirection,t),this.invertForward&&this.gameObject.quaternion.multiply(j1.flipYQuat)}createBehaviours(n,t,i){if(t.uuid===this.gameObject.uuid){let s=t;if(this.keepUpDirection){const r=Zt.createEmptyParent(t);s=r;const l=this.invertForward?-1:1;r.setMatrix(r.getMatrix().multiply(new se().makeRotationZ(Math.PI/2*l))),t.setMatrix(t.getMatrix().multiply(new se().makeRotationZ(-Math.PI/2*l)))}const o=new Wt("lookat "+this.name,Tt.sceneStartTrigger(),ve.lookAtCameraAction(s,void 0,this.invertForward?cn.back:cn.forward,this.keepUpDirection?cn.up:cn.zero));n.addBehavior(o)}}},a(vy,"flipYQuat",new V().setFromAxisAngle(new x(0,1,0),Math.PI)),vy);let oa=j1;Qp([m(j)],oa.prototype,"target",2),Qp([m()],oa.prototype,"invertForward",2),Qp([m()],oa.prototype,"keepUpDirection",2),Qp([m()],oa.prototype,"copyTargetRotation",2);var ij=Object.defineProperty,nj=Object.getOwnPropertyDescriptor,by=(n,t,i,s)=>{for(var o=s>1?void 0:s?nj(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&ij(t,i,o),o};class Dl extends A{constructor(){super(...arguments),a(this,"url"),a(this,"mode",0),a(this,"clickable",!0)}async open(){if(!this.url){console.warn("OpenURL: URL is not set, can't open.",this);return}this._validateUrl();let t=this.url;switch(!t.startsWith("mailto:")&&t.includes("@")&&(t="mailto:"+t),F()&&De("Open URL: "+t),this.mode){case 0:Q.isSafari(),globalThis.open(t,"_blank");break;case 1:Q.isSafari()&&Q.isiOS()?globalThis.open(t,"_top"):globalThis.open(t,"_self");break;case 2:Q.isSafari()?globalThis.open(t,"_top"):globalThis.open(t,"_new");break}}start(){this.gameObject.getComponentInParent(Ai)||this.gameObject.addComponent(Ai)}onPointerEnter(t){!t.used&&this.clickable&&this.context.input.setCursor("pointer")}onPointerExit(){this.clickable&&this.context.input.unsetCursor("pointer")}onPointerClick(t){var i;this.clickable&&!t.used&&(i=this.url)!=null&&i.length&&this.open()}_validateUrl(){this.url&&this.url.startsWith("www.")&&(F()&&console.warn("URL is not valid, adding https:// to the start of the URL",this.url),this.url="https://"+this.url)}}by([m()],Dl.prototype,"url",2),by([m()],Dl.prototype,"mode",2),by([m()],Dl.prototype,"clickable",2);var sj=Object.defineProperty,oj=Object.getOwnPropertyDescriptor,Bl=(n,t,i,s)=>{for(var o=s>1?void 0:s?oj(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&sj(t,i,o),o};class Ys extends A{constructor(){super(...arguments),a(this,"side","none"),a(this,"controller",!0),a(this,"hands",!1),a(this,"controlVisibility",!0),a(this,"useGripSpace",!1),a(this,"resetTransformAfterXRSession",!0),a(this,"_startPosition",new x),a(this,"_startRotation",new V),a(this,"_startScale",new x)}get activeAndEnabled(){return!0}onEnterXR(t){this._startPosition.copy(this.gameObject.position),this._startRotation.copy(this.gameObject.quaternion),this._startScale.copy(this.gameObject.scale)}onUpdateXR(t){if(!this.enabled)return;const i=t.xr.getController(this.side);if(i){if(i.hand&&!this.hands){this.controlVisibility&&(this.gameObject.visible=!1);return}else if(!this.controller){this.controlVisibility&&(this.gameObject.visible=!1);return}this.controlVisibility&&(this.gameObject.visible=!0),this.useGripSpace||i.targetRayMode==="transient-pointer"?(this.gameObject.worldPosition=i.gripWorldPosition,this.gameObject.worldQuaternion=i.gripWorldQuaternion,this.gameObject.worldScale=q(i.xr.rigScale,i.xr.rigScale,i.xr.rigScale).multiply(this._startScale)):(this.gameObject.worldPosition=i.rayWorldPosition,this.gameObject.worldQuaternion=i.rayWorldQuaternion,this.gameObject.worldScale=q(i.xr.rigScale,i.xr.rigScale,i.xr.rigScale).multiply(this._startScale))}}onLeaveXR(t){this.resetTransformAfterXRSession&&(this.gameObject.position.copy(this._startPosition),this.gameObject.quaternion.copy(this._startRotation),this.gameObject.scale.copy(this._startScale))}}Bl([m()],Ys.prototype,"side",2),Bl([m()],Ys.prototype,"controller",2),Bl([m()],Ys.prototype,"hands",2),Bl([m()],Ys.prototype,"controlVisibility",2),Bl([m()],Ys.prototype,"useGripSpace",2),Bl([m()],Ys.prototype,"resetTransformAfterXRSession",2);function L1(n,t){const i=n.xr.getFrame();if(!i)return console.warn("No XRFrame available"),!1;const s=i.session.enabledFeatures;if(s&&!s.some(r=>r==="camera-access"))return console.error(`No camera feed available - please request the 'camera-access' feature before starting WebXR or add the ARCameraBackground component to your scene.

Example to request camera-access in global scope:
NeedleXRSession.onSessionRequestStart(evt => {
    evt.init.optionalFeatures = evt.init.optionalFeatures || [];
    evt.init.optionalFeatures.push('camera-access');
});
`),F()&&rc("No camera feed available - please request the 'camera-access' feature before starting WebXR or add the ARCameraBackground component to your scene"),!1;const o=i.getViewerPose(n.xr.getReferenceSpace());if(o)for(const r of o.views)if("camera"in r&&r.camera){let l=n.xr.getBinding();if(l||(l=new XRWebGLBinding(i.session,n.getContext())),l){let c=null;if("getCameraImage"in l){rj(n,t);const h=n.properties.get(t);if(h)return c=l.getCameraImage(r.camera),h.__webglTexture=c,!0;console.warn("No texture properties found for target texture")}}else console.error(r.camera,n.xr)}else console.error("NO CAMERA IN VIEW");else console.error(n.xr.getReferenceSpace(),i);return!1}const D1=new WeakMap;function rj(n,t){const i=D1.get(t)||new WeakSet;if(i.has(n))return;i.add(n),D1.set(t,i),console.debug("Initialize texture for camera feed");const s=new Re,o=new zn,r=new wi;r.add(new X(o,s));const l=new _e;s.map=t,n.render(r,l)}function aj(n,t,i,s="image/webp",o){return _y({context:n,width:t,height:i,mimeType:s,camera:o})}function _y(n){var t,i;n||(n={});const{transparent:s=!1}=n;let{mimeType:o,context:r,width:l,height:c,camera:h}=n;if(!r&&(r=ue.Current,!r))return console.error("Can not save screenshot: No needle-engine context found or provided."),null;if(!h&&(h=r.mainCamera,!h))return console.error("No camera found"),null;const d=r.renderer,u=d.xr.enabled;if(u&&r.currentFrameEvent!=Me.EarlyUpdate)return console.warn("Screenshot: defer to access XR frame"),new Promise(L=>{Ss(D=>{const U=_y(n);L(U)},Me.EarlyUpdate,{once:!0})});const p=d.domElement,g=p.width,y=p.height;l||(l=g),c||(c=y);const f=l,v=c,b=window.devicePixelRatio||1;l/=b,c/=b,d.xr.isPresenting&&d.xr.getFrame();const w=d.xr.enabled;d.xr.enabled=!1,d.xr.isPresenting=!1,p.style.width=`${l}px`,p.style.height=`${c}px`;const _=d.getRenderTarget(),S=d.getClearColor(new ae),R=d.getClearAlpha(),M=r.scene.background,T="aspect"in h?h.aspect:null;try{const L=n.render_events!==!1,D=new Array;L&&(Ia(r.scene,Ze,D),D.forEach(E=>{var z;if(E?.onBeforeRender(),E.isInstancingActive&&E.instances)for(let H=0;H<((z=E.instances)==null?void 0:z.length);H++){const ie=E.instances[H];Os(ie.object,!0)}})),s&&(r.scene.background=null,d.setClearColor(0,0)),n.background&&(r.scene.background=null,d.setClearColor(n.background),n.background instanceof xe&&d.setClearAlpha(n.background.a)),s&&d.setClearAlpha(0),d.setSize(l,c,!1),"cam"in h&&(h=h.threeCamera),h instanceof _e&&(h.aspect=l/c,h.updateProjectionMatrix());const U="type"in n&&n.type==="texture";let B=null;U&&(B=new vs(l,c,{wrapS:Jy,wrapT:Jy,format:1023}),d.setRenderTarget(B));let Y=p;if(u?(B&&console.error('Taking XR screenshots with { type: "texture" } is currently not supported.'),Y=Hh.compositeWithCameraImage({width:f,height:v,scene:r.scene,camera:h,renderer:d})):r.renderNow(h||null),h instanceof _e&&T!=null&&(h.aspect=T,h.updateProjectionMatrix()),L&&D.forEach(E=>E.onAfterRender()),!o&&"download_filename"in n&&n.download_filename)switch((t=n.download_filename.split(".").pop())==null?void 0:t.toLowerCase()){case"png":o="image/png";break;case"jpg":case"jpeg":o="image/jpeg";break;case"webp":o="image/webp";break}if(s&&n.trim===!0){const E=lj(Y);E&&(Y=E)}if("type"in n){if(n.type==="texture")return B?(n.target&&(n.target.image=B?.texture.image,n.target.needsUpdate=!0),B.texture.offset.set(0,-1),B.texture.needsUpdate=!0,B.texture):(console.error("No target texture found"),null);if(n.type==="blob")return new Promise((E,z)=>{Y.toBlob(H=>{E(H)},o)});if(n.type==="share")return new Promise((E,z)=>{Y.toBlob(H=>{if(H&&"share"in navigator){let ie="file_type"in n&&n.file_type||o;o||(ie="image/png");const oe=ie?.split("/")[1]||"png",de=new File([H],"filename"in n?n.filename||`screenshot.${oe}`:`screenshot.${oe}`,{type:ie});return navigator.share({title:"title"in n?n.title:void 0,text:"text"in n?n.text:void 0,url:"url"in n?n.url:void 0,files:[de]}).catch(me=>{console.warn("User cancelled share",me.message)}).finally(()=>{E({blob:H,shared:!0})})}return{blob:H,shared:!1}},o)})}const $=Y.toDataURL(o);if("download_filename"in n&&n.download_filename){let E=n.download_filename;if(Q.isMobileDevice()&&typeof window<"u"){const z=E+"_screenshots",H=E.split("."),ie=(i=H.pop())==null?void 0:i.toLowerCase();let oe=0;localStorage.getItem(z)&&(oe=parseInt(sessionStorage.getItem(z)||"0")),oe>0&&(E=`${H.join()}-${oe}.${ie}`),oe+=1,sessionStorage.setItem(z,oe.toString())}B1($,E)}return $}finally{d.setRenderTarget(_),r.scene.background=M,d.setSize(g,y,!1),d.setClearColor(S,R),T!=null&&h instanceof _e&&(h.aspect=T,h.updateProjectionMatrix()),d.xr.enabled=w,d.xr.isPresenting=u,u||r.updateSize(!0)}return null}function lj(n){if(!("document"in globalThis))return null;const t=document.createElement("canvas");t.width=n.width,t.height=n.height;const i=t.getContext("2d");if(!i)return null;i.drawImage(n,0,0);const s=t.width,o=t.height,r=i.getImageData(0,0,s,o).data;let l=o,c=s,h=0,d=0;for(let f=0;f<o;f++)for(let v=0;v<s;v++){const b=(f*s+v)*4;r[b+3]!==0&&(v<c&&(c=v),v>d&&(d=v),f<l&&(l=f),f>h&&(h=f))}const u=d-c+1,p=h-l+1,g=document.createElement("canvas"),y=g.getContext("2d");return y?(g.width=u,g.height=p,y.drawImage(t,c,l,u,p,0,0,u,p),g):null}let Vh=null;function B1(n,t){if(n){if(!n.startsWith("data:image")){console.error("Can not save image: Data url is not an image",n);return}Vh||(Vh=document.createElement("a")),Vh.href=n,Vh.download=t,Vh.click()}}var Hh;(n=>{let t=null,i=null,s=null,o=null,r=null;function l(d){const{renderer:u,width:p,height:g}=d,y=u.xr.enabled,f=u.getRenderTarget(),v=u.autoClear,b=p,w=g,_=p/g;(!s||s.width!==b||s.height!==w)&&(s??(s=new vs(b,w,{colorSpace:gn})),s.width=b,s.height=w,s.samples=4,s.texture.repeat.y=-1,s.texture.offset.y=1),(!r||r.width!==b||r.height!==w)&&(r=document.createElement("canvas"),r.width=b,r.height=w,r.style.position="fixed",r.style.top="0px",r.style.right="0px",r.style.width="300px",r.style.height=`${300/_}px`,r.style.zIndex="1000",r.style.pointerEvents="none",r.style.opacity="1.0",r.style.willChange="contents"),t||(t=h({defines:{DECODE_VIDEO_TEXTURE:!0}})),i||(i=h()),o||(o=new Le),u.xr.updateCamera(d.camera),u.xr.enabled=!1,u.autoClear=!1,u.clear(),u.setSize(b,w),u.setRenderTarget(s),L1(d.renderer,o)||console.error("Could not update texture from XR frame");const S=O.findObjectOfType($h);return S?S.setTexture(o):(t.setTexture(o),u.render(t,d.camera)),u.clearDepth(),u.setSize(b,w),u.render(d.scene,d.camera),u.setRenderTarget(null),i.setTexture(s.texture),u.render(i,d.camera),r.getContext("2d",{alpha:!1}).drawImage(u.domElement,0,0,r.width,r.height),u.setRenderTarget(f),u.xr.enabled=y,u.autoClear=v,r}n.compositeWithCameraImage=l;const c=`
uniform sampler2D t2D;
varying vec2 vUv;

void main() {

    vec4 texColor = texture2D( t2D, vUv );

    #ifdef DECODE_VIDEO_TEXTURE

        // inline sRGB decode (TODO: Remove this code when https://crbug.com/1256340 is solved)
        texColor = vec4( mix( pow( texColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), texColor.rgb * 0.0773993808, vec3( lessThanEqual( texColor.rgb, vec3( 0.04045 ) ) ) ), texColor.w );

    #endif

    gl_FragColor = texColor;
    #include <tonemapping_fragment>
    #include <colorspace_fragment>
}
`;function h(d){const u=d?.material||new mn({name:"BackgroundMaterial",uniforms:ev.clone(ud.background.uniforms),vertexShader:ud.background.vertexShader,fragmentShader:c,defines:d?.defines,side:ro,depthTest:!1,depthWrite:!1,fog:!1});Object.defineProperty(u,"map",{get:function(){return this.threeTexture}});const p=new X(new zn(2,2),u);return bd(p,!1),p.geometry.deleteAttribute("normal"),p.renderOrder=-1e6,p.setTexture=function(g){u.uniforms.t2D.value=g},p}n.makeFullscreenPlane=h})(Hh||(Hh={}));var cj=Object.defineProperty,hj=Object.getOwnPropertyDescriptor,dj=(n,t,i,s)=>{for(var o=s>1?void 0:s?hj(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&cj(t,i,o),o};const F1=C("debugarcamera");class $h extends A{constructor(){super(...arguments),a(this,"backgroundTint",new xe(1,1,1,1)),a(this,"backgroundPlane"),a(this,"threeTexture"),a(this,"forceTextureInitialization",function(){const t=new Re,i=new zn,s=new wi;s.add(new X(i,t));const o=new _e;return function(r,l){t.map=l,r.render(s,o),F1&&console.warn("Force texture initialization")}}()),a(this,"preRender",()=>{if(!(!this||!this.gameObject)&&this.context.renderer.xr.getFrame()){if(!this.threeTexture&&this.context.renderer&&(this.threeTexture=new Le,this.forceTextureInitialization(this.context.renderer,this.threeTexture)),this.backgroundPlane===void 0){const t=this.backgroundTint;this.backgroundPlane=Hh.makeFullscreenPlane({material:new mn({name:"BackgroundMaterial",uniforms:{...ev.clone(ud.background.uniforms),tint:{value:new fe(t.r,t.g,t.b,t.a)}},vertexShader:ud.background.vertexShader,fragmentShader:uj,side:Ci,depthTest:!1,depthWrite:!1,fog:!1})})}this.backgroundPlane.parent!==this.scene&&this.scene.add(this.backgroundPlane),this.backgroundPlane.material instanceof mn&&this.backgroundPlane.material.uniforms.tint.value.set(this.backgroundTint.r,this.backgroundTint.g,this.backgroundTint.b,this.backgroundTint.a),this.updateFromFrame()}})}onBeforeXR(t,i){t==="immersive-ar"&&(i.optionalFeatures=i.optionalFeatures||[],i.optionalFeatures.push("camera-access"),F1&&console.warn("Requesting camera-access"))}onEnterXR(t){t.xr.mode==="immersive-ar"&&(this.backgroundPlane&&(this.context.scene.add(this.backgroundPlane),this.backgroundPlane.visible=!1),this.backgroundPlane&&this.context.scene.add(this.backgroundPlane),this.context.pre_render_callbacks.push(this.preRender))}onLeaveXR(t){this.backgroundPlane&&this.backgroundPlane.removeFromParent();const i=this.context.pre_render_callbacks.indexOf(this.preRender);i>=0&&this.context.pre_render_callbacks.splice(i,1)}get background(){return this.backgroundPlane}onBeforeRender(t){this.updateFromFrame()}updateFromFrame(){var t;this.threeTexture&&((t=this.context.xr)==null?void 0:t.mode)==="immersive-ar"&&(L1(this.context.renderer,this.threeTexture),this.setTexture(this.threeTexture))}setTexture(t){this.backgroundPlane&&(this.threeTexture=t,this.backgroundPlane.setTexture(this.threeTexture),this.backgroundPlane.visible=!0)}}dj([m(xe)],$h.prototype,"backgroundTint",2);const uj=`
uniform sampler2D t2D;
uniform vec4 tint;

varying vec2 vUv;

void main() {

    vec4 texColor = texture2D( t2D, vUv );
    texColor.w = 1.0;

    // inline sRGB decode
    texColor = vec4( mix( pow( texColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), texColor.rgb * 0.0773993808, vec3( lessThanEqual( texColor.rgb, vec3( 0.04045 ) ) ) ), texColor.w );

    gl_FragColor = texColor * tint;

    #include <tonemapping_fragment>
    #include <colorspace_fragment>
}
`;var pj=Object.defineProperty,mj=Object.getOwnPropertyDescriptor,tr=(n,t,i,s)=>{for(var o=s>1?void 0:s?mj(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&pj(t,i,o),o};const z1=C("debugimagetracking"),wy=class{constructor(n,t,i,s,o,r){a(this,"measuredSize"),a(this,"state"),a(this,"_position"),a(this,"_rotation"),a(this,"_trackingComponent"),a(this,"_trackedImage"),a(this,"_bitmap"),a(this,"_pose"),this._trackingComponent=n,this._trackedImage=t,this._bitmap=i,this.measuredSize=s,this.state=o,this._pose=r}get url(){return this._trackedImage.image??""}get widthInMeters(){return this._trackedImage.widthInMeters??void 0}get bitmap(){return this._bitmap}get model(){return this._trackedImage}getPosition(n){return this.ensureTransformData(),n.copy(this._position),n}getQuaternion(n){return this.ensureTransformData(),n.copy(this._rotation),n}applyToObject(n,t=void 0){this.ensureTransformData();const i=n.position.distanceToSquared(this._position)/.05+n.quaternion.angleTo(this._rotation)/.05;t&&(t*=Math.max(1,i)),t===void 0||t>=1?(n.position.copy(this._position),n.quaternion.copy(this._rotation)):(t=Math.max(0,Math.min(1,t)),n.position.lerp(this._position,t),n.quaternion.slerp(this._rotation,t))}ensureTransformData(){if(!this._position){this._position=wy._positionBuffer.get(),this._rotation=wy._rotationBuffer.get();const n=this._pose.transform,t=J.active.convertSpace(n);this._position.copy(t?.position),this._rotation.copy(t?.quaternion)}}};let Gh=wy;a(Gh,"_positionBuffer",new Oi(()=>new x,20)),a(Gh,"_rotationBuffer",new Oi(()=>new V,20));class Zs{constructor(){a(this,"image"),a(this,"widthInMeters",.25),a(this,"object"),a(this,"createObjectInstance",!1),a(this,"imageDoesNotMove",!1),a(this,"hideWhenTrackingIsLost",!0)}}tr([m(URL)],Zs.prototype,"image",2),tr([m()],Zs.prototype,"widthInMeters",2),tr([m(le)],Zs.prototype,"object",2),tr([m()],Zs.prototype,"createObjectInstance",2),tr([m()],Zs.prototype,"imageDoesNotMove",2),tr([m()],Zs.prototype,"hideWhenTrackingIsLost",2);class gj{constructor(t,i,s){a(this,"filename"),a(this,"widthInMeters"),a(this,"imageData"),this.filename=t,this.imageData=i,this.widthInMeters=s}get extensionName(){return"image-tracking"}onAfterHierarchy(t,i){const s=Q.getiOSVersion(),o=(s?parseInt(s.split(".")[0]):18)>=18?1:100;i.beginBlock('def Preliminary_ReferenceImage "AnchoringReferenceImage"'),i.appendLine("uniform asset image = @image_tracking/"+this.filename+"@"),i.appendLine("uniform double physicalWidth = "+(this.widthInMeters*o).toFixed(8)),i.closeBlock()}onBeforeBuildDocument(t){const i=O.findObjectOfType(ra);!i||!i.trackedImages||i.trackedImages.length>1&&(F()&&we("USDZ: Only one tracked image is supported."),console.warn("USDZ: Only one tracked image is supported."))}onAfterSerialize(t){t.files["image_tracking/"+this.filename]=this.imageData}onExportObject(t,i,s){var o;const r=O.findObjectOfType(ra);if(!(!r||!r.trackedImages)){for(const l of r.trackedImages)if(((o=l.object)==null?void 0:o.asset)===t){const c=O.findObjectOfType($e);if(!c)continue;const{scale:h,target:d}=c.getARScaleAndTarget();let u=t;const p=new se;if(t!==d)for(;u.parent&&u.parent!==d;)u=u.parent,p.premultiply(u.matrix);const g=p.clone().invert();i.setMatrix(g.scale(new x(h,h,h)));break}}}}var xy;const qh=(xy=class extends A{constructor(){super(...arguments),a(this,"trackedImages"),a(this,"smooth",!0),a(this,"trackedImageIndexMap",new Map),a(this,"_supported",!0),a(this,"imageToObjectMap",new Map),a(this,"currentImages",[]),a(this,"webXRIncubationsWarning",`Image tracking is currently not supported on this device. On Chrome for Android, you can enable the <a target="_blank" href="#" onclick="() => console.log('I')">chrome://flags/#webxr-incubations</a> flag.`),a(this,"onImageTrackingUpdate",n=>{const t=J.active;if(t)for(const i of n){const s=i.model,o=i.state==="tracked";if(!s.object)continue;let r=this.imageToObjectMap.get(s);if(r===void 0)r={object:null,frames:0,lastTrackingTime:Date.now()},this.imageToObjectMap.set(s,r),s.object.loadAssetAsync().then(l=>{if(s.createObjectInstance&&l&&(l=O.instantiate(l)),l){r.object=l;for(const c of l.getComponentsInChildren(Ze))c.setInstancingEnabled(!1);t.rig?(t.rig.gameObject.add(l),i.applyToObject(l),l.activeSelf||O.setActive(l,!0)):console.warn("XRImageTracking: missing XRRig")}});else{if(r.frames++,o&&(r.lastTrackingTime=Date.now()),s.imageDoesNotMove&&r.frames>10||!r.object)continue;t.rig&&(t.rig.gameObject.add(r.object),i.applyToObject(r.object,this.smooth?this.context.time.deltaTimeUnscaled*3:void 0),r.object.activeSelf||O.setActive(r.object,!0))}}})}get supported(){return this._supported}awake(){if(z1&&console.log(this),!!this.trackedImages){for(const n of this.trackedImages)if(n.image&&!qh._imageElements.has(n.image)){const t=n.image;qh._imageElements.set(t,null);const i=document.createElement("img");i.src=t,i.addEventListener("load",async()=>{const s=await createImageBitmap(i);qh._imageElements.set(t,s);const o=await Ox(s);if(o){const r=await(await o.convertToBlob({type:"image/png"})).arrayBuffer(),l=O.findObjectOfType($e);l&&this.trackedImages&&(l.extensions.push(new gj("marker.png",new Uint8Array(r),this.trackedImages[0].widthInMeters)),l.anchoringType="image")}})}}}onBeforeXR(n,t){var i;if(this.trackedImages){t.optionalFeatures=t.optionalFeatures||[],t.optionalFeatures.includes("image-tracking")||t.optionalFeatures.push("image-tracking"),t.trackedImages=[];for(const s of this.trackedImages)if((i=s.image)!=null&&i.length&&s.widthInMeters>0){const o=qh._imageElements.get(s.image);o&&(this.trackedImageIndexMap.set(t.trackedImages.length,s),t.trackedImages.push({image:o,widthInMeters:s.widthInMeters}))}}}onEnterXR(n){var t;if(this.trackedImages){for(const i of this.trackedImages)if((t=i.object)!=null&&t.asset){const s=i.object.asset;s.userData||(s.userData={});const o={visible:s.visible,parent:s.parent,matrix:s.matrix.clone()};s.userData["image-tracking"]=o}}for(const i of this.imageToObjectMap.values())i.frames=0}onLeaveXR(n){var t,i;if(!this.supported&&Q.isAndroidDevice()&&we(this.webXRIncubationsWarning),this.trackedImages){for(const s of this.trackedImages)if((t=s.object)!=null&&t.asset){const o=s.object.asset;if(o.userData){const r=o.userData["image-tracking"];r&&(o.visible=r.visible,(i=r.parent)==null||i.add(o),o.matrix.copy(r.matrix),o.matrix.decompose(o.position,o.quaternion,o.scale)),delete o.userData["image-tracking"]}}}}onUpdateXR(n){var t;this.currentImages.length=0;const i=n.xr.frame;if(!i)return;if("getImageTrackingResults"in i){if(((t=n.xr.session.enabledFeatures)==null?void 0:t.includes("image-tracking"))===!1)return;if(i.session&&typeof i.getImageTrackingResults=="function"){const o=i.getImageTrackingResults();if(o.length>0){const r=this.context.renderer.xr.getReferenceSpace();if(r){for(const l of o){const c=l.trackingState,h=l.index,d=this.trackedImageIndexMap.get(h);if(d){const u=i.getPose(l.imageSpace,r),p=new Gh(this,d,l.image,l.measuredSize,c,u);this.currentImages.push(p)}else z1&&console.warn("No tracked image for index",h)}if(this.currentImages.length>0)try{this.dispatchEvent(new CustomEvent("image-tracking",{detail:this.currentImages})),this.onImageTrackingUpdate(this.currentImages)}catch(l){console.error(l)}}}}}else{this.didPrintWarning||(this.didPrintWarning=!0,console.log(this.webXRIncubationsWarning)),this._supported=!1,we(this.webXRIncubationsWarning);return}const s=1e3;for(const[o,r]of this.imageToObjectMap){if(!r.object||!o||o.hideWhenTrackingIsLost===!1)continue;let l=!1;for(const c of this.currentImages)if(c.model===o){const h=Date.now()-r.lastTrackingTime;if(o.imageDoesNotMove||c.state==="tracked"||h<=s){l=!0;break}}l||O.setActive(r.object,!1)}}},a(xy,"_imageElements",new Map),xy);let ra=qh;tr([m(Zs)],ra.prototype,"trackedImages",2),tr([m()],ra.prototype,"smooth",2);var fj=Object.defineProperty,yj=Object.getOwnPropertyDescriptor,Fl=(n,t,i,s)=>{for(var o=s>1?void 0:s?yj(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&fj(t,i,o),o};const aa=C("debugplanetracking");class Ks extends A{constructor(){super(...arguments),a(this,"dataTemplate"),a(this,"occluder",!0),a(this,"initiateRoomCaptureIfNoData",!0),a(this,"usePlaneData",!0),a(this,"useMeshData",!0),a(this,"runInVR",!0),a(this,"bounds",new xi),a(this,"center",new x),a(this,"labelOffset",new x),a(this,"_dataId",1),a(this,"_allPlanes",new Map),a(this,"_allMeshes",new Map),a(this,"firstTimeNoPlanesDetected",-100),a(this,"makeOccluder",(t,i,s=!1)=>{if(i){if(i instanceof Array){for(const o of i)this.makeOccluder(t,o,s);return}!s&&!i.name.toLowerCase().includes("occlu")||(i.colorWrite=!1,i.depthTest=!0,i.depthWrite=!0,i.transparent=!1,i.polygonOffset=!0,i.polygonOffsetFactor=1,i.polygonOffsetUnits=.1,t.renderOrder=-1e3)}}),a(this,"_flipForwardMatrix",new se().makeRotationY(Math.PI)),a(this,"_verticesCache",new Map)}get trackedPlanes(){return this._allPlanes.values()}get trackedMeshes(){return this._allMeshes.values()}onBeforeXR(t,i){t==="immersive-vr"&&!this.runInVR||(i.optionalFeatures=i.optionalFeatures||[],this.usePlaneData&&!i.optionalFeatures.includes("plane-detection")&&i.optionalFeatures.push("plane-detection"),this.useMeshData&&!i.optionalFeatures.includes("mesh-detection")&&i.optionalFeatures.push("mesh-detection"))}onEnterXR(t){for(const i of this._allPlanes.keys())this.removeData(i,this._allPlanes);for(const i of this._allMeshes.keys())this.removeData(i,this._allMeshes)}onLeaveXR(t){for(const i of this._allPlanes.keys())this.removeData(i,this._allPlanes);for(const i of this._allMeshes.keys())this.removeData(i,this._allMeshes)}onUpdateXR(t){if(!this.runInVR&&t.xr.isVR)return;const i=t.xr.rig;if(!i){console.warn("No XR rig found, cannot parent tracked planes to it");return}const s=t.xr.frame;if(!this.context.renderer.xr.getReferenceSpace())return;const o=s.detectedPlanes,r=s.detectedMeshes,l=o!==void 0&&o.size>0,c=r!==void 0&&r.size>0;if(this.initiateRoomCaptureIfNoData&&(!l&&!c&&this.firstTimeNoPlanesDetected<-10&&(this.firstTimeNoPlanesDetected=Date.now()),(l||c)&&(this.firstTimeNoPlanesDetected=-1),this.firstTimeNoPlanesDetected>0&&Date.now()-this.firstTimeNoPlanesDetected>2500&&"initiateRoomCapture"in s.session&&(s.session.initiateRoomCapture(),this.firstTimeNoPlanesDetected=-1)),o!==void 0&&this.processFrameData(t.xr,i.gameObject,s,o,this._allPlanes),r!==void 0&&this.processFrameData(t.xr,i.gameObject,s,r,this._allMeshes),aa){const h=this.context.mainCameraComponent.gameObject.worldPosition;for(const d of this._allPlanes.values())!d.mesh||!d.mesh.visible||(this.bounds.makeEmpty(),d.mesh.traverse(u=>{u instanceof X&&this.bounds.expandByObject(u)}),this.bounds.getCenter(this.center),this.labelOffset.copy(h).sub(this.center).normalize().multiplyScalar(.1),G.DrawLabel(this.center.add(this.labelOffset),(d.xrData.semanticLabel||"plane").toUpperCase()+`
`+d.xrData.lastChangedTime.toFixed(2),.02))}}removeData(t,i){const s=i.get(t);if(!s)return;i.delete(t),aa&&console.log("Plane no longer tracked, id="+s.id),s.mesh&&(s.mesh.removeFromParent(),s.mesh.traverse(r=>{const l=r.userData.normalsHelper;l?(l.dispose(),l.removeFromParent()):aa&&console.warn("No normals helper found for mesh",s.mesh)}),Ti(s.mesh,!0,!0));const o=new CustomEvent("plane-tracking",{detail:{type:"plane-removed",context:s}});this.dispatchEvent(o)}processFrameData(t,i,s,o,r){const l=this.context.renderer.xr.getReferenceSpace();if(l){for(const c of r.keys())o.has(c)||this.removeData(c,r);for(const c of o){const h="planeSpace"in c?c.planeSpace:"meshSpace"in c?c.meshSpace:void 0;if(!h)continue;const d=s.getPose(h,l);let u;if(r.has(c)){const p=r.get(c);if(u=p.mesh,p.timestamp<c.lastChangedTime){if(p.timestamp=c.lastChangedTime,p.mesh){const y=this.createGeometry(c);if(p.mesh instanceof X)p.mesh.geometry.dispose(),p.mesh.geometry=y,this.makeOccluder(p.mesh,p.mesh.material);else if(p.mesh instanceof so)for(const f of p.mesh.children)f instanceof X&&(f.geometry.dispose(),f.geometry=y,this.makeOccluder(f,f.material));if(p.collider){const f=p.mesh;p.collider.sharedMesh=f,p.collider.convex=this.checkIfContextShouldBeConvex(f,p.xrData),p.collider.onDisable(),p.collider.onEnable()}aa&&(console.log("Plane updated, id="+p.id,p),p.mesh.traverse(f=>{if(!(f instanceof X))return;const v=f.userData.normalsHelper;v&&v.update()}))}const g=new CustomEvent("plane-tracking",{detail:{type:"plane-updated",context:p}});this.dispatchEvent(g)}}else{if(!this.dataTemplate){const p=new X;aa?p.material=new kC:this.occluder?(p.material=new Re,this.makeOccluder(p,p.material,!0)):p.material=new Re({wireframe:!0,opacity:.5,transparent:!0,color:3355443}),this.dataTemplate=new le("","",p)}if(!this.dataTemplate.asset)this.dataTemplate.loadAssetAsync();else{const p=O.instantiate(this.dataTemplate.asset);if(p.name="xr-tracked-plane",u=p,Hm(p,!1),p instanceof X)Ee(p.geometry),p.geometry=this.createGeometry(c),this.makeOccluder(p,p.material,this.occluder&&!this.dataTemplate);else if(p instanceof so)for(const f of p.children)f instanceof X&&(Ee(f.geometry),f.geometry=this.createGeometry(c),this.makeOccluder(f,f.material,this.occluder&&!this.dataTemplate));const g=p.getComponent(Ro);if(g){const f=p;g.sharedMesh=f,g.convex=this.checkIfContextShouldBeConvex(f,c),g.onDisable(),g.onEnable()}p.matrixAutoUpdate=!1,p.matrixWorldNeedsUpdate=!0,i.add(p);const y={id:this._dataId++,xrData:c,timestamp:c.lastChangedTime,mesh:p,collider:g};r.set(c,y),aa&&console.log("New plane detected, id="+y.id,y,{hasCollider:!!g,isGroup:p instanceof so});try{const f=new CustomEvent("plane-tracking",{detail:{type:"plane-added",context:y}});this.dispatchEvent(f)}catch(f){console.error(f)}}}u&&(d?(u.visible=!0,u.matrix.fromArray(d.transform.matrix),u.matrix.premultiply(this._flipForwardMatrix)):u.visible=!1,aa&&u.traverse(p=>{if(p instanceof X)if(p.userData.normalsHelper)p.userData.normalsHelper.update();else{const g=new KC(p,.05,255);g.layers.disableAll(),g.layers.set(2),this.context.scene.add(g),p.userData.normalsHelper=g}}))}}}checkIfContextShouldBeConvex(t,i){if(!t)return!0;if(t){const s=new xi;s.expandByObject(t);const o=new x;s.getSize(o);let r=!0;return o.x>2&&o.y>2&&o.z>1.5&&(r=!1),r&&"semanticLabel"in i&&i.semanticLabel==="wall"&&(r=!0),r}return!0}createGeometry(t){return"polygon"in t?this.createPlaneGeometry(t.polygon):"vertices"in t&&"indices"in t?this.createMeshGeometry(t.vertices,t.indices):new gs}createMeshGeometry(t,i){const s=t.toString()+"_"+i.toString();if(this._verticesCache.has(s))return this._verticesCache.get(s);const o=new gs;o.setIndex(new yt(i,1)),o.setAttribute("position",new yt(t,3));const r=Array();for(let l=0;l<t.length;l+=3)r.push(t[l],t[l+2]);return o.setAttribute("uv",new yt(t,3)),o.computeVertexNormals(),this._verticesCache.set(s,o),o}createPlaneGeometry(t){const i=new gs,s=[],o=[];t.forEach(g=>{s.push(g.x,g.y,g.z),o.push(g.x,g.z)});const r=new x(s[0],s[1],s[2]),l=new x(s[3],s[4],s[5]),c=new x(s[6],s[7],s[8]),h=new x,d=new x;h.subVectors(l,r),d.subVectors(c,r),h.cross(d),h.normalize();const u=[];for(let g=0;g<s.length/3;g++)u.push(h.x,h.y,h.z);const p=[];for(let g=2;g<t.length;++g)p.push(0,g-1,g);return i.setAttribute("position",new yt(new Float32Array(s),3)),i.setAttribute("uv",new yt(new Float32Array(o),2)),i.setAttribute("normal",new yt(new Float32Array(u),3)),i.setIndex(p),i.computeBoundingBox(),i.computeBoundingSphere(),i}}Fl([m(le)],Ks.prototype,"dataTemplate",2),Fl([m()],Ks.prototype,"occluder",2),Fl([m()],Ks.prototype,"initiateRoomCaptureIfNoData",2),Fl([m()],Ks.prototype,"usePlaneData",2),Fl([m()],Ks.prototype,"useMeshData",2),Fl([m()],Ks.prototype,"runInVR",2);var vj=Object.defineProperty,bj=Object.getOwnPropertyDescriptor,_j=(n,t,i,s)=>{for(var o=s>1?void 0:s?bj(t,i):t,r=n.length-1,l;r>=0;r--)(l=n[r])&&(o=(s?l(t,i,o):l(o))||o);return s&&o&&vj(t,i,o),o};const U1=C("debugwebxr");class Yp extends A{constructor(){super(...arguments),a(this,"priority",0),a(this,"_startScale")}get isActive(){return this.activeAndEnabled&&this.gameObject.visible}setAsActiveXRRig(){var t;(t=J.active)==null||t.setRigActive(this)}setPriority(t){this.priority=t}awake(){if(U1){const t=new j;t.position.y+=.5,this.gameObject.add(t);const i=t.addNewComponent(Gr);i&&(i.isGizmo=!1);const s=new Si(.5);this.gameObject.add(s)}}isXRRig(){return!0}supportsXR(t){return!0}onEnterXR(t){this._startScale=this.gameObject.scale.clone(),t.xr.addRig(this),U1&&console.log("WebXR: add Rig",this.name,this.priority)}onLeaveXR(t){t.xr.removeRig(this),this._startScale&&this.gameObject&&this.gameObject.scale.copy(this._startScale)}}_j([m()],Yp.prototype,"priority",2);class wj extends A{constructor(){super(...arguments),a(this,"toggleKey","KeyP")}update(){this.context.input.isKeyDown(this.toggleKey)&&this.context.domElement.classList.toggle("presentation-mode")}}k.add("AlignmentConstraint",Lc),k.add("Animation",Ut),k.add("Animator",kt),k.add("AudioListener",Ts),k.add("AudioSource",Ne),k.add("Avatar_Brain_LookAt",Hc),k.add("Avatar_MouthShapes",qc),k.add("Avatar_MustacheShake",_f),k.add("AvatarBlink_Simple",Er),k.add("AvatarEyeLook_Rotation",qa),k.add("AxesHelper",Xa),k.add("BasicIKConstraint",Cf),k.add("BoxHelperComponent",Ki),k.add("Camera",Oe),k.add("CharacterController",Ar),k.add("CharacterControllerInput",Ls),k.add("Collider",di),k.add("SphereCollider",Qa),k.add("BoxCollider",Ya),k.add("MeshCollider",Ro),k.add("CapsuleCollider",Is),k.add("ContactShadows",kn),k.add("LogStats",kf),k.add("DeleteBox",Kc),k.add("Deletable",Rf),k.add("DeviceFlag",Lu),k.add("DragControls",ui),k.add("DropListener",Ds),k.add("Duplicatable",Ja),k.add("EventListEvent",Cu),k.add("EventTrigger",Bu),k.add("GltfExportBox",$f),k.add("GltfExport",ih),k.add("VariantAction",i0),k.add("ChangeTransformOnClick",Br),k.add("ChangeMaterialOnClick",pl),k.add("SetActiveOnClick",Fr),k.add("HideOnStart",gl),k.add("EmphasizeOnClick",fl),k.add("PlayAudioOnClick",Io),k.add("PlayAnimationOnClick",zr),k.add("PreliminaryAction",yl),k.add("PreliminaryTrigger",oh),k.add("VisibilityAction",rh),k.add("TapGestureTrigger",s0),k.add("USDZExporter",$e),k.add("Fog",Sl),k.add("BoxGizmo",Gr),k.add("GridHelper",Cl),k.add("GroundProjectedEnv",$n),k.add("UsageMarker",Zc),k.add("Interactable",Mf),k.add("FixedJoint",j0),k.add("HingeJoint",vh),k.add("Light",gi),k.add("LODGroup",_h),k.add("LookAtConstraint",Rr),k.add("NeedleMenu",ss),k.add("NestedGltf",fp),k.add("Networking",Pl),k.add("OffsetConstraint",qr),k.add("CameraTargetReachedEvent",Wc),k.add("OrbitControls",be),k.add("ParticleSystemRenderer",nn),k.add("ParticleSystem",ct),k.add("PlayerColor",Vl),k.add("Antialiasing",Oh),k.add("BloomEffect",Kr),k.add("ChromaticAberration",Ph),k.add("ColorAdjustments",Go),k.add("DepthOfField",In),k.add("EffectWrapper",kh),k.add("PixelationEffect",Mh),k.add("ScreenSpaceAmbientOcclusion",Gs),k.add("ScreenSpaceAmbientOcclusionN8",jn),k.add("SharpeningEffect",Th),k.add("TiltShiftEffect",ls),k.add("ToneMappingEffect",$o),k.add("Vignette",ta),k.add("Volume",Al),k.add("ReflectionProbe",nl),k.add("Renderer",Ze),k.add("MeshRenderer",th),k.add("SkinnedMeshRenderer",Hf),k.add("Rigidbody",ye),k.add("SceneSwitcher",ot),k.add("ScreenCapture",Qo),k.add("ShadowCatcher",Ah),k.add("RemoteSkybox",cs),k.add("SmoothFollow",Yo),k.add("SpatialTriggerReceiver",hs),k.add("SpatialTrigger",Dh),k.add("SpectatorCamera",Fp),k.add("SpriteRenderer",mi),k.add("SyncedCamera",Up),k.add("SyncedRoom",Ln),k.add("SyncedTransform",qn),k.add("TestRunner",dy),k.add("TestSimulateUserData",uy),k.add("PlayableDirector",Ko),k.add("SignalReceiver",Il),k.add("AnimationTrackHandler",Vp),k.add("AudioTrackHandler",Uh),k.add("SignalTrackHandler",Nh),k.add("ControlTrackHandler",Hp),k.add("TransformGizmo",ia),k.add("BaseUIComponent",rn),k.add("UIRootComponent",Nc),k.add("Button",Qs),k.add("Canvas",At),k.add("CanvasGroup",Uo),k.add("EventSystem",si),k.add("Graphic",Nr),k.add("MaskableGraphic",fh),k.add("Image",jl),k.add("RawImage",qp),k.add("InputField",sa),k.add("VerticalLayoutGroup",x0),k.add("HorizontalLayoutGroup",S0),k.add("GridLayoutGroup",C0),k.add("Outline",xl),k.add("ObjectRaycaster",Ai),k.add("GraphicRaycaster",ku),k.add("SpatialGrabRaycaster",Ha),k.add("RectTransform",Vt),k.add("SpatialHtml",Wh),k.add("Text",Ht),k.add("LookAt",oa),k.add("OpenURL",Dl),k.add("VideoPlayer",ft),k.add("Voip",Mo),k.add("Avatar",Do),k.add("XRControllerFollow",Ys),k.add("XRControllerModel",os),k.add("XRControllerMovement",Li),k.add("TeleportTarget",cp),k.add("WebARCameraBackground",$h),k.add("WebARSessionRoot",ns),k.add("WebXR",Je),k.add("AvatarMarker",Rt),k.add("WebXRImageTracking",ra),k.add("WebXRPlaneTracking",Ks),k.add("XRRig",Yp),k.add("XRFlag",Ii),k.add("PlayerSync",bl),k.add("PlayerState",ji),k.add("PresentationMode",wj);const Xh=bt,xj=C("debugtypestore");xj&&console.log(k);function Sj(n,t){const i=g_(n,t);return i!==void 0?i:null}const Cj=new L2,Sy=Symbol("deserialize-queue");async function Oj(n,t,i,s=null,o){if(!i){console.debug("Can not create component instances: gltf is null");return}let r=s;typeof r=="number"&&(r=new Dt(s));const l=t.indexOf("?");t=l===-1?t:t.substring(0,l);const c=new Bg(i.scene);c.gltfId=t,c.context=n,c.gltf=i,c.nodeToObject=o?.nodeToObjectMap,c.implementationInformation=Cj;let h=n[Sy];if(h||(h=n[Sy]=[]),i.scenes)for(const d of i.scenes)await Py(c,d,h);if(i.children)for(const d of i.children)await Py(c,d,h);n.new_scripts_pre_setup_callbacks.push(()=>{const d=n[Sy];if(d){for(const u of d)Pj(u,c);d.length=0}if(r){const u={},p=[];Oy(i,r,u,p);for(const g of i.scenes)Oy(g,r,u,p);for(const g of p)g.resolveGuids(u)}})}const Cy=Symbol("original-component-name"),zl=new Map;function Oy(n,t,i,s){if(t===null||!n)return;const o=n.guid,r=n.guid;r!=null&&r.length&&(zl.has(r)||(Xh&&console.log('Creating InstanceIdProvider with key "'+r+'" for object '+n.name),zl.set(r,new Dt(r))));const l=r&&zl.get(r)||t;if(n.guid=l.generateUUID(),o&&o!=="invalid"&&(i[o]=n.guid),n&&n.userData&&n.userData.components)for(const c of n.userData.components){if(c===null)continue;const h=c.guid;h?zl.has(h)||(Xh&&console.log('Creating InstanceIdProvider with key "'+h+'" for component '+c[Cy]),zl.set(h,new Dt(h))):Xh&&console.warn("Can not create IdProvider: component "+c[Cy]+" has no guid",c.guid);const d=zl.get(h)||t,u=c.guid;c.guid=d.generateUUID(),u&&u!=="invalid"&&(i[u]=c.guid),c.resolveGuids&&s.push(c)}if(n.children)for(const c of n.children)Oy(c,t,i,s)}const Qh=[];async function Py(n,t,i,s){var o,r,l,c,h;if(!t)return;const d=t.userData;if(d){const u=d.builtin_components;if(u&&u.length>0)for(const p of u)try{if(p===null)continue;const g=k.get(p.name);if(g!=null){const y=new g;y.sourceId=n.gltfId,Aa(y,p,n.implementationInformation),y.context=n.context,"guid"in p&&(y[hc]=p.guid),y[Cy]=p.name,yr(t,y,!1),i.push({instance:y,compData:p,obj:t}),y.isCamera&&n.context&&n.context.mainCamera===null&&y.tag==="MainCamera"&&n.context.setCurrentCamera(y),((l=(r=(o=n.context)==null?void 0:o.physics)==null?void 0:r.engine)==null?void 0:l.isInitialized)===!1&&(y.isCollider||y.isRigidbody)&&((h=(c=n.context)==null?void 0:c.physics.engine)==null||h.initialize())}else Xh&&console.debug("unknown component: "+p.name),Qh.includes(p.name)||Qh.push(p.name)}catch(g){console.error(p.name+" - "+g.message,g)}if(Qh.length>0){const p=Qh.join(", ");console.warn("unknown components: "+p),Qh.length=0,Xt()&&De(`<strong>Unknown components in scene</strong>:

${p}

This could mean you forgot to add a npmdef to your ExportInfo
<a href="https://engine.needle.tools/docs/project_structure.html#creating-and-installing-a-npmdef" target="_blank">documentation</a>`,Pi.Warn)}}if(t.children)for(const u of t.children)await Py(n,u,i)}function Pj(n,t){const{instance:i,compData:s,obj:o}=n;t.object=o,t.target=i,Hd(i,s,t),Xh&&console.debug("add "+s.name,s,i)}const Zp=C("debugfileformat");async function N1(n,t=!0){var i;if(t){const o=n,r=new URL(o,globalThis.location.origin);let l=null;const c=r.searchParams.get("filetype");switch(c&&(l=c.toUpperCase()),l!=null&&l.length||(l=(i=r.pathname.split(".").pop())==null?void 0:i.toUpperCase()),Zp&&console.debug("Use file extension to determine type: "+l),l){case"GLTF":return"gltf";case"VRM":return"vrm";case"GLB":return"glb";case"FBX":return"fbx";case"USD":return"usd";case"USDA":return"usda";case"USDZ":return"usdz";case"OBJ":return"obj"}}if(!n.startsWith("blob:")){const o=new URL(n);o.searchParams.append("range","true"),n=o.toString()}const s=await fetch(n,{method:"GET",headers:{range:"bytes=0-32"}}).catch(o=>null);if(s!=null&&s.ok){const o=await s.arrayBuffer(),r=W1(o,s);return Zp&&console.log("Determined file type from header: "+r),r}return"unknown"}function W1(n,t){if(n.byteLength<4)return"unknown";const i=new Uint8Array(n);if(Zp&&console.warn(`Trying to determine file type from binary data
`,'"'+new TextDecoder().decode(n)+`"
`,i),i[0]==103&&i[1]==108&&i[2]==84&&i[3]==70)return console.debug("GLTF detected"),"glb";if(i[0]==80&&i[1]==75&&i[2]==3&&i[3]==4)return console.debug("USDZ detected"),"usdz";if(i[0]==80&&i[1]==88&&i[2]==82&&i[3]==45&&i[4]==85&&i[5]==83&&i[6]==68&&i[7]==67)return console.debug("Binary USD detected"),"usd";if(i[0]==35&&i[1]==117&&i[2]==115&&i[3]==100&&i[4]==97)return console.debug("ASCII USD detected"),"usda";if(i[0]==75&&i[1]==97&&i[2]==121&&i[3]==100&&i[4]==97&&i[5]==114&&i[6]==97&&i[7]==32)return console.debug("Binary FBX detected"),"fbx";if(i[0]==59&&i[1]==32&&i[2]==70&&i[3]==66&&i[4]==88&&i[5]==32)return console.debug("ASCII FBX detected"),"fbx";if(i[0]==35&&i[1]==32&&i[2]==66&&i[3]==108&&i[4]==101&&i[5]==110&&i[6]==100&&i[7]==101&&i[8]==114&&i[9]==32||i[0]==35&&i[1]==32&&i[2]==65&&i[3]==108&&i[4]==105&&i[5]==97&&i[6]==115&&i[7]==32&&i[8]==79&&i[9]==66&&i[10]==74)return console.debug("OBJ detected"),"obj";if(t.headers.has("content-type")){const s=t.headers.get("content-type");switch(console.debug("Content-Type: "+s),s){case"model/gltf+json":return"gltf";case"model/gltf-binary":return"glb";case"model/vrm":return"vrm";case"model/vnd.usdz+zip":return"usdz";case"model/vnd.usd+zip":return"usd";case"model/vnd.usda+zip":return"usda";case"model/fbx":case"model/vnd.autodesk.fbx":return"fbx";case"model/obj":return"obj"}}if(i[0]==118&&i[1]==32||i[0]==102&&i[1]==32)return console.debug("OBJ detected (the file has no header and starts with vertex or face)"),"obj";if(i[0]==35&&i[1]==32&&i[2]==70&&i[3]==105&&i[4]==108&&i[5]==101&&i[6]==32&&i[7]==101&&i[8]==120&&i[9]==112&&i[10]==111&&i[11]==114&&i[12]==116&&i[13]==101&&i[14]==100&&i[15]==32&&i[16]==98&&i[17]==121&&i[18]==32&&i[19]==90&&i[20]==66&&i[21]==114&&i[22]==117&&i[23]==115&&i[24]==104)return console.debug("OBJ detected (exported by ZBrush)"),"obj";if(i[0]==109&&i[1]==116&&i[2]==108&&i[3]==108&&i[4]==105&&i[5]==98)return console.debug("OBJ detected (mtllib)"),"obj";if(F()||Zp){const s=new TextDecoder().decode(n.slice(0,16));console.debug('Could not determine file type from binary data: "'+s+'..."',i)}else console.debug("Could not determine file type from binary data",i);return"unknown"}class ky{createBuiltinComponents(t,i,s,o,r){return Oj(t,i,s,o,r)}writeBuiltinComponentData(t,i){return Sj(t,i)}parseSync(t,i,s,o){return q1(t,i,s,o)}loadSync(t,i,s,o,r){return X1(t,i,s,o,r)}}wm(ky);const V1=C("printGltf")||C("printgltf"),H1=C("downloadgltf"),kj=C("debugfileformat");var $1=(n=>(n[n.BeforeLoad=0]="BeforeLoad",n[n.AfterLoaded=1]="AfterLoaded",n[n.FinishedSetup=10]="FinishedSetup",n))($1||{});class la{constructor(t,i,s,o){a(this,"context"),a(this,"loader"),a(this,"path"),a(this,"gltf"),this.context=t,this.path=i,this.loader=s,this.gltf=o}}const ir={};function Mj(n,t){ir[n]=ir[n]||[],ir[n].push(t)}function Rj(n,t){if(ir[n]){const i=ir[n].indexOf(t);i>=0&&ir[n].splice(i,1)}}function Ul(n,t){if(ir[n])for(const i of ir[n])i(t)}async function G1(n,t,i,s,o){V1&&console.warn("glTF",t,i),t.includes("?")&&(t=t.split("?")[0]),await fn().createBuiltinComponents(n,t,i,s,o)}async function My(n,t){const i=await N1(n)||"unknown";switch(kj&&console.debug("Determined file type: "+i+" for url",n),i){case"unknown":{console.warn("Unknown file type. Assuming glTF:",n);const s=new ar;return await Wu(s,t,n),s}case"fbx":return new rv;case"obj":return new ym;case"usd":case"usda":case"usdz":return console.warn(i.toUpperCase()+" files are not supported."),null;default:console.warn("Unknown file type:",i);case"gltf":case"glb":case"vrm":{const s=new ar;return await Wu(s,t,n),s}}}async function q1(n,t,i,s){typeof i!="string"&&(console.warn("Parse gltf binary without path, this might lead to errors in resolving extensions. Please provide the source path of the gltf/glb file",i,typeof i),i=""),V1&&console.log("Parse glTF",i);const o=await My(i,n);if(!o)return;if(o instanceof ym){typeof t!="string"&&(t=new TextDecoder().decode(t));const l=o.parse(t);return{animations:l.animations,scene:l,scenes:[l]}}if(!(o instanceof ar)){const l=o.parse(t,i);return Z1(o,l),{animations:l.animations,scene:l,scenes:[l]}}const r=Nu(o);return new Promise((l,c)=>{try{let h=i.split("?")[0].trimEnd();{const u=h.split("/");u.length>0&&u[u.length-1]!==""&&u.pop(),h=u.join("/"),h.endsWith("/")||(h+="/")}o.resourcePath=h,gu(o,n),Ul(0,new la(n,i,o));const d=n.mainCamera;o.parse(t,"",async u=>{Wf(i,u,n),Ul(1,new la(n,i,o,u)),await G1(n,i,u,s,r),await Q1(u.scene,n,d),Ul(10,new la(n,i,o,u)),l(u),H1&&Y1(t)},u=>{console.error('Loading asset at "'+i+`" failed
`,u),l(void 0)})}catch(h){console.error(h),c(h)}})}async function X1(n,t,i,s,o){Tj(t);const r=await My(t,n);if(!r)return;if(!(r instanceof ar)){const c=await r.loadAsync(t,o);return Z1(r,c),{animations:c.animations,scene:c,scenes:[c]}}const l=Nu(r);return new Promise((c,h)=>{try{gu(r,n),Ul(0,new la(n,t,r));const d=n.mainCamera;r.load(t,async u=>{Wf(t,u,n),Ul(1,new la(n,t,r,u)),await G1(n,i,u,s,l),await Q1(u.scene,n,d),Ul(10,new la(n,t,r,u)),c(u),H1&&Y1(t)},u=>{o?.call(r,u)},u=>{console.error('Loading asset at "'+t+`" failed
`,u),c(void 0)})}catch(d){console.error(d),h(d)}})}async function Q1(n,t,i){i||(i=t.mainCamera);try{i?await t.renderer.compileAsync(n,i,t.scene).catch(s=>{console.warn(s.message)}):_2(n,t)}catch(s){console.warn(s?.message||s)}}function Tj(n){if(new URL(n,window.location.href).href.startsWith("file://")){const t=`Hi - it looks like you are trying to load a local file which will not work. You need to use a webserver to serve your files.
Please refer to the documentation on <a href="https://fwd.needle.tools/needle-engine/docs/local-server">https://docs.needle.tools</a> or ask for help in our <a href="https://discord.needle.tools">discord community</a>`;De(t),console.warn(t)}}function Y1(n){if(typeof n=="string"){const t=document.createElement("a");t.href=n,t.download=n.split("/").pop(),t.click()}else{const t=new Blob([n],{type:"application/octet-stream"}),i=window.URL.createObjectURL(t),s=document.createElement("a");s.href=i,s.download="download.glb",s.click()}}function Z1(n,t){if(t!=null&&t.isObject3D){const i=t;(n instanceof rv||n instanceof ym)&&i.traverse(s=>{const o=s;o!=null&&o.isMesh&&$m(o,o.material)})}}wm(ky);const Ue=C("debugwebcomponent"),K1="needle-engine",J1="vr",eS="desktop",Ej=[hw,J1,eS],Yh="ar-session-active",Zh="desktop-session-active",Aj=["public-key","version","hash","src","camera-controls","loadstart","progress","loadfinished","dracoDecoderPath","dracoDecoderType","ktx2DecoderPath","tone-mapping","tone-mapping-exposure","background-blurriness","background-color"];class Ry extends HTMLElement{constructor(){super(),a(this,"_context"),a(this,"_overlay_ar"),a(this,"_loadingProgress01",0),a(this,"_loadingView"),a(this,"_previousSrc",null),a(this,"_didFullyLoad",!1),a(this,"_loadId",0),a(this,"_abortController",null),a(this,"_lastSourceFiles",null),a(this,"_createContextPromise",null),a(this,"onXRSessionStarted",()=>{var i;const s=this.context.xrSessionMode;s==="immersive-ar"?this.onEnterAR(this.context.xrSession):s==="immersive-vr"&&this.onEnterVR(this.context.xrSession),(i=this.context.xrSession)==null||i.addEventListener("end",()=>{this.dispatchEvent(new CustomEvent("xr-session-ended",{detail:{session:this.context.xrSession,context:this._context,sessionMode:s}})),s==="immersive-ar"?this.onExitAR(this.context.xrSession):s==="immersive-vr"&&this.onExitVR(this.context.xrSession)})}),a(this,"onReady",()=>{var i;return(i=this._loadingView)==null?void 0:i.onLoadingFinished()}),a(this,"onError",()=>{var i;return(i=this._loadingView)==null?void 0:i.setMessage("Loading failed!")}),a(this,"_previouslyRegisteredMap",new Map),this._overlay_ar=new Rk,this.addEventListener("ready",this.onReady),ew(),this.attachShadow({mode:"open"});const t=document.createElement("template");t.innerHTML=`<style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Flex:opsz,wght@8..144,100..1000&display=swap');

    :host {
        position: absolute;
        display: block;
        width: max(600px, 100%);
        height: max(300px, 100%);
        touch-action: none;

        -webkit-tap-highlight-color: transparent;
    }

    @media (max-width: 600px) {
        :host {
            width: 100%;
        }
    }
    @media (max-height: 300px) {
        :host {
            height: 100%;
        }
    }

    :host > div.canvas-wrapper {
        width: 100%;
        height: 100%;
    }

    :host canvas {   
        position: absolute;
        user-select: none;
        -webkit-user-select: none;

        /** allow touch panning but no pinch zoom **/
        /** but this doesnt work yet: 
         * touch-action: pan-x, pan-y;
         **/
        
        -webkit-touch-callout: none;
        -webkit-user-drag: none;
        -webkit-user-modify: none;
    }
    :host .content {
        position: absolute;
        top: 0;
        width: 100%;
        height: 100%;
        visibility: visible;
        z-index: 500; /* < must be less than the webxr buttons element */
        pointer-events: none;
    }
    :host .overlay-content {
        position: absolute;
        user-select: auto;
        pointer-events: all;
    }
    :host slot[name="quit-ar"]:hover {
        cursor: pointer;
    }
    :host .quit-ar-button {
        position: absolute;
        // top: env(titlebar-area-y); /** this doesnt work **/
        top: 60px; /** camera access needs a bit more space **/
        right: 20px;
        z-index: 9999;
    }
</style>
<div class="canvas-wrapper"> <!-- this wrapper is necessary for WebXR https://github.com/meta-quest/immersive-web-emulator/issues/55 -->
    <canvas></canvas>
</div>
<div class="content">
    <slot class="overlay-content"></slot>
</div>
`,this.shadowRoot&&this.shadowRoot.appendChild(t.content.cloneNode(!0)),this._context=new ee({domElement:this}),this.addEventListener("error",this.onError)}static get observedAttributes(){return Aj}get loadingProgress01(){return this._loadingProgress01}get loadingFinished(){return this.loadingProgress01>.999}get cameraControls(){const t=this.getAttribute("camera-controls");return t==null?null:!(t===null||t==="False"||t==="false"||t==="0"||t==="none")}getContext(){return new Promise((t,i)=>{if(this._context&&this.loadingFinished)t(this._context);else{const s=()=>{this.removeEventListener("loadfinished",s),this._context&&this.loadingFinished&&t(this._context)};this.addEventListener("loadfinished",s)}})}get context(){return this._context}async connectedCallback(){if(Ue&&console.log("<needle-engine> connected"),this.setPublicKey(),this.setVersion(),this.addEventListener("xr-session-started",this.onXRSessionStarted),this.onSetupDesktop(),!this.getAttribute("src")){const i=globalThis["needle:codegen_files"];Ue&&console.log('src is null, trying to load from globalThis["needle:codegen_files"]',i),i&&(Ue&&console.log('globalThis["needle:codegen_files"]',i),this.setAttribute("src",i))}Ue&&console.log("src",this.getAttribute("src"));const t=this._loadId;setTimeout(()=>{this.isConnected!==!1&&t===this._loadId&&this.onLoad()},1)}disconnectedCallback(){var t;this.removeEventListener("xr-session-started",this.onXRSessionStarted),this._didFullyLoad=!1;const i=this.getAttribute("keep-alive"),s=i==null||i?.length>0&&i!=="true"&&i!=="1";Ue&&console.warn('<needle-engine> disconnected, keep-alive: "'+i+'"',typeof i,"Dispose=",s),s?(Ue&&console.warn("<needle-engine> dispose"),(t=this._context)==null||t.dispose(),this._context=null,this._lastSourceFiles=null,this._loadId+=1):Ue&&console.warn("<needle-engine> is not disposed because keep-alive is set")}attributeChangedCallback(t,i,s){switch(Ue&&console.log("attributeChangedCallback",t,i,s),t){case"src":Ue&&console.warn(`<needle-engine src>
changed from "`,i,'" to "',s,'"'),this.onLoad();break;case"hash":this._context&&(this._context.hash=s);break;case"loadstart":case"progress":case"loadfinished":typeof s=="string"&&s.length>0&&(Ue&&console.log(t+" attribute changed",s),this.registerEventFromAttribute(t,s));break;case"dracoDecoderPath":Ue&&console.log("dracoDecoderPath",s),uw(s);break;case"dracoDecoderType":s==="wasm"||s==="js"?(Ue&&console.log("dracoDecoderType",s),pw(s)):console.error("Invalid dracoDecoderType",s,"expected js or wasm");break;case"ktx2DecoderPath":Ue&&console.log("ktx2DecoderPath",s),mw(s);break;case"tone-mapping":{this.applyAttributes();break}case"tone-mapping-exposure":{this.applyAttributes();break}case"background-blurriness":{const o=parseFloat(s);o!=null&&this._context&&(this._context.scene.backgroundBlurriness=o);break}case"background-color":{this.applyAttributes();break}case"public-key":{s!=cc&&this.setPublicKey();break}case"version":{s!=_n&&this.setVersion();break}}}async onLoad(){var t,i;if(!this.isConnected)return;if(this._context||(Ue&&console.warn("Create new context"),this._context=new ee({domElement:this})),!this._context){console.error("Needle Engine: Context not initialized");return}const s=this.getSourceFiles();if(!this.checkIfSourceHasChanged(s,this._lastSourceFiles))return;this._abortController&&(Ue&&console.warn("Abort previous loading process"),this._abortController.abort(),this._abortController=null),this._lastSourceFiles=s;const o=++this._loadId;if((s==null||s.length<=0)&&(Ue&&console.warn("Clear scene",s),this._context.clear(),o!==this._loadId))return;const r=this.getAttribute("alias");this.classList.add("loading");const l=On();this.ensureLoadStartIsRegistered();let c=this.dispatchEvent(new CustomEvent("loadstart",{detail:{context:this._context,alias:r},cancelable:!0}));if(l){const b=this.getAttribute("hide-loading-overlay");b!=null&&b!=="0"&&(c=!1)}c===!1&&!l&&(F()||(c=!0),console.warn("Needle Engine: You need a commercial license to override the default loading view. Visit https://needle.tools/pricing"),F()&&we('You need a <a target="_blank" href="https://needle.tools/pricing">commercial license</a> to override the default loading view. This will not work in production.')),!this._loadingView&&c&&(this._loadingView=new rf(this)),c&&(this._didFullyLoad!==!0?(t=this._loadingView)==null||t.onLoadingBegin("begin load"):setTimeout(()=>{this._loadingView&&this._loadingProgress01<.3&&this._loadId===o&&this._loadingView.onLoadingBegin("begin load")},300)),Ue&&console.warn(`--------------
Needle Engine: Begin loading `+o+`
`,s),this.onBeforeBeginLoading();const h=[],d={context:this._context,name:"",progress:{},index:0,count:s.length,totalProgress01:this._loadingProgress01},u=new CustomEvent("progress",{detail:d}),p=new Array,g=new AbortController;this._abortController=g;const y={files:s,abortSignal:g.signal,onLoadingProgress:b=>{var w;if(Ue&&console.debug("Loading progress: ",b),g.signal.aborted)return;const _=b.index;!p[_]&&b.name&&(p[_]=Ij(b.name)),b.name=p[_],c&&((w=this._loadingView)==null||w.onLoadingUpdate(b)),d.name=b.name,d.progress=b.progress,this._loadingProgress01=sf(b),d.totalProgress01=this._loadingProgress01,this.dispatchEvent(u)},onLoadingFinished:(b,w,_)=>{Ue&&console.debug(`Finished loading "${w}" (aborted? ${g.signal.aborted})`),!g.signal.aborted&&_&&h.push({src:w,file:_})}},f=this.getAttribute("hash");f!=null&&(this._context.hash=f),this._context.alias=r,this._createContextPromise=this._context.create(y);const v=await this._createContextPromise;if(this.applyAttributes(),Ue&&console.warn(`--------------
Needle Engine: finished loading `+o+`
`,s,`Aborted? ${g.signal.aborted}`),g.signal.aborted){console.log("Loading finished but aborted...");return}if(this._loadId!==o){console.log("Load id changed during loading process");return}this._loadingProgress01=1,c&&v&&((i=this._loadingView)==null||i.onLoadingUpdate(1,"creating scene")),this._didFullyLoad=!0,this.classList.remove("loading"),this.classList.add("loading-finished"),this.dispatchEvent(new CustomEvent("loadfinished",{detail:{context:this._context,src:r,loadedFiles:h}}))}applyAttributes(){if(this._context.renderer){const s=this.getAttribute("tonemapping")||this.getAttribute("tone-mapping");switch(s?.toLowerCase()){case"none":this._context.renderer.toneMapping=ya;break;case"linear":this._context.renderer.toneMapping=dd;break;case"neutral":this._context.renderer.toneMapping=Xl;break;case"agx":this._context.renderer.toneMapping=hd;break;default:s!=null&&console.warn("Invalid tone-mapping attribute: "+s)}const o=this.getAttribute("tone-mapping-exposure");if(o!=null){const r=parseFloat(o);isNaN(r)||(this._context.renderer.toneMappingExposure=r)}}const t=this.getAttribute("background-blurriness");if(t!=null){const s=parseFloat(t);s!==void 0&&this._context&&(this._context.scene.backgroundBlurriness=s)}const i=this.getAttribute("background-color");if(this._context&&typeof i=="string"&&i.length>0){const s=this._context.scene.background;s instanceof ae?s.set(i):this._context.scene.background=new ae(i)}}internalSetLoadingMessage(t){var i;(i=this._loadingView)==null||i.setMessage(t)}getSourceFiles(){const t=this.getAttribute("src");if(!t)return[];let i;Array.isArray(t)?i=t:t.startsWith("[")&&t.endsWith("]")?i=JSON.parse(t):t.includes(",")?i=t.split(","):i=[t];for(let s=i.length-1;s>=0;s--){const o=i[s];(o==="null"||o==="undefined"||o?.length<=0)&&i.splice(s,1)}return i}checkIfSourceHasChanged(t,i){if(t?.length!==i?.length||t==null&&i!==null||t!==null&&i==null)return!0;if(t!==null&&i!==null){for(let s=0;s<t?.length;s++)if(t[s]!==i[s])return!0}return!1}ensureLoadStartIsRegistered(){const t=this.getAttribute("loadstart");t&&this.registerEventFromAttribute("loadstart",t)}registerEventFromAttribute(t,i){const s=this._previouslyRegisteredMap.get(t);if(s&&(this._previouslyRegisteredMap.delete(t),this.removeEventListener(t,s)),typeof i=="string"&&i.length>0)try{const o=(0,eval)(i);typeof o=="function"&&(this._previouslyRegisteredMap.set(t,o),this.addEventListener(t,r=>o?.call(globalThis,this._context,r)))}catch(o){console.error("Error registering event "+t+'="'+i+`" failed with the following error:
`,o)}}setPublicKey(){cc.length>0&&this.setAttribute("public-key",cc)}setVersion(){_n.length>0&&this.setAttribute("version",_n)}getAROverlayContainer(){return this._overlay_ar.createOverlayContainer(this)}getVROverlayContainer(){for(let t=0;t<this.children.length;t++){const i=this.children[t];if(i.classList.contains("vr"))return i}return null}onEnterAR(t){var i;this.onSetupAR();const s=this.getAROverlayContainer();this._overlay_ar.onBegin(this._context,s,t),this.dispatchEvent(new CustomEvent("enter-ar",{detail:{session:t,context:this._context,htmlContainer:(i=this._overlay_ar)==null?void 0:i.ARContainer}}))}onExitAR(t){var i;this._overlay_ar.onEnd(this._context),this.onSetupDesktop(),this.dispatchEvent(new CustomEvent("exit-ar",{detail:{session:t,context:this._context,htmlContainer:(i=this._overlay_ar)==null?void 0:i.ARContainer}}))}onEnterVR(t){this.onSetupVR(),this.dispatchEvent(new CustomEvent("enter-vr",{detail:{session:t,context:this._context}}))}onExitVR(t){this.onSetupDesktop(),this.dispatchEvent(new CustomEvent("exit-vr",{detail:{session:t,context:this._context}}))}onSetupAR(){this.classList.add(Yh),this.classList.remove(Zh);const t=this.getAROverlayContainer();Ue&&console.warn("onSetupAR:",t),t&&(t.classList.add(Yh),t.classList.remove(Zh)),this.foreachHtmlElement(i=>this.setupElementsForMode(i,hw))}onSetupVR(){this.classList.remove(Yh),this.classList.remove(Zh),this.foreachHtmlElement(t=>this.setupElementsForMode(t,J1))}onSetupDesktop(){this.classList.remove(Yh),this.classList.add(Zh);const t=this.getAROverlayContainer();t&&(t.classList.remove(Yh),t.classList.add(Zh)),this.foreachHtmlElement(i=>this.setupElementsForMode(i,eS))}setupElementsForMode(t,i,s=null){var o,r;if(!(t===((r=(o=this._context)==null?void 0:o.renderer)==null?void 0:r.domElement)||t.id==="VRButton"||t.id==="ARButton"))if(t.classList.contains(i))t.style.visibility="visible",t.style.display==="none"&&(t.style.display="block");else for(const l of Ej)t.classList.contains(l)&&(t.style.visibility="hidden",t.style.display="none")}foreachHtmlElement(t){for(let i=0;i<this.children.length;i++){const s=this.children[i];s.style&&t(s)}}onBeforeBeginLoading(){const t=this.getAttribute("dracoDecoderPath");t&&(Ue&&console.log("using custom draco decoder path",t),uw(t));const i=this.getAttribute("dracoDecoderType");i&&(Ue&&console.log("using custom draco decoder type",i),pw(i));const s=this.getAttribute("ktx2DecoderPath");s&&(Ue&&console.log("using custom ktx2 decoder path",s),mw(s))}}typeof window<"u"&&!window.customElements.get(K1)&&window.customElements.define(K1,Ry);function Ij(n){if(n.startsWith("blob:"))return"blob";const t=n.split("/");let i=t[t.length-1];const s=i.indexOf("?");s>0&&(i=i.substring(0,s));const o=i.indexOf("=");o>0&&(i=i.substring(o));const r=i.split(".").pop(),l=r?["glb","gltf","usdz","usd","fbx","obj","mtl"].indexOf(r.toLowerCase()):-1;if(r&&l>=0&&(i=i.substring(0,i.length-r.length-1)),i=decodeURIComponent(i),i.length>3){let c="",h=!1;const d=["(",")","[","]","{","}",":",";",",",".","!","?"];for(let u=0;u<i.length;u++){let p=i[u];(p==="_"||p==="-")&&(p=" "),!(p===" "&&c.length<=0||d.includes(p)||(c.length===0&&(p=p.toUpperCase()),h&&p===" "))&&(h&&(p=p.toUpperCase()),h=!1,c+=p,p===" "&&(h=!0))}return F()&&i!==c&&console.debug('Generated display name: "'+i+'" \u2192 "'+c+'"'),c.trim()}return F()&&console.debug("Loading: use default name",i),i}const jj=Object.freeze(Object.defineProperty({__proto__:null,NeedleEngineHTMLElement:Ry},Symbol.toStringTag,{value:"Module"}));function Lj(){Ps.registerWaitForInteraction(()=>{const n=MC.getContext();n.addEventListener("statechange",()=>{setTimeout(()=>{const t=n.state;(t==="suspended"||t==="interrupted")&&n.resume().then(()=>{console.log("AudioContext resumed successfully")}).catch(i=>{console.log("Failed to resume AudioContext: "+i)})},500)})})}setTimeout(Lj,1e3);const Kp=C("debughotreload");let Kh=!1;const Jh=new Map;function Dj(){return Kh}function Bj(n){var t;if(Kh)return;const i=n.constructor.name;Jh.has(i)?(t=Jh.get(i))==null||t.push(n):Jh.set(i,[n])}function Fj(n){if(Kh)return;const t=n.constructor.name,i=Jh.get(t);if(!i)return;const s=i.indexOf(n);s!==-1&&i.splice(s,1)}let tS=!1;function zj(){if(Kp||tS)return;tS=!0;const n=console.error;console.error=(...t)=>{if(t.length){const i=t[0];if(typeof i=="string"&&i.includes("[hmr] Failed to reload ")){console.log("[Needle Engine] Hot reloading failed"),window.location.reload();return}}n.apply(console,t)}}function Uj(n){Kp&&console.log("[HMR] Apply changes",n,Object.keys(n)),zj();for(const t of Object.keys(n))try{Kh=!0;const i=k.get(t);if(!i){Kp&&console.log("[HMR] Type not found: "+t);continue}const s=n[t],o=Jh.get(s.name);let r="[Needle Engine] Updating type: "+t;const l=o?.length??-1;l>0?r+=" x"+l:r+=" - no instances",console.log(r);const c=Object.getOwnPropertyNames(i.prototype),h=Object.getOwnPropertyDescriptors(s.prototype);for(const d in h)h[d].writable&&(i.prototype[d]=n[t].prototype[d]);for(const d of c)h[d]||delete i.prototype[d];if(o){const d=new s,u=Object.getOwnPropertyDescriptors(d);for(const p of o){const g=p,y=g.isComponent===!0,f=y?g.activeAndEnabled:!0,v=y?g.context:void 0;try{if(y&&v&&Cs(g,v),y&&f&&(g.enabled=!1),p.onBeforeHotReloadFields&&p.onBeforeHotReloadFields()===!1)continue;for(const b in u)if(u[b].writable){if(p[b]===void 0)p[b]=d[b];else if(typeof p[b]=="function"&&!p[b].prototype){const w=p[b],_=w.name,S="bound ";if(_===S)continue;const R=w.name.substring(S.length),M=s.prototype[R];M&&(p[b]=M.bind(p))}}p.onAfterHotReloadFields&&p.onAfterHotReloadFields()}finally{y&&v&&Cg(g,v),y&&f&&(g.enabled=!0)}}}}catch(i){if(Kp)console.error(i);else return!1}finally{Kh=!1,Un(Pi.Log,"Script changes applied (HMR)")}return!0}const rt=C("debugphysics"),Ty=C("debugcolliderplacement"),Ey=C("debugcollisions"),Nj=C("showcolliders"),Ay=C("debugraycasts"),bi=Symbol("needle component"),ni=Symbol("physics body"),iS=Symbol("rigidbody");globalThis.true=globalThis.true!==void 0?globalThis.true:!0,rt&&console.log("Use Rapier",!0,globalThis.true),ue.registerCallback(pe.ContextCreationStart,n=>{rt&&console.log("Register rapier physics backend"),n.context.physics.engine=new Nl(n.context)});const Jp=class{constructor(n){a(this,"debugRenderColliders",!1),a(this,"debugRenderRaycasts",!1),a(this,"context"),a(this,"_initializePromise"),a(this,"_isInitialized",!1),a(this,"rapierRay"),a(this,"raycastVectorsBuffer",new Oi(()=>new x,10)),a(this,"rapierSphere",null),a(this,"rapierColliderArray",[]),a(this,"rapierIdentityRotation",{x:0,y:0,z:0,w:1}),a(this,"rapierForwardVector",{x:0,y:0,z:1}),a(this,"enabled",!1),a(this,"_tempPosition",new x),a(this,"_tempQuaternion",new V),a(this,"_tempScale",new x),a(this,"_tempMatrix",new se),a(this,"_isUpdatingPhysicsWorld",!1),a(this,"_world"),a(this,"_hasCreatedWorld",!1),a(this,"eventQueue"),a(this,"collisionHandler"),a(this,"objects",[]),a(this,"bodies",[]),a(this,"_meshCache",new Map),a(this,"_gravity",{x:0,y:-9.81,z:0}),a(this,"lines"),a(this,"_tempCenterPos",new x),a(this,"_tempCenterVec",new x),a(this,"_tempCenterQuaternion",new V),this.context=n}removeBody(n){var t,i,s;if(!n)return;this.validate();const o=n[ni];if(n[ni]=null,o&&this.world){const r=this.objects.findIndex(l=>l===n);if(r>=0){const l=this.bodies[r];if(this.bodies.splice(r,1),this.objects.splice(r,1),l instanceof I.RAPIER_PHYSICS.MODULE.Collider){const c=l;(t=this.world)==null||t.removeCollider(c,!0);const h=c.parent();h&&h.numColliders()<=0&&(h[bi]||(i=this.world)==null||i.removeRigidBody(h))}else l instanceof I.RAPIER_PHYSICS.MODULE.RigidBody&&(l.numColliders()<=0?(s=this.world)==null||s.removeRigidBody(l):F()&&(l.did_log_removing||setTimeout(()=>{l.numColliders()>0&&(l.did_log_removing=!0,console.warn("RapierPhysics: removing rigidbody with colliders from the physics world is not possible right now, please remove the colliders first"))},1)))}}}updateBody(n,t,i){if(this.validate(),!!this.enabled&&!(n.destroyed||!n.gameObject)&&!(!t&&!i))if(n.isCollider===!0)console.warn("TODO: implement updating collider position");else{const s=n,o=s[ni];o&&this.syncPhysicsBody(s.gameObject,o,t,i)}}updateProperties(n){if(this.validate(),n.isCollider){const t=n,i=t[ni];i&&(this.internalUpdateColliderProperties(t,i),t.sharedMaterial&&this.updatePhysicsMaterial(t))}else{const t=n,i=this.internal_getRigidbody(t);i&&this.internalUpdateRigidbodyProperties(t,i)}}addForce(n,t,i){this.validate();const s=this.internal_getRigidbody(n);s?s.addForce(t,i):console.warn("Rigidbody doesn't exist: can not apply force (does your object with the Rigidbody have a collider?)")}addImpulse(n,t,i){this.validate();const s=this.internal_getRigidbody(n);s?s.applyImpulse(t,i):console.warn("Rigidbody doesn't exist: can not apply impulse (does your object with the Rigidbody have a collider?)")}getLinearVelocity(n){this.validate();const t=this.internal_getRigidbody(n);return t?t.linvel():null}getAngularVelocity(n){this.validate();const t=this.internal_getRigidbody(n);return t?t.angvel():null}resetForces(n,t){this.validate();const i=this.internal_getRigidbody(n);i?.resetForces(t)}resetTorques(n,t){this.validate();const i=this.internal_getRigidbody(n);i?.resetTorques(t)}applyImpulse(n,t,i){this.validate();const s=this.internal_getRigidbody(n);s?s.applyImpulse(t,i):console.warn("Rigidbody doesn't exist: can not apply impulse (does your object with the Rigidbody have a collider?)")}wakeup(n){this.validate();const t=this.internal_getRigidbody(n);t?t.wakeUp():console.warn("Rigidbody doesn't exist: can not wake up (does your object with the Rigidbody have a collider?)")}isSleeping(n){this.validate();const t=this.internal_getRigidbody(n);return t?.isSleeping()}setAngularVelocity(n,t,i){this.validate();const s=this.internal_getRigidbody(n);s?s.setAngvel(t,i):console.warn("Rigidbody doesn't exist: can not set angular velocity (does your object with the Rigidbody have a collider?)")}setLinearVelocity(n,t,i){this.validate();const s=this.internal_getRigidbody(n);s?s.setLinvel(t,i):console.warn("Rigidbody doesn't exist: can not set linear velocity (does your object with the Rigidbody have a collider?)")}get isInitialized(){return this._isInitialized}async initialize(){return this._initializePromise||(this._initializePromise=this.internalInitialization()),this._initializePromise}async internalInitialization(){return C("__nophysics")?(console.warn("Physics are disabled"),!1):(rt&&console.log("Initialize rapier physics engine"),"env"in import.meta&&{}.VITE_NEEDLE_USE_RAPIER==="false"?(rt&&console.log("Rapier disabled"),!1):this._hasCreatedWorld?(console.error("Invalid call to create physics world: world is already created"),!0):(this._hasCreatedWorld=!0,I.RAPIER_PHYSICS.MAYBEMODULE==null&&(rt&&console.trace("Loading rapier physics engine"),await(await I.RAPIER_PHYSICS.load()).init()),rt&&console.log("Physics engine initialized, creating world..."),this._world=new I.RAPIER_PHYSICS.MODULE.World(this._gravity),this.rapierRay=new I.RAPIER_PHYSICS.MODULE.Ray({x:0,y:0,z:0},{x:0,y:0,z:1}),this.enabled=!0,this._isInitialized=!0,rt&&console.log("Physics world created"),!0))}validate(){this._isInitialized||rt&&(this._lastWarnTime=this._lastWarnTime??0,Date.now()-this._lastWarnTime>1e3&&(this._lastWarnTime=Date.now(),console.warn("Physics engine is not initialized")))}raycast(n,t,i){var s;if(!this._isInitialized)return console.log("Physics engine is not initialized"),null;let o=i?.maxDistance,r=i?.solid;o===void 0&&(o=1/0),r===void 0&&(r=!0);const l=this.getPhysicsRay(this.rapierRay,n,t);if(!l)return null;(this.debugRenderRaycasts||Ay)&&G.DrawRay(l.origin,l.dir,255,1);const c=(s=this.world)==null?void 0:s.castRay(l,o,r,i?.queryFilterFlags,i?.filterGroups,void 0,void 0,h=>{const d=h[bi];return i!=null&&i.filterPredicate?i.filterPredicate(d):i?.useIgnoreRaycastLayer!==!1?!(d!=null&&d.gameObject.layers.isEnabled(2)):!0});if(c){const h=l.pointAt(c.timeOfImpact),d=this.raycastVectorsBuffer.get();return d.set(h.x,h.y,h.z),{point:d,collider:c.collider[bi]}}return null}raycastAndGetNormal(n,t,i){var s;if(!this._isInitialized)return null;let o=i?.maxDistance,r=i?.solid;o===void 0&&(o=1/0),r===void 0&&(r=!0);const l=this.getPhysicsRay(this.rapierRay,n,t);if(!l)return null;(this.debugRenderRaycasts||Ay)&&G.DrawRay(l.origin,l.dir,255,1);const c=(s=this.world)==null?void 0:s.castRayAndGetNormal(l,o,r,i?.queryFilterFlags,i?.filterGroups,void 0,void 0,h=>{const d=h[bi];return i!=null&&i.filterPredicate?i.filterPredicate(d):i?.useIgnoreRaycastLayer!==!1?!(d!=null&&d.gameObject.layers.isEnabled(2)):!0});if(c){const h=l.pointAt(c.timeOfImpact),d=c.normal,u=this.raycastVectorsBuffer.get(),p=this.raycastVectorsBuffer.get();return u.set(h.x,h.y,h.z),p.set(d.x,d.y,d.z),{point:u,normal:p,collider:c.collider[bi]}}return null}getPhysicsRay(n,t,i){var s,o,r;const l=(s=this.context)==null?void 0:s.mainCamera;if(t===void 0){const d=(o=this.context)==null?void 0:o.input.getPointerPosition(0);if(d)t=d;else return null}if(t.z===void 0){if(!l)return console.error("Can not perform raycast from 2d point - no main camera found"),null;const d=this.raycastVectorsBuffer.get();d.x=t.x,d.y=t.y,d.z=0,(d.x>1||d.y>1||d.y<-1||d.x<-1)&&(rt&&console.warn("Converting screenspace to raycast space",d),(r=this.context)==null||r.input.convertScreenspaceToRaycastSpace(d)),d.unproject(l),t=d}const c=t;n.origin.x=c.x,n.origin.y=c.y,n.origin.z=c.z;const h=this.raycastVectorsBuffer.get();if(i)h.set(i.x,i.y,i.z);else{if(!l)return console.error("Can not perform raycast - no camera found"),null;h.set(n.origin.x,n.origin.y,n.origin.z);const d=te(l);h.sub(d)}return h.normalize(),n.dir.x=h.x,n.dir.y=h.y,n.dir.z=h.z,n}sphereOverlap(n,t){return this.rapierColliderArray.length=0,this._isInitialized?this.world?(this.rapierSphere??(this.rapierSphere=new I.RAPIER_PHYSICS.MODULE.Ball(t)),this.rapierSphere.radius=t,(this.debugRenderRaycasts||Ay)&&G.DrawWireSphere(n,t,3359999,1),this.world.intersectionsWithShape(n,this.rapierIdentityRotation,this.rapierSphere,i=>{const s=i[bi],o=new Dw(s.gameObject,s);return this.rapierColliderArray.push(o),!0},void 0,void 0,void 0,void 0,i=>i.isSensor()?!1:i[bi].gameObject.layers.isEnabled(2)==!1),this.rapierColliderArray):this.rapierColliderArray:this.rapierColliderArray}get world(){return this._world}get isUpdating(){return this._isUpdatingPhysicsWorld}get gravity(){var n;return((n=this.world)==null?void 0:n.gravity)??this._gravity}set gravity(n){this.world?this.world.gravity=n:this._gravity=n}clearCaches(){var n,t,i,s;this._meshCache.clear(),(n=this.eventQueue)!=null&&n.raw&&((t=this.eventQueue)==null||t.free()),(i=this.world)!=null&&i.bodies&&((s=this.world)==null||s.free())}async addBoxCollider(n,t){if(this._isInitialized||await this.initialize(),!n.activeAndEnabled)return;if(!this.enabled){rt&&console.warn("Physics are disabled");return}const i=n.gameObject,s=Ye(i,this._tempPosition).multiply(t);s.multiplyScalar(.5),s.x<0&&(s.x=Math.abs(s.x)),s.y<0&&(s.y=Math.abs(s.y)),s.z<0&&(s.z=Math.abs(s.z)),s.x==0&&(s.x=1e-7),s.y==0&&(s.y=1e-7),s.z==0&&(s.z=1e-7);const o=I.RAPIER_PHYSICS.MODULE.ColliderDesc.cuboid(s.x,s.y,s.z);this.createCollider(n,o)}async addSphereCollider(n){if(this._isInitialized||await this.initialize(),!n.activeAndEnabled)return;if(!this.enabled){rt&&console.warn("Physics are disabled");return}const t=I.RAPIER_PHYSICS.MODULE.ColliderDesc.ball(.5);this.createCollider(n,t),this.updateProperties(n)}async addCapsuleCollider(n,t,i){if(this._isInitialized||await this.initialize(),!n.activeAndEnabled)return;if(!this.enabled){rt&&console.warn("Physics are disabled");return}const s=n.gameObject,o=Ye(s,this._tempPosition);o.x=Math.abs(o.x),o.y=Math.abs(o.y);const r=i*o.x;t=Math.max(t,r*2);const l=W.clamp(t*.5*o.y-i*o.x,0,Number.MAX_SAFE_INTEGER),c=I.RAPIER_PHYSICS.MODULE.ColliderDesc.capsule(l,r);this.createCollider(n,c)}async addMeshCollider(n,t,i,s){var o,r,l;let c=t.geometry;if(!c){rt&&console.warn("Missing mesh geometry",t.name);return}(r=(o=c.index)==null?void 0:o.array)!=null&&r.length||(console.warn(`Your MeshCollider is missing vertices or indices in the assined mesh "${t.name}". Consider providing an indexed geometry.`),c=JC(c));let h=null;const d=c.getAttribute("position");if(d instanceof $y){const y=d.count;h=new Float32Array(y*3);for(let f=0;f<y;f++){const v=d.getX(f),b=d.getY(f),w=d.getZ(f);h[f*3]=v,h[f*3+1]=b,h[f*3+2]=w}}else h=d.array;if(await this.initialize(),!this.enabled){rt&&console.warn("Physics are disabled");return}if(!n.activeAndEnabled)return;const u=(l=c.index)==null?void 0:l.array,p=n.gameObject.worldScale.clone();if(s&&p.multiply(s),Math.abs(p.x-1)>1e-4||Math.abs(p.y-1)>1e-4||Math.abs(p.z-1)>1e-4){const y=`${c.uuid}_${p.x}_${p.y}_${p.z}_${i}`;if(this._meshCache.has(y))rt&&console.warn("Use cached mesh collider"),h=this._meshCache.get(y);else{(rt||F())&&console.debug(`[Performance] Your MeshCollider "${n.name}" is scaled: consider applying the scale to the collider mesh instead (${p.x}, ${p.y}, ${p.z})`);const f=new Float32Array(h.length);for(let v=0;v<h.length;v+=3)f[v]=h[v]*p.x,f[v+1]=h[v+1]*p.y,f[v+2]=h[v+2]*p.z;h=f,this._meshCache.set(y,f)}}const g=i?I.RAPIER_PHYSICS.MODULE.ColliderDesc.convexHull(h):I.RAPIER_PHYSICS.MODULE.ColliderDesc.trimesh(h,u);g&&this.createCollider(n,g)}updatePhysicsMaterial(n){if(!n)return;const t=n.sharedMaterial,i=n[ni];if(i&&t){if(t.bounciness!==void 0&&i.setRestitution(t.bounciness),t.bounceCombine!==void 0)switch(t.bounceCombine){case wt.Average:i.setRestitutionCombineRule(I.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Average);break;case wt.Maximum:i.setRestitutionCombineRule(I.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Max);break;case wt.Minimum:i.setRestitutionCombineRule(I.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Min);break;case wt.Multiply:i.setRestitutionCombineRule(I.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Multiply);break}if(t.dynamicFriction!==void 0&&i.setFriction(t.dynamicFriction),t.frictionCombine!==void 0)switch(t.frictionCombine){case wt.Average:i.setFrictionCombineRule(I.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Average);break;case wt.Maximum:i.setFrictionCombineRule(I.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Max);break;case wt.Minimum:i.setFrictionCombineRule(I.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Min);break;case wt.Multiply:i.setFrictionCombineRule(I.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Multiply);break}}}getBody(n){return n?n[ni]:null}getComponent(n){return n?n[bi]:null}createCollider(n,t){var i;if(!this.world)throw new Error("Physics world not initialized");const s=this._tempMatrix;let o;n.attachedRigidbody?o=this.getRigidbody(n,this._tempMatrix):(rt&&console.log("Create collider without rigidbody",n.name),s.makeRotationFromQuaternion(Ce(n.gameObject)),s.setPosition(te(n.gameObject))),s.decompose(this._tempPosition,this._tempQuaternion,this._tempScale),this.tryApplyCenter(n,this._tempPosition),t.setTranslation(this._tempPosition.x,this._tempPosition.y,this._tempPosition.z),t.setRotation(this._tempQuaternion),t.setSensor(n.isTrigger);const r=n.sharedMaterial;if(r){if(r.bounciness!==void 0&&t.setRestitution(r.bounciness),r.bounceCombine!==void 0)switch(r.bounceCombine){case wt.Average:t.setRestitutionCombineRule(I.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Average);break;case wt.Maximum:t.setRestitutionCombineRule(I.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Max);break;case wt.Minimum:t.setRestitutionCombineRule(I.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Min);break;case wt.Multiply:t.setRestitutionCombineRule(I.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Multiply);break}if(r.dynamicFriction!==void 0&&t.setFriction(r.dynamicFriction),r.frictionCombine!==void 0)switch(r.frictionCombine){case wt.Average:t.setFrictionCombineRule(I.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Average);break;case wt.Maximum:t.setFrictionCombineRule(I.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Max);break;case wt.Minimum:t.setFrictionCombineRule(I.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Min);break;case wt.Multiply:t.setFrictionCombineRule(I.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Multiply);break}}((i=n.attachedRigidbody)==null?void 0:i.autoMass)===!1&&(t.setDensity(1e-6),t.setMass(1e-6));try{const l=this.world.createCollider(t,o);return l[bi]=n,n[ni]=l,l.setActiveEvents(I.RAPIER_PHYSICS.MODULE.ActiveEvents.COLLISION_EVENTS),l.setActiveCollisionTypes(I.RAPIER_PHYSICS.MODULE.ActiveCollisionTypes.ALL),this.objects.push(n),this.bodies.push(l),this.updateColliderCollisionGroups(n),l}catch(l){return console.error('Error creating collider "'+n.name+`"
Error:`,l),null}}updateColliderCollisionGroups(n){const t=n[ni],i=n.membership;let s=0;if(i==null)s=65535;else for(let l=0;l<i.length;l++){const c=i[l];c>31?console.error(`Rapier only supports 32 layers, layer ${c} is not supported`):s|=1<<Math.floor(c)}const o=n.filter;let r=0;if(o==null)r=65535;else for(let l=0;l<o.length;l++){const c=o[l];c>31?console.error(`Rapier only supports 32 layers, layer ${c} is not supported`):r|=1<<Math.floor(c)}t.setCollisionGroups(s<<16|r)}getRigidbody(n,t){if(!this.world)throw new Error("Physics world not initialized");let i=null;if(n.attachedRigidbody){const s=n.attachedRigidbody;if(i=s[ni],!i){const o=s.isKinematic&&!Ty;rt&&console.log("Create rigidbody",o);const r=o?I.RAPIER_PHYSICS.MODULE.RigidBodyDesc.kinematicPositionBased():I.RAPIER_PHYSICS.MODULE.RigidBodyDesc.dynamic(),l=te(n.attachedRigidbody.gameObject);r.setTranslation(l.x,l.y,l.z),r.setRotation(Ce(n.attachedRigidbody.gameObject)),r.centerOfMass=new I.RAPIER_PHYSICS.MODULE.Vector3(s.centerOfMass.x,s.centerOfMass.y,s.centerOfMass.z),i=this.world.createRigidBody(r),this.bodies.push(i),this.objects.push(s)}i[bi]=s,s[ni]=i,this.internalUpdateRigidbodyProperties(s,i),this.getRigidbodyRelativeMatrix(n.gameObject,s.gameObject,t),n[iS]=i}else{const s=I.RAPIER_PHYSICS.MODULE.RigidBodyDesc.kinematicPositionBased(),o=te(n.gameObject);s.setTranslation(o.x,o.y,o.z),s.setRotation(Ce(n.gameObject)),i=this.world.createRigidBody(s),t.identity(),i[bi]=null}return i}internal_getRigidbody(n){return n.isCollider===!0?n[iS]:n[ni]}internalUpdateColliderProperties(n,t){const i=t.shape;let s=!1;switch(i.type){case I.RAPIER_PHYSICS.MODULE.ShapeType.Ball:{const p=i,g=n,y=n.gameObject,f=Ye(y,this._tempPosition),v=Math.abs(g.radius*f.x);s=p.radius!==v,p.radius=v,s&&t.setShape(p);break}case I.RAPIER_PHYSICS.MODULE.ShapeType.Cuboid:const o=i,r=n,l=n.gameObject,c=Ye(l,this._tempPosition),h=r.size.x*.5*c.x,d=r.size.y*.5*c.y,u=r.size.z*.5*c.z;s=o.halfExtents.x!==h||o.halfExtents.y!==d||o.halfExtents.z!==u,o.halfExtents.x=h,o.halfExtents.y=d,o.halfExtents.z=u,s&&t.setShape(o);break}if(s){const o=n.attachedRigidbody;if(o!=null&&o.autoMass){const r=this.getBody(o);r?.recomputeMassPropertiesFromColliders()}}this.updateColliderCollisionGroups(n),n.isTrigger!==t.isSensor()&&t.setSensor(n.isTrigger)}internalUpdateRigidbodyProperties(n,t){if(t.enableCcd(n.collisionDetectionMode!==wu.Discrete),t.setLinearDamping(n.drag),t.setAngularDamping(n.angularDrag),t.setGravityScale(n.useGravity?n.gravityScale:0,!0),n.dominanceGroup<=127&&n.dominanceGroup>=-127?t.setDominanceGroup(Math.floor(n.dominanceGroup)):t.setDominanceGroup(0),n.autoMass){t.setAdditionalMass(0,!1);for(let i=0;i<t.numColliders();i++)t.collider(i).setDensity(1);t.recomputeMassPropertiesFromColliders()}else{t.setAdditionalMass(n.mass,!1);for(let i=0;i<t.numColliders();i++)t.collider(i).setDensity(1e-7);t.recomputeMassPropertiesFromColliders()}t.setEnabledRotations(!n.lockRotationX,!n.lockRotationY,!n.lockRotationZ,!1),t.setEnabledTranslations(!n.lockPositionX,!n.lockPositionY,!n.lockPositionZ,!1),n.isKinematic?t.setBodyType(I.RAPIER_PHYSICS.MODULE.RigidBodyType.KinematicPositionBased,!1):t.setBodyType(I.RAPIER_PHYSICS.MODULE.RigidBodyType.Dynamic,!1)}step(n){if(this.world&&this.enabled){if(this._isUpdatingPhysicsWorld=!0,this.eventQueue||(this.eventQueue=new I.RAPIER_PHYSICS.MODULE.EventQueue(!1)),n===void 0||n<=0){this._isUpdatingPhysicsWorld=!1;return}else n!==void 0&&(this.world.timestep=W.lerp(this.world.timestep,n,.8));try{this.world.step(this.eventQueue)}catch(t){console.warn("Error running physics step",t)}this._isUpdatingPhysicsWorld=!1}}postStep(){this.world&&this.enabled&&(this._isUpdatingPhysicsWorld=!0,this.syncObjects(),this._isUpdatingPhysicsWorld=!1,this.eventQueue&&!this.collisionHandler&&(this.collisionHandler=new Wj(this.world,this.eventQueue)),this.collisionHandler&&(this.collisionHandler.handleCollisionEvents(),this.collisionHandler.update()),this.updateDebugRendering(this.world))}updateDebugRendering(n){var t,i,s,o;if(rt||Ty||Nj||this.debugRenderColliders===!0){if(!this.lines){const l=new Hy({color:7855479,fog:!1}),c=new gs;this.lines=new Vy(c,l),this.lines.layers.disableAll(),this.lines.layers.enable(2)}this.lines.parent!==((t=this.context)==null?void 0:t.scene)&&((i=this.context)==null||i.scene.add(this.lines));const r=n.debugRender();this.lines.geometry.setAttribute("position",new yt(r.vertices,3)),this.lines.geometry.setAttribute("color",new yt(r.colors,4)),(this.context.time.frame%30===0||((s=this.lines.geometry.boundingSphere)==null?void 0:s.radius)===0)&&this.lines.geometry.computeBoundingSphere()}else this.lines&&((o=this.context)==null||o.scene.remove(this.lines))}syncObjects(){if(!Ty)for(let n=0;n<this.bodies.length;n++){const t=this.objects[n],i=this.bodies[n],s=t;if(s?.isCollider===!0&&!s.attachedRigidbody){const c=i.parent();c?this.syncPhysicsBody(t.gameObject,c,!0,!0):this.syncPhysicsBody(t.gameObject,i,!0,!0);continue}const o=i.translation(),r=i.rotation();if(Number.isNaN(o.x)||Number.isNaN(r.x)){!s.__COLLIDER_NAN&&F()&&(console.warn("Collider has NaN values",s.name,s.gameObject,i),s.__COLLIDER_NAN=!0);continue}const l=t.center;if(l&&l.isVector3){this._tempQuaternion.set(r.x,r.y,r.z,r.w);const c=this._tempPosition.copy(l).applyQuaternion(this._tempQuaternion),h=Ye(t.gameObject);c.multiply(h),o.x-=c.x,o.y-=c.y,o.z-=c.z}cr(t.gameObject,o.x,o.y,o.z),Um(t.gameObject,r.x,r.y,r.z,r.w)}}syncPhysicsBody(n,t,i,s){if(t instanceof I.RAPIER_PHYSICS.MODULE.RigidBody){const o=te(n,this._tempPosition),r=Ce(n,this._tempQuaternion);switch(t.bodyType()){case I.RAPIER_PHYSICS.MODULE.RigidBodyType.Fixed:case I.RAPIER_PHYSICS.MODULE.RigidBodyType.KinematicPositionBased:case I.RAPIER_PHYSICS.MODULE.RigidBodyType.KinematicVelocityBased:i&&t.setNextKinematicTranslation(o),s&&t.setNextKinematicRotation(r);break;default:i&&t.setTranslation(o,!1),s&&t.setRotation(r,!1);break}}else if(t instanceof I.RAPIER_PHYSICS.MODULE.Collider){n.matrixWorldNeedsUpdate&&n.updateWorldMatrix(!0,!1),n.matrixWorld.decompose(this._tempPosition,this._tempQuaternion,this._tempScale);const o=this._tempPosition,r=this._tempQuaternion,l=t[bi];if(this.tryApplyCenter(l,o),i){const c=t.translation();(c.x!==o.x||c.y!==o.y||c.z!==o.z)&&t.setTranslation(o)}if(s){const c=t.rotation();(c.x!==r.x||c.y!==r.y||c.z!==r.z||c.w!==r.w)&&t.setRotation(r)}}}tryApplyCenter(n,t){const i=n.center;i&&n.gameObject&&(i.x!==0||i.y!==0||i.z!==0)&&(this._tempCenterPos.x=i.x,this._tempCenterPos.y=i.y,this._tempCenterPos.z=i.z,Ye(n.gameObject,this._tempCenterVec),this._tempCenterPos.multiply(this._tempCenterVec),n.attachedRigidbody?this._tempCenterPos.applyQuaternion(n.gameObject.quaternion):(Ce(n.gameObject,this._tempCenterQuaternion),this._tempCenterPos.applyQuaternion(this._tempCenterQuaternion)),t.x+=this._tempCenterPos.x,t.y+=this._tempCenterPos.y,t.z+=this._tempCenterPos.z)}getRigidbodyRelativeMatrix(n,t,i,s){if(s===void 0&&(s=Jp._matricesBuffer,s.length=0),n===t){const o=Ye(n,this._tempPosition);i.makeScale(o.x,o.y,o.z);for(let r=s.length-1;r>=0;r--)i.multiply(s[r]);return i}return s.push(n.matrix),n.parent&&this.getRigidbodyRelativeMatrix(n.parent,t,i,s),i}addFixedJoint(n,t){if(!this.world){console.error("Physics world not initialized");return}const i=n[ni],s=t[ni];this.calculateJointRelativeMatrices(n.gameObject,t.gameObject,this._tempMatrix),this._tempMatrix.decompose(this._tempPosition,this._tempQuaternion,this._tempScale);const o=I.RAPIER_PHYSICS.MODULE.JointData.fixed(Jp.centerConnectionPos,Jp.centerConnectionRot,this._tempPosition,this._tempQuaternion),r=this.world.createImpulseJoint(o,i,s,!0);rt&&console.log("ADD FIXED JOINT",r)}addHingeJoint(n,t,i,s){if(!this.world){console.error("Physics world not initialized");return}const o=n[ni],r=t[ni];this.calculateJointRelativeMatrices(n.gameObject,t.gameObject,this._tempMatrix),this._tempMatrix.decompose(this._tempPosition,this._tempQuaternion,this._tempScale);const l=I.RAPIER_PHYSICS.MODULE.JointData.revolute(i,this._tempPosition,s),c=this.world.createImpulseJoint(l,o,r,!0);rt&&console.log("ADD HINGE JOINT",c)}calculateJointRelativeMatrices(n,t,i){n.updateWorldMatrix(!0,!1),t.updateWorldMatrix(!0,!1);const s=n.matrixWorld,o=t.matrixWorld;s.elements[0]=1,s.elements[5]=1,s.elements[10]=1,o.elements[0]=1,o.elements[5]=1,o.elements[10]=1,i.copy(o).premultiply(s.invert()).invert()}};let Nl=Jp;a(Nl,"_didLoadPhysicsEngine",!1),a(Nl,"_matricesBuffer",[]),a(Nl,"centerConnectionPos",{x:0,y:0,z:0}),a(Nl,"centerConnectionRot",{x:0,y:0,z:0,w:1});class Wj{constructor(t,i){a(this,"world"),a(this,"eventQueue"),a(this,"activeCollisions",[]),a(this,"activeCollisionsStay",[]),a(this,"activeTriggers",[]),this.world=t,this.eventQueue=i}handleCollisionEvents(){this.eventQueue&&this.world&&this.eventQueue.drainCollisionEvents((t,i,s)=>{const o=this.world.getCollider(t),r=this.world.getCollider(i);if(!o||!r)return;const l=o[bi],c=r[bi];Ey&&console.log("EVT",l.name,c.name,s,o,r),l&&c&&(s?(this.onCollisionStarted(l,o,c,r),this.onCollisionStarted(c,r,l,o)):(this.onCollisionEnded(l,c),this.onCollisionEnded(c,l)))})}update(){this.onHandleCollisionStay()}onCollisionStarted(t,i,s,o){let r=null;if(t.isTrigger||s.isTrigger)_r(t.gameObject,l=>{l.onTriggerEnter&&!l.destroyed&&l.onTriggerEnter(s),this.activeTriggers.push({collider:t,component:l,otherCollider:s})});else{const l=t.gameObject;this.world.contactPair(i,o,(c,h)=>{_r(l,d=>{var u;if(d.destroyed)return;const p=d.onCollisionEnter||d.onCollisionStay||d.onCollisionExit;if(p||Ey){if(!r){const g=[],y=c.normal();s instanceof Ro&&s.convex&&(y.x=-y.x,y.y=-y.y,y.z=-y.z);for(let f=0;f<c.numSolverContacts();f++){const v=c.solverContactPoint(f),b=c.contactImpulse(f);if(v){const w=c.contactDist(f),_=c.solverContactFriction(f),S=c.solverContactTangentVelocity(f),R=new jw(v,w,y,b,_,S);g.push(R),Ey&&G.DrawDirection(v,y,16711680,3,!0)}}r=new Lw(l,s,g)}if(p){const g={collider:t,component:d,collision:r};this.activeCollisions.push(g),d.onCollisionStay&&this.activeCollisionsStay.push(g),(u=d.onCollisionEnter)==null||u.call(d,r)}}})})}}onHandleCollisionStay(){for(const t of this.activeCollisionsStay){const i=t.component;if(!i.destroyed&&i.activeAndEnabled&&i.onCollisionStay){if(t.collision.collider.destroyed)continue;const s=t.collision;i.onCollisionStay(s)}}for(const t of this.activeTriggers){const i=t.component;if(!i.destroyed&&i.activeAndEnabled&&i.onTriggerStay){const s=t.otherCollider;if(s.destroyed)continue;i.onTriggerStay(s)}}}onCollisionEnded(t,i){if(!(t.destroyed||i.destroyed)){for(let s=0;s<this.activeCollisions.length;s++){const o=this.activeCollisions[s],r=o.collider;if(r.destroyed||o.collision.collider.destroyed){this.activeCollisions.splice(s,1),s--;continue}if(r===t&&o.collision.collider===i){const l=o.component;if(this.activeCollisions.splice(s,1),s--,l.activeAndEnabled&&l.onCollisionExit){const c=o.collision;l.onCollisionExit(c)}}}for(let s=0;s<this.activeCollisionsStay.length;s++){const o=this.activeCollisionsStay[s],r=o.collider;if(r.destroyed||o.collision.collider.destroyed){this.activeCollisionsStay.splice(s,1),s--;continue}if(r===t&&o.collision.collider===i){const l=o.component;if(this.activeCollisionsStay.splice(s,1),s--,l.activeAndEnabled&&l.onCollisionExit){const c=o.collision;l.onCollisionExit(c)}}}for(let s=0;s<this.activeTriggers.length;s++){const o=this.activeTriggers[s],r=o.collider;if(r.destroyed||o.otherCollider.destroyed){this.activeTriggers.splice(s,1),s--;continue}if(r===t&&o.otherCollider===i){const l=o.component;if(this.activeTriggers.splice(s,1),s--,l.activeAndEnabled&&l.onTriggerExit){const c=o.otherCollider;l.onTriggerExit(c)}}}}}}class Vj{static async createComparisonScene(t){const{files:i}=t,s=await Promise.all(i.map(f=>new le(f).loadAssetAsync())),o=new wi;let r=0;for(const f of s)if(f instanceof j){f.position.y=r,o.add(f);const v=oi([f]);r+=v.getSize(new x).y,r+=.1}const l=new _e(20);o.add(l);const c=t.environment||"https://dl.polyhaven.org/file/ph-assets/HDRIs/exr/1k/studio_small_09_1k.exr";if(c){let f=null;if(c.endsWith(".hdr")){const v=(await import("./three-examples.min.js").then(b=>b.RGBELoader$1)).RGBELoader;f=new v}else if(c.endsWith(".exr")){const v=(await import("./three-examples.min.js").then(b=>b.EXRLoader$1)).EXRLoader;f=new v}if(f){const v=await f.loadAsync(c).catch(b=>(console.error(b),null));v&&(v.mapping=ys,v.needsUpdate=!0,o.background=v,o.environment=v,o.backgroundBlurriness=.75)}else console.warn("Unsupported environment map format",c)}const h=oi(o.children),d=h.getCenter(new x),u=h.getSize(new x),p=Math.max(u.x,u.y,u.z)/(2*Math.tan(Math.PI*l.fov/360));l.position.set(d.x,d.y,p),l.lookAt(d);const g=new nv(l,t.domElement||document.body);g.target=d,g.update();const y=(t.domElement||document.body).getBoundingClientRect();return l.aspect=y.width/y.height,l.updateProjectionMatrix(),{scene:o,camera:l}}}let Iy=0;function nS(n){n?Iy++:Iy--}function Hj(){return Iy>0}const $j={binary:!0,animations:!0};async function Gj(n){if(!n.context)throw new Error("No context provided to exportAsGLTF");n.scene||(n.scene=n.context.scene);const t={...$j,...n},{context:i}=t,s=new sv;s.register(c=>new ox(c)),s.register(c=>new xR(c)),s.register(c=>new Kw(c)),Nf(s,t.context);const o={binary:t.binary,animations:Xj(i,t.scene,[])},r=new qj;console.debug("Exporting GLTF",o),r.onBeforeExport(t),nS(!0);const l=await s.parseAsync(t.scene,o).catch(c=>(console.error(c),null));if(nS(!1),r.onAfterExport(t),!l)throw new Error("Failed to export GLTF");if(t.downloadAs!=null){let c=null;if(l instanceof ArrayBuffer?c=new Blob([l],{type:"application/octet-stream"}):console.error("Can not download GLTF as a blob",l),c){const h=URL.createObjectURL(c),d=document.createElement("a");d.href=h;let u=t.downloadAs;!u.endsWith(".glb")&&!u.endsWith(".gltf")&&(u+=t.binary?".glb":".gltf"),d.download=u,d.click()}}return l}const sS=Symbol("needle:weight");class qj{constructor(){a(this,"_undo",[])}onBeforeExport(t){t.context.animations.mixers.forEach(i=>{const s=Fa.tryGetActionsFromMixer(i);if(s)for(let o=0;o<s.length;o++){const r=s[o];r[sS]=r.weight,r.weight=0,this._undo.push(()=>{r.weight=r[sS]})}i.update(0)}),t.context.scene.traverse(i=>{if(!Df(i)){const s=i.parent;s&&(i.removeFromParent(),this._undo.push(()=>s.add(i)))}})}onAfterExport(t){this._undo.forEach(i=>i()),this._undo.length=0}}function Xj(n,t,i){n.animations.mixers.forEach(o=>{const r=Fa.tryGetActionsFromMixer(o);if(r)for(let l=0;l<r.length;l++){const c=r[l].getClip();i.push(c)}}),Array.isArray(t)||(t=[t]);for(const o of t)Fa.tryGetAnimationClipsFromObjectHierarchy(o,i);const s=new Set(i);return Array.from(s)}const oS="needle-button",jy=F();var ca,ha,da,_i,Dn,Wl,Ly,rS,Dy,aS,em;class By extends HTMLElement{constructor(){super(),pn(this,Ly),pn(this,Dy),pn(this,ca,void 0),pn(this,ha,void 0),pn(this,da,void 0),pn(this,_i,void 0),pn(this,Dn,void 0),pn(this,Wl,void 0),pn(this,em,t=>{jy&&console.log("Needle Button clicked"),!t.defaultPrevented&&ge(this,_i)&&ge(this,_i).click()}),this.removeEventListener("click",ge(this,em)),this.addEventListener("click",ge(this,em))}attributeChangedCallback(t,i,s){nd(this,Ly,rS).call(this)}}ca=new WeakMap,ha=new WeakMap,da=new WeakMap,_i=new WeakMap,Dn=new WeakMap,Wl=new WeakMap,Ly=new WeakSet,rS=function(){var n,t;if((n=ge(this,_i))==null||n.remove(),this.getAttribute("ar")!=null)ge(this,Dn)??Fn(this,Dn,new Ur),Fn(this,_i,ge(this,Dn).createARButton());else if(this.getAttribute("vr")!=null)ge(this,Dn)??Fn(this,Dn,new Ur),Fn(this,_i,ge(this,Dn).createVRButton());else if(this.getAttribute("quicklook")!=null)ge(this,Dn)??Fn(this,Dn,new Ur),Fn(this,_i,ge(this,Dn).createQuicklookButton());else{jy?console.warn("No button type specified for <needle-button>. Use either ar, vr or quicklook attribute."):console.debug("No button type specified for <needle-button>. Use either ar, vr or quicklook attribute.");return}ge(this,ca)??Fn(this,ca,this.attachShadow({mode:"open"})),ge(this,ha)??Fn(this,ha,document.createElement("slot")),ge(this,da)??Fn(this,da,document.createElement("style")),ge(this,da).innerHTML=`
            button {
                all: initial;
                cursor: inherit;
                color: inherit;
                font-family: inherit;
                gap: inherit;
                white-space: nowrap;
            }
        `,this.getAttribute("unstyled")!=null||(ge(this,da).innerHTML+=`
            :host {
                display: inline-block;
                background: rgba(255, 255, 255, .8);
                backdrop-filter: blur(10px);
                width: fit-content;
                transition: background .2s;

                cursor: pointer;
                padding: 0.4rem .5rem;
                border-radius: 0.8rem;
                color: black;
                background: rgba(245, 245, 245, .8);
                outline: rgba(0,0,0,.05) 1px solid;
            }
            :host(:hover) {
                background: rgba(255, 255, 255, 1);
                transition: background .2s;
            }
            slot {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: .5rem;
            }
`),ge(this,ha).innerHTML=ge(this,_i).innerHTML,ge(this,ha).style.cssText="display: flex; align-items: center; justify-content: center;",ge(this,_i).innerHTML=ge(this,ha).outerHTML,ge(this,ca).innerHTML=ge(this,_i).outerHTML,ge(this,ca).prepend(ge(this,da)),hu(Kg,{element:ge(this,ca)}),(t=ge(this,Wl))==null||t.disconnect(),ge(this,Wl)??Fn(this,Wl,new MutationObserver(()=>nd(this,Dy,aS).call(this))),ge(this,Wl).observe(ge(this,_i),{attributes:!0}),jy&&console.log("Needle Button updated")},Dy=new WeakSet,aS=function(){ge(this,_i)&&(ge(this,_i).style.display==="none"?this.style.display="none":this.style.display==="none"&&(this.style.display=""))},em=new WeakMap,a(By,"observedAttributes",["ar","vr","quicklook"]),typeof window<"u"&&!window.customElements.get(oS)&&window.customElements.define(oS,By);const ed=C("debugavatar");class Fy{constructor(t,i,s,o){a(this,"root"),a(this,"head"),a(this,"leftHand"),a(this,"rigthHand");var r;this.root=t,this.head=i,this.leftHand=s,this.rigthHand=o,(r=this.root)==null||r.traverse(l=>l.layers.set(2))}get isValid(){return this.head!==null&&this.head!==void 0}}class lS{constructor(){a(this,"avatarRegistryUrl",null)}async getOrCreateNewAvatarInstance(t,i){if(!i)return console.error("Can not create avatar: failed to provide id or root object"),null;let s=null;if(typeof i=="string"){if(s=await this.loadAvatar(t,i),!s){const r=new Bn;s=O.instantiate(_a(i,t.scene),r)}}else s=i;if(!s)return null;const o=this.findAvatar(s);return o.isValid?(ed&&console.log("[Custom Avatar] valid config",i,ed?o:""),o):(console.warn("[Custom Avatar] config isn't valid",i,ed?o:""),null)}async loadAvatar(t,i){if(console.assert(i!=null&&typeof i=="string","Avatar id must not be null"),i.length<=0||!i)return null;if(ed&&console.log("[Custom Avatar] "+i+", loading..."),i.endsWith(".glb")||(i+=".glb"),this.avatarRegistryUrl===null){const o=await fetch("./"+i);let r=null;if(o.ok){const c=await o.blob();c&&(r=await c.arrayBuffer())}if(!r)return null;const l=await fn().parseSync(t,r,null,0);return l?.scene??null}const s=new ar;return gu(s,t),new Promise((o,r)=>{const l=this.avatarRegistryUrl+"/"+i;s.load(l,async c=>{await fn().createBuiltinComponents(t,l,c,null,void 0),o(c.scene)},c=>{ed&&console.log("[Custom Avatar] "+c.loaded/c.total*100+"% loaded of "+c.total/1024+"kB")},c=>{console.error("[Custom Avatar] Error when loading: "+c),o(null)})})}cacheModel(t,i){}findAvatar(t){const i=t;let s=i;s.children.length==1&&(s=t.children[0]);let o=this.findAvatarPart(s,["head"]);const r=this.findAvatarPart(s,["left","hand"]),l=this.findAvatarPart(s,["right","hand"]);if(!o){o=i;const c=new x;new xi().setFromObject(o).getSize(c);const h=Math.max(c.x,c.y,c.z);console.warn("[Custom Avatar] Normalizing head scale, it's too big: "+h+" meters! Should be < 0.3m"),h>.3&&o.scale.multiplyScalar(1/h*.3)}return new Fy(i,o,r,l)}findAvatarPart(t,i){const s=t.name.toLowerCase();let o=!0;for(const r of i){if(!o)break;s.indexOf(r)===-1&&(o=!1)}if(o)return t;if(t.children)for(const r of t.children){const l=this.findAvatarPart(r,i);if(l)return l}return null}handleCustomAvatarErrors(t){if(!t.ok)throw Error(t.statusText);return t}}class cS{get extensionName(){return"DocumentExtension"}onAfterBuildDocument(t){}}class hS{}const Qj=Object.freeze(Object.defineProperty({__proto__:null,ActionBuilder:ve,ActionCollection:Bx,ActionModel:en,AlignmentConstraint:Lc,Animation:Ut,AnimationCurve:kl,AnimationExtension:np,AnimationTrackHandler:Vp,Animator:kt,AnimatorController:ln,Antialiasing:Oh,AudioExtension:ua,AudioListener:Ts,AudioSource:Ne,AudioTrackHandler:Uh,Avatar:Do,AvatarBlink_Simple:Er,AvatarEyeLook_Rotation:qa,AvatarLoader:lS,AvatarMarker:Rt,AvatarModel:Fy,Avatar_Brain_LookAt:Hc,Avatar_MouthShapes:qc,Avatar_MustacheShake:_f,Avatar_POI:Es,AxesHelper:Xa,BaseUIComponent:rn,BasicIKConstraint:Cf,BehaviorExtension:g0,BehaviorModel:Wt,BloomEffect:Kr,BoxCollider:Ya,BoxGizmo:Gr,BoxHelperComponent:Ki,Button:Qs,CallInfo:Rs,Camera:Oe,CameraTargetReachedEvent:Wc,Canvas:At,CanvasGroup:Uo,CapsuleCollider:Is,ChangeMaterialOnClick:pl,ChangeTransformOnClick:Br,CharacterController:Ar,CharacterControllerInput:Ls,ChromaticAberration:Ph,Collider:di,ColorAdjustments:Go,ColorBySpeedModule:Ml,ColorOverLifetimeModule:xp,ContactShadows:kn,ControlTrackHandler:Hp,CustomBranding:$r,Deletable:Rf,DeleteBox:Kc,DepthOfField:In,DeviceFlag:Lu,DocumentExtension:cS,DragControls:ui,DropListener:Ds,Duplicatable:Ja,EffectWrapper:kh,EmissionModule:$s,EmphasizeOnClick:fl,EventList:Se,EventListEvent:Cu,EventSystem:si,EventTrigger:Bu,FieldWithDefault:ux,FixedJoint:j0,Fog:Sl,GltfExport:ih,GltfExportBox:$f,Gradient:Xr,Graphic:Nr,GraphicRaycaster:ku,GridHelper:Cl,GridLayoutGroup:C0,GroundProjectedEnv:$n,GroupActionModel:Eo,HideOnStart:gl,HingeJoint:vh,HorizontalLayoutGroup:S0,Image:jl,InheritVelocityModule:Yr,InputField:sa,InstanceHandle:Gu,InstancingHandler:sl,Interactable:Mf,Keyframe:fi,LODGroup:_h,LODModel:Ol,Light:gi,LimitVelocityOverLifetimeModule:gt,LogStats:kf,LookAt:oa,LookAtConstraint:Rr,MainModule:$t,MaskableGraphic:fh,MeshCollider:Ro,MeshRenderer:th,MinMaxCurve:Z,MinMaxGradient:yi,NeedleMenu:ss,NestedGltf:fp,Networking:Pl,NoiseModule:Pe,ObjectRaycaster:Ai,OffsetConstraint:qr,OpenURL:Dl,OrbitControls:be,Outline:xl,Padding:Hr,ParticleBurst:wp,ParticleSubEmitter:U0,ParticleSystem:ct,ParticleSystemRenderer:nn,PhysicsExtension:f0,PixelationEffect:Mh,PlayAnimationOnClick:zr,PlayAudioOnClick:Io,PlayableDirector:Ko,PlayerColor:Vl,PointerEventData:td,PostProcessingHandler:ny,PreliminaryAction:yl,PreliminaryTrigger:oh,RawImage:qp,Rect:Gx,RectTransform:Vt,ReflectionProbe:nl,RegisteredAnimationInfo:nr,RemoteSkybox:cs,Renderer:Ze,RendererLightmap:qu,Rigidbody:ye,RotationBySpeedModule:tn,RotationOverLifetimeModule:An,SceneSwitcher:ot,ScreenCapture:Qo,ScreenSpaceAmbientOcclusion:Gs,ScreenSpaceAmbientOcclusionN8:jn,SetActiveOnClick:Fr,ShadowCatcher:Ah,ShapeModule:et,SharpeningEffect:Th,SignalAsset:Wp,SignalReceiver:Il,SignalReceiverEvent:Bh,SignalTrackHandler:Nh,Size:$x,SizeBySpeedModule:vi,SizeOverLifetimeModule:Qr,SkinnedMeshRenderer:Hf,SmoothFollow:Yo,SpatialGrabRaycaster:Ha,SpatialHtml:Wh,SpatialTrigger:Dh,SpatialTriggerReceiver:hs,SpectatorCamera:Fp,SphereCollider:Qa,Sprite:Ns,SpriteData:jo,SpriteRenderer:mi,SpriteSheet:vl,SubEmitterSystem:Mp,SyncedCamera:Up,SyncedRoom:Ln,SyncedTransform:qn,TapGestureTrigger:s0,TeleportTarget:cp,TestRunner:dy,TestSimulateUserData:uy,Text:Ht,TextBuilder:w0,TextExtension:pp,TextureSheetAnimationModule:Gt,TiltShiftEffect:ls,ToneMappingEffect:$o,TrailModule:Ge,TransformData:Ke,TransformGizmo:ia,TriggerBuilder:Tt,TriggerModel:Dr,UIRaycastUtils:uf,UIRootComponent:Nc,USDZExporter:$e,USDZText:Vr,USDZUIExtension:k0,UsageMarker:Zc,VariantAction:i0,VelocityOverLifetimeModule:tt,VerticalLayoutGroup:x0,VideoPlayer:ft,Vignette:ta,VisibilityAction:rh,Voip:Mo,Volume:Al,VolumeParameter:N,VolumeProfile:Rp,WebARCameraBackground:$h,WebARSessionRoot:ns,WebXR:Je,WebXRImageTracking:ra,WebXRImageTrackingModel:Zs,WebXRPlaneTracking:Ks,WebXRTrackedImage:Gh,XRControllerFollow:Ys,XRControllerModel:os,XRControllerMovement:Li,XRFlag:Ii,XRRig:Yp,XRState:ci,__Ignore:hS},Symbol.toStringTag,{value:"Module"}));/* @license
 * Copyright 2021 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the 'License');
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an 'AS IS' BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Yj={topLight:{intensity:500,position:[.418,16.199,.3]},room:{position:[-.757,13.219,.717],scale:[31.713,28.305,28.591]},boxes:[{position:[-10.906,2.009,1.846],rotation:-.195,scale:[2.328,7.905,4.651]},{position:[-5.607,-.754,-.758],rotation:.994,scale:[1.97,1.534,3.955]},{position:[6.167,.857,7.803],rotation:.561,scale:[3.927,6.285,3.687]},{position:[-2.017,.018,6.124],rotation:.333,scale:[2.002,4.566,2.064]},{position:[2.291,-.756,-2.621],rotation:-.286,scale:[1.546,1.552,1.496]},{position:[-2.193,-.369,-5.547],rotation:.516,scale:[3.875,3.487,2.986]}],lights:[{intensity:50,position:[-16.116,14.37,8.208],scale:[.1,2.428,2.739]},{intensity:50,position:[-16.109,18.021,-8.207],scale:[.1,2.425,2.751]},{intensity:17,position:[14.904,12.198,-1.832],scale:[.15,4.265,6.331]},{intensity:43,position:[-.462,8.89,14.52],scale:[4.38,5.441,.088]},{intensity:20,position:[3.235,11.486,-12.541],scale:[2.5,2,.1]},{intensity:100,position:[0,20,0],scale:[1,.1,1]}]},Zj={topLight:{intensity:400,position:[.5,14,.5]},room:{position:[0,13.2,0],scale:[31.5,28.5,31.5]},boxes:[{position:[-10.906,-1,1.846],rotation:-.195,scale:[2.328,7.905,4.651]},{position:[-5.607,-.754,-.758],rotation:.994,scale:[1.97,1.534,3.955]},{position:[6.167,-.16,7.803],rotation:.561,scale:[3.927,6.285,3.687]},{position:[-2.017,.018,6.124],rotation:.333,scale:[2.002,4.566,2.064]},{position:[2.291,-.756,-2.621],rotation:-.286,scale:[1.546,1.552,1.496]},{position:[-2.193,-.369,-5.547],rotation:.516,scale:[3.875,3.487,2.986]}],lights:[{intensity:80,position:[-14,10,8],scale:[.1,2.5,2.5]},{intensity:80,position:[-14,14,-4],scale:[.1,2.5,2.5]},{intensity:23,position:[14,12,0],scale:[.1,5,5]},{intensity:16,position:[0,9,14],scale:[5,5,.1]},{intensity:80,position:[7,8,-14],scale:[2.5,2.5,.1]},{intensity:80,position:[-7,16,-14],scale:[2.5,2.5,.1]},{intensity:1,position:[0,20,0],scale:[.1,.1,.1]}]};class Kj extends wi{constructor(t){super(),this.position.y=-3.5;const i=new ma;i.deleteAttribute("uv");const s=new Ft({metalness:0,side:cd}),o=new Ft({metalness:0}),r=t=="legacy"?Yj:Zj,l=new om(16777215,r.topLight.intensity,28,2);l.position.set(...r.topLight.position),this.add(l);const c=new X(i,s);c.position.set(...r.room.position),c.scale.set(...r.room.scale),this.add(c);for(const h of r.boxes){const d=new X(i,o);d.position.set(...h.position),d.rotation.set(0,h.rotation,0),d.scale.set(...h.scale),this.add(d)}for(const h of r.lights){const d=new X(i,this.createAreaLightMaterial(h.intensity));d.position.set(...h.position),d.scale.set(...h.scale),this.add(d)}}createAreaLightMaterial(t){const i=new Re;return i.color.setScalar(t),i}}const tm=C("debugmissingcamera");ue.registerCallback(pe.MissingCamera,n=>{var t,i,s,o;tm&&console.warn("Creating missing camera");const r=n.context.scene,l=new _e;l.name="Default Fallback Camera",r.add(l);const c=new Oe;if(c.sourceId=((i=(t=n.files)==null?void 0:t[0])==null?void 0:i.src)??"unknown",c.fieldOfView=35,n.context.domElement.getAttribute("transparent")!=null)c.clearFlags=Oo.Uninitialized;else if((s=n.context.domElement.getAttribute("skybox-image"))!=null&&s.length||(o=n.context.domElement.getAttribute("background-image"))!=null&&o.length||n.context.lightmaps.tryGetSkybox(c.sourceId))c.clearFlags=Oo.Skybox,c.backgroundBlurriness=.2;else{c.clearFlags=Oo.SolidColor;let u="#efefef";if(typeof window!==void 0&&window.matchMedia("(prefers-color-scheme: dark)").matches&&(u="#1f1f1f"),r.background=new ae(u),!r.environment){const p=new RC(n.context.renderer),g=new Kj("neutral");r.environment=p.fromScene(g,.025).texture}}const h=yr(l,c,!0);l.position.x=0,l.position.y=1,l.position.z=2;const d=n.context.domElement;return d?.cameraControls!=!1&&dS(n.context,h),h}),ue.registerCallback(pe.ContextCreated,n=>{if(!n.context.mainCamera){tm&&console.log("Will not auto-fit because a default camera exists");return}const t=n.context.domElement;if(t?.cameraControls==!0){const i=Fv(n.context.mainCamera);if(i?.isCameraController==!0){tm&&console.log("Will not auto-fit because a camera controller exists");return}dS(n.context)}});function dS(n,t){t=t??n.mainCameraComponent;const i=t?.gameObject;if(tm&&console.log("Creating default camera controls",t?.name),i){const s=Sc(i,be);s.sourceId=t?.sourceId??"unknown";const o=n.domElement.getAttribute("auto-rotate");if(s.autoRotate=o!=null&&o!="0"&&o?.toLowerCase()!="false",s.autoRotateSpeed=.5,s.autoFit=!0,s.autoRotate&&o){const r=parseFloat(o);isNaN(r)||(s.autoRotateSpeed=r)}}else console.warn("Missing camera object, can not add orbit controls")}ue.registerCallback(pe.ContextCreated,n=>{const t=n.context.domElement.getAttribute("autoplay");if(t!==void 0&&(t===""||t==="true"||t==="1")&&n.files)for(const i of n.files)O.foreachComponent(i.file.scene,s=>{if(s.enabled!==!1){if(s instanceof Ut&&s.playAutomatically||s instanceof kt||s instanceof Ko&&s.playOnAwake===!0)return!0;if(s instanceof Ut)return s.playAutomatically=!0,!0;if(s instanceof Ko)return s.playOnAwake=!0,!0}},!0)!==!0&&Fa.assignAnimationsFromFile(i.file,{createAnimationComponent:(s,o)=>Ri(s,Ut)})});class Jj extends cO{constructor(){super(new hO),this.name="GenerateMeshBVHWorker"}runTask(t,i,s={}){return new Promise((o,r)=>{if(i.getAttribute("position").isInterleavedBufferAttribute||i.index&&i.index.isInterleavedBufferAttribute)throw new Error("GenerateMeshBVHWorker: InterleavedBufferAttribute are not supported for the geometry attributes.");t.onerror=d=>{r(new Error(`GenerateMeshBVHWorker: ${d.message}`))},t.onmessage=d=>{const{data:u}=d;if(u.error)r(new Error(u.error)),t.onmessage=null;else if(u.serialized){const{serialized:p,position:g}=u,y=dO.deserialize(p,i,{setIndex:!1}),f=Object.assign({setBoundingBox:!0},s);if(i.attributes.position.array=g,p.index)if(i.index)i.index.array=p.index;else{const v=new yt(p.index,1,!1);i.setIndex(v)}f.setBoundingBox&&(i.boundingBox=y.getBoundingBox(new xi)),s.onProgress&&s.onProgress(u.progress),o(y),t.onmessage=null}else s.onProgress&&s.onProgress(u.progress)};const l=i.index?i.index.array:null,c=i.attributes.position.array,h=[c];l&&h.push(l),t.postMessage({index:l,position:c,options:{...s,onProgress:null,includedProgressCallback:!!s.onProgress,groups:[...i.groups]}},h.map(d=>d.buffer).filter(d=>typeof SharedArrayBuffer>"u"||!(d instanceof SharedArrayBuffer)))})}}const eL=Object.freeze(Object.defineProperty({__proto__:null,GenerateMeshBVHWorker:Jj},Symbol.toStringTag,{value:"Module"}));export{EM as $physicsKey,ve as ActionBuilder,Bx as ActionCollection,en as ActionModel,D_ as Addressables,Lc as AlignmentConstraint,Ua as AmbientMode,Ut as Animation,kl as AnimationCurve,np as AnimationExtension,Vp as AnimationTrackHandler,Fa as AnimationUtils,kt as Animator,bo as AnimatorConditionMode,ln as AnimatorController,lf as AnimatorControllerParameterType,Dc as AnimatorStateInfo,Oh as Antialiasing,Ps as Application,nu as ApplicationEvents,Hb as AssetDatabase,le as AssetReference,ua as AudioExtension,Ts as AudioListener,Ne as AudioSource,Uh as AudioTrackHandler,Do as Avatar,Er as AvatarBlink_Simple,qa as AvatarEyeLook_Rotation,lS as AvatarLoader,Rt as AvatarMarker,Fy as AvatarModel,Hc as Avatar_Brain_LookAt,qc as Avatar_MouthShapes,_f as Avatar_MustacheShake,Es as Avatar_POI,Wa as Axes,Xa as AxesHelper,Ym as BUILD_TIME,rn as BaseUIComponent,Cf as BasicIKConstraint,g0 as BehaviorExtension,Wt as BehaviorModel,wr as BlobStorage,Kr as BloomEffect,Ya as BoxCollider,Gr as BoxGizmo,Ki as BoxHelperComponent,Qs as Button,ks as ButtonsFactory,Fw as CallDirection,Rs as CallInfo,Oe as Camera,Wc as CameraTargetReachedEvent,At as Canvas,Uo as CanvasGroup,Is as CapsuleCollider,pl as ChangeMaterialOnClick,Br as ChangeTransformOnClick,Ar as CharacterController,Ls as CharacterControllerInput,Ph as ChromaticAberration,Oi as CircularBuffer,Oo as ClearFlags,ds as ClipExtrapolation,di as Collider,Lw as Collision,wu as CollisionDetectionMode,Go as ColorAdjustments,Ml as ColorBySpeedModule,xp as ColorOverLifetimeModule,Ek as Component,A as Component$1,yc as ComponentLifecycleEvents,Qj as Components,Pb as ConnectionEvents,jw as ContactPoint,kn as ContactShadows,ee as Context,bk as ContextArgs,pe as ContextEvent,ue as ContextRegistry,Hp as ControlTrackHandler,$r as CustomBranding,Rn as CustomShader,lu as DefaultReflectionMode,Rf as Deletable,Kc as DeleteBox,In as DepthOfField,Lu as DeviceFlag,Q as DeviceUtilities,cS as DocumentExtension,ui as DragControls,Ef as DragMode,Ds as DropListener,Ja as Duplicatable,kh as EffectWrapper,$s as EmissionModule,fl as EmphasizeOnClick,rf as EngineLoadingView,Se as EventList,Cu as EventListEvent,si as EventSystem,Bu as EventTrigger,ux as FieldWithDefault,iu as FileReference,F_ as FileReferenceSerializer,uR as FileSpawnModel,Qw as File_Event,j0 as FixedJoint,Sl as Fog,Me as FrameEvent,Sd as GENERATOR,O as GameObject,G as Gizmos,ih as GltfExport,$f as GltfExportBox,la as GltfLoadEvent,$1 as GltfLoadEventType,Xr as Gradient,Nr as Graphic,ku as GraphicRaycaster,Hi as Graphics,Cl as GridHelper,C0 as GridLayoutGroup,$n as GroundProjectedEnv,Eo as GroupActionModel,Au as HideFlags,gl as HideOnStart,vh as HingeJoint,S0 as HorizontalLayoutGroup,S2 as HostData,jl as Image,eu as ImageReference,B_ as ImageReferenceSerializer,Yr as InheritVelocityModule,pb as Input,ai as InputEventQueue,Be as InputEvents,sa as InputField,Gu as InstanceHandle,sl as InstancingHandler,an as InstancingUtil,n_ as InstantiateEvent,Dt as InstantiateIdProvider,Bn as InstantiateOptions,Mf as Interactable,Hh as InternalScreenshotUtils,QP as JoinedRoomResponse,FP as KeyEventArgs,fi as Keyframe,_h as LODGroup,Ol as LODModel,YP as LeftRoomResponse,gi as Light,X_ as LightData,gt as LimitVelocityOverLifetimeModule,kk as LoadingElementOptions,kf as LogStats,Pi as LogType,oa as LookAt,Rr as LookAtConstraint,I as MODULES,$t as MainModule,my as MarkerType,fh as MaskableGraphic,W as Mathf,Ro as MeshCollider,th as MeshRenderer,Z as MinMaxCurve,yi as MinMaxGradient,dc as NEKeyboardEvent,ws as NEPointerEvent,By as NeedleButtonElement,Ry as NeedleEngineHTMLElement,ky as NeedleLoader,ss as NeedleMenu,Od as NeedlePatchesKey,eg as NeedleXRController,J as NeedleXRSession,Rb as NeedleXRSync,Fb as NeedleXRUtils,fp as NestedGltf,Mb as NetworkConnection,Qn as NetworkedStreamEvents,id as NetworkedStreams,Pl as Networking,o_ as NewInstanceModel,Pe as NoiseModule,Ai as ObjectRaycaster,uo as ObjectUtils,qr as OffsetConstraint,yd as OneEuroFilter,jm as OneEuroFilterXYZ,Dl as OpenURL,be as OrbitControls,xl as Outline,kb as OwnershipEvent,rg as OwnershipModel,cc as PUBLIC_KEY,Hr as Padding,wp as ParticleBurst,U0 as ParticleSubEmitter,ct as ParticleSystem,Ho as ParticleSystemBaseBehaviour,nn as ParticleSystemRenderer,bp as ParticleSystemShapeType,Gc as PeerHandle,Cb as PeerNetworking,Ad as Physics,f0 as PhysicsExtension,wt as PhysicsMaterialCombine,Mh as PixelationEffect,zr as PlayAnimationOnClick,Io as PlayAudioOnClick,Ko as PlayableDirector,Vl as PlayerColor,ji as PlayerState,Vx as PlayerStateEvent,bl as PlayerSync,V_ as PlayerView,H_ as PlayerViewManager,td as PointerEventData,kd as PointerType,ht as PostProcessingEffect,ny as PostProcessingHandler,yl as PreliminaryAction,oh as PreliminaryTrigger,To as PreviewHelper,pr as PrimitiveType,ce as Progress,Mm as PromiseAllWithErrors,km as PromiseErrorResult,xe as RGBAColor,Nl as RapierPhysics,qp as RawImage,Vn as RaycastOptions,Gx as Rect,Vt as RectTransform,nl as ReflectionProbe,nr as RegisteredAnimationInfo,cs as RemoteSkybox,Na as RenderTexture,Mw as RenderTextureSerializer,Ze as Renderer,q_ as RendererData,qu as RendererLightmap,ye as Rigidbody,nt as RigidbodyConstraints,ne as RoomEvents,tn as RotationBySpeedModule,An as RotationOverLifetimeModule,zu as SceneLightSettings,ot as SceneSwitcher,Qo as ScreenCapture,Gs as ScreenSpaceAmbientOcclusion,jn as ScreenSpaceAmbientOcclusionN8,wn as SendQueue,Bg as SerializationContext,Fr as SetActiveOnClick,Ah as ShadowCatcher,et as ShapeModule,Th as SharpeningEffect,Wp as SignalAsset,Il as SignalReceiver,Bh as SignalReceiverEvent,Nh as SignalTrackHandler,$x as Size,vi as SizeBySpeedModule,Qr as SizeOverLifetimeModule,Hf as SkinnedMeshRenderer,Yo as SmoothFollow,Ha as SpatialGrabRaycaster,Wh as SpatialHtml,Dh as SpatialTrigger,hs as SpatialTriggerReceiver,Fp as SpectatorCamera,Qa as SphereCollider,yg as SphereIntersection,Dw as SphereOverlapResult,Ns as Sprite,jo as SpriteData,mi as SpriteRenderer,vl as SpriteSheet,Fk as StateMachineBehaviour,vf as StreamEndedEvent,Bw as StreamReceivedEvent,Mp as SubEmitterSystem,Up as SyncedCamera,Ln as SyncedRoom,qn as SyncedTransform,s0 as TapGestureTrigger,cp as TeleportTarget,dy as TestRunner,Vj as TestSceneUtils,uy as TestSimulateUserData,Ht as Text,w0 as TextBuilder,pp as TextExtension,Gt as TextureSheetAnimationModule,ls as TiltShiftEffect,Y_ as Time,$o as ToneMappingEffect,Fh as TrackHandler,Ni as TrackType,Ge as TrailModule,Ke as TransformData,ia as TransformGizmo,Tt as TriggerBuilder,Dr as TriggerModel,k as TypeStore,uf as UIRaycastUtils,Nc as UIRootComponent,Gf as USDDocument,Zt as USDObject,vx as USDWriter,$e as USDZExporter,bx as USDZExporter$1,Vr as USDZText,k0 as USDZUIExtension,Rw as UriSerializer,Zc as UsageMarker,ZP as UserJoinedOrLeftRoomModel,_n as VERSION,i0 as VariantAction,tt as VelocityOverLifetimeModule,x0 as VerticalLayoutGroup,ft as VideoPlayer,fo as ViewDevice,ta as Vignette,rh as VisibilityAction,Mo as Voip,Al as Volume,N as VolumeParameter,Rp as VolumeProfile,K2 as WaitForFrames,U_ as WaitForPromise,$g as WaitForSeconds,Js as Watch,$h as WebARCameraBackground,ns as WebARSessionRoot,Je as WebXR,Ur as WebXRButtonFactory,ra as WebXRImageTracking,Zs as WebXRImageTrackingModel,Ks as WebXRPlaneTracking,Gh as WebXRTrackedImage,Ys as XRControllerFollow,os as XRControllerModel,Li as XRControllerMovement,Ii as XRFlag,Yp as XRRig,ci as XRState,Zn as XRStateFlag,hS as __Ignore,Qb as __internalNotifyObjectDestroyed,_s as activeInHierarchyFieldName,kv as addAttributeChangeCallback,Ri as addComponent,BR as addCustomExtensionPlugin,Mj as addGltfLoadEventListener,yr as addNewComponent,Cd as addPatch,Gd as apply,Uj as applyHMRChanges,w_ as applyPrototypeExtensions,s_ as beginListenDestroy,a_ as beginListenInstantiate,ig as binaryIdentifierCasts,vk as build_scene_functions,ur as builtinComponentKeyName,sf as calculateProgress01,VO as clearMessages,aM as colorSerializer,d_ as compareAssociation,Ou as componentSerializer,Qv as copyTexture,My as createLoader,bw as createMotion,li as debugNet,uc as debugOwner,Cx as decompressGpuTexture,Zl as deepClone,yn as delay,Kl as delayForFrames,Hd as deserializeObject,Ti as destroy,O_ as destroyComponentInstance,Ee as disposeObjectResources,Yn as disposeStream,hc as editorGuidKeyName,dr as enableSpatialConsole,cM as euler,pM as eventListSerializer,Gj as exportAsGLTF,Ng as findByGuid,kc as findObjectOfType,M_ as findObjectsOfType,wg as findResourceUsers,Zv as fitObjectIntoVolume,_r as foreachComponent,Kd as foreachComponentEnumerator,sP as forward,Rv as generateQRCode,r_ as generateSeed,oi as getBoundingBox,Fv as getCameraController,vr as getComponent,Oc as getComponentInChildren,Pc as getComponentInParent,Cc as getComponents,Ia as getComponentsInChildren,$d as getComponentsInParent,mx as getFormattedDate,Pt as getIconElement,Yg as getIconTexture,jO as getIp,LO as getIpAndLocation,IO as getIpCloudflare,fn as getLoader,Sc as getOrAddComponent,C as getParam,aP as getParentHierarchyPath,bO as getPath,$P as getPeerOptions,xb as getPeerjsInstance,m2 as getResourceUserCount,Nv as getTempColor,vn as getTempQuaternion,q as getTempVector,Ql as getUrlParams,Yv as getVisibleInCustomShadowRendering,$v as getWorldDirection,Nm as getWorldEuler,te as getWorldPosition,Ce as getWorldQuaternion,ic as getWorldRotation,Ye as getWorldScale,On as hasCommercialLicense,ef as hasIndieLicense,Su as hasPointerEventComponent,yo as hasProLicense,ib as hideDebugConsole,Ox as imageToCanvas,Da as instantiate,Wf as invokeAfterImportPluginHooks,ub as invokeXRSessionEnd,db as invokeXRSessionStart,R_ as isActiveInHierarchy,ja as isActiveSelf,OO as isAndroidDevice,Xv as isAnimationAction,Iw as isComponent,gO as isDebugMode,wO as isDesktop,br as isDestroyed,F as isDevEnvironment,u2 as isDisposed,Hj as isExporting,vv as isHostedOnGlitch,Dj as isHotReloading,SO as isIPad,J_ as isIconElement,Xt as isLocalNetwork,kO as isMacOS,xO as isMobileDevice,PO as isMozillaXR,TO as isQuest,Gb as isResourceTrackingEnabled,RO as isSafari,Qd as isUsingInstancing,MO as isiOS,CO as isiPad,X1 as loadSync,wd as logHierarchy,YO as lookAtInverse,tc as lookAtObject,ZO as lookAtScreenPoint,yO as makeId,Cv as makeIdFromRandomWords,Tn as makeNameSafe,T_ as markAsInstancedRendered,EO as microphonePermissionsGranted,mO as nameof,_v as nameofFactory,kw as objectSerializer,BP as offXRSessionEnd,DP as offXRSessionStart,Kk as onAfterRender,Zk as onBeforeRender,Qk as onClear,Yk as onDestroy,xw as onInitialized,Sw as onStart,Cw as onUpdate,Jm as onXRSessionEnd,Pd as onXRSessionStart,q1 as parseSync,Kv as placeOnSurface,$m as postprocessFBXMaterials,eM as prefix,wv as pushState,vO as randomNumber,ng as registerBinaryType,pu as registerComponent,Nu as registerComponentExtension,sn as registerCustomEffectType,Nf as registerExportExtensions,Wu as registerExtensions,Bj as registerHotReloadType,wm as registerLoader,c_ as registerPrefabProvider,x_ as registerPrototypeExtensions,M2 as registerType,Pv as relativePathPrefix,Mv as removeAttributeChangeCallback,Ug as removeComponent,FR as removeCustomImportExtensionType,Rj as removeGltfLoadEventListener,jP as removePatch,ao as resolveUrl,Ov as sanitizeString,B1 as saveImage,aj as screenshot,_y as screenshot2,Tg as sendDestroyed,m as serializable,g_ as serializeObject,kr as serializeable,Mc as setActive,Iv as setAllowBalloonMessages,zO as setAllowOverlayMessages,bd as setAutoFitEnabled,Lm as setCameraController,A_ as setDestroyed,gP as setDevEnvironment,_g as setDisposable,La as setDontDestroy,Cm as setOrAddParamsToUrl,fO as setParam,Yl as setParamWithoutReload,GP as setPeerOptions,d2 as setResourceTrackingEnabled,Om as setState,Hm as setVisibleInCustomShadowRendering,Wm as setWorldEuler,dt as setWorldPosition,cr as setWorldPositionXYZ,Vi as setWorldQuaternion,Um as setWorldQuaternionXYZW,Vm as setWorldRotation,nc as setWorldRotationXYZ,xa as setWorldScale,rc as showBalloonError,De as showBalloonMessage,we as showBalloonWarning,Qm as showDebugConsole,QO as slerp,wc as syncDestroy,d0 as syncField,Eg as syncInstantiate,lP as textureToCanvas,_b as tryCastBinary,W1 as tryDetermineFileTypeFromBinary,N1 as tryDetermineFileTypeFromURL,_a as tryFindObject,wb as tryGetGuid,Fj as unregisterHotReloadType,Pm as unwatchWrite,zv as useForAutoFit,Mt as validate,gd as watchWrite};
